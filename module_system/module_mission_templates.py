from header_common import *
from header_operations import *
from header_mission_templates import *
from header_animations import *
from header_sounds import *
from header_music import *
from header_items import *
from header_skills import *
from module_constants import *
from header_terrain_types import *
#from compiler import *
####################################################################################################################
#   Each mission-template is a tuple that contains the following fields:
#  1) Mission-template id (string): used for referencing mission-templates in other files.
#     The prefix mt_ is automatically added before each mission-template id
#
#  2) Mission-template flags (int): See header_mission-templates.py for a list of available flags
#  3) Mission-type(int): Which mission types this mission template matches.
#     For mission-types to be used with the default party-meeting system,
#     this should be 'charge' or 'charge_with_ally' otherwise must be -1.
#
#  4) Mission description text (string).
#  5) List of spawn records (list): Each spawn record is a tuple that contains the following fields:
#    5.1) entry-no: Troops spawned from this spawn record will use this entry
#    5.2) spawn flags.
#    5.3) alter flags. which equipment will be overriden
#    5.4) ai flags.
#    5.5) Number of troops to spawn.
#    5.6) list of equipment to add to troops spawned from here (maximum 8).
#  6) List of triggers (list).
#     See module_triggers.py for infomation about triggers.
#
#  Please note that mission templates is work in progress and can be changed in the future versions.
#
####################################################################################################################

#SB : add new disguise sets, make sure none of them have high difficulty
# the new flags now also have af_override_everything, so include footwear
pilgrim_disguise = [itm_simple_hood_1,itm_generic_poor1,itm_practice_staff, itm_throwing_daggers, itm_leather_boots]
farmer_disguise = [itm_roman_poor1, itm_butchering_knife, itm_pitch_fork, itm_stones, itm_caligea,itm_straw_hat]
hunter_disguise = [itm_hunting_bow,itm_barbed_arrows, itm_phrygian_cap_red, itm_leather_gloves, itm_parthian_tunic_1, itm_dagger_parthian_1, itm_leather_boots]
merchant_disguise = [itm_roman_toga,itm_caligea,itm_dagger]
guard_disguise = [itm_germanic_light9,itm_germanic_helm2,itm_celtic_boots,itm_germanic_shield_large1,itm_war_spear]
bard_disguise = [itm_leather_boots,itm_lyre,itm_linen_tunic,itm_dagger]
#note that these are usually male clothing, especially farmer_disguise, need some female ones as well

nothing = [itm_nothing_legs,itm_nothing_head,itm_nothing_body,itm_nothing_hands]

af_castle_lord = af_override_horse | af_override_weapons| af_require_civilian

can_spawn_commoners = (ti_before_mission_start,0,0,[],[(assign,"$can_spawn_commoners",1)])
cannot_spawn_commoners = (ti_before_mission_start,0,0,[],[(assign,"$can_spawn_commoners",0)])

remove_banners = (ti_before_mission_start, 0, 0, [],[
  (try_for_range, ":prop", banner_scene_props_begin, banner_scene_props_end_minus_one),
      (replace_scene_props, ":prop", "spr_empty"),
  (try_end),
])

# Trigger to spawn Alexandria Lighthouse in the background if nearby
spawn_alexandria_lighthouse = (0, 0, ti_once, [
  (party_get_current_terrain, ":terrain", "p_temp_party"),
  (this_or_next|eq, ":terrain", rt_bridge),
  (this_or_next|eq, ":terrain", rt_water),
  (eq, ":terrain", rt_river),
  (set_fixed_point_multiplier, 1),
  (store_distance_to_party_from_party, ":distance", "p_main_party", "p_town_20"),
  (le, ":distance", 60),
],[
  (set_fixed_point_multiplier, 100),
  (display_message, "@You can see the distant light of Alexandria on the horizon.", color_good_news),

  # Get the direction vector from the player to the town on the world map
  (party_get_position, pos1, "p_main_party"),
  (party_get_position, pos2, "p_town_20"),
  (position_transform_position_to_local, pos3, pos1, pos2), # pos3 is now the vector from player to town

  # Get the center of the battle scene
  # Entry point 0 is a reliable way to get a point near the center of the scene's geometry
  (entry_point_get_position, pos4, 0),

  (position_get_x, ":dir_x", pos3),
  (position_get_y, ":dir_y", pos3),
  (val_mul, ":dir_x", 150),
  (val_mul, ":dir_y", 150),

  (position_get_x, ":center_x", pos4),
  (position_get_y, ":center_y", pos4),
  (val_add, ":dir_x", ":center_x"),
  (val_add, ":dir_y", ":center_y"),

  (position_set_x, pos1, ":dir_x"),
  (position_set_y, pos1, ":dir_y"),
  (position_set_z, pos1, 0),

  # --- DEBUG: Print the final spawn coordinates ---
  (assign, reg5, ":dir_x"),
  (assign, reg6, ":dir_y"),
  (assign, reg7, 0),
  (display_message, "@DEBUG: Lighthouse spawning at X:{reg5}, Y:{reg6}, Z:{reg7}"),

  (set_spawn_position, pos1),
  (spawn_scene_prop, "spr_alexandria_lighthouse_icon"),
  (assign, ":prop", reg0),

  (prop_instance_set_scale, ":prop", 750, 750, 750),
])

common_maritime_drowning =(1, 0, 0,[
    (store_mission_timer_a, ":cur_time"),
    (gt, ":cur_time", 5),
  ],[
    # ACCORDING DROWNING
    (set_fixed_point_multiplier, 100),
    (try_for_agents,":agent"),
      (agent_is_alive,":agent"),
      (agent_is_human,":agent"),
      (agent_get_position,pos6,":agent"),
      (position_get_z, ":deep", pos6),
      (lt, ":deep", -200),
      (try_begin),
        (agent_is_non_player, ":agent"),
        (agent_set_hit_points, ":agent", 0, 1),
        (agent_deliver_damage_to_agent, ":agent", ":agent" ,1),
      (else_try),
        (agent_set_hit_points, ":agent", 0, 1),
        (agent_deliver_damage_to_agent, ":agent", ":agent" ,1),
      (end_try),
    (end_try),
])

vc_water = [			# 5 trigger
  (ti_on_agent_spawn, 0, ti_once, [],[
    (assign, ":beaufort_copy", "$beaufort"),
    (call_script, "script_get_wave_properties"),
    (assign, "$Amplitude_x",	reg1),
    (assign, "$Amplitude_y",	reg2),
    (assign, "$lamda_x",		reg3),
    (assign, "$lamda_y",		reg4),
    (assign, "$wavespeed_y", 	reg6),
    (assign, "$target_Amplitude_x",	"$Amplitude_x"),
    (assign, "$target_Amplitude_y",	"$Amplitude_y"),
    (call_script, "script_set_wave_shader"),
    (assign, "$beaufort", ":beaufort_copy"),
  ]),
  (0, 0, 0.02, [],[
    (try_begin),
      (is_between, "$wave_timer", 0, 6283),
      (val_add, "$wave_timer", 1),
    (else_try),
      (assign, "$wave_timer", 0),
    (end_try),
    (call_script, "script_set_wave_timer"),
  ]),
  (5, 0, 15, [
    (store_random_in_range,":chance",1,4),
    (eq,":chance",1),
  ],	# comands wave change
  [
    (assign, ":beaufort_copy", "$beaufort"),
    (call_script, "script_get_wave_properties"),
    (shuffle_range, 1, 3),
    (assign, "$target_Amplitude_x",	reg1),
    (assign, "$target_Amplitude_y",	reg2),
    (assign, "$beaufort", ":beaufort_copy"),
  ]),
  (0.05, 0, 0, [],[
    (assign, ":amplitude_change", 20),
    (try_begin),
      (lt, "$Amplitude_x", "$target_Amplitude_x"),
      (store_sub, ":value", "$target_Amplitude_x", "$Amplitude_x"),
      (ge, ":value", ":amplitude_change"),
      (val_add, "$Amplitude_x", ":amplitude_change"),
    (else_try),
      (gt, "$Amplitude_x", "$target_Amplitude_x"),
      (store_sub, ":value", "$Amplitude_x", "$target_Amplitude_x"),
      (ge, ":value", ":amplitude_change"),
      (val_sub, "$Amplitude_x", ":amplitude_change"),
    (end_try),

    (try_begin),
      (lt, "$Amplitude_y", "$target_Amplitude_y"),
      (store_sub, ":value", "$target_Amplitude_y", "$Amplitude_y"),
      (ge, ":value", ":amplitude_change"),
      (val_add, "$Amplitude_y", ":amplitude_change"),
    (else_try),
      (gt, "$Amplitude_y", "$target_Amplitude_y"),
      (store_sub, ":value", "$Amplitude_y", "$target_Amplitude_y"),
      (ge, ":value", ":amplitude_change"),
      (val_sub, "$Amplitude_y", ":amplitude_change"),
    (end_try),

    (set_fixed_point_multiplier,10000),
    (set_shader_param_float4, "@vWaveInfo", "$Amplitude_x", "$Amplitude_y", "$WaveNumber_x", "$WaveNumber_y"),
    (store_add, ":Origin_z", "$Amplitude_x", "$Amplitude_y"), # This can be used to alter overall sea level
    (set_shader_param_float4, "@vWaveOrigin", 0, 0, ":Origin_z", 0),
    (set_fixed_point_multiplier,100),
  ]),
  (0, 0, 0,[
    (key_is_down, key_left_control),
    (eq, "$cheat_mode", 1),
    (key_clicked, key_p),
  ],[
    (try_begin),
      (lt, "$beaufort", 12),
      (val_add, "$beaufort", 1),
    (else_try),
      (assign, "$beaufort", 0),
    (end_try),
    (assign, reg1, "$beaufort"),
    (display_message, "@{!}beaufort: {reg1}"),

    (call_script, "script_get_wave_properties"),
    (assign, "$Amplitude_x",	reg1),
    (assign, "$Amplitude_y",	reg2),
    (assign, "$lamda_x",		reg3),
    (assign, "$lamda_y",		reg4),
    (assign, "$wavespeed_y", 	reg6),
    (assign, "$target_Amplitude_x",	reg1),
    (assign, "$target_Amplitude_y",	reg2),
    (call_script, "script_set_wave_shader"),
  ]),
]

vc_menu = [
  (0, 0, ti_once, [
    (neq, "$vc_menu_active", 0),# This is starting the presentation
  ],[
    (start_presentation, "$vc_menu_active"),
    (set_fixed_point_multiplier, 100),
    (entry_point_get_position, pos8, 70),
    (mission_cam_set_position, pos8),
    (call_script, "script_save_cam_first_person_mode"),
    (mission_cam_set_mode, 1, 0, 1),
    (set_camera_in_first_person, 0),
    (mission_cam_set_screen_color, 0xFF000000),
    (mission_cam_animate_to_screen_color, 0x00000000, 1000),
    (mission_disable_talk),
  ]),

  (0, 0, 0.5, [
    (neq, "$vc_menu_active", 0),
  ],[
    (try_begin),
        # RESTART MENU
        (store_mission_timer_a,":mission_time"),
        (ge,":mission_time",2),
        (neg|is_presentation_active, "$vc_menu_active"),
        (eq, "$vc_menu_active", "prsnt_senate"),
        (start_presentation, "$vc_menu_active"),
        (set_fixed_point_multiplier, 100),
        (entry_point_get_position, pos8, 70),
        (mission_cam_set_position, pos8),
        (call_script, "script_save_cam_first_person_mode"),
        (mission_cam_set_mode, 1, 0, 1),
        (set_camera_in_first_person, 0),
        (mission_cam_set_screen_color, 0xFF000000),
        (mission_cam_animate_to_screen_color, 0x00000000, 500),
        (mission_disable_talk),
    (try_end),
  ])
]

deactivate_player_agent = (0,0,ti_once,[],[
  (get_player_agent_no, ":player"),
  (call_script, "script_advanced_agent_set_speed_modifier", ":player", 0),
  (agent_set_visibility, ":player", 0),
  (agent_set_no_death_knock_down_only, ":player", 1),
])

poisoned_arrows_hit = (ti_on_agent_hit, 0, 0, [],[
    (store_trigger_param, ":victim", 1),
    (store_trigger_param, ":attacker", 2),
    (store_trigger_param, ":missile", 5),

    (eq, ":missile", "itm_poisoned_arrows"),
    # (try_begin),
        # (agent_get_slot, ":is_poisoned", ":victim", slot_agent_is_poisoned),
    (get_player_agent_no, ":player"),
    (agent_get_horse, ":p_horse", ":player"),
    (try_begin),
        (eq, ":attacker", ":player"),
        # (neq, ":is_poisoned", 1),
        (try_begin),
            (neg|agent_is_human, ":victim"),
            (display_message, "@You have poisoned a horse!", 0x3F8000),
            (agent_set_slot, ":victim", slot_agent_is_poisoned, 3),
        (else_try),
            (display_message, "@You have poisoned the enemy!", 0x3F8000),
            (agent_set_slot, ":victim", slot_agent_is_poisoned, 3),
        (try_end),
    (else_try),
        (eq, ":victim", ":player"),
        # (neq, ":is_poisoned", 1),
        (display_message, "@You are poisoned!", 0x3F8000),
        (mission_cam_set_screen_color, 0xFF000000),
        (mission_cam_animate_to_screen_color, 0x4D000000, 2000),
        (agent_set_slot, ":victim", slot_agent_is_poisoned, 3),
    (else_try),
        (eq, ":victim", ":p_horse"),
        # (neq, ":is_poisoned", 1),
        (display_message, "@Your horse is poisoned!", 0x3F8000),
        (agent_set_slot, ":victim", slot_agent_is_poisoned, 3),
    (else_try),
        # (neq, ":is_poisoned", 1),
        (agent_set_slot, ":victim", slot_agent_is_poisoned, 3),
    (try_end),
    # (try_end),
])

poisoned_arrows_damage = (6, 0, 0, [],[
  (try_for_agents,":cur_agent"),
      (agent_is_active, ":cur_agent"),
      (agent_is_alive, ":cur_agent"),
      (agent_get_slot, ":is_poisoned", ":cur_agent", slot_agent_is_poisoned),
      (ge, ":is_poisoned", 1),
      (val_sub, ":is_poisoned", 1),
      (try_begin),
          (store_agent_hit_points,reg22,":cur_agent", 0),
          (val_sub,reg22, 7),
          (agent_set_hit_points,":cur_agent",reg22, 0),

          #debug message
          # (str_store_agent_name, s1, ":cur_agent"),
          # (display_message, "@{s1} has {reg22} hp"),

          (le,reg22, 1),
          (remove_agent,":cur_agent"),
      (try_end),
      (try_begin),
          (neg|agent_is_non_player, ":cur_agent"),
          (mission_cam_set_screen_color, 0xFF000000),
          (mission_cam_animate_to_screen_color, 0x4D000000, 2000),
          (display_message, "@The poison decreases your health!", 0x3F8000),
      #debug message
      # (else_try),
          # (str_store_agent_name, s1, ":cur_agent"),
          # (display_message, "@The poison decreases {s1} health!"),
      (try_end),

      (try_begin),
          (eq, ":is_poisoned", 0),
          (try_begin),
              (neg|agent_is_non_player, ":cur_agent"),
              (display_message, "@You are no longer poisoned", color_good_news),
          #debug message
          # (else_try),
              # (str_store_agent_name, s1, ":cur_agent"),
              # (display_message, "@{s1} is no longer poisoned", color_good_news),
          (try_end),
      (try_end),
      (agent_set_slot, ":cur_agent", slot_agent_is_poisoned, ":is_poisoned"),
  (try_end),
])

chariot_triggers = [
  (ti_before_mission_start, 0, 0, [],[
    (assign, "$g_player_chariot_agent", -1),
  ]),
  # clear chariot animation
  (ti_on_agent_mount, 0, 0, [
    (neg|is_vanilla_warband),
  ],[
    (store_trigger_param_1, ":rider"),
    (store_trigger_param_2, ":horse"),
    (agent_is_active, ":rider"),
    (agent_is_alive, ":rider"),
    (agent_get_item_id, ":chariot", ":horse"),
    (this_or_next|eq, ":chariot", "itm_quadriga_chariot_horse"),
    (this_or_next|eq, ":chariot", "itm_basic_chariot_b_horse"),
    (eq, ":chariot", "itm_basic_chariot_horse"),
    (agent_get_slot, ":instance", ":horse", slot_agent_chariot_prop_instance),
    (scene_prop_set_slot, ":instance", slot_scene_prop_init, 1),
  ]),
  (ti_on_agent_dismount, 0, 0, [
    (neg|is_vanilla_warband),
  ],[
    (store_trigger_param_1, ":rider"),
    (store_trigger_param_2, ":horse"),
    (agent_is_active, ":rider"),
    (agent_is_alive, ":rider"),
    # (agent_is_active, ":horse"),
    (agent_get_item_id, ":chariot", ":horse"),
    (this_or_next|eq, ":chariot", "itm_quadriga_chariot_horse"),
    (this_or_next|eq, ":chariot", "itm_basic_chariot_b_horse"),
    (eq, ":chariot", "itm_basic_chariot_horse"),
    (agent_set_animation, ":rider", "anim_rider_fall_roll",0),
    (try_begin),# disable camera on dismount for player
        (neg|agent_is_non_player, ":rider"),
        (assign, "$g_player_chariot_agent", -1),
        (mission_cam_set_mode, 0),
    (try_end),
    (display_message, "@Trigger ti_on_agent_dismount"),
  ]),
  (ti_on_agent_killed_or_wounded, 0, 0, [
    (neg|is_vanilla_warband),
  ],[
    (store_trigger_param_1, ":agent"),
    (agent_is_active, ":agent"),
    # (try_begin),
    #   (agent_is_human, ":agent"),
    #   (agent_get_horse, ":horse", ":agent"),
    #   (agent_is_active, ":horse"),
    # (try_end),
    (try_begin),# disable camera on player death
      (ge, "$g_player_chariot_agent", 0),
      (neg|agent_is_non_player, ":agent"),
      (assign, "$g_player_chariot_agent", -1),
      (mission_cam_set_mode, 0),

      (display_message, "@Diasble chariot camera. Reason: Player dead"),
    (else_try),# disable camera on horse death
      (eq, ":agent", "$g_player_chariot_agent"),
      (assign, "$g_player_chariot_agent", -1),
      (mission_cam_set_mode, 0),
      (display_message, "@Diasble chariot camera. Reason: Horse dead"),
    (try_end),
  ]),
  #dismount player with m-key
  (0, 0, 0, [
    (neg|is_vanilla_warband),
    (ge, "$g_player_chariot_agent", 0),
    (key_clicked, key_f),
  ],[
    (get_player_agent_no, ":player"),
    # (agent_get_horse, ":horse", ":player"),
    # (gt, ":horse", -1),
    (agent_is_alive, "$g_player_chariot_agent"),

    (agent_get_item_id, ":chariot", "$g_player_chariot_agent"),
    (this_or_next|eq, ":chariot", "itm_quadriga_chariot_horse"),
    (this_or_next|eq, ":chariot", "itm_basic_chariot_b_horse"),
    (eq, ":chariot", "itm_basic_chariot_horse"),

    # (agent_start_running_away, "$g_player_chariot_agent"),
    (agent_set_horse, ":player", -1),

    (agent_set_animation, ":player", "anim_dismount_chariot",0),

    # (agent_set_slot, "$g_player_chariot_agent", slot_agent_is_running_away, 1),
    # does not work
    # (agent_stop_running_away, "$g_player_chariot_agent"),

    (assign, "$g_player_chariot_agent", -1),
    (mission_cam_set_mode, 0),
  ]),
  (0, 0, 0, [
    (neg|is_vanilla_warband),
    (ge, "$g_player_chariot_agent", 0),
    (mission_cam_set_mode, 0),
  ],[
    (try_begin),
      (neg|is_camera_in_first_person),
      (get_player_agent_no, ":player"),
      (mission_cam_set_mode, 1),
      (agent_get_position, pos47, ":player"),
      (position_move_z, pos47, 350),#always cm
      (position_move_y, pos47, -700),
      (mission_cam_set_position, pos47),
    (else_try),
      (mission_cam_set_mode, 0),
    (try_end),
  ]),
  (0.5, 0, 0, [
    (neg|is_vanilla_warband),
  ],[
    (call_script, "script_chariot_trigger", "spr_basic_chariot_b"),
  ]),
  (0.5, 0, 0, [
    (neg|is_vanilla_warband),
  ],[
    (call_script, "script_chariot_trigger", "spr_basic_chariot"),
  ]),
  (0.5, 0, 0, [
    (neg|is_vanilla_warband),
  ],[
    (call_script, "script_chariot_trigger", "spr_quadriga_chariot"),
  ]),
]

global_common_triggers = [
  (0, 0, 0,[
    (key_clicked, key_j),
  ],[
		(options_get_combat_speed, ":speed"),
		(try_begin),
			(eq, ":speed", 0),
			(options_set_combat_speed, 1),
			(display_message, "@Changed agent movement speed from: slowest to slow",message_alert),
		(else_try),
			(eq, ":speed", 1),
			(options_set_combat_speed, 2),
			(display_message, "@Changed agent movement speed from: slow to normal",message_alert),
		(else_try),
			(eq, ":speed", 2),
			(options_set_combat_speed, 3),
			(display_message, "@Changed agent movement speed from: normal to fast",message_alert),
		(else_try),
			(eq, ":speed", 3),
			(options_set_combat_speed, 4),
			(display_message, "@Changed agent movement speed from: fast to fastest",message_alert),
		(else_try),
			(eq, ":speed", 4),
			(options_set_combat_speed, 0),
			(display_message, "@Changed agent movement speed from: fastest to slowest",message_alert),
		(try_end),
    (try_for_agents, ":agent_no"),
      (agent_is_active, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (call_script, "script_advanced_agent_set_speed_modifier",":agent_no", 100),
    (try_end),
  ]),

  (0, 0, 0, [
    (key_is_down, key_f1),#hold position order
    (eq, "$g_is_in_slow_mode", 0),
  ],[
    (set_fixed_point_multiplier, 1000),
    (mission_get_time_speed, "$g_is_in_slow_mode"),
    (gt, "$g_is_in_slow_mode", 1000),
    (mission_set_time_speed, 900),  # below code causes problems with orders
  ]),

  (0, 0, 0, [
    (neg|key_is_down, key_f1),#hold position order
    (ge, "$g_is_in_slow_mode", 1),
  ],[
    (set_fixed_point_multiplier, 1000),
    (val_max, "$g_is_in_slow_mode", 8),
    (mission_set_time_speed, "$g_is_in_slow_mode"),
    (assign, "$g_is_in_slow_mode", 0),
  ]),

  (0, 0, 0, [
    # (eq, "$g_is_in_slow_mode", 0),
    (this_or_next|key_is_down, key_left_control),
    (key_is_down, key_right_control),

    (this_or_next|key_clicked, key_numpad_0),
    (this_or_next|key_clicked, key_numpad_1),
    (this_or_next|key_clicked, key_numpad_2),
    (this_or_next|key_clicked, key_numpad_3),
    (this_or_next|key_clicked, key_numpad_4),
    (this_or_next|key_clicked, key_numpad_5),
    (this_or_next|key_clicked, key_numpad_6),
    (this_or_next|key_clicked, key_numpad_7),
    (this_or_next|key_clicked, key_numpad_8),
    (key_clicked, key_numpad_9),
  ],[
    (set_fixed_point_multiplier, 1000),
    (try_begin),
      (key_clicked, key_numpad_0),
      (mission_set_time_speed, 8), #btw 8 is lowest speed we can animate well at 1 millisecond
      (display_message, "@Set time-flow to lowest", message_alert),
    (else_try),
      (key_clicked, key_numpad_1),
      (mission_set_time_speed, 250),
      (display_message, "@Set time-flow to 0.25", message_alert),
    (else_try),
      (key_clicked, key_numpad_2),
      (mission_set_time_speed, 500),
      (display_message, "@Set time-flow to 0.50", message_alert),
    (else_try),
      (key_clicked, key_numpad_3),
      (mission_set_time_speed, 750),
      (display_message, "@Set time-flow to 0.75", message_alert),
    (else_try),
      (key_clicked, key_numpad_4),
      (mission_set_time_speed, 1000),
      (display_message, "@Set time-flow to normal", message_alert),
    (else_try),
      (key_clicked, key_numpad_5),
      (mission_set_time_speed, 1250),
      (display_message, "@Set time-flow to 1.25", message_alert),
    (else_try),
      (key_clicked, key_numpad_6),
      (mission_set_time_speed, 1500),
      (display_message, "@Set time-flow to 1.50", message_alert),
    (else_try),
      (key_clicked, key_numpad_7),
      (mission_set_time_speed, 1750),
      (display_message, "@Set time-flow to 1.75", message_alert),
    (else_try),
      (key_clicked, key_numpad_8),
      (mission_set_time_speed, 2000),
      (display_message, "@Set time-flow to 2.00", message_alert),
    (else_try),
      (key_clicked, key_numpad_9),
      (mission_set_time_speed, 2250),
      (display_message, "@Set time-flow to 2.25", message_alert),
    (try_end),
  ]),

  #crouching should only be available while hunting
  (ti_on_agent_spawn, 0, 0, [ ],[
    (store_trigger_param_1, ":agent_no"),
    # (agent_get_troop_id, ":troop", ":agent_no"),
    # (neq, ":troop", "trp_phalanx"),
    (agent_ai_set_can_crouch, ":agent_no", 0),
  ]),

  poisoned_arrows_hit,
  poisoned_arrows_damage,

  ###um kaempfe langsamer zu machen
  (ti_on_agent_spawn, 0, 0, [ ],[
    (store_trigger_param_1, ":agent_no"),
    (agent_is_active, ":agent_no"),
    (agent_is_human, ":agent_no"),
    (agent_is_alive, ":agent_no"),

    ## modify damage accoriding to weapon quality
    (try_begin),
        (agent_get_party_id, ":agent_party", ":agent_no"),
        (party_is_active, ":agent_party"),
        (store_faction_of_party, ":faction_party", ":agent_party"),
        (faction_get_slot, ":quality", ":faction_party", dplmc_slot_faction_quality),
        (neq, ":quality", 0),
        (assign, ":damage_mod", 100),
        (agent_get_damage_modifier, ":damage_mod", ":agent_no"),
        (val_add, ":quality", 100),
        (val_mul, ":damage_mod", ":quality"),
        (val_div, ":damage_mod", 100),
        (agent_set_damage_modifier, ":agent_no", ":damage_mod"),
    (try_end),

    (call_script, "script_advanced_agent_set_speed_modifier",":agent_no", 100),

    ####this code is to set Roman armors according to climate
    #switch to winter version for roman boots
    (try_begin),
        (call_script, "script_cf_snow_on_scene", "p_main_party"),
        (agent_get_item_slot, ":body", ":agent_no", ek_body),
        (is_between, ":body", "itm_aquilifer_legion_squamata_1", "itm_aux_slinger"),#wears Roman military equipment
        (agent_get_item_slot, ":item", ":agent_no", ek_foot),
        (try_begin),
            (this_or_next|eq, ":item", "itm_legio_armored_caligea_2"),
            (this_or_next|eq, ":item", "itm_legio_armored_caligea"),
            (this_or_next|eq, ":item", "itm_centurio_west_graves"),
            (this_or_next|eq, ":item", "itm_centurio_east_graves"),
            (this_or_next|eq, ":item", "itm_centurio_praetorian_graves"),
            (this_or_next|eq, ":item", "itm_aux_centurio_graves"),
            (this_or_next|eq, ":item", "itm_graves_simple"),
            (eq, ":item", "itm_graves_simple_2"),
            (agent_unequip_item, ":agent_no",":item"),
            (val_add, ":item", 1),
        (else_try),
            (this_or_next|is_between, ":item", "itm_eastern_shoe", "itm_cataphract_boots"),
            (is_between, ":item", "itm_female_caligea_gold", "itm_legio_armored_caligea_2"),
            (agent_unequip_item, ":agent_no",":item"),
            (assign, ":item", "itm_graves_simple_winter"),
        (else_try),
            (agent_is_non_player, ":agent_no"),
            (assign, ":item", "itm_graves_simple_winter"),
        (try_end),
        (gt, ":item", -1),
        (agent_equip_item, ":agent_no",":item", ek_foot),
        # (agent_set_slot, ":agent_no", slot_agent_tournament_point, 1),
    (try_end),
  ]),

  (ti_battle_window_opened,0,0, [
      # (this_or_next|game_key_clicked, gk_inventory_window),
      # (game_key_is_down, gk_inventory_window),
      (call_script, "script_cf_snow_on_scene", "p_main_party"),
  ],[
      (get_player_agent_no, ":agent_no"),
      (agent_is_active, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_item_slot, ":body", ":agent_no", ek_body),
      (is_between, ":body", "itm_aquilifer_legion_squamata_1", "itm_aux_slinger"),#wears Roman military equipment
      (agent_get_item_slot, ":item", ":agent_no", ek_foot),
      (try_begin),
          (this_or_next|eq, ":item", "itm_legio_armored_caligea_2"),
          (this_or_next|eq, ":item", "itm_legio_armored_caligea"),
          (this_or_next|eq, ":item", "itm_centurio_west_graves"),
          (this_or_next|eq, ":item", "itm_centurio_east_graves"),
          (this_or_next|eq, ":item", "itm_centurio_praetorian_graves"),
          (this_or_next|eq, ":item", "itm_aux_centurio_graves"),
          (this_or_next|eq, ":item", "itm_graves_simple"),
          (eq, ":item", "itm_graves_simple_2"),
          (agent_unequip_item, ":agent_no",":item"),
          (val_add, ":item", 1),
      (else_try),
          (this_or_next|is_between, ":item", "itm_eastern_shoe", "itm_cataphract_boots"),
          (is_between, ":item", "itm_female_caligea_gold", "itm_legio_armored_caligea_2"),
          (agent_unequip_item, ":agent_no",":item"),
          (assign, ":item", "itm_graves_simple_winter"),
      (try_end),
      (gt, ":item", -1),
      (agent_equip_item, ":agent_no",":item",ek_foot),
  ]),
  (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent"),
      (agent_get_troop_id, ":troop_no", ":dead_agent"),
      (is_between, ":troop_no", household_slaves_begin, cook_slaves_end),
      (str_store_troop_name, s0, ":troop_no"),
      (display_message, "@Your slave {s0} died!", message_negative),
      (troop_set_slot, ":troop_no", slot_slave_template_troop, 0),
  ]),
] + chariot_triggers

small_battle_check = (ti_on_agent_spawn, 0, 0,[
    (store_add, ":total_size", "$g_friend_fit_for_battle", "$g_enemy_fit_for_battle"),
    (le, ":total_size", 100),
  ],[
    (store_trigger_param_1, ":agent_to_move"),
    (agent_is_active, ":agent_to_move"),

    (get_scene_boundaries, pos10, pos11),
    (set_fixed_point_multiplier, 100),
    (position_get_x, ":scene_max_x", pos11),
    (position_get_y, ":scene_max_y", pos11),
    (val_add, ":scene_max_x", 2400), # 2400 has been subtracted automatically because of barriers from outer terrain
    (val_add, ":scene_max_y", 2400),
    (val_div, ":scene_max_x", 2),
    (val_div, ":scene_max_y", 2),
    (position_set_x, pos11, ":scene_max_x"),
    (position_set_y, pos11, ":scene_max_y"),

    (agent_get_position, pos10, ":agent_to_move"),
    (call_script, "script_point_y_toward_position", pos10, pos11),

    (position_get_x, ":x", pos10),
    (store_random_in_range, ":x_addition", -2000, 2000),
    (val_add, ":x", ":x_addition"),
    (position_set_x, pos10, ":x"),

    (get_distance_between_positions, ":y_to_move", pos10, pos11),
    (val_div, ":y_to_move", 7),
    (val_mul, ":y_to_move", 5),
    (position_move_y, pos10, ":y_to_move"),

    (agent_set_position, ":agent_to_move", pos10),
])

voice_order_sounds = (ti_on_order_issued, 0, 1, [],[
  (troop_slot_eq, "trp_player", slot_troop_culture, "fac_culture_7"),
  (store_trigger_param_1,":order"),
  (store_trigger_param_2,":agent_id"),
  (agent_is_active, ":agent_id"),
  (agent_is_alive, ":agent_id"),
  (call_script, "script_dplmc_store_troop_is_female", "trp_player"),
  (eq, reg0, 0),
  (try_begin),
      (eq,":order", mordr_hold), #mantener la posicion
      (agent_play_sound, ":agent_id", "snd_order_hold"),
  # (else_try),
      # (eq,":order", mordr_follow), #seguidme
      # (agent_play_sound, ":agent_id", "snd_orden_seguidme"),
  (else_try),
      (eq,":order", mordr_charge), #carga
      (agent_play_sound, ":agent_id", "snd_order_charge"),
  (else_try),
      (eq,":order", mordr_stand_closer), #densa
      (agent_play_sound, ":agent_id", "snd_order_stand_closer"),
  (else_try),
      (eq,":order", mordr_spread_out), #dispersa
      (agent_play_sound, ":agent_id", "snd_order_spread"),
  (else_try),
      (eq,":order", mordr_advance), #dispersa
      (agent_play_sound, ":agent_id", "snd_order_hold"),
  (else_try),
      (eq,":order", mordr_follow), #dispersa
      (agent_play_sound, ":agent_id", "snd_order_hold"),
  (else_try),
      (eq,":order", mordr_fall_back), #dispersa
      (agent_play_sound, ":agent_id", "snd_order_retreat"),
  (else_try),
      (eq,":order", mordr_stand_ground), #alto
      (agent_play_sound, ":agent_id", "snd_order_hold"),
  (else_try),
      (eq,":order", mordr_fire_at_will), #disparo
      (agent_play_sound, ":agent_id", "snd_order_fire"),
  (else_try),
      (eq,":order", mordr_hold_fire),  #alto disparo
      (agent_play_sound, ":agent_id", "snd_order_hold_fire"),
  (try_end),
])

camera_controls = [ #7 triggers
  (ti_before_mission_start, 0, 0, [],[
    (assign, "$cam_mode", 0),
  ]),

  (ti_battle_window_opened, 0, 0, [],[
    (assign, "$cam_seeking_mouse", Far_Away)
  ]),

  # (ti_escape_pressed, 0, 0, [],[
  #   (assign, "$cam_mode", 0),
  # ]),

  (0, 0, 0, [
    (neq, "$cam_mode", 0),
    (set_fixed_point_multiplier, 1000),
    (mission_get_time_speed, ":interval"),
    (val_mul, ":interval", camera_trigger_interval*1000),
    (val_div, ":interval", 1000),
    (store_mission_timer_c_msec, reg0),
    (store_sub, ":elapsed", reg0, "$cam_last_called"),
    (gt, ":elapsed", ":interval"),
  ],[

    (assign, "$cam_last_called", reg0),
    (assign, ":change_pitch", 0),
    (assign, ":change_yaw", 0),
    (assign, ":change_zoom", 0),
    (assign, ":pan_back_forth", 0),
    (assign, ":pan_right_left", 0),
    (assign, ":pan_up_down", 0),
    (assign, ":has_rotated", 0),

    #check zoom keys
    (try_begin),
      (key_is_down, key_numpad_plus),
      (store_div, reg0, "$cam_speed", 30),
      (val_add, reg0, 1),
      (val_sub, reg0, "$cam_zoom"),
      (val_mul, reg0, -1),
      (try_begin),
        (gt, reg0, camera_effective_min_zoom),
        (assign, "$cam_zoom", reg0),
        (assign, ":change_zoom", 1),
      (try_end),
    (else_try),
      (key_is_down, key_numpad_minus),
      (store_div, reg0, "$cam_speed", 30),
      (val_add, reg0, 1),
      (val_add, reg0, "$cam_zoom"),
      (try_begin),
        (le, reg0, 75),  #although it will zoom out to around 150 or so, it starts looking distorted past this point
        (assign, "$cam_zoom", reg0),
        (assign, ":change_zoom", 1),
      (try_end),
    (try_end),

    #check pan back and forth keys
    (store_and, reg0, "$cam_mode", camera_pan_back_forth),
    (try_begin),
      (gt, reg0, 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (store_mul, ":pan_back_forth", "$cam_speed", 1),
      (else_try),
        (game_key_is_down, gk_move_backward),
        (store_mul, ":pan_back_forth", "$cam_speed", -1),
      (try_end),
    (try_end),

    #check pan right and left keys
    (store_and, reg0, "$cam_mode", camera_pan_right_left),
    (try_begin),
      (gt, reg0, 0),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (store_mul, ":pan_right_left", "$cam_speed", 1),
      (else_try),
        (game_key_is_down, gk_move_left),
        (store_mul, ":pan_right_left", "$cam_speed", -1),
      (try_end),
    (try_end),

    #check pan up and down keys
    (store_and, reg0, "$cam_mode", camera_pan_up_down),
    (try_begin),
      (gt, reg0, 0),
      (try_begin),
        (key_is_down, key_f),
        (store_mul, ":pan_up_down", "$cam_speed", 1),
      (else_try),
        (key_is_down, key_c),
        (store_mul, ":pan_up_down", "$cam_speed", -1),
      (else_try),
        (key_is_down, key_v), #c is character report
        (store_mul, ":pan_up_down", "$cam_speed", -1),
      (try_end),
    (try_end),

    #handle diagonals
    (try_begin),
      (neq, ":pan_back_forth", 0),
      (neq, ":pan_right_left", 0),
      (neq, ":pan_up_down", 0),
      (val_mul, ":pan_back_forth", 1000),
      (val_div, ":pan_back_forth", 1732),
      (val_mul, ":pan_right_left", 1000),
      (val_div, ":pan_right_left", 1732),
      (val_mul, ":pan_up_down", 1000),
      (val_div, ":pan_up_down", 1732),
    (else_try),
      (neq, ":pan_back_forth", 0),
      (neq, ":pan_right_left", 0),
      (val_mul, ":pan_back_forth", 1000),
      (val_div, ":pan_back_forth", 1414),
      (val_mul, ":pan_right_left", 1000),
      (val_div, ":pan_right_left", 1414),
    (else_try),
      (neq, ":pan_up_down", 0),
      (neq, ":pan_right_left", 0),
      (val_mul, ":pan_up_down", 1000),
      (val_div, ":pan_up_down", 1414),
      (val_mul, ":pan_right_left", 1000),
      (val_div, ":pan_right_left", 1414),
    (else_try),
      (neq, ":pan_back_forth", 0),
      (neq, ":pan_up_down", 0),
      (val_mul, ":pan_back_forth", 1000),
      (val_div, ":pan_back_forth", 1414),
      (val_mul, ":pan_up_down", 1000),
      (val_div, ":pan_up_down", 1414),
    (try_end),

    #check rotation
    (store_and, reg0, "$cam_mode", camera_rotate),
    (try_begin),
      (gt, reg0, 0),
      #check pitch keys
      (assign, ":min_one", "$cam_speed"),
      (convert_to_fixed_point, ":min_one"),
      (store_sqrt, reg0, ":min_one"),
      (convert_from_fixed_point, reg0),
      (store_add, ":min_one", reg0, camera_key_rotate_attenuator),
      (store_and, ":rev_y", "$cam_mode", camera_reverse_y),
      (try_begin),
        (key_is_down, key_up),
        (try_begin),
          (eq, ":rev_y", 0),
          (store_div, ":change_pitch", ":min_one", camera_key_rotate_attenuator),
        (else_try),
          (store_div, ":change_pitch", ":min_one", -1 * camera_key_rotate_attenuator),
        (try_end),

      (else_try),
        (key_is_down, key_down),
        (try_begin),
          (eq, ":rev_y", 0),
          (store_div, ":change_pitch", ":min_one", -1 * camera_key_rotate_attenuator),
        (else_try),
          (store_div, ":change_pitch", ":min_one", camera_key_rotate_attenuator),
        (try_end),
      (try_end),

      #check yaw keys
      (try_begin),
        (key_is_down, key_right),
        (store_div, ":change_yaw", ":min_one", -1 * camera_key_rotate_attenuator),
      (else_try),
        (key_is_down, key_left),
        (store_div, ":change_yaw", ":min_one", camera_key_rotate_attenuator),
      (try_end),

      #handle diagonal
      (try_begin),
        (neq, ":change_yaw", 0),
        (try_begin),
          (neq, ":change_pitch", 0),
          (val_mul, ":change_yaw", 1000),
          (val_div, ":change_yaw", 1414),
          (val_mul, ":change_pitch", 1000),
          (val_div, ":change_pitch", 1414),
        (try_end),
        (val_add, "$cam_yaw", ":change_yaw"),
      (try_end),

      #check mouse rotation
      (try_begin),
        (eq, ":change_pitch", 0),
        (eq, ":change_yaw", 0),
        (gt, "$cam_displacements", 0),

        (store_div, ":change_yaw", "$cam_displace_x", "$cam_displacements"),
        (val_mul, ":change_yaw", -1),
        (store_div, ":change_pitch", "$cam_displace_y", "$cam_displacements"),

        (store_and, reg0, "$cam_mode", camera_reverse_y),
        (try_begin),
          (neq, reg0, 0),
          (val_mul, ":change_pitch", -1),
        (try_end),

        (val_clamp, ":change_yaw", -179, 180),
        (val_add, "$cam_yaw", ":change_yaw"),
      (try_end),

      #pitch ceiling/floor
      (neq, ":change_pitch", 0),
      (store_add, reg0, "$cam_pitch", ":change_pitch"),

      (try_begin),
        (is_between, reg0, camera_minimum_pitch, camera_maximum_pitch),
        (assign, "$cam_pitch", reg0),
      (else_try),
        (assign, ":change_pitch", 0),
      (try_end),
    (try_end),  #rotation
    (assign, "$cam_displace_x", 0),
    (assign, "$cam_displace_y", 0),
    (assign, "$cam_displacements", 0),

    #check for camera targets
    (mission_cam_get_position, pos0),
    (set_fixed_point_multiplier, 100),
    (store_and, ":target", "$cam_mode", camera_target_agent|camera_target_prop),
    (try_begin),
      (neq, ":target", 0),
      (store_and, reg0, "$cam_mode", camera_target_agent),

      #we're following an agent
      (try_begin),
        (neq, reg0, 0),
        (try_begin),
          (agent_is_active, "$cam_target_instance"),
          (agent_get_position, pos1, "$cam_target_instance"),
          (position_move_z, pos1, camera_minimum_z),
        (else_try),
          (assign, "$cam_target_instance", 0),
        (try_end),

        #we're following a prop
      (else_try),
        (prop_instance_is_valid, "$cam_target_instance"),
        (prop_instance_get_position, pos1, "$cam_target_instance"),
      (else_try),
        (assign, "$cam_target_instance", 0),
      (try_end),

      #have the camera "follow" the target
      (gt, "$cam_target_instance", 0),
      (copy_position, pos2, pos0), #not going to move the camera now, as we need to pass the various tests, etc., so we do it by ordering pans
      (position_get_z, ":from_z", pos1),
      (position_set_z, pos2, ":from_z"),  #set on same plane as target as we'll be breaking down horizontal and vertical distance to move
      (call_script, "script_point_y_toward_position", pos1, pos2),

      (assign, ":old_horizontal_dist", reg0),
      (position_get_z, reg0, pos0),
      (store_sub, ":old_vertical_dist", reg0, ":from_z"),

      #find new camera location
      (val_add, "$cam_above_target", ":pan_up_down"),
      (val_max, "$cam_above_target", 50), #avoid overrunning target

      (copy_position, pos2, pos1),
      (store_mul, ":horizontal_dist", camera_fixed_angle_h, "$cam_above_target"),
      (val_div, ":horizontal_dist", camera_fixed_angle_v),
      (position_move_y, pos2, ":horizontal_dist"),

      #capture yaw
      (position_get_rotation_around_z, ":has_rotated", pos0),
      (call_script, "script_point_y_toward_position", pos2, pos1),
      (position_copy_rotation, pos0, pos2),
      (position_get_rotation_around_z, reg0, pos0),
      (val_sub, ":has_rotated", reg0),

      #prep for various checks
      (store_sub, ":pan_back_forth", ":old_horizontal_dist", ":horizontal_dist"),
      (store_sub, ":pan_up_down", "$cam_above_target", ":old_vertical_dist"),

      #rotate default properly
    (else_try),
      (position_get_x, ":from_x", pos0),
      (position_get_y, ":from_y", pos0),
      (position_get_z, ":from_z", pos0),
      (init_position, pos0),
      (position_set_x, pos0, ":from_x"),
      (position_set_y, pos0, ":from_y"),
      (position_set_z, pos0, ":from_z"),
    (try_end),

    (position_rotate_z, pos0, "$cam_yaw"),

    #handle rotating camera first
    (store_and, ":rotate_first", "$cam_mode", camera_pan_to_rotation),
    (try_begin),
      (neq, ":rotate_first", 0),
      (eq, ":target", 0), #targets have special panning
      (position_rotate_x, pos0, "$cam_pitch"),

      (assign, reg0, "$cam_pitch"),
      (convert_to_fixed_point, reg0),
      (store_sin, ":sine_pitch", reg0),
      (store_cos, ":cosine_pitch", reg0),

      (store_mul, ":x_proj_x", ":pan_back_forth", ":cosine_pitch"),
      (store_mul, ":x_proj_y", ":pan_up_down", ":sine_pitch"),
      (store_mul, ":y_proj_x", ":pan_back_forth", ":sine_pitch"),
      (store_mul, ":y_proj_y", ":pan_up_down", ":cosine_pitch"),

      (store_add, ":pan_back_forth", ":x_proj_x", ":x_proj_y"),
      (convert_from_fixed_point, ":pan_back_forth"),
      (store_add, ":pan_up_down", ":y_proj_x", ":y_proj_y"),
      (convert_from_fixed_point, ":pan_up_down"),
    (try_end),

    #check boundaries
    (try_begin),
      (this_or_next|neq, ":pan_back_forth", 0),
      (neq, ":pan_right_left", 0),

      (copy_position, pos1, pos0),
      (position_move_x, pos1, ":pan_right_left"),
      (position_move_y, pos1, ":pan_back_forth"),

      (position_get_x, ":from_x", pos1),
      (is_between, ":from_x", "$g_bound_left", "$g_bound_right"),
      (position_get_y, ":from_y", pos1),
      (is_between, ":from_y", "$g_bound_bottom", "$g_bound_top"),
      (copy_position, pos0, pos1),

      #check terrain
      (call_script, "script_get_distance_to_terrain_or_water", pos0),
      (assign, ":dist_to_terrain", reg0),
      (store_and, reg0, "$cam_mode", camera_follow_terrain),
      (try_begin),
        (gt, reg0, 0),  #follow terrain
        (store_sub, reg0, "$cam_to_terrain", ":dist_to_terrain"),
        (val_add, "$cam_z", reg0),
        (position_set_z, pos0, "$cam_z"),

      (else_try),
        (store_sub, reg0, camera_minimum_z, ":dist_to_terrain"),
        (gt, reg0, 0),
        (assign, "$cam_to_terrain", camera_minimum_z),
        (val_add, "$cam_z", reg0),
        (position_set_z, pos0, "$cam_z"),

      (else_try),
        (assign, "$cam_to_terrain", ":dist_to_terrain"),
      (try_end),

      #out of bounds
    (else_try),
      (assign, ":pan_back_forth", 0),
      (assign, ":pan_right_left", 0),
    (try_end),

    #check ground
    (try_begin),
      (lt, ":pan_up_down", 0),
      (val_mul, ":pan_up_down", -1),
      (call_script, "script_get_distance_to_terrain_or_water", pos0),
      (val_sub, reg0, camera_minimum_z),
      (val_max, reg0, 0),
      (val_min, ":pan_up_down", reg0),
      (try_begin),
        (gt, ":pan_up_down", 0),
        (val_sub, "$cam_to_terrain", ":pan_up_down"),
        (val_sub, "$cam_z", ":pan_up_down"),
        (position_set_z, pos0, "$cam_z"),
      (try_end),

      #check ceiling
    (else_try),
      (gt, ":pan_up_down", 0),
      (call_script, "script_get_distance_to_terrain_or_water", pos0),
      (val_add, reg0, ":pan_up_down"),
      (try_begin),
        (gt, reg0, 5000),  #50m
        (val_sub, "$cam_above_target", ":pan_up_down"),
        (assign, ":pan_up_down", 0),
      (else_try),
        (val_add, "$cam_to_terrain", ":pan_up_down"),
        (val_add, "$cam_z", ":pan_up_down"),
        (position_set_z, pos0, "$cam_z"),
      (try_end),
    (try_end),

    #apply change
    (this_or_next|neq, ":change_pitch", 0),
    (this_or_next|neq, ":change_yaw", 0),
    (this_or_next|neq, ":change_zoom", 0),
    (this_or_next|neq, ":pan_back_forth", 0),
    (this_or_next|neq, ":pan_right_left", 0),
    (this_or_next|neq, ":pan_up_down", 0),
    (neq, ":has_rotated", 0),

    (try_begin),
      (eq, ":rotate_first", 0),
      (position_rotate_x, pos0, "$cam_pitch"),
    (try_end),

    (set_fixed_point_multiplier, 1000),
    (mission_get_time_speed, ":interval"),
    (val_mul, ":interval", camera_animation_time),
    (val_div, ":interval", 1000),
    (mission_cam_animate_to_position_and_aperture, pos0, "$cam_zoom", ":interval"),
  ]),

  (0, 0, 0, [
    (neq, "$cam_mode", 0),
  ],[
    #toggle camera_follow_terrain
    (try_begin),
      (key_clicked, key_q),
      (store_and, reg0, "$cam_mode", camera_follow_terrain),
      (try_begin),
        (eq, reg0, 0),
        (val_or, "$cam_mode", camera_follow_terrain),
        (display_message, "@Camera follow terrain mode ON."),
      (else_try),
        (val_sub, "$cam_mode", camera_follow_terrain),
        (display_message, "@Camera follow terrain mode OFF."),
      (try_end),
    (try_end),

    #toggle flip y
    (try_begin),
      (key_clicked, key_y),
      (store_and, reg0, "$cam_mode", camera_reverse_y),
      (try_begin),
        (eq, reg0, 0),
        (val_or, "$cam_mode", camera_reverse_y),
      (else_try),
        (val_sub, "$cam_mode", camera_reverse_y),
      (try_end),
    (try_end),

    #toggle pan to rotation
    (try_begin),
      (key_clicked, key_r),
      (store_and, reg0, "$cam_mode", camera_pan_to_rotation),
      (try_begin),
        (eq, reg0, 0),
        (val_or, "$cam_mode", camera_pan_to_rotation),
        (display_message, "@Camera rotate before pan ON."),
      (else_try),
        (val_sub, "$cam_mode", camera_pan_to_rotation),
        (display_message, "@Camera rotate before pan OFF."),
      (try_end),
    (try_end),

    #pan velocity
    (try_begin),
      (key_clicked, key_mouse_scroll_up),
      (val_mul, "$cam_speed", 2),
    (try_end),

    (try_begin),
      (key_clicked, key_mouse_scroll_down),
      (val_add, "$cam_speed", 1),
      (val_div, "$cam_speed", 2),
    (try_end),
    #rotation by mouse
    (try_begin),
      (store_and, reg0, "$cam_mode", camera_rotate),
      (gt, reg0, 0),

      (mouse_get_position, pos0),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg0, pos0),
      (position_get_y, reg1, pos0),

      #mouse hasn't moved
      (try_begin),
        (eq, "$cam_mouse_x", reg0),
        (eq, "$cam_mouse_y", reg1),

        #reassign center
        (try_begin),
          (is_between, reg0, 485, 501), #observed values for centered mouse
          (is_between, reg1, 375, 501),
          (val_add, "$cam_clock", 1),

          (eq, "$cam_clock", 3),
          (assign, "$cam_mouse_center_x", reg0),
          (assign, "$cam_mouse_center_y", reg1),
        (try_end),

      (else_try),
        (assign, "$cam_mouse_x", reg0),
        (assign, "$cam_mouse_y", reg1),
        (store_sub, reg0, "$cam_mouse_x", "$cam_mouse_center_x"),
        (store_sub, reg1, "$cam_mouse_y", "$cam_mouse_center_y"),

        #mouse recovering from a button somewhere?
        (neq, "$cam_seeking_mouse", 0),
        (assign, reg2, reg0),
        (val_abs, reg2),

        (try_begin),
          (ge, "$cam_seeking_mouse", reg2),  #mouse still coming in from wherever it was?
          (assign, "$cam_seeking_mouse", reg2),
        (else_try),
          (assign, "$cam_seeking_mouse", 0),
        (try_end),

        #track mouse move
      (else_try),
        (assign, "$cam_clock", 0),
        (val_add, "$cam_displace_x", reg0),
        (val_add, "$cam_displace_y", reg1),
        (val_add, "$cam_displacements", 1),
      (try_end),
    (try_end),
  ]),

  (0, 0, 0, [
    (key_clicked, key_enter),
    (neg|main_hero_fallen), #and not the death cam
    # (scene_prop_get_num_instances, reg0, "spr_dyn_ship_substrate"),
    # (le, reg0, 0),  #avoid conflict with naval strategy camera
    (assign,":pass",0),
    (try_begin),
      (neq, "$cam_mode", 0),
      (try_begin),#VC-2097
        (eq, "$cam_first_person_mode", 0),
        (mission_cam_set_mode, 0, 500, 0),
      (else_try),
        (mission_cam_set_mode, 0, 0, 0),
        (set_camera_in_first_person, "$cam_first_person_mode"),
      (try_end),
      (mission_cam_set_aperture,75),
      (assign, "$cam_mode", 0),
      (display_message, "@Disable strategic camera", message_alert),
    (else_try),
      (eq, "$cam_mode", 0),
      # (ge, "$cheat_mode", 1),
      (assign,":pass",1),
      (call_script, "script_save_cam_first_person_mode"),
      (mission_cam_set_mode, 1),
      (set_camera_in_first_person, 0),
      (mission_cam_get_position, pos0),
      (set_fixed_point_multiplier, 100),
      (agent_get_position, pos1, "$fplayer_agent_no"),
      (position_move_z, pos1, camera_minimum_z),
      (position_get_z, reg0, pos1),
      (position_set_z, pos0, reg0), #for some reason, camera position starts 10m above player agent
      (call_script, "script_point_y_toward_position", pos0, pos1),
      (position_move_y, pos0, camera_fixed_angle_h * -1000 / camera_fixed_angle_v),
      (assign, "$cam_above_target", 1000),
      (position_move_z, pos0, "$cam_above_target"),
      (position_get_z, "$cam_z", pos0),
      (call_script, "script_get_distance_to_terrain_or_water", pos0),
      (assign, "$cam_to_terrain", reg0),
      (assign, "$cam_pitch", 330),
      (assign, "$cam_yaw", 0),
      (position_rotate_x, pos0, "$cam_pitch"),
      (mission_cam_animate_to_position, pos0, 500),

      (store_and, reg0, "$first_time", first_time_strategy_camera),
      (try_begin),
        (eq, reg0, 0),
        (val_or, "$first_time", first_time_strategy_camera),
        (eq, "$g_is_quick_battle", 0),
        (str_store_string, s0, "str_strategy_cam"),
        (try_begin),
          (neg|is_presentation_active, "prsnt_battle"),
          (game_key_get_mapped_key_name, s1, gk_view_orders),
          (str_store_string, s0, "@{s0}^^A Battle Command Display is often available by pressing the {s1} key."),
        (try_end),
        (dialog_box, "str_s0", "@Strategy Camera"),
      (try_end),
      (display_message, "@Enable strategic camera", message_alert),
    (try_end),
    (eq,":pass",1),
  ],[
    (eq, "$cam_mode", 0), #test here in case naval battle camera has activated
    (assign, "$cam_mode", camera_pan_up_down|camera_target_agent), #R/L and B/F pans not recommended, as the keys also move player agent
    (assign, "$cam_target_instance", "$fplayer_agent_no"),
    (assign, "$cam_speed", 100), #10 m/s
    (assign, "$cam_last_called", 0),
    (mouse_get_position, pos0),
    (set_fixed_point_multiplier, 1000),
    (position_get_x, "$cam_mouse_center_x", pos0),
    (position_get_y, "$cam_mouse_center_y", pos0),
    (assign, "$cam_seeking_mouse", 0),
    (mission_cam_get_aperture, "$cam_zoom"),
  ]),

  #turn on camera if no player agent
  (0, 3, ti_once, [
    (eq, "$cam_mode", 0),
  ],[
    (try_begin),
      (store_and, reg0, "$first_time", first_time_cam_battle),
      (eq, reg0, 0),
      (val_or, "$first_time", first_time_cam_battle),
      (eq, "$g_is_quick_battle", 0),
      (dialog_box, "str_tactical_controls", "@Tactical Controls"),
    (try_end),
  ]),
] #end camera controls

creeping = [  #4 triggers; requires common_controller_keys*, init $player_functions
  (ti_before_mission_start, 0, 0, [],[
    (assign, "$player_is_creeping", 0),
  ]),

  (0, 0, 0, [
      (game_key_clicked, gk_crouch),
    #  (key_clicked, key_y),
    ],[
    (get_player_agent_no, ":player_agent"),
    (agent_get_horse, ":horse", ":player_agent"),
    (try_begin),
        (eq, "$player_is_creeping", 1),
        (assign, "$player_is_creeping", 0),
        (call_script, "script_advanced_agent_set_speed_modifier", ":player_agent", 100),
        (agent_set_accuracy_modifier, ":player_agent", 100),
        (agent_set_walk_forward_animation, ":player_agent", "anim_walk_forward"),
    (else_try),
        (eq, ":horse", -1),
        (neg|main_hero_fallen),
        (assign, "$player_is_creeping", 1),
        (call_script, "script_advanced_agent_set_speed_modifier", ":player_agent", 40),
        (agent_set_accuracy_modifier, ":player_agent", 125),
        (agent_set_walk_forward_animation, ":player_agent", "anim_walk_forward_crouch"),
    (try_end),
  ]),

  #action that cancels creeping?
  (0, 0, 0, [
      (eq, "$player_is_creeping", 1),

      (this_or_next|game_key_clicked, gk_action), #mounting horse, etc.
      (this_or_next|game_key_clicked, gk_jump),
      (this_or_next|game_key_clicked, gk_kick),
      (game_key_is_down, gk_defend),
    ],[
      (assign, "$player_is_creeping", 0),
      (get_player_agent_no, ":player_agent"),
      (agent_set_crouch_mode, ":player_agent", 0),
      (call_script, "script_advanced_agent_set_speed_modifier", ":player_agent", 100),
      (agent_set_accuracy_modifier, ":player_agent", 100),
      # (agent_set_animation, ":player_agent", "anim_crouch_to_stand", 0),
      # (agent_set_stand_animation, ":player_agent", "anim_stand"),
      (agent_set_walk_forward_animation, ":player_agent", "anim_walk_forward"),
  ]),

  (0, 0, 0, [
      (eq, "$player_is_creeping", 1),
      #(neg|troop_is_mounted, "trp_player"),
      (neg|main_hero_fallen),
    ],[
      (get_player_agent_no, ":player_agent"),
      (agent_get_horse, ":horse", ":player_agent"),
      (eq, ":horse", -1),

      #animation does not work with weapon
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (agent_get_wielded_item, reg1, ":player_agent", 0),
        (gt, reg1, 0),
        (agent_set_wielded_item, ":player_agent", -1),
      (try_end),

      #lost animation?
      (agent_get_animation, reg1, ":player_agent", 0),
      (try_begin),
        (neq, reg1, "anim_walk_forward_crouch"),

        (call_script, "script_advanced_agent_set_speed_modifier", ":player_agent", 40),
        (agent_set_walk_forward_animation, ":player_agent", "anim_walk_forward_crouch"),
      (try_end),

      #lost crouch?
      (agent_get_crouch_mode, reg1, ":player_agent"),
      (try_begin),
        (eq, reg1, 0),
        (neg|game_key_is_down, gk_move_forward),  #let animation work
        (neg|game_key_is_down, gk_move_backward),
        (neg|game_key_is_down, gk_move_left),
        (neg|game_key_is_down, gk_move_right),
        (neg|game_key_is_down, gk_attack),  #don't disrupt attack
        (agent_set_crouch_mode, ":player_agent", 1),
      (try_end),
  ]),
]

elephant_attack = (2, 0, 0,[
    (try_for_agents, ":stepper"),
      (agent_is_alive, ":stepper"),
      (agent_get_troop_id, ":troop", ":stepper"),
      (eq, ":troop", "trp_elephant"),
      (agent_get_position,pos1,":stepper"),
      (try_for_agents,":agent"),
        (agent_is_alive,":agent"),
        (agent_is_human,":agent"),
        (agent_get_team, ":grenadiers_team", ":stepper"),
        (agent_get_team, ":targets_team", ":agent"),
        (teams_are_enemies, ":grenadiers_team", ":targets_team"),
        (agent_get_position,pos3,":agent"),
        (get_distance_between_positions,":dist",pos1,pos3),
        (le,":dist",300),
        (agent_set_animation, ":agent", "anim_rider_fall_roll"),

        (store_agent_hit_points, ":cur_hit_points",":agent",1),
        (val_sub,":cur_hit_points",20),
        (agent_set_hit_points,":agent",":cur_hit_points",1),
        (agent_deliver_damage_to_agent, ":stepper", ":agent", 0),
      (try_end),
    (try_end),
],[])

wild_cat_attack =(2, 0, 0,[
    (try_for_agents, ":tigger"),
      (agent_is_alive, ":tigger"),
      (agent_get_troop_id, ":troop", ":tigger"),
      (this_or_next|eq, ":troop", "trp_wolf"),
      (this_or_next|eq, ":troop", "trp_wild_cat_2"),
      (eq, ":troop", "trp_wild_cat"),
      (agent_get_position,pos1,":tigger"),
      (assign, ":attack", 0),
      (try_for_agents,":agent"),
        (agent_is_alive,":agent"),
        (agent_is_human,":agent"),
        (agent_get_team, ":grenadiers_team", ":tigger"),
        (agent_get_team, ":targets_team", ":agent"),
        (teams_are_enemies, ":grenadiers_team", ":targets_team"),
        (agent_get_position,pos3,":agent"),
        (get_distance_between_positions,":dist",pos1,pos3),
        (le,":dist",250),
        (try_begin),
            (agent_slot_eq, ":agent", slot_agent_walker_occupation, 0),
            (agent_set_animation, ":agent", "anim_rider_fall_roll"),
            (agent_set_slot, ":agent", slot_agent_walker_occupation, 2),
        (else_try),
            (agent_get_slot, ":timer1", ":agent", slot_agent_walker_occupation),
            (val_sub, ":timer1", 1),
            (val_max, ":timer1", 0),
            (agent_set_slot, ":agent", slot_agent_walker_occupation, ":timer1"),
        (try_end),

        (store_agent_hit_points, ":cur_hit_points",":agent",1),
        (try_begin),
            (eq, ":troop", "trp_wolf"),
            (val_sub,":cur_hit_points",8),
        (else_try),
            (val_sub,":cur_hit_points",20),
        (try_end),
        (agent_set_hit_points,":agent",":cur_hit_points",1),
        (agent_deliver_damage_to_agent, ":tigger", ":agent", 0),
        (assign, ":attack", 1),
      (try_end),
      (try_begin),
        (eq, ":attack", 1),
        (agent_slot_eq, ":tigger", slot_agent_walker_occupation, 0),
        (agent_get_horse,":animal",":tigger"),
        (agent_is_alive, ":animal"),
        (agent_set_animation, ":animal", "anim_wild_cat_attack"),
        (try_begin),
            (eq, ":troop", "trp_wolf"),
            (agent_play_sound, ":tigger", "snd_wolf"),
        (else_try),
            (agent_play_sound, ":tigger", "snd_wild_cat"),
        (try_end),
        (agent_set_slot, ":tigger", slot_agent_walker_occupation, 4),
      (else_try),
        (agent_get_slot, ":timer1", ":tigger", slot_agent_walker_occupation),
        (val_sub, ":timer1", 1),
        (val_max, ":timer1", 0),
        (agent_set_slot, ":tigger", slot_agent_walker_occupation, ":timer1"),
      (try_end),
    (try_end),
],[])

initialise_auxiliary_player = (ti_before_mission_start, 0, 0,[
],[
    (assign, "$auxilary_player_active", 0), #variable for player party after party rebalancing
    (try_begin),
        (eq, "$use_player_auxiliary", 1),  #is active player enabled?
        #backup player party
        (assign, "$g_move_heroes", 1),
        (party_clear, "p_temp_casualties_3"),
        (call_script, "script_party_add_party", "p_temp_casualties_3", "p_main_party"),
        (set_player_troop, "trp_player"), #just in case?
        (assign, "$enable_deahtcam", 0), #disable deathcam, until we can not find any troops to "posses"
    (else_try),
        (assign, "$enable_deahtcam", 1),
    (try_end),
])

auxiliary_player_check = (5, 0, 0,[
    (eq, "$use_player_auxiliary", 1),
    (eq, "$enable_deahtcam", 0), #if deatcham is activated, no longer spawn as an auxiliary. TODO: reset camera settings and spawn anyway?
    (get_player_agent_no,":agent"),
    (neg|agent_is_alive, ":agent"),
	],[
    (set_fixed_point_multiplier, 100),
		(get_player_agent_no, ":p_agent"),
		(agent_get_team, ":player_team", ":p_agent"),
		(agent_get_division, ":player_division", ":p_agent"),
		(assign, ":spawned", 0),

    (init_position, pos10),
    (init_position, pos11),

		(try_for_agents, ":agent"),
		  (eq, ":spawned", 0),
		  (agent_is_human, ":agent"),
		  (agent_is_alive, ":agent"),
		  (agent_get_team, ":agent_team", ":agent"),
		  (agent_get_party_id, ":agent_party",":agent"),
		  (eq, ":agent_party", "p_main_party"),
		  (agent_get_division, ":agent_division", ":p_agent"),
		  (agent_get_group, ":agent_group", ":p_agent"),
		  (eq, ":player_team", ":agent_team"),
		  (eq, ":player_division", ":agent_division"),
		  (agent_get_troop_id,":troop_id", ":agent"),
          (neg|troop_is_hero, ":troop_id"),#not a hero
		 # (neg|is_between, ":troop_id", companions_begin, lords_end), #just in case

		  (set_player_troop, ":troop_id"),
		  (store_agent_hit_points,":hp",":agent",1),
		  (agent_get_position, pos11, ":agent"),
		  (position_set_z, pos11, -2000),
		  (position_set_x, pos11, 0),
		  (position_set_y, pos11, 0),
		  (agent_get_position, pos10, ":agent"),
		  (agent_get_horse, ":horse", ":agent"),
		  (try_begin),
		    (gt, ":horse", 0),
            (agent_set_position,":horse",pos11),
            (remove_agent, ":horse"),
		  (try_end),
		  (agent_set_position,":agent", pos11),
		  (agent_set_slot, ":agent", slot_possessed, 1),
		  (remove_agent, ":agent"),
          (set_spawn_position, pos10),
		  (spawn_agent, ":troop_id"),
		  (assign, ":p_agent", reg0),
		  (agent_set_team, ":p_agent", ":player_team"),
		  (agent_set_division, ":p_agent", ":agent_division"),
		  (agent_set_hit_points, ":p_agent" ,":hp",1),
		  (agent_set_group, ":p_agent", ":agent_group"),
		  (agent_set_slot, ":p_agent", slot_possessed, 2),
		  (agent_set_slot, ":p_agent", slot_real_troop, ":troop_id"),
		  (try_begin),
		    (agent_get_horse, ":p_horse", ":p_agent"),
            (gt, ":p_horse", 0), #player is mounted
		    (lt, ":horse", 0), #AI is not mounted!
            (agent_set_position,":p_horse",pos11),
            (remove_agent, ":p_horse"),
		  (try_end),
		  (set_player_troop, "trp_player"),
		  (assign, ":spawned", 1),
		  (assign, "$auxilary_player_active", 1), #checks that player spawned and will need to manualy correct party

		  #(team_set_order_listener, ":player_team", grc_everyone),
		  #(team_give_order, ":player_team", grc_everyone, mordr_hold), #tom
		(try_end),
		(eq, ":spawned", 0),
		(assign, "$enable_deahtcam", 1), #deathcam is active now
])

auxiliary_player = [
	initialise_auxiliary_player,
	auxiliary_player_check
]

more_difficult_damage = ( #player less damnage, opponent more damage
  ti_on_agent_hit, 0, 0, [(eq, "$insanedamage_on", 1),],
  [
    (assign, ":reg0_backup", reg0),
    (store_trigger_param_1, ":inflicted_agent"),
    (store_trigger_param_2, ":dealer_agent"),
    (store_trigger_param_3, ":damage"),

    (set_trigger_result, -1),
    (agent_is_active, ":inflicted_agent"),
    (agent_is_human, ":inflicted_agent"),
    (agent_is_alive, ":inflicted_agent"),
    (agent_is_human, ":dealer_agent"),
    (get_player_agent_no, ":player_agent"),  #
    (try_begin),
        (eq, ":inflicted_agent", ":player_agent"),
        (store_mul, ":new_damage", ":damage", 2), #double damage to player
        (val_max, ":new_damage" ,1),
        (set_trigger_result,  ":new_damage"),
    (else_try),
        (eq, ":dealer_agent", ":player_agent"),
        (store_div, ":new_damage", ":damage", 2), #half damage to enemy
        (val_max, ":new_damage" ,1),
        (set_trigger_result,  ":new_damage"),
    (try_end),

    (assign, reg0, ":reg0_backup"),
])

fireball_trigger = [
  (0.1, 0, 0,[],[
    (scene_prop_get_num_instances, ":number_of_balls", "spr_x_fire_ball"),
    (ge, ":number_of_balls", 1),
    (get_player_agent_no, ":player_agent"),
    (try_for_range, ":dummy", 0, ":number_of_balls"),
      (scene_prop_get_instance, ":scene_prop_id", "spr_x_fire_ball", ":dummy"),
      (neg|scene_prop_slot_eq, ":scene_prop_id",100, 1),
      (prop_instance_is_valid, ":scene_prop_id"),#valid
      (prop_instance_receive_damage, ":scene_prop_id", ":player_agent", 1),#will be destroyed after a min
      (prop_instance_get_position, pos30, ":scene_prop_id"),
      (try_for_agents, ":agents"),
        (agent_is_alive, ":agents"),
        (assign, ":c", 1),
        (try_begin), # dont effect allies
          (eq,"$player_ambushed",3),#player is ambushed
          (neg|agent_is_ally, ":agents"),
          (assign, ":c", 0),
        (else_try),#player is laying ambush
          (eq,"$player_ambushed",4),
          (agent_is_ally, ":agents"),
          (assign, ":c", 0),
        (try_end),
        (eq, ":c", 1),
        (agent_get_position, pos31, ":agents"),
        (get_distance_between_positions, ":distance", pos30, pos31),
        (lt, ":distance", 225),
        #(play_sound, "snd_dummy_destroyed"),
        (agent_deliver_damage_to_agent, ":agents", ":agents", 65),
        (try_begin),
            (eq, ":agents", ":player_agent"),
            (display_message, "@Recieved damage from fireball!", color_terrible_news),
        (try_end),
        (prop_instance_receive_damage, ":scene_prop_id", ":player_agent", 100),
      (try_end),
    (try_end),
  ]),
]


dedal_shield_bash = (0, 0.35, 1,[
    (eq, "$g_schield_bash", 1),
    (game_key_is_down,gk_defend),
    (game_key_clicked,gk_attack),
    ],[
    (game_key_is_down,gk_defend),
    (call_script,"script_shield_bash_trigger")])
dedal_shield_bash_AI = (2, 0, 0,[
  (eq, "$g_schield_bash", 1),
],[
    (call_script,"script_shield_bash_ai_trigger")])

bodyguard_triggers = [
 (ti_after_mission_start, 0, ti_once, [(neq, "$g_mt_mode", tcm_disguised)], #condition for not sneaking in; to exclude prison-breaks, etc change to (eq, "$g_mt_mode", tcm_default")
   [
    #Get number of bodyguards
    # (store_skill_level, ":leadership", skl_leadership, "trp_player"),
    # (troop_get_slot, ":renown", "trp_player", slot_troop_renown),
    # (val_div, ":leadership", 3),
    # (val_div, ":renown", 400),
    # (store_add, ":max_guards", ":renown", ":leadership"),
    # (val_min, ":max_guards", 4),
    (eq, "$g_body_guard_on", 1),
    (assign, ":max_guards", 4),

    #Get player info
    (get_player_agent_no, ":player"),
    (agent_get_team, ":playerteam", ":player"),
    (agent_get_horse, ":use_horse", ":player"), #If the player spawns with a horse, the bodyguard will too.

    #Prepare Scene/Mission Template
    (assign, ":entry_point", 0),
    (assign, ":mission_tpl", 0),
    (try_begin),
        (party_slot_eq, "$current_town", slot_party_type, spt_village),
        (assign, ":entry_point", 11), #Village Elder's Entry
        (assign, ":mission_tpl", "mt_village_center"),
    (else_try),
        (this_or_next|eq, "$talk_context", tc_prison_break),
        (this_or_next|eq, "$talk_context", tc_escape),
        (eq, "$talk_context", tc_town_talk),
        (assign, ":entry_point", 24), #Prison Guard's Entry
        (try_begin),
            (party_slot_eq, "$current_town", slot_party_type, spt_castle),
            (assign, ":mission_tpl", "mt_castle_visit"),
        (else_try),
            (assign, ":mission_tpl", "mt_town_center"),
        (try_end),
    (else_try),
        (eq, "$talk_context", tc_tavern_talk),
        (assign, ":entry_point", 17), #First NPC Tavern Entry
    (try_end),
    (try_begin),
        (neq, "$talk_context", tc_tavern_talk),
        (gt, ":use_horse", 0),
        (mission_tpl_entry_set_override_flags, ":mission_tpl", ":entry_point", 0),
    (try_end),
    (store_current_scene, ":cur_scene"),
    (modify_visitors_at_site, ":cur_scene"),

    #Find and Spawn Bodyguards
    (assign, ":bodyguard_count", 0),
    (party_get_num_companion_stacks, ":num_of_stacks", "p_main_party"),
    (try_for_range, ":i", 0, ":num_of_stacks"),
        (party_stack_get_troop_id, ":troop_id", "p_main_party", ":i"),
        (call_script, "script_cf_can_spawn_as_body_guard", ":troop_id"),
        (val_add, ":bodyguard_count", 1),

        (try_begin), #For prison-breaks
            (this_or_next|eq, "$talk_context", tc_escape),
            (eq, "$talk_context", tc_prison_break),
            (troop_set_slot, ":troop_id", slot_troop_will_join_prison_break, 1),
        (try_end),

        (add_visitors_to_current_scene, ":entry_point", ":troop_id", 1),

        (eq, ":bodyguard_count", ":max_guards"),
        (assign, ":num_of_stacks", 0), #Break Loop
    (try_end), #Stack Loop
    (gt, ":bodyguard_count", 0), #If bodyguards spawned...
    (set_show_messages, 0),
    (team_give_order, ":playerteam", 8, mordr_follow), #Division 8 to avoid potential conflicts
    (set_show_messages, 1),
  ]),

  (ti_on_agent_spawn, 0, 0, [],[
    (store_trigger_param_1, ":agent"),
    (agent_is_active, ":agent"),

    # (try_begin),
    #     (agent_is_human, ":agent"),
    #     (agent_get_team, reg15, ":agent"),
    #     (str_store_agent_name, s0, ":agent"),
    #     (display_message, "@{s0} team {reg15}"),
    # (try_end),

    (assign, ":agent_horse", -1),
    (try_begin),# in case companion spawns mounted
        (neg|agent_is_human, ":agent"),
        (agent_get_rider, ":rider", ":agent"),
        (agent_is_active, ":rider"),
        (assign, ":agent_horse",":agent"),
        (assign, ":agent", ":rider"),
        (agent_get_troop_id, ":troop", ":agent"),
        (str_store_troop_name, s10, ":troop"),
    (try_end),
    (agent_get_troop_id, ":troop", ":agent"),
    (call_script, "script_cf_can_spawn_as_body_guard", ":troop"),
    (str_store_troop_name, s10, ":troop"),

    (get_player_agent_no, ":player"),
    (agent_get_team, reg15, ":player"),
    (agent_get_position,pos25,":player"),
    (agent_set_team, ":agent", reg15),
    # (display_message, "@player team {reg15}"),
    (agent_set_division, ":agent", 8),
    (agent_add_relation_with_agent, ":agent", ":player", 1),
    (agent_set_is_alarmed, ":agent", 1),
    (store_random_in_range, ":shift", 1, 3),
    (val_mul, ":shift", 100),
    (position_move_y, pos25, ":shift"),
    (store_random_in_range, ":shift", 1, 3),
    (store_random_in_range, ":shift_2", 0, 2),
    (val_mul, ":shift_2", -1),
    (try_begin),
        (neq, ":shift_2", 0),
        (val_mul, ":shift", ":shift_2"),
    (try_end),
    (position_move_x, pos25, ":shift"),
    (agent_set_position, ":agent", pos25),
    (try_begin),
        (eq, ":agent_horse", -1),
        (agent_get_horse, ":agent_horse", ":agent"),
    (try_end),
    (try_begin),
        (agent_is_active, ":agent_horse"),
        (agent_set_position, ":agent_horse", pos25),
    (try_end),
  ]),

  (ti_on_agent_killed_or_wounded, 0, 0, [],[
    (store_trigger_param_1, ":dead_agent"),
    (agent_get_troop_id, ":troop", ":dead_agent"),
    (neq, ":troop", "trp_player"),
    (troop_is_hero, ":troop"),
    (main_party_has_troop, ":troop"),
    (party_wound_members, "p_main_party", ":troop", 1),
  ]),
]

nero_lyre_playing =  (0, 0, 0,[
    (key_clicked,key_o),
    (get_player_agent_no,":agent"),
    (agent_is_active,":agent"),
    (agent_is_alive,":agent"),
    (agent_has_item_equipped,":agent", "itm_lyre_rich"),
  ],[
    (get_player_agent_no,":agent"),
    (try_begin),
        (agent_is_active,":agent"),#is alive
        (agent_is_alive,":agent"),
        (agent_get_horse,":horse",":agent"),#no horse
        (neg|agent_is_active,":horse"),
        (agent_get_animation, ":animation", ":agent", 0),
        (try_begin),
            (eq, ":animation", "anim_player_lyre_standing"),                #stop if already performing
            (agent_stop_sound, ":agent"),
            (agent_set_animation, ":agent", "anim_player_lyre_end",0),
        (else_try),
            (neq, ":animation", "anim_player_lyre_standing"),#start playing
            (agent_set_animation, ":agent", "anim_player_lyre_standing",0),
            (agent_play_sound,":agent","snd_dedal_tavern_lyre"),
        (try_end),
    (try_end),
])

improved_lightning =  (ti_before_mission_start, 0, 0,[],[
    (party_get_current_terrain, ":terrain", "p_main_party"),
    (call_script, "script_get_region_of_pos22", "p_main_party"),
    (assign, ":cur_region", reg1),
    (get_global_cloud_amount, ":clouds"),

    (try_begin),
        (this_or_next|eq, ":terrain", rt_forest),
        (eq, ":terrain", rt_plain),
        (try_begin),#winter
            (this_or_next|eq, "$g_cur_month", 1),
            (this_or_next|eq, "$g_cur_month", 2),
            (this_or_next|eq, "$g_cur_month", 11),
            (eq, "$g_cur_month", 12),
            (call_script, "script_change_scene_fog", 300, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (else_try),#sommer
            (this_or_next|eq, "$g_cur_month", 5),
            (this_or_next|eq, "$g_cur_month", 6),
            (this_or_next|eq, "$g_cur_month", 7),
            (eq, "$g_cur_month", 8),
            (call_script, "script_change_scene_fog", 600, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (else_try),#else
            (call_script, "script_change_scene_fog", 450, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (try_end),
    (else_try),
        (this_or_next|eq, ":terrain", rt_water),
        (this_or_next|eq, ":terrain", rt_river),
        (eq, ":terrain", rt_bridge),
        (try_begin),#winter
            (this_or_next|eq, "$g_cur_month", 1),
            (this_or_next|eq, "$g_cur_month", 2),
            (this_or_next|eq, "$g_cur_month", 11),
            (eq, "$g_cur_month", 12),
            (call_script, "script_change_scene_fog", 400, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (else_try),#sommer
            (this_or_next|eq, "$g_cur_month", 5),
            (this_or_next|eq, "$g_cur_month", 6),
            (this_or_next|eq, "$g_cur_month", 7),
            (eq, "$g_cur_month", 8),
            (call_script, "script_change_scene_fog", 700, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (else_try),#else
            (call_script, "script_change_scene_fog", 550, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (try_end),
    (else_try),
        (this_or_next|eq, ":terrain", rt_snow),
        (eq, ":terrain", rt_snow_forest),
        (try_begin),#winter
            (this_or_next|eq, "$g_cur_month", 1),
            (this_or_next|eq, "$g_cur_month", 2),
            (this_or_next|eq, "$g_cur_month", 11),
            (eq, "$g_cur_month", 12),
            (call_script, "script_change_scene_fog", 350, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (else_try),#sommer
            (this_or_next|eq, "$g_cur_month", 5),
            (this_or_next|eq, "$g_cur_month", 6),
            (this_or_next|eq, "$g_cur_month", 7),
            (eq, "$g_cur_month", 8),
            (call_script, "script_change_scene_fog", 650, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (else_try),#else
            (call_script, "script_change_scene_fog", 500, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (try_end),
    (else_try),
        (this_or_next|eq, ":terrain", rt_desert),
        (eq, ":terrain", rt_desert_forest),
        (try_begin),#winter
            (this_or_next|eq, "$g_cur_month", 1),
            (this_or_next|eq, "$g_cur_month", 2),
            (this_or_next|eq, "$g_cur_month", 11),
            (eq, "$g_cur_month", 12),
            (call_script, "script_change_scene_fog", 375, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (else_try),#sommer
            (this_or_next|eq, "$g_cur_month", 5),
            (this_or_next|eq, "$g_cur_month", 6),
            (this_or_next|eq, "$g_cur_month", 7),
            (eq, "$g_cur_month", 8),
            (call_script, "script_change_scene_fog", 675, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (else_try),#else
            (call_script, "script_change_scene_fog", 525, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (try_end),
    (else_try),
        (try_begin),#winter
            (this_or_next|eq, "$g_cur_month", 1),
            (this_or_next|eq, "$g_cur_month", 2),
            (this_or_next|eq, "$g_cur_month", 11),
            (eq, "$g_cur_month", 12),
            (call_script, "script_change_scene_fog", 365, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (else_try),#sommer
            (this_or_next|eq, "$g_cur_month", 5),
            (this_or_next|eq, "$g_cur_month", 6),
            (this_or_next|eq, "$g_cur_month", 7),
            (eq, "$g_cur_month", 8),
            (call_script, "script_change_scene_fog", 665, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (else_try),#else
            (call_script, "script_change_scene_fog", 515, ":clouds", 0xA6A6A6, ":terrain", ":cur_region"),
        (try_end),
    (try_end),
])

weather = [
  #ti_battle_window_opened seems to be called whenever a window is opened during mission (inventory, game options etc)
  (ti_battle_window_opened, 0, 0, [],[  ##for player to remove head armor for certain armors
      (get_player_agent_no,":agent"),
      (agent_is_active,":agent"),
      (call_script,"script_item_confict_check",":agent"),
  ]),
  (ti_on_agent_spawn, 0, 0, [],[
  ##for player to remove head armor for certain armors
      (store_trigger_param_1, ":agent"),
      (agent_is_human,":agent"),
      (call_script,"script_item_confict_check",":agent"),
  ]),
  nero_lyre_playing,
  (0, 0, 1,[
    (game_key_clicked,gk_attack),
    (get_player_agent_no,":agent"),
    (agent_is_active,":agent"),
    (agent_is_alive,":agent"),
    (agent_get_wielded_item,":wielded_item",":agent"),
    (this_or_next|eq,":wielded_item","itm_horn"),
    (this_or_next|eq,":wielded_item","itm_trumpet_eastern"),
    (eq,":wielded_item","itm_trumpet_celtic"),
  ],[
    (try_begin),
      (call_script,"script_horn_sp_trigger"),
    (try_end),
  ]),
  (0.1, 0, 0,[
    (this_or_next|neg|game_in_multiplayer_mode),
    (neg|multiplayer_is_dedicated_server),
    (get_player_agent_no,":agent"),
    (agent_is_active,":agent"),
    (agent_get_animation,":anim",":agent"),
    (eq,":anim","anim_horn"),
    (agent_get_wielded_item,":wielded_item",":agent"),
    (neq,":wielded_item","itm_horn"),
    (neq,":wielded_item","itm_trumpet_eastern"),
    (neq,":wielded_item","itm_trumpet_celtic"),
    (try_for_range,":slot",0,4),
      (agent_get_item_slot,":s_item",":agent",":slot"),
      (this_or_next|eq,":wielded_item","itm_horn"),
      (this_or_next|eq,":wielded_item","itm_trumpet_eastern"),
      (eq,":wielded_item","itm_trumpet_celtic"),
      (agent_set_wielded_item,":agent",":s_item"),
    (try_end),
  ],[]),
  (0, 0, 1, [
    ######Singleplayer version (action key)
    # (game_key_is_down,gk_action),###########!!!
    # (game_key_is_down,gk_defend),
    (key_is_down,key_k),
  ],[
    (call_script,"script_shield_taunt_trigger"),
    #(assign, reg5, "$battle_ratio"),
    #(display_message, "@battleratio: {reg5}"),
	]),

  (ti_before_mission_start, 0, 0, [
  ],[
    ## remove plants from fields during winter
    (try_begin),
        (call_script, "script_cf_snow_on_scene", "p_main_party"),
        (replace_scene_props, "spr_cabbage_b", "spr_empty"),#fields are empty now
        (replace_scene_props, "spr_squash_plant", "spr_empty"),
        (replace_scene_props, "spr_bean", "spr_empty"),
    (else_try),
    ## let deserts and mediterreanian be sunny as fuck
        (call_script, "script_cf_is_desert_or_mediterreanian", "p_main_party"),
        (store_random_in_range, ":clouds", 0, 5),
        (set_global_cloud_amount, ":clouds"),
        (set_rain, 2, 0),
        (set_rain, 1, 0),
        (set_rain, 0, 100),
        ##shader, disable seasons in deserts or mediterrainian
        (set_fixed_point_multiplier, 1),
        (set_shader_param_float, "@vSeason",0),#no snow in deserts, 0 means spring
    (try_end),

    (try_begin),
        (call_script, "script_cf_is_desert_or_mediterreanian", "p_main_party"),
    (else_try),
    ## add rain and snow effects to non-desert or med region
        (get_global_cloud_amount, ":wolken"),
        (is_between, ":wolken", 90, 101),
        (try_begin),
            (call_script, "script_cf_snow_on_scene", "p_main_party"),
            (set_rain, 2, 250),#let it snow
        (else_try),
            (set_rain, 1, 250),
        (try_end),
    (try_end),

    # weather for special quests
    (try_begin),
        (check_quest_active, "qst_wlodowiecus_adventure_3"),
        (quest_slot_ge, "qst_wlodowiecus_adventure_3", slot_quest_current_state, 5),

        (set_global_cloud_amount, 100),
        (set_fixed_point_multiplier, 1),
        (set_shader_param_float, "@vSeason", 3),# snow during wlod quest
        (set_rain, 2, 250),#let it snow
        (try_begin),
            (ge, "$cheat_mode", 1),
            (display_log_message, "@Set seasonal shader for quest WLOD 3"),
        (try_end),
    (try_end),
  ]),

  # init wind
  (0, 0, ti_once, [],[
    #shader, set wind shader properly
    (assign, ":shader_wind_strenght", "$wind_power"),
    # (try_begin),
    # (eq, ":shader_wind_strenght", 4),
    # (assign, ":shader_wind_strenght", 2),
    # (else_try),
    # (eq, ":shader_wind_strenght", 3),
    # (assign, ":shader_wind_strenght", 1),
    # (try_end),
    # (val_clamp, ":shader_wind_strenght", 0, 3),
    (val_mul, ":shader_wind_strenght", 10),#wind_power: 0 - 4 -> 0 - 40
    (val_div, ":shader_wind_strenght", 4), # 0-10

    # (assign, reg1, ":shader_wind_strenght"),
    # (display_message, "@shader_wind_strenght: {reg1}"),

    (set_fixed_point_multiplier,10),
    (set_shader_param_float, "@vWindStrength", ":shader_wind_strenght"),
    (set_fixed_point_multiplier, 1),
    (set_shader_param_float, "@vWindDirection", 30),#30 degree
    (set_fixed_point_multiplier,100),
  ]),

  (0, 0, ti_once, [],[
    # light
    (set_fixed_point_multiplier, 100),
    (try_begin),
      (store_time_of_day, ":day_time"),
      (is_between, ":day_time", 4, 20),
      (get_startup_sun_light, pos1),
      (call_script, "script_calculate_season_light"),
      # (val_mul, reg1, 2),(val_mul, reg2, 2),(val_mul, reg3, 2),
      # (val_div, reg1, 3),(val_div, reg2, 3),(val_div, reg3, 3),
      (set_startup_sun_light, reg1, reg2, reg3),
      (get_startup_ambient_light, pos1),
      (call_script, "script_calculate_season_light"),
      # (val_mul, reg1, 2),(val_mul, reg2, 2),(val_mul, reg3, 2),
      # (val_div, reg1, 3),(val_div, reg2, 3),(val_div, reg3, 3),
      (set_startup_ambient_light, reg1, reg2, reg3),
      (get_startup_ground_ambient_light, pos1),
      (call_script, "script_calculate_season_light"),
      # (val_mul, reg1, 2),(val_mul, reg2, 2),(val_mul, reg3, 2),
      # (val_div, reg1, 3),(val_div, reg2, 3),(val_div, reg3, 3),
      (set_startup_ground_ambient_light, reg1, reg2, reg3),
      (ge, "$cheat_mode", 1),
      (display_message, "@{!}season light set"),
    (try_end),
  ]),
]

wounds_vc = (ti_on_agent_hit, 0, 0, [],[
  (neq, "$auxilary_player_active", 1),

  (assign, ":reg0_backup", reg0),
  (store_trigger_param, ":inflicted_agent_id", 1),
  (get_player_agent_no, ":player_agent"),
  (eq, ":inflicted_agent_id", ":player_agent"),
  #(store_trigger_param, ":dealer_agent_id", 2),
  (store_trigger_param, ":inflicted_damage", 3),
  (store_trigger_param, ":hit_bone", 4),
  #(store_trigger_param, ":missile_item_kind_no", 5),

  (options_get_damage_to_player, ":damage_to_player_option"), #0 = 1/4, 1 = 1/2, 2 = 1/1
  (try_begin),
    (val_sub, ":damage_to_player_option", 2),
    (val_mul, ":damage_to_player_option", -2),
    (gt, ":damage_to_player_option", 0),
    (val_mul, ":inflicted_damage", ":damage_to_player_option"),
  (try_end),

  (try_begin),
    (eq, "$vc_wounds_on", 1),

    (ge, ":inflicted_damage", 20),
    (store_random_in_range, ":rand", 1, 101),
    (le, ":rand", 20),				#20% chance for hits high damage hits (was 30)

    # GET NUMBER OF CURRENT WOUNDS
    (assign, ":num_current_wounds", 0),
    (try_for_range, ":curr_slot", slot_quest_int_penalty_fluid_points, slot_quest_end_penalty_fluid_points),
      (quest_get_slot, ":fluid_points", "qst_vc_wounds", ":curr_slot"),
      (try_begin),
        (lt, ":fluid_points", 0),
        (val_mul, ":fluid_points", -1),
      (try_end),
      (gt, ":fluid_points", 0),
      (val_add, ":num_current_wounds", ":fluid_points"),
    (try_end),

    # PASS 2
    (store_random_in_range, ":rand", 0, 10),
    (store_mul, ":quad_current_wounds", ":num_current_wounds", ":num_current_wounds"),	#0-0, 1-1, 2-4, 3-9 and rest is greater
    (ge, ":rand", ":quad_current_wounds"),	#0-100%, 1-90%, 2-60%, 3-10%

    # PASS 3
    (store_character_level, ":level", "trp_player"),
    (store_mul, ":current_wounds_mul_10", ":num_current_wounds", 10),	#0-0, 1-10, 2-20, 3-30
    (ge, ":level", ":current_wounds_mul_10"),

    (val_add, "$wounded_today", 1),
    # (val_add, "$total_wounds_ever", 1),

    # 1. Penalty
    (try_begin),
      # (eq, ":hit_bone", hb_head),	#head		#head injuries disabled for VC-2776
      # (store_random_in_range, ":rand", 0, 2),
      # (le, ":rand", 0),
      # (assign, ":attribute", ca_charisma),
      # (assign, ":days_slot", slot_quest_int_penalty_left_days),
      # (str_store_string, s1, "@You suffer a serious injury to your head. (-1 intelligence)"),
      # (else_try),
      (eq, ":hit_bone", hb_head),	#head 2
      (assign, ":attribute", ca_charisma),
      (assign, ":days_slot", slot_quest_cha_penalty_left_days),
      (str_store_string, s1, "@You suffer a serious injury to your face. (-1 charisma)"),
      (call_script, "script_change_troop_health", "trp_player", 15),
    (else_try),
      (this_or_next|is_between, ":hit_bone", hb_shoulder_l, hb_hand_r + 1),	# arms
      (is_between, ":hit_bone", hb_thigh_l, hb_foot_r + 1),					# legs
      (assign, ":attribute", ca_agility),
      (assign, ":days_slot", slot_quest_agi_penalty_left_days),
      (str_store_string, s1, "@You suffer a serious injury to one of your limbs. (-1 agility)"),
      (call_script, "script_change_troop_health", "trp_player", 5),
    (else_try),
      (assign, ":attribute", ca_strength),	# body/rest
      (assign, ":days_slot", slot_quest_str_penalty_left_days),
      (str_store_string, s1, "@You suffer a serious injury to your body. (-1 strength)"),
      (call_script, "script_change_troop_health", "trp_player", 10),
    (try_end),
    (store_attribute_level, ":level", "trp_player", ":attribute"),
    (gt,":level", 3),
    (display_message, s1, message_negative),
    (troop_raise_attribute, "trp_player", ":attribute", -1),
    (try_begin),
      (quest_get_slot, ":left_days", "qst_vc_wounds", ":days_slot"),
      (le, ":left_days", 0),
      (quest_set_slot, "qst_vc_wounds", ":days_slot", 5),
    (try_end),
    (store_add, ":points_slot", ":days_slot", 10),
    (quest_get_slot, ":points", "qst_vc_wounds", ":points_slot"),
    (val_add, ":points", 1),
    (quest_set_slot, "qst_vc_wounds", ":points_slot", ":points"),

    # 2. Screen color
    (mission_cam_set_screen_color, 0x99660000),
    (store_mul, ":time", ":inflicted_damage", 5),
    (mission_cam_animate_to_screen_color, 0x00000000, ":time"),

    # 3. Sound
    # (play_sound, "snd_corazon_late"),
  (try_end),
  (assign, reg0, ":reg0_backup"),
])

ambient_scene_play_loop = (ti_after_mission_start, 0, 0,[],[
    (neg|game_in_multiplayer_mode),
    (call_script,"script_sp_scene_play_ambient_loop",0)])
ambient_scene_play_random_sound = (3, 0, 0,[],[
    (neg|game_in_multiplayer_mode),
    (call_script,"script_sp_scene_play_random_ambient_sound",0)])
ambient_tavern_play_loop = (ti_after_mission_start, 0, 0,[],[
    (play_sound,"snd_ambient_tavern_loop")])
ambient_tavern_play_random_sound = (5, 0, 0,[],[
    (store_random_in_range,":r",0,10),(lt,":r",2),
    (play_sound,"snd_ambient_random_tavern")])
ambient_set_agents_for_sounds = (0, 8, ti_once, [],[
    (neg|game_in_multiplayer_mode),
    (call_script,"script_sp_set_agents_for_sounds")])
ambient_agent_play_sound = (4, 0, 0, [],[
    (neg|game_in_multiplayer_mode),
    (call_script,"script_sp_agent_play_sound")])

sand_storm = [
  (1, 0, 0, [
    (eq,"$lightning_cycle",3),
  ],[
    (get_player_agent_no, ":player"),
    (agent_is_active, ":player"),
    (agent_is_alive, ":player"),

    (assign, ":save_fpm", 1),# dave fixed point value
    (convert_to_fixed_point, ":save_fpm"),

    (set_fixed_point_multiplier, 100),
    (init_position, pos25),
    (agent_get_position, pos25, ":player"),
    (position_get_z, ":z", pos25),
    (val_add, ":z", 400),
    (position_set_z, pos25, ":z"),
    (particle_system_burst, "psys_desert_storm", pos25, 90),

    (set_fixed_point_multiplier, ":save_fpm"),
  ]),

  (0, 0, ti_once, [],[
    (try_begin),
      (call_script, "script_cf_is_desert", "p_main_party"),
      (store_random_in_range, ":r", 0, 10),
      (le, ":r", 2),
      (assign,"$lightning_cycle",3),
      (display_message, "@Sandstorm!", message_negative),
    (else_try),
      (store_current_scene, ":scene"),
      (eq, ":scene", "scn_ruins_of_carthage"),
      (assign,"$lightning_cycle",3),
      (display_message, "@Sandstorm!", message_negative),
    (try_end),
  ]),
]

thunder_storm =	[		# 4 trigger

  (0, 0, ti_once, [#preparations 2
  ],[
    # (display_message, "@Thunderstorm. Check I"),
    (assign, "$lightning_cycle", -1),
    (try_begin),
      (store_current_scene, ":scene"),
      (this_or_next|eq, ":scene", "scn_ruins_of_carthage"),# exclude certain scenes
      (call_script, "script_cf_is_desert", "p_main_party"),
    (else_try),
      (store_time_of_day, ":day_time"),
      (neg|is_between, ":day_time", 4, 20),
      (get_global_cloud_amount, ":clouds"),
      (ge, ":clouds", 65),
      (store_random_in_range, ":rand", 1, 11),
      (le, ":rand", 4),	# 20% chance
      (assign, "$lightning_cycle", 0),
      (set_global_cloud_amount, 100),
      (set_rain, 1, 250),

      (eq, "$lightning_cycle", 0),
      (display_message, "@A Thunderstorm approaches!", color_bad_news),
      (set_fixed_point_multiplier, 1000),
      (get_startup_sun_light, pos1),
      (position_get_x, "$sun_r", pos1),	# r
      (position_get_y, "$sun_g", pos1), # g
      (position_get_z, "$sun_b", pos1),	# b
      (get_startup_ambient_light, pos1),
      (position_get_x, "$amb_r", pos1),	# r
      (position_get_y, "$amb_g", pos1), # g
      (position_get_z, "$amb_b", pos1),	# b
    (try_end),
  ]),

  (3, 0.2, 6,[#lightning 1
    (eq,"$lightning_cycle",0),
    (store_random_in_range,":chance",1,5),
    (eq,":chance",1),
    (play_sound,"snd_thunder_close"),
    (set_fixed_point_multiplier, 1),
    (set_startup_sun_light, 1000, 1000, 1000),
    (set_startup_ambient_light, 1000, 1000, 1000),
  ],[
    (set_startup_sun_light, 0, 0, 0),
    (set_startup_ambient_light, 0, 0, 0),
    (assign, "$lightning_cycle",1),
  ]),

  (0.4,0.1, 6,		[	#lightning 2
    (eq,"$lightning_cycle",1),
    (set_fixed_point_multiplier, 1),
    (set_startup_sun_light, 220, 220, 220),
    (set_startup_ambient_light, 220, 220, 220),
  ],[
    (set_fixed_point_multiplier, 1),
    (set_startup_sun_light, 1, 1, 1),
    (set_startup_ambient_light, 1, 1, 1),
    (assign,"$lightning_cycle",2),
  ]),

  (0.5,0.1, 6,			[#lightning 3
    (eq,"$lightning_cycle",2),
    (set_fixed_point_multiplier, 1),
    (set_startup_sun_light, 150, 150, 150),
    (set_startup_ambient_light, 150, 150, 150),
  ],[
    (set_fixed_point_multiplier, 1000),
    (set_startup_sun_light, "$sun_r", "$sun_g", "$sun_b"),
    (set_startup_ambient_light, "$amb_r", "$amb_g", "$amb_b"),
    (assign,"$lightning_cycle", 0),
  ]),
]

p_wetter = weather
storms = thunder_storm + sand_storm

custom_commander_critical_strike =(ti_on_agent_hit, 0, 0, [],[
    (store_trigger_param_1, ":inflicted_agent"),
    (store_trigger_param_2, ":dealer_agent"),
    (store_trigger_param_3, ":inflicted_damage"),

    (set_trigger_result, -1),
    (gt, ":inflicted_damage", 0),
    (set_trigger_result, ":inflicted_damage"),
    (try_begin),
      (agent_is_human, ":dealer_agent"),
      (assign, ":dealer_item_id", reg0),
      (is_between, ":dealer_item_id", all_items_begin, all_items_end),
      (try_begin),
        ## knock_back between humans with melee weapons
        (agent_is_human, ":inflicted_agent"),
        (agent_get_position, pos1, ":inflicted_agent"),
        (agent_get_position, pos2, ":dealer_agent"),
        (try_begin),
          (position_is_behind_position, pos2, pos1),
          (item_get_type, ":item_type", ":dealer_item_id"),
          (this_or_next|eq, ":item_type", itp_type_one_handed_wpn),
          (this_or_next|eq, ":item_type", itp_type_two_handed_wpn),
          (eq, ":item_type", itp_type_polearm),
          # dest damage ratio is 1/2
          (assign, ":dest_damage", ":inflicted_damage"),
          (val_div, ":dest_damage", 2),
          (store_agent_hit_points, ":inflicted_agent_hp", ":inflicted_agent", 1),
          (val_sub, ":inflicted_agent_hp", ":dest_damage"),
          (val_max, ":inflicted_agent_hp", 0),
          (agent_set_hit_points, ":inflicted_agent", ":inflicted_agent_hp", 1),
          #(call_script, "script_change_courage_around_agent", -8, ":inflicted_agent"),
          # messages for player
          (get_player_agent_no, ":player_agent"),
          (try_begin),#reduce morale a bit if attacked from behind
            (neq, ":inflicted_agent", ":player_agent"),
            (call_script, "script_change_agent_courage", ":inflicted_agent", -100, 0),
          (try_end),
          (try_begin),
            (eq, ":dealer_agent", ":player_agent"),
            (assign, reg1, ":dest_damage"),
            (display_message, "@Delivered {reg1} extra damage from behind!", 0xFF0000),
          (else_try),
            (eq, ":inflicted_agent", ":player_agent"),
            (assign, reg1, ":dest_damage"),
            (display_message, "@Received {reg1} extra damage from behind!", 0xFF0000),
          (try_end),
          (try_begin),
            (agent_get_horse, ":horse_yes_no", ":inflicted_agent"),
            (eq, ":horse_yes_no", -1),
            (agent_set_animation, ":inflicted_agent","anim_strike_fall_back_rise"),
          (try_end),
        (try_end),
      (else_try),
        # inflicted_agent is horse, dealer_troop is on foot and uses polearm or thrust
        (neg|agent_is_human, ":inflicted_agent"),
        (agent_get_horse, ":dealer_agent_horse_id", ":dealer_agent"),
        (eq, ":dealer_agent_horse_id", -1),
        (agent_get_action_dir, ":action_dir", ":dealer_agent"),
        (item_get_type, ":item_type", ":dealer_item_id"),

        (assign, ":extra_damage_rate", 0),
        (try_begin),
          (eq, ":item_type", itp_type_polearm),
          (try_begin),
            (eq, ":action_dir", 0),
            (assign, ":extra_damage_rate", 180), #chief incrementa
            (store_random_in_range, ":random_no", 1, 100),
            (try_begin), #el caballo retrocede chief
              (le, ":random_no", 50),
              (agent_set_animation, ":inflicted_agent","anim_horse_rear"),
            (try_end),
          (else_try),
            (assign, ":extra_damage_rate", 120), #chief incrementa
          (try_end),
        (else_try),
          (this_or_next|eq, ":item_type", itp_type_one_handed_wpn),
          (eq, ":item_type", itp_type_two_handed_wpn),
          (eq, ":action_dir", 0),
          (assign, ":extra_damage_rate", 75),
        (try_end),
        (gt, ":extra_damage_rate", 0),
        (store_mul, ":extra_damage", ":inflicted_damage", ":extra_damage_rate"),
        (val_div, ":extra_damage", 100),
        (store_agent_hit_points, ":inflicted_agent_hp", ":inflicted_agent", 1),
        (val_sub, ":inflicted_agent_hp", ":extra_damage"),
        (val_max, ":inflicted_agent_hp", 0),
        (agent_set_hit_points, ":inflicted_agent", ":inflicted_agent_hp", 1),
        # messages for player
        (get_player_agent_no, ":player_agent"),
        (try_begin),
          (eq, ":dealer_agent", ":player_agent"),
          (assign, reg1, ":extra_damage"),
          (try_begin),
            (agent_get_rider, ":rider_agent", ":inflicted_agent"),
            (gt, ":rider_agent", -1),
            (display_message, "@Delivered {reg1} extra damage to horse."),
          (else_try),
            (display_message, "@Delivered {reg1} extra damage."),
          (try_end),
        (try_end),
        (try_begin),
          (agent_get_horse, ":player_horse_id", ":player_agent"),
          (eq, ":player_horse_id", ":inflicted_agent"),
          (assign, reg1, ":extra_damage"),
          (display_message, "@Horse received {reg1} extra damage."),
        (try_end),
      (try_end),
    (try_end),
  ])

#decapitation
theoris_decapitation = [
    (ti_on_agent_hit, 0, 0, [
      (neq, "$g_gore_on", 0),
    ],[
      (store_trigger_param_1, ":agent"),
      (agent_is_active, ":agent"),
      (agent_is_human, ":agent"),
      (agent_is_non_player, ":agent"),
      (agent_get_troop_id, ":troop_no", ":agent"),
      (neg|troop_is_hero, ":troop_no"),
      (store_random_in_range, ":randomizer", 1, 6),
      (eq, ":randomizer", 1),

      (store_trigger_param_3, ":damage"),
      (ge, ":damage", 30), #strong blow
      (store_agent_hit_points, ":hp", ":agent", 1),
      (val_sub, ":hp", 5),
      (ge, ":damage", ":hp"),
      (agent_get_position, pos1, ":agent"),
      (get_distance_between_positions, ":distance", pos1, pos0),
      (is_between, ":distance", 90, 185), # *zing*
      (agent_get_item_slot, ":item", ":agent", 4), #head slot
      (try_begin),
        (ge, ":item", 1),
        (agent_unequip_item, ":agent", ":item"),
      (try_end),
      (agent_set_hit_points,":agent", 0, 1), #DEATH IS CERTAIN (no running around decapitated idiots :D)
      (agent_equip_item, ":agent", "itm_nothing_head"),
      (particle_system_burst, "psys_game_blood_2", pos0, 125), #BLODDYBLOODBLOODDDDDD
      (set_spawn_position, pos1),
      (spawn_scene_prop, "spr_head"),
   ]),

  (10, 0, 0, [
    (neq, "$g_gore_on", 0),
  ],[#fade out heads after some time
    (try_for_prop_instances, ":instance", "spr_head"),
      (scene_prop_get_slot, ":timer_1", ":instance", scene_prop_timer),
      (val_max, ":timer_1", 0),
      (try_begin),
        (lt, ":timer_1", 2),
        (val_add, ":timer_1", 1),
        (scene_prop_set_slot, ":instance", scene_prop_timer, ":timer_1"),
      (else_try),
        (eq, ":timer_1", 1),
        (scene_prop_fade_out, ":instance", 75),
        (val_add, ":timer_1", 1),
        (scene_prop_set_slot, ":instance", scene_prop_timer, ":timer_1"),
      (try_end),
    (try_end),
  ]),
]


# horse_archer_ai = (0.5, 0, 0, [],
  # [
        # (set_fixed_point_multiplier, 1000),
        # (try_for_agents, ":agent_no"),
            # (agent_is_alive, ":agent_no"),
            # (agent_is_human, ":agent_no"),
            # (agent_is_non_player, ":agent_no"),
            # (neg|agent_slot_eq, ":agent_no", slot_agent_is_skirmishing, 1),
            # (agent_get_horse, ":horse_no", ":agent_no"),
            # (assign, ":melee_weapon", -1),
            # (try_begin),
                # (agent_slot_eq, ":agent_no", slot_agent_is_running_away, 0),
                # (gt, ":horse_no", -1),
                # (agent_get_team, ":team_no", ":agent_no"),
                # (agent_get_division, ":class_no", ":agent_no"),
                # (team_get_weapon_usage_order, ":weapon_usage_order", ":team_no", ":class_no"),
                # (team_get_movement_order, ":movement_order", ":team_no", ":class_no"),
                # (team_get_hold_fire_order, ":hold_fire", ":team_no", ":class_no"),
                # (assign, ":thrown_ammo", 0),
                # (assign, ":ranged_weapon", -1),
                # (try_for_range, ":item", 0, 4),
                  # (agent_get_item_slot, ":item_weapon", ":agent_no", ":item"),
                  # (gt, ":item_weapon", 0),
                  # (item_get_type, ":item_weapon_type", ":item_weapon"),
                  # (try_begin),
                    # (eq, ":item_weapon_type", itp_type_thrown),
                    # (agent_get_ammo_for_slot, ":ammo_for_slot", ":agent_no", ":item"),
                    # (val_add, ":thrown_ammo", ":ammo_for_slot"),
                  # (else_try),
                    # (this_or_next|eq, ":item_weapon_type", itp_type_bow),
                    # (this_or_next|eq, ":item_weapon_type", itp_type_pistol),
                    # (eq, ":item_weapon_type", itp_type_musket),
                    # (assign, ":ranged_weapon", ":item_weapon"),
                  # (else_try),
                    # (this_or_next|eq, ":item_weapon_type", itp_type_one_handed_wpn),
                    # (this_or_next|eq, ":item_weapon_type", itp_type_two_handed_wpn),
                    # (eq, ":item_weapon_type", itp_type_polearm),
                    # (assign, ":melee_weapon", ":item_weapon"),
                  # (try_end),
                # (try_end),
                # (gt, ":ranged_weapon", -1),
                # (neg|item_has_property, ":ranged_weapon", itp_cant_reload_on_horseback),
                # (neg|item_has_property, ":ranged_weapon", itp_cant_use_on_horseback),
                # (agent_get_ammo, ":ammo", ":agent_no", 0),
                # (val_sub, ":ammo", ":thrown_ammo"),
                # (gt, ":ammo", 0),
                # (agent_set_slot, ":agent_no", slot_agent_is_skirmishing, 2),
                # (neg|eq, ":hold_fire", aordr_hold_your_fire),
                # (neg|eq, ":weapon_usage_order", wordr_use_melee_weapons),
                # (eq, ":movement_order", mordr_charge),
                # (agent_get_position, pos50, ":agent_no"),
                # (agent_get_speed, pos31, ":agent_no"),
                # (position_get_y,":speed_y",pos31),
                # (assign, ":distance_closest", 100000),#1000m
                # (assign, ":enemies_closest", -1),
                # (try_for_agents, ":enemies"),
                    # (agent_is_alive, ":enemies"),
                    # (agent_is_human, ":enemies"),
                    # (agent_get_position, pos36, ":enemies"),
                    # (agent_get_team, ":enemies_team", ":enemies"),
                    # (teams_are_enemies, ":team_no", ":enemies_team"),
                    # (get_distance_between_positions, ":distance", pos50, pos36),
                    # (try_begin),
                      # (agent_slot_eq, ":enemies", slot_agent_is_running_away, 1),
                      # (val_add, ":distance", 10000),
                    # (try_end),
                    # (try_begin),
                      # (agent_get_horse, ":enemies_horse", ":enemies"),
                      # (gt, ":enemies_horse", -1),
                      # (agent_get_speed, pos32, ":enemies"),
                      # (position_get_y,":speed_y_enemies",pos32),
                      # (val_sub, ":speed_y_enemies", ":speed_y"),
                      # (store_div, ":distance_cavalry", ":speed_y_enemies",5),
                      # (val_max, ":distance_cavalry", 0),
                      # (val_add, ":distance_cavalry", 500),
                      # (val_sub, ":distance", ":distance_cavalry"),
                    # (else_try),
                      # (agent_get_wielded_item, ":weapon_hold", ":enemies", 1),
                      # (neg|gt, ":weapon_hold", 1),
                      # (val_sub, ":distance", 500),
                    # (try_end),
                    # (lt, ":distance", ":distance_closest"),
                    # (assign, ":distance_closest", ":distance"),
                    # (assign, ":enemies_closest", ":enemies"),
                # (try_end),
                # (neq, ":enemies_closest", -1),
                # (agent_get_position, pos51, ":enemies_closest"),
                # (get_distance_between_positions, ":distance_true", pos50, pos51),
                # (try_begin),
                  # (agent_slot_eq, ":enemies_closest", slot_agent_is_running_away, 0),
                  # (gt,":distance_true",200),
                  # (agent_set_wielded_item, ":agent_no", ":ranged_weapon"),
                # (else_try),
                  # (le, ":distance_true", 200),
                  # (gt, ":melee_weapon", -1),
                  # (agent_set_wielded_item, ":agent_no", ":melee_weapon"),
                # (try_end),
                # (assign, ":speed_limit", 1000),
                # (try_begin),
                    # (agent_get_wielded_item, ":weapon_hold", ":agent_no", 0),
                    # (gt, ":weapon_hold", 0),
                    # (item_get_type, ":weapon_type", ":weapon_hold"),
                    # (this_or_next|eq, ":weapon_type", itp_type_bow),
                    # (this_or_next|eq, ":weapon_type", itp_type_pistol),
                    # (eq, ":weapon_type", itp_type_musket),
                    # (agent_get_bone_position, pos53, ":agent_no", 8, 1),
                    # (agent_get_bone_position, pos54, ":enemies_closest", 9, 1),
                    # (position_has_line_of_sight_to_position, pos53, pos54),
                    # (agent_set_look_target_agent, ":agent_no", ":enemies_closest"),
                    # (try_begin),
                      # (assign, ":shoot_distance", 4000),
                      # (agent_get_attack_action, ":attack_action", ":agent_no"),
                      # (eq, ":attack_action", 1),
                      # (try_begin),
                        # (gt, ":distance_closest", 700),
                        # (le, ":distance_closest", ":shoot_distance"),
                        # (store_div, ":speed_limit", ":speed_y",2000),#
                        # (val_max, ":speed_limit", 0),
                      # (try_end),
                      # (eq, ":weapon_type", itp_type_bow),
                      # (try_begin),
                        # (le, ":distance_true", ":shoot_distance"),
                        # (agent_set_defend_action, ":agent_no", -2, 1),
                        # (agent_set_attack_action, ":agent_no", 3, 0),
                      # (else_try),
                        # (gt, ":distance_true", ":shoot_distance"),
                        # (agent_set_attack_action, ":agent_no", -2, 1),
                        # (agent_set_defend_action, ":agent_no", 3, 1),
                      # (try_end),
                    # (else_try),
                      # (eq, ":weapon_type", itp_type_bow),
                      # (le, ":distance_true", ":shoot_distance"),#
                      # (agent_get_combat_state, ":combat_state", ":agent_no"),
                      # (neq, ":combat_state", 8),
                      # (agent_set_attack_action, ":agent_no", 3, 1),
                    # (try_end),
                # (try_end),
                # (agent_set_speed_limit, ":agent_no", ":speed_limit"),
                # (try_begin),
                  # (agent_slot_eq, ":enemies_closest", slot_agent_is_running_away, 0),
                  # (lt, ":distance_closest", 10000),
                  # (try_begin),
                    # (get_scene_boundaries, pos2, pos3),
                    # (position_transform_position_to_local, pos4, pos2,pos50),
                    # (position_get_x, ":left", pos4),
                    # (position_get_y, ":down", pos4),
                    # (position_transform_position_to_local, pos4, pos2,pos3),
                    # (position_get_x, ":map_width", pos4),
                    # (position_get_y, ":map_height", pos4),
                    # (store_sub, ":right", ":map_width", ":left"),
                    # (store_sub, ":up", ":map_height", ":down"),
                    # (position_transform_position_to_local, pos4, pos50, pos51),
                    # (position_get_x, ":enemies_x", pos4),
                    # (position_get_y, ":enemies_y", pos4),
                    # (assign, ":effect", 0),
                    # (try_begin),
                      # (neg|gt, ":distance_closest", 1000),
                      # (assign, ":effect", -78000),
                    # (else_try),
                      # (gt, ":distance_closest", 2000),#
                      # (store_sub,":effect", ":distance_closest", 0),
                      # (val_mul, ":effect", 5),
                      # (val_clamp, ":effect", 35000, 90000),
                    # (try_end),
                    # (assign, ":distance_to_boundary", 30000),
                    # (val_min, ":distance_to_boundary", ":left"),
                    # (val_min, ":distance_to_boundary", ":up"),
                    # (val_min, ":distance_to_boundary", ":right"),
                    # (val_min, ":distance_to_boundary", ":down"),
                    # (try_begin),
                      # (lt, ":distance_to_boundary", 30000),
                      # (agent_slot_eq, ":enemies_closest", slot_agent_is_running_away, 0),
                      # (store_div, ":map_middle_x", ":map_width", 20),
                      # (store_div, ":map_middle_y", ":map_height", 20),
                      # (position_copy_origin, pos4, pos2),
                      # (position_move_x, pos4, ":map_middle_x", 1),
                      # (position_move_y, pos4, ":map_middle_y", 1),
                      # (get_distance_between_positions,":distance_middle", pos4, pos50),
                      # (position_transform_position_to_local, pos4, pos50, pos4),
                      # (position_get_x, ":map_middle_x", pos4),
                      # (position_get_y, ":map_middle_y", pos4),
                      # (val_mul, ":map_middle_x", 100),
                      # (val_mul, ":map_middle_y", 100),
                      # (val_mul, ":enemies_x", 100),
                      # (val_mul, ":enemies_y", 100),
                      # (store_div,":cos_middle",":map_middle_x",":distance_middle"),
                      # (store_div,":sin_middle",":map_middle_y",":distance_middle"),
                      # (store_div,":cos_enemies",":enemies_x",":distance_true"),
                      # (store_div,":sin_enemies",":enemies_y",":distance_true"),
                      # (store_acos, ":angle_cos", ":cos_middle"),
                      # (store_asin, ":angle_sin", ":sin_middle"),
                      # (store_acos, ":angle_cos_enemies", ":cos_enemies"),
                      # (store_asin, ":angle_sin_enemies", ":sin_enemies"),
                      # (try_begin),
                        # (lt, ":angle_sin", 0),
                        # (val_mul,":angle_cos", -1),
                        # (val_add,":angle_cos", 360000),
                      # (try_end),
                      # (try_begin),
                        # (lt, ":angle_sin_enemies", 0),
                        # (val_mul,":angle_cos_enemies", -1),
                        # (val_add,":angle_cos_enemies", 360000),
                      # (try_end),
                      # (store_sub, ":k2", ":angle_cos", ":angle_cos_enemies"),
                      # (val_sub, ":k2", 270000),
                      # (val_sub, ":k2", ":effect"),
                      # (store_add, ":effect", ":k2", ":effect"),
                      # (try_begin),
                        # (lt, ":angle_cos", ":angle_cos_enemies"),
                        # (val_add, ":effect", 360000),
                      # (try_end),
                      # (val_clamp,":effect",-210000, 15000),
                      # (agent_set_attack_action, ":agent_no", -2, 1),
                      # (agent_set_defend_action, ":agent_no", 3, 1),
                    # (try_end),
                    # (store_cos, ":cos", ":effect"),
                    # (store_sin, ":sin", ":effect"),
                    # (store_mul, ":k_x1", ":cos", ":enemies_y",),
                    # (store_mul, ":k_x2", ":sin", ":enemies_x",),
                    # (store_mul, ":k_y1", ":sin", ":enemies_y",),
                    # (store_mul, ":k_y2", ":cos", ":enemies_x",),
                    # (store_add, ":move_x",":k_x1", ":k_x2"),
                    # (store_sub, ":move_y",":k_y1", ":k_y2"),
                    # (position_move_x, pos50, ":move_x", 0),
                    # (position_move_y, pos50, ":move_y", 0),
                  # (try_end),
                  # (agent_set_scripted_destination, ":agent_no", pos50, 1),
                # (else_try),
                  # (agent_clear_scripted_mode, ":agent_no"),
                  # (agent_force_rethink, ":agent_no"),
                # (try_end),
            # (else_try),
                # (try_begin),
                  # (agent_slot_eq, ":agent_no", slot_agent_is_skirmishing, 0),
                  # (agent_set_slot, ":agent_no", slot_agent_is_skirmishing, 1),
                # (else_try),
                  # (agent_slot_eq, ":agent_no", slot_agent_is_skirmishing, 2),
                  # (this_or_next|agent_slot_eq, ":agent_no", slot_agent_is_running_away, 1),
                  # (this_or_next|lt, ":horse_no", 0),
                  # (this_or_next|eq, ":ammo", 0),
                  # (this_or_next|eq, ":hold_fire", aordr_hold_your_fire),
                  # (this_or_next|eq, ":weapon_usage_order", wordr_use_melee_weapons),
                  # (neq, ":movement_order", mordr_charge),
                  # (agent_clear_scripted_mode, ":agent_no"),
                  # (agent_set_speed_limit, ":agent_no", 100),
                  # (agent_force_rethink, ":agent_no"),
                  # (agent_set_slot, ":agent_no", slot_agent_is_skirmishing, 3),
                  # (this_or_next|eq, ":hold_fire", aordr_hold_your_fire),
                  # (eq, ":ammo", 0),
                  # (gt, ":melee_weapon", -1),
                  # (agent_set_wielded_item, ":agent_no", ":melee_weapon"),
                # (try_end),
            # (try_end),
        # (try_end),
  # ])

improved_horse_archer_ai = [

  (0, 0, ti_once, [
  ],[
    (ge, "$cheat_mode", 1),
    (assign, "$g_tracker", -1),
  ]),

  (1, 0, 0, [
    (eq,"$g_battle_won",0),
  ],[
    (set_fixed_point_multiplier, 100),
    (try_for_agents, ":agent"),
        (agent_is_active, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_human, ":agent"),
        (agent_is_non_player, ":agent"),
        (try_begin),
            (agent_slot_eq, ":agent", slot_agent_is_running_away, 0), #Isn't routing.
            (agent_get_horse, ":horse", ":agent"),
            (gt, ":horse", 0), #mounted
            (agent_get_ammo, ":ammo_left", ":agent"),
            (gt, ":ammo_left", 0),
            (assign, ":ranged", 0),
            (try_for_range, ":r", "itm_javelin", "itm_sling"),
                (neg|is_between, ":r", "itm_pilum", "itm_hunting_bow"),
                (agent_has_item_equipped, ":agent", ":r"),
                (assign, ":ranged", 1),
            (try_end),

            (eq, ":ranged", 1),
            (agent_get_team, ":team", ":agent"),
            (agent_get_division, ":division", ":agent"),

            (team_get_weapon_usage_order, ":weapon_usage_order", ":team", ":division"),
            (team_get_movement_order, ":movement_order", ":team", ":division"),
            (team_get_hold_fire_order, ":hold_fire", ":team", ":division"),
            (neq, ":hold_fire", aordr_hold_your_fire),
            (neq, ":weapon_usage_order", wordr_use_melee_weapons),
            (eq, ":movement_order", mordr_charge),

            ##equip script
            ##mounted troops use bows n shit
            (try_begin),
                (assign, ":c", 1),
                (try_begin),
                    (agent_get_wielded_item, ":item", ":agent", 0),
                    (is_between, ":item", 1, "itm_items_end"),
                    (item_get_type, ":type", ":item"),
                    (this_or_next|eq, ":type", itp_type_thrown),
                    (eq, ":type", itp_type_bow),
                    (assign, ":c", 0),#block if already equipped
                (try_end),
                (eq, ":c", 1),
                (try_for_range, reg0, 0, 4),
                    (agent_get_item_slot, ":item", ":agent", reg0),
                    (is_between, ":item", 1, "itm_items_end"),
                    #(gt, ":item", 0),
                    (item_get_type, ":type", ":item"),
                    (this_or_next|eq, ":type", itp_type_thrown),
                    (eq, ":type", itp_type_bow),
                    (agent_set_wielded_item, ":agent", ":item"),
                    (assign, reg0, -1), ##break
                (try_end),
            (try_end),

            (agent_get_wielded_item, ":item", ":agent", 0),
            (item_get_type, ":type", ":item"),
            (this_or_next|eq, ":type", itp_type_thrown),
            (eq, ":type", itp_type_bow),

            (call_script, "script_get_first_closest_enemy_distance", ":agent", ":team", 200), # Find distance of nearest 3 enemies
            (assign, ":nearest_enemy", reg18),
            (assign, ":closest_agent", reg19),
            (gt, ":closest_agent", -1),

            (try_begin),
                (assign, ":radious", 8000),
                (assign, ":nearest_enemy_range", 8500),
                # (assign, ":skrimish_angle", 10),
                (try_begin),
                    (eq, ":type", itp_type_thrown),
                    (assign, ":nearest_enemy_range", 7500),
                    (assign, ":radious", 7000),
                (try_end),
                (call_script, "script_horse_archer_skirmish", ":agent", ":closest_agent", ":nearest_enemy", ":radious", ":nearest_enemy_range"),
                (try_begin), ##shooot more often
                    (gt, ":nearest_enemy", 200),
                    (lt, ":nearest_enemy", 7500),
                    (store_random_in_range, ":random", 0, 10),
                    (le, ":random", 2),
                    (agent_get_attack_action, ":action", ":agent"),
                    (eq, ":action", 0), #free
                    (agent_get_combat_state, ":agent_cs", ":agent"),
                    (neq, ":agent_cs", 7), #NEG does not see target
                    (this_or_next|eq, ":type", itp_type_thrown),
                    (eq, ":type", itp_type_bow),
                    #(eq, ":type", itp_type_crossbow),
                    (agent_set_attack_action, ":agent", 0, 0),
                (try_end),
            (try_end),
        (else_try), #clear horse archer skirmisher ai
            (agent_slot_eq, ":agent", slot_agent_is_in_scripted_mode, 1),
            (agent_set_slot, ":agent", slot_agent_is_in_scripted_mode, 0),
            (agent_clear_scripted_mode, ":agent"),
            (call_script, "script_equip_best_melee_weapon", ":agent", 0, 0, 0),
            # (agent_force_rethink, ":agent"),
        (try_end),
    (try_end),
  ])
]

AI_triggers = [
  # Trigger file: AI_before_mission_start
  (ti_before_mission_start, 0, 0, [],[
      (assign, "$ranged_clock", 0),
      (assign, "$clock_reset", 0),
      (assign, "$teams_last_fighting", 0),
      (init_position, Team0_Cavalry_Destination),
      (init_position, Team1_Cavalry_Destination),
      (init_position, Team2_Cavalry_Destination),
      (init_position, Team3_Cavalry_Destination),

      (try_begin),
        (eq, "$player_deploy_troops", 0),
        (assign, "$battle_phase", BP_Setup),
      (else_try),
        (assign, "$battle_phase", BP_Ready),	#deployment triggers must advance battle phase
      (try_end)
  ]),

  # Trigger file: AI_after_mission_start
  (0, 0, ti_once, [
      (call_script, "script_cf_division_data_available"),
      ],[
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":team", 0, 4),
        (call_script, "script_battlegroup_get_position", pos0, ":team", grc_everyone),
        (position_get_x, reg0, pos0),
        (team_set_slot, ":team", slot_team_starting_x, reg0),
        (position_get_y, reg0, pos0),
        (team_set_slot, ":team", slot_team_starting_y, reg0),

        #prevent confusion over AI not using formations for archers
        (neq, ":team", "$fplayer_team_no"),
        (store_add, ":slot", slot_team_d0_formation, grc_archers),
        (team_set_slot, ":team", ":slot", formation_none),

        #set up by spawn point until BP_Setup
        (call_script, "script_field_start_position", ":team"),	#returns pos2
        (copy_position, pos1, pos2),
        (team_get_leader, ":ai_leader", ":team"),
        (call_script, "script_division_reset_places"),

        (try_for_range, ":division", 0, 9),
          (call_script, "script_battlegroup_place_around_pos1", ":team", ":division", ":ai_leader"),
        (try_end),
      (try_end),
  ]),

  # Trigger file: AI_setup
  (0, 0, ti_once, [
      (call_script, "script_cf_division_data_available"),
      (ge, "$battle_phase", BP_Setup),	#wait 'til player deploys
      ],[
      (call_script, "script_field_tactics", 1),
  ]),

  # Trigger file: AI_regular_trigger
  (.1, 0, 0, [
      (gt, "$last_player_trigger", 0),
      (ge, "$battle_phase", BP_Setup),

      (store_mission_timer_c_msec, reg0),
      (val_sub, reg0, "$last_player_trigger"),
      (ge, reg0, 250),	#delay to offset from formations trigger (trigger delay does not work right)
      ],[
      (val_add, "$last_player_trigger", 500),

      (try_begin),	#catch moment fighting starts
        (eq, "$clock_reset", 0),
        (call_script, "script_cf_any_fighting"),
        (call_script, "script_cf_count_casualties"),
        (assign, "$battle_phase", BP_Fight),
      (else_try),
        (eq, "$clock_reset", 0),
        (store_current_scene, ":scene"),
        (eq, ":scene", "scn_holy_lance_cave"), # nero: special scene make them attack!
        (assign, "$battle_phase", BP_Fight),
      (try_end),

      (set_fixed_point_multiplier, 100),
      (call_script, "script_store_battlegroup_data"),

      (try_begin),	#reassess ranged position when fighting starts
        (ge, "$battle_phase", BP_Fight),	#we have to do it this way because BP_Fight may be set in ways other than casualties
        (eq, "$clock_reset", 0),
        (call_script, "script_field_tactics", 1),
        (assign, "$ranged_clock", 0),
        (assign, "$clock_reset", 1),

      (else_try),	#at longer intervals after setup...
        (ge, "$battle_phase", BP_Jockey),
        (store_mul, ":five_sec_modulus", 5, Reform_Trigger_Modulus),
        (val_div, ":five_sec_modulus", formation_reform_interval),
        (store_mod, reg0, "$ranged_clock", ":five_sec_modulus"),
        # (eq, reg0, 0),	#MOTO uncomment this line if archers too fidgety

        #reassess archer position
        (call_script, "script_field_tactics", 1),

        #catch reinforcements and set divisions to be retyped with new troops
        (try_begin),
          (neg|team_slot_eq, 0, slot_team_reinforcement_stage, "$defender_reinforcement_stage"),
          (team_set_slot, 0, slot_team_reinforcement_stage, "$defender_reinforcement_stage"),
          (try_for_range, ":division", 0, 9),
            (store_add, ":slot", slot_team_d0_type, ":division"),
            (team_set_slot, 0, ":slot", sdt_unknown),
            (team_set_slot, 2, ":slot", sdt_unknown),
          (try_end),
        (try_end),
        (try_begin),
          (neg|team_slot_eq, 1, slot_team_reinforcement_stage, "$attacker_reinforcement_stage"),
          (team_set_slot, 1, slot_team_reinforcement_stage, "$attacker_reinforcement_stage"),
          (try_for_range, ":division", 0, 9),
            (store_add, ":slot", slot_team_d0_type, ":division"),
            (team_set_slot, 1, ":slot", sdt_unknown),
            (team_set_slot, 3, ":slot", sdt_unknown),
          (try_end),
        (try_end),

      (else_try),
        (call_script, "script_field_tactics", 0),
      (try_end),

      (try_begin),
        (eq, "$battle_phase", BP_Setup),
        (assign, ":not_in_setup_position", 0),
        (try_for_range, ":bgteam", 0, 4),
          (neq, ":bgteam", "$fplayer_team_no"),
          (team_slot_ge, ":bgteam", slot_team_size, 1),
          (call_script, "script_battlegroup_get_position", pos1, ":bgteam", grc_archers),
          (team_get_order_position, pos0, ":bgteam", grc_archers),
          (get_distance_between_positions, reg0, pos0, pos1),
          (gt, reg0, 500),
          (assign, ":not_in_setup_position", 1),
        (try_end),
        (eq, ":not_in_setup_position", 0),	#all AI reached setup position?
        (assign, "$battle_phase", BP_Jockey),
      (try_end),

      (val_add, "$ranged_clock", 1),
  ]),

  # Trigger file: AI_hero_fallen
  #if AI to take over for mods with post-player battle action
  (0, 0, ti_once, [
    (main_hero_fallen),

    (assign, "$cam_mode", 0),#pickbacking this here to disable strategic camera

    (eq, AI_Replace_Dead_Player, 1),
  ],[
    (set_show_messages, 0),
    #undo special player commands
    (team_set_order_listener, "$fplayer_team_no", grc_everyone),
    (team_give_order, "$fplayer_team_no", grc_everyone, mordr_use_any_weapon),
    (team_give_order, "$fplayer_team_no", grc_everyone, mordr_fire_at_will),

    #clear all scripted movement (for now)
    (call_script, "script_player_order_formations", mordr_retreat),
    (set_show_messages, 1),

    (try_for_agents, ":agent"),	#reassign agents to the divisions AI uses
      (agent_is_alive, ":agent"),
      (call_script, "script_agent_fix_division", ":agent"),
    (try_end),
  ]),
] #end AI triggers

common_after_mission_start = (
  ti_after_mission_start, 0, ti_once, [],[
    (get_player_agent_no, "$fplayer_agent_no"),
    (try_begin),
      (eq, "$fplayer_agent_no", -1),
      (assign, "$fplayer_team_no", -1),
    (else_try),
      (agent_get_group, "$fplayer_team_no", "$fplayer_agent_no"),
    (try_end),
    # (agent_get_horse, ":horse", "$fplayer_agent_no"),
    # (agent_set_slot, "$fplayer_agent_no", slot_agent_horse, ":horse"),
    (set_fixed_point_multiplier, 100),
    (get_scene_boundaries, pos2, pos3),
    (position_get_x, "$g_bound_right", pos3),
    (position_get_y, "$g_bound_top", pos3),
    (position_get_x, "$g_bound_left", pos2),
    (position_get_y, "$g_bound_bottom", pos2),
])

utility_triggers = [  #1 trigger
  common_after_mission_start,
]

#to prevent presentations from starting while old ones are still running
common_presentation_switcher = (
  .05, 0, 0, [
    (neq, "$switch_presentation_new", 0), #we can safely ignore prsnt_game_start
    (neg|is_presentation_active, "$switch_presentation_old"),
    ],[
    (start_presentation, "$switch_presentation_new"),
    (assign, "$switch_presentation_old", "$switch_presentation_new"), #this makes the heroic assumption that all presentations use this system
    (assign, "$switch_presentation_new", 0),
])

battle_panel_triggers = [ #4 triggers
  common_presentation_switcher,

  (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (agent_set_slot, ":agent_no", slot_agent_map_overlay_id, 0),
  ]),

  (0, 0, 0, [
      (game_key_clicked, gk_view_orders)
  ],[
      (try_begin),
        (is_presentation_active, "prsnt_battle"),
        (presentation_set_duration, 0),

      (else_try),
        (presentation_set_duration, 0),
        (assign, "$switch_presentation_new", "prsnt_battle"),
      (try_end),
  ]),

  # (0.1, 0, 0, [ this is left from Native code
      # (is_presentation_active, "prsnt_battle")
  # ],[
      # (call_script, "script_update_order_panel_statistics_and_map"),
  # ]),
]

extended_battle_menu = [  #15 triggers
  # Trigger file: extended_battle_menu_init
  (ti_before_mission_start ,0, ti_once, [],[
      (assign, "$gk_order", 0),	#tracks the first tier order given
      (assign, "$gk_order_hold_over_there", HOT_no_order),	#used to determine if F1 key is being held down
      (assign, "$native_opening_menu", 0),	#tracks whether the first tier battle menu would normally be showing
      (assign, "$g_presentation_active", 0),	#used here to track whether prsnt_battle is overridden when fake battle menu starts
  ]),

  common_presentation_switcher,

  # Trigger file: extended_battle_menu_division_selection
  (0,0,.1, [
      (this_or_next|game_key_clicked, gk_group0_hear),
      (this_or_next|game_key_clicked, gk_group1_hear),
      (this_or_next|game_key_clicked, gk_group2_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),	#shows up as "unknown 6" on Native screen
      (this_or_next|game_key_clicked, gk_everyone_around_hear),
      (game_key_clicked, gk_everyone_hear),
      (neg|main_hero_fallen),
      ],[
      (assign, "$gk_order", 0),
      (try_begin),
        (is_presentation_active, "prsnt_battle"),
        (assign, "$g_presentation_active", 1),
      (try_end),
      (try_begin),
        (presentation_set_duration, 0),
        (assign, "$switch_presentation_new", "prsnt_order_display"),
      (try_end),
      (assign, "$native_opening_menu", 1),
      (try_begin),
        (eq, "$battle_phase", BP_Deploy),
        (try_for_range, ":division", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":division"),
          (store_add, ":slot", slot_team_d0_formation, ":division"),
          (team_get_slot, ":formation", "$fplayer_team_no", ":slot"),
          (set_show_messages, 0),
          (call_script, "script_formation_to_native_order", "$fplayer_team_no", ":division", ":formation"),	#force Native formation update to delink listening/non-listening
          (set_show_messages, 1),
        (try_end),
      (try_end),
  ]),

  # Trigger file: extended_battle_menu_tab_out
  # (ti_tab_pressed, 0, 0, [
  # (is_presentation_active, "prsnt_order_display"),
  # ],[
  # (assign, "$gk_order", 0),
  # (assign, "$native_opening_menu", 0),
  # (presentation_set_duration, 0),
  # ]),

  # Trigger file: extended_battle_menu_esc_or_die_out
  (0, 0, 0, [
      (this_or_next|main_hero_fallen),
      (key_is_down, key_escape),
      (is_presentation_active, "prsnt_order_display"),
      ],[
      (presentation_set_duration, 0),
      (assign, "$native_opening_menu", 0),
  ]),

  (0, 0, 0, [
      (this_or_next|main_hero_fallen),
      (key_is_down, key_escape),
      (neq, "$gk_order", 0),
      ],[
      (assign, "$gk_order", 0),
  ]),

  # Trigger file: extended_battle_menu_hold_F1
  (.1, 0, 0, [
      (neq, "$when_f1_first_detected", 0),
      # (store_application_time, reg0),	#real time for when game time is slowed for real deployment
      (store_mission_timer_c_msec, reg0),
      (val_sub, reg0, "$when_f1_first_detected"),
      (ge, reg0, 250),	#check around .3 seconds later (Native trigger delay does not work right)
      (eq, "$gk_order", gk_order_1),	#next trigger set MOVE menu?
      ],[
      (assign, "$when_f1_first_detected", 0),

      (try_begin),
        (game_key_is_down, gk_order_1),	#BUT player is holding down key?
        (assign, "$gk_order_hold_over_there", HOT_F1_held),
        (assign, "$gk_order", 0),

        (store_and, reg0, "$first_time", first_time_hold_F1),
        (try_begin),
          (eq, reg0, 0),
          (val_or, "$first_time", first_time_hold_F1),
          (eq, "$g_is_quick_battle", 0),
          (dialog_box, "str_division_placement", "@Division Placement"),
        (try_end),

      (else_try),
        (eq, "$gk_order_hold_over_there", HOT_F1_pressed),
        (assign, "$gk_order_hold_over_there", HOT_no_order),
        (assign, "$gk_order", 0),
        (call_script, "script_player_order_formations", mordr_hold),
      (try_end),
  ]),

  # Trigger file: extended_battle_menu_F1
  (0, 0, 0, [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen)
      ],[
      # (store_application_time, "$when_f1_first_detected"),
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neq, "$gk_order", gk_order_1),
        (neq, "$gk_order", gk_order_2),
        (neq, "$gk_order", gk_order_3),
        (assign, "$gk_order", gk_order_1),
        (assign, "$native_opening_menu", 0),
        (try_begin),
          (is_presentation_active, "prsnt_battle"),
          (assign, "$g_presentation_active", 1),
        (try_end),
        (presentation_set_duration, 0),	#clear main menu additions
        (assign, "$gk_order_hold_over_there", HOT_no_order),
      (else_try),
        (eq, "$gk_order", gk_order_1),	#HOLD
        (assign, "$gk_order_hold_over_there", HOT_F1_pressed),
      (else_try),
        (eq, "$gk_order", gk_order_2),	#ADVANCE
        (assign, "$gk_order", 0),
        (presentation_set_duration, 0),	#clear F2 menu additions
        (call_script, "script_player_order_formations", mordr_advance),
      (else_try),
        (eq, "$gk_order", gk_order_3),	#HOLD FIRE
        (assign, "$gk_order", 0),
      (try_end),
  ]),

  # Trigger file: extended_battle_menu_F2
  (0, 0, 0, [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen)
      ],[
      (try_begin),
        (neq, "$gk_order", gk_order_1),
        (neq, "$gk_order", gk_order_2),
        (neq, "$gk_order", gk_order_3),
        (assign, "$gk_order", gk_order_2),
        (assign, "$native_opening_menu", 0),
        (try_begin),
          (is_presentation_active, "prsnt_battle"),
          (assign, "$g_presentation_active", 1),
        (try_end),
        (presentation_set_duration, 0),
        (assign, "$switch_presentation_new", "prsnt_order_display"),
      (else_try),
        (eq, "$gk_order", gk_order_1),	#FOLLOW
        (assign, "$gk_order", 0),
        (call_script, "script_player_order_formations", mordr_follow),
      (else_try),
        (eq, "$gk_order", gk_order_2),	#FALL BACK
        (assign, "$gk_order", 0),
        (presentation_set_duration, 0),	#clear F2 menu additions
        (call_script, "script_player_order_formations", mordr_fall_back),
      (else_try),
        (eq, "$gk_order", gk_order_3),	#FIRE AT WILL
        (assign, "$gk_order", 0),
      (try_end),
  ]),

  # Trigger file: extended_battle_menu_F3
  (0, 0, 0, [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen)
      ],[
      (try_begin),
        (neq, "$gk_order", gk_order_1),
        (neq, "$gk_order", gk_order_2),
        (neq, "$gk_order", gk_order_3),
        (assign, "$gk_order", gk_order_3),
        (assign, "$native_opening_menu", 0),
        (try_begin),
          (is_presentation_active, "prsnt_battle"),
          (assign, "$g_presentation_active", 1),
        (try_end),
        (presentation_set_duration, 0),	#clear main menu additions
      (else_try),
        (eq, "$gk_order", gk_order_1),	#CHARGE
        (assign, "$gk_order", 0),
        (call_script, "script_player_order_formations", mordr_charge),
      (else_try),
        (eq, "$gk_order", gk_order_2),	#SPREAD OUT
        (assign, "$gk_order", 0),
        (presentation_set_duration, 0),	#clear F2 menu additions
        (call_script, "script_player_order_formations", mordr_spread_out),
      (else_try),
        (eq, "$gk_order", gk_order_3),	#BLUNT WEAPONS
        (assign, "$gk_order", 0),
      (try_end),
  ]),

  # Trigger file: extended_battle_menu_F4
  (0, 0, 0, [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen)
      ],[
      (try_begin),
        (eq, "$gk_order", 0),
        (try_begin),
          (eq, "$form_ai_off", 0),
          (assign, "$gk_order", gk_order_4),
          (try_begin),
            (is_presentation_active, "prsnt_battle"),
            (assign, "$g_presentation_active", 1),
          (try_end),
          (presentation_set_duration, 0),
          (assign, "$switch_presentation_new", "prsnt_order_display"),

          (store_and, reg0, "$first_time", first_time_formations),
          (try_begin),
            (eq, reg0, 0),
            (val_or, "$first_time", first_time_formations),
            (eq, "$g_is_quick_battle", 0),
            (dialog_box, "str_formations", "@Complex Formations"),
          (try_end),

        (else_try),
          (display_message, "@Formations turned OFF in options menu"),
          (eq, "$native_opening_menu", 1),
          (try_begin),
            (is_presentation_active, "prsnt_battle"),
            (assign, "$g_presentation_active", 1),
          (try_end),
          (presentation_set_duration, 0),
          (assign, "$switch_presentation_new", "prsnt_order_display"),
        (try_end),
      (else_try),
        (eq, "$gk_order", gk_order_1),	#STAND GROUND
        (assign, "$gk_order", 0),
        (call_script, "script_player_order_formations", mordr_stand_ground),
      (else_try),
        (eq, "$gk_order", gk_order_2),	#STAND CLOSER
        (assign, "$gk_order", 0),
        (presentation_set_duration, 0),	#clear F2 menu additions
        (call_script, "script_player_order_formations", mordr_stand_closer),
      (else_try),
        (eq, "$gk_order", gk_order_3),	#ANY WEAPON
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", gk_order_4),	#FORMATION - RANKS
        (assign, "$gk_order", 0),
        (call_script, "script_division_reset_places"),
        (try_for_range, ":division", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":division"),
          (store_add, ":slot", slot_team_d0_target_team, ":division"),
          (team_set_slot, "$fplayer_team_no", ":slot", -1),
          (store_add, ":slot", slot_team_d0_size, ":division"),
          (team_slot_ge, "$fplayer_team_no", ":slot", 1),
          (store_add, ":slot", slot_team_d0_fclock, ":division"),
          (team_set_slot, "$fplayer_team_no", ":slot", 1),
          (call_script, "script_player_attempt_formation", ":division", formation_ranks, 1),
        (try_end),
      (try_end),
  ]),

  # Trigger file: extended_battle_menu_F5
  (0, 0, 0, [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen)
      ],[
      (try_begin),
        (eq, "$gk_order", 0),	#Redisplay
        (eq, "$native_opening_menu", 1),
        (try_begin),
          (is_presentation_active, "prsnt_battle"),
          (assign, "$g_presentation_active", 1),
        (try_end),
        (presentation_set_duration, 0),
        (assign, "$switch_presentation_new", "prsnt_order_display"),
      (else_try),
        (eq, "$gk_order", gk_order_1),	#RETREAT
        (assign, "$gk_order", 0),
        (call_script, "script_player_order_formations", mordr_retreat),
      (else_try),
        (eq, "$gk_order", gk_order_2),	#MOUNT
        (assign, "$gk_order", 0),
        (presentation_set_duration, 0),	#clear F2 menu additions
      (else_try),
        (eq, "$gk_order", gk_order_4), #FORMATION - SHIELDWALL
        (assign, "$gk_order", 0),
        (call_script, "script_division_reset_places"),
        (try_for_range, ":division", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":division"),
          (store_add, ":slot", slot_team_d0_target_team, ":division"),
          (team_set_slot, "$fplayer_team_no", ":slot", -1),
          (store_add, ":slot", slot_team_d0_size, ":division"),
          (team_slot_ge, "$fplayer_team_no", ":slot", 1),
          (store_add, ":slot", slot_team_d0_fclock, ":division"),
          (team_set_slot, "$fplayer_team_no", ":slot", 1),
          (call_script, "script_player_attempt_formation", ":division", formation_shield, 1),
        (try_end),
      (try_end),
  ]),

  # Trigger file: extended_battle_menu_F6
  (0, 0, 0, [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen)
      ],[
      (try_begin),
        (eq, "$gk_order", 0),	#Redisplay
        (eq, "$native_opening_menu", 1),
        (try_begin),
          (is_presentation_active, "prsnt_battle"),
          (assign, "$g_presentation_active", 1),
        (try_end),
        (presentation_set_duration, 0),
        (assign, "$switch_presentation_new", "prsnt_order_display"),
      (else_try),
        (eq, "$gk_order", gk_order_2),	#DISMOUNT
        (assign, "$gk_order", 0),
        (presentation_set_duration, 0),	#clear F2 menu additions
        (call_script, "script_player_order_formations", mordr_dismount),
      (else_try),
        (eq, "$gk_order", gk_order_4), #FORMATION - WEDGE
        (assign, "$gk_order", 0),
        (call_script, "script_division_reset_places"),
        (try_for_range, ":division", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":division"),
          (store_add, ":slot", slot_team_d0_target_team, ":division"),
          (team_set_slot, "$fplayer_team_no", ":slot", -1),
          (store_add, ":slot", slot_team_d0_size, ":division"),
          (team_slot_ge, "$fplayer_team_no", ":slot", 1),
          (store_add, ":slot", slot_team_d0_fclock, ":division"),
          (team_set_slot, "$fplayer_team_no", ":slot", 1),
          (call_script, "script_player_attempt_formation", ":division", formation_wedge, 1),
        (try_end),
      (try_end),
  ]),

  # Trigger file: extended_battle_menu_F7
  (0, 0, 0, [
      (key_clicked, key_f7),
      (neg|main_hero_fallen)
      ],[
      (try_begin),
        (eq, "$gk_order", 0),	#Redisplay
        (eq, "$native_opening_menu", 1),
        (try_begin),
          (is_presentation_active, "prsnt_battle"),
          (assign, "$g_presentation_active", 1),
        (try_end),
        (presentation_set_duration, 0),
        (assign, "$switch_presentation_new", "prsnt_order_display"),
      (else_try),
        (eq, "$gk_order", gk_order_2),	#MEMORIZE DIVISION PLACEMENTS
        (call_script, "script_memorize_division_placements"),

      (else_try),
        (eq, "$gk_order", gk_order_4), #FORMATION - SQUARE
        (assign, "$gk_order", 0),
        (call_script, "script_division_reset_places"),
        (try_for_range, ":division", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":division"),
          (store_add, ":slot", slot_team_d0_target_team, ":division"),
          (team_set_slot, "$fplayer_team_no", ":slot", -1),
          (store_add, ":slot", slot_team_d0_size, ":division"),
          (team_slot_ge, "$fplayer_team_no", ":slot", 1),
          (store_add, ":slot", slot_team_d0_fclock, ":division"),
          (team_set_slot, "$fplayer_team_no", ":slot", 1),
          (call_script, "script_player_attempt_formation", ":division", formation_square, 1),
        (try_end),
      (try_end),
  ]),

  # Trigger file: extended_battle_menu_F8
  (0, 0, 0, [
      (key_clicked, key_f8),
      (neg|main_hero_fallen)
      ],[
      (try_begin),
        (eq, "$gk_order", 0),	#Redisplay
        (eq, "$native_opening_menu", 1),
        (try_begin),
          (is_presentation_active, "prsnt_battle"),
          (assign, "$g_presentation_active", 1),
        (try_end),
        (presentation_set_duration, 0),
        (assign, "$switch_presentation_new", "prsnt_order_display"),
      (else_try),
        (eq, "$gk_order", gk_order_2),	#FORGET DIVISION PLACEMENTS (WILL USE DEFAULT)
        (call_script, "script_default_division_placements"),
      (else_try),
        (eq, "$gk_order", gk_order_4), #FORMATION - CANCEL
        (assign, "$gk_order", 0),
        (call_script, "script_player_order_formations", mordr_charge),
      (try_end),
  ]),

  # Trigger file: extended_battle_menu_restore_prsnt_battle
  (0.7, 0, 0, [
      (eq, "$g_presentation_active", 1),
      (neg|is_presentation_active, "prsnt_order_display"),
      (eq, "$gk_order", 0),
      ],[
      (presentation_set_duration, 0),
      (assign, "$switch_presentation_new", "prsnt_battle"),
      (assign, "$g_presentation_active", 0),
  ]),
]#end extended battle menu

#These triggers acquire division data
common_division_data = [  #4 triggers
  # Trigger file: common_division_data_ti_before_mission_start
  (ti_before_mission_start, 0, 0, [],[
      (assign, "$last_player_trigger", -2),
      (try_for_range, ":team", 0, 4),
        (team_set_slot, ":team", slot_team_size, 0),
        (try_for_range, ":division", 0, 9),
          (store_add, ":slot", slot_team_d0_type, ":division"),
          (team_set_slot, ":team", ":slot", sdt_unknown),
        (try_end),
      (try_end),
  ]),

  # Trigger file: common_division_data_ti_after_mission_start
  (0, .2, ti_once, [(mission_tpl_are_all_agents_spawned)],[	#only 300 or so agents are spawned by ti_after_mission_start
      (try_for_agents, ":agent"),
        (agent_is_active, ":agent"),
        (agent_is_human, ":agent"),
        (try_begin),
          (multiplayer_get_my_player, ":player"),
          (player_is_active, ":player"),
          (player_get_agent_id, ":player_agent", ":player"),
          (eq, ":agent", ":player_agent"),
          (assign, "$fplayer_agent_no", ":player_agent"),
          (player_get_team_no,  "$fplayer_team_no", ":player"),
        (else_try),
          (agent_is_non_player, ":agent"),
          (agent_get_group, ":team", ":agent"),
          (gt, ":team", -1),	#not a MP spectator
          (call_script, "script_agent_fix_division", ":agent"), #Division fix
        (try_end),
      (try_end),

      (try_begin),
        (neg|game_in_multiplayer_mode),
        (set_fixed_point_multiplier, 100),
        (call_script, "script_store_battlegroup_data"),

        #get modal team faction
        (store_sub, ":num_kingdoms", kingdoms_end, kingdoms_begin),
        (store_mul, ":end", 4, ":num_kingdoms"),
        (try_for_range, ":slot", 0, ":end"),
          (team_set_slot, scratch_team, ":slot", 0),
        (try_end),
        (try_for_agents, ":cur_agent"),
          (agent_is_human, ":cur_agent"),
          (agent_get_group, ":cur_team", ":cur_agent"),
          (agent_get_troop_id, ":cur_troop", ":cur_agent"),
          (store_troop_faction, ":cur_faction", ":cur_troop"),
          (is_between, ":cur_faction", kingdoms_begin, kingdoms_end),
          (store_mul, ":slot", ":cur_team", ":num_kingdoms"),
          (val_sub, ":cur_faction", kingdoms_begin),
          (val_add, ":slot", ":cur_faction"),
          (team_get_slot, ":count", scratch_team, ":slot"),
          (val_add, ":count", 1),
          (team_set_slot, scratch_team, ":slot", ":count"),
        (try_end),

        (try_for_range, ":team", 0, 4),
          (team_slot_ge, ":team", slot_team_size, 1),
          (team_get_leader, ":fleader", ":team"),
          (try_begin),
            (ge, ":fleader", 0),
            (agent_get_troop_id, ":fleader_troop", ":fleader"),
            (store_troop_faction, ":team_faction", ":fleader_troop"),
          (else_try),
            (assign, ":team_faction", 0),
            (assign, ":modal_count", 0),
            (store_mul, ":begin", ":team", ":num_kingdoms"),
            (store_add, ":end", ":begin", ":num_kingdoms"),
            (try_for_range, ":slot", ":begin", ":end"),
              (team_get_slot, ":count", scratch_team, ":slot"),
              (gt, ":count", ":modal_count"),
              (assign, ":modal_count", ":count"),
              (store_sub, ":team_faction", ":begin", ":slot"),
              (val_add, ":team_faction", kingdoms_begin),
            (try_end),
          (try_end),
          (team_set_slot, ":team", slot_team_faction, ":team_faction"),
        (try_end),
      (try_end),

      (val_add, "$last_player_trigger", 1),	#signal .5 sec trigger to start
  ]),

  #catch spawning agents after initial setup
  (ti_on_agent_spawn, 0, 0, [(call_script, "script_cf_division_data_available")],[
      (store_trigger_param_1, ":agent"),
      (call_script, "script_agent_fix_division", ":agent"), #Division fix
      # (str_store_agent_name, s2, ":agent"),
      # (agent_get_division, reg33, ":agent"),
      # (display_message, "@Fix division for agent, {s2}, division: {reg33}"),
  ]),

  # (0, 0, 0, [
  # (key_clicked, key_left_control),
  # ],[
      # (try_for_range, ":agent"),
        # (str_store_agent_name, s2, ":agent"),
        # (agent_get_division, reg33, ":agent"),
        # (display_message, "@Fix division for agent, {s2}, division: {reg33}"),
      # (try_end),
  # ]),

  # Trigger file: common_division_data_regular_trigger
  (0.5, 0, 0, [
      (neq, "$last_player_trigger", -2),
      (neg|main_hero_fallen),
      ],[
      (set_fixed_point_multiplier, 100),
      (store_mission_timer_c_msec, "$last_player_trigger"),

      (try_begin),	#set up revertible types for type check
        (try_for_range, ":team", 0, 4),
          (try_for_range, ":division", 0, 9),
            (store_add, ":slot", slot_team_d0_type, ":division"),
            (this_or_next|team_slot_eq, ":team", ":slot", sdt_skirmisher),
            (team_slot_eq, ":team", ":slot", sdt_harcher),
            (team_set_slot, ":team", ":slot", sdt_unknown),
          (try_end),
        (try_end),
      (try_end),

      (call_script, "script_store_battlegroup_data"),
  ]),
]#end common division data

#These triggers process non-Native orders to divisions
#divorced from whatever command or AI interface (the back end)
division_order_processing = [ #4 triggers
    # Trigger file: division_order_processing_before_mission_start
    (ti_before_mission_start, 0, ti_once, [],[
      (assign, "$g_division_order_processing", 1),	#flag showing these functions are active

      (try_for_range, ":team", 0, 4),
          (try_for_range, reg0, slot_team_d0_target_team, slot_team_d0_target_team+9),
              (team_set_slot, ":team", reg0, -1),
          (try_end),

          #represent Native initial state
          (try_begin),
            (eq, Native_Formations_Implementation, WFaS_Implementation),
            (try_for_range, reg0, slot_team_d0_formation, slot_team_d0_formation+9),
                (team_set_slot, ":team", reg0, formation_2_row),
            (try_end),
            (try_for_range, reg0, slot_team_d0_formation_num_ranks, slot_team_d0_formation_num_ranks+9),
                (team_set_slot, ":team", reg0, 2),
            (try_end),
            (try_for_range, reg0, slot_team_d0_formation_space, slot_team_d0_formation_space+9),
                (team_set_slot, ":team", reg0, 1),
            (try_end),

          (else_try),
              (try_for_range, reg0, slot_team_d0_formation, slot_team_d0_formation+9),
                  (team_set_slot, ":team", reg0, formation_none),
              (try_end),
          (try_end),

          (try_for_range, reg0, slot_team_d0_move_order, slot_team_d0_move_order+9),
              (team_set_slot, ":team", reg0, mordr_charge),
          (try_end),
      (try_end),
    ]),

    # Trigger file: division_order_processing_one_second
    (1, 0, 0, [
      (eq, "$g_battle_result", 0),
      (call_script, "script_cf_division_data_available"),
    ],[
      (set_fixed_point_multiplier, 100),

      (call_script, "script_team_get_position_of_enemies", Enemy_Team_Pos, "$fplayer_team_no", grc_everyone),
      (assign, ":num_enemies", reg0),

      (try_begin),
        (gt, ":num_enemies", 0),
        (call_script, "script_process_player_division_positioning"),
      (try_end),

      # (try_begin),
      # (call_script, "script_cf_order_active_check", slot_team_d0_order_skirmish),
      # (call_script, "script_order_skirmish_skirmish"),
      # (try_end),

      (val_add, "$last_player_trigger", 500),
    ]),

    (ti_tab_pressed, 0, 0, [
      (this_or_next|main_hero_fallen),
      (eq, "$g_battle_won", 1),
    ],[
      (assign, "$g_division_order_processing", 0),
    ]),

    (ti_question_answered, 0, 0, [
      (store_trigger_param_1, ":answer"),
      (eq, ":answer", 0),
    ],[
      (assign, "$g_division_order_processing", 0),
    ]),
]#end division order processing

#These triggers allow player to set up troops before a battle
real_deployment = [ #3 triggers
  # Trigger file: real_deployment_after_mission_start
  (ti_after_mission_start, 0, 0, [
      (this_or_next|eq, "$g_is_quick_battle", 1),
      (neq, "$player_deploy_troops", 0),
      ],[
      # (call_script, "script_init_overhead_camera"),
      (assign, "$battle_phase", BP_Init),
      (assign, "$player_deploy_troops", 0),
  ]),

  # Trigger file: real_deployment_init
  (0, 0, ti_once, [
      (eq, "$battle_phase", BP_Init),
      (call_script, "script_cf_division_data_available"),
      # (eq, "$g_division_order_processing", 1),	#division_order_processing inits are done
      ],[
      # (assign, "$g_battle_command_presentation", bcp_state_order_groups),
      # (rebuild_shadow_map),
      (try_begin),
        (eq, "$g_division_order_processing", 1),	#division_order_processing inits are done
        (gt, "$fplayer_team_no", -1),

        #place divisions
        (set_fixed_point_multiplier, 100),
        (call_script, "script_division_reset_places"),
        (call_script, "script_field_start_position", "$fplayer_team_no"),	#returns pos2
        (copy_position, Target_Pos, pos2),

        (try_for_range_backwards, ":division", 0, 9),
          (store_add, ":slot", slot_team_d0_size, ":division"),
          (team_slot_ge, "$fplayer_team_no", ":slot", 1),	#division exists
          (store_add, ":slot", slot_faction_d0_mem_relative_x_flag, ":division"),
          (faction_get_slot, ":formation_is_memorized", "fac_player_faction", ":slot"),
          (store_add, ":slot", slot_team_d0_formation_space, ":division"),
          (team_get_slot, ":current_spacing", "$fplayer_team_no", ":slot"),

          (try_begin),
            (neq, ":formation_is_memorized", 0),
            (store_add, ":slot", slot_faction_d0_mem_formation, ":division"),
            (faction_get_slot, ":formation", "fac_player_faction", ":slot"),
            (store_add, ":slot", slot_team_d0_formation, ":division"),
            (team_set_slot, "$fplayer_team_no", ":slot", ":formation"),	#do this here to prevent script_player_attempt_formation from resetting spacing

            (store_add, ":slot", slot_faction_d0_mem_formation_space, ":division"),
            (faction_get_slot, ":memorized_spacing", "fac_player_faction", ":slot"),

            #bring unformed divisions into sync with formations' minimum
            (set_show_messages, 0),
            (try_begin),
              (ge, ":memorized_spacing", ":current_spacing"),
              (try_for_range, reg0, ":current_spacing", ":memorized_spacing"),
                (team_give_order, "$fplayer_team_no", ":division", mordr_spread_out),
              (try_end),
            (else_try),
              (try_for_range, reg0, ":memorized_spacing", ":current_spacing"),
                (team_give_order, "$fplayer_team_no", ":division", mordr_stand_closer),
              (try_end),
            (try_end),
            (set_show_messages, 1),
            (store_add, ":slot", slot_team_d0_formation_space, ":division"),
            (team_set_slot, "$fplayer_team_no", ":slot", ":memorized_spacing"),

            (try_begin),
              (gt, ":formation", formation_none),
              (assign, reg1, ":division"),
              (str_store_class_name, s2, reg1),
              (val_add, reg1, 1),
              (display_message, "@Division {reg1} {s2} goes to its memorized position..."),
              (call_script, "script_player_attempt_formation", ":division", ":formation", 0),
            (else_try),
              (call_script, "script_formation_to_native_order", "$fplayer_team_no", ":division", ":formation"),
              (call_script, "script_battlegroup_place_around_leader", "$fplayer_team_no", ":division", "$fplayer_agent_no"),

              (eq, Native_Formations_Implementation, WB_Implementation),
              (assign, reg0, ":memorized_spacing"),
              (assign, reg1, ":division"),
              (str_store_class_name, s2, reg1),
              (val_add, reg1, 1),
              (try_begin),
                (ge, reg0, 0),
                (display_message, "@Division {reg1} {s2} forms line (memorized)."),
              (else_try),
                (val_mul, reg0, -1),
                (val_add, reg0, 1),
                (display_message, "@Division {reg1} {s2} forms {reg0} lines (memorized)."),
              (try_end),
            (try_end),

          (else_try),
            (team_set_order_listener, "$fplayer_team_no", ":division"),	#pick one division to listen; otherwise player agent gets moved as if part of infantry
            (store_add, ":slot", slot_team_d0_type, ":division"),

            (eq, "$form_ai_off", 0),
            (team_slot_eq, "$fplayer_team_no", ":slot", sdt_cavalry),
            (call_script, "script_player_attempt_formation", ":division", formation_wedge, 2),

          (else_try),
            (eq, "$form_ai_off", 0),
            (neg|team_slot_eq, "$fplayer_team_no", ":slot", sdt_archer),
            (neg|team_slot_eq, "$fplayer_team_no", ":slot", sdt_harcher),
            (call_script, "script_get_default_formation", "$fplayer_team_no"),	#defined only for infantry
            (assign, ":formation", reg0),
            (gt, ":formation", formation_none),
            (call_script, "script_player_attempt_formation", ":division", ":formation", 2),

            #Native defaults
          (else_try),
            (call_script, "script_pick_native_formation", "$fplayer_team_no", ":division"),
            (assign, ":formation", reg0),
            (assign, ":ranks", reg1),
            (store_add, ":slot", slot_team_d0_formation, ":division"),
            (team_set_slot, "$fplayer_team_no", ":slot", ":formation"),
            (store_add, ":slot", slot_team_d0_formation_num_ranks, ":division"),
            (team_set_slot, "$fplayer_team_no", ":slot", ":ranks"),
            (copy_position, pos1, Target_Pos),
            (call_script, "script_battlegroup_place_around_pos1", "$fplayer_team_no", ":division", "$fplayer_agent_no"),
            (call_script, "script_formation_to_native_order", "$fplayer_team_no", ":division", ":formation"),	#also forces reset for agent_get_position_in_group

            # (eq, Native_Formations_Implementation, WB_Implementation),	info overload?
            # (assign, reg0, ":current_spacing"),
            # (assign, reg1, ":division"),
            # (str_store_class_name, s2, reg1),
            # (val_add, reg1, 1),
            # (try_begin),
            # (ge, reg0, 0),
            # (display_message, "@Division {reg1} {s2} forms line."),
            # (else_try),
            # (val_mul, reg0, -1),
            # (val_add, reg0, 1),
            # (display_message, "@Division {reg1} {s2} forms {reg0} lines."),
            # (try_end),
          (try_end),
        (try_end),	#division loop

        # #Tactics-Based number of orders and placement limit
        # (try_begin),
        # (eq, "$g_is_quick_battle", 1),
        # (assign, ":num_orders", 3),
        # (else_try),
        # (party_get_skill_level, reg0, "p_main_party", "skl_tactics"),
        # (assign, ":num_orders", reg0),
        # (try_end),
        # # (team_set_slot, 6, slot_team_mv_temp_placement_counter, ":num_orders"),	DEPRECATED

        # (store_add, ":times_ten_meters", ":num_orders", 2),	#this makes base placement radius 20m
        # (store_mul, "$division_placement_limit", ":times_ten_meters", 1000),
        # (call_script, "script_team_get_position_of_enemies", pos1, "$fplayer_team_no", grc_everyone),
        # (call_script, "script_battlegroup_get_position", pos2, "$fplayer_team_no", grc_everyone),
        # (get_distance_between_positions, reg0, pos1, pos2),
        # (val_div, reg0, 3),
        # (val_min, "$division_placement_limit", reg0),	#place no closer than 1/3 the distance between

        # #make placement border
        # (store_mul, ":num_dashes", 2, "$division_placement_limit"),
        # (val_mul, ":num_dashes", 314, "$division_placement_limit"),
        # (val_div, ":num_dashes", 100*400),	#number of 4-meters in circumference
        # (store_div, ":hundredths_degree", 36000, ":num_dashes"),
        # (agent_get_position, pos1, "$fplayer_agent_no"),
        # (try_for_range, reg1, 0, ":num_dashes"),
        # (position_rotate_z_floating, pos1, ":hundredths_degree"),
        # (copy_position, pos0, pos1),
        # (position_move_y, pos0, "$division_placement_limit"),
        # (position_move_x, pos0, -100),	#center the 200cm dash to avoid sawtooth effect
        # (position_set_z_to_ground_level, pos0),
        # (position_move_z, pos0, 50),
        # (set_spawn_position, pos0),
        # (spawn_scene_prop, "spr_deployment_boundary"),
        # (prop_instance_set_scale, reg0, 2000, 10000, 1),	#going for 2 meter dash
        # (try_end),
      (try_end),	#valid player team
      # ]),

      # # Trigger file: real_deployment_stop_time
      # (0, 0, ti_once, [
      # (eq, "$g_battle_command_presentation", bcp_state_order_groups),	#wait til the above trigger fires
      # ],[
      (assign, "$battle_phase", BP_Deploy),
      # (set_fixed_point_multiplier, 1000),
      # (party_get_slot, reg0, "p_main_party", slot_party_pref_rdep_time_scale),
      # (try_begin),
      # (eq, reg0, 1),
      # (mission_set_time_speed, 5),
      # (else_try),
      # (eq, reg0, 2),
      # (mission_set_time_speed, 10),
      # (else_try),
      # (mission_set_time_speed, 1),
      # (try_end),
  ]),

  # # Trigger file: real_deployment_process_divisions
  # (0, 0, 0, [
  # (eq, "$battle_phase", BP_Deploy),
  # # (team_slot_ge, 6, slot_team_mv_temp_placement_counter, 1), ## Error Check to be sure placements remain
  # ],[
  # (set_fixed_point_multiplier, 100),
  # (try_begin),
  # (eq, "$BCP_mouse_state", HOT_F1_held),
  # (prop_instance_get_position, pos1, "$g_objects_selector"),
  # (set_show_messages, 0),
  # (try_for_range, ":division", 0, 9),
  # (store_add, ":slot", slot_team_d0_size, ":division"),
  # (team_slot_ge, "$fplayer_team_no", ":slot", 1),	#division exists
  # (class_is_listening_order, "$fplayer_team_no", ":division"),
  # (team_set_order_position, "$fplayer_team_no", ":division", pos1),
  # (try_end),
  # (call_script, "script_process_place_divisions"),
  # (set_show_messages, 1),
  # (try_end),
  # (call_script, "script_process_player_division_positioning"),
  # (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no")
  # ]),

  # Trigger file: real_deployment_end
  (0, 0, ti_once, [
      (eq, "$battle_phase", BP_Deploy),
      # (this_or_next|eq, "$g_battle_command_presentation", bcp_state_off),
      # (neg|team_slot_ge, 6, slot_team_mv_temp_placement_counter, 1),
      ],[
      (assign, "$battle_phase", BP_Setup),
      # (set_fixed_point_multiplier, 10),
      # (mission_set_time_speed, 10),
      # (assign, "$g_battle_command_presentation", bcp_state_off),
      # (try_begin),
      # (is_presentation_active, "prsnt_battle_command"),
      # (presentation_set_duration, 0),
      # (try_end),
      # (assign, "$BCP_pointer_available", 0),
      # # (scene_prop_set_visibility, "$g_objects_selector", 0),
      (get_player_agent_no, ":agent"),
      (gt, ":agent", -1),
      (agent_get_team, reg0, ":agent"),
      # (team_set_order_listener, reg0, -1),
      (team_set_order_listener, reg0, grc_everyone),
      # (try_for_prop_instances, ":prop_instance", "spr_deployment_boundary"),
      # (scene_prop_fade_out, ":prop_instance", 2),
      # (try_end),
      # (assign, "$g_custom_camera_regime", normal_camera),
      # (mission_cam_set_mode, 0, 1000, 1)
  ]),

  # # Trigger file: real_deployment_rebuild_shadows
  # (0, 2, ti_once, [
  # (ge, "$battle_phase", BP_Setup),
  # ],[
  # (try_for_prop_instances, ":prop_instance", "spr_deployment_boundary"),
  # (scene_prop_set_visibility, ":prop_instance", 0),
  # (try_end),
  # (rebuild_shadow_map),
  # ]),
]

formations_triggers = [ #4 triggers
  # Trigger file: formations_before_mission_start
  (ti_before_mission_start, 0, 0, [],[
      (try_for_range, ":team", 0, 4),
        (try_for_range, ":division", 0, 9),
          (store_add, ":slot", slot_team_d0_speed_limit, ":division"),
          (team_set_slot, ":team", ":slot", 10),
          (store_add, ":slot", slot_team_d0_fclock, ":division"),
          (team_set_slot, ":team", ":slot", 1),
        (try_end),
      (try_end),

      (call_script, "script_init_noswing_weapons"),
  ]),

  #kludge formation superiority
  (ti_on_agent_hit, 0, 0, [
      (store_trigger_param, ":missile", 5),
      (le, ":missile", 0),
      (store_trigger_param, ":inflicted_agent_id", 1),
      (agent_is_active,":inflicted_agent_id"),
      (agent_is_human, ":inflicted_agent_id"),
      (agent_is_alive, ":inflicted_agent_id"),
    ],[
      (store_trigger_param, ":inflicted_agent_id", 1),
      (store_trigger_param, ":dealer_agent_id", 2),
      (store_trigger_param, ":inflicted_damage", 3),

      (try_begin),
        (neq, ":inflicted_agent_id", "$fplayer_agent_no"),
        (neq, ":dealer_agent_id", "$fplayer_agent_no"),

        (agent_get_team, ":inflicted_team", ":inflicted_agent_id"),
        (agent_get_division, ":inflicted_division", ":inflicted_agent_id"),
        (store_add, ":slot", slot_team_d0_formation, ":inflicted_division"),
        (team_get_slot, ":inflicted_formation", ":inflicted_team", ":slot"),

        (agent_get_team, ":dealer_team", ":dealer_agent_id"),
        (agent_get_division, ":dealer_division", ":dealer_agent_id"),
        (store_add, ":slot", slot_team_d0_formation, ":dealer_division"),
        (team_get_slot, ":dealer_formation", ":dealer_team", ":slot"),

        (try_begin),
          (eq, ":inflicted_formation", 0),
          (neq, ":dealer_formation", 0),

          (store_add, ":slot", slot_team_d0_percent_in_place, ":dealer_division"),
          (team_slot_ge, ":dealer_team", ":slot", 80),

          (store_add, ":slot", slot_team_d0_formation_space, ":dealer_division"),
          (team_get_slot, ":spacing", ":dealer_team", ":slot"),

          (try_begin),
            (eq, ":spacing", 0),
            (val_mul, ":inflicted_damage", 6),
          (else_try),
            (eq, ":spacing", 1),
            (val_mul, ":inflicted_damage", 5),
          (else_try),
            (val_mul, ":inflicted_damage", 4),
          (try_end),
          (val_div, ":inflicted_damage", 2),

        (else_try),
          (neq, ":inflicted_formation", 0),
          (eq, ":dealer_formation", 0),

          (store_add, ":slot", slot_team_d0_percent_in_place, ":inflicted_division"),
          (team_slot_ge, ":inflicted_team", ":slot", 80),

          (store_add, ":slot", slot_team_d0_formation_space, ":inflicted_division"),
          (team_get_slot, ":spacing", ":inflicted_team", ":slot"),

          (val_mul, ":inflicted_damage", 2),
          (try_begin),
            (eq, ":spacing", 0),
            (val_div, ":inflicted_damage", 6),
          (else_try),
            (eq, ":spacing", 1),
            (val_div, ":inflicted_damage", 5),
          (else_try),
            (val_div, ":inflicted_damage", 4),
          (try_end),

          (val_max, ":inflicted_damage", 1),
        (try_end),
      (try_end),

      (set_trigger_result, ":inflicted_damage"),
  ]),

  # Trigger file: formations_victory_trigger
  (2, 0, ti_once, [
      (eq, "$g_battle_won", 1),
      ],[
      (try_for_range, ":division", 0, 9),
        (store_add, ":slot", slot_team_d0_size, ":division"),
        (team_slot_ge, "$fplayer_team_no", ":slot", 1),
        (call_script, "script_formation_end", "$fplayer_team_no", ":division"),
      (try_end),
  ]),

  # Trigger file: formations_on_agent_killed_or_wounded
  (ti_on_agent_killed_or_wounded, 0, 0, [],[	#prevent leaving noswing weapons around for player to pick up
      (store_trigger_param_1, ":dead_agent_no"),
      (gt, ":dead_agent_no", -1),
      (call_script, "script_switch_from_noswing_weapons", ":dead_agent_no"),
  ]),
]#end formations triggers


#jacobhinds Morale Code BEGIN
#routing soldiers recover morale by 30 every 3 seconds.
jacobhinds_morale_recover = (
	6, 0, 0, [
    (eq, "$moral_recovery", 1),
    (neq, "$g_battle_won", 1)
  ],[
		(try_for_agents, ":agent"),
      (agent_is_active, ":agent"),
			(agent_is_alive, ":agent"),
			(agent_is_human, ":agent"),
			(gt, ":agent", 1),
			(agent_slot_eq, ":agent", slot_agent_is_running_away, 1),
      (neg|agent_slot_eq, ":agent", slot_agent_recently_decided, 1),
			#Morale recovery based on number of ready troops on the battlefield, routing or not (prevents rush morale shock exploit)
			(assign, ":strength", 0),
			(try_begin),
				(agent_is_ally, ":agent"),
				(store_add, ":strength", "$j_num_us_ready", "$j_num_allies_ready"),
			(else_try),
				(assign, ":strength", "$j_num_enemies_ready"),
			(try_end),
      (val_add, ":strength", 5),
			(call_script, "script_change_agent_courage", ":agent", ":strength", 0),
		(try_end),
])

jacobhinds_ranged_melee_morale_penalty = (
#ranged units get morale penalties for being in melee, eventually routing
#for now defined by guarantee_ranged
	3, 0, 0, [
    (neq,"$player_ambushed",3),
    (neq,"$player_ambushed",4),
    (eq, "$ranged_penality", 1),
  ],[
		(try_for_agents, ":agent_no"),
			(agent_is_active, ":agent_no"),
			(agent_is_human, ":agent_no"),
			(agent_is_alive, ":agent_no"),
			(agent_get_troop_id, ":troop_id", ":agent_no"),
			(troop_is_guarantee_ranged, ":troop_id"),

			#put your exemptions here (e.g. javelinmen, heavy archers, peltast-types, grenadiers, heavy infantry --  i.e. any unit which is guarantee_ranged which you don't want to rout in melee)
			(neq, ":troop_id", "trp_germanic_skirmisher"),
			(neq, ":troop_id", "trp_germanic_skirmisher_exp"),
			(neq, ":troop_id", "trp_germanic_skirmisher_vet"),
			(neq, ":troop_id", "trp_kreta_archer"),
			(neq, ":troop_id", "trp_meroe_archers"),
			(neq, ":troop_id", "trp_celtic_skirmisher"),
			(neq, ":troop_id", "trp_celtic_skirmisher_exp"),
			(neq, ":troop_id", "trp_celtic_skirmisher_vet"),
			(neq, ":troop_id", "trp_dacian_skirmishers"),
			(neq, ":troop_id", "trp_dacian_skirmishers_exp"),
			(neq, ":troop_id", "trp_dacian_skirmishers_vet"),
			(neq, ":troop_id", "trp_sarmatian_archers"),
			(neq, ":troop_id", "trp_sarmatian_archers_exp"),
			(neq, ":troop_id", "trp_sarmatian_archers_vet"),
			(neq, ":troop_id", "trp_sarmatian_light_horsearcher"),
			(neq, ":troop_id", "trp_sarmatian_light_horsearcher_exp"),
			(neq, ":troop_id", "trp_sarmatian_light_horsearcher_vet"),
			(neq, ":troop_id", "trp_sarmatian_heavy_horsearcher"),
			(neq, ":troop_id", "trp_sarmatian_heavy_horsearcher_exp"),
			(neq, ":troop_id", "trp_sarmatian_heavy_horsearcher_vet"),
			(neq, ":troop_id", "trp_eastern_skrimisher"),
			(neq, ":troop_id", "trp_eastern_skrimisher_exp"),
			(neq, ":troop_id", "trp_eastern_skrimisher_vet"),
			(neq, ":troop_id", "trp_eastern_horsearcher"),
			(neq, ":troop_id", "trp_eastern_horsearcher_exp"),
			(neq, ":troop_id", "trp_eastern_horsearcher_vet"),
			(neq, ":troop_id", "trp_eastern_light_archer"),
			(neq, ":troop_id", "trp_eastern_light_archer_exp"),
			(neq, ":troop_id", "trp_eastern_light_archer_vet"),
			(neq, ":troop_id", "trp_mountain_bandit"),
			(neq, ":troop_id", "trp_forest_bandit"),
			(neq, ":troop_id", "trp_steppe_bandit"),
			(neq, ":troop_id", "trp_black_sea_priate"),
      (neq, ":troop_id", "trp_sea_raider"),
			(neq, ":troop_id", "trp_taiga_bandit"),
			(neq, ":troop_id", "trp_custom_sagitarius"),
			(neq, ":troop_id", "trp_desert_bandit"),
			(neq, ":troop_id", "trp_garamantien_noble_horseman"),
			(neq, ":troop_id", "trp_gaetuli_noble_horseman"),
			(neq, ":troop_id", "trp_gaetuli_horseman"),
			(neq, ":troop_id", "trp_sarranid_horseman"),
			(neq, ":troop_id", "trp_arab_noble_archers"),
			(neq, ":troop_id", "trp_irish_skirmisher"),
			(neq, ":troop_id", "trp_alan_horse_archer"),
			(neq, ":troop_id", "trp_alan_heavy_horse_archer"),

			(agent_get_simple_behavior, ":behaviour", ":agent_no"),
			(eq, ":behaviour", aisb_melee),
			(agent_ai_get_cached_enemy, ":enemy_agent", ":agent_no", 0),
			(agent_slot_eq, ":enemy_agent", slot_agent_is_running_away, 0),

			#closer ranks means less morale shock
			(agent_get_slot, ":rank_depth", ":agent_no", slot_agent_rank_closeness),
			(val_mul, ":rank_depth", 250),

			(store_sub, ":courage_change",  ":rank_depth", 1500),
			(call_script, "script_change_agent_courage", ":agent_no", ":courage_change", 0),
		(try_end),
	],)


jacobhinds_battle_ratio_init = (
#proportionalises battle ratio by adding ABS of ratio to both sides when they spawn
   0, 0, ti_once, [],[
    (call_script, "script_cf_calculate_battle_ratio"),
])

jacobhinds_battle_ratio_spawn_bonus = (
#proportionalises battle ratio by adding absolute value of ratio to both sides when they spawn
	ti_on_agent_spawn, 0.1, 0, [],[
		(store_trigger_param_1, ":agent"),
    (agent_is_active, ":agent"),
    (agent_is_human, ":agent"),
		(agent_get_slot, ":courage", ":agent", slot_agent_courage_score),
		(try_begin),
			(ge, "$battle_ratio", 0),
			(val_add, ":courage", "$battle_ratio"),
		(else_try),
      (val_sub, ":courage", "$battle_ratio"),
		(try_end),
    (val_min, ":courage", max_morale),
		(agent_set_slot, ":agent", slot_agent_courage_score, ":courage"),
])
jacobhinds_battle_ratio_calculate = (
  10, 0, 0, [],[
    (call_script, "script_cf_calculate_battle_ratio"),
 ])

moral_trigger_decide_to_run_or_not = 		(3, 0, 0, [
    (store_mission_timer_a,":mission_time"),
    (ge,":mission_time",4),
],[
    (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (ge, ":agent_no", 0),
        (try_begin),
            (agent_get_slot, ":timer_local", ":agent_no", slot_agent_recently_decided),#he recently decided
            (ge, ":timer_local", 2),
            (val_sub, ":timer_local", 1),
            (agent_set_slot, ":agent_no", slot_agent_recently_decided, ":timer_local"),#he recently decided
        (else_try),
            (call_script, "script_decide_run_away_or_not", ":agent_no"),
        (try_end),
    (try_end),
])

morale_triggers = [
(0, 0, 3,[
    (key_clicked, key_t),
    (assign, ":c", 0),
    (try_begin),
      (eq, "$enlisted_party", -1),
      (assign, ":c", 1),
    (else_try),
      (quest_slot_ge, "qst_freelancing", slot_quest_freelancer_rank, 3),
      (assign, ":c", 1),
    (try_end),
    (eq, ":c", 1),
],[
    (le, "$warcry_loading", 0),
    (get_player_agent_no, ":player"),
    (agent_is_alive, ":player"),
    (try_for_agents, ":cur_agent"),#effect
        (agent_is_human, ":cur_agent"),
        (agent_is_alive, ":cur_agent"),
        (agent_is_active,":cur_agent"),
        (agent_is_ally, ":cur_agent"),
        (neq, ":player", ":cur_agent"),
        (agent_set_damage_modifier, ":cur_agent", 105),
        (assign, "$warcry_loading", 30),
        (store_random_in_range, ":rand", 0, 100),
        (ge, ":rand", 50),
        (call_script,"script_agent_perform_warcry", ":cur_agent"),
    (try_end),
    (display_message, "str_war_cry",message_positive),
	  (call_script, "script_agent_perform_warcry", ":player"),
    (call_script, "script_change_courage_around_agent", 5, ":player"),
    (call_script, "script_change_courage_around_agent_for_routed_agents", 5, ":player"),
]),

(0, 0, 1,[
  (gt, "$warcry_loading", 0),
],[
  (val_sub, "$warcry_loading", 1),
]),

(ti_on_order_issued, 0, 0, [
    (store_trigger_param_1, ":order_no"),
    (store_trigger_param_2, ":order_agent"),

    (try_begin),
        (neg|agent_is_non_player, ":order_agent"),
        (this_or_next|eq, ":order_no", mordr_all_fire_now),
        (this_or_next|eq, ":order_no", mordr_left_fire_now),
        (this_or_next|eq, ":order_no", mordr_middle_fire_now),
        (this_or_next|eq, ":order_no", mordr_right_fire_now),
        (this_or_next|eq, ":order_no", mordr_fire_at_will),
        (eq, ":order_no", mordr_charge),
        (agent_set_animation, ":order_agent", "anim_order_charge", 1),
    (try_end),

    (try_for_agents, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_ally, ":agent_no"),
        (agent_get_troop_id, ":id", ":agent_no"),
        (try_begin),
            (this_or_next|eq, ":id", "trp_custom_cornicen"),
            (eq, ":id", "trp_cornicen"),
            (try_begin),
                (agent_has_item_equipped, ":agent_no", "itm_f_cornu"),
            (else_try),
                (agent_equip_item, ":agent_no", "itm_f_cornu"),
            (try_end),
            (agent_set_wielded_item, ":agent_no", "itm_f_cornu"),
            (agent_set_animation, ":agent_no", "anim_cornu_play", 1),
            (agent_play_sound, ":agent_no", "snd_cornu"),
        (try_end),
    (try_end),
	],[]),


  (ti_before_mission_start, 0, 0, [],[
    (gt, "$enlisted_party", -1),
    (quest_set_slot, "qst_freelancing", slot_quest_freelancer_agent_spawned, 0),
  ]),

  moral_trigger_decide_to_run_or_not,

  (ti_on_agent_spawn, 0, 0, [],[
    (store_trigger_param_1, ":agent_no"),
    (agent_get_troop_id, ":troop_id", ":agent_no"),
    (gt, ":troop_id", "trp_player"),#this should also exclude horses
    (store_faction_of_troop, ":faction", ":troop_id"),
    (faction_get_slot, ":culture", ":faction", slot_faction_culture),

    #properly set teams!!!
    (try_begin),
      (eq, "$enlisted_party", -1),
      (call_script, "script_agent_reassign_team", ":agent_no"),
    (else_try),
      (call_script, "script_agent_reassign_team_freelancer", ":agent_no"),
    (try_end),
    # (store_random_in_range, ":rand", 1, 101),
    # (try_begin),
      # # 1% chance COWARD/PANIC
      # (eq, ":rand", 1),
      # (agent_set_slot, ":agent_no", slot_agent_courage_score, 600), #very low Courage
      # # (try_begin),
        # # (ge, "$cheat_mode", 1),
        # # (agent_is_ally, ":agent_no"),
        # # (display_message, "@{!}TEST: There is a Coward in our lines!"),
      # # (try_end),
    # (else_try),
    ##idea is to make barabrians braver so that they dont lose that easily against civilized factions
    (try_begin),
      (eq, ":culture", "fac_culture_1"),
      (assign, ":initial_courage_score", 6500),
    (else_try),
      (eq, ":culture", "fac_culture_2"),
      (assign, ":initial_courage_score", 8000),
    (else_try),
      (eq, ":culture", "fac_culture_3"),
      (assign, ":initial_courage_score", 6500),
    (else_try),
      (eq, ":culture", "fac_culture_4"),
      (assign, ":initial_courage_score", 8500),
    (else_try),
      (this_or_next|eq, ":faction", "fac_mountain_bandits"),
      (eq, ":culture", "fac_culture_8"),##the jewish
      (assign, ":initial_courage_score", 7000),
    (else_try),
      (is_between, ":troop_id", bandits_begin, bandits_end),
      (assign, ":initial_courage_score", 3500),##bandits are cowards
    (else_try),
      (is_between, ":troop_id", mercenary_troops_begin, mercenary_troops_end),
      (assign, ":initial_courage_score", 4000),##mercs have low moral
    (else_try),
      (assign, ":initial_courage_score", 5000),
    (try_end),

    (try_begin), # defenders higher courage
      (eq, "$g_empieza_asedio", 1),
      (agent_get_team, ":team", ":agent_no"),
      (this_or_next|eq, ":team", 0),
      (eq, ":team", 2),
      (val_add, ":initial_courage_score", 2000),
    (try_end),


    (try_begin), #reinforcements recieve a moral boost
      (this_or_next|ge,"$defender_reinforcement_stage",1),
      (ge,"$attacker_reinforcement_stage",1),
      (val_add, ":initial_courage_score", 2500),
      #(display_message, "@Moral boost for reinforcements applied"),
    (try_end),

    (try_begin), # ambush effect
      (eq,"$player_ambushed",3),
      (agent_is_ally, ":agent_no"),
      (val_sub, ":initial_courage_score", 1000),
    (else_try),
      (eq,"$player_ambushed",3),
      (neg|agent_is_ally, ":agent_no"),
      (val_add, ":initial_courage_score", 3000),
    (try_end),

    (try_begin), # ambush effect
      (eq,"$player_ambushed",4),
      (agent_is_ally, ":agent_no"),
      (val_add, ":initial_courage_score", 3000),
    (else_try),
      (eq,"$player_ambushed",4),
      (neg|agent_is_ally, ":agent_no"),
      (val_sub, ":initial_courage_score", 1000),
    (try_end),

    (try_begin),
      (is_between, ":faction", minor_kingdoms_begin, minor_kingdoms_end),
      (val_add, ":initial_courage_score", 2000),
    (try_end),
    (try_begin), # berserkers no flee or it is quite difficult to flee.
      (this_or_next|eq,":troop_id","trp_germanic_berserker"), #berserker
      (eq,":troop_id","trp_dacian_noble_inf"), #berserker
      (val_add, ":initial_courage_score", 10000),
    (try_end),

    (try_begin),
      (troop_is_mounted, ":troop_id"),
      (val_add, ":initial_courage_score", 2000),
    (try_end),
  # (agent_get_troop_id, ":troop_id", ":agent_no"),
    (store_character_level, ":troop_level", ":troop_id"),
    (val_mul, ":troop_level", 200), #was 100
    #I want to make the difference to high level troops a bit bigger
    (val_add, ":initial_courage_score", ":troop_level"), #average : 25 * 100 = 2500

    (store_random_in_range, ":randomized_addition_courage", 0, 1000), #average : 1500
    (val_add, ":initial_courage_score", ":randomized_addition_courage"),

    (agent_get_party_id, ":agent_party", ":agent_no"),
    (assign, ":cur_morale", 100),
    (try_begin),
      (gt, ":agent_party", -1),
      # (party_is_active, ":agent_party"),
      (party_get_morale, ":cur_morale", ":agent_party"),
    (try_end),

    (store_sub, ":morale_effect_on_courage", ":cur_morale", 70),
    (val_mul, ":morale_effect_on_courage", 30), #this can effect morale with -2100..900
    (val_add, ":initial_courage_score", ":morale_effect_on_courage"),

    #average = 3000 + 2500 + 500 = 6000; min : 4800, max : 9000
    #morale effect = min : -2100(party morale is 0), average : 0(party morale is 70), max : 900(party morale is 100)
    #min starting : 2700, max starting  : 9900, average starting : 6000
    (val_max, ":initial_courage_score", 100),##at least they shall have 100
    (val_min, ":initial_courage_score", max_morale),
    (agent_set_slot, ":agent_no", slot_agent_courage_score, ":initial_courage_score"),
  ]),

  (ti_on_agent_killed_or_wounded, 0, 0, [],[
    (assign, ":ally_standing", 0),
    (assign, ":ally_fallen", 0),
    (assign, ":enemy_standing", 0),
    (assign, ":enemy_fallen", 0),

    (try_for_agents, ":agent"),
      (agent_is_human, ":agent"),#to avoid horses
      # BELONGS TO EFFECT 1:
      # count standing and fallen agents of both sides
      (try_begin),
        (agent_is_ally, ":agent"),
        (try_begin),
          (agent_is_alive, ":agent"),
          (val_add, ":ally_standing", 1),
        (else_try),
          (val_add, ":ally_fallen", 1),
        (try_end),
      (else_try),
        (try_begin),
          (agent_is_alive, ":agent"),
          (val_add, ":enemy_standing", 1),
        (else_try),
          (val_add, ":enemy_fallen", 1),
        (try_end),
      (try_end),
      (try_begin),
        (call_script, "script_cf_agent_can_rout", ":agent"),
        # Effect 2: high level troops and heros will encourage troops randomly every minute
        ##change: only heros
        (agent_is_alive, ":agent"),
        (agent_get_troop_id, ":troop_id", ":agent"),
        (neq, ":troop_id", "trp_player"),
          # COURAGE TROOPS
        (try_begin),
          (eq, "$more_lose_leader", 1),
          (troop_is_hero, ":troop_id"),##only heros encourage troops
          (store_random_in_range, reg30, 0, 101),
          (try_begin),
            (le, reg30, 10),
            (store_attribute_level, ":cha", ":troop_id", ca_charisma),
            (val_div, ":cha", 5),
            (store_skill_level, ":leadership","skl_leadership", ":troop_id"),
            (val_add, ":cha", ":leadership"),
            (val_div, ":cha", 2),
            (val_clamp, ":cha", 1, 16),
            (call_script, "script_change_courage_around_agent", ":cha", ":agent"),#was 1
            (call_script, "script_change_courage_around_agent_for_routed_agents", ":cha", ":agent"),
            #(str_store_troop_name, s40, ":troop_id"),
            #(display_message, "@{s40} encourages his troops!"),
          # (else_try),
          #   (ge, reg30, 80),
          #   (store_attribute_level, ":cha", ":troop_id", ca_charisma),
          #   (val_div, ":cha", 5),
          #   (store_skill_level, ":leadership","skl_leadership", ":troop_id"),
          #   (val_add, ":cha", ":leadership"),
          #   (val_clamp, ":cha", 1, 16),
          #   (call_script, "script_change_courage_around_agent_for_routed_agents", ":cha", ":agent"),
            #(str_store_troop_name, s40, ":troop_id"),
            #(display_message, "@{s40} encourages his troops!"),
          (try_end),
        (else_try),
          (is_between, ":troop_id", "trp_vexilarius_xxii", "trp_centurio_west"),##roman officers
          (store_random_in_range, reg30, 0, 100),
          (try_begin),
          #   (le, reg30, 8),
          #   (call_script, "script_change_courage_around_agent", 3, ":agent"),
          #   # (display_message, "@Aquila encourages troops.", color_good_news),
          # (else_try),
            (ge, reg30, 85),
            (call_script, "script_change_courage_around_agent_for_routed_agents", 2, ":agent"),
            # (display_message, "@Aquila encourages troops.", color_good_news),
          (try_end),
        (else_try),##roman aquilifer gives more bonus
          (is_between, ":troop_id", "trp_aquilifer_xxii", "trp_vexilarius_xxii"),
          (store_random_in_range, reg30, 0, 11),
          (try_begin),
            (ge, reg30, 3),
            (call_script, "script_change_courage_around_agent", 4, ":agent"),
          (try_end),
        (else_try),## non roman standard bearers and hornmen
          (is_between, ":troop_id", "trp_bosporan_standard_bearer", "trp_judean_light_clubman"),
          (store_random_in_range, reg30, 0, 101),
          (try_begin),
            (ge, reg30, 85),
            (call_script, "script_change_courage_around_agent", 2, ":agent"),
          (try_end),
        (try_end),
      (try_end),
    (try_end),

    (store_add, ":ally_total", ":ally_standing", ":ally_fallen"),
    (store_add, ":enemy_total", ":enemy_standing", ":enemy_fallen"),

    # EFFECT 2: DETECT FIRST BLOOD FOR EACH SIDE AND RESET VARIABLES:
    (try_begin),
      (eq, ":ally_fallen", 1),
      (eq, ":enemy_fallen", 0),
      (store_mission_timer_a, "$ally_first_blood"),
      (assign, "$ally_courage_pen_stage", 0),
    (else_try),
      (eq, ":ally_fallen", 0),
      (eq, ":enemy_fallen", 1),
      (store_mission_timer_a, "$enemy_first_blood"),
      (assign, "$enemy_courage_pen_stage", 0),
    (try_end),

    # EFFECT 2: DETECT IF MANY MAN DIED IN SHORT TIME
    (assign, ":ally_delta_courage", 0),
    (assign, ":enemy_delta_courage", 0),
    (store_trigger_param, ":inflicted_agent_id", 1),
    (try_begin),
      (agent_is_ally, ":inflicted_agent_id"),
      (ge, ":ally_total", 8),
      (try_begin),
        (eq, "$ally_courage_pen_stage", 0),
        (store_div, ":quarter_ally_total", ":ally_total", 4),
        (ge, ":ally_fallen", ":quarter_ally_total"),		#means 25% of the men are fallen
        (store_mission_timer_a, ":timer_1"),
        (val_sub, ":timer_1", "$ally_first_blood"),	#now the :timer represents the seconds since first ally was killed
        (val_sub, ":timer_1", 40),					#there will be only a courage penalty if 25% are killed in under 40 seconds
        (lt, ":timer_1", 0),
        (store_mul, ":ally_delta_courage", ":timer_1", "$moral_shock"),##Nero Claudius: was 30, 45 making moral hit stronger#If 25% killed in 30 sec, courage_pen = -300 (10 sec means -900)
        (store_div, ":enemy_delta_courage", ":ally_delta_courage", -3),#So other side gets a 33% bonus
        (assign, "$ally_courage_pen_stage", 1),
        #(play_sound, "snd_enemy_scored_a_point"),
        # (try_begin),
        #   (troop_slot_eq, "trp_player", slot_troop_culture, "fac_culture_7"),
        #   (play_sound, "snd_cornu"),
        # (else_try),
        #   (play_sound, "snd_horn"),
        # (try_end),
        (display_message, "@We lost a quarter of our troops in a very short time. The hearts of our troops are filled with fear.", color_terrible_news),
      (else_try),
        (eq, "$ally_courage_pen_stage", 1),
        (ge, ":ally_fallen", ":ally_standing"),		#means 50% of the men are fallen
        (store_mission_timer_a, ":timer_1"),
        (val_sub, ":timer_1", "$ally_first_blood"),	#now the :timer represents the seconds since first ally was killed
        (val_sub, ":timer_1", 80),					#there will be only a courage penalty if 50% are killed in under 80 seconds/ 1 minutes 20 sec
        (lt, ":timer_1", 0),
        (store_mul, ":ally_delta_courage", ":timer_1", "$moral_shock"),##Nero Claudius: was 30, 45 making moral hit stronger#If 50% killed in 60 sec, courage_pen = -600 (40 sec means -1200)
        (store_div, ":enemy_delta_courage", ":ally_delta_courage", -3),#So other side gets a 33% bonus
        (assign, "$ally_courage_pen_stage", 2),
        #(play_sound, "snd_enemy_scored_a_point"),
        # (try_begin),
        #   (troop_slot_eq, "trp_player", slot_troop_culture, "fac_culture_7"),
        #   (play_sound, "snd_cornu"),
        # (else_try),
        #   (play_sound, "snd_horn"),
        # (try_end),
        (display_message, "@Half of our army has fallen within a very short time. The troops panic!", color_terrible_news),
      (try_end),
    (else_try),
      (ge, ":enemy_total", 8),
      (try_begin),
        (eq, "$enemy_courage_pen_stage", 0),
        (store_div, ":quarter_enemy_total", ":enemy_total", 4),
        (ge, ":enemy_fallen", ":quarter_enemy_total"),						#means 25% of the men are fallen
        (store_mission_timer_a, ":timer_1"),
        (val_sub, ":timer_1", "$enemy_first_blood"),					#now the :timer represents the seconds since first enemy was killed
        (val_sub, ":timer_1", 40),										#there will be only a courage penalty if 25% are killed in under 40 seconds
        (lt, ":timer_1", 0),
        (store_mul, ":enemy_delta_courage", ":timer_1", "$moral_shock"),			#If 25% killed in 30 sec, courage_pen = -300 (10 sec means -900)
        (store_div, ":ally_delta_courage", ":enemy_delta_courage", -3),#So other side gets a 33% bonus
        (assign, "$enemy_courage_pen_stage", 1),
        #(play_sound, "snd_team_scored_a_point"),
        # (try_begin),
        #   (troop_slot_eq, "trp_player", slot_troop_culture, "fac_culture_7"),
        #   (play_sound, "snd_cornu"),
        # (else_try),
        #   (play_sound, "snd_horn"),
        # (try_end),
        (display_message, "@The enemy lost a quarter of his troops in a very short time. The hearts of his troops are filled with fear.", color_good_news),
      (else_try),
        (eq, "$enemy_courage_pen_stage", 1),
        (ge, ":enemy_fallen", ":enemy_standing"),		#means 50% of the men are fallen
        (store_mission_timer_a, ":timer_1"),
        (val_sub, ":timer_1", "$enemy_first_blood"),	#now the :timer represents the seconds since first enemy was killed
        (val_sub, ":timer_1", 80),					#there will be only a courage penalty if 50% are killed in under 80 seconds
        (lt, ":timer_1", 0),
        (store_mul, ":enemy_delta_courage", ":timer_1", "$moral_shock"),#If 50% killed in 60 sec, courage_pen = -600 (40 sec means -1200)
        (store_div, ":ally_delta_courage", ":enemy_delta_courage", -3),#So other side gets a 33% bonus
        (assign, "$enemy_courage_pen_stage", 2),
        #(play_sound, "snd_team_scored_a_point"),
        # (try_begin),
        #   (troop_slot_eq, "trp_player", slot_troop_culture, "fac_culture_7"),
        #   (play_sound, "snd_cornu"),
        # (else_try),
        #   (play_sound, "snd_horn"),
        # (try_end),
        (display_message, "@Half of the enemy army has fallen within a very short time. His troops panic.", color_good_news),
      (try_end),
    (try_end),

    (try_begin),
      # EFFECT 2: APPLY ALL DELTA COURRAGE
      (this_or_next|neq, ":ally_delta_courage", 0),
      (neq, ":enemy_delta_courage", 0),
      (try_for_agents, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_human, ":agent"),  #to avoid horses
        (try_begin),
          (agent_is_ally, ":agent"),
          (call_script, "script_change_agent_courage", ":agent", ":ally_delta_courage", 0),
        (else_try),
          (call_script, "script_change_agent_courage", ":agent", ":enemy_delta_courage", 0),
        (try_end),
      (try_end),
    (try_end),
  ]),

  (ti_on_agent_killed_or_wounded, 0, 0, [],[
    (store_trigger_param_1, ":dead_agent_no"),
    (store_trigger_param_2, ":killer_agent_no"),
    (store_trigger_param_3, ":is_wounded"),

    (try_begin),
      (ge, ":dead_agent_no", 0),
      (neg|agent_is_ally, ":dead_agent_no"),
      (agent_is_human, ":dead_agent_no"),
      (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),

      (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties

      (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),

      (try_begin),
        (call_script, "script_cf_force_wound_troop", ":dead_agent_troop_id"),
        (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
        (set_trigger_result, 2),
      (else_try),
        (neg|troop_is_hero, ":dead_agent_troop_id"),
        (eq, "$g_realistic_wounding", 1),
        (le, ":last_damage", 10),
        (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
        (set_trigger_result, 2),
      (else_try),
        (neg|troop_is_hero, ":dead_agent_troop_id"),
        (eq, "$g_realistic_wounding", 1),
        (ge, ":last_damage", 40),
        (set_trigger_result, 1),
      (else_try),
        (try_begin),
          (eq, ":is_wounded", 1),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
        (try_end),
        (set_trigger_result, 0),
      (try_end),
    (try_end),

    (try_begin),
      (ge, ":dead_agent_no", 0),
      (agent_is_ally, ":dead_agent_no"),
      (agent_is_human, ":dead_agent_no"),
      (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),

      (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),

      (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),

      (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),

      (party_get_skill_level, ":surgery", "p_main_party", skl_surgery),
      (store_mul, ":chance", ":surgery", 4),
      (val_add, ":chance", 25),
      (store_random_in_range, ":rand", 0, 100),

      (try_begin),
        (call_script, "script_cf_force_wound_troop", ":dead_agent_troop_id"),
        (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
        (set_trigger_result, 2),
      (else_try),
        (neg|troop_is_hero, ":dead_agent_troop_id"),
        (eq, "$g_realistic_wounding", 1),
        (le, ":last_damage", 10),
        (set_trigger_result, 2),
      (else_try),
        (neg|troop_is_hero, ":dead_agent_troop_id"),
        (eq, "$g_realistic_wounding", 1),
        (gt, ":rand", ":chance"),
        (ge, ":last_damage", 40),
        (set_trigger_result, 1),
      (else_try),
        (set_trigger_result, 0),
      (try_end),
    (try_end),

    (call_script, "script_apply_death_effect_on_courage_scores", ":dead_agent_no", ":killer_agent_no"),
  ]),

  (ti_on_agent_killed_or_wounded, 0, 0, [
    (eq, "$more_lose_leader", 1),
  ],[
    (store_trigger_param, ":inflicted_agent_id", 1),
    (gt, ":inflicted_agent_id", -1),
    (agent_is_human, ":inflicted_agent_id"),

    (agent_get_troop_id, ":agent_troop", ":inflicted_agent_id"),
    (troop_is_hero, ":agent_troop"),
    (agent_get_party_id, ":agent_party", ":inflicted_agent_id"),
    (neq, ":agent_party", -1),
    (party_stack_get_troop_id, ":party_leader_troop", ":agent_party", 0),
    (eq, ":agent_troop", ":party_leader_troop"),

    (assign, ":ally_delta_courage", 0),
    (assign, ":enemy_delta_courage", 0),
    (get_player_agent_no, ":player_agent"),
    (try_begin),
      (eq, "$enlisted_party", -1),##no freenlancer
      (eq, ":inflicted_agent_id", ":player_agent"),
      (display_message, "@You fall and your troops panic!", message_negative),
      (try_begin),
        (eq, "$g_is_emperor", 1),
        (assign, ":ally_delta_courage", -2000),
      (else_try),
        (assign, ":ally_delta_courage", -1000),
      (try_end),
      (assign, ":enemy_delta_courage", 600),
      #(call_script, "script_change_troop_renown", "trp_player", -5),
    (else_try),
      (neq, ":inflicted_agent_id", ":player_agent"),
      (agent_is_ally, ":inflicted_agent_id"),
      (display_message, "@Our side lost a leader. Our troops panic!", message_negative),
      (assign, ":ally_delta_courage", -1000),
      (assign, ":enemy_delta_courage", 600),
      # (call_script, "script_change_troop_renown", ":agent_troop", -5),
    (else_try),
      (neq, ":inflicted_agent_id", ":player_agent"),
      (assign, ":ally_delta_courage", 600),
      (try_begin),
        (is_between, ":agent_troop", kings_begin, kings_end),
        (assign, ":enemy_delta_courage", -2000),	#16.01.15
        (display_message, "@The enemy king has fallen. Their troops panic!", message_positive),
      (else_try),
        (assign, ":enemy_delta_courage", -1000),	#16.01.15
        (display_message, "@The enemy lost a leader. Their troops panic!", message_positive),
      (try_end),
    #  (call_script, "script_change_troop_renown", ":agent_troop", -5),
    (try_end),

    (try_begin),
      # APPLY ALL DELTA COURRAGE
      (neq, ":ally_delta_courage", 0),
      (neq, ":enemy_delta_courage", 0),
      (try_for_agents, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_human, ":agent"),
        # (str_store_agent_name, s1,":agent"),
        # (assign, reg1, ":agent_courage_score"),
        (try_begin),
          (agent_is_ally, ":agent"),
          (call_script, "script_change_agent_courage", ":agent", ":ally_delta_courage", 0),
          # (assign, reg2, ":ally_delta_courage"),
          # (assign, reg3, ":agent_courage_score"),
          # (display_message, "@{s1} {reg1} + {reg2} = {reg3}"),
        (else_try),
          (call_script, "script_change_agent_courage", ":agent", ":ally_delta_courage", 0),
          # (assign, reg2, ":enemy_delta_courage"),
          # (assign, reg3, ":agent_courage_score"),
          # (display_message, "@{s1} {reg1} + {reg2} = {reg3}"),
        (try_end),
      (try_end),

    (try_end),
  ]),

  (ti_on_agent_killed_or_wounded, 0, 0, [],[
    (store_trigger_param, ":inflicted_agent_id", 1),
    (gt, ":inflicted_agent_id", -1),
    (agent_is_human, ":inflicted_agent_id"),

	  (agent_get_troop_id, ":agent_troop", ":inflicted_agent_id"),
	  (is_between, ":agent_troop", "trp_aquilifer_xxii", "trp_vexilarius_xxii"),
    (assign, ":ally_delta_courage", 0),
    (assign, ":enemy_delta_courage", 0),
    (try_begin),
      (agent_is_ally, ":inflicted_agent_id"),
      (display_message, "@The Aquila has fallen. Our troops panic!", message_negative),
      (assign, ":ally_delta_courage", -1500),
      (assign, ":enemy_delta_courage", 500),
    (else_try),
      (display_message, "@The enemy Aquila has fallen.. Their troops panic!", message_positive),
      (play_sound, "snd_team_scored_a_point"),
      (assign, ":ally_delta_courage", 500),
      #(assign, ":enemy_delta_courage", -700),
      (assign, ":enemy_delta_courage", -1500),	#16.01.15
    (try_end),
    # (try_end),
    (try_begin),
      # APPLY ALL DELTA COURRAGE
      (neq, ":ally_delta_courage", 0),
      (neq, ":enemy_delta_courage", 0),
      (try_for_agents, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_human, ":agent"),
        (agent_get_slot, ":agent_courage_score", ":agent", slot_agent_courage_score),
        # (str_store_agent_name, s1,":agent"),
        # (assign, reg1, ":agent_courage_score"),
        (try_begin),
          (agent_is_ally, ":agent"),
          (val_add, ":agent_courage_score", ":ally_delta_courage"),
          # (assign, reg2, ":ally_delta_courage"),
          # (assign, reg3, ":agent_courage_score"),
          # (display_message, "@{s1} {reg1} + {reg2} = {reg3}"),
        (else_try),
          (val_add, ":agent_courage_score", ":enemy_delta_courage"),
          # (assign, reg2, ":enemy_delta_courage"),
          # (assign, reg3, ":agent_courage_score"),
          # (display_message, "@{s1} {reg1} + {reg2} = {reg3}"),
        (try_end),
        (val_max, ":agent_courage_score", 0), 				#not < 0
        (agent_set_slot, ":agent", slot_agent_courage_score, ":agent_courage_score"),
      (try_end),
    (try_end),
  ]),
]

add_horn_hornman = (ti_on_agent_spawn, 0, 0, [],[
    (store_trigger_param, ":agent_no", 1),
    (agent_get_troop_id, ":troop_id", ":agent_no"),
    (try_begin),
        (call_script, "script_cf_troop_is_hornman", ":troop_id"),
        (call_script, "script_get_horn_item", ":troop_id"),
        (assign, ":horn", reg0),
        (neg|agent_has_item_equipped, ":agent_no", ":horn"),
        (agent_get_item_slot,  ":item", ":agent_no", 3),
        (try_begin),
            (gt, ":item", 0),
            (agent_unequip_item, ":agent_no", ":item"),
        (try_end),
        (agent_equip_item, ":agent_no", ":horn"),
    (try_end),
])

ai_horn = [ #3 triggers
  add_horn_hornman,

  (3, 0, ti_once, [],[
    (try_for_agents, ":agent"),
      (agent_is_active, ":agent"),
      (agent_is_alive, ":agent"),
      (agent_is_human, ":agent"),
      (agent_get_troop_id, ":agent_troop", ":agent"),
      (call_script, "script_cf_troop_is_hornman", ":agent_troop"),
      (store_random_in_range, ":rand", 0, 2),
      (eq, ":rand", 1),
      (call_script, "script_agent_perform_horn", ":agent"),
    (try_end),
  ]),

  (ti_on_order_issued, 0, 0,[
    (store_trigger_param, ":order_no", 1),
    (assign, reg7, ":order_no"),
    (this_or_next|eq, ":order_no", mordr_stand_closer),
    (this_or_next|eq, ":order_no", mordr_spread_out),
    (this_or_next|eq, ":order_no", mordr_fall_back),
    (this_or_next|eq, ":order_no", mordr_stand_ground),
    (this_or_next|eq, ":order_no", mordr_hold),
    (this_or_next|eq, ":order_no", mordr_advance),
    (eq, ":order_no", mordr_charge),
  ],[
    (try_for_agents, ":agent"),
      (agent_is_active, ":agent"),
      (agent_is_alive, ":agent"),
      (agent_is_ally, ":agent"),
      (agent_is_human, ":agent"),
      (agent_get_troop_id, ":agent_troop", ":agent"),
      (call_script, "script_cf_troop_is_hornman", ":agent_troop"),
      # (store_random_in_range, ":rand", 0, 2),
      # (eq, ":rand", 1),
      (call_script, "script_agent_perform_horn", ":agent"),
    (try_end),
  ]),
]

immersive_troops = ( #inmersive troops gestos y sonidos
  5, 0, 0,[
    (store_mission_timer_a, ":cur_time"),
    (gt, ":cur_time", 1),#
    (lt, ":cur_time", 180),#No more specials after 180 seconds

    # (store_current_scene,":cur_scene"),
    # (neg|is_between, ":cur_scene", "scn_salt_mine", "scn_mp_addon_maps_end"), #only random scenes in lead_chargue

    (neg|conversation_screen_is_active),
    (neg|is_presentation_active, "prsnt_battle"),
    (neg|is_presentation_active, "prsnt_order_display"),
  ],[
    (try_for_agents, ":agent"),
      (agent_is_active,":agent"),
      (agent_is_human, ":agent"),
      (agent_is_alive, ":agent"),
      (agent_get_horse,":agent_mounted",":agent"),
      (eq,":agent_mounted",-1), #no mounted
      #  (agent_is_ally, ":agent"), #only allies.

      (agent_get_troop_id, ":troop_id", ":agent"),
      (neq,":troop_id","trp_player"),

      (neg|troop_is_hero, ":troop_id"),

      (try_begin),
         (call_script, "script_cf_dplmc_troop_is_female", ":troop_id"),
          ##        (get_player_agent_no, ":player_agent"),
          ##        (agent_get_team, ":agent_team_p", ":player_agent"),
          ##        (agent_get_team, ":agent_team", ":agent"),
          ##        (eq, ":agent_team_p", ":agent_team"),

      (else_try),
          (agent_get_animation, ":agent_anl", ":agent", 0),
          (agent_get_animation, ":agent_anu", ":agent", 1),

          ##        (agent_get_animation, reg0, ":agent", 0),
          ##        (agent_get_animation, reg1, ":agent", 1),
          ##        (str_store_troop_name,s5,":troop_id"),
          ##        (display_message, "@{s5} animation id: low body {reg0} , upper body {reg1}"),

          (agent_get_party_id, ":agent_party", ":agent"),
          (try_begin),
            (gt, ":agent_party", -1),
            (party_get_num_companions, ":num_men", ":agent_party"),
          (else_try),
            (assign, ":num_men", 41),
          (try_end),
          #   (agent_get_simple_behavior, ":agent_sb", ":agent"),
          (agent_get_combat_state, ":agent_cs", ":agent"),
          (try_begin),
            ##          (this_or_next|eq, ":agent_cs", 0),
            ##          (eq, ":agent_cs", 8),
            # (this_or_next|eq, ":agent_sb", aisb_hold),
            (le, ":agent_cs", 0),#scripted mode

            (store_random_in_range, ":rand", 0, 350),
            (try_begin),
              (le, ":rand", 4),
              (agent_play_sound, ":agent", "snd_inmersive_troops"),
            (else_try),
              (le, ":rand", 8),
              (ge, ":num_men", 40),
              (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
              (call_script,"script_agent_perform_shield_taunt", ":agent"),
              ##          (else_try),
              ##            (le, ":rand", 12),
              ##            (agent_play_sound, ":agent", "snd_inmersive_troops_exp"),
            (else_try),
              (le, ":rand", 10),
              (eq, ":agent_anl", 8),#
              (this_or_next|eq, ":agent_anu", 320),#
              (eq, ":agent_anu", -1),#
              (call_script,"script_agent_perform_warcry", ":agent"),
            (else_try),
              (le, ":rand", 23),
              (eq, ":agent_anl", 8),#v
              (this_or_next|eq, ":agent_anu", 320),#
              (eq, ":agent_anu", -1),#
              (call_script,"script_agent_perform_shield_taunt", ":agent"),
            (else_try),
              (le, ":rand", 25),
              (eq, ":agent_anl", 8),#
              (eq, ":agent_anu", -1),#
              (call_script, "script_agent_perform_horn", ":agent"),
            (else_try),
              (le, ":rand", 26),
              (agent_play_sound, ":agent", "snd_man_warcry"),
            (else_try),
            (try_end),
          (try_end),
        (try_end),
    (try_end),
])

agent_assign_rank_closeness = (ti_on_order_issued, 0, 0, [],[
  (store_trigger_param_1,":order"),
  (store_trigger_param_2,":agent"),
  (agent_is_active, ":agent"),
  (agent_is_alive, ":agent"),
  (agent_is_human, ":agent"),
	(agent_get_slot, ":closeness", ":agent", slot_agent_is_running_away),
	(try_begin),
		(eq, ":order", mordr_stand_closer),
		(val_add, ":closeness", 1),
	(else_try),
		(eq, ":order", mordr_spread_out),
		(val_sub, ":closeness", 1),
	(try_end),

	(val_clamp, ":closeness", -1, 3), #just an assumption based on observation; the loosest formation is only 1 below the defualt
	(agent_set_slot, ":agent", slot_agent_rank_closeness, ":closeness"),
])

jacobhinds_rout_check = (
   0, 0, 0, [
    (eq, "$debug_moral", 1),
    (key_is_down,key_k),
  ],[
    (try_for_agents, ":agent"),
        (agent_is_active, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_human, ":agent"),
        (agent_get_slot, ":courage", ":agent", slot_agent_courage_score),
        (agent_get_slot, ":routing", ":agent", slot_agent_is_running_away),
        (assign, reg0, ":courage"),
        (assign, reg1, "$battle_ratio"),
        (assign, reg2, ":routing"),
        (str_store_string, s1, "@{reg2?routing:steady}"),
        (agent_get_troop_id, ":troop", ":agent"),
        (str_store_troop_name, s0, ":troop"),
        (display_message, "@Fear = {reg0} {s0} ({s1})"),
    (try_end),
])

jacobhinds_morale_triggers = [
  jacobhinds_battle_ratio_init,
  jacobhinds_battle_ratio_spawn_bonus,
  jacobhinds_battle_ratio_calculate,
  jacobhinds_morale_recover,
  immersive_troops,
  jacobhinds_ranged_melee_morale_penalty,
  agent_assign_rank_closeness,
  jacobhinds_rout_check
]

#jacobhinds Morale Code END


##diplomacy begin

dedal_tavern_animations = (ti_after_mission_start, 0, 0,[
    (eq, "$can_spawn_commoners", 1),
	],[
    (try_for_agents,":agent"),
        (agent_is_human, ":agent"),#only humans
        (agent_is_alive, ":agent"),#no-dead
        (agent_get_troop_id,":troop",":agent"),
        (neg|agent_slot_ge, ":agent", slot_agent_is_blocked, 1),
        (try_begin), # block for taverns
            (eq, "$talk_context", tc_tavern_talk),
            (is_between,":troop",walkers_begin,walkers_end),
            (agent_get_entry_no, ":entry", ":agent"),
            (is_between, ":entry", 32, 41),
            (try_begin),
                (agent_has_item_equipped,":agent","itm_dedal_kufel"),
                (agent_set_stand_animation, ":agent", "anim_sitting_drinking_low"),
                (agent_set_animation, ":agent", "anim_sitting_drinking_low"),
                (store_random_in_range,":r",0,300),
            (else_try),
                (agent_set_stand_animation, ":agent", "anim_sitting_low"),
                (agent_set_animation, ":agent", "anim_sitting_low"),
                (store_random_in_range,":r",0,300),
            (try_end),
            (agent_set_animation_progress,":agent",":r"),
            (agent_set_slot, ":agent", slot_agent_is_blocked, 1),
        (else_try),
            (eq, ":troop", "trp_whore"),
            (agent_set_stand_animation, ":agent", "anim_vyrn_shieldmaiden_stand"),
            (agent_set_animation, ":agent", "anim_vyrn_shieldmaiden_stand"),
        (else_try),
            (is_between,":troop",tavern_minstrels_begin,tavern_minstrels_end),
            (store_item_kind_count, ":item_count", "itm_lyre", ":troop"),
            (assign, ":item_no", -1),
            (try_begin),
                (this_or_next|gt, ":item_count", 0),
                (troop_has_item_equipped, ":troop", "itm_lyre"),
                (assign, ":item_no", "itm_lyre"),
            (else_try),
                (store_item_kind_count, ":item_count", "itm_lute", ":troop"),
                (this_or_next|gt, ":item_count", 0),
                (troop_has_item_equipped, ":troop", "itm_lute"),
                (assign, ":item_no", "itm_lute"),
            (else_try),
                (store_item_kind_count, ":item_count", "itm_flute", ":troop"),
                (this_or_next|gt, ":item_count", 0),
                (troop_has_item_equipped, ":troop", "itm_flute"),
                (assign, ":item_no", "itm_flute"),
            (try_end),
            (try_begin),
                (neq, ":item_no", -1),
                (agent_equip_item, ":agent", ":item_no"), #equip instrument
                (agent_set_wielded_item, ":agent", -1), #doff it
            (try_end),
            (play_track,0,2),
            (try_begin),
                (agent_has_item_equipped,":agent","itm_lute"),
                (agent_set_stand_animation, ":agent", "anim_lute_standing"),
                (agent_set_animation, ":agent", "anim_lute_standing"),
                (agent_play_sound,":agent","snd_dedal_tavern_lute"),
            (else_try),
                (agent_has_item_equipped,":agent","itm_lyre"),
                (agent_set_stand_animation, ":agent", "anim_lyre_standing"),
                (agent_set_animation, ":agent", "anim_lyre_standing"),
                (agent_play_sound,":agent","snd_dedal_tavern_lyre"),
            (else_try),
                (agent_has_item_equipped,":agent","itm_flute"),
                (agent_set_stand_animation, ":agent", "anim_flute_player"),
                (agent_set_animation, ":agent", "anim_flute_player"),
                (agent_play_sound,":agent","snd_dedal_tavern_flute"),
            (try_end),
            (store_random_in_range,":r",0,300),
            (agent_set_animation_progress,":agent",":r"),
        (try_end),
    (try_end),
  ])

dplmc_horse_speed = (
  1, 0, 0, [(eq, "$g_dplmc_horse_speed", 0),],
  [
  (try_for_agents, ":agent_no"),
    (agent_is_alive, ":agent_no"),
    (agent_is_human, ":agent_no"),
    (agent_get_horse, ":horse_agent", ":agent_no"),
    (try_begin),
      (ge, ":horse_agent", 0),
      (store_agent_hit_points, ":horse_hp",":horse_agent"),
      (store_sub, ":lost_hp", 100, ":horse_hp"),
      (try_begin),
        (le, ":lost_hp", 15),
        (val_div, ":lost_hp", 2),
        (store_add, ":speed_factor", 100, ":lost_hp"),
      (else_try),
        (val_mul, ":lost_hp", 2),
        (val_div, ":lost_hp", 3),
        (store_sub, ":speed_factor", 115, ":lost_hp"),
      (try_end),
      (agent_get_troop_id, ":agent_troop", ":agent_no"),
      (store_skill_level, ":skl_level", "skl_riding", ":agent_troop"),
      (store_mul, ":speed_multi", ":skl_level", 2),
      (val_add, ":speed_multi", 100),
      (val_mul, ":speed_factor", ":speed_multi"),
      (val_div, ":speed_factor", 100),
      (agent_set_horse_speed_factor, ":agent_no", ":speed_factor"),
    (try_end),
  (try_end),
  ])

#alternate mouse camera
##BEAN BEGIN - Deathcam

common_move_deathcam = (0, 0, 0,[
    (neq, "$enable_deahtcam", 0),
    (eq, "$g_dplmc_cam_activated", camera_mouse),
    (this_or_next|game_key_is_down, gk_move_forward),
    (this_or_next|game_key_is_down, gk_move_backward),
    (this_or_next|game_key_is_down, gk_move_left),
    (this_or_next|game_key_is_down, gk_move_right),
    (this_or_next|key_is_down, "$g_cam_tilt_left"),
    (this_or_next|key_is_down, "$g_cam_tilt_right"),
    (this_or_next|key_is_down, "$g_camera_adjust_sub"),
    (this_or_next|key_is_down, "$g_camera_adjust_add"),
    (this_or_next|key_clicked, key_home),
    (game_key_is_down, gk_zoom),
  ],[
    (set_fixed_point_multiplier, 10000),
    (mission_cam_get_position, pos47),
    # (try_begin),
    # (key_clicked, key_home),
        # (position_set_x, pos47, "$deathcam_death_pos_x"),
        # (position_set_y, pos47, "$deathcam_death_pos_y"),
        # (position_set_z, pos47, "$deathcam_death_pos_z"),
    # (try_end),

    (assign, ":move_x", 0),
    (assign, ":move_y", 0),
    (assign, ":move_z", 0),

    (try_begin),
      (game_key_is_down, gk_move_forward),
      (val_add, ":move_y", 10),
    (else_try),
      (game_key_is_down, gk_move_backward),
      (val_add, ":move_y", -10),
    (try_end),

    (try_begin),
      (game_key_is_down, gk_move_right),
      (val_add, ":move_x", 10),
    (else_try),
      (game_key_is_down, gk_move_left),
      (val_add, ":move_x", -10),
    (try_end),

    (try_begin),
      (key_is_down, "$g_camera_adjust_add"),
      (val_add, ":move_z", 10),
    (else_try),
      (key_is_down, "$g_camera_adjust_sub"),
      (val_add, ":move_z", -10),
    (try_end),

    (try_begin),
      (game_key_is_down, gk_zoom),
      (val_mul, ":move_x", 4),
      (val_mul, ":move_y", 4),
      (val_mul, ":move_z", 2),
    (try_end),

    # (try_begin),
    # (key_is_down, key_end),
        # (try_begin),
        # (eq, "$deathcam_flip_y_multiplier", 1),
            # (assign, "$deathcam_flip_y_multiplier", -1),
            # (display_message, "@Y-Rotation Inverted"),
        # (else_try),
            # (assign, "$deathcam_flip_y_multiplier", 1),
            # (display_message, "@Y-Rotation Normal"),
        # (try_end),
    # (try_end),

    (position_move_x, pos47, ":move_x"),
    (position_move_y, pos47, ":move_y"),
    (position_move_z, pos47, ":move_z"),

    (mission_cam_set_position, pos47),

    (try_begin),
      (key_is_down, "$g_cam_tilt_left"),
      (ge, "$deathcam_sensitivity_x", 4), #Negative check.
      (ge, "$deathcam_sensitivity_y", 3),
      (val_sub, "$deathcam_sensitivity_x", 4),
      (val_sub, "$deathcam_sensitivity_y", 3),
      (store_mod, reg6, "$deathcam_sensitivity_x", 100), #25% increments
      (store_mod, reg7, "$deathcam_sensitivity_y", 75),
      (try_begin),
        (eq, reg6, 0),
        (eq, reg7, 0),
        (assign, reg8, "$deathcam_sensitivity_x"),
        (assign, reg9, "$deathcam_sensitivity_y"),
        (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
      (try_end),
    (else_try),
      (key_is_down, "$g_cam_tilt_right"),
      (val_add, "$deathcam_sensitivity_x", 4),
      (val_add, "$deathcam_sensitivity_y", 3),
      (store_mod, reg6, "$deathcam_sensitivity_x", 100), #25% increments
      (store_mod, reg7, "$deathcam_sensitivity_y", 75),
      (try_begin),
        (eq, reg6, 0),
        (eq, reg7, 0),
        (assign, reg8, "$deathcam_sensitivity_x"),
        (assign, reg9, "$deathcam_sensitivity_y"),
        (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
      (try_end),
    (try_end),
])

common_rotate_deathcam = (0, 0, 0,[
    (neq, "$enable_deahtcam", 0),
    (eq, "$g_dplmc_cam_activated", camera_mouse),
  ],[
    (set_fixed_point_multiplier, 10000), #Extra Precision

    (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"), #Opened (mouse must move)
        (this_or_next|key_clicked, key_escape), #Menu
        (this_or_next|key_clicked, key_q), #Notes, etc
        (key_clicked, key_tab), #Retreat
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
    (try_end),

    (assign, ":continue", 0),

    (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1), #Get and set mouse position
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),

        (mission_cam_get_position, pos47),

        (try_begin),
        (neq, "$deathcam_prsnt_was_active", 1),
            (try_begin), #Check not moved
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
                (val_add, "$deathcam_mouse_notmoved_counter", 1),
                (try_begin), #Notmoved for n cycles
                (ge, "$deathcam_mouse_notmoved_counter", 15),
                    (assign, "$deathcam_mouse_notmoved_counter", 0),
                    (assign, "$deathcam_mouse_notmoved_x", reg1),
                    (assign, "$deathcam_mouse_notmoved_y", reg2),
                (try_end),
            (else_try), #Has moved
                (assign, ":continue", 1),
                (assign, "$deathcam_mouse_notmoved_counter", 0),
            (try_end),
            (assign, "$deathcam_mouse_last_x", reg1), #Next cycle, this pos = last pos
            (assign, "$deathcam_mouse_last_y", reg2),
        (else_try), #prsnt was active
            (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"), #Is moving
            (neq, reg2, "$deathcam_mouse_last_y"),
                (store_sub, ":delta_x2", reg1, "$deathcam_mouse_last_notmoved_x"), #Store pos difference
                (store_sub, ":delta_y2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":delta_x2", -10, 11), #when engine recenters mouse, there is a small gap
            (is_between, ":delta_y2", -10, 11), #usually 5 pixels, but did 10 to be safe.
                (assign, "$deathcam_prsnt_was_active", 0),
                (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
                (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
            (else_try),
                (assign, "$deathcam_mouse_notmoved_x", reg1),
                (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
                (assign, "$deathcam_mouse_last_x", reg1), #Next cycle, this pos = last pos
                (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
    (try_end),

    (assign, ":delta_x", 0),
    (assign, ":delta_y", 0),
    (assign, ":rotating_horizontal", 0),
    (assign, ":rotating_vertical", 0),

    (try_begin),
      (key_is_down, "$g_camera_rot_left"),
      (try_begin),
        (ge, "$deathcam_keyboard_rotation_x", 0),
        (assign, "$deathcam_keyboard_rotation_x", -20),
      (try_end),
      (val_add, "$deathcam_keyboard_rotation_x", -1),
      (assign, ":continue", 2),
      (assign, ":rotating_horizontal", -1),
    (else_try),
      (key_is_down, "$g_camera_rot_right"),
      (try_begin),
        (le, "$deathcam_keyboard_rotation_x", 0),
        (assign, "$deathcam_keyboard_rotation_x", 20),
      (try_end),
      (val_add, "$deathcam_keyboard_rotation_x", 1),
      (assign, ":continue", 2),
      (assign, ":rotating_horizontal", 1),
    (else_try),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, ":rotating_horizontal", 0),
    (try_end),

    (try_begin),
      (key_is_down, "$g_camera_rot_up"),
      (try_begin),
        (le, "$deathcam_keyboard_rotation_y", 0),
        (assign, "$deathcam_keyboard_rotation_y", 15),
      (try_end),
      (val_add, "$deathcam_keyboard_rotation_y", 1),
      (assign, ":continue", 2),
      (assign, ":rotating_vertical", 1),
    (else_try),
      (key_is_down, "$g_camera_rot_down"),
      (try_begin),
        (ge, "$deathcam_keyboard_rotation_y", 0),
        (assign, "$deathcam_keyboard_rotation_y", -15),
      (try_end),
      (val_add, "$deathcam_keyboard_rotation_y", -1),
      (assign, ":continue", 2),
      (assign, ":rotating_vertical", -1),
    (else_try),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, ":rotating_vertical", 0),
    (try_end),

    (try_begin),
      (eq, ":continue", 1),
      (store_sub, ":delta_x", reg1, "$deathcam_mouse_notmoved_x"), #Store pos difference
      (store_sub, ":delta_y", reg2, "$deathcam_mouse_notmoved_y"),
    (else_try),
      (eq, ":continue", 2),
      (try_begin),
        (neq, ":rotating_horizontal", 0),
        (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
        (assign, ":delta_x", "$deathcam_keyboard_rotation_x"),
      (try_end),

      (try_begin),
        (neq, ":rotating_vertical", 0),
        (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
        (assign, ":delta_y", "$deathcam_keyboard_rotation_y"),
      (try_end),
    (try_end),

    (try_begin),
      (ge, ":continue", 1),
      (val_mul, ":delta_x", "$deathcam_sensitivity_x"),
      (val_mul, ":delta_y", "$deathcam_sensitivity_y"),
      # (val_mul, ":delta_y", "$deathcam_flip_y_multiplier"),

      (val_clamp, ":delta_x", -80000, 80001), #8
      (val_clamp, ":delta_y", -60000, 60001), #6

      (store_mul, ":neg_rotx", "$deathcam_total_rotx", -1),
      (position_rotate_x_floating, pos47, ":neg_rotx"), #Reset x axis to initial state

      (position_rotate_y, pos47, 90), #Barrel roll by 90 degrees to inverse x/z axis
      (position_rotate_x_floating, pos47, ":delta_x"), #Rotate simulated z axis, Horizontal
      (position_rotate_y, pos47, -90), #Reverse

      (position_rotate_x_floating, pos47, "$deathcam_total_rotx"), #Reverse

      (position_rotate_x_floating, pos47, ":delta_y"), #Vertical
      (val_add, "$deathcam_total_rotx", ":delta_y"), #Fix yaw
      (mission_cam_set_position, pos47),
    (try_end),
])
##BEAN END - Deathcam
#alternate follower camera
custom_commander_camera = (0, 0, 0, [
    (neq, "$enable_deahtcam", 0),
    (eq, "$g_dplmc_cam_activated", camera_follow),
    # (neg|main_hero_fallen),
  ],[
    (try_begin),
      (main_hero_fallen),
      (gt, "$dmod_current_agent", -1), #should be -1, but variable gets bugged
      # (agent_is_active, "$dmod_current_agent"),
      (assign, ":player_agent", "$dmod_current_agent"),
      (assign, ":duration", 500),
    (else_try),
      # (get_player_agent_no, ":player_agent"),
      (assign, ":player_agent", "$g_player_agent"),
      (assign, ":duration", 0),#instant
    (try_end),
    #compared to other deathcams these values are kept between missions
    (ge, ":player_agent", 0),
    (assign, ":continue", 0),
    (try_begin),
      (key_is_down, "$g_camera_adjust_add"),
      (val_add, "$g_camera_z", 5),
      (assign, ":continue", 1),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, "$g_camera_rotate_y", 5),
      (try_end),
    (else_try),
      (key_is_down, "$g_camera_adjust_sub"),
      (val_sub, "$g_camera_z", 5),
      (assign, ":continue", 1),
      (try_begin),
        (key_is_down, key_left_control),
        (val_sub, "$g_camera_rotate_y", 5),
      (try_end),
    (else_try),
      (key_is_down, "$g_camera_rot_up"),
      (val_add, "$g_camera_y", 5),
      (assign, ":continue", 1),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, "$g_camera_rotate_x", 5),
      (try_end),
    (else_try),
      (key_is_down, "$g_camera_rot_down"),
      (val_sub, "$g_camera_y", 5),
      (assign, ":continue", 1),
      (try_begin),
        (key_is_down, key_left_control),
        (val_sub, "$g_camera_rotate_x", 5),
      (try_end),
    (try_end),
    (try_begin),
      (key_is_down, key_left_control),
      (try_begin),
        (key_is_down, "$g_camera_rot_left"),
        (val_sub, "$g_camera_rotate_y", 5),
      (else_try),
        (key_is_down, "$g_camera_rot_right"),
        (val_add, "$g_camera_rotate_y", 5),
      (try_end),
    (try_end),
    (try_begin), #any key pressed, immediate update
      (eq, ":continue", 1),
      (assign, ":duration", 0),
      (mission_cam_set_mode, 1),
    (try_end),
    (agent_get_look_position, pos47, ":player_agent"),
    #moving around x when following is pointless
    (position_move_z, pos47, "$g_camera_z"),
    (position_move_y, pos47, "$g_camera_y"),
    (position_rotate_z, pos47, "$g_camera_rotate_z"),
    #rot x is the only one that makes sense, other rotations tilt too much
    (position_rotate_x, pos47, "$g_camera_rotate_x"),
    (position_rotate_y, pos47, "$g_camera_rotate_y"),
    (agent_get_horse, ":horse_agent", ":player_agent"),
    (try_begin),
      (ge, ":horse_agent", 0),
      (position_move_z, pos47, 90),
      (val_div, ":duration", 2),#mounted agents need to refresh faster
    (try_end),
    #prevent clipping underground
    (position_get_distance_to_ground_level, ":height", pos47),
    (try_begin), #centimeters?
      (le, ":height", 0),
      (position_set_z_to_ground_level, pos47),
      (position_move_z, pos47, 15), #keep around knee height?
    (try_end),
    (try_begin), #if we don't cancel during first person, head disappears
      (call_script, "script_cf_cancel_camera_keys"),
      (neg|main_hero_fallen),
    (else_try),
      (gt, ":duration", 0), #if 0, won't animate at all
      # (eq, "$dmod_move_camera", 1),
      (mission_cam_animate_to_position, pos47, ":duration", 0),
    (else_try), #this allows moving with the troop every frame
      (mission_cam_set_position, pos47),
    (try_end),
  ])

deathcam_cycle_forwards = (0, 0.5, 1,[
    (this_or_next|key_clicked, key_mouse_scroll_up),(key_clicked, "$g_cam_tilt_left"),
    (main_hero_fallen),(eq, "$g_dplmc_cam_activated", camera_follow),
    (neq, "$enable_deahtcam", 0),
],[
    (call_script, "script_dmod_cycle_forwards"),
])

deathcam_cycle_backwards = (0, 0.5, 1,[
    (this_or_next|key_clicked, key_mouse_scroll_down),(key_clicked, "$g_cam_tilt_right"),
    (main_hero_fallen),(eq, "$g_dplmc_cam_activated", camera_follow),
    (neq, "$enable_deahtcam", 0),
  ],[
    (call_script, "script_dmod_cycle_backwards"),
])

#default keyboard camera
dplmc_death_camera = (0, 0, 0,[
   (neq, "$enable_deahtcam", 0),
   (eq, "$g_dplmc_battle_continuation", 0),
   (eq, "$g_dplmc_cam_activated", camera_keyboard),
  ],[
    #(agent_get_look_position, pos47, ":player_agent"),

    # (get_player_agent_no, ":player_agent"),
    # (agent_get_team, ":player_team", ":player_agent"),

    (mission_cam_get_position, pos47),

    (assign, ":camera_rotate_x", 0),
    (assign, ":camera_rotate_y", 0),
    (assign, ":camera_rotate_z", 0),
    (assign, ":camera_x", 0),
    (assign, ":camera_y", 0),
    (assign, ":camera_z", 0),

    (try_begin),
      (game_key_is_down, gk_move_left),
      (val_sub, ":camera_x", 10),
    (else_try),
      (game_key_is_down, gk_move_right),
      (val_add, ":camera_x", 10),
    (try_end),
    (position_move_x, pos47, ":camera_x"),

    (try_begin),
      (game_key_is_down, gk_move_forward),
      (val_add, ":camera_y", 10),
    (else_try),
      (game_key_is_down, gk_move_backward),
      (val_sub, ":camera_y", 10),
    (try_end),
    (position_move_y, pos47, ":camera_y"),

    (try_begin),
      (key_is_down, "$g_camera_adjust_add"),
      (val_add, ":camera_z", 10),
    (else_try),
      (key_is_down, "$g_camera_adjust_sub"),
      (val_sub, ":camera_z", 10),
    (try_end),
    (position_move_z, pos47, ":camera_z"),

    (try_begin),
      (key_is_down, "$g_camera_rot_left"),
      (val_add, ":camera_rotate_z", 1),
    (else_try),
      (key_is_down, "$g_camera_rot_right"),
      (val_sub, ":camera_rotate_z", 1),
    (try_end),
    (position_rotate_z, pos47, ":camera_rotate_z"),

    (try_begin),
      (key_is_down, "$g_cam_tilt_left"),
      (val_add, ":camera_rotate_y", 1),
    (else_try),
      (key_is_down, "$g_cam_tilt_right"),
      (val_sub, ":camera_rotate_y", 1),
    (try_end),
    (position_rotate_y, pos47, ":camera_rotate_y"),

    (try_begin),
      (key_is_down, "$g_camera_rot_up"),
      (val_add, ":camera_rotate_x", 1),
    (else_try),
      (key_is_down, "$g_camera_rot_down"),
      (val_sub, ":camera_rotate_x", 1),
    (try_end),
    (position_rotate_x, pos47, ":camera_rotate_x"),

    (try_begin),
      (call_script, "script_cf_cancel_camera_keys"),
    (else_try),
      (mission_cam_set_mode, 1),
      (mission_cam_set_position, pos47),
    (try_end),
])

realistic_wounding = (ti_on_agent_hit, 0, 0, [],[
    (store_trigger_param, ":inflicted_agent_id", 1),
    (store_trigger_param, ":dealer_agent_id", 2),
    (store_trigger_param, ":inflicted_damage", 3),
    (store_trigger_param, ":hit_bone", 4),
    (store_trigger_param, ":missile_item", 5),

    (get_player_agent_no, ":player_no"),

    (try_begin),
      (eq, ":dealer_agent_id", ":player_no"),
      (val_mul, ":inflicted_damage", 2),
      (val_div, ":inflicted_damage", 3),
    (try_end),

    (try_begin),
      (eq, ":hit_bone", hb_head),
      (val_mul, ":inflicted_damage", 2),
    (try_end),

    (try_begin),
      (neq, ":dealer_agent_id", ":player_no"),
      (gt, ":missile_item", -1),
      (val_mul, ":inflicted_damage", 3),
      (val_div, ":inflicted_damage", 4),
    (try_end),

    (agent_set_slot, ":inflicted_agent_id", slot_agent_last_damage, ":inflicted_damage"),
])

miracle_arena_trigger = (3,0,ti_once,[],[
    (call_script, "script_cf_can_perform_miracle"),
    (store_random_in_range, ":miracle", miracle_battle_heal, miracle_battle_morale),
    (call_script, "script_perform_miracle", ":miracle"),
])

miracle_battle_trigger = (3,0,ti_once,[],[
    (call_script, "script_cf_can_perform_miracle"),
    (store_random_in_range, ":miracle", miracle_battle_heal, miracle_battle_morale + 1),
    (call_script, "script_perform_miracle", ":miracle"),
])

##SB : new camera triggers
dplmc_death_came_triggers = [
  common_move_deathcam,
  common_rotate_deathcam,
  custom_commander_camera,
  deathcam_cycle_forwards,
  deathcam_cycle_backwards,
  dplmc_death_camera
]
dplmc_battle_mode_triggers_no_deathcam = [
  # torches for night battles?
  # (ti_on_agent_spawn, 0.5, 0, [
  #   (is_currently_night),
  # ],[
  #   (store_random_in_range, ":rand", 0, 10),
  #   (ge, ":rand", 8),
  #   (store_trigger_param_1, ":agent_no"),
  #   (agent_is_active, ":agent_no"),
  #   (agent_is_alive, ":agent_no"),
  #   (agent_is_human, ":agent_no"),
  #   (agent_get_wielded_item, ":old_item" , ":agent_no", 1),
  #   (try_begin),
  #     (gt, ":old_item" , 0),
  #     (agent_unequip_item, ":agent_no", ":old_item"),
  #   (end_try),
  #   (agent_equip_item, ":agent_no", "itm_torch"),
  #   (agent_set_wielded_item, ":agent_no", "itm_torch"),
  # ]),

  voice_order_sounds,
  #VC-1729 call horse begins
  (0, 0, ti_once,[],[
    (assign, "$player_horse_agent_no", -1),
    (store_skill_level, ":skill", "skl_riding", "trp_player"),
    (ge, ":skill", 4),	#need riding skill 4 to call horse
    (get_player_agent_no, ":player_agent"),
    (gt, ":player_agent", -1),
    (agent_is_alive, ":player_agent"),
    (agent_get_horse, "$player_horse_agent_no", ":player_agent"),
    (gt, "$player_horse_agent_no", -1),
  ]),

  (0, 0, 0,[
    (key_clicked, key_h),
    (gt, "$player_horse_agent_no", -1),
    (neg|main_hero_fallen),
  ],[
    (try_begin),
      (neg|agent_is_alive, "$player_horse_agent_no"),
    (else_try),
      (display_message, "@You call your horse..."),
      (get_player_agent_no, ":player_agent"),
      (agent_get_rider, ":rider", "$player_horse_agent_no"),
      (neq, ":rider", ":player_agent"),
      (agent_get_position, pos1, ":player_agent"),
      (agent_set_scripted_destination, "$player_horse_agent_no", pos1),
    (try_end),
  ]),

  #Weapon, Armor and helm randomization
  (ti_on_agent_spawn, 0, 0, [],[
    (store_trigger_param_1, ":agent_no"),
    (agent_is_active, ":agent_no"),
    (agent_is_human, ":agent_no"),
    (agent_is_alive, ":agent_no"),
    (agent_is_non_player, ":agent_no"),
    (agent_get_troop_id, ":troop", ":agent_no"),
    (neg|troop_is_hero,":troop"),

    # #RANDOMIZE ARMOR
    # (try_begin),
        # (agent_slot_eq, ":agent_no", slot_agent_tournament_point, 0),
        # (agent_get_item_slot, ":cur_armor", ":agent_no", ek_body),
        # (gt, ":cur_armor", -1),
        # (troop_get_inventory_capacity, ":end_cond", ":troop"),
        # (assign, ":result", -1),
        # (assign, ":slot_no", 0),
        # (try_for_range, ":i_slot", 0, ":end_cond"),
            # (troop_get_inventory_slot, ":item_id", ":troop", ":i_slot"),
            # (gt,":item_id",0),
            # (item_get_type, ":item_type", ":item_id"),
            # (eq, ":item_type", itp_type_body_armor),
            # (troop_get_inventory_slot_modifier, ":item_imod", ":troop", ":i_slot"),
            # (troop_set_slot, "trp_temp_array_b", ":slot_no", ":item_id"),
            # (troop_set_slot, "trp_temp_array_a", ":slot_no", ":item_imod"),
            # (val_add, ":slot_no", 1),
        # (try_end),
        # (try_for_range, ":unused", 0, 2),
            # (call_script, "script_shuffle_troop_slots",  "trp_temp_array_b",0,":slot_no"),
        # (try_end),
        # (gt, ":slot_no", 0),
        # (store_mul, ":slot10", ":slot_no",10),
        # (try_for_range, ":unused", 0, 6),
            # (store_random_in_range, ":result", 0, ":slot10"),
        # (try_end),
        # (val_div, ":result", 10),
        # (try_begin),
            # (gt, ":slot_no", 6),
            # (store_div, ":half", ":slot_no", 2),
            # (eq, ":result", ":half"),
            # #			(display_log_message, "@Half!"),
            # (store_random_in_range, ":rand", -2,3),
            # (val_add, ":result", ":rand"),
        # (try_end),
        # (neq, ":result", -1),
        # (store_random_in_range, ":imod", 0, ":slot_no"),
        # (troop_get_slot, ":cur_slot", "trp_temp_array_b", ":result"),
        # (troop_get_slot, ":cur_imod", "trp_temp_array_a", ":imod"),
        # (neq, ":cur_slot", ":cur_armor"),
        # (try_begin),
            # (gt, ":cur_armor", -1),
            # (agent_unequip_item, ":agent_no",":cur_armor"),
        # (try_end),
        # (agent_equip_item, ":agent_no",":cur_slot",ek_body, ":cur_imod"),
    # (try_end),

    ##RANDOMIZE HELMS
    (try_begin),
        (agent_get_item_slot, ":cur_helm", ":agent_no", ek_head),
        (gt, ":cur_helm", -1),
        (troop_get_inventory_capacity, ":end_cond", ":troop"),
        (assign, ":result", -1),
        (assign, ":slot_no", 0),
        (try_for_range, ":i_slot", 0, ":end_cond"),
            (troop_get_inventory_slot, ":item_id", ":troop", ":i_slot"),
            (gt,":item_id",0),
            (item_get_type, ":item_type", ":item_id"),
            (eq, ":item_type", itp_type_head_armor),
            (troop_get_inventory_slot_modifier, ":item_imod", ":troop", ":i_slot"),
            (troop_set_slot, "trp_temp_array_b", ":slot_no", ":item_id"),
            (troop_set_slot, "trp_temp_array_a", ":slot_no", ":item_imod"),
            (val_add, ":slot_no", 1),
        (try_end),
        (try_for_range, ":unused", 0, 2),
            (call_script, "script_shuffle_troop_slots",  "trp_temp_array_b",0,":slot_no"),
        (try_end),
        (gt, ":slot_no", 0),
        (store_mul, ":slot10", ":slot_no",10),
        (try_for_range, ":unused", 0, 6),
            (store_random_in_range, ":result", 0, ":slot10"),
        (try_end),
        (val_div, ":result", 10),
        (try_begin),
            (gt, ":slot_no", 6),
            (store_div, ":half", ":slot_no", 2),
            (eq, ":result", ":half"),
            #			(display_log_message, "@Half!"),
            (store_random_in_range, ":rand", -2,3),
            (val_add, ":result", ":rand"),
        (try_end),
        (neq, ":result", -1),
        (store_random_in_range, ":imod", 0, ":slot_no"),
        (troop_get_slot, ":cur_slot", "trp_temp_array_b", ":result"),
        (troop_get_slot, ":cur_imod", "trp_temp_array_a", ":imod"),
        (neq, ":cur_slot", ":cur_helm"),
        (try_begin),
            (gt, ":cur_helm", -1),
            (agent_unequip_item, ":agent_no",":cur_helm"),
        (try_end),
        (agent_equip_item, ":agent_no",":cur_slot",ek_head, ":cur_imod"),

        # (str_store_item_name, s24, ":cur_helm"),
        # (str_store_item_name, s23, ":cur_slot"),
        # (assign, reg24, ":cur_helm"),
        # (assign, reg23, ":cur_slot"),
        # (assign, reg25, ":agent_no"),
        # (assign, reg26, ":result"),

        # (display_log_message, "@{!}{reg25} - Removed {s24}({reg24}), equipped {s23} ({reg23}), slot is {reg26}"),
    (try_end),

    (assign, ":number_of_onehanded_weapons", 0),
    (assign, ":number_of_twohanded_weapons", 0),

    #REMOVE DUPLOCATE WEAPONS
    (try_for_range, ":item_slot_number", ek_item_0, ek_head),
        (agent_get_item_slot, ":cur_item", ":agent_no", ":item_slot_number"),
        (troop_get_inventory_capacity, ":end_cond", ":troop"),

        (try_begin),
            (gt, ":cur_item", -1),#is valid
            (item_get_type, ":item_type", ":cur_item"),
            (try_begin),
                (eq, ":item_type", itp_type_one_handed_wpn),
                (val_add, ":number_of_onehanded_weapons", 1),
            (else_try),
                (eq, ":item_type", itp_type_two_handed_wpn),
                (val_add, ":number_of_twohanded_weapons", 1),
            (try_end),
            (try_begin),
                (eq, ":item_type", itp_type_one_handed_wpn),
                (gt, ":number_of_onehanded_weapons", 1),
                (agent_unequip_item, ":agent_no",":cur_item"),

                (try_begin),
                    (ge, "$cheat_mode", 1),
                    (str_store_troop_name, s25, ":troop"),
                    (str_store_item_name, s24, ":cur_item"),
                    (assign, reg23, ":item_slot_number"),
                    (assign, reg25, ":agent_no"),
                    (assign, reg26, ":result"),

                    (display_log_message, "@{!}{s25}{reg25} - Removed {s24} ({reg23})"),
                (try_end),
            (try_end),
            (try_begin),
                (eq, ":item_type", itp_type_two_handed_wpn),
                (gt, ":number_of_twohanded_weapons", 1),
                (agent_unequip_item, ":agent_no",":cur_item"),

                (try_begin),
                    (ge, "$cheat_mode", 1),
                    (str_store_troop_name, s25, ":troop"),
                    (str_store_item_name, s24, ":cur_item"),
                    (assign, reg23, ":item_slot_number"),
                    (assign, reg25, ":agent_no"),
                    (assign, reg26, ":result"),

                    (display_log_message, "@{!}{s25}{reg25} - Removed {s24} ({reg23})"),
                (try_end),
            (try_end),
        (else_try),#do nothing if he has a bow
            (call_script, "script_cf_has_bow", ":agent_no"),
        (else_try),#ADD bows for parthian elite infantry
            (this_or_next|eq, ":troop", "trp_eastern_elite_infantry"),
            (this_or_next|eq, ":troop", "trp_eastern_elite_infantry_exp"),
            (eq, ":troop", "trp_eastern_elite_infantry_vet"),
            (troop_get_inventory_capacity, ":end_cond", ":troop"),
            (assign, ":result", -1),
            (assign, ":slot_no", 0),
            (try_for_range, ":i_slot", 0, ":end_cond"),
                (troop_get_inventory_slot, ":item_id", ":troop", ":i_slot"),
                (gt,":item_id",0),
                (item_get_type, ":item_type", ":item_id"),
                (eq, ":item_type", itp_type_bow),
                (troop_get_inventory_slot_modifier, ":item_imod", ":troop", ":i_slot"),
                (troop_set_slot, "trp_temp_array_b", ":slot_no", ":item_id"),
                (troop_set_slot, "trp_temp_array_a", ":slot_no", ":item_imod"),
                (val_add, ":slot_no", 1),
            (try_end),
            (try_for_range, ":unused", 0, 2),
                (call_script, "script_shuffle_troop_slots",  "trp_temp_array_b",0,":slot_no"),
            (try_end),
            (gt, ":slot_no", 0),
            (store_mul, ":slot10", ":slot_no",10),
            (try_for_range, ":unused", 0, 6),
                (store_random_in_range, ":result", 0, ":slot10"),
            (try_end),
            (val_div, ":result", 10),
            (try_begin),
                (gt, ":slot_no", 6),
                (store_div, ":half", ":slot_no", 2),
                (eq, ":result", ":half"),
                #			(display_log_message, "@Half!"),
                (store_random_in_range, ":rand", -2,3),
                (val_add, ":result", ":rand"),
            (try_end),
            (neq, ":result", -1),
            (store_random_in_range, ":imod", 0, ":slot_no"),
            (troop_get_slot, ":cur_slot", "trp_temp_array_b", ":result"),
            (troop_get_slot, ":cur_imod", "trp_temp_array_a", ":imod"),
            (neq, ":cur_slot", ":cur_item"),
            (agent_equip_item, ":agent_no",":cur_slot",":item_slot_number", ":cur_imod"),
            (store_add, ":ammunition_slot", ":item_slot_number", 1),#add ammunition
            (agent_equip_item, ":agent_no","itm_barbed_arrows",":ammunition_slot"),
            (try_begin),
                (ge, "$cheat_mode", 1),
                (str_store_item_name, s23, ":cur_slot"),
                (assign, reg23, ":cur_slot"),
                (assign, reg25, ":agent_no"),
                (assign, reg26, ":result"),
                (str_store_troop_name, s25, ":troop"),
                (display_log_message, "@{!}{s25} ({reg25}) - equipped {s23} ({reg23}), slot is {reg26}"),
            (try_end),
        (else_try),#ADD MORE THROWING WEAPONS IF THE SLOT IS EMPTY
            (troop_get_inventory_capacity, ":end_cond", ":troop"),
            (assign, ":result", -1),
            (assign, ":slot_no", 0),
            (try_for_range, ":i_slot", 0, ":end_cond"),
                (troop_get_inventory_slot, ":item_id", ":troop", ":i_slot"),
                (gt,":item_id",0),
                (item_get_type, ":item_type", ":item_id"),
                (eq, ":item_type", itp_type_thrown),
                (troop_get_inventory_slot_modifier, ":item_imod", ":troop", ":i_slot"),
                (troop_set_slot, "trp_temp_array_b", ":slot_no", ":item_id"),
                (troop_set_slot, "trp_temp_array_a", ":slot_no", ":item_imod"),
                (val_add, ":slot_no", 1),
            (try_end),
            (try_for_range, ":unused", 0, 2),
                (call_script, "script_shuffle_troop_slots",  "trp_temp_array_b",0,":slot_no"),
            (try_end),
            (gt, ":slot_no", 0),
            (store_mul, ":slot10", ":slot_no",10),
            (try_for_range, ":unused", 0, 6),
                (store_random_in_range, ":result", 0, ":slot10"),
            (try_end),
            (val_div, ":result", 10),
            (try_begin),
                (gt, ":slot_no", 6),
                (store_div, ":half", ":slot_no", 2),
                (eq, ":result", ":half"),
                #			(display_log_message, "@Half!"),
                (store_random_in_range, ":rand", -2,3),
                (val_add, ":result", ":rand"),
            (try_end),
            (neq, ":result", -1),
            (store_random_in_range, ":imod", 0, ":slot_no"),
            (troop_get_slot, ":cur_slot", "trp_temp_array_b", ":result"),
            (troop_get_slot, ":cur_imod", "trp_temp_array_a", ":imod"),
            (neq, ":cur_slot", ":cur_item"),
            (agent_equip_item, ":agent_no",":cur_slot",":item_slot_number", ":cur_imod"),
            (try_begin),
                (ge, "$cheat_mode", 1),
                (str_store_item_name, s23, ":cur_slot"),
                (assign, reg23, ":cur_slot"),
                (assign, reg25, ":agent_no"),
                (assign, reg26, ":result"),
                (str_store_troop_name, s25, ":troop"),
                (display_log_message, "@{!}{s25} ({reg25}) - equipped {s23} ({reg23}), slot is {reg26}"),
            (try_end),
        (try_end),
    (try_end),

    (agent_get_party_id, ":party", ":agent_no"),
    (try_begin),
        (ge, ":party", 0),
        (try_begin),
            (eq, ":party", "p_main_party"),
            (assign, ":party_faction", "$players_kingdom"),
        (else_try),
            (store_faction_of_party, ":party_faction"),
        (try_end),
        (is_between, ":party_faction", kingdoms_begin, kingdoms_end),
        (faction_get_slot, ":quality", ":party_faction", dplmc_slot_faction_quality),
        (try_for_range, ":item_slot_number", ek_item_0, ek_head),
            (agent_get_item_slot, ":cur_item", ":agent_no", ":item_slot_number"),
            (gt, ":cur_item", -1),
            (item_get_type, ":type", ":cur_item"),
            (neq, ":type", itp_type_shield),
            (store_random_in_range, ":rand", 0, 75),
            (assign, ":imod", -1),
            (try_begin),
                (le, ":rand", 40),
                (le, ":quality", -3),
                (call_script, "script_get_next_lower_imod_for_item", ":cur_item", 0),
                (assign, ":imod", reg0),
            (else_try),
                (le, ":rand", 30),
                (le, ":quality", -2),
                (call_script, "script_get_next_lower_imod_for_item", ":cur_item", 0),
                (assign, ":imod", reg0),
            (else_try),
                (le, ":rand", 20),
                (le, ":quality", -1),
                (call_script, "script_get_next_lower_imod_for_item", ":cur_item", 0),
                (assign, ":imod", reg0),
            (else_try),
                (le, ":rand", 50),
                (ge, ":quality", 3),
                (call_script, "script_get_next_higher_imod_for_item", ":cur_item", 0),
                (assign, ":imod", reg0),
            (else_try),
                (le, ":rand", 40),
                (ge, ":quality", 2),
                (call_script, "script_get_next_higher_imod_for_item", ":cur_item", 0),
                (assign, ":imod", reg0),
            (else_try),
                (le, ":rand", 30),
                (ge, ":quality", 1),
                (call_script, "script_get_next_higher_imod_for_item", ":cur_item", 0),
                (assign, ":imod", reg0),
            (try_end),
            (try_begin),
                (gt, ":imod", -1),
                (agent_unequip_item, ":agent_no", ":cur_item"),
                (agent_equip_item, ":agent_no", ":cur_item", ":item_slot_number", ":imod"),

                (try_begin),
                    (ge, "$cheat_mode", 1),
                    (str_store_agent_name, s1, ":agent_no"),
                    (str_store_item_name, s2, ":cur_item"),
                    (assign, reg0, ":imod"),
                    (display_message, "@{s1}: added {s2}, ({reg0})"),
                    # (call_script, "script_advanced_agent_set_speed_modifier", ":agent_no", 10),
                (try_end),
            (try_end),
        (try_end),
    (try_end),
  ]),

  (1,0,2,[],[
    (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_is_non_player, ":agent_no"),
        (agent_get_wielded_item, ":wielded_item", ":agent_no", 0),
        (gt, ":wielded_item", 0),
        (try_begin),#remove kontos for dismounted units
            (is_between, ":wielded_item", kontos_begin, kontos_end),
            (agent_get_horse, ":horse", ":agent_no"),
            (le, ":horse", 0),
            (agent_unequip_item, ":agent_no", ":wielded_item"),
            (call_script, "script_equip_best_melee_weapon", ":agent_no", 0, 0, 1),
            (try_begin),
                (eq, "$cheat_mode", 1),
                (agent_get_troop_id, ":troop", ":agent_no"),
                (str_store_troop_name, s33, ":troop"),
                (display_message, "@{s33} changes weapons"),
            (try_end),
        (else_try),#fix too large shields beeing used with bows
            (is_between, ":wielded_item", "itm_hunting_bow", "itm_ballista_mounted"),
            (agent_get_wielded_item, ":shield", ":agent_no", 1),
            (gt, ":shield", 0),
            (neg|is_between, ":shield", "itm_scythian_shield_cav1", "itm_eastern_germanic_shield_1"),
            (neg|is_between, ":shield", "itm_ad_mixed_round_shields_01", "itm_signum_bireme"),
            (neg|is_between, ":shield", "itm_celtic_round_shild1", "itm_irish_shield_1"),
            (neg|is_between, ":shield", "itm_s_parma_mak_plain_16", "itm_eastern_shield_inf_light1"),
            (neg|is_between, ":shield", "itm_leather_covered_round_shield", "itm_javelin"),
            (neq, ":shield", "itm_african_round_shield"),
            (agent_set_wielded_item, ":agent_no", -1), #this will unequip all items
            (agent_set_wielded_item, ":agent_no", ":wielded_item"), #reequip bow
            (try_begin),
                (eq, "$cheat_mode", 1),
                (agent_get_troop_id, ":troop", ":agent_no"),
                (str_store_troop_name, s33, ":troop"),
                (display_message, "@{s33} unequip shield as too large"),
            (try_end),
        (try_end),
    (try_end),
  ]),
  ##make dismounted cavalry to infantry
  (ti_on_agent_dismount, 0, 0, [],[
    (store_trigger_param_1, ":rider"),
    # (store_trigger_param_2, ":horse"),
    (agent_is_active, ":rider"),
    (agent_is_alive, ":rider"),
    (agent_is_non_player, ":rider"),

    (try_begin),
        (agent_get_wielded_item, ":wielded_item", ":rider", 0),
        (gt, ":wielded_item", 0),
        (is_between, ":wielded_item", kontos_begin, kontos_end), # remove contos
        (agent_unequip_item, ":rider", ":wielded_item"),
        (call_script, "script_equip_best_melee_weapon", ":rider", 0, 0, 1),#check for best melee weapon
    (try_end),

    (agent_get_team, ":team", ":rider"),#change division
    (agent_get_division, reg34, ":rider"),
    (store_add, ":slot", slot_team_d0_formation, reg34),

    (agent_set_division, ":rider", grc_infantry),
    (agent_set_slot, ":rider", slot_agent_new_division, grc_infantry),
    (neg|team_slot_eq, ":team", ":slot", formation_none),
    (agent_clear_scripted_mode, ":rider"),
    (agent_set_slot, ":rider", slot_agent_formation_rank, 0),
    (agent_set_slot, ":rider", slot_agent_inside_formation, 0),
  ]),

  ###horse scull BEGIN
  #sets up the spawn timer
  (ti_on_agent_spawn, 0, 0,[
    (gt, "$g_horses_are_avaliable", 0),
  ],[
    (store_trigger_param_1, ":horse_no"),
    (agent_is_active, ":horse_no"),
    (neg|agent_is_human, ":horse_no"), #horse agent
    (agent_get_rider, ":agent_no", ":horse_no"),
    (try_begin),
        (agent_is_active, ":agent_no"),
        (agent_is_non_player, ":agent_no"), #default period for npcs
        (agent_set_slot, ":horse_no", slot_agent_bought_horse, 0), #default duration
    (else_try),
        (agent_set_slot, ":horse_no", slot_agent_bought_horse, 210),
    (try_end),
  ]),

  #restart it when horses are mounted again
  (ti_on_agent_mount, 0, 0, [
    (gt, "$g_horses_are_avaliable", 0),
  ],[
    (store_trigger_param_1, ":agent_no"),
    (store_trigger_param_2, ":horse_no"),
    (agent_is_active, ":horse_no"),
    (try_begin),
      (agent_is_active, ":agent_no"),
      (agent_is_non_player, ":agent_no"), #default period for npcs
      (agent_set_slot, ":horse_no", slot_agent_bought_horse, 0), #reset the timer
    (else_try),
      (agent_set_slot, ":horse_no", slot_agent_bought_horse, 210), #couple minutes longer for players
    (try_end),
  ]),

  #restart it when horses are mounted again
  (ti_on_agent_mount, 0, 0, [
  ],[
    (store_trigger_param_1, ":agent_no"),
    (store_trigger_param_2, ":horse_no"),
    (agent_is_active, ":horse_no"),
    (agent_is_active, ":agent_no"),
    (agent_is_non_player, ":agent_no"),

    (agent_get_team, ":team", ":agent_no"),#change division
    (agent_get_division, reg34, ":agent_no"),
    (store_add, ":slot", slot_team_d0_formation, reg34),

    (agent_set_division, ":agent_no", grc_cavalry),
    (agent_set_slot, ":agent_no", slot_agent_new_division, grc_cavalry),
    (neg|team_slot_eq, ":team", ":slot", formation_none),
    (agent_clear_scripted_mode, ":agent_no"),
    (agent_set_slot, ":agent_no", slot_agent_formation_rank, 0),
    (agent_set_slot, ":agent_no", slot_agent_inside_formation, 0),
  ]),

  #the main "workhorse" of the trigger, set to intervals of 5/10/30 or have a server setting
  (10, 0, 0, [
    (gt, "$g_horses_are_avaliable", 0),
  ],[
    (set_fixed_point_multiplier, 1000),
    (try_for_agents, ":horse_no"),
      (agent_is_active, ":horse_no"),
      (agent_is_alive, ":horse_no"),
      (neg|agent_is_human, ":horse_no"),
      (agent_get_rider, ":rider_no", ":horse_no"),
      (lt, ":rider_no", 0),
      (agent_get_slot, ":horse_timer", ":horse_no", slot_agent_bought_horse),
      (try_begin),
        (le, ":horse_timer", -90), #a minute and a half
        (agent_get_position, pos1, ":horse_no"),
        (get_player_agent_no, ":player_agent"),
        (agent_get_position, pos2, ":player_agent"),
        (get_distance_between_positions, ":dist", pos1, pos2),#in centimeters
        (lt, ":dist", 600), #nobody (important) nearby
        (agent_fade_out, ":horse_no"),
      (else_try),
        (val_sub, ":horse_timer", "$g_horses_are_avaliable"),
        (agent_set_slot, ":horse_no", slot_agent_bought_horse, ":horse_timer"),
        (try_begin), #force runaway half-way through
          (le, ":horse_timer", -60),
          (agent_start_running_away, ":horse_no"),
        (try_end),
      (try_end),
    (try_end),
  ]),
  dedal_shield_bash_AI,
  dedal_shield_bash,
  custom_commander_critical_strike,
  miracle_battle_trigger,
  more_difficult_damage,
  realistic_wounding,

  dplmc_horse_speed,
]
dplmc_battle_mode_triggers = dplmc_death_came_triggers + dplmc_battle_mode_triggers_no_deathcam
##diplomacy end

common_battle_mission_start = (
  ti_before_mission_start, 0, 0, [],[
    (team_set_relation, 0, 2, 1),
    (team_set_relation, 1, 3, 1),
    (call_script, "script_change_banners_and_chest"),
])

common_battle_player_fallen_renown_lose = (
  1, 4, ti_once, [(main_hero_fallen)],[
    (store_character_level, ":player_level", "trp_player"), #depend on level, more level more penalty
    (try_begin), #difficult setting
      (ge, ":player_level", 7),
      (val_div, ":player_level", 6),
      (assign, ":renown_change", ":player_level"),
      (val_mul, ":renown_change", -1),
      (val_min, ":renown_change", 0),
      (call_script,"script_change_troop_renown", "trp_player", ":renown_change"),
    (try_end),
    (display_message,"@You have fallen. (Press tab key to leave)"),
])

common_battle_tab_press = (
  ti_tab_pressed, 0, 0, [],
  [
    (try_begin),
      (call_script, "script_all_enemies_routed"),
      (eq, reg10, 0),
      (this_or_next|eq, "$g_dplmc_battle_continuation", 0),
      (neg|main_hero_fallen),
      (set_mission_result,1),
      (display_message,"str_msg_battle_won"),
      (assign,"$g_battle_won",1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,0),
    (else_try),
      (eq, "$g_battle_won", 1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,0),
    ##diplomacy begin
    (else_try),
      (eq, "$g_dplmc_battle_continuation", 0),
      ##diplomacy start+ Import Caba`drin's battle continuation fix
      (this_or_next|main_hero_fallen),   #CABA EDIT/FIX FOR DEATH CAM
      ##diplomacy end+
      (eq, "$pin_player_fallen", 1),
      (question_box,"str_do_you_want_to_retreat"),
##      (call_script, "script_simulate_retreat", 5, 20),
##      (str_store_string, s5, "str_retreat"),
##      (call_script, "script_count_mission_casualties_from_agents"),
##      (set_mission_result, -1),
##      (finish_mission,0),
    ##diplomacy end
    (else_try),
      (neq,"$player_ambushed",3), #no flee in ambush	#this is causing VC-2348
      (call_script, "script_cf_check_enemies_nearby"),
      (question_box,"str_do_you_want_to_retreat"),
    (else_try),
      (eq,"$player_ambushed",3), #no flee in ambush	#this is causing VC-2348
      (display_message,"str_can_not_retreat_ambush"),
    (else_try),
      (display_message,"str_can_not_retreat"),
    (try_end),
    ])

common_battle_init_banner = (ti_on_agent_spawn, 0, 0, [],[
    (store_trigger_param_1, ":agent_no"),
    (agent_get_troop_id, ":troop_no", ":agent_no"),
    (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":agent_no", ":troop_no"),
  ])

common_arena_init_banner = (ti_on_agent_spawn, 0, 0, [],[
    (store_trigger_param_1, ":agent_no"),
    (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":agent_no", -1),
  ])

common_arena_fight_tab_press = (ti_tab_pressed, 0, 0, [],[
    (question_box,"str_give_up_fight"),
  ])

common_custom_battle_tab_press = (ti_tab_pressed, 0, 0, [],[
    (try_begin),
      (neq, "$g_battle_result", 0),
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    (else_try),
      (question_box,"str_give_up_fight"),
    (try_end),
  ])

custom_battle_check_victory_condition = (1, 60, ti_once,[
    (store_mission_timer_a,reg(1)),
    (ge,reg(1),10),
    (all_enemies_defeated, 2),
    ##diplomacy begin
    (this_or_next|eq, "$g_dplmc_battle_continuation", 0),
    (neg|main_hero_fallen, 0),
    ##diplomacy end
    (set_mission_result,1),
    (display_message,"str_msg_battle_won"),
    (assign, "$g_battle_won",1),
    (assign, "$g_battle_result", 1),
  ],[
    (call_script, "script_custom_battle_end"),
    (finish_mission, 1),
  ])

custom_battle_check_defeat_condition = (1, 4, 0,[
    (main_hero_fallen),
    ##diplomacy begin
    (try_begin),
      (call_script, "script_cf_dplmc_battle_continuation"),
    (else_try),
      ##diplomacy end
      (assign,"$g_battle_result",-1),
      ##diplomacy begin
    (try_end),
    ##diplomacy end
    (eq,"$g_battle_result",-1),
  ],[
    (call_script, "script_custom_battle_end"),
    (finish_mission),
  ])

common_battle_victory_display = (10, 0, 0, [],[
    (eq,"$g_battle_won",1),
    (display_message,"str_msg_battle_won"),
  ])

common_siege_question_answered = (ti_question_answered, 0, 0, [],[
    (store_trigger_param_1,":answer"),
    (eq,":answer",0),
    (assign, "$pin_player_fallen", 0),
    (get_player_agent_no, ":player_agent"),
    (agent_get_team, ":agent_team", ":player_agent"),
    (try_begin),
      (neq, "$attacker_team", ":agent_team"),
      (neq, "$attacker_team_2", ":agent_team"),
      (str_store_string, s5, "str_siege_continues"),
      (call_script, "script_simulate_retreat", 8, 15, 0),
    (else_try),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 5, 20, 0),
    (try_end),
    (call_script, "script_count_mission_casualties_from_agents"),
    (finish_mission,0),
  ])

common_siege_calculate_reinforcement_waves = (ti_before_mission_start, 0, 0, [],[
    # (options_get_battle_size, ":value"),
    # (val_div, ":value", 10),
    # (try_begin),
        # (le, ":value", 25),
        # (assign, "$siege_threshold_attacker", 12),
        # (assign, "$siege_threshold_defender", 14),
    # (else_try),
        # (le, ":value", 50),
        # (assign, "$siege_threshold_attacker", 10),
        # (assign, "$siege_threshold_defender", 12),
    # (else_try),
        # (le, ":value", 75),
        # (assign, "$siege_threshold_attacker", 8),
        # (assign, "$siege_threshold_defender", 10),
    # (else_try),
        (assign, "$siege_threshold_attacker", 6),
        (assign, "$siege_threshold_defender", 8),
    # (try_end),
    (val_mul, "$siege_threshold_attacker", "$reduce_factor"),
    (val_mul, "$siege_threshold_defender", "$reduce_factor"),
    (assign, reg1, "$siege_threshold_attacker"),
    (assign, reg2, "$siege_threshold_defender"),
    (display_message, "@Reinforcements for attacker: {reg1} and for defender: {reg2}."),
  ])

common_custom_battle_question_answered = (ti_question_answered, 0, 0, [],[
    (store_trigger_param_1,":answer"),
    (eq,":answer",0),
    (assign, "$g_battle_result", -1),
    (call_script, "script_custom_battle_end"),
    (finish_mission),
  ])
common_siege_init = (0, 0, ti_once, [],[
    (assign,"$g_battle_won",0),
    (assign,"$defender_reinforcement_stage",0),
    (assign,"$attacker_reinforcement_stage",0),
    (call_script, "script_music_set_situation_with_culture", mtf_sit_siege),
    (call_script, "script_init_death_cam"), #SB : initialize this here
  ])

common_music_situation_update = (30, 0, 0, [],[
    (call_script, "script_combat_music_set_situation_with_culture"),
  ])

common_siege_defender_reinforcement_archer_reposition = (2, 0, 0,[
  ],[
    (call_script, "script_siege_move_archers_to_archer_positions"),
  ])
common_siege_refill_ammo = (240, 0, 0, [],##changed to 4 min
  [#refill ammo of defenders every two minutes.
    (try_for_agents,":cur_agent"),
      (agent_is_active, ":cur_agent"),
      (agent_is_alive, ":cur_agent"),
      (agent_is_human, ":cur_agent"),
      (agent_refill_ammo, ":cur_agent"),
    (try_end),
    (display_message, "@Received ammunition supplies."),
  ])

common_camp_defenders_move_to_defender_position = (2, 0, 0,[
  ],[
    (call_script, "script_camp_defenders_move_to_defender_position"),
  ])

common_siege_attacker_do_not_stall = (5, 0, 0, [],[ #Make sure attackers do not stall on the ladders...
    (try_for_agents, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_team, ":agent_team", ":agent_no"),
      (this_or_next|eq, ":agent_team", "$attacker_team"),
      (eq, ":agent_team", "$attacker_team_2"),
      (agent_ai_set_always_attack_in_melee, ":agent_no", 1),
    (try_end),
  ])
common_nobody_stalls = (5, 0, 0, [],[ #Disable stalling on sea battles
      (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_ai_set_always_attack_in_melee, ":agent_no", 1),
      (try_end),
    ])

common_battle_check_friendly_kills = (ti_on_agent_killed_or_wounded, 0, 0, [],[
    (store_trigger_param_1, ":dead_agent_no"),
    (store_trigger_param_2, ":killer_agent_no"),
    (agent_is_active, ":dead_agent_no"),
    (agent_is_active, ":killer_agent_no"),
    (neg|agent_is_non_player, ":killer_agent_no"),#player
    (agent_is_ally, ":dead_agent_no"),#ally
    (call_script, "script_change_player_party_morale", -5),
    (try_begin),
        (check_quest_active, "qst_freelancing"),
        (quest_get_slot, ":progress", "qst_freelancing", slot_quest_freelancer_progress),
        (val_sub, ":progress", 10),
        (quest_set_slot, "qst_freelancing", slot_quest_freelancer_progress, ":progress"),
        (assign, reg3, 10),
        (val_mul, reg3, -1),
        (display_message, "@You lost {reg3} progress points due to killing friendly troops!", color_terrible_news),
    (try_end),
  ])

common_battle_check_victory_condition = (1, 60, ti_once,[
    (store_mission_timer_a,reg(1)),
    (ge,reg(1),10),
    (all_enemies_defeated, 5),
    #(all_enemies_defeated, 5),
    # (call_script, "script_all_enemies_routed"),
    # (eq, reg10, 0),
    ##diplomacy begin
    (this_or_next|eq, "$g_dplmc_battle_continuation", 0),
    (neg|main_hero_fallen),
    ##diplomacy end
    (set_mission_result,1),
    (display_message,"str_msg_battle_won"),
    (assign,"$g_battle_won",1),
    (assign, "$g_battle_result", 1),
    (call_script, "script_play_victorious_sound"),
  ],[
    (call_script, "script_count_mission_casualties_from_agents"),
    (finish_mission, 1),
  ])

common_battle_victory_display = (10, 0, 0, [],[
    (try_begin),
      (eq,"$g_battle_won",1),
      (display_message,"str_msg_battle_won"),
    (else_try),
      (call_script, "script_all_enemies_routed"),
      (eq, reg10, 0),
      (display_message,"str_all_enemies_routed"),
    (try_end),
  ])

common_fieldbattle_refill_ammo = (##changed to 8 min
  60*6, 0, 0, [
    (store_mission_timer_a, ":time"),
    (gt, ":time", 240),#let some time pass
  ],[
    (try_for_agents,":cur_agent"),
        (agent_is_active, ":cur_agent"),
        (agent_is_alive, ":cur_agent"),
        (agent_is_human, ":cur_agent"),
        (agent_slot_eq, ":cur_agent", slot_agent_is_running_away, 0),
        (agent_get_attack_action, ":action", ":cur_agent"),
        (eq, ":action", 0), #not fighting with weapon
        (agent_refill_ammo, ":cur_agent"),
    (try_end),
    (display_message, "@Soldiers are picking up missles from the ground.", message_alert),
  ])

common_siege_check_defeat_condition = (1, 4, 0,[
    (main_hero_fallen),
  ],[
    (try_begin),
      (call_script, "script_cf_dplmc_battle_continuation"),
    (else_try),
      (assign, "$pin_player_fallen", 1),
      (get_player_agent_no, ":player_agent"),
      (agent_get_team, ":agent_team", ":player_agent"),
      (try_begin),
        (neq, "$attacker_team", ":agent_team"),
        (neq, "$attacker_team_2", ":agent_team"),
        (str_store_string, s5, "str_siege_continues"),
        (call_script, "script_simulate_retreat", 8, 15, 0),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
      (try_end),
      (assign, "$g_battle_result", -1),
      (set_mission_result,-1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,0),
    (try_end),
  ])

common_battle_order_panel = (
  0, 0, 0, [
    (game_key_clicked, gk_view_orders),
    (neg|is_presentation_active, "prsnt_battle"),
  ],[
    (start_presentation, "prsnt_battle"),
  ])

common_battle_order_panel_tick = (0.1, 0, 0, [
    (is_presentation_active, "prsnt_battle"),
  ],[
    (call_script, "script_update_order_panel_statistics_and_map"),
  ])

common_battle_inventory = (ti_inventory_key_pressed, 0, 0, [],[
    (display_message,"str_use_baggage_for_inventory"),
  ])

common_inventory_not_available = (ti_inventory_key_pressed, 0, 0,[
    (display_message, "str_cant_use_inventory_now"),
  ],[])

tournament_triggers = [

  custom_commander_critical_strike,
  cannot_spawn_commoners,
  improved_lightning,
  miracle_arena_trigger,
  common_arena_init_banner,

  (1,0,2,[],[
    (try_for_agents, ":agent_no"),
      (agent_is_active, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_is_non_player, ":agent_no"),
      (agent_get_troop_id, ":troop", ":agent_no"),
      (troop_is_guarantee_horse, ":troop"),
      (agent_get_horse, ":horse", ":agent_no"),
      (le, ":horse", 0),
      (agent_get_wielded_item, ":wielded_item", ":agent_no", 0),
      (gt, ":wielded_item", 0),
      (is_between, ":wielded_item", kontos_begin, kontos_end),
      (agent_unequip_item, ":agent_no", ":wielded_item"),
      (call_script, "script_equip_best_melee_weapon", ":agent_no", 0, 0, 1),
      (try_begin),
        (eq, "$cheat_mode", 1),
        (str_store_troop_name, s33, ":troop"),
        (display_message, "@{s33} changes weapons"),
      (try_end),
    (try_end),
  ]),

  (0, 0, 3,[
    (key_clicked, key_t),
  ],[
    (get_player_agent_no, ":player_agent"),
    (call_script,"script_agent_perform_warcry", ":player_agent"),
		(display_message, "@You unleash a fearsome cry!",message_positive),
  ]),

  (ti_before_mission_start, 0, 0, [],[
    (call_script, "script_change_banners_and_chest"),
    (assign, "$g_arena_training_num_agents_spawned", 0)
  ]),
  (ti_inventory_key_pressed, 0, 0, [
    (display_message,"str_cant_use_inventory_arena")
  ],[]),

  (ti_tab_pressed, 0, 0, [],[
    (try_begin),
      (eq, "$g_mt_mode", abm_visit),
      (set_trigger_result, 1),
    (else_try),
      (question_box,"str_give_up_fight"),
    (try_end),
  ]),
  (ti_question_answered, 0, 0, [],[
    (store_trigger_param_1,":answer"),
    (eq,":answer",0),
    (try_begin),
      (eq, "$g_mt_mode", abm_tournament),
      (call_script, "script_end_tournament_fight", 0),
    (else_try),
      (eq, "$g_mt_mode", abm_training),
      (get_player_agent_no, ":player_agent"),
      (agent_get_kill_count, "$g_arena_training_kills", ":player_agent", 1),#use this for conversation
      #SB : deduct health here
      (call_script, "script_agent_apply_training_health", ":player_agent"),
    (try_end),
    (finish_mission,0),
  ]),

  (ti_on_agent_spawn,1,0, [],[
    (store_trigger_param_1, ":agent"),
    (agent_get_troop_id, ":troop", ":agent"),
    (this_or_next|eq, ":troop", "trp_guest"),
    (eq, ":troop", "trp_guest_female"),
    (agent_set_stand_animation, ":agent", "anim_arena_stand_idle"),
    (agent_set_animation, ":agent", "anim_arena_stand_idle"),
    (store_random_in_range,":r",0,300),
    (agent_set_animation_progress,":agent",":r"),
   ]),

  (1, 0, ti_once, [],[
    (eq, "$g_mt_mode", abm_visit),
    (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
    (store_current_scene, reg(1)),
    (scene_set_slot, reg(1), slot_scene_visited, 1),
    (mission_enable_talk),
    (get_player_agent_no, ":player_agent"),
    (assign, ":team_set", 0),
    (try_for_agents, ":agent_no"),
      (neq, ":agent_no", ":player_agent"),
      (agent_get_troop_id, ":troop_id", ":agent_no"),
      (is_between, ":troop_id", regular_troops_begin, regular_troops_end),
      (eq, ":team_set", 0),
      (agent_set_team, ":agent_no", 1),
      (assign, ":team_set", 1),
    (try_end),
  ]),

  #even though $disable_npc_complaints should really only apply for companions
  (ti_on_agent_killed_or_wounded, 0, 0, [
    (eq, "$g_mt_mode", abm_tournament),
  ],[
    (store_trigger_param_1, ":dead_agent_no"),
    (store_trigger_param_2, ":killer_agent_no"),

    # (get_player_agent_no, ":player_agent"),
    # (eq, ":killer_agent_no", ":player_agent"),
    (agent_get_troop_id, ":killer_troop", ":killer_agent_no"),
    (troop_is_hero, ":killer_troop"),

    (agent_is_human, ":dead_agent_no"),
    (agent_get_troop_id, ":wounded_troop", ":dead_agent_no"),
    (troop_is_hero, ":wounded_troop"),
    (is_between, ":wounded_troop", heroes_begin, heroes_end), #exclude common tournament fighters
    (troop_slot_ge, ":wounded_troop", slot_troop_renown, 200), #no point in being mad if you're nobody
    (try_begin), #calculate relation loss
      (troop_get_slot, ":lrep", ":wounded_troop", slot_lord_reputation_type),
      (eq, ":lrep", lrep_quarrelsome),
      #(troop_slot_eq, ":killer_troop", slot_lord_reputation_type, lrep_quarrelsome), why would a quarrelsome lord be mad that he won?
      (assign, ":relation_loss", -1),
    (else_try),
      (assign, ":relation_loss", 0),
    (try_end),
    (try_begin), #friendly fire, it happens
      (eq, ":killer_troop", "trp_player"),
      (agent_is_ally, ":dead_agent_no"),
      (call_script, "script_change_player_relation_with_troop", ":wounded_troop", -3),
    (else_try),
      (call_script, "script_troop_change_relation_with_troop", ":killer_troop", ":wounded_troop", ":relation_loss"),
    (try_end),
    (call_script, "script_change_troop_renown", ":killer_troop", 1), #Static amount
  ]),

  (0, 0, ti_once, [
    (eq, "$g_mt_mode", abm_tournament),
  ],[
    (play_sound, "snd_arena_ambiance", sf_looping),
    (call_script, "script_music_set_situation_with_culture", mtf_sit_arena),
  ]),

  (1, 4, ti_once, [
    (eq, "$g_mt_mode", abm_tournament),
    (this_or_next|main_hero_fallen),
    (num_active_teams_le, 1)
  ],[
    (try_begin),
      (neg|main_hero_fallen),
      (call_script, "script_end_tournament_fight", 1),
      (call_script, "script_play_victorious_sound"),
      (finish_mission),
    (else_try),
      (call_script, "script_end_tournament_fight", 0),
      (finish_mission),
    (try_end),
  ]),

  (ti_battle_window_opened, 0, 0, [],[
    (eq, "$g_mt_mode", abm_training),
    (start_presentation, "prsnt_arena_training")
  ]),

  (0, 0, ti_once, [],[
    (eq, "$g_mt_mode", abm_training),
    (assign, "$g_arena_training_max_opponents", 40),
    (assign, "$g_arena_training_num_agents_spawned", 0),
    (assign, "$g_arena_training_kills", 0),
    (assign, "$g_arena_training_won", 0),
    (call_script, "script_music_set_situation_with_culture", mtf_sit_arena),
  ]),

  (1, 4, ti_once, [
    (eq, "$g_mt_mode", abm_training),
    (store_mission_timer_a, ":cur_time"),
    (gt, ":cur_time", 3),
    (assign, ":win_cond", 0),
    (try_begin),
      (ge, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),#spawn at most 40 agents
      (num_active_teams_le, 1),
      (assign, ":win_cond", 1),
    (try_end),
    (this_or_next|eq, ":win_cond", 1),
    (main_hero_fallen)
  ],[
    (get_player_agent_no, ":player_agent"),
    (agent_get_kill_count, "$g_arena_training_kills", ":player_agent", 1),#use this for conversation
    (assign, "$g_arena_training_won", 0),
    (try_begin),
      (neg|main_hero_fallen),
      (assign, "$g_arena_training_won", 1),#use this for conversation
    (try_end),
    (assign, "$g_mt_mode", abm_visit),
    (set_jump_mission, "mt_arena_melee_fight"),
    (party_get_slot, ":arena_scene", "$current_town", slot_town_arena),
    (modify_visitors_at_site, ":arena_scene"),
    (reset_visitors),
    (set_visitor, 35, "trp_veteran_fighter"),
    (set_visitor, 36, "trp_hired_blade"),
    ##nero claudis, bug where is no auctor in arena after fight
    (store_sub, ":town_id", "$current_town", towns_begin),
    (store_add, ":auctor", ":town_id", arena_masters_begin),
    (set_visitor, 52, ":auctor"),

    (call_script, "script_spawn_specators"),

    (set_jump_entry, 50),
    (jump_to_scene, ":arena_scene"),

    #SB : deduct health here
    (call_script, "script_agent_apply_training_health", ":player_agent"),
  ]),

  (0.2, 0, 0,[
    (eq, "$g_mt_mode", abm_training),
    (assign, ":num_active_fighters", 0),
    (try_for_agents, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_team, ":team_no", ":agent_no"),
      (is_between, ":team_no", 0 ,7),
      (val_add, ":num_active_fighters", 1),
    (try_end),
    (lt, ":num_active_fighters", 7),
    (neg|main_hero_fallen),
    (store_mission_timer_a, ":cur_time"),
    (this_or_next|ge, ":cur_time", "$g_arena_training_next_spawn_time"),
    (this_or_next|lt, "$g_arena_training_num_agents_spawned", 6),
    (num_active_teams_le, 1),
    (lt, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
  ],[
    (assign, ":added_troop", "$g_arena_training_num_agents_spawned"),
    (store_div,  ":added_troop", "$g_arena_training_num_agents_spawned", 6),
    (assign, ":added_troop_sequence", "$g_arena_training_num_agents_spawned"),
    (val_mod, ":added_troop_sequence", 6),
    (val_add, ":added_troop", ":added_troop_sequence"),
    (val_min, ":added_troop", 9),
    (val_add, ":added_troop", "trp_arena_training_fighter_1"),
    (assign, ":end_cond", 10000),
    (get_player_agent_no, ":player_agent"),
    (agent_get_position, pos5, ":player_agent"),
    (try_for_range, ":unused", 0, ":end_cond"),
      (store_random_in_range, ":random_entry_point", 32, 40),
      #SB : now we use this to prevent duplicate
      (neq, ":random_entry_point", "$g_player_entry_point"), # make sure we don't overwrite player
      (entry_point_get_position, pos1, ":random_entry_point"),
      (get_distance_between_positions, ":dist", pos5, pos1),
      (gt, ":dist", 1200), #must be at least 12 meters away from the player
      (assign, ":end_cond", 0),
    (try_end),
    (add_visitors_to_current_scene, ":random_entry_point", ":added_troop", 1),
    #SB : set this as last spawnpoint
    (assign, "$g_player_entry_point", ":random_entry_point"),
    (store_add, ":new_spawned_count", "$g_arena_training_num_agents_spawned", 1),
    (store_mission_timer_a, ":cur_time"),
    (store_add, "$g_arena_training_next_spawn_time", ":cur_time", 14),
    (store_div, ":time_reduction", ":new_spawned_count", 3),
    (val_sub, "$g_arena_training_next_spawn_time", ":time_reduction"),
  ]),

  (0, 0, 0,[
    (eq, "$g_mt_mode", abm_training),
  ],[
    (assign, ":max_teams", 6),
    (val_max, ":max_teams", 1),
    (get_player_agent_no, ":player_agent"),
    (try_for_agents, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_slot_eq, ":agent_no", slot_agent_arena_team_set, 0),
      (agent_get_team, ":team_no", ":agent_no"),
      (is_between, ":team_no", 0 ,7),
      (try_begin),
        (eq, ":agent_no", ":player_agent"),
        (agent_set_team, ":agent_no", 6), #player is always team 6.
      (else_try),
        (store_random_in_range, ":selected_team", 0, ":max_teams"),
      # find strongest team
        (try_for_range, ":t", 0, 6),
          (troop_set_slot, "trp_temp_array_a", ":t", 0),
        (try_end),
        (try_for_agents, ":other_agent_no"),
          (agent_is_human, ":other_agent_no"),
          (agent_is_alive, ":other_agent_no"),
          (neq, ":agent_no", ":player_agent"),
          (agent_slot_eq, ":other_agent_no", slot_agent_arena_team_set, 1),
          (agent_get_team, ":other_agent_team", ":other_agent_no"),
          (troop_get_slot, ":count", "trp_temp_array_a", ":other_agent_team"),
          (val_add, ":count", 1),
          (troop_set_slot, "trp_temp_array_a", ":other_agent_team", ":count"),
        (try_end),
        (assign, ":strongest_team", 0),
        (troop_get_slot, ":strongest_team_count", "trp_temp_array_a", 0),
        (try_for_range, ":t", 1, 6),
          (troop_slot_ge, "trp_temp_array_a", ":t", ":strongest_team_count"),
          (troop_get_slot, ":strongest_team_count", "trp_temp_array_a", ":t"),
          (assign, ":strongest_team", ":t"),
        (try_end),
        (store_random_in_range, ":rand", 5, 100),
        (try_begin),
          (lt, ":rand", "$g_arena_training_num_agents_spawned"),
          (assign, ":selected_team", ":strongest_team"),
        (try_end),
        (agent_set_team, ":agent_no", ":selected_team"),
      (try_end),
      (agent_set_slot, ":agent_no", slot_agent_arena_team_set, 1),
      (try_begin),
        (neq, ":agent_no", ":player_agent"),
        (val_add, "$g_arena_training_num_agents_spawned", 1),
      (try_end),
    (try_end),
  ]),
] + improved_horse_archer_ai

mission_templates = [
("town_default",0,-1,
  "Default town visit",[
    (0,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
    (1,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (8,mtef_scene_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_scene_source,af_override_horse,0,1,[]),
    (11,mtef_scene_source,af_override_horse,0,1,[]),
    (12,mtef_scene_source,af_override_horse,0,1,[]),
    (13,mtef_scene_source,0,0,1,[]),
    (14,mtef_scene_source,0,0,1,[]),
    (15,mtef_scene_source,0,0,1,[]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),
    (17,mtef_visitor_source,af_override_horse,0,1,[]),
    (18,mtef_visitor_source,af_override_horse,0,1,[]),
    (19,mtef_visitor_source,af_override_horse,0,1,[]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_horse,0,1,[]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
    (23,mtef_visitor_source,af_override_horse,0,1,[]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse,0,1,[]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),

    (1,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[]),#32
    (2,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[]),#33
    (3,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[]),#34
    (4,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[]),#35
    (5,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[]),#36
    (6,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[]),#37
    (7,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[]),#38
    (8,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[]),#39
    (10,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[]),#40

    (41,mtef_visitor_source,af_override_horse,0,1,[]),
    (42,mtef_visitor_source,af_override_horse,0,1,[]),
    (43,mtef_visitor_source,af_override_weapons|af_override_head|af_override_horse,0,1,[]),
    (44,mtef_visitor_source,af_override_weapons|af_override_head|af_override_horse,0,1,[]),
    (45,mtef_visitor_source,af_override_weapons|af_override_head|af_override_horse,0,1,[]),
  ], global_common_triggers + p_wetter +
  [
    can_spawn_commoners,

    ambient_tavern_play_loop,
    ambient_tavern_play_random_sound,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
		dedal_tavern_animations,
		wounds_vc,
		#dedal end
    (1, 0, ti_once, [],[
      (store_current_scene, ":cur_scene"),
      (scene_set_slot, ":cur_scene", slot_scene_visited, 1),
      (try_begin),
        (gt, "$sneaked_into_town", disguise_none),
        (call_script, "script_music_set_situation_with_culture", mtf_sit_town_infiltrate),
      (else_try),
        (eq, "$talk_context", tc_tavern_talk),
        (call_script, "script_music_set_situation_with_culture", mtf_sit_tavern),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_initialize_tavern_variables"),
    ]),

    (ti_inventory_key_pressed, 0, 0,[ #SB : disable inventory while attacked in taverns
      (try_begin),
        (this_or_next|eq, "$g_main_attacker_agent", 0),
        (neq, "$talk_context", tc_tavern_talk),
        (set_trigger_result, 1),
      (try_end),
    ],[]),

    #tavern - belligerent drunk leaving/fading out
    (1, 0, 0,[
      (gt, "$g_belligerent_drunk_leaving", 0),
      (entry_point_get_position, pos0, 0),
      (agent_get_position, pos1, "$g_belligerent_drunk_leaving"),
      (get_distance_between_positions, ":dist", pos0, pos1),
      (le, ":dist", 150),
    ],[
      (agent_fade_out, "$g_belligerent_drunk_leaving"),
      (assign, "$g_belligerent_drunk_leaving", 0),
    ]),

    (ti_tab_pressed, 0, 0,[
      (try_begin),
        (eq, "$g_main_attacker_agent", 0),
        (set_trigger_result, 1),
      (try_end),
    ],[]),

	  #tavern brawl triggers - drunk
    (2, 0, 0,[
	    (neg|conversation_screen_is_active),
      (eq, "$talk_context", tc_tavern_talk),
      (neg|troop_slot_eq, "trp_hired_assassin", slot_troop_cur_center, "$g_encountered_party"),
      (troop_slot_eq, "trp_belligerent_drunk", slot_troop_cur_center, "$g_encountered_party"),
      (eq, "$drunks_dont_pick_fights", 0),
	  ],[
	    (try_begin),
	      (eq, "$g_start_belligerent_drunk_fight", 0),
	      (assign, "$g_start_belligerent_drunk_fight", 1),

	      (try_for_agents, ":cur_agent"),
	        (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
	        (eq, ":cur_agent_troop", "trp_belligerent_drunk"),
	        (assign, "$g_belligerent_drunk", ":cur_agent"),
	      (try_end),
	    (else_try),
	      (eq, "$g_start_belligerent_drunk_fight", 1),

	      (agent_is_active, "$g_belligerent_drunk"),
	      (agent_is_alive, "$g_belligerent_drunk"),
	      (get_player_agent_no, ":player_agent"),
	      (agent_get_position, pos0, ":player_agent"),
	      (agent_get_position, pos1, "$g_belligerent_drunk"),
	      (get_distance_between_positions, ":dist", pos0, pos1),
	      (position_get_z, ":pos0_z", pos0),
	      (position_get_z, ":pos1_z", pos1),
	      (store_sub, ":z_difference", ":pos1_z", ":pos0_z"),
	      (try_begin),
	        (le, ":z_difference", 0),
	        (val_mul, ":z_difference", -1),
	      (try_end),
	      (store_mul, ":z_difference_mul_3", ":z_difference", 3),
	      (val_add, ":dist", ":z_difference_mul_3"),
	      (store_random_in_range, ":random_value", 0, 200),
	      (store_add, ":400_plus_random_200", 400, ":random_value"),
	      (le, ":dist", ":400_plus_random_200"),
 		    (call_script, "script_activate_tavern_attackers"),
  		  (start_mission_conversation, "trp_belligerent_drunk"),
  		  (assign, "$g_start_belligerent_drunk_fight", 2),
	    (try_end),
	  ]),

	  #tavern brawl triggers - assassin
    (2, 0, 0, [
	    (neg|conversation_screen_is_active),
      (eq, "$talk_context", tc_tavern_talk),
      (troop_slot_eq, "trp_hired_assassin", slot_troop_cur_center, "$g_encountered_party"),
    ],[
	    (try_begin),
	      (eq, "$g_start_hired_assassin_fight", 0),
	      (assign, "$g_start_hired_assassin_fight", 1),

	      (try_for_agents, ":cur_agent"),
	        (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
	        (eq, ":cur_agent_troop", "trp_hired_assassin"),
	        (assign, "$g_hired_assassin", ":cur_agent"),
	      (try_end),
	    (else_try),
	      (eq, "$g_start_hired_assassin_fight", 1),

	      (agent_is_active, "$g_hired_assassin"),
	      (agent_is_alive, "$g_hired_assassin"),
	      (get_player_agent_no, ":player_agent"),
	      (agent_get_position, pos0, ":player_agent"),
	      (agent_get_position, pos1, "$g_hired_assassin"),
	      (get_distance_between_positions, ":dist", pos0, pos1),
	      (position_get_z, ":pos0_z", pos0),
	      (position_get_z, ":pos1_z", pos1),
	      (store_sub, ":z_difference", ":pos1_z", ":pos0_z"),
	      (try_begin),
	        (le, ":z_difference", 0),
	        (val_mul, ":z_difference", -1),
	      (try_end),
	      (store_mul, ":z_difference_mul_3", ":z_difference", 3),
	      (val_add, ":dist", ":z_difference_mul_3"),
	      (store_random_in_range, ":random_value", 0, 200),
	      (store_add, ":400_plus_random_200", 400, ":random_value"),
	      (le, ":dist", ":400_plus_random_200"),
        (call_script, "script_activate_tavern_attackers"),
        (assign, "$g_start_hired_assassin_fight", 2),
        (assign, "$g_main_attacker_agent", "$g_hired_assassin"),
      (try_end),
	  ]),

	  #Aftermath talks
    (3, 0, ti_once,[
	    (neg|conversation_screen_is_active),
      (eq, "$talk_context", tc_tavern_talk),
      (gt, "$g_main_attacker_agent", 0),
      (this_or_next|neg|agent_is_alive, "$g_main_attacker_agent"),
      (agent_is_wounded, "$g_main_attacker_agent"),
    ],[
      (mission_enable_talk),
      (try_for_agents, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_get_position, pos4, ":agent"),
        (agent_set_scripted_destination, ":agent", pos4),
      (try_end),
      (party_get_slot, ":tavernkeeper", "$g_encountered_party", slot_town_tavernkeeper),
      (start_mission_conversation, ":tavernkeeper"),
	  ]),

	  #Aftermath talks
    (3, 0, ti_once,[
	    (neg|conversation_screen_is_active),
      (eq, "$talk_context", tc_tavern_talk),
      (gt, "$g_main_attacker_agent", 0),
      (main_hero_fallen),
    ],[
      (jump_to_menu, "mnu_lost_tavern_duel"),
      (finish_mission,0)
	  ]),
	  #No shooting in the tavern
    (1, 0, 0,[
	    (neg|conversation_screen_is_active),
      (eq, "$talk_context", tc_tavern_talk),
      (gt, "$g_main_attacker_agent", 0),

      (get_player_agent_no, ":player_agent"),
      (agent_is_alive, ":player_agent"),
      ## SB : move diplomacy standing check back up here in conditions
      (call_script, "script_dplmc_get_troop_standing_in_faction", "trp_player", "$g_encountered_party_faction"),
      (lt, reg0, DPLMC_FACTION_STANDING_MEMBER),
      (agent_get_wielded_item, ":wielded_item", ":player_agent", 0),
      (gt, ":wielded_item", 0),
      (item_get_type, ":type", ":wielded_item"),
      (this_or_next|is_between, ":type", itp_type_bow, itp_type_goods),
      (is_between, ":type", itp_type_pistol, itp_type_bullets),
      # (is_between, ":wielded_item", "itm_darts", "itm_torch"),
      # (neq, ":wielded_item", "itm_javelin_melee"),
      # (neq, ":wielded_item", "itm_throwing_spear_melee"),
      # (neq, ":wielded_item", "itm_jarid_melee"),
      # (neq, ":wielded_item", "itm_light_throwing_axes_melee"),
      # (neq, ":wielded_item", "itm_throwing_axes_melee"),
      # (neq, ":wielded_item", "itm_heavy_throwing_axes_melee"),
      #SB : also add these conditions
    ],[
      (party_get_slot, ":tavernkeeper", "$g_encountered_party", slot_town_tavernkeeper),
      # ##diplomacy start+
      # #Turn of this !@#$%ing obnoxious and totally illogical restriction provided:
      # (try_begin),
        # #1) there is an actual fight
        # (gt, "$g_main_attacker_agent", 0),
        # (agent_is_alive, "$g_main_attacker_agent"),
        # (neg|agent_is_wounded, "$g_main_attacker_agent"),
        # #2) the player is the lord of this town, a mercenary captain in the kingdom's employ, or ruler of this kingdom
        # (store_faction_of_party , ":center_faction", "$g_encountered_party"),
        # (this_or_next|eq, ":center_faction", "$players_kingdom"),
          # (eq, ":center_faction", "fac_player_supporters_faction"),
      # (else_try),
		# #Else, original behavior:
			(start_mission_conversation, ":tavernkeeper"),
		# (try_end),
		##diplomacy stop+
	  ]),
    #SB : drunks are totally effective fighters
    (3, 0, 0,[
      (eq, "$talk_context", tc_tavern_talk),
      (ge, "$g_start_belligerent_drunk_fight", 1),
      (gt, "$g_main_attacker_agent", 0),
      (agent_is_alive, "$g_main_attacker_agent"),
      # (eq, "$g_belligerent_drunk_leaving", 0), #don't stumble while leaving
      (store_random_in_range, ":random_no", 0, 3),
      (eq, ":random_no", 0),
    ],[
      # (store_random_in_range, ":anim", "anim_strike_chest_front_stop", "anim_cheer"),
      (store_random_in_range, ":anim", "anim_strike3_head_left", "anim_fall_face_hold"),
      (agent_set_animation, "$g_main_attacker_agent", ":anim"),
      (store_random_in_range, ":progress", 0, 100),
      (agent_set_animation_progress, "$g_main_attacker_agent", ":progress"),
    ]),
	  #Check for weapon in hand of attacker, also, everyone gets out of the way
    (1, 0, 0,[
      (gt, "$g_main_attacker_agent", 0),
    ],[
      (agent_get_wielded_item, ":wielded_item", "$g_main_attacker_agent", 0),
      (val_max, "$g_attacker_drawn_weapon", ":wielded_item"),
      (call_script, "script_neutral_behavior_in_fight"),
    ]),
  ] + bodyguard_triggers,
),

# This template is used in party encounters and such.
#
("conversation_encounter",0,-1, "Conversation_encounter",[
    (0,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (1,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (2,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (3,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (4,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (5,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (6,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (7,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (8,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (9,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (10,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (11,mtef_visitor_source,af_override_fullhelm,0,1,[]),
  #prisoners now...
    (12,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (13,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (14,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (15,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (16,mtef_visitor_source,af_override_fullhelm,0,1,[]),
  #Other party
    (17,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (18,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (19,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (20,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (21,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (22,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (23,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (24,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (25,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (26,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (27,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (28,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (29,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (30,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (31,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (32,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (33,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (34,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (35,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (36,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (37,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (38,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (39,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (40,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (41,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (42,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (43,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (44,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (45,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (46,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (47,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (48,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (49,mtef_visitor_source,af_override_fullhelm,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent"),
      (agent_is_active, ":agent"),
      (agent_is_human, ":agent"),
      (agent_get_troop_id, ":troop", ":agent"),
      (try_begin),
          (call_script, "script_cf_dplmc_troop_is_female", ":troop"),
          (agent_set_animation, ":agent", "anim_vyrn_shieldmaiden_stand"),
          (store_random_in_range,reg0, 0, 100),
          (agent_set_animation_progress, ":agent", reg0),
      (try_end),
    ]),
    # freindly greetings (after 0.35 secs)
    (0, 0.35, ti_once, [],[
      (eq,"$party_meeting",1), # friendly
      (try_for_agents,":agent"),
          (agent_is_human, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (call_script, "script_dplmc_store_troop_is_female", ":troop"),
          (eq, reg0, 0),
          #(agent_get_entry_no,":e",":agent"),
          (try_begin),
              #(eq,":e",17),
              (agent_get_troop_id, ":trp", ":agent"),
              (neg|is_between, ":trp", "trp_looter", bandits_end),
              (neg|is_between, ":trp", kingdom_ladies_begin, kingdom_ladies_end),
              #(troop_get_type, ":race", ":trp"),
              # (store_troop_faction, ":fac", ":trp"),
              # (neq, ":faction", "fac_deserters"),
              # (neg|faction_slot_eq, ":fac", slot_faction_culture, "fac_culture_4"),
              # (neg|faction_slot_eq, ":fac", slot_faction_culture, "fac_culture_3"),
              # (neg|faction_slot_eq, ":fac", slot_faction_culture, "fac_culture_2"),
              # (neg|faction_slot_eq, ":fac", slot_faction_culture, "fac_culture_1"),
              #(assign, ":greet_ani", -1),
              # (this_or_next|is_between,  ":race", tf_orc_begin, tf_orc_end),(neg|faction_slot_eq, ":fac", slot_faction_rank, 0),
              # (try_begin), (is_between,  ":race", tf_elf_begin, tf_elf_end),
                # (assign, ":greet_ani", "anim_greet_elf"),
              # (else_try), (eq,  ":race", tf_orc),
                # (assign, ":greet_ani", "anim_greet_orc"),
              # (else_try),
                # (this_or_next|eq, ":fac", "fac_gondor"),
                # (this_or_next|eq, ":fac", "fac_umbar"),
                # (eq, ":fac", "fac_rohan"),
                # (assign, ":greet_ani", "anim_greet_human"),
              # (else_try), (is_between,  ":race", tf_orc_begin, tf_orc_end),  # other orcs
                # (assign, ":greet_ani", "anim_greet_goaway"),
              # (else_try), # all others
              (assign, ":greet_ani", "anim_greet_simple"),
              # (try_end),
              (try_begin),
                  (gt,":greet_ani",0),
                  (agent_get_horse,reg1,":agent"),
                  (try_begin),
                      (ge,reg1,0),
                      (val_add, ":greet_ani", 1),
                  (try_end),
                  (agent_set_animation, ":agent", ":greet_ani"),
                  (store_random_in_range,reg0,0,100),
                  (agent_set_animation_progress, ":agent", reg0),
              (try_end),
          # (else_try),
            # (agent_set_animation, ":agent", "anim_stand"),
            # (store_random_in_range,reg0,0,100),
            # (agent_set_animation_progress, ":agent", reg0),
          (try_end),
      (try_end)
    ]),
]),

("conversation_encounter_special",0,-1,
  "Conversation_encounter",[
    (0,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (1,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (2,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (3,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (4,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (5,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (6,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (7,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (8,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (9,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (10,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (11,mtef_visitor_source,af_override_fullhelm,0,1,[]),
  #prisoners now...
    (12,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (13,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (14,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (15,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (16,mtef_visitor_source,af_override_fullhelm,0,1,[]),
  #Other party
    (17,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (18,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (19,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (20,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (21,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (22,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (23,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (24,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (25,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (26,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (27,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (28,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (29,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (30,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (31,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (32,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (33,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (34,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (35,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (36,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (37,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (38,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (39,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (40,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (41,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (42,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (43,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (44,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (45,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (46,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (47,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (48,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (49,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (50,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (51,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (52,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (53,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (54,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (55,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (56,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (57,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (58,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (59,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (60,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (61,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (62,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (63,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (64,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (65,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (66,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (67,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (68,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (69,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (70,mtef_visitor_source,af_override_fullhelm,0,1,[]),
  ], p_wetter +global_common_triggers +
  [
    cannot_spawn_commoners,
    (ti_tab_pressed, 0, 0,[
      (display_message, "str_cannot_leave_now"),
    ],[]),

    improved_lightning,

    (0, 0, ti_once, [],[
      (assign, ":target", 13),
      (try_for_agents, ":agent"),
          (agent_get_entry_no, ":entry", ":agent"),
          (this_or_next|eq, ":entry", 10),
          (eq, ":entry", 11),
          (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 0),
      (else_try),
          (eq, ":entry", 0),
          (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 50),
          (entry_point_get_position, pos12, ":target"),
          (agent_set_scripted_destination, ":agent", pos12),
          (val_add, ":target", 1),
      (else_try),
          (call_script, "script_init_town_agent", ":agent"),
      (try_end),
      (mission_disable_talk),
    ]),

    (ti_on_agent_spawn, 0,0, [(eq, "$temp2", -1),],[
      (store_trigger_param_1, ":agent"),
      (agent_get_troop_id, ":troop", ":agent"),
      (eq, ":troop", "$temp"),
      (assign, "$temp2", ":agent"),
    ]),

    (1, 1, 1, [
      (neg|conversation_screen_is_active),
      (eq, "$temp3", 0),],
    [
      (agent_is_active, "$temp2"),
      (agent_get_position, pos12, "$temp2"),
      (get_player_agent_no, ":player_agent"),
      (agent_get_position, pos13, ":player_agent"),
      (get_distance_between_positions, reg22, pos12,pos13),
      (le, reg22, 450),
      (mission_enable_talk),
      (start_mission_conversation, "$temp"),
      (assign, "$temp3", 1),
  ]),
]),

("town_center",0,-1,
  "Default town visit",[
    (0,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
    (1,mtef_scene_source|mtef_team_0,0,0,1,[]),
    (2,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
    (3,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
    (4,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
    (5,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
    (6,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
    (7,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (14,mtef_scene_source,0,0,1,[]),
    (15,mtef_scene_source,0,0,1,[]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),
    (17,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (18,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (19,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (20,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (21,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (22,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (23,mtef_visitor_source,af_override_horse,0,1,[]), #guard
    (24,mtef_visitor_source,af_override_horse,0,1,[]), #guard
    (25,mtef_visitor_source,af_override_horse,0,1,[]), #guard
    (26,mtef_visitor_source,af_override_horse,0,1,[]), #guard
    (27,mtef_visitor_source,af_override_horse,0,1,[]), #guard
    (28,mtef_visitor_source,af_override_horse,0,1,[]), #guard
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#town walker point
    (33,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#town walker point
    (34,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#town walker point
    (35,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#town walker point
    (36,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#town walker point
    (37,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#town walker point
    (38,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#town walker point
    (39,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#town walker point
    (40,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]), #in towns, can be used for guard reinforcements
    (41,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]), #special merchant in rome
    (42,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]), #special merchant in rome
    (43,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]), #special merchant in rome
    (44,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]), #special merchant in rome
    (45,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (46,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (47,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (48,mtef_visitor_source,af_override_horse,0,1,[]),
    (49,mtef_visitor_source,af_override_horse,0,1,[]),
    (50,mtef_visitor_source,af_override_horse,0,1,[]),
    (51,mtef_visitor_source,af_override_horse,0,1,[]),
    (52,mtef_visitor_source,af_override_horse,0,1,[]),
    (53,mtef_visitor_source,af_override_horse,0,1,[]),
    (54,mtef_visitor_source,af_override_horse,0,1,[]),
    (55,mtef_visitor_source,af_override_horse,0,1,[]),
    (56,mtef_visitor_source,af_override_horse|af_castle_lord,0,1,[]),
    (57,mtef_visitor_source,af_override_horse|af_castle_lord,0,1,[]),
    (58,mtef_visitor_source,af_override_horse|af_castle_lord,0,1,[]),
    (59,mtef_visitor_source,af_override_horse,0,1,[]),
    (60,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    can_spawn_commoners,
    improved_lightning,
    (1,0,ti_once, [
      (eq, "$current_town","p_town_6"),
      (troop_slot_eq, "trp_christ",slot_troop_days_on_mission, 0),
    ],[
      (store_random_in_range, ":rand", 0,100),
      (lt, ":rand", 45), #45% chance to have someone beeing punished
      (try_begin),
          (store_faction_of_party, ":fac", "$current_town"),
          (faction_slot_ge, ":fac", dplmc_slot_faction_serfdom, -2),

          (get_player_agent_no, ":player_agent"),
          (set_fixed_point_multiplier, 100),
          (entry_point_get_position, pos1, 53),

          (set_spawn_position, pos1),
          (spawn_agent, "trp_slave"),
          (assign, "$alpha_animal", reg0),
          (agent_set_no_death_knock_down_only, "$alpha_animal", 1),
          (agent_add_relation_with_agent, ":player_agent", "$alpha_animal", 0),
          (entry_point_get_position, pos1, 53),
          (position_move_y, pos1, 500),
          (position_move_x, pos1, -50),
          (set_spawn_position, pos1),
          (try_for_range, ":unused", 0, 2),
              (spawn_agent, "trp_christ"),
              (assign, ":agent", reg0),
              (agent_add_relation_with_agent, ":agent", "$alpha_animal", -1),
              (agent_add_relation_with_agent, ":player_agent", ":agent", 0),
              (agent_set_is_alarmed, ":agent", 1),
              (agent_ai_set_always_attack_in_melee, ":agent", 1),
              (agent_ai_set_aggressiveness, ":agent", 1000),
              (try_for_range, ":item_slot", 0, 4),
                  (agent_get_item_slot,  ":item", ":agent", ":item_slot"),
                  (gt, ":item", -1),
                  (agent_unequip_item, ":agent", ":item"),
              (try_end),
              (agent_equip_item, ":agent", "itm_club"),
              (agent_set_wielded_item, ":agent", "itm_club"),
              (position_move_x, pos1, 100),
              (set_spawn_position, pos1),
          (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, [
    ],[
      (neq, "$talk_context", tc_escape),
      (neq, "$talk_context", tc_prison_break),
      (try_for_agents, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_is_human, ":agent_no"),
          (agent_is_alive, ":agent_no"),
          (call_script, "script_init_town_agent", ":agent_no"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, [],
    [(assign, "$g_main_attacker_agent", 0),]),

    (1, 0, ti_once,[],[
      (try_begin),
        (eq, "$g_mt_mode", tcm_default),
        (store_current_scene, ":cur_scene"),
        (scene_set_slot, ":cur_scene", slot_scene_visited, 1),
      (try_end),
      (call_script, "script_init_town_walker_agents"),
      (try_begin),
        (gt, "$sneaked_into_town", disguise_none),
        (call_script, "script_music_set_situation_with_culture", mtf_sit_town_infiltrate),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0,[],[
      (call_script, "script_change_banners_and_chest")
    ]),

    (ti_inventory_key_pressed, 0, 0,[
      (try_begin),
        (eq, "$g_mt_mode", tcm_default),
        (set_trigger_result,1),
      (else_try),
        (eq, "$g_mt_mode", tcm_disguised),
        (display_message,"str_cant_use_inventory_disguised"),
      (else_try),
        (display_message, "str_cant_use_inventory_now"),
      (try_end),
    ],[]),
	  wounds_vc,
    (ti_tab_pressed, 0, 0,[
      (try_begin),
        (this_or_next|eq, "$talk_context", tc_escape),
        (eq, "$talk_context", tc_prison_break),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (this_or_next|eq, "$g_mt_mode", tcm_default),
        (eq, "$g_mt_mode", tcm_disguised),
        (mission_enable_talk),
        (set_trigger_result,1),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ],[]),

    (ti_on_leave_area, 0, 0,[
      (try_begin),
        (eq, "$g_defending_against_siege", 0),
        (assign,"$g_leave_town",1),
      (try_end),
    ],[
      (try_begin),
        (eq, "$talk_context", tc_escape),
        (call_script, "script_deduct_casualties_from_garrison"),
        (jump_to_menu,"mnu_sneak_into_town_caught_dispersed_guards"),
      (try_end),
      (mission_enable_talk),
    ]),

    (0, 0, ti_once,[],[
      (party_slot_eq, "$current_town", slot_party_type, spt_town),
      (call_script, "script_town_init_doors", 0),
      (try_begin),
        (eq, "$town_nighttime", 0),
        (play_sound, "snd_town_ambiance", sf_looping),
      (try_end),
    ]),

    (3, 0, 0,[
      (call_script, "script_tick_town_walkers")
    ],[]),

    (2, 0, 0,[
      (call_script, "script_center_ambiance_sounds")
    ],[]),

    #JAILBREAK TRIGGERS
    #Civilians get out of the way
    (1, 0, 0,[
	    (this_or_next|eq, "$talk_context", tc_prison_break),
      (eq, "$talk_context", tc_escape),
	  ],[
      (call_script, "script_neutral_behavior_in_fight"),
      (mission_disable_talk),
    ]),
    (ti_on_agent_spawn, 0, 0, [
      (this_or_next|eq, "$talk_context", tc_escape),
      (eq, "$talk_context", tc_prison_break),
    ],[
      (store_trigger_param_1, ":agent_no"),
      (agent_get_troop_id, ":troop_no", ":agent_no"),
      (troop_get_slot, ":will_join_prison_break", ":troop_no", slot_troop_will_join_prison_break),
      (eq, ":will_join_prison_break", 1),
      (display_message, "@Check 1"),
      (agent_ai_set_aggressiveness, ":agent_no", 5),
      (troop_set_slot, ":troop_no", slot_troop_will_join_prison_break, 0),
      (agent_set_is_alarmed, ":agent_no", 1),
      (agent_set_team, ":agent_no", 0),
      (try_begin),
        (troop_slot_eq, ":troop_no", slot_troop_mission_participation, mp_prison_break_stand_back),
        (agent_get_position, pos1, ":agent_no"),
        (agent_set_scripted_destination, ":agent_no", pos1),
      (try_end),
    ]),
	  #The game begins with the town alerted
    (1, 0, ti_once,[
      #If I set this to 1, 0, ti_once, then the prisoner spawns twice
      (eq, "$talk_context", tc_escape),
    ],[
      (get_player_agent_no, ":player_agent"),
      (assign, reg6, ":player_agent"),
      (call_script, "script_activate_town_guard"),
      (agent_get_team, ":player_team", ":player_agent"),
      (try_for_range, ":prisoner", active_npcs_begin, kingdom_ladies_end),
        (troop_slot_ge, ":prisoner", slot_troop_mission_participation, mp_prison_break_fight),
        (str_store_troop_name, s4, ":prisoner"),
        (display_message, "str_s4_joins_prison_break"),
        # (store_current_scene, ":cur_scene"), #this might be a better option? redundant?
        # (modify_visitors_at_site, ":cur_scene"),

        #<entry_no>,<troop_id>,<number_of_troops>, <team_no>, <group_no>),
        #team no and group no are used in multiplayer mode only. default team in entry is used in single player mode
        (store_current_scene, ":cur_scene"),
        (modify_visitors_at_site, ":cur_scene"),
        (add_visitors_to_current_scene, 24, ":prisoner", 1, ":player_team", 0),
        (troop_set_slot, ":prisoner", slot_troop_will_join_prison_break, 1),
      (try_end),
	  ]),
    (3, 0, 0,[
      (main_hero_fallen, 0),
    ],[
      (try_begin),
        (this_or_next|eq, "$talk_context", tc_prison_break),
        (eq, "$talk_context", tc_escape),
        (call_script, "script_deduct_casualties_from_garrison"),
        (jump_to_menu,"mnu_captivity_start_castle_defeat"),
        (assign, ":end_cond", kingdom_ladies_end),
        (try_for_range, ":prisoner", active_npcs_begin, ":end_cond"),
          (troop_set_slot, ":prisoner", slot_troop_mission_participation, 0), #new
        (try_end),
        (mission_enable_talk),
        (finish_mission, 0),
      (else_try),
        (set_trigger_result,1),
      (try_end),
    ]),

    (3, 0, 0,[
      (eq, "$talk_context", tc_escape),
      (neg|main_hero_fallen,0),
      (store_mission_timer_a, ":time"),
      (ge, ":time", 10),

      (all_enemies_defeated), #1 is default enemy team for in-town battles
    ],[
      (call_script, "script_deduct_casualties_from_garrison"),
      (try_for_agents, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (troop_slot_ge, ":troop", slot_troop_mission_participation, mp_prison_break_fight),
        (try_begin),
          (agent_is_alive, ":agent"),
          (troop_set_slot, ":troop", slot_troop_mission_participation, mp_prison_break_escaped),
        (else_try),
          (troop_set_slot, ":troop", slot_troop_mission_participation, mp_prison_break_caught),
        (try_end),
      (try_end),
      (jump_to_menu,"mnu_sneak_into_town_caught_ran_away"),
      (mission_enable_talk),
      (finish_mission,0)
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent_no"),
      (store_trigger_param_2, ":killer_agent_no"),
      (agent_get_troop_id, ":dead_agent_troop_no", ":dead_agent_no"),
      (agent_get_troop_id, ":killer_agent_troop_no", ":killer_agent_no"),
      (try_begin),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_dacian_prision_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_caucasian_prison_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_celtic_prison_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_sarmatian_prison_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_germanic_prison_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_eastern_prison_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_batava_prison_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_jew_prison_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_bosporan_prison_guard"),
        (eq, ":dead_agent_troop_no", "trp_roman_prison_guard"),
        (eq, ":killer_agent_troop_no", "trp_player"),
        (display_message, "@You got keys to the dungeon.", message_alert),
      (else_try), #SB : do this here instead of post-combat
        (troop_is_hero, ":dead_agent_troop_no"),
        (troop_slot_ge, ":dead_agent_troop_no", slot_troop_mission_participation, mp_prison_break_fight),
        (troop_set_slot, ":dead_agent_troop_no", slot_troop_mission_participation, mp_prison_break_caught),
      (try_end),
    ]),

    ambient_scene_play_loop,
    ambient_scene_play_random_sound,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]+ bodyguard_triggers,),

("village_center",0,-1,
  "village center",[
    (0,mtef_scene_source|mtef_team_0,0,0,1,[]),
    (1,mtef_scene_source|mtef_team_0,0,0,1,[]),
    (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),

    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,0,0,1,[]),
    (14,mtef_visitor_source,0,0,1,[]),
    (15,mtef_visitor_source,0,0,1,[]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),
    (17,mtef_visitor_source,af_override_horse,0,1,[]),
    (18,mtef_visitor_source,af_override_horse,0,1,[]),
    (19,mtef_visitor_source,af_override_horse,0,1,[]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_horse,0,1,[]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
    (23,mtef_visitor_source,af_override_horse,0,1,[]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse,0,1,[]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source,af_override_horse,0,1,[]),
    (33,mtef_visitor_source,af_override_horse,0,1,[]),
    (34,mtef_visitor_source,af_override_horse,0,1,[]),
    (35,mtef_visitor_source,af_override_horse,0,1,[]),
    (36,mtef_visitor_source,af_override_horse,0,1,[]),
    (37,mtef_visitor_source,af_override_horse,0,1,[]),
    (38,mtef_visitor_source,af_override_horse,0,1,[]),
    (39,mtef_visitor_source,af_override_horse,0,1,[]),
    (40,mtef_visitor_source,af_override_horse,0,1,[]),
    (41,mtef_visitor_source,af_override_horse,0,1,[]),
    (42,mtef_visitor_source,af_override_horse,0,1,[]),
    (43,mtef_visitor_source,af_override_horse,0,1,[]),
    (44,mtef_visitor_source,af_override_horse,0,1,[]),
    (45,mtef_visitor_source,af_override_horse,0,1,[]),
    (46,mtef_visitor_source,af_override_horse,0,1,[]),
    (47,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + storms +global_common_triggers +
  [
    can_spawn_commoners,
    improved_lightning,

    (1, 0, ti_once, [],[
      (store_current_scene, ":cur_scene"),
      (scene_set_slot, ":cur_scene", slot_scene_visited, 1),
      (call_script, "script_init_town_walker_agents"),
      (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
    ]),

    (ti_before_mission_start, 0, 0, [],[(call_script, "script_change_banners_and_chest")]),
    (ti_inventory_key_pressed, 0, 0, [
      (try_begin),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (neg|check_quest_succeeded, "qst_hunt_down_fugitive"),
        (neg|check_quest_failed, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", slot_quest_current_state, 1),
        (display_message, "str_cant_use_inventory_now"),
      (else_try),
        (set_trigger_result,1),
      (try_end),
    ],[]),
    (ti_on_leave_area, 0, 0, [
      (try_begin),
        (assign,"$g_leave_town",1),
      (try_end),
    ],[]),
    (3, 0, 0, [(call_script, "script_tick_town_walkers")],[]),
    (2, 0, 0, [(call_script, "script_center_ambiance_sounds")],[]),

    (0,0,ti_once,[
      (neg|conversation_screen_is_active),
      (check_quest_active, "qst_blank_quest_10"),
      (neg|check_quest_succeeded, "qst_blank_quest_10"),
      (neg|check_quest_failed, "qst_blank_quest_10"),
      (quest_slot_eq, "qst_blank_quest_10", slot_quest_target_center, "$current_town"),
      (quest_slot_eq, "qst_blank_quest_10", slot_quest_current_state, 1),
      (quest_get_slot, ":troop", "qst_blank_quest_10", slot_quest_target_troop),
      (try_for_agents, ":cur_agent"),
        (agent_is_alive,":cur_agent"),
        (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
        (eq, ":cur_agent_troop", ":troop"),
        (agent_set_team, ":cur_agent", 1),
        (agent_set_is_alarmed, ":cur_agent", 1),
        (agent_ai_set_aggressiveness, ":cur_agent", 10),
        #				(team_give_order, 1, grc_everyone, mordr_charge),
      (try_end),
      (team_set_relation, 0, 1, -1),
      (team_set_relation, 1, 0, -1),
    ],[]),
    (0.25,0,ti_once,[
      (is_currently_night),
      (check_quest_active, "qst_blank_quest_13"),
      (neg|check_quest_succeeded, "qst_blank_quest_13"),
      (neg|check_quest_failed, "qst_blank_quest_13"),
      (get_player_agent_no, ":player_agent"),
      (agent_get_position, pos5, ":player_agent"),
      (store_random_in_range, ":rand_entry", 30, 40),
      # (entry_point_get_position, pos1, "$temp2"),
      # (get_distance_between_positions, ":distance", pos1, pos5),
      # (lt, ":distance", 400),
      (add_visitors_to_current_scene, ":rand_entry", "trp_asturias_veteran", 1),
      (quest_set_slot, "qst_blank_quest_13", slot_quest_current_state, 1),
    ],[]),
    (ti_on_agent_spawn, 0, 0, [],[
      (try_begin),
        (check_quest_active, "qst_blank_quest_13"),
        (neg|check_quest_succeeded, "qst_blank_quest_13"),
        (neg|check_quest_failed, "qst_blank_quest_13"),
        (store_trigger_param_1, ":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (eq, ":troop_no", "trp_asturias_veteran"),
        (agent_set_team, ":agent_no", 1),
        (agent_set_is_alarmed, ":agent_no", 1),
        (agent_ai_set_aggressiveness, ":agent_no", 10),
        (team_set_relation, 0, 1, -1),
        (team_set_relation, 1, 0, -1),
        (team_give_order, 1, grc_everyone, mordr_charge),
        (agent_set_no_death_knock_down_only, ":agent_no", 1),
        (assign, "$temp", 0),
        (quest_set_slot, "qst_blank_quest_13", slot_quest_current_state, 1),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_blank_quest_10"),
        (neg|check_quest_succeeded, "qst_blank_quest_10"),
        (neg|check_quest_failed, "qst_blank_quest_10"),
        (store_trigger_param_1, ":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (quest_get_slot, ":troop", "qst_blank_quest_10", slot_quest_target_troop),
        (eq, ":troop_no",":troop"),
        (assign, "$temp2", 0),
      (try_end),
    ]),
    (ti_on_agent_knocked_down, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent"),
      (agent_get_troop_id, ":troop", ":dead_agent"),
      (eq, ":troop", "trp_asturias_veteran"),
      (val_add, "$temp", 1),
      (try_begin),
        (gt, "$temp", 2),
        (agent_set_no_death_knock_down_only, ":dead_agent", 0),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (check_quest_active, "qst_blank_quest_13"),
      (store_trigger_param_1, ":dead_agent"),
      (agent_get_troop_id, ":troop", ":dead_agent"),
      (eq, ":troop", "trp_asturias_veteran"),
      (display_message, "@You killed the ghost"),
    ]),
    (1, 0, ti_once, [
      (check_quest_active, "qst_blank_quest_10"),
      (neg|check_quest_succeeded, "qst_blank_quest_10"),
      (neg|check_quest_failed, "qst_blank_quest_10"),
      (quest_slot_eq, "qst_blank_quest_10", slot_quest_current_state, 1),
      (quest_get_slot, ":troop", "qst_blank_quest_10", slot_quest_target_troop),
      (assign, ":not_alive", 0),
      (try_for_agents, ":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (eq, ":troop_no", ":troop"),
        (try_begin),
          (call_script, "script_cf_troop_agent_is_alive", ":troop_no"),
          (eq, "$temp2", 0),
          #							(display_message, "@agent is alive"),
          (agent_set_team, ":agent_no", 1),
          (agent_set_is_alarmed, ":agent_no", 1),
          (agent_ai_set_aggressiveness, ":agent_no", 199),
          (get_player_agent_no, ":player_agent"),
          (agent_set_look_target_agent, ":agent_no", ":player_agent"),
          (team_give_order, 1, grc_everyone, mordr_charge),
          (assign, "$temp2", 1),
        (else_try),
          (eq, "$temp2", 1),
          (neg|agent_is_alive, ":agent_no"),
          (assign, ":not_alive", 1),
        (try_end),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":not_alive", 1),
    ],[
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_village_hunt_music_defeated"),
        (call_script, "script_fail_quest", "qst_blank_quest_10"),
        (finish_mission, 4),
      (else_try),
        (quest_get_slot, ":item", "qst_blank_quest_10", slot_quest_target_item),
        (try_begin),
          (store_free_inventory_capacity, ":free_slots", "trp_player"),
          (gt, ":free_slots", 0),
          (troop_add_items, "trp_player", ":item",1),
        (else_try),
          (troop_get_inventory_capacity, ":max_inv_slot", "trp_player"),
          (assign, ":end", ":max_inv_slot"),
          (try_for_range, ":cur_inv_slot", 0, ":end"),
            (troop_get_inventory_slot, ":cur_item", "trp_player", ":cur_inv_slot"),
            (ge, ":cur_item", 0),
            (is_between, ":cur_item", food_begin, food_end),
            (troop_remove_item, "trp_player", ":cur_item"),
            (assign, ":end", 0),
          (try_end),
          (troop_add_items, "trp_player", ":item",1),
        (try_end),
        (call_script, "script_succeed_quest", "qst_blank_quest_10"),
        (call_script, "script_change_player_relation_with_center", "$current_town", -4),
      (try_end),
    ]),
    (ti_tab_pressed, 0, 0, [
      (try_begin),
        (check_quest_active, "qst_blank_quest_13"),
        (neg|check_quest_succeeded, "qst_blank_quest_13"),
        (neg|check_quest_failed, "qst_blank_quest_13"),
        (quest_slot_eq, "qst_blank_quest_13", slot_quest_current_state, 1),
        (try_begin),
          (call_script, "script_cf_troop_agent_is_alive", "trp_asturias_veteran"),
          (call_script, "script_fail_quest", "qst_blank_quest_13"),
        (else_try),
          (call_script, "script_succeed_quest", "qst_blank_quest_13"),
        (try_end),
        (set_trigger_result,1),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (neg|check_quest_succeeded, "qst_hunt_down_fugitive"),
        (neg|check_quest_failed, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", slot_quest_current_state, 1),
        (try_begin),
          (call_script, "script_cf_troop_agent_is_alive", "trp_fugitive"),
          (call_script, "script_fail_quest", "qst_hunt_down_fugitive"),
        (else_try),
          (call_script, "script_succeed_quest", "qst_hunt_down_fugitive"),
        (try_end),
        (set_trigger_result,1),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_blank_quest_10"),
        (neg|check_quest_succeeded, "qst_blank_quest_10"),
        (neg|check_quest_failed, "qst_blank_quest_10"),
        (quest_slot_eq, "qst_blank_quest_10", slot_quest_current_state, 1),
        (quest_get_slot, ":troop", "qst_blank_quest_10", slot_quest_target_troop),
        (try_begin),
          (call_script, "script_cf_troop_agent_is_alive", ":troop"),
          (call_script, "script_fail_quest", "qst_blank_quest_10"),
        (else_try),
          (call_script, "script_succeed_quest", "qst_blank_quest_10"),
        (try_end),
        (set_trigger_result,1),
      (try_end),
      (try_begin),
        (set_trigger_result,1),
      (try_end),
    ],[]),
    (1, 0, ti_once, [
      (check_quest_active, "qst_blank_quest_13"),
      (neg|check_quest_succeeded, "qst_blank_quest_13"),
      (neg|check_quest_failed, "qst_blank_quest_13"),
      (quest_slot_eq, "qst_blank_quest_13", slot_quest_current_state, 1),
      (assign, ":not_alive", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "trp_asturias_veteran"),
      (else_try),
        (assign, ":not_alive", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":not_alive", 1),
    ],[
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_village_hunt_lover_defeated"),
        (call_script, "script_fail_quest", "qst_blank_quest_13"),
        (finish_mission, 4),
      (else_try),
        (call_script, "script_succeed_quest", "qst_blank_quest_13"),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, [
      (check_quest_active, "qst_hunt_down_fugitive"), #not ti_once
      (quest_slot_eq, "qst_hunt_down_fugitive", slot_quest_target_center, "$current_town"),
      (neg|check_quest_succeeded, "qst_hunt_down_fugitive"),
    ],[
      (store_trigger_param_1, ":dead_agent_no"),
      # (store_trigger_param_2, ":killer_agent"),
      (agent_is_human, ":dead_agent_no"),
      (store_trigger_param_3, ":is_wounded"),
      (get_player_agent_no, ":player_agent"),
      (agent_get_troop_id, ":corpse", ":dead_agent_no"),
      (try_begin),
        (this_or_next|eq, ":dead_agent_no", ":player_agent"),
        (main_hero_fallen),#should be same

        (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
        # (call_script, "script_fail_quest", "qst_hunt_down_fugitive"), #do this from menu so we can reuse it
        (finish_mission, 4),
      (else_try),
        (eq, ":corpse", "trp_fugitive"),
        (party_remove_members, "$current_town", "trp_fugitive", 1),
        # (eq, ":killer_agent", ":player_agent"), #bodyguards, villagers also applicable
        (try_begin),
          (eq, ":is_wounded", 0),#killed rather than wounded
          (call_script, "script_change_player_relation_with_center", "$current_town", -2),
        (else_try),
          # (display_message, "@You leave the fugitive to villager's justice.", message_positive),
          (party_force_add_prisoners, "p_main_party", "trp_fugitive", 1),
          (quest_set_slot, "qst_hunt_down_fugitive", slot_quest_current_state, 2), #enter phase 2 of bringing him back
        (try_end),
        (agent_get_wielded_item, ":item", ":dead_agent_no", 0),
        (try_begin),
          (gt, ":item", 0),
          (store_random_in_range, ":imod", imod_plain, imod_fine),
          (troop_add_item, "trp_player", ":item", ":imod"),
          (agent_unequip_item, ":dead_agent_no", ":item"),
        (try_end),
        (call_script, "script_succeed_quest", "qst_hunt_down_fugitive"),
        (call_script, "script_deactivate_tavern_attackers"),
      (else_try), #villagers?
        (call_script, "script_change_player_relation_with_center", "$current_town", -10),
      (try_end),
    ]),

    ambient_scene_play_loop,
    ambient_scene_play_random_sound,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,

  ] + bodyguard_triggers,
),
("visit_bandit_lair",0,-1,
  "village center",[
    (0,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (1,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (2,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (3,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (4,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (5,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (6,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (7,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),

    (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (11,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
  ], p_wetter + storms +global_common_triggers +
  [
    (0, 0, ti_once,[
      (gt, "$temp_troop", 0),
      (neg|conversation_screen_is_active),
    ],[
      (start_mission_conversation, "$temp_troop"),
    ]),

    (ti_tab_pressed, 0, 0, [
    ],[
      (stop_all_sounds, 1),
      (finish_mission, 3),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
      (mission_disable_talk),
    ]),

    can_spawn_commoners,
    improved_lightning,

    (1, 0, ti_once, [],[
      (store_current_scene, ":cur_scene"),
      (scene_set_slot, ":cur_scene", slot_scene_visited, 1),
      (call_script, "script_init_town_walker_agents"),
      (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
    ]),

    (ti_before_mission_start, 0, 0, [],[(call_script, "script_change_banners_and_chest")]),

    (ti_inventory_key_pressed, 0, 0, [
      (set_trigger_result,1),
    ],[]),

    (2, 0, 0, [(call_script, "script_center_ambiance_sounds")],[]),

    (0,8,0,[],[
      (try_for_agents,":agent_no"),
        (agent_is_alive,":agent_no"),
        (agent_is_human,":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (neg|troop_is_hero, ":troop_no"),

        (assign, ":continue_walk", 0),
        (store_random_in_range, ":continue_walk", 1, 100),
        (try_begin),
          (le, ":continue_walk", 38),
          (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
          (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
          (agent_set_animation, ":agent_no", "anim_stand_man"),
          (agent_set_animation_progress, ":agent_no", 10),

          (agent_get_position, pos1, ":agent_no"),
          (store_random_in_range, ":points", 1, 12),
          (entry_point_get_position, pos2, ":points"),
          (agent_set_speed_limit, ":agent_no", 1),
          (agent_set_scripted_destination, ":agent_no", pos2),
        (try_end),
      (try_end),
    ]),

    ambient_scene_play_loop,
    ambient_scene_play_random_sound,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,

  ] + bodyguard_triggers,
),
("bandits_at_night",0,-1,
  "Default town visit",[
    (0,mtef_scene_source|mtef_team_0, af_override_horse, aif_start_alarmed, 1, pilgrim_disguise),
    (1,mtef_scene_source|mtef_team_0,0,0,1,[]),
    (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (4,mtef_visitor_source|mtef_team_0, af_override_horse, aif_start_alarmed, 1, []),
    (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),

    (8,mtef_scene_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),(10,mtef_visitor_source,af_override_horse,0,1,[]),(11,mtef_visitor_source,af_override_horse,aif_start_alarmed,1,[]),(12,mtef_visitor_source,af_override_horse,0,1,[]),(13,mtef_scene_source,0,0,1,[]),(14,mtef_scene_source,0,0,1,[]),(15,mtef_scene_source,0,0,1,[]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),(17,mtef_visitor_source,af_override_horse,0,1,[]),(18,mtef_visitor_source,af_override_horse,0,1,[]),(19,mtef_visitor_source,af_override_horse,0,1,[]),(20,mtef_visitor_source,af_override_horse,0,1,[]),(21,mtef_visitor_source,af_override_horse,0,1,[]),(22,mtef_visitor_source,af_override_horse,0,1,[]),(23,mtef_visitor_source,af_override_horse,0,1,[]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),(25,mtef_visitor_source,af_override_horse,0,1,[]),(26,mtef_visitor_source,af_override_horse,0,1,[]),(27,mtef_visitor_source,af_override_horse,aif_start_alarmed,1,[]),(28,mtef_visitor_source,af_override_horse,aif_start_alarmed,1,[]),(29,mtef_visitor_source,af_override_horse,0,1,[]),(30,mtef_visitor_source,af_override_horse,0,1,[]),(31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source,af_override_horse,0,1,[]),(33,mtef_visitor_source,af_override_horse,0,1,[]),(34,mtef_visitor_source,af_override_horse,0,1,[]),(35,mtef_visitor_source,af_override_horse,0,1,[]),(36,mtef_visitor_source,af_override_horse,0,1,[]),(37,mtef_visitor_source,af_override_horse,0,1,[]),(38,mtef_visitor_source,af_override_horse,0,1,[]),(39,mtef_visitor_source,af_override_horse,0,1,[]),
    (40,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),(41,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),(42,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),(43,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (44,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),(45,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),(46,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),(47,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    common_nobody_stalls,
    cannot_spawn_commoners,
    improved_lightning,
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (agent_get_troop_id, ":troop_no", ":agent_no"),
      (neq, ":troop_no", "trp_player"),
      (agent_set_team, ":agent_no", 1),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (call_script, "script_change_banners_and_chest")
    ]),

    common_inventory_not_available,

    (ti_tab_pressed, 0, 0,[
      (display_message, "str_cannot_leave_now"),
    ],[]),
    (ti_on_leave_area, 0, 0,[
      (try_begin),
        (eq, "$g_defending_against_siege", 0),
        (assign,"$g_leave_town",1),
      (try_end),
    ],[]),

    (0, 0, ti_once, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_ambushed),
      (set_party_battle_mode),
      (party_slot_eq, "$current_town", slot_party_type, spt_town),
      (call_script, "script_town_init_doors", 0),
    ]),
    (6, 0, 0, [],[ #deactivate stalling
      (try_for_agents, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_ai_set_always_attack_in_melee, ":agent_no", 1),
      (try_end),
    ]),
    (1, 4, ti_once,[
      (store_mission_timer_a,":cur_time"),
      (ge, ":cur_time", 5),
      (this_or_next|main_hero_fallen),
      (num_active_teams_le,1)
    ],[
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_town_bandits_failed"),
      (else_try),
        (jump_to_menu, "mnu_town_bandits_succeeded"),
      (try_end),
      (finish_mission),
    ]),
    wounds_vc,
    dedal_shield_bash,
    dedal_shield_bash_AI,

    custom_commander_critical_strike,
    miracle_battle_trigger,
    more_difficult_damage,

] + bodyguard_triggers),

  (
    "village_training", mtf_arena_fight, -1,
    "village_training",
    [(2,mtef_visitor_source|mtef_team_0,af_override_everything,aif_start_alarmed,1,[itm_practice_staff]),
     (4,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[itm_practice_staff]),
     ], p_wetter + storms +global_common_triggers +
    [
    improved_lightning,
      (ti_before_mission_start, 0, 0, [],
       [
         (assign, "$g_train_peasants_against_bandits_training_succeeded", 0),
         (call_script, "script_change_banners_and_chest"),
         ]),

      common_arena_fight_tab_press,

      (ti_question_answered, 0, 0, [],
       [
         (store_trigger_param_1,":answer"),
         (eq,":answer",0),
         (finish_mission),
         ]),

      common_inventory_not_available,

      (1, 4, ti_once,
       [
         (this_or_next|main_hero_fallen),
         (num_active_teams_le, 1)
         ],
       [
         (try_begin),
           (neg|main_hero_fallen),
           (assign, "$g_train_peasants_against_bandits_training_succeeded", 1),
         (try_end),
         (finish_mission),
         ]),
      ],
    ),

("visit_town_castle",0,-1,
  "You enter the halls of the lord.",[
    (0,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (1,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]), #for doors
    (5,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (6,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (7,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_castle_lord,0,1,[]),
    (11,mtef_visitor_source,af_castle_lord,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,0,0,1,[]),
    (14,mtef_visitor_source,0,0,1,[]),
    (15,mtef_visitor_source,0,0,1,[]),
    (16,mtef_visitor_source,af_castle_lord,0,1,[]),
    (17,mtef_visitor_source,af_castle_lord,0,1,[]),
    (18,mtef_visitor_source,af_castle_lord,0,1,[]),
    (19,mtef_visitor_source,af_castle_lord,0,1,[]),
    (20,mtef_visitor_source,af_castle_lord,0,1,[]),
    (21,mtef_visitor_source,af_castle_lord,0,1,[]),
    (22,mtef_visitor_source,af_castle_lord,0,1,[]),
    (23,mtef_visitor_source,af_castle_lord,0,1,[]),
    (24,mtef_visitor_source,af_castle_lord,0,1,[]),
    (25,mtef_visitor_source,af_castle_lord,0,1,[]),
    (26,mtef_visitor_source,af_castle_lord,0,1,[]),
    (27,mtef_visitor_source,af_castle_lord,0,1,[]),
    (28,mtef_visitor_source,af_castle_lord,0,1,[]),
    (29,mtef_visitor_source,af_castle_lord,0,1,[]),
    (30,mtef_visitor_source,af_castle_lord,0,1,[]),
    (31,mtef_visitor_source,af_castle_lord,0,1,[]),
    (32,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[]),
    (33,mtef_visitor_source,0,0,1,[]),
    (34,mtef_visitor_source,0,0,1,[]),
    (35,mtef_visitor_source,0,0,1,[]),
    (36,mtef_visitor_source,0,0,1,[]),
    (37,mtef_visitor_source,0,0,1,[]),
    (38,mtef_visitor_source,0,0,1,[]),
    (39,mtef_visitor_source,0,0,1,[]),
    (40,mtef_visitor_source,af_castle_lord,0,1,[]),
    (41,mtef_visitor_source,af_castle_lord,0,1,[]),
    (42,mtef_visitor_source,af_castle_lord,0,1,[]),
    (43,mtef_visitor_source,af_castle_lord,0,1,[]),
    (44,mtef_visitor_source,af_castle_lord,0,1,[]),
    (45,mtef_visitor_source,af_castle_lord,0,1,[]),
    (46,mtef_visitor_source,af_castle_lord,0,1,[]),
    (47,mtef_visitor_source,af_castle_lord,0,1,[]),
    (48,mtef_visitor_source,af_castle_lord,0,1,[]),
    (49,mtef_visitor_source,af_castle_lord,0,1,[]),
    (50,mtef_visitor_source,af_castle_lord,0,1,[]),
    (51,mtef_visitor_source,af_castle_lord,0,1,[]),
    (52,mtef_visitor_source,af_castle_lord,0,1,[]),
    (53,mtef_visitor_source,af_castle_lord,0,1,[]),
    (54,mtef_visitor_source,af_castle_lord,0,1,[]),
    (55,mtef_visitor_source,af_castle_lord,0,1,[]),
    (56,mtef_visitor_source,af_castle_lord,0,1,[]),
    (57,mtef_visitor_source,af_castle_lord,0,1,[]),
    (58,mtef_visitor_source,af_castle_lord,0,1,[]),
    (59,mtef_visitor_source,af_castle_lord,0,1,[]),
    (60,mtef_visitor_source,af_castle_lord,0,1,[]),
    (61,mtef_visitor_source,af_castle_lord,0,1,[]),
    (62,mtef_visitor_source,af_castle_lord,0,1,[]),
    (63,mtef_visitor_source,af_castle_lord,0,1,[]),
    (64,mtef_visitor_source,af_castle_lord,0,1,[]),
    (65,mtef_visitor_source,af_castle_lord,0,1,[]),
    (66,mtef_visitor_source,af_castle_lord,0,1,[]),
    (67,mtef_visitor_source,af_castle_lord,0,1,[]),
    (68,mtef_visitor_source,af_castle_lord,0,1,[]),
    (69,mtef_visitor_source,af_castle_lord,0,1,[]),
    (70,mtef_visitor_source,af_override_body,0,1,[itm_roman_poor5,itm_roman_poor1]),
    (71,mtef_visitor_source,af_override_body,0,1,[itm_roman_poor4,itm_roman_poor2,itm_roman_poor3]),
    (72,mtef_visitor_source,af_override_body,0,1,[itm_female_1,itm_female_2,itm_female_3]),
    (73,mtef_visitor_source,af_override_body,0,1,[itm_female_1_barb,itm_female_2_barb,itm_female_3_barb]),
    (74,mtef_visitor_source,af_override_body,0,1,[itm_roman_toga,itm_roman_toga_2,itm_roman_toga_3]),
    (75,mtef_visitor_source,af_override_body,0,1,[itm_barb_femal_rich1,itm_barb_femal_rich2]),
    (76,mtef_visitor_source,af_override_body,0,1,[itm_roman_toga,itm_roman_toga_2,itm_roman_toga_3]),
    (77,mtef_visitor_source,af_override_body,0,1,[itm_barb_femal_rich3,itm_barb_femal_rich3]),
    (78,mtef_visitor_source,af_override_body,0,1,[]),
    (79,mtef_visitor_source,af_override_body,0,1,[]),
    (80,mtef_visitor_source,af_override_body,0,1,[]),
  ], p_wetter +global_common_triggers +
  [
    (0, 0, ti_once, [
      (gt, "$auto_speak_troop", -1),
      (neg|conversation_screen_is_active),
    ],[
      (start_mission_conversation, "$auto_speak_troop"),
    ]),
    can_spawn_commoners,
    # improved_lightning,
    (0, 0, 0.5,[
      (eq, "$current_town", "p_town_6"),
      (eq, "$g_is_emperor", 1),
    ],[
      (get_player_agent_no, ":player"),
      (try_for_agents, ":agent"),
          (neq, ":agent", ":player"),
          (agent_get_troop_id, ":troop_id", ":agent"),
          (this_or_next|eq, ":troop_id", "trp_suppliciant"),
          (eq, ":troop_id", "trp_suppliciant_female"),
          (agent_set_look_target_agent, ":agent", ":player"),
      (try_end),
    ]),
    (0, 0, 0,[
      (key_clicked, key_k),
      (tutorial_message, -1),
    ],[]),
	  (1,0,ti_once,[
      (troop_slot_eq,"trp_global_variables", g_nero_intro_feast, 0),
      (eq, "$current_town", "p_town_6"),
      (store_faction_of_party, ":center_faction", "$current_town"),
      (faction_slot_eq, ":center_faction", slot_faction_ai_state, sfai_feast),
      (faction_slot_eq, ":center_faction", slot_faction_ai_object, "$current_town"),
      (neg|conversation_screen_is_active),
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@Feasts in Rome take place in the triclinium (dining room) of the Domus Augusti, the palace of Ceasar.^^(press K to finish read)"),
      (troop_set_slot,"trp_global_variables", g_nero_intro_feast, 1),
		]),
    (0, 0, 3,[
      (key_clicked, key_t),
    ],[
      (get_player_agent_no, ":agent_no"),
      (agent_set_animation, ":agent_no", "anim_blow_kiss", 1),
    ]),
    (4,1,ti_once,[],[
      (eq, "$talk_context", tc_court_talk),
      (eq, "$current_town", "p_town_6"),
      (store_random_in_range, ":rand", 0, 100),
      (assign, ":spawn_troop", "trp_slave"),
      (try_begin),
        (lt, ":rand", 50),
        (assign, ":spawn_troop", "trp_slave_female"),
      (try_end),
      (add_visitors_to_current_scene, 34, ":spawn_troop", 1, 1, 0),
    ]),
    (0,8,0,[],[
      (try_for_agents,":agent_no"),
        (agent_is_alive,":agent_no"),
        (agent_is_human,":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (this_or_next|eq, ":troop_no", "trp_slave"),
        (eq, ":troop_no", "trp_slave_female"),

        (assign, ":continue_walk", 0),
        (store_random_in_range, ":continue_walk", 1, 100),
        (try_begin),
          (le, ":continue_walk", 43),
          (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
          (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
          (agent_set_animation, ":agent_no", "anim_stand_man"),
          (agent_set_animation_progress, ":agent_no", 10),

          (agent_get_position, pos1, ":agent_no"),
          (store_random_in_range, ":points", 1, 10),
          (entry_point_get_position, pos2, ":points"),
          (agent_set_speed_limit, ":agent_no", 1),
          (agent_set_scripted_destination, ":agent_no", pos2),
        (try_end),
      (try_end),
    ]),
    (ti_after_mission_start, 0, ti_once, [
      (eq, "$auto_speak_troop", -1),
    ],[
      (try_begin),
        (this_or_next|eq, "$talk_context", tc_tavern_talk),
        (eq, "$talk_context", tc_court_talk),
        (mission_cam_set_screen_color, 0xFF736252), #roughly the colour of the menu bg
        (mission_cam_animate_to_screen_color, 0x00736252, 1500),
      (else_try),
        (mission_cam_set_screen_color, 0xFF010203), #roughly dungeon moss/lichen colours
        (mission_cam_animate_to_screen_color, 0x00000000, 3000),
      (try_end),
    ]),

	  dedal_tavern_animations,

    (0, 0, ti_once, [],[
      (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_get_troop_id, ":troop", ":agent_no"),
        (try_begin),
          (eq, "$g_is_emperor", 1),
          (this_or_next|eq, ":troop", "trp_suppliciant"),
          (eq, ":troop", "trp_suppliciant_female"),
          (store_random_in_range, ":r", 0, 51),
          (val_add, ":r", "str_emperor_request_text_1"),
          (agent_set_slot, ":agent_no", slot_agent_fatiga, ":r"),
        (try_end),

        (try_begin),
          (neg|is_between, ":troop", tavern_minstrels_begin, tavern_minstrels_end),
          (call_script, "script_init_town_agent", ":agent_no"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (call_script, "script_change_banners_and_chest"),
    ]),
    (ti_inventory_key_pressed, 0, 0,[
      (set_trigger_result,1)
    ],[]),

    (ti_tab_pressed, 0, 0,[
	    (neq, "$talk_context", tc_prison_break),
	    (set_trigger_result,1)
	  ],[]),

    (ti_on_leave_area, 0, 0,[
 	    (eq, "$talk_context", tc_prison_break),
 	  ],[
	    (display_message, "str_leaving_area_during_prison_break"),
	    (set_jump_mission, "mt_sneak_caught_fight"),
	  ]),

    (0, 0, ti_once, [],[
      (try_begin),
        (eq, "$talk_context", tc_court_talk),
        (try_begin),
          (store_faction_of_party, ":center_faction", "$current_town"),
          (faction_slot_eq, ":center_faction", slot_faction_ai_state, sfai_feast),
          (faction_slot_eq, ":center_faction", slot_faction_ai_object, "$current_town"),
          (call_script, "script_music_set_situation_with_culture", mtf_sit_feast),
          #(call_script, "script_music_set_situation_with_culture", mtf_sit_lords_hall),
        (try_end),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 0), #prison
      (try_end),
    ]),

    (0, 0, 0.5, [
      (key_is_down, key_right_mouse_button),
      (scene_prop_get_instance, ":player_chest", "spr_player_chest", 0),
      (ge, ":player_chest", 0),
      (prop_instance_get_position, pos1, ":player_chest"),
      (get_player_agent_no, ":player_agent"),
      (agent_get_position, pos2, ":player_agent"),
      (get_distance_between_positions, ":dist", pos1, pos2),
      (lt, ":dist", 250),
    ],[
      (tutorial_message, -1),
      (call_script, "script_get_chest_troop", "$current_town"),
      (assign, "$pool_troop", reg0),
      (start_presentation, "prsnt_deposit_withdraw_money"),
    ]),
    (2, 1.5, 1, [
      (scene_prop_get_instance, ":player_chest", "spr_player_chest", 0),
      (ge, ":player_chest", 0),
      (prop_instance_get_position, pos1, ":player_chest"),
      (get_player_agent_no, ":player_agent"),
      (agent_get_position, pos2, ":player_agent"),
      (get_distance_between_positions, ":dist", pos1, pos2),
      (lt, ":dist", 300),
      # (position_has_line_of_sight_to_position, pos2, pos1),
      (neg|position_is_behind_position, pos1, pos2),
      (neg|is_presentation_active, "prsnt_deposit_withdraw_money"),
      (neg|conversation_screen_is_active),
    ],[
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, 500, 500),
      (tutorial_message_set_center_justify, 1),
      (tutorial_message_set_background, 1),
      (tutorial_message, "str_chest_info"),
    ]),

    (2, 0, 1, [
      (scene_prop_get_instance, ":player_chest", "spr_player_chest", 0),
      (ge, ":player_chest", 0),
      (conversation_screen_is_active),
    ],[
      (tutorial_message, -1),
    ]),

	  ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),


("back_alley_kill_local_merchant",mtf_battle_mode,-1,
  "You enter the back alley",[
    (0,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (1,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[]),
  ], p_wetter + storms +global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    common_inventory_not_available,
    (0, 3, ti_once,[],[
      (entry_point_get_position, pos1, 0),
      (set_spawn_position, pos1),
      (add_visitors_to_current_scene, 0, "trp_local_merchant", 1, 1, 0),
    ]),
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_troop_id, ":corpse", ":agent_no"),
      (eq, ":corpse", "trp_local_merchant"),
      (agent_set_team, ":agent_no", 1),
      (agent_set_is_alarmed, ":agent_no", 1),
      (agent_ai_set_aggressiveness, ":agent_no", 1000),
      (agent_play_sound, ":agent_no", "snd_man_yell"),
      (try_begin),
          (party_slot_eq, "$qst_kill_local_merchant_center", slot_center_culture, "fac_culture_1"),
          (agent_equip_item, ":agent_no", "itm_dacian_noble2", ek_body),
          (agent_equip_item, ":agent_no", "itm_leather_boots", ek_foot),
          (agent_equip_item, ":agent_no", "itm_dacian_pileus_a_1", ek_head),
          (agent_equip_item, ":agent_no", "itm_celtic_sword1", ek_item_0),
      (else_try),
          (party_slot_eq, "$qst_kill_local_merchant_center", slot_center_culture, "fac_culture_2"),
          (agent_equip_item, ":agent_no", "itm_celtic_light7", ek_body),
          (agent_equip_item, ":agent_no", "itm_celtic_boots", ek_foot),
          (agent_equip_item, ":agent_no", "itm_celtic_sword2", ek_item_0),
      (else_try),
          (this_or_next|party_slot_eq, "$qst_kill_local_merchant_center", slot_center_culture, "fac_culture_3"),
          (party_slot_eq, "$qst_kill_local_merchant_center", slot_center_culture, "fac_culture_9"),
          (agent_equip_item, ":agent_no", "itm_scythian_light4", ek_body),
          (agent_equip_item, ":agent_no", "itm_eastern_shoe", ek_foot),
          (agent_equip_item, ":agent_no", "itm_sarmatian_ringsword_1", ek_item_0),
      (else_try),
          (party_slot_eq, "$qst_kill_local_merchant_center", slot_center_culture, "fac_culture_4"),
          (agent_equip_item, ":agent_no", "itm_germanic_light7", ek_body),
          (agent_equip_item, ":agent_no", "itm_celtic_boots", ek_foot),
          (agent_equip_item, ":agent_no", "itm_sax1", ek_item_0),
      (else_try),
          (this_or_next|party_slot_eq, "$qst_kill_local_merchant_center", slot_center_culture, "fac_culture_5"),
          (this_or_next|party_slot_eq, "$qst_kill_local_merchant_center", slot_center_culture, "fac_culture_6"),
          (party_slot_eq, "$qst_kill_local_merchant_center", slot_center_culture, "fac_culture_8"),
          (agent_equip_item, ":agent_no", "itm_sarranid_cloth_robe_fancy_2", ek_body),
          (agent_equip_item, ":agent_no", "itm_eastern_shoe_b", ek_foot),
          (agent_equip_item, ":agent_no", "itm_arabian_sword_b", ek_item_0),
      (else_try),
          (agent_equip_item, ":agent_no", "itm_roman_toga", ek_body),
          (agent_equip_item, ":agent_no", "itm_caligea", ek_foot),
          (agent_equip_item, ":agent_no", "itm_dagger", ek_item_0),
      (try_end),
    ]),
    (ti_tab_pressed, 0, 0, [
      (display_message,"str_cannot_leave_now")
    ],[]),
    (ti_before_mission_start, 0, 0, [],[
      (call_script, "script_change_banners_and_chest")
    ]),
    (0, 0, ti_once, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_ambushed),
    ]),
    (0, 0, ti_once, [
      (store_mission_timer_a,":cur_time"),
      (ge,":cur_time",1),
      (assign, ":merchant_hp", 0),
      (assign, ":player_hp", 0),
      (assign, ":merchant_hp", 0),
      (assign, ":merchant_agent", -1),
      (assign, ":player_agent", -1),
      (try_for_agents, ":agent_no"),
        (agent_get_troop_id, ":troop_id", ":agent_no"),
        (try_begin),
          (eq, ":troop_id", "trp_local_merchant"),
          (store_agent_hit_points, ":merchant_hp", ":agent_no"),
          (assign, ":merchant_agent", ":agent_no"),
        (else_try),
          (eq, ":troop_id", "trp_player"),
          (store_agent_hit_points, ":player_hp",":agent_no"),
          (assign, ":player_agent", ":agent_no"),
        (try_end),
      (try_end),
      (ge, ":player_agent", 0),
      (ge, ":merchant_agent", 0),
      (agent_is_alive, ":player_agent"),
      (agent_is_alive, ":merchant_agent"),
      (is_between, ":merchant_hp", 1, 30),
      (gt, ":player_hp", 50),
      (start_mission_conversation, "trp_local_merchant"),
    ],[]),
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent_no"),
      (agent_is_human, ":dead_agent_no"),
      (agent_get_troop_id, ":corpse", ":dead_agent_no"),

      (try_begin),
          (eq, ":corpse", "trp_player"),
          (call_script, "script_fail_quest", "qst_kill_local_merchant"),
      (else_try),
          (eq, ":corpse", "trp_local_merchant"),
          (call_script, "script_change_player_relation_with_center", "$current_town", -4),
          (call_script, "script_succeed_quest", "qst_kill_local_merchant"),
      (try_end),
      (finish_mission,5),
    ]),
    wounds_vc,
]),

("back_alley_revolt",mtf_battle_mode,charge,
    "You lead your men to battle.",
    [(0,mtef_team_0|mtef_use_exact_number,af_override_horse|af_override_weapons|af_override_head,aif_start_alarmed,4,[itm_quarter_staff]),
     (1,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[]),
     (2,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[]),
     (3,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[]),
     (4,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[]),
     (5,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[]),
     (6,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[]),
     (7,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[]),
     (8,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[]),
     (9,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[]),
     (10,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[]),
     (11,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_knife,itm_pitch_fork,itm_sickle,itm_club,itm_stones]),
     ], p_wetter + storms +global_common_triggers +
    [
    cannot_spawn_commoners,
    improved_lightning,
      common_inventory_not_available,

      common_battle_init_banner,

      (ti_tab_pressed, 0, 0, [],
       [(question_box,"str_do_you_want_to_retreat"),
        ]),
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (jump_to_menu, "mnu_collect_taxes_failed"),
        (finish_mission),]),

      (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),
      (ti_before_mission_start, 0, 0, [],[(call_script, "script_change_banners_and_chest")]),

      (0, 0, ti_once, [],
       [
         (call_script, "script_music_set_situation_with_culture", mtf_sit_fight),
         ]),

      (1, 4, ti_once, [(this_or_next|main_hero_fallen),(num_active_teams_le,1)],
       [
           (try_begin),
             (main_hero_fallen),
             (jump_to_menu, "mnu_collect_taxes_failed"),
           (else_try),
             (jump_to_menu, "mnu_collect_taxes_rebels_killed"),
           (try_end),
           (finish_mission),
           ]),
		   wounds_vc,
]),

("camp_defend",mtf_battle_mode|mtf_synch_inventory,charge,
  "You lead your men to battle.",[
    (52,mtef_ally_party|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,5,[]),#0
    (53,mtef_ally_party|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,5,[]),#1
    (54,mtef_ally_party|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,5,[]),#2
    (55,mtef_ally_party|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,5,[]),#3
    (56,mtef_ally_party|mtef_team_0|mtef_infantry_first,af_override_horse,aif_start_alarmed,16,[]),#4
    (57,mtef_ally_party|mtef_team_0|mtef_infantry_first,af_override_horse,aif_start_alarmed,16,[]),#5
    (58,mtef_ally_party|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),#6
    (59,mtef_ally_party|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),#7
    (60,mtef_enemy_party|mtef_team_1,af_override_horse,aif_start_alarmed,30,[]),#8
    (61,mtef_enemy_party|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),#9
    (62,mtef_enemy_party|mtef_team_1,af_override_horse,aif_start_alarmed,30,[]),#10
    (63,mtef_enemy_party|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),#11
  ], p_wetter + storms +global_common_triggers +
  [

    common_maritime_drowning,

    cannot_spawn_commoners,
    improved_lightning,
    common_camp_defenders_move_to_defender_position,

    (180, 0, 0, [],##changed to 3 min
    [#refill ammo of defenders every 3 minutes.
      (try_for_agents,":cur_agent"),
          (agent_is_active, ":cur_agent"),
          (agent_is_alive, ":cur_agent"),
          (agent_is_human, ":cur_agent"),
          (agent_is_ally, ":cur_agent"),
          (agent_refill_ammo, ":cur_agent"),
      (try_end),
      (display_message, "@Defenders received ammunition supplies."),
    ]),

    common_battle_init_banner,
    common_battle_player_fallen_renown_lose,
    wounds_vc,

    common_battle_tab_press,

    (240, 0, 0, [],##changed to 4 min
    [#refill ammo of defenders every two minutes.
      (try_for_agents,":cur_agent"),
        (agent_is_active, ":cur_agent"),
        (agent_is_alive, ":cur_agent"),
        (agent_is_human, ":cur_agent"),
        (agent_is_ally, ":cur_agent"),
        (agent_refill_ammo, ":cur_agent"),
      (try_end),
      (display_message, "@Received ammunition supplies."),
    ]),

    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (agent_is_active, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_is_non_player, ":agent_no"),
      (try_begin),
          (agent_is_ally, ":agent_no"),
          (agent_set_accuracy_modifier, ":agent_no", 150),
          (agent_get_troop_id, ":troop", ":agent_no"),
          (troop_is_guarantee_ranged, ":troop"),
          (assign, ":end", ek_head),
          (try_for_range, ":slot", ek_item_0, ":end"),
              (agent_get_item_slot, ":cur_weapon", ":agent_no", ":slot"),
              (gt, ":cur_weapon", -1),
              (item_get_type, ":type", ":cur_weapon"),
              (eq, ":type", itp_type_thrown),
              (agent_equip_item,":agent_no", ":cur_weapon"),
              (agent_set_wielded_item, ":agent_no", ":cur_weapon"),
              (assign, ":end", ek_item_0),
          (try_end),
      (else_try),
          (agent_set_accuracy_modifier, ":agent_no", 75),
      (try_end),
    ]),

    ##attacker do not stall
    (6, 0, 0, [],[ #Make sure attackers do not stall...
      (try_for_agents, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (neg|agent_is_ally, ":agent_no"),
        (agent_ai_set_always_attack_in_melee, ":agent_no", 1),
      (try_end),
    ]),

    #let camp defenders hold position
    (0, 0, ti_once,[
      (set_show_messages, 0),

      (team_give_order, "$defender_team", grc_archers, mordr_stand_ground),
      (team_give_order, "$defender_team", grc_archers, mordr_stand_closer),
      (team_give_order, "$defender_team", grc_archers, mordr_stand_closer),
      (team_give_order, "$defender_team", grc_archers, mordr_stand_closer),
      (team_give_order, "$defender_team_2", grc_archers, mordr_stand_ground),
      (team_give_order, "$defender_team_2", grc_archers, mordr_stand_closer),
      (team_give_order, "$defender_team_2", grc_archers, mordr_stand_closer),
      (team_give_order, "$defender_team_2", grc_archers, mordr_stand_closer),
      (try_for_agents, ":agent"),
          (agent_is_ally, ":agent"),#allies, player is always defending
          (agent_is_active, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_is_human, ":agent"),
          (agent_is_non_player, ":agent"),
          (agent_set_slot, ":agent", slot_agent_is_not_reinforcement, 1),
          (agent_get_entry_no, ":entry", ":agent"),
          (try_begin),
              (eq, ":entry", 4),
              (agent_set_division,":agent", 0),
          (else_try),
              (eq, ":entry", 5),
              (agent_set_division,":agent", 2),
          (try_end),
      (try_end),

      (team_give_order, "$defender_team", 0, mordr_hold),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),

      (entry_point_get_position, pos10, 56),
      (team_set_order_position, "$defender_team_2", 0, pos10),
      (team_set_order_position, "$defender_team", 0, pos10),

      (team_give_order, "$defender_team_2", 2, mordr_hold),
      (team_give_order, "$defender_team_2", 2, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 2, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 2, mordr_stand_closer),

      (entry_point_get_position, pos10, 57),
      (team_set_order_position, "$defender_team_2", 2, pos10),
      (team_set_order_position, "$defender_team", 2, pos10),

      (set_show_messages, 1),
    ],[]),

    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":elapsed_time"),
        (gt, ":elapsed_time", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,0),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_place_player_banner_near_inventory_bms"),

      (party_clear, "p_routed_enemies"),

      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),

      (assign,"$g_battle_won",0),
      (assign,"$defender_reinforcement_stage",0),
      (assign,"$attacker_reinforcement_stage",0),
    ]),
    (0, 0, ti_once, [],[
      (call_script, "script_place_player_banner_near_inventory"),
      (call_script, "script_combat_music_set_situation_with_culture"),
      (call_script, "script_init_death_cam"),
    ]),

    common_music_situation_update,
    common_battle_check_friendly_kills,

    (1, 0, 5, [
      (lt,"$defender_reinforcement_stage","$defender_threshold"),
      (store_mission_timer_a,":mission_time"),
      (ge,":mission_time",10),
      (store_normalized_team_count,":num_defenders", 0),
      (lt,":num_defenders",25)
    ],[
      (add_reinforcements_to_entry,6,20),
      (add_reinforcements_to_entry,7,20),
      (val_add,"$defender_reinforcement_stage",1)
    ]),

    (1, 0, 5, [
      (lt,"$attacker_reinforcement_stage","$defender_threshold"),
      (store_mission_timer_a,":mission_time"),
      (ge,":mission_time",10),
      (store_normalized_team_count,":num_attackers", 1),
      (lt,":num_attackers",18)
    ],[
      (add_reinforcements_to_entry,9,19),
      (add_reinforcements_to_entry,11,19),
      (val_add,"$attacker_reinforcement_stage",1),
    ]),

    common_battle_check_victory_condition,
    common_battle_victory_display,

    (1, 4, 0,[
      (main_hero_fallen)
    ],[
      (try_begin),
        (call_script, "script_cf_dplmc_battle_continuation"),
      (else_try),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result,-1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),
      (try_end),
    ]),

    common_battle_inventory,
    common_battle_order_panel_tick,
  ]
    + camera_controls
    + theoris_decapitation
    + ai_horn
    # + utility_triggers
    + battle_panel_triggers
    # + extended_battle_menu
    # + common_division_data + division_order_processing + real_deployment
    # + formations_triggers + AI_triggers
    ##diplomacy begin
    + dplmc_battle_mode_triggers
    ##diplomacy end
    + auxiliary_player
    + morale_triggers
    + jacobhinds_morale_triggers
   # + freelancer_fest_teams
),

("lead_charge",mtf_battle_mode|mtf_synch_inventory,charge,
  "You lead your men to battle.",[
    (1,mtef_defenders|mtef_team_0,0,aif_start_alarmed,65,[]),
    (0,mtef_defenders|mtef_team_0,0,aif_start_alarmed,0,[]),
    (4,mtef_attackers|mtef_team_1,0,aif_start_alarmed,65,[]),
    (4,mtef_attackers|mtef_team_1,0,aif_start_alarmed,0,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,
    small_battle_check,

    (ti_before_mission_start, 0, ti_once,[],[
      (try_begin),
          (ge, "$cheat_mode", 1),
          (display_message, "@Set screen colour."),
      (try_end),
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00000000, 3000),#25% alpha
    ]),

    improved_lightning,
    (2, 0, ti_once,[
      (store_mission_timer_a, reg1),
      (gt, reg1, 2),],[
      (set_show_messages, 0),
      (try_for_range, ":team", 0, 4),
        (team_give_order, ":team", grc_cavalry, mordr_mount),
        (team_give_order, ":team", sdt_harcher, mordr_mount),
      (try_end),
      (set_show_messages, 1),
    ]),

    common_battle_init_banner,
    common_battle_player_fallen_renown_lose,
    common_music_situation_update,
    wounds_vc,
    common_battle_tab_press,

    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":elapsed_time"),
        (gt, ":elapsed_time", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,0),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_place_player_banner_near_inventory_bms"),
      (party_clear, "p_routed_enemies"),
      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),
      (assign,"$g_battle_won",0),
      (assign,"$defender_reinforcement_stage",0),
      (assign,"$attacker_reinforcement_stage",0),
    ]),
    (0, 0, ti_once, [],[
      (call_script, "script_place_player_banner_near_inventory"),
      (call_script, "script_combat_music_set_situation_with_culture"),
      (call_script, "script_init_death_cam"),
    ]),
    common_battle_check_friendly_kills,

    (1, 0, 5, [
      (lt,"$defender_reinforcement_stage","$defender_threshold"),
      (store_mission_timer_a,":mission_time"),
      (ge,":mission_time",10),
      (store_normalized_team_count,":num_defenders", 0),
      (lt,":num_defenders",30),
    ],[
      (add_reinforcements_to_entry,0,45),
      (val_add,"$defender_reinforcement_stage",1)
    ]),

    (1, 0, 5, [
      (lt,"$attacker_reinforcement_stage","$defender_threshold"),
      (store_mission_timer_a,":mission_time"),
      (ge,":mission_time",10),
      (store_normalized_team_count,":num_attackers", 1),
      (lt,":num_attackers",30),
    ],[
      (add_reinforcements_to_entry,3,45),
      (val_add,"$attacker_reinforcement_stage",1),
    ]),

    common_battle_check_victory_condition,
    common_battle_victory_display,

    (1, 4, 0, [(main_hero_fallen)],[
      ##diplomacy begin
      (try_begin),
          (call_script, "script_cf_dplmc_battle_continuation"),
      (else_try),
          (assign, "$pin_player_fallen", 1),
          (str_store_string, s5, "str_retreat"),
          (call_script, "script_simulate_retreat", 10, 20, 1),
          (assign, "$g_battle_result", -1),
          (set_mission_result,-1),
          (call_script, "script_count_mission_casualties_from_agents"),
          (finish_mission,0),
      (try_end),
    ]),

    common_battle_inventory,
    common_battle_order_panel_tick,
  ]
  + improved_horse_archer_ai
  + camera_controls
  + theoris_decapitation
  + morale_triggers
  + jacobhinds_morale_triggers
  + ai_horn
  + utility_triggers + battle_panel_triggers + extended_battle_menu
  + common_division_data + division_order_processing + real_deployment
  + formations_triggers + AI_triggers
  + dplmc_battle_mode_triggers
  + auxiliary_player
),

("lead_charge_large",mtf_battle_mode|mtf_synch_inventory,charge,
  "You lead your men to battle.",[
    (0,mtef_defenders|mtef_team_0,0,aif_start_alarmed,0,[]),
    (1,mtef_defenders|mtef_team_0,0,aif_start_alarmed,5,[]),
    (2,mtef_team_2,0,aif_start_alarmed,0,[]), #not used
    (3,mtef_attackers|mtef_team_1,0,aif_start_alarmed,0,[]),
    (4,mtef_attackers|mtef_team_1,0,aif_start_alarmed,5,[]),
    #4 spawn points for infantry and 4 for cav and 4 for archers, one spawn is for everyone
    ##65/13 = 5, so 13 entries for every team
    (5,mtef_attackers|mtef_team_1|mtef_infantry_first,0,aif_start_alarmed,5,[]),  #
    (6,mtef_attackers|mtef_team_1|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (7,mtef_attackers|mtef_team_1|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (8,mtef_attackers|mtef_team_1|mtef_infantry_first,0,aif_start_alarmed,5,[]),  #

    (9,mtef_attackers|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed, 5,[]),  #
    (10,mtef_attackers|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,5,[]),  #
    (11,mtef_attackers|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
    (12,mtef_attackers|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
    #
    (13,mtef_attackers|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (14,mtef_attackers|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,5,[]),  #
    (15,mtef_attackers|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (16,mtef_attackers|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,5,[]),

    (17,mtef_defenders|mtef_team_0|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (18,mtef_defenders|mtef_team_0|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (19,mtef_defenders|mtef_team_0|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (20,mtef_defenders|mtef_team_0|mtef_infantry_first,0,aif_start_alarmed,5,[]),

    (21,mtef_defenders|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
    (22,mtef_defenders|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
    (23,mtef_defenders|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
    (24,mtef_defenders|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,5,[]),

    (25,mtef_defenders|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (26,mtef_defenders|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (27,mtef_defenders|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (28,mtef_defenders|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,5,[]),
    ##I now remove those additional reinforcements spawn points as AI is having problems with it
    ##additional cav reinforcement spawnpoints
    # (29,mtef_defenders|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,0,[]),
    # (30,mtef_attackers|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,0,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,

    (ti_before_mission_start, 0, ti_once,
    [],[
      (try_begin),
          (ge, "$cheat_mode", 1),
          (display_message, "@Set screen colour."),
      (try_end),
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00000000, 2000),#25% alpha
    ]),

    improved_lightning,
    common_battle_init_banner,
    wounds_vc,
    common_battle_player_fallen_renown_lose,
    common_fieldbattle_refill_ammo,

    (2, 0, ti_once,[#####hopefull fix dismounting cav
      (store_mission_timer_a, reg1),
      (gt, reg1, 2),],[
      (set_show_messages, 0),
      (try_for_range, ":team", 0, 4),
        (team_give_order, ":team", grc_cavalry, mordr_mount),
        (team_give_order, ":team", sdt_harcher, mordr_mount),
      (try_end),
      (set_show_messages, 1),
    ]),

    common_battle_tab_press,

    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":elapsed_time"),
        (gt, ":elapsed_time", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,0),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_place_player_banner_near_inventory_bms"),

      (party_clear, "p_routed_enemies"),

      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),

      (assign,"$g_battle_won",0),
      (assign,"$defender_reinforcement_stage",0),
      (assign,"$attacker_reinforcement_stage",0),
    ]),

    (0, 0, ti_once, [],[
      (call_script, "script_place_player_banner_near_inventory"),
      (call_script, "script_combat_music_set_situation_with_culture"),
      ##diplomacy begin
      (call_script, "script_init_death_cam"),
      # (assign, "$g_dplmc_charge_when_dead", 0),
      ##diplomacy end
    ]),
    common_music_situation_update,
    common_battle_check_friendly_kills,
    (1, 0, 5, [
      (lt,"$defender_reinforcement_stage","$defender_threshold"),
      (store_mission_timer_a,":mission_time"),
      (ge,":mission_time",10),
      (store_normalized_team_count,":num_defenders", 0),
      (lt,":num_defenders",51)
    ],[
      (add_reinforcements_to_entry,0,29),#less reinforcements
      (val_add,"$defender_reinforcement_stage",1),
    ]),

    (1, 0, 5, [
      (lt,"$attacker_reinforcement_stage","$defender_threshold"),
      (store_mission_timer_a,":mission_time"),
      (ge,":mission_time",10),
      (store_normalized_team_count,":num_attackers", 1),
      (lt,":num_attackers",51),
    ],[
      (add_reinforcements_to_entry,3,29),#less reinforcements
      (val_add,"$attacker_reinforcement_stage",1),
    ]),

    (1, 4, 0,[
      (main_hero_fallen),
    ],[
      (try_begin),
        (call_script, "script_cf_dplmc_battle_continuation"),
      (else_try),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result,-1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),
      (try_end),
    ]),

    common_battle_victory_display,
    common_battle_check_victory_condition,
    common_battle_inventory,
    common_battle_order_panel_tick,
    #skirmish_archer_ai,
  ]
  + improved_horse_archer_ai
  + theoris_decapitation
  + jacobhinds_morale_triggers
  + ai_horn
  + camera_controls
  + utility_triggers + battle_panel_triggers + extended_battle_menu + common_division_data + division_order_processing + real_deployment + formations_triggers + AI_triggers + morale_triggers
  + dplmc_battle_mode_triggers
  + auxiliary_player
),

("lead_charge_ambush",mtf_battle_mode|mtf_synch_inventory,charge,
  "You lead your men to battle.",[
    (0,mtef_enemy_party|mtef_team_0,0,aif_start_alarmed,0,[]),
    (1,mtef_enemy_party|mtef_team_0,0,aif_start_alarmed,6,[]),
    (2,mtef_team_2,0,aif_start_alarmed,0,[]), #not used
    (3,mtef_ally_party|mtef_team_1,0,aif_start_alarmed,0,[]),
    (4,mtef_ally_party|mtef_team_1,0,aif_start_alarmed,6,[]),
    #4 spawn points for infantry and 4 for cav and 4 for archers, one spawn is for everyone
    ##65/13 = 5, so 13 entries for every team
    (5,mtef_ally_party|mtef_team_1|mtef_infantry_first,0,aif_start_alarmed,5,[]),  #
    (6,mtef_ally_party|mtef_team_1|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (7,mtef_ally_party|mtef_team_1|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (8,mtef_ally_party|mtef_team_1|mtef_infantry_first,0,aif_start_alarmed,5,[]),  #

    (9,mtef_ally_party|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,5,[]),  #
    (10,mtef_ally_party|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,5,[]),  #
    (11,mtef_ally_party|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
    (12,mtef_ally_party|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
    #
    (13,mtef_ally_party|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (14,mtef_ally_party|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,5,[]),  #
    (15,mtef_ally_party|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (16,mtef_ally_party|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,5,[]),

    (17,mtef_enemy_party|mtef_team_0|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (18,mtef_enemy_party|mtef_team_0|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (19,mtef_enemy_party|mtef_team_0|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (20,mtef_enemy_party|mtef_team_0|mtef_infantry_first,0,aif_start_alarmed,5,[]),

    (21,mtef_enemy_party|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
    (22,mtef_enemy_party|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
    (23,mtef_enemy_party|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
    (24,mtef_enemy_party|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,5,[]),

    (25,mtef_enemy_party|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (26,mtef_enemy_party|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (27,mtef_enemy_party|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (28,mtef_enemy_party|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,5,[]),
    ##additional cav reinforcement spawnpoints
    # (29,mtef_defenders|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,0,[]),
    # (30,mtef_attackers|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,0,[]),
  ], p_wetter + fireball_trigger + storms +global_common_triggers +
  [
    cannot_spawn_commoners,
    (ti_before_mission_start, 0, ti_once,[],[
      (try_begin),
          (ge, "$cheat_mode", 1),
          (display_message, "@Set screen colour."),
      (try_end),
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00000000, 2000),#25% alpha
    ]),

    improved_lightning,
    #####hopefull fix dismounting cav
    (2, 0, ti_once,[
      (store_mission_timer_a, reg1),
      (gt, reg1, 2),],[
      (set_show_messages, 0),
      (try_for_range, ":team", 0, 4),
          (team_give_order, ":team", grc_cavalry, mordr_mount),
          (team_give_order, ":team", sdt_harcher, mordr_mount),
      (try_end),
      (set_show_messages, 1),
    ]),

    common_fieldbattle_refill_ammo,
    common_battle_init_banner,
    wounds_vc,
    common_battle_player_fallen_renown_lose,

    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (agent_is_active, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_is_non_player, ":agent_no"),
      (try_begin),
          (neg|agent_is_ally, ":agent_no"),
          (agent_set_accuracy_modifier, ":agent_no", 150),#was 300
          (agent_get_troop_id, ":troop", ":agent_no"),
          (troop_is_guarantee_ranged, ":troop"),
          (assign, ":end", ek_head),
          (try_for_range, ":slot", ek_item_0, ":end"),
              (agent_get_item_slot, ":cur_weapon", ":agent_no", ":slot"),
              (gt, ":cur_weapon", -1),
              (item_get_type, ":type", ":cur_weapon"),
              (eq, ":type", itp_type_thrown),
              (agent_equip_item,":agent_no", ":cur_weapon"),
              (agent_set_wielded_item, ":agent_no", ":cur_weapon"),
              (assign, ":end", ek_item_0),
              #				(agent_set_animation, ":agent_no", "anim_cheer"),
          (try_end),
      (else_try),
          (agent_get_troop_id, ":troop", ":agent_no"),
          (troop_is_guarantee_ranged, ":troop"),
          (agent_set_accuracy_modifier, ":agent_no", 75),#was 50
          (agent_set_damage_modifier,":agent_no",85), #was 75
      (try_end),
    ]),

    # hold position
    (0, 0, ti_once, [],[
      (team_give_order, "$defender_team", 0, mordr_hold),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 0, mordr_hold),
      (team_give_order, "$defender_team_2", 0, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 0, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 0, mordr_stand_closer),
      (entry_point_get_position, pos10, 7),
      (team_set_order_position, "$defender_team_2", 0, pos10),
      (team_set_order_position, "$defender_team", 0, pos10),
    ]),

    ####ambush chief effect to player and allies
    (0, 0, ti_once, [
      (eq,"$player_ambushed",3),
    ],[
      (try_for_agents, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_is_alive,":agent_no"),
          (agent_is_human,":agent_no"),
          (agent_is_ally, ":agent_no"),
          ###no fleeing or running around, I have given the defender of an ambush a moral hit, the following lines conflict with moral scripts I think
          (store_random_in_range, ":chance", 1, 101),
          (le, ":chance", 30),
          (agent_set_slot, ":agent_no",  slot_agent_is_running_away, 1),
          (agent_start_running_away, ":agent_no", 0),
      (try_end),
    ]),
  ##there is for 30 sec disorder
    (30, 0, ti_once, [
      (eq,"$player_ambushed",3),
    ],[
      (try_for_agents, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_is_alive,":agent_no"),
          (agent_is_human,":agent_no"),
          (agent_is_ally, ":agent_no"),
          (agent_slot_eq, ":agent_no",  slot_agent_is_running_away, 1),
          (agent_set_slot, ":agent_no",  slot_agent_is_running_away, 0),
          (agent_stop_running_away, ":agent_no"),
      (try_end),
    ]),
    common_battle_tab_press,

    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
          (store_mission_timer_a, ":elapsed_time"),
          (gt, ":elapsed_time", 20),
          (str_store_string, s5, "str_retreat"),
          (call_script, "script_simulate_retreat", 10, 20, 1),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,0),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_place_player_banner_near_inventory_bms"),

      (party_clear, "p_routed_enemies"),

      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),

      (assign,"$g_battle_won",0),
      (assign,"$defender_reinforcement_stage",0),
      (assign,"$attacker_reinforcement_stage",0),
    ]),
    (0, 0, ti_once, [],[
      (call_script, "script_place_player_banner_near_inventory"),
      (call_script, "script_combat_music_set_situation_with_culture"),
      ##diplomacy begin
      (call_script, "script_init_death_cam"),
    ]),

    common_music_situation_update,
    common_battle_check_friendly_kills,

    (1, 0, 5, [
      (lt,"$defender_reinforcement_stage","$defender_threshold"),
      (store_mission_timer_a,":mission_time"),
      (ge,":mission_time",10),
      (store_normalized_team_count,":num_defenders", 0),
      (lt,":num_defenders",30),
    ],[
      (add_reinforcements_to_entry,3,30),#less reinforcements
      (val_add,"$defender_reinforcement_stage",1),
    ]),

    (1, 0, 5, [
      (lt,"$attacker_reinforcement_stage","$defender_threshold"),
      (store_mission_timer_a,":mission_time"),
      (ge,":mission_time",10),
      (store_normalized_team_count,":num_attackers", 1),
      (lt,":num_attackers",30),
    ],[
      (add_reinforcements_to_entry,0,30),#less reinforcements
      (val_add,"$attacker_reinforcement_stage",1),
    ]),

    (1, 4, 0,[
      (main_hero_fallen),
    ],[
      ##diplomacy begin
      (try_begin),
          (call_script, "script_cf_dplmc_battle_continuation"),
      (else_try),
          ##diplomacy end
          (assign, "$pin_player_fallen", 1),

          (str_store_string, s5, "str_retreat"),
          (call_script, "script_simulate_retreat", 10, 20, 1),
          (assign, "$g_battle_result", -1),
          (set_mission_result,-1),
          (call_script, "script_count_mission_casualties_from_agents"),
          (finish_mission,0),
          ##diplomacy begin
      (try_end),
      ##diplomacy end
    ]),

    common_battle_victory_display,
    common_battle_check_victory_condition,
    common_battle_inventory,
    common_battle_order_panel_tick,
  ]
    + improved_horse_archer_ai
    + camera_controls
    + theoris_decapitation
    + jacobhinds_morale_triggers
    + ai_horn
    #+ utility_triggers
    + battle_panel_triggers
    #+ extended_battle_menu
    #+ common_division_data
    #+ division_order_processing
    #+ real_deployment
    #+ formations_triggers
    #+ AI_triggers
    + morale_triggers
    ##diplomacy begin
    + dplmc_battle_mode_triggers
    ##diplomacy end
    + auxiliary_player
    # + freelancer_fest_teams
),

("lead_charge_ambush_attack",mtf_battle_mode|mtf_synch_inventory,charge,
  "You lead your men to battle.",[
    (0,mtef_ally_party|mtef_team_0,0,aif_start_alarmed,0,[]),

    (1,mtef_ally_party|mtef_team_0,0,aif_start_alarmed,6,[]),

    (2,mtef_team_2,0,aif_start_alarmed,0,[]), #not used
    (3,mtef_enemy_party|mtef_team_1,0,aif_start_alarmed,0,[]),

    (4,mtef_enemy_party|mtef_team_1,0,aif_start_alarmed,6,[]),
    (5,mtef_enemy_party|mtef_team_1|mtef_infantry_first,0,aif_start_alarmed,5,[]),  #
    (6,mtef_enemy_party|mtef_team_1|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (7,mtef_enemy_party|mtef_team_1|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (8,mtef_enemy_party|mtef_team_1|mtef_infantry_first,0,aif_start_alarmed,5,[]),  #

    (9,mtef_enemy_party|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,5,[]),  #
    (10,mtef_enemy_party|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,5,[]),  #
    (11,mtef_enemy_party|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
    (12,mtef_enemy_party|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
  #
    (13,mtef_enemy_party|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (14,mtef_enemy_party|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,5,[]),  #
    (15,mtef_enemy_party|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (16,mtef_enemy_party|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,5,[]),

    (17,mtef_ally_party|mtef_team_0|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (18,mtef_ally_party|mtef_team_0|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (19,mtef_ally_party|mtef_team_0|mtef_infantry_first,0,aif_start_alarmed,5,[]),
    (20,mtef_ally_party|mtef_team_0|mtef_infantry_first,0,aif_start_alarmed,5,[]),

    (21,mtef_ally_party|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
    (22,mtef_ally_party|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
    (23,mtef_ally_party|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,5,[]),
    (24,mtef_ally_party|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,5,[]),

    (25,mtef_ally_party|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (26,mtef_ally_party|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (27,mtef_ally_party|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,5,[]),
    (28,mtef_ally_party|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,5,[]),
  ], p_wetter + fireball_trigger + storms +global_common_triggers +
  [
    # hold position
    (0, 0, ti_once, [],[
      (team_give_order, "$defender_team", 0, mordr_hold),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 0, mordr_hold),
      (team_give_order, "$defender_team_2", 0, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 0, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 0, mordr_stand_closer),
      (entry_point_get_position, pos10, 7),
      (team_set_order_position, "$defender_team_2", 0, pos10),
      (team_set_order_position, "$defender_team", 0, pos10),
    ]),

    (ti_before_mission_start, 0, ti_once,[],[
      (try_begin),
          (ge, "$cheat_mode", 1),
          (display_message, "@Set screen colour."),
      (try_end),
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00000000, 2000),#25% alpha
    ]),
    improved_lightning,
    (2, 0, ti_once,[
      (store_mission_timer_a, reg1),
      (gt, reg1, 2),],[
      (set_show_messages, 0),
      (try_for_range, ":team", 0, 4),
        (team_give_order, ":team", grc_cavalry, mordr_mount),
          (team_give_order, ":team", sdt_harcher, mordr_mount),
      (try_end),
      (set_show_messages, 1),
    ]),
	  common_fieldbattle_refill_ammo,
    common_battle_init_banner,
	  wounds_vc,
    common_battle_player_fallen_renown_lose,
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (agent_is_active, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_is_non_player, ":agent_no"),
      (try_begin),
        (agent_is_ally, ":agent_no"),
        (agent_set_accuracy_modifier, ":agent_no", 150),#was 300
        (agent_get_troop_id, ":troop", ":agent_no"),
        (troop_is_guarantee_ranged, ":troop"),
        (assign, ":end", ek_head),
        (try_for_range, ":slot", ek_item_0, ":end"),
          (agent_get_item_slot, ":cur_weapon", ":agent_no", ":slot"),
          (gt, ":cur_weapon", -1),
          (item_get_type, ":type", ":cur_weapon"),
          (eq, ":type", itp_type_thrown),
          (agent_equip_item,":agent_no", ":cur_weapon"),
          (agent_set_wielded_item, ":agent_no", ":cur_weapon"),
          (assign, ":end", ek_item_0),
          #				(agent_set_animation, ":agent_no", "anim_cheer"),
        (try_end),
      (else_try),
        (agent_get_troop_id, ":troop", ":agent_no"),
        (troop_is_guarantee_ranged, ":troop"),
        (agent_set_accuracy_modifier, ":agent_no", 75),#was 50
        (agent_set_damage_modifier,":agent_no",85), #was 75
      (try_end),
    ]),
    ##### Ambush player part, to enemy effect
    (0, 0, ti_once, [
      (eq,"$player_ambushed",4),
    ],[
      (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_alive,":agent_no"),
        (agent_is_human,":agent_no"),
        (neg|agent_is_ally, ":agent_no"),
        (store_random_in_range, ":chance", 1, 101),
        (le, ":chance", 30),
        (agent_set_slot, ":agent_no",  slot_agent_is_running_away, 1),
        (agent_start_running_away, ":agent_no", 0),
      (try_end),
    ]),
    (30, 0, ti_once, [
      (eq,"$player_ambushed",4),
    ],[
      (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_alive,":agent_no"),
        (agent_is_human,":agent_no"),
        (neg|agent_is_ally, ":agent_no"),
        (agent_slot_eq, ":agent_no",  slot_agent_is_running_away, 1),
        (agent_set_slot, ":agent_no",  slot_agent_is_running_away, 0),
        (agent_stop_running_away, ":agent_no"),
      (try_end),
    ]),
    common_battle_tab_press,
    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":elapsed_time"),
        (gt, ":elapsed_time", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,0),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_place_player_banner_near_inventory_bms"),

      (party_clear, "p_routed_enemies"),

      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),

      (assign,"$g_battle_won",0),
      (assign,"$defender_reinforcement_stage",0),
      (assign,"$attacker_reinforcement_stage",0),
    ]),

    (0, 0, ti_once, [],[
      (call_script, "script_place_player_banner_near_inventory"),
      (call_script, "script_combat_music_set_situation_with_culture"),
      ##diplomacy begin
      (call_script, "script_init_death_cam"),
      # (assign, "$g_dplmc_charge_when_dead", 0),
      ##diplomacy end
    ]),

    common_music_situation_update,
    common_battle_check_friendly_kills,

    (1, 0, 5, [
      (lt,"$defender_reinforcement_stage","$defender_threshold"),
      (store_mission_timer_a,":mission_time"),
      (ge,":mission_time",10),
      (store_normalized_team_count,":num_defenders", 0),
      (lt,":num_defenders",30)
    ],[
		   (add_reinforcements_to_entry,0,30),#less reinforcements
		   (val_add,"$defender_reinforcement_stage",1)
    ]),

    (1, 0, 5, [
      (lt,"$attacker_reinforcement_stage","$defender_threshold"),
      (store_mission_timer_a,":mission_time"),
      (ge,":mission_time",10),
      (store_normalized_team_count,":num_attackers", 1),
      (lt,":num_attackers",30)
    ],[
      (add_reinforcements_to_entry,3,30),#less reinforcements
      #(add_reinforcements_to_entry,30,10),#less reinforcements this is for additional cav reinforcement
      (val_add,"$attacker_reinforcement_stage",1)
    ]),

    (1, 4, 0,[(main_hero_fallen)
    ],[
      ##diplomacy begin
      (try_begin),
        (call_script, "script_cf_dplmc_battle_continuation"),
      (else_try),
        ##diplomacy end
        (assign, "$pin_player_fallen", 1),


        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result,-1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),
        ##diplomacy begin
      (try_end),
      ##diplomacy end
    ]),
    common_battle_victory_display,
    common_battle_check_victory_condition,
    common_battle_inventory,
    common_battle_order_panel_tick,
  ]
  + improved_horse_archer_ai
  + theoris_decapitation
  + jacobhinds_morale_triggers
  + ai_horn
  #+ utility_triggers
  + battle_panel_triggers
  #+ extended_battle_menu
  #+ common_division_data
  #+ division_order_processing
  #+ real_deployment
  #+ formations_triggers
  #+ AI_triggers
  + morale_triggers
  ##diplomacy begin
  + dplmc_battle_mode_triggers
  ##diplomacy end
  + auxiliary_player
  + camera_controls
  # + freelancer_fest_teams
),

("village_attack_bandits",mtf_battle_mode|mtf_synch_inventory,charge,
  "You lead your men to battle.",[
    (3,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (1,mtef_team_0|mtef_use_exact_number,0,aif_start_alarmed, 7,[]),
    (1,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
  ], p_wetter + storms +global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 0, 2, 1),#since we reassigne teams, must also make sure they dont kill each other
      (team_set_relation, 1, 3, 1),
      (party_clear, "p_routed_enemies"),
      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),

      (assign,"$g_battle_won",0),
      (assign,"$defender_reinforcement_stage",0),
      (assign,"$attacker_reinforcement_stage",0),
    ]),

    common_battle_tab_press,
    common_battle_init_banner,

    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20, 1),
      (assign, "$g_battle_result", -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,0),
    ]),

    (0, 0, ti_once, [],[
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (try_begin),
        (eq, "$g_mt_mode", vba_after_training),
        (add_reinforcements_to_entry, 1, 6),
      (else_try),
        (add_reinforcements_to_entry, 1, 29),
      (try_end),
      #SB : deathcam
      (call_script, "script_init_death_cam"),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    common_music_situation_update,
    common_battle_check_friendly_kills,
    common_battle_check_victory_condition,
    common_battle_victory_display,
    wounds_vc,

    (1, 4, 0,[
      (main_hero_fallen)
    ],[
      (try_begin),
        (call_script, "script_cf_dplmc_battle_continuation"),
      (else_try),
        (assign, "$pin_player_fallen", 1),


        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (try_end),
    ]),

    common_battle_inventory,
    common_battle_order_panel_tick,
  ]
  + improved_horse_archer_ai
  + camera_controls
  + theoris_decapitation
  + jacobhinds_morale_triggers
	+ morale_triggers
	+ ai_horn
  + utility_triggers + battle_panel_triggers + extended_battle_menu + common_division_data + division_order_processing + real_deployment + formations_triggers + AI_triggers
  + dplmc_battle_mode_triggers
  + auxiliary_player
),

("village_raid",mtf_battle_mode|mtf_synch_inventory,charge,
    "You lead your men to battle.",
    [
     (3,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,35,[]),
     (3,mtef_defenders|mtef_team_0,0,aif_start_alarmed,0,[]),
     (1,mtef_attackers|mtef_team_1,0,aif_start_alarmed,35,[]),
     (1,mtef_attackers|mtef_team_1,0,aif_start_alarmed,0,[]),
     ], p_wetter + storms +global_common_triggers +
    [
      cannot_spawn_commoners,
    improved_lightning,
      (ti_before_mission_start, 0, 0, [],
       [
        (team_set_relation, 0, 2, 1),#since we reassigne teams, must also make sure they dont kill each other
        (team_set_relation, 1, 3, 1),
         (party_clear, "p_routed_enemies"),
         (assign, "$g_latest_order_1", 1),
         (assign, "$g_latest_order_2", 1),
         (assign, "$g_latest_order_3", 1),
         (assign, "$g_latest_order_4", 1),

        (assign,"$g_battle_won",0),
        (assign,"$defender_reinforcement_stage",0),
        (assign,"$attacker_reinforcement_stage",0),
         ]),
      common_fieldbattle_refill_ammo,
      common_battle_tab_press,
      common_battle_init_banner,
      common_battle_player_fallen_renown_lose,

      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (assign, "$pin_player_fallen", 0),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),]),

     (0, 0, ti_once, [],[
                           #SB : deathcam
                           (call_script, "script_init_death_cam"),
                           (call_script, "script_combat_music_set_situation_with_culture"),
                           ]),

      common_music_situation_update,
      common_battle_check_friendly_kills,

      (1, 0, 5, [(lt,"$defender_reinforcement_stage","$defender_threshold"),
                 (store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_defenders", 0),
                 (lt,":num_defenders",20)],
           [(add_reinforcements_to_entry,0,45),(val_add,"$defender_reinforcement_stage",1)]),
      (1, 0, 5, [(lt,"$attacker_reinforcement_stage","$defender_threshold"),
                 (store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_attackers", 1),
                 (lt,":num_attackers",20)],
           [(add_reinforcements_to_entry,3,45),(val_add,"$attacker_reinforcement_stage",1)]),

      common_battle_check_victory_condition,
      common_battle_victory_display,
		  wounds_vc,
      (1, 4,
      ##diplomacy begin
      0,
      ##diplomacy end
      [(main_hero_fallen)],
          [
              ##diplomacy begin
              (try_begin),
                (call_script, "script_cf_dplmc_battle_continuation"),
              (else_try),
                ##diplomacy end
                (assign, "$pin_player_fallen", 1),


                (str_store_string, s5, "str_retreat"),
                (call_script, "script_simulate_retreat", 10, 20, 1),
                (assign, "$g_battle_result", -1),
                (set_mission_result,-1),
                (call_script, "script_count_mission_casualties_from_agents"),
                (finish_mission,0),
                ##diplomacy begin
              (try_end),
              ##diplomacy end
          ]),

   #SB : handle nervous man as fugitive quest
   (ti_on_agent_killed_or_wounded, 0, 0, [(check_quest_active, "qst_hunt_down_fugitive"), #not ti_once
                       (neg|check_quest_succeeded, "qst_hunt_down_fugitive"),
                       (neg|check_quest_failed, "qst_hunt_down_fugitive"),
                       (quest_slot_eq, "qst_hunt_down_fugitive", slot_quest_target_center, "$current_town"),
                       (quest_slot_eq, "qst_hunt_down_fugitive", slot_quest_current_state, 1),],
   [
    (store_trigger_param_1, ":dead_agent_no"),
    # (store_trigger_param_2, ":killer_agent"),
    (agent_is_human, ":dead_agent_no"),
    (store_trigger_param_3, ":is_wounded"),
    #(get_player_agent_no, ":player_agent"),
    (agent_get_troop_id, ":corpse", ":dead_agent_no"),
    (try_begin),
      (eq, ":corpse", "trp_fugitive"),
      # (party_remove_members, "$current_town", "trp_fugitive", 1),
      # (eq, ":killer_agent", ":player_agent"), #bodyguards, villagers also applicable
      (try_begin),
        (eq, ":is_wounded", 1),#wounded, add as prisoner since normally we don't access casualties in this mission template
        # (display_message, "@You leave the fugitive to villager's justice.", message_positive),
        (party_force_add_prisoners, "p_main_party", "trp_fugitive", 1),
        (quest_set_slot, "qst_hunt_down_fugitive", slot_quest_current_state, 2), #enter phase 2 of bringing him back
      (try_end),
      (call_script, "script_succeed_quest", "qst_hunt_down_fugitive"),
      # (call_script, "script_deactivate_tavern_attackers"),
    # (else_try), #villagers?
      # (call_script, "script_change_player_relation_with_center", "$current_town", -1),
    (try_end),
    ]),


      common_battle_inventory,
      #common_battle_order_panel,
      common_battle_order_panel_tick,
    ]
    + improved_horse_archer_ai
    + camera_controls
    + theoris_decapitation
    + morale_triggers
    + jacobhinds_morale_triggers
    + ai_horn
    + utility_triggers + battle_panel_triggers + extended_battle_menu + common_division_data + division_order_processing + real_deployment + formations_triggers + AI_triggers
    ##diplomacy begin
    + dplmc_battle_mode_triggers
    ##diplomacy end
    + auxiliary_player
   # + freelancer_fest_teams
),

  (
    "besiege_inner_battle_castle",mtf_battle_mode,-1,
    "You attack the walls of the castle...",
    [
     (0, mtef_attackers|mtef_use_exact_number|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (6, mtef_attackers|mtef_use_exact_number|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
     (7, mtef_attackers|mtef_use_exact_number|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
     (16, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,2,[]),
     (17, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,2,[]),
     (18, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,2,[]),
     (19, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,2,[]),
     (20, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     ], p_wetter +global_common_triggers +
    [
      cannot_spawn_commoners,
      (ti_before_mission_start, 0, 0, [],[(call_script, "script_change_banners_and_chest")]),
      common_battle_player_fallen_renown_lose,
      common_battle_tab_press,
      common_battle_init_banner,
     	wounds_vc,
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (assign, "$pin_player_fallen", 0),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result,-1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),
        ]),

      (0, 0, ti_once, [],[(assign,"$g_battle_won",0),
                           ##diplomacy begin
                           (call_script, "script_init_death_cam"),
                           # (assign, "$g_dplmc_charge_when_dead", 1),
                           ##diplomacy end
                           (call_script, "script_music_set_situation_with_culture", mtf_sit_ambushed),
                           ]),

      #AI Tiggers
      (0, 0, ti_once, [
          (assign, "$defender_team", 0),
          (assign, "$attacker_team", 1),
          (assign, "$defender_team_2", 2),
          (assign, "$attacker_team_2", 3),
          ],[]),

      common_battle_check_friendly_kills,
      common_battle_check_victory_condition,
      common_battle_victory_display,

      (1, 4,
      ##diplomacy begin
      0,
      ##diplomacy end
      [(main_hero_fallen)],
          [
            ##diplomacy begin
            (try_begin),
              (call_script, "script_cf_dplmc_battle_continuation"),
            (else_try),
              (assign, "$pin_player_fallen", 1),


              (str_store_string, s5, "str_retreat"),
              (call_script, "script_simulate_retreat", 5, 20, 0),
              (assign, "$g_battle_result", -1),
              (set_mission_result,-1),
              (call_script, "script_count_mission_casualties_from_agents"),
              (finish_mission,0),
            (try_end),
            ##diplomacy end
              ]),

      #common_battle_order_panel,
      common_battle_order_panel_tick,
      common_battle_inventory,
    ]
    + theoris_decapitation
    + utility_triggers + battle_panel_triggers + extended_battle_menu + common_division_data + division_order_processing + real_deployment + formations_triggers
    ##diplomacy begin
    + dplmc_battle_mode_triggers
    ##diplomacy end
    + auxiliary_player
    ),

  (
    "besiege_inner_battle_town_center",mtf_battle_mode,-1,
    "You attack the walls of the castle...",
    [
     (0, mtef_attackers|mtef_use_exact_number|mtef_team_1,af_override_horse,aif_start_alarmed,25,[]),
     (2, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,6,[]),
     (23, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,3,[]),
     (24, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,3,[]),
     (25, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
     (26, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
     (27, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
     (28, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,6,[]),
     ], p_wetter + storms +global_common_triggers +
    [
      cannot_spawn_commoners,
    improved_lightning,
    (ti_before_mission_start, 0, 0, [],[(call_script, "script_change_banners_and_chest")]),
    common_battle_player_fallen_renown_lose,
    common_battle_tab_press,
    common_battle_init_banner,
    wounds_vc,
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (assign, "$pin_player_fallen", 0),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result,-1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),
        ]),

      (0, 0, ti_once, [],[(assign,"$g_battle_won",0),
                           ##diplomacy begin
                           (call_script, "script_init_death_cam"),
                           # (assign, "$g_dplmc_charge_when_dead", 1),
                           ##diplomacy end
                           (call_script, "script_music_set_situation_with_culture", mtf_sit_ambushed),
                           ]),

      #AI Tiggers
      (0, 0, ti_once, [
          (assign, "$defender_team", 0),
          (assign, "$attacker_team", 1),
          (assign, "$defender_team_2", 2),
          (assign, "$attacker_team_2", 3),
          ],[]),

      common_battle_check_friendly_kills,
      common_battle_check_victory_condition,
      common_battle_victory_display,

      (1, 4,
      ##diplomacy begin
      0,
      ##diplomacy end
      [(main_hero_fallen)],
          [
          ##diplomacy begin
          (try_begin),
            (call_script, "script_cf_dplmc_battle_continuation"),
          (else_try),
            ##diplomacy end
            (assign, "$pin_player_fallen", 1),

            (str_store_string, s5, "str_retreat"),
            (call_script, "script_simulate_retreat", 5, 20, 0),
            (assign, "$g_battle_result", -1),
            (set_mission_result,-1),
            (call_script, "script_count_mission_casualties_from_agents"),
            (finish_mission,0),
          ##diplomacy begin
          (try_end),
          ##diplomacy end

              ]),

      #common_battle_order_panel,
      common_battle_order_panel_tick,
      common_battle_inventory,
    ]
    + theoris_decapitation
    + utility_triggers + battle_panel_triggers + extended_battle_menu + common_division_data + division_order_processing + real_deployment + formations_triggers
    ##diplomacy begin
    + dplmc_battle_mode_triggers
    ##diplomacy end
    + auxiliary_player
 ),

("castle_attack_walls_defenders_sally",mtf_battle_mode,-1,#|mtf_synch_inventory
  "You attack the walls of the castle...",[
     (0,mtef_attackers|mtef_team_1,0,aif_start_alarmed,40,[]),
     (0,mtef_attackers|mtef_team_1,0,aif_start_alarmed,0,[]),
     (3,mtef_defenders|mtef_team_0,0,aif_start_alarmed,50,[]), #dckplmc - allow defenders to use horses
     (3,mtef_defenders|mtef_team_0,0,aif_start_alarmed,0,[]),
  ], p_wetter + storms +global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,

    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_remove_siege_objects"),
    ]),
    common_battle_player_fallen_renown_lose,

    (0, 0, 3,[(key_clicked, key_t),],[
      (le, "$warcry_loading", 0),
      (get_player_agent_no, ":player"),
      (agent_is_alive, ":player"),
      (try_for_agents, ":cur_agent"),#effect
          (agent_is_human, ":cur_agent"),
          (agent_is_alive, ":cur_agent"),
          (agent_is_active,":cur_agent"),
          (agent_is_ally, ":cur_agent"),
          (neq, ":player", ":cur_agent"),
          (agent_set_damage_modifier, ":cur_agent", 105),
          (assign, "$warcry_loading", 30),
          (store_random_in_range, ":rand", 0, 100),
          (ge, ":rand", 50),
          (call_script,"script_agent_perform_warcry", ":cur_agent"),
      (try_end),
      (display_message, "str_war_cry",message_positive),
      (call_script, "script_agent_perform_warcry", ":player"),
    ]),
    (0, 0, 1,[
      (gt, "$warcry_loading", 0),
    ],[
      (val_sub, "$warcry_loading", 1),
    ]),
    (ti_on_leave_area, 0, 0,[],[
      (assign, "$pin_player_fallen", 0),
      (get_player_agent_no, ":player_agent"),
      (agent_get_team, ":agent_team", ":player_agent"),
      (try_begin),
        (neq, "$attacker_team", ":agent_team"),
        (neq, "$attacker_team_2", ":agent_team"),
        (str_store_string, s5, "str_siege_continues"),
        (call_script, "script_simulate_retreat", 8, 15, 0),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,0),
    ]),
    common_battle_tab_press,
    common_battle_init_banner,
    wounds_vc,
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent_no"),
      #(store_trigger_param_2, ":killer_agent_no"),
      (store_trigger_param_3, ":is_wounded"),

      (try_begin),
        (ge, ":dead_agent_no", 0),
        (neg|agent_is_ally, ":dead_agent_no"),
        (agent_is_human, ":dead_agent_no"),
        (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
        (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
        (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),
        (try_begin),
          (call_script, "script_cf_force_wound_troop", ":dead_agent_troop_id"),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
          (set_trigger_result, 2),
        (else_try),
          (neg|troop_is_hero, ":dead_agent_troop_id"),
          (eq, "$g_realistic_wounding", 1),
          (le, ":last_damage", 10),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
          (set_trigger_result, 2),
        (else_try),
          (neg|troop_is_hero, ":dead_agent_troop_id"),
          (eq, "$g_realistic_wounding", 1),
          (ge, ":last_damage", 40),
          (set_trigger_result, 1),
        (else_try),
          (try_begin),
            (eq, ":is_wounded", 1),
            (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
          (try_end),
          (set_trigger_result, 0),
        (try_end),
      (try_end),

      (try_begin),
        (ge, ":dead_agent_no", 0),
        (agent_is_ally, ":dead_agent_no"),
        (agent_is_human, ":dead_agent_no"),

        (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),

        (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),

        (party_get_skill_level, ":surgery", "p_main_party", skl_surgery),
        (store_mul, ":chance", ":surgery", 4),
        (val_add, ":chance", 25),
        (store_random_in_range, ":rand", 0, 100),

        (try_begin),
          (call_script, "script_cf_force_wound_troop", ":dead_agent_troop_id"),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
          (set_trigger_result, 2),
        (else_try),
          (neg|troop_is_hero, ":dead_agent_troop_id"),
          (eq, "$g_realistic_wounding", 1),
          (le, ":last_damage", 10),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
          (set_trigger_result, 2),
        (else_try),
          (neg|troop_is_hero, ":dead_agent_troop_id"),
          (eq, "$g_realistic_wounding", 1),
          (gt, ":rand", ":chance"),
          (ge, ":last_damage", 40),
          (set_trigger_result, 1),
        (else_try),
          (set_trigger_result, 0),
        (try_end),
      (try_end),
    ]),
    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 5, 20, 0),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,0),
    ]),
    (0, 0, ti_once, [],[
      (assign,"$g_battle_won",0),
      ##diplomacy begin
      (call_script, "script_init_death_cam"),
      # (assign, "$g_dplmc_charge_when_dead", 1),
      ##diplomacy end
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),
    common_music_situation_update,
    common_battle_check_friendly_kills,
    (1, 60, ti_once, [
      (store_mission_timer_a, reg(1)),
      (ge, reg(1), 10),
      (all_enemies_defeated, 2),
      (neg|main_hero_fallen,0),
      (set_mission_result,1),
      (display_message,"str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (assign, "$g_siege_sallied_out_once", 1),
      (assign, "$g_siege_method", 1), #reset siege timer
      (call_script, "script_play_victorious_sound"),
    ],[
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,1),
    ]),
    common_battle_victory_display,
    (1, 4, 0,[
      (main_hero_fallen)
    ],[
      ##diplomacy begin
      (try_begin),
        (call_script, "script_cf_dplmc_battle_continuation"),
      (else_try),
        ##diplomacy end
        (assign, "$pin_player_fallen", 1),

        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),
      ##diplomacy begin
      (try_end),
      ##diplomacy end
    ]),
    common_battle_order_panel_tick,
    common_battle_inventory,
  ]
  + improved_horse_archer_ai
  + camera_controls
  + theoris_decapitation
  + utility_triggers + battle_panel_triggers + extended_battle_menu + common_division_data + division_order_processing + real_deployment + formations_triggers
  + dplmc_battle_mode_triggers
  + auxiliary_player
),

("castle_attack_walls_ladder",mtf_battle_mode,-1,#|mtf_synch_inventory
  "You attack the walls of the castle...",[
    #defender spawns
    (16,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,11,[]),#0
    (17,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,11,[]),#1
    (18,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,11,[]),#2
    (19,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,11,[]),#3

    #attacker spawn + reinforcements
    (20,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),#4
    (20,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),#5
    (21,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),#6
    (21,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),#7
    (22,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),#8
    (22,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),  #9
    (23,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),#10
    (23,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),#11

    #defender reinforcements
    (24,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),#12
    (25,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),#13
    (26,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),#14
    (27,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),#15

    #defender archer positions
    (40,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,3,[]),
    (41,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,3,[]),
    (42,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,3,[]),
    (43,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,3,[]),
    (44,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,3,[]),
    (45,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,3,[]),
    (46,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,3,[]),
    (47,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,3,[]),
    #attacker archer positions are from 60 to 65
    #3 and 0 for sally
  ], p_wetter + storms +global_common_triggers +
  [
    cannot_spawn_commoners,
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (agent_is_active, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (try_begin),#spawn player horse
          (neg|agent_is_non_player, ":agent_no"),#player
          (agent_get_troop_id, ":troop", ":agent_no"),
          (eq, ":troop", "trp_player"),#is really player
          (neg|agent_is_defender, ":agent_no"),#player is not defender
          (troop_get_inventory_slot, ":horse", "trp_player", ek_horse),
          (gt, ":horse", 0),
          (agent_get_position, pos22, ":agent_no"),
          (set_spawn_position, pos22),
          (spawn_horse, ":horse", 0),
      (try_end),
      (try_begin),
          (agent_is_non_player, ":agent_no"),
          (try_begin),
              (agent_is_defender, ":agent_no"),
              (agent_set_accuracy_modifier, ":agent_no", 300),
              (agent_get_troop_id, ":troop", ":agent_no"),
              (troop_is_guarantee_ranged, ":troop"),
              (assign, ":end", ek_head),
              (try_for_range, ":slot", ek_item_0, ":end"),
                  (agent_get_item_slot, ":cur_weapon", ":agent_no", ":slot"),
                  (gt, ":cur_weapon", -1),
                  (item_get_type, ":type", ":cur_weapon"),
                  (eq, ":type", itp_type_thrown),
                  (agent_equip_item,":agent_no", ":cur_weapon"),
                  (agent_set_wielded_item, ":agent_no", ":cur_weapon"),
                  (assign, ":end", ek_item_0),
              (try_end),
          (else_try),
              (neg|agent_is_defender, ":agent_no"),
              (agent_get_troop_id, ":troop", ":agent_no"),
              (troop_is_guarantee_ranged, ":troop"),
              (try_begin),
                  (this_or_next|eq, ":troop", "trp_custom_balista"),
                  (eq, ":troop", "trp_ballistarii"),
                  (agent_set_accuracy_modifier, ":agent_no", 400),
                  (agent_set_reload_speed_modifier, ":agent_no", 200),
              (else_try),
                  (agent_set_accuracy_modifier, ":agent_no", 90),
              (try_end),
          (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, [
      (call_script, "script_rename_class_siege"),

      (assign, reg40, 0),
      (try_begin),
          (eq, "$g_mantlets_1", 2),
          (assign, reg40, 1),
      (else_try),
          (eq, "$temp4", 2),
          (assign, reg40, 1),
      (try_end),
      (eq, reg40, 0),
    ],[
      (replace_scene_props, "spr_siege_wall_a_remove", "spr_empty"),
      # (replace_scene_props, "spr_siege_wall_a", "spr_empty"),
      (replace_scene_props, "spr_siege_large_shield_a_remove", "spr_empty"),
      (replace_scene_props, "spr_siege_large_shield_a", "spr_empty"),
    ]),

    #check for retreats
    (30, 0, 0, [
      (eq, "$temp4", 2),# player is defender
      (ge, "$attacker_reinforcement_stage", 3),#men have died
    ],[
      # (display_message, "@Attackers commander evaluates retreat."),
      (assign, ":num_defender_dead_men", 0),
      (assign, ":num_attacker_dead_men", 0),
      (try_for_agents,":cur_agent"),#count dead agents from both teams
          (agent_is_human, ":cur_agent"),
          (try_begin),
              (agent_is_defender, ":cur_agent"),
              (try_begin),
                  (agent_is_wounded, ":cur_agent"),
                  (val_add, ":num_defender_dead_men", 1),
              (else_try),
                  (agent_is_routed, ":cur_agent"),
                  (val_add, ":num_defender_dead_men", 1),
              (else_try),
                  (neg|agent_is_alive, ":cur_agent"),
                  (val_add, ":num_defender_dead_men", 1),
              (try_end),
          (else_try),
              (try_begin),
                  (agent_is_wounded, ":cur_agent"),
                  (val_add, ":num_attacker_dead_men", 1),
              (else_try),
                  (agent_is_routed, ":cur_agent"),
                  (val_add, ":num_attacker_dead_men", 1),
              (else_try),
                  (neg|agent_is_alive, ":cur_agent"),
                  (val_add, ":num_attacker_dead_men", 1),
              (try_end),
          (try_end),
      (try_end),
      (assign, reg40, ":num_attacker_dead_men"),
      (assign, reg41, ":num_defender_dead_men"),
      # (display_message, "@Attacker casualties: {reg40}. Defender casualties: {reg41}."),

      (get_player_agent_no, ":player"),
      (try_begin),
          (agent_is_defender, ":player"),#player is defender
          (store_sub, ":total_attacker_allive", "$g_enemy_fit_for_battle", ":num_attacker_dead_men"),
          (store_sub, ":total_defender_allive", "$g_friend_fit_for_battle", ":num_defender_dead_men"),
      (else_try),#player is attacker
          (store_sub, ":total_attacker_allive", "$g_friend_fit_for_battle", ":num_attacker_dead_men"),
          (store_sub, ":total_defender_allive", "$g_enemy_fit_for_battle", ":num_defender_dead_men"),
      (try_end),
      (assign, reg30, ":total_defender_allive"),
      (assign, reg31, ":total_attacker_allive"),
      # (display_message, "@total_defender_allive: {reg30}, total_attacker_allive: {reg31}"),

      (assign, ":c", 0),
      (try_begin),#very heavy loses
          (ge, ":total_defender_allive", 70),
          (store_div,":num_attacker_dead_men_6", ":num_attacker_dead_men", 6),#
          (val_sub, ":num_attacker_dead_men_6", ":num_defender_dead_men"),
          (gt, ":num_attacker_dead_men_6", 0),
          (assign, ":c", 1),
          (display_message, "@The attackers lost 6 times more casualties than the defenders!"),
      (else_try),#attackers strength is gone
          (ge, ":total_defender_allive", 50),
          (ge, "$attacker_reinforcement_stage", 4),#men have died
          (store_mul, ":total_attacker_allive_double", ":total_attacker_allive", 2),
          (gt, ":total_defender_allive", ":total_attacker_allive_double"),
          (display_message, "@The defenders army has the double strength of the attackers army!"),
          (assign, ":c", 1),
      (else_try),
          (ge, ":total_defender_allive", 80),
          (ge, "$attacker_reinforcement_stage", 4),#men have died
          (store_div,":num_attacker_dead_men_5", ":num_attacker_dead_men", 5),#
          (val_sub, ":num_attacker_dead_men_5", ":num_defender_dead_men"),
          (gt, ":num_attacker_dead_men_5", 0),
          (assign, ":c", 1),
          (display_message, "@The attackers lost 5 times more casualties than the defenders!"),
      (else_try),
          (ge, ":total_defender_allive", 90),
          (ge, "$attacker_reinforcement_stage", 5),#men have died
          (store_div,":num_attacker_dead_men_4", ":num_attacker_dead_men", 4),#
          (val_sub, ":num_attacker_dead_men_4", ":num_defender_dead_men"),
          (gt, ":num_attacker_dead_men_4", 0),
          (display_message, "@The attackers lost 4 times more casualties than the defenders!"),
          (assign, ":c", 1),
      (try_end),
      (eq, ":c", 1),
      (display_message, "@Attackers casualties are too high. They retreat."),
      (assign, "$pin_player_fallen", 0),
      (get_player_agent_no, ":player_agent"),
      (agent_get_team, ":agent_team", ":player_agent"),
      (try_begin),
          (neq, "$attacker_team", ":agent_team"),
          (neq, "$attacker_team_2", ":agent_team"),
          (str_store_string, s5, "str_siege_continues"),
          (call_script, "script_simulate_retreat", 1, 1, 0),
      (else_try),
          (str_store_string, s5, "str_retreat"),
          (call_script, "script_simulate_retreat", 1, 1, 0),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,0),
    ]),

    #reinforcement check
    (3, 0, 5, [],[
      (store_mission_timer_a,":mission_time"),
      (ge,":mission_time",10),
      (try_begin),
          (lt, "$defender_reinforcement_stage","$siege_threshold_defender"),
          (store_normalized_team_count,":num_defenders",0),
          (le,":num_defenders",40),
          (add_reinforcements_to_entry,12, 11),
          (add_reinforcements_to_entry,13, 11),
          (add_reinforcements_to_entry,14, 11),
          (add_reinforcements_to_entry,15, 11),
          (val_add,"$defender_reinforcement_stage",1),
      (try_end),
      (try_begin),
          (lt,"$attacker_reinforcement_stage","$siege_threshold_attacker"),
          (store_normalized_team_count,":num_attackers",1),
          (lt,":num_attackers",28),
          (add_reinforcements_to_entry, 5, 12),
          (add_reinforcements_to_entry, 7, 12),
          (add_reinforcements_to_entry, 9, 12),
          (add_reinforcements_to_entry, 11, 12),
          (val_add,"$attacker_reinforcement_stage", 1),
      (try_end),
    ]),

    #let defenders hold position
    (0, 0, ti_once,[
      #set variables
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),

      (assign, "$temp4_1", 0),#for ammunition supplies of attackers

      (set_show_messages, 0),

      #give orders!
      (team_give_order, "$defender_team", grc_archers, mordr_stand_ground),
      (team_give_order, "$defender_team", grc_archers, mordr_stand_closer),
      (team_give_order, "$defender_team_2", grc_archers, mordr_stand_ground),
      (team_give_order, "$defender_team_2", grc_archers, mordr_stand_closer),
      (try_for_agents, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_is_alive, ":agent_no"),
          (agent_is_non_player, ":agent_no"),
          (agent_get_team, ":agent_team", ":agent_no"),#is a defender
          (try_begin),
              (this_or_next|eq, ":agent_team", "$defender_team"),
              (eq, ":agent_team", "$defender_team_2"),
              (agent_set_slot, ":agent_no", slot_agent_is_not_reinforcement, 1),
              (agent_get_entry_no, ":entry", ":agent_no"),
              (try_begin),
                  (eq, ":entry", 0),
                  (agent_set_division,":agent_no", 0),
              (else_try),
                  (eq, ":entry", 1),
                  (agent_set_division,":agent_no", 2),
              (else_try),
                  (eq, ":entry", 2),
                  (agent_set_division,":agent_no", 3),
              (else_try),
                  (eq, ":entry", 3),
                  (agent_set_division,":agent_no", 4),
              (try_end),
          (else_try),
              (try_begin),
                  #has a bow
                  (call_script, "script_cf_has_bow", ":agent_no"),
                  #(agent_get_troop_id, ":troop", ":agent_no"),
                  #(troop_is_guarantee_ranged, ":troop"),#archers go to archer point
                  # (agent_get_entry_no, ":entry", ":agent_no"),
                  # (try_begin),
                      # (eq, ":entry", 4),
                      # (agent_set_division,":agent_no", 5),
                  # (else_try),
                      # (eq, ":entry", 6),
                      # (agent_set_division,":agent_no", 6),
                  # (else_try),
                      # (eq, ":entry", 8),
                      # (agent_set_division,":agent_no", 7),
                  # (else_try),
                      # (eq, ":entry", 10),
                      # (agent_set_division,":agent_no", 8),
                  # (try_end),
                  (store_mod, ":division", ":agent_no", 4),
                  (val_add, ":division", 5),
                  (agent_set_division,":agent_no", ":division"),
                  # (assign, reg1, ":division"),
                  # (assign, reg2, ":agent_no"),
                  # (agent_get_troop_id, ":troop", ":agent_no"),
                  # (str_store_troop_name, s1, ":troop"),
                  # (display_message, "@{s1}: id {reg2}, division {reg1}"),
              (else_try),
                  (agent_get_entry_no, ":entry", ":agent_no"),
                  (try_begin),
                      (eq, ":entry", 4),
                      (agent_set_division,":agent_no", 0),
                  (else_try),
                      (eq, ":entry", 6),
                      (agent_set_division,":agent_no", 1),
                  (else_try),
                      (eq, ":entry", 8),
                      (agent_set_division,":agent_no", 2),
                  (else_try),
                      (eq, ":entry", 10),
                      (agent_set_division,":agent_no", 3),
                  (try_end),
              (try_end),
          (try_end),
      (try_end),

      (team_give_order, "$defender_team", 0, mordr_hold),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 0, mordr_hold),
      (team_give_order, "$defender_team_2", 0, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 0, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 0, mordr_stand_closer),
      (entry_point_get_position, pos10, 16),
      (team_set_order_position, "$defender_team_2", 0, pos10),
      (team_set_order_position, "$defender_team", 0, pos10),

      (team_give_order, "$defender_team", 2, mordr_hold),
      (team_give_order, "$defender_team", 2, mordr_stand_closer),
      (team_give_order, "$defender_team", 2, mordr_stand_closer),
      (team_give_order, "$defender_team", 2, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 2, mordr_hold),
      (team_give_order, "$defender_team_2", 2, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 2, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 2, mordr_stand_closer),
      (entry_point_get_position, pos10, 17),
      (team_set_order_position, "$defender_team_2", 2, pos10),
      (team_set_order_position, "$defender_team", 2, pos10),

      (team_give_order, "$defender_team", 3, mordr_hold),
      (team_give_order, "$defender_team", 3, mordr_stand_closer),
      (team_give_order, "$defender_team", 3, mordr_stand_closer),
      (team_give_order, "$defender_team", 3, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 3, mordr_hold),
      (team_give_order, "$defender_team_2", 3, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 3, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 3, mordr_stand_closer),
      (entry_point_get_position, pos10, 18),
      (team_set_order_position, "$defender_team_2", 3, pos10),
      (team_set_order_position, "$defender_team", 3, pos10),

      (team_give_order, "$defender_team", 4, mordr_hold),
      (team_give_order, "$defender_team", 4, mordr_stand_closer),
      (team_give_order, "$defender_team", 4, mordr_stand_closer),
      (team_give_order, "$defender_team", 4, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 4, mordr_hold),
      (team_give_order, "$defender_team_2", 4, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 4, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 4, mordr_stand_closer),
      (entry_point_get_position, pos10, 19),
      (team_set_order_position, "$defender_team_2", 4, pos10),
      (team_set_order_position, "$defender_team", 4, pos10),

      (team_give_order, "$attacker_team", 5, mordr_hold),
      (team_give_order, "$attacker_team_2", 5, mordr_hold),
      (entry_point_get_position, pos10, 60),
      (team_set_order_position, "$attacker_team_2", 5, pos10),
      (team_set_order_position, "$attacker_team", 5, pos10),

      (team_give_order, "$attacker_team", 6, mordr_hold),
      (team_give_order, "$attacker_team_2", 6, mordr_hold),
      (entry_point_get_position, pos10, 61),
      (team_set_order_position, "$attacker_team_2", 6, pos10),
      (team_set_order_position, "$attacker_team", 6, pos10),

      (team_give_order, "$attacker_team", 7, mordr_hold),
      (team_give_order, "$attacker_team_2", 7, mordr_hold),
      (entry_point_get_position, pos10, 62),
      (team_set_order_position, "$attacker_team_2", 7, pos10),
      (team_set_order_position, "$attacker_team", 7, pos10),

      (team_give_order, "$attacker_team", 8, mordr_hold),
      (team_give_order, "$attacker_team_2", 8, mordr_hold),
      (entry_point_get_position, pos10, 63),
      (team_set_order_position, "$attacker_team_2", 8, pos10),
      (team_set_order_position, "$attacker_team", 8, pos10),

      (set_show_messages, 1),
    ],[]),

    #freelancer
    (ti_before_mission_start, 0, 0, [],[
      (try_begin),
          (gt, "$enlisted_party", -1),
          (quest_set_slot, "qst_freelancing", slot_quest_freelancer_agent_spawned, 0),
      (try_end),
    ]),

    #simple defender ai
    (5, 0, ti_once, [
      (store_div, ":threshold", "$siege_threshold_defender", 3),
      (ge, "$defender_reinforcement_stage", ":threshold"),
    ],[
      (display_message, "@Defender's infantry, spread out!"),
      (set_show_messages, 0),
      (team_give_order, "$defender_team", 0, mordr_spread_out),
      (team_give_order, "$defender_team_2", 0, mordr_spread_out),
      (team_give_order, "$defender_team", 2, mordr_spread_out),
      (team_give_order, "$defender_team_2", 2, mordr_spread_out),
      (team_give_order, "$defender_team", 3, mordr_spread_out),
      (team_give_order, "$defender_team_2", 3, mordr_spread_out),
      (team_give_order, "$defender_team", 4, mordr_spread_out),
      (team_give_order, "$defender_team_2", 4, mordr_spread_out),
      (set_show_messages, 1),
    ]),

    #simple attacker ai
    (5, 0, ti_once, [
      (ge,"$temp4_1",5),
      (store_mission_timer_a, ":mission_time"),
      (gt, ":mission_time", 180), #3 minutes, not too early
    ],[
      (set_show_messages, 0),
      (try_for_range, ":division", 0, grc_everyone),
          (team_give_order, "$attacker_team", ":division", mordr_charge), #AI desperate charge:infantry!!!
          (team_give_order, "$attacker_team_2", ":division", mordr_charge), #AI desperate charge:infantry!!!
      (try_end),
      (set_show_messages, 1),
      (display_message, "@Attacker's Archers, charge!"),
    ]),

    #simple defeder AI
    (5, 0, ti_once, [
      (store_div, ":threshold", "$siege_threshold_defender", 2),
      (ge, "$defender_reinforcement_stage", ":threshold"),
      (store_mission_timer_a, ":mission_time"),
      (gt, ":mission_time", 180), #3 minutes, not too early
    ],[
      (display_message, "@Defender's Infantry, counter attack!"),
      (set_show_messages, 0),
      (team_give_order, "$defender_team", 0, mordr_charge), #AI desperate charge:infantry!!!
      (team_give_order, "$defender_team_2", 0, mordr_charge), #AI desperate charge:infantry!!!
      (team_give_order, "$defender_team", 2, mordr_charge), #AI desperate charge:cavalry!!!
      (team_give_order, "$defender_team_2", 2, mordr_charge), #AI desperate charge:cavalry!!!
      (team_give_order, "$defender_team", 3, mordr_charge), #AI desperate charge:cavalry!!!
      (team_give_order, "$defender_team_2", 3, mordr_charge), #AI desperate charge:cavalry!!!
      (team_give_order, "$defender_team", 4, mordr_charge), #AI desperate charge:cavalry!!!
      (team_give_order, "$defender_team_2", 4, mordr_charge), #AI desperate charge:cavalry!!!
      (set_show_messages, 1),
    ]),
    #simple AI: all charge at the end of the siege
    (5, 0, ti_once, [
      (store_sub, ":threshold", "$siege_threshold_defender", 1),
      (ge, "$defender_reinforcement_stage", ":threshold"),
      (store_mission_timer_a, ":mission_time"),
      (gt, ":mission_time", 240), #4 minutes, not too early
    ],[
      (display_message, "@Everybody, charge!"),
      (set_show_messages, 0),
      (team_give_order, "$defender_team", grc_everyone, mordr_charge), #AI desperate charge: everyone!!!
      (team_give_order, "$defender_team_2", grc_everyone, mordr_charge), #AI desperate charge: everyone!!!

      #let also the attacker charge now to finish the last defenders
      (team_give_order, "$attacker_team", grc_everyone, mordr_charge), #AI finish them
      (team_give_order, "$attacker_team_2", grc_everyone, mordr_charge), #AI finish them
      (set_show_messages, 1),
    ]),

    #freelancer
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      #properly set teams!!!
      (try_begin),
          (ge, "$enlisted_party", 1),
          (call_script, "script_agent_reassign_team_freelancer", ":agent_no"),
      (try_end),

      (try_begin),
          (agent_is_defender, ":agent_no"),
          (call_script, "script_cf_has_bow", ":agent_no"),
          (agent_set_division, ":agent_no", grc_archers),
      # (else_try),
          # (agent_set_division, ":agent_no", grc_infantry),
      (try_end),
    ]),

    #war cry
    (0, 0, 3,[
      (key_clicked, key_t),
    ],[
      (le, "$warcry_loading", 0),
      (get_player_agent_no, ":player"),
      (agent_is_alive, ":player"),
      (try_for_agents, ":cur_agent"),#effect
          (agent_is_human, ":cur_agent"),
          (agent_is_alive, ":cur_agent"),
          (agent_is_active,":cur_agent"),
          (agent_is_ally, ":cur_agent"),
          (neq, ":cur_agent", ":player"),
          (agent_set_damage_modifier, ":cur_agent", 110),
          (assign, "$warcry_loading", 10),
          (call_script,"script_agent_perform_warcry", ":cur_agent"),
      (try_end),
      (display_message, "str_war_cry",message_positive),
      (call_script, "script_agent_perform_warcry", ":player"),
    ]),

    (0, 0, 1,[(gt, "$warcry_loading", 0), ],[(val_sub, "$warcry_loading", 1),]),


    improved_lightning,
    common_siege_calculate_reinforcement_waves,
    wounds_vc,
    common_battle_player_fallen_renown_lose,
    common_battle_mission_start,
    common_battle_tab_press,
    common_battle_init_banner,
    common_siege_question_answered,
    common_siege_init,
    common_music_situation_update,

    common_siege_defender_reinforcement_archer_reposition,
    common_siege_attacker_do_not_stall,

    common_battle_check_friendly_kills,
    common_battle_check_victory_condition,
    common_battle_victory_display,

    common_siege_check_defeat_condition,
    common_battle_order_panel_tick,
    common_inventory_not_available,

    #ammunition supply for defenders
    (180, 0, 0, [],##changed to 3 min
    [#refill ammo of defenders every 3 minutes.
      (try_for_agents,":cur_agent"),
          (agent_is_active, ":cur_agent"),
          (agent_is_alive, ":cur_agent"),
          (agent_is_human, ":cur_agent"),
          (agent_is_defender, ":cur_agent"),
          (agent_refill_ammo, ":cur_agent"),
      (try_end),
      (display_message, "@Defenders recieved ammunition supplies."),
    ]),
    #ammunition supply for attackers
    (120, 0, 0, ##changed to 2 min
    [(le, "$temp4_1", 4),],#only 5 refills each battle
    [#refill ammo of defenders every two minutes.
      (try_for_agents,":cur_agent"),
          (agent_is_active, ":cur_agent"),
          (agent_is_alive, ":cur_agent"),
          (agent_is_human, ":cur_agent"),
          (neg|agent_is_defender, ":cur_agent"),
          (agent_refill_ammo, ":cur_agent"),
      (try_end),
      (display_message, "@Attackers recieved ammunition supplies."),
      (val_add, "$temp4_1", 1),
    ]),

    #also some of the reinforcements get greek fire, but much less likely
    (ti_on_agent_spawn, 0, 0, [
      (ge, "$defender_reinforcement_stage", 5),
    ],[
      (store_trigger_param_1, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_is_active, ":agent_no"),
      (agent_is_non_player, ":agent_no"),
      (agent_get_team, ":agent_team", ":agent_no"),
      (this_or_next|eq, ":agent_team", "$defender_team"),
      (eq, ":agent_team", "$defender_team_2"),
      (try_begin),
          (call_script, "script_cf_has_bow", ":agent_no"),#no archers, they have arrows
      (else_try),
          (store_random_in_range, ":r", 0, 25),
          (try_begin),
              (eq, ":r", 1),#less likely
              (agent_equip_item, ":agent_no", "itm_greek_fire"),
          (else_try),
              (eq, ":r", 0),
              (agent_equip_item, ":agent_no", "itm_stones_siege"),
          (try_end),
      (try_end),
    ]),
    (0, 1, ti_once, [],[
      (try_for_agents, ":agent_no"),
          (agent_is_human, ":agent_no"),
          (agent_is_alive, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_is_non_player, ":agent_no"),
          (agent_get_team, ":agent_team", ":agent_no"),
          (this_or_next|eq, ":agent_team", "$defender_team"),
          (eq, ":agent_team", "$defender_team_2"),
          (try_begin),
              (call_script, "script_cf_has_bow", ":agent_no"),#no archers, they have arrows
          (else_try),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 1),
                  (agent_equip_item, ":agent_no", "itm_greek_fire"),
              (else_try),
                  (agent_equip_item, ":agent_no", "itm_stones_siege"),
              (try_end),
          (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent_no"),
      (store_trigger_param_3, ":is_wounded"),
      (try_begin),
          (ge, ":dead_agent_no", 0),
          (neg|agent_is_ally, ":dead_agent_no"),
          (agent_is_human, ":dead_agent_no"),
          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
          (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
          (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),
          (try_begin),
              (call_script, "script_cf_force_wound_troop", ":dead_agent_troop_id"),
              (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
              (set_trigger_result, 2),
          (else_try),
              (neg|troop_is_hero, ":dead_agent_troop_id"),
              (eq, "$g_realistic_wounding", 1),
              (le, ":last_damage", 10),
              (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
              (set_trigger_result, 2),
          (else_try),
              (neg|troop_is_hero, ":dead_agent_troop_id"),
              (eq, "$g_realistic_wounding", 1),
              (ge, ":last_damage", 40),
              (set_trigger_result, 1),
          (else_try),
              (try_begin),
                  (eq, ":is_wounded", 1),
                  (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
              (try_end),
              (set_trigger_result, 0),
          (try_end),
      (try_end),

      (try_begin),
          (ge, ":dead_agent_no", 0),
          (agent_is_ally, ":dead_agent_no"),
          (agent_is_human, ":dead_agent_no"),

          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),

          (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),

          (party_get_skill_level, ":surgery", "p_main_party", skl_surgery),
          (store_mul, ":chance", ":surgery", 4),
          (val_add, ":chance", 25),
          (store_random_in_range, ":rand", 0, 100),

          (try_begin),
              (call_script, "script_cf_force_wound_troop", ":dead_agent_troop_id"),
              (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
              (set_trigger_result, 2),
          (else_try),
              (neg|troop_is_hero, ":dead_agent_troop_id"),
              (eq, "$g_realistic_wounding", 1),
              (le, ":last_damage", 10),
              (set_trigger_result, 2),
          (else_try),
              (neg|troop_is_hero, ":dead_agent_troop_id"),
              (eq, "$g_realistic_wounding", 1),
              (ge, ":last_damage", 40),
              (ge, ":rand", ":chance"),
              (set_trigger_result, 1),
          (else_try),
              (set_trigger_result, 0),
          (try_end),
      (try_end),
    ]),

    (ti_on_leave_area, 0, 0, [],[
      (assign, "$pin_player_fallen", 0),
      # (get_player_agent_no, ":player_agent"),
      #(agent_get_team, ":agent_team", ":player_agent"),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 1, 4, 0),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,0),
    ]),

  ] + camera_controls + theoris_decapitation
    + battle_panel_triggers + dplmc_battle_mode_triggers
    + auxiliary_player
),

("castle_visit",0,-1,
  "Castle visit",[
    (0,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons|af_override_head,0,1,pilgrim_disguise),
    (1,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
    (2,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
    (3,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
    (4,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise), #for doors
    (5,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
    (6,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
    (7,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
    (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
    (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (11,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (12,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
    (13,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (14,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (15,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (16,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (17,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (18,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (19,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_horse,0,1,[]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
    (23,mtef_visitor_source,af_override_horse,0,1,[]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse,0,1,[]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source,af_override_horse,0,1,[]), ##castle chief walkers
    (33,mtef_visitor_source,af_override_horse,0,1,[]), ##castle chief walkers
    (34,mtef_visitor_source,af_override_horse,0,1,[]), ##castle chief walkers
    (35,mtef_visitor_source,af_override_horse,0,1,[]), ##castle chief walkers
    (36,mtef_visitor_source,af_override_horse,0,1,[]), ##castle chief walkers
    (37,mtef_visitor_source,af_override_horse,0,1,[]), ##castle chief walkers
    (38,mtef_visitor_source,af_override_horse,0,1,[]), #castle chief walkers
    (39,mtef_visitor_source,af_override_horse,0,1,[]), #castle chief walkers
    # Party members
    (40,mtef_visitor_source,af_override_horse,0,1,[]),
    (41,mtef_visitor_source,af_override_horse,0,1,[]),
    (42,mtef_visitor_source,af_override_horse,0,1,[]),
    (43,mtef_visitor_source,af_override_horse,0,1,[]),
    (44,mtef_visitor_source,af_override_horse,0,1,[]),
    (45,mtef_visitor_source,af_override_horse,0,1,[]),
    (46,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + storms +global_common_triggers +
  [
    improved_lightning,
    can_spawn_commoners,
    (0,0,ti_once, [],[
      # spawn castle guard at entry 2
      (try_begin),
          (is_between, "$g_encountered_party_faction", kingdoms_begin, kingdoms_end),
          (faction_get_slot, ":troop_castle_guard", "$g_encountered_party_faction", slot_faction_castle_guard_troop),
          (gt, ":troop_castle_guard", 1),
          (entry_point_get_position, pos18, 2),
          (set_spawn_position, pos18),
          (spawn_agent, ":troop_castle_guard"),
          (agent_set_team, reg0, 7),
      (try_end),
    ]),
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent_no"),
      (store_trigger_param_2, ":killer_agent_no"),
      #(store_trigger_param_3, ":is_wounded"),

      (agent_get_troop_id, ":dead_agent_troop_no", ":dead_agent_no"),
      (agent_get_troop_id, ":killer_agent_troop_no", ":killer_agent_no"),

      (try_begin),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_dacian_prision_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_caucasian_prison_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_celtic_prison_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_sarmatian_prison_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_germanic_prison_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_eastern_prison_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_batava_prison_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_jew_prison_guard"),
        (this_or_next|eq, ":dead_agent_troop_no", "trp_bosporan_prison_guard"),
        (eq, ":dead_agent_troop_no", "trp_roman_prison_guard"),

        (eq, ":killer_agent_troop_no", "trp_player"),

        #SB : colorize and redo string
        (display_message, "@You got the keys to the dungeon.", message_alert),
        (mission_disable_talk),
      (try_end),
    ]),

    #JAILBREAK TRIGGERS
    #Civilians get out of the way
    (1, 0, 0,[
      (this_or_next|eq, "$talk_context", tc_prison_break),
      (eq, "$talk_context", tc_escape),
    ],[
      #(agent_get_team, ":prisoner_agent", 0),
      (call_script, "script_neutral_behavior_in_fight"),
      (mission_disable_talk),
    ]),

    (1, 0, ti_once,[],[
      (try_begin),
        (eq, "$g_mt_mode", tcm_default),
        (store_current_scene, ":cur_scene"),
        (scene_set_slot, ":cur_scene", slot_scene_visited, 1),
      (try_end),
      (call_script, "script_init_town_walker_agents"),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", mtf_sit_town_infiltrate),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
      (try_end),
      (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (call_script, "script_init_town_agent", ":agent_no"),
      (try_end),
    ]),

    (3, 0, 0, [(call_script, "script_tick_town_walkers")],[]),
    (2, 0, 0, [(call_script, "script_center_ambiance_sounds")],[]),

    (ti_on_agent_spawn, 0, 0, [
      (this_or_next|eq, "$talk_context", tc_escape),
      (eq, "$talk_context", tc_prison_break),
    ],[
      (store_trigger_param_1, ":agent_no"),
      (agent_get_troop_id, ":troop_no", ":agent_no"),
      (troop_get_slot, ":will_join_prison_break", ":troop_no", slot_troop_will_join_prison_break),
      (eq, ":will_join_prison_break", 1),
      (agent_ai_set_aggressiveness, ":agent_no", 5),
      (troop_set_slot, ":troop_no", slot_troop_will_join_prison_break, 0),
      (agent_set_is_alarmed, ":agent_no", 1),
      (try_begin),
        (troop_slot_eq, ":troop_no", slot_troop_mission_participation, mp_prison_break_stand_back),
        (agent_get_position, pos1, ":agent_no"),
        (agent_set_scripted_destination, ":agent_no", pos1),
      (try_end),
    ]),
    (1, 0, ti_once,[
      #If I set this to 1, 0, ti_once, then the prisoner spawns twice
      (eq, "$talk_context", tc_escape),
    ],[
      (get_player_agent_no, ":player_agent"),
      (assign, reg6, ":player_agent"),
      (call_script, "script_activate_town_guard"),

      (get_player_agent_no, ":player_agent"),
      (agent_get_position, pos4, ":player_agent"),

      (party_get_num_prisoner_stacks, ":cap", "$current_town"),
      (agent_get_team, ":player_team", ":player_agent"),
      (try_for_range, ":stack", 0, ":cap"),
        (party_prisoner_stack_get_troop_id, ":prisoner", "$current_town", ":stack"),
        (troop_is_hero, ":prisoner"),
        (troop_slot_ge, ":prisoner", slot_troop_mission_participation, mp_prison_break_fight),
        (str_store_troop_name, s4, ":prisoner"),
        (display_message, "str_s4_joins_prison_break"),

        (store_current_scene, ":cur_scene"), #this might be a better option?
        (modify_visitors_at_site, ":cur_scene"),
        #<entry_no>,<troop_id>,<number_of_troops>, <team_no>, <group_no>),
        #team no and group no are used in multiplayer mode only. default team in entry is used in single player mode
        (store_current_scene, ":cur_scene"),
        (modify_visitors_at_site, ":cur_scene"),
        # (assign, ":nearest_entry_no", 24),
        (add_visitors_to_current_scene, 24, ":prisoner", 1, ":player_team", 0),
        (troop_set_slot, ":prisoner", slot_troop_will_join_prison_break, 1),
      (try_end),
	  ]),

    (ti_tab_pressed, 0, 0,[
      (try_begin),
        (this_or_next|eq, "$talk_context", tc_escape),
        (eq, "$talk_context", tc_prison_break),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (this_or_next|eq, "$g_mt_mode", tcm_default),
        (eq, "$g_mt_mode", tcm_disguised),
        (set_trigger_result, 1),
        (mission_enable_talk),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ],[]),

    (ti_before_mission_start, 0, 0, [],[
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_remove_siege_objects"),
    ]),
    (3, 0, 0,[
      (main_hero_fallen, 0),
    ],[
      (try_begin),
        (this_or_next|eq, "$talk_context", tc_prison_break),
        (eq, "$talk_context", tc_escape),

        (call_script, "script_deduct_casualties_from_garrison"),
	      (jump_to_menu,"mnu_captivity_start_castle_defeat"),

	      (assign, ":end_cond", kingdom_ladies_end),
        (try_for_range, ":prisoner", active_npcs_begin, ":end_cond"),
          (troop_set_slot, ":prisoner", slot_troop_mission_participation, 0), #new
        (try_end),

	      (mission_enable_talk),
	      (finish_mission, 0),
	    (else_try),
        (mission_enable_talk),
        (finish_mission, 0),
        (set_trigger_result, 1),
      (try_end),
    ]),

    (3, 0, 0,[
      (eq, "$talk_context", tc_escape),
      (neg|main_hero_fallen,0),
      (store_mission_timer_a, ":time"),
      (ge, ":time", 10),
      (all_enemies_defeated), #1 is default enemy team for in-town battles
    ],[
      (call_script, "script_deduct_casualties_from_garrison"),
      (try_for_agents, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (troop_slot_ge, ":troop", slot_troop_mission_participation, mp_prison_break_fight),
        (try_begin),
          (agent_is_alive, ":agent"),
          (troop_set_slot, ":troop", slot_troop_mission_participation, mp_prison_break_escaped),
        (else_try),
          (troop_set_slot, ":troop", slot_troop_mission_participation, mp_prison_break_caught),
        (try_end),
      (try_end),
      (jump_to_menu, "mnu_sneak_into_town_caught_ran_away"),
      (mission_enable_talk),
      (finish_mission, 0),
    ]),

	  ambient_scene_play_loop,
    ambient_scene_play_random_sound,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
  ] + bodyguard_triggers,
),

("training_ground_trainer_talk", 0, -1,
  "Training.",[
    (0,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
    (1,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
    (2,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
    (3,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
    (4,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
    (5,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
    (6,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
    (7,mtef_visitor_source|mtef_team_1,af_override_all,aif_start_alarmed,1,[itm_dagger,itm_practice_shield, itm_arena_armor_blue, itm_tourney_helm_blue]),
    (8,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (9,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (10,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (11,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (12,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (13,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,[itm_dagger,itm_practice_shield, itm_arena_armor_blue, itm_tourney_helm_blue]),
    (14,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,[itm_dreizack2, itm_arena_armor_red, itm_tourney_helm_red]),
	  (15,mtef_visitor_source|mtef_team_0,0,0,1,[]),
	  (16,mtef_visitor_source|mtef_team_0,0,0,1,[]),
	  (17,mtef_visitor_source|mtef_team_0,0,0,1,[]),
	  (18,mtef_visitor_source|mtef_team_0,0,0,1,[]),
	  (19,mtef_visitor_source|mtef_team_0,0,0,1,[]),
	  (20,mtef_visitor_source|mtef_team_0,0,0,1,[]),
	  (21,mtef_visitor_source|mtef_team_2,af_override_all,aif_start_alarmed,1,[itm_dreizack2, itm_arena_armor_red, itm_tourney_helm_red]),
  ], p_wetter +global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    (1, 0, ti_once, [],[
      (team_set_relation, 0, 1, 1),
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 2, -1),
      (mission_enable_talk),
    ]),

      (ti_before_mission_start, 0, 0, [],
       [
         (call_script, "script_change_banners_and_chest"),
         ]),
      (ti_inventory_key_pressed, 0, 0,
       [
         (set_trigger_result,1),
         ],[]),
      (ti_tab_pressed, 0, 0,
       [
         (set_trigger_result,1),
         ],[]),

         (0, 0, ti_once,
       [
        (try_for_agents, ":agent"),
            (agent_is_active, ":agent"),
            (agent_get_entry_no, ":entry", ":agent"),
            (try_begin),
                (eq, ":entry", 6),
                (entry_point_get_position, pos22, ":entry"),
                (agent_set_scripted_destination, ":agent", pos22),
            (else_try),
                (this_or_next|eq, ":entry", 7),
                (eq, ":entry", 21),
                (agent_set_no_death_knock_down_only, ":agent", 1),
            (try_end),
        (try_end),
         ],[]),
     # (0.0, 1.0, 2.0,
      # [(lt, "$trainer_help_message", 2),
        # ],
      # [(try_begin),
         # (eq, "$trainer_help_message", 0),
# #         (tutorial_box, "str_trainer_help_1", "@Tutorial"),
       # (else_try),
# #         (tutorial_box, "str_trainer_help_2", "@Tutorial"),
       # (try_end),
       # (val_add, "$trainer_help_message", 1),
          # ]),

    ],
  ),

  #SB : reuse slots instead of globals, retain health
  (
    "training_ground_trainer_training",mtf_arena_fight,-1,
    "You will fight a match in the arena.",
    [
      (16, mtef_visitor_source|mtef_team_0,af_override_everything,aif_start_alarmed,1,[itm_practice_shield,itm_practice_sword]),
      (17, mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[itm_practice_staff]),
      (18, mtef_visitor_source|mtef_team_2,af_override_everything,aif_start_alarmed,1,[itm_practice_staff]),
      (19, mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_heavy_practice_sword]),
      (20, mtef_visitor_source,0,0,1,[]),
    ], p_wetter +global_common_triggers +
    [
      cannot_spawn_commoners,
    improved_lightning,
      (ti_before_mission_start, 0, 0, [],[(call_script, "script_change_banners_and_chest")]),

      common_arena_fight_tab_press,

      #SB : player override items
      (ti_on_agent_spawn, 0, ti_once, [
        (troop_slot_ge, "$g_talk_troop", slot_troop_trainer_training_difficulty, 4),
        (store_trigger_param_1,":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (eq, ":troop_no", "$g_player_troop"),
      ],
      [
        (store_trigger_param_1,":agent_no"),
        #get wpt
        (store_proficiency_level, ":onehands", "$g_player_troop", wpt_one_handed_weapon),
        (store_proficiency_level, ":twohands", "$g_player_troop", wpt_two_handed_weapon),
        (store_proficiency_level, ":polearms", "$g_player_troop", wpt_polearm),

        (try_begin),
          (ge, ":onehands", ":twohands"),
          (ge, ":onehands", ":polearms"),
          # (agent_equip_item, ":agent_no", "itm_practice_shield"),
          (assign, ":weapon", "itm_practice_sword"),
        (else_try),
          (ge, ":twohands", ":onehands"),
          (ge, ":twohands", ":polearms"),
          (assign, ":weapon", "itm_heavy_practice_sword"),
        (else_try),
          (ge, ":polearms", ":onehands"),
          (ge, ":polearms", ":twohands"),
          (assign, ":weapon", "itm_practice_staff"),
        (try_end),
        (call_script, "script_get_proficient_melee_training_weapon", "$g_player_troop"),
        (assign, ":weapon", reg0),

        (agent_get_wielded_item, ":item_no", ":agent_no", 0),
        (neq, ":item_no", ":weapon"),
        (agent_unequip_item, ":agent_no", ":item_no"),
        (try_begin),
          (agent_get_wielded_item, ":item_no", ":agent_no", 1),
          (gt, ":item_no", 0),
          (neq, ":weapon", "itm_practice_sword"),
          (agent_unequip_item, ":agent_no", ":item_no"),
        (else_try),
          (eq, ":weapon", "itm_practice_sword"),
          (eq, ":item_no", -1),
          (agent_equip_item, ":agent_no", "itm_practice_shield"),
          (agent_set_wielded_item, ":agent_no", "itm_practice_shield"),
        (try_end),
        (agent_equip_item, ":agent_no",":weapon"),
        (agent_set_wielded_item, ":agent_no", ":weapon"),
      ]),

      (ti_question_answered, 0, 0, [],
       [
         (store_trigger_param_1, ":answer"),
         (eq, ":answer", 0),
         (set_jump_mission, "mt_training_ground_trainer_talk"),
         # (try_begin),
           # (party_get_slot, ":scene", "$g_encountered_party", slot_grounds_melee),
           # (le, ":scene", 0),
           # (assign, ":scene", "$g_training_ground_melee_training_scene"),
         # (try_end),
         (store_current_scene, ":scene"),
         (modify_visitors_at_site, ":scene"),
         (reset_visitors),
         (set_jump_entry, 5),
         (jump_to_scene, ":scene"),
         ]),
      (1, 3, ti_once, [(main_hero_fallen,0)],
       [
         (set_jump_mission, "mt_training_ground_trainer_talk"),
         # (try_begin),
           # (party_get_slot, ":scene", "$g_encountered_party", slot_grounds_melee),
           # (le, ":scene", 0),
           # (assign, ":scene", "$g_training_ground_melee_training_scene"),
         # (try_end),
         (store_current_scene, ":scene"),
         (modify_visitors_at_site, ":scene"),
         (reset_visitors),
         (set_jump_entry, 5),
         (jump_to_scene, ":scene"),

         (store_troop_health, ":hp", "$g_player_troop", 0),
         (troop_get_slot, ":diff", "$g_talk_troop", slot_troop_trainer_training_difficulty),
         (store_sub, ":diff", 9, ":diff"),
         (val_mul, ":hp", ":diff"),
         (val_div, ":hp", 10),
         (troop_set_health, "$g_player_troop", ":hp", 0),
         ]),
      (1, 3, ti_once,
       [
         (store_mission_timer_a, reg1),
         (ge, reg1, 1),
         (num_active_teams_le, 1),
         (neg|main_hero_fallen),
         # (assign, "$training_fight_won", 1),
         (troop_set_slot, "$g_talk_troop", slot_troop_trainer_training_fight_won, 1),
         ],
       [
       #instead of refreshing the scene we just talk on-sight
         (get_player_agent_no, ":agent"),
         (store_agent_hit_points, ":hp", ":agent", 0),
         (troop_set_health, "$g_player_troop", ":hp", 0),

         (mission_enable_talk),
         (start_mission_conversation, "$g_talk_troop"),
         ]),
      (ti_inventory_key_pressed, 0, 0, [(display_message,"str_cant_use_inventory_arena")],[]),
    ],
  ),


  (
    "training_ground_training", mtf_arena_fight|mtf_no_blood, -1,
    "Training.",
    [
      (0,mtef_visitor_source|mtef_team_0,af_override_everything,aif_start_alarmed,1,[itm_practice_staff,itm_practice_boots]),
      (1,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[itm_practice_staff,itm_practice_boots]),
      (2,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[itm_practice_staff,itm_practice_boots]),
      (3,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[itm_practice_staff,itm_practice_boots]),
      (4,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[itm_practice_staff,itm_practice_boots]),
      (8,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
      (9,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
      (10,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
      (11,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
      (12,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
      (13,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
      (14,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
      (15,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
    ], p_wetter +global_common_triggers +
    [
      cannot_spawn_commoners,
    improved_lightning,
        # #SB : set spectator randomized cheering
        (ti_on_agent_spawn, 0, 0, [
            (store_trigger_param_1,":agent_no"),
            (agent_is_human, ":agent_no"),
            (agent_get_item_slot, ":item_no", ":agent_no", ek_foot),
            (neq, ":item_no", "itm_practice_boots"), #not equipped on spectator troops
            # (agent_get_entry_no, ":entry_no", ":agent_no"),
            # (assign, reg1, ":entry_no"),
            # (str_store_agent_name, s1, ":agent_no"),
            # (display_message, "@{s1} at {reg1}"),
            # (gt, ":entry_no", 4),
          ],
          [
            # (set_fixed_point_multiplier, 100),
            (store_trigger_param_1,":agent_no"),
            (agent_get_troop_id, ":troop_no", ":agent_no"),
            # (try_begin),
              # (call_script, "script_cf_gender_toggle", ":troop_no"),
              # (store_random_in_range, ":gender", 0, 2),
              # (troop_set_type, ":troop_no", ":gender"),
            # (try_end),
            (store_random_in_range, ":cheer", 0, 300),
            (try_begin),
              (is_between, ":troop_no", companions_begin, companions_end),
              (call_script, "script_dplmc_npc_morale", ":troop_no", 0),
            (else_try),
              (call_script, "script_game_get_morale_of_troops_from_faction", ":troop_no"),
            (try_end),
            (val_add, ":cheer", reg0),
            (try_begin),
              (ge, ":cheer", 150),
              (store_random_in_range, ":stand_animation", "anim_wedding_guest", "anim_wedding_dad_stairs"),
              (agent_set_stand_animation, ":agent_no", ":stand_animation"),
              (agent_set_animation, ":agent_no", ":stand_animation"),
              (store_random_in_range, ":random_no", 0, 100),
              (agent_set_animation_progress, ":agent_no", ":random_no"),
            (try_end),
            #assign other cheer action when player kills in ctm_melee or hits gourds
        ]),

        #SB : wound troops and heroes
      (ti_on_agent_killed_or_wounded, 0, 0, [
        (eq, "$g_mt_mode", ctm_melee),
        ],
       [
       (store_trigger_param_1, ":agent_no"),
       (store_trigger_param_2, ":killer"),
       (agent_get_troop_id, ":troop_no", ":agent_no"),
       #yes, there's a chance that the highest skill troop is the one getting injured, but w/e
       (party_get_skill_level, ":first_aid", "p_main_party", "skl_first_aid"),
       (try_begin),
         (troop_is_hero, ":troop_no"),
         (store_troop_health, ":health", ":troop_no", 1), #this is not yet deducted
         (val_mul, ":first_aid", 5), #as per skill description
         (val_mul, ":health", ":first_aid"),
         (val_div, ":health", 100),
         (troop_set_health, ":troop_no", ":health", 1),
       (else_try), #regular troops
         (val_add, ":first_aid", 100),
         (store_random_in_range, ":random_no", 0, ":first_aid"),
         (lt, ":random_no", 25),
         (party_wound_members, "p_main_party", ":troop_no", 1),
       (try_end),

       (try_begin),
         (get_player_agent_no, ":player_agent"),
         (store_trigger_param_2, ":killer"),
         (eq, ":player_agent", ":killer"),
         (call_script, "script_agents_cheer_during_training"),
       (try_end),

       ]),
      (ti_before_mission_start, 0, 0, [],
       [
         (assign, "$g_last_destroyed_gourds", 0),
         (call_script, "script_change_banners_and_chest")]),

      common_arena_fight_tab_press,

      (ti_question_answered, 0, 0, [],
       [
         (store_trigger_param_1,":answer"),
         (eq,":answer",0),
         (assign, "$g_training_ground_training_success_ratio", 0),

         (call_script, "script_troop_set_training_health_from_agent"), #SB : store health
         (jump_to_menu, "mnu_training_ground_training_result"),
         (finish_mission),
         ]),

      common_inventory_not_available,

      (0, 0, ti_once,
       [
         (try_begin),
           (eq, "$g_mt_mode", ctm_ranged),
           (set_fixed_point_multiplier, 100),
           (entry_point_get_position, pos1, 0),
           (init_position, pos2),
           (position_set_y, pos2, "$g_training_ground_ranged_distance"),
           (position_transform_position_to_parent, pos3, pos1, pos2),
           (copy_position, pos1, pos3),
           (assign, ":end_cond", 10),
           (assign, ":shift_value", 0),
           (try_for_range, ":cur_i", 0, ":end_cond"),
             (store_sub, ":cur_instance", ":cur_i", ":shift_value"),
             (scene_prop_get_instance, ":target_object", "spr_gourd", ":cur_instance"),
             (copy_position, pos2, pos1),
             (init_position, pos0),
             (store_random_in_range, ":random_no", 0, 360),
             (position_rotate_z, pos2, ":random_no"),
             (store_random_in_range, ":random_no", 50, 600),
             (position_move_x, pos2, ":random_no"),
             (store_random_in_range, ":random_no", 0, 360),
             (position_transform_position_to_local, pos3, pos1, pos2),
             (position_rotate_z, pos0, ":random_no"),
             (position_transform_position_to_parent, pos4, pos0, pos3),
             (position_transform_position_to_parent, pos2, pos1, pos4),
             (position_set_z_to_ground_level, pos2),
             (position_move_z, pos2, 150),
             (assign, ":valid", 1),
             (try_for_range, ":cur_instance_2", 0, 10),
               (eq, ":valid", 1),
               (neq, ":cur_instance", ":cur_instance_2"),
               (scene_prop_get_instance, ":target_object_2", "spr_gourd", ":cur_instance_2"),
               (prop_instance_get_position, pos3, ":target_object_2"),
               (get_distance_between_positions, ":dist", pos2, pos3),
               (lt, ":dist", 100),
               (assign, ":valid", 0),
             (try_end),
             (try_begin),
               (eq, ":valid", 0),
               (val_add, ":end_cond", 1),
               (val_add, ":shift_value", 1),
             (else_try),
               (prop_instance_set_position, ":target_object", pos2),
               (prop_instance_animate_to_position, ":target_object", pos2, 1),
               (scene_prop_get_instance, ":target_object_2", "spr_gourd_spike", ":cur_instance"),
               (position_move_z, pos2, -150), #moving back to ground level
               (prop_instance_set_position, ":target_object_2", pos2),
               (prop_instance_animate_to_position, ":target_object_2", pos2, 1),
             (try_end),
           (try_end),
         (else_try),
           (eq, "$g_mt_mode", ctm_mounted),
           (assign, ":num_gourds", 0),
           #First, placing gourds on the spikes
           (try_for_range, ":cur_i", 0, 100),
             (scene_prop_get_instance, ":target_object", "spr_gourd", ":cur_i"),
             (scene_prop_get_instance, ":target_object_2", "spr_gourd_spike", ":cur_i"),
             (ge, ":target_object", 0),
             (ge, ":target_object_2", 0),
             (val_add, ":num_gourds", 1),
             (prop_instance_get_position, pos0, ":target_object_2"),
             (position_move_z, pos0, 150),
             (prop_instance_set_position, ":target_object", pos0),
             (prop_instance_animate_to_position, ":target_object", pos0, 1),
           (try_end),
           (store_sub, ":end_cond", ":num_gourds", "$g_training_ground_training_num_gourds_to_destroy"),
           #Second, removing gourds and their spikes randomly
           (try_for_range, ":cur_i", 0, ":end_cond"),
             (store_random_in_range, ":random_instance", 0, ":num_gourds"),
             (scene_prop_get_instance, ":target_object", "spr_gourd", ":random_instance"),
             (prop_instance_get_position, pos0, ":target_object"),
             (position_get_z, ":pos_z", pos0),
             (try_begin),
               (lt, ":pos_z", -50000),
#               (val_add, ":end_cond", 1), #removed already, try again
             (else_try),
               (position_set_z, pos0, -100000),
               (prop_instance_set_position, ":target_object", pos0),
               (prop_instance_animate_to_position, ":target_object", pos0, 1),
               (scene_prop_get_instance, ":target_object_2", "spr_gourd_spike", ":random_instance"),
               (prop_instance_set_position, ":target_object_2", pos0),
               (prop_instance_animate_to_position, ":target_object_2", pos0, 1),
             (try_end),
           (try_end),
         (try_end),
         ],
       []),

      (1, 3, ti_once,
       [
         (eq, "$g_mt_mode", ctm_melee),
         (this_or_next|main_hero_fallen),
         (num_active_teams_le, 1)
         ],
       [
         (try_begin),
           (neg|main_hero_fallen),
           (assign, "$g_training_ground_training_success_ratio", 100),
         (else_try),
           (assign, ":alive_enemies", 0),
           (try_for_agents, ":agent_no"),
             (agent_is_alive, ":agent_no"),
             (agent_is_human, ":agent_no"),
             (agent_get_team, ":team_no", ":agent_no"),
             (eq, ":team_no", 1),
             (val_add, ":alive_enemies", 1),
           (try_end),
           (store_sub, ":dead_enemies", "$g_training_ground_training_num_enemies", ":alive_enemies"),
           (store_mul, "$g_training_ground_training_success_ratio", ":dead_enemies", 100),
           (val_div, "$g_training_ground_training_success_ratio", "$g_training_ground_training_num_enemies"),
         (try_end),
         #SB : calculate hero wounded status
         (call_script, "script_troop_set_training_health_from_agent"),
         (jump_to_menu, "mnu_training_ground_training_result"),
         (finish_mission),
         ]),

      (1, 3, ti_once,
       [
         (eq, "$g_mt_mode", ctm_ranged),
         (get_player_agent_no, ":player_agent"),
         (agent_get_ammo, ":ammo", ":player_agent"),
         (store_mission_timer_a, ":cur_seconds"),
         (this_or_next|main_hero_fallen),
         (this_or_next|eq, ":ammo", 0),
         (gt, ":cur_seconds", 116),
         ],
       [
         (store_mul, "$g_training_ground_training_success_ratio", "$scene_num_total_gourds_destroyed", 10),
         (jump_to_menu, "mnu_training_ground_training_result"),
         (finish_mission),
         ]),

      (1, 3, ti_once,
       [
         (eq, "$g_mt_mode", ctm_mounted),
         (get_player_agent_no, ":player_agent"),
         (agent_get_horse, ":player_horse", ":player_agent"),
         (store_mission_timer_a, ":cur_seconds"),
         (this_or_next|lt, ":player_horse", 0),
         (this_or_next|main_hero_fallen),
         (this_or_next|ge, "$scene_num_total_gourds_destroyed", "$g_training_ground_training_num_gourds_to_destroy"),
         (gt, ":cur_seconds", 120),
         ],
       [
         (store_mul, "$g_training_ground_training_success_ratio", "$scene_num_total_gourds_destroyed", 100),
         (val_div, "$g_training_ground_training_success_ratio", "$g_training_ground_training_num_gourds_to_destroy"),
         (jump_to_menu, "mnu_training_ground_training_result"),
         (finish_mission),
         ]),

      (0, 0, 0,
       [
         (gt, "$g_last_destroyed_gourds", 0),
         (try_begin),
           (eq, "$g_mt_mode", ctm_ranged),
           (entry_point_get_position, pos1, 0),
           (position_move_y, pos1, 100, 0),
           (get_player_agent_no, ":player_agent"),
           (agent_get_position, pos2, ":player_agent"),
           (try_begin),
             (position_is_behind_position, pos2, pos1),
             (val_add, "$scene_num_total_gourds_destroyed", "$g_last_destroyed_gourds"),
           (else_try),
             (display_message, "@You must stay behind the line on the ground! Point is not counted."),
           (try_end),
         (else_try),
           (val_add, "$scene_num_total_gourds_destroyed", "$g_last_destroyed_gourds"),
         (try_end),

         (assign, "$g_last_destroyed_gourds", 0),
         ],
       [(call_script, "script_agents_cheer_during_training"),]),
    ],
  ),

  (
    "sneak_caught_fight",mtf_battle_mode|mtf_synch_inventory,-1,
    "You must fight your way out!",
    [
     (0,mtef_scene_source|mtef_team_0,af_override_all,aif_start_alarmed,1,pilgrim_disguise),
     (1,mtef_scene_source|mtef_team_0,af_override_all,aif_start_alarmed,1,pilgrim_disguise),
     (2,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (4,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (5,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (6,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (7,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (8,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (9,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (10,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (11,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (12,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (13,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (14,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (15,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (16,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (17,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (18,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (19,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (20,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (21,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (22,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (23,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (24,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (25,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (26,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (27,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (28,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (29,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (30,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (31,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (32,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (33,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (34,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (35,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (36,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (37,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (38,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (39,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (40,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (41,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (42,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (43,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (44,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (45,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (46,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (47,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (48,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (49,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (50,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (51,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (52,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (53,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (54,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (55,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (56,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (57,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (58,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (59,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (60,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (61,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (62,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (63,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (64,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),

     # (0,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,pilgrim_disguise),
     # (25,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     # (26,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     # (27,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     # (28,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     # (29,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     # (30,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     # (31,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     # (32,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    ], p_wetter + storms + global_common_triggers +
    [
      cannot_spawn_commoners,
    improved_lightning,
      (ti_before_mission_start, 0, 0, [],
      [
        (call_script, "script_change_banners_and_chest"),

        (try_begin),
            (party_slot_eq, "$g_encountered_party", slot_party_type, spt_castle),
            (call_script, "script_remove_siege_objects"),
        (try_end),
      ]),

      (ti_after_mission_start, 0, 0, [],
       [
        (assign, ":num_guards", 5),

        (try_begin),
          (party_get_slot, ":last_nearby_fire_time", "$current_town", slot_town_last_nearby_fire_time),
          (store_current_hours, ":cur_time"),
          (store_add, ":fire_finish_time", ":last_nearby_fire_time", fire_duration),
          (is_between, ":cur_time", ":last_nearby_fire_time", ":fire_finish_time"), #SB : fix is_between that was always false
          (assign, ":num_guards", 2),
        (else_try),
          (this_or_next|eq, "$talk_context", tc_escape),
          (eq, "$talk_context", tc_prison_break),

          (assign, ":num_guards", 4),
        (try_end),

        (try_begin),
          (this_or_next|eq, "$talk_context", tc_escape),
          (eq, "$talk_context", tc_prison_break),
          (entry_point_get_position, pos0, 7),
        (else_try),
          (party_slot_eq, "$current_town", slot_party_type, spt_town),
          (entry_point_get_position, pos0, 0),
        (else_try),
          (entry_point_get_position, pos0, 1),
        (try_end),

        (assign, ":last_nearest_entry_distance", -1),
        (assign, ":last_nearest_entry_point", -1),
        (try_for_range, ":guard_no", 0, ":num_guards"),
          (assign, ":smallest_dist", 100000),
          (try_for_range, ":guard_entry_point", 2, 64),
            (neq, ":last_nearest_entry_point", ":guard_entry_point"),
            (entry_point_get_position, pos1, ":guard_entry_point"),
            (get_distance_between_positions, ":dist", pos0, pos1),
            (lt, ":dist", ":smallest_dist"),
            (gt, ":dist", ":last_nearest_entry_distance"),
            (assign, ":smallest_dist", ":dist"),
            (assign, ":nearest_entry_point", ":guard_entry_point"),
          (try_end),

          (store_faction_of_party, ":town_faction","$current_town"),
          (try_begin),
            (this_or_next|eq, ":guard_no", 0),
            (eq, ":guard_no", 2),
            (faction_get_slot, ":troop_of_guard", ":town_faction", slot_faction_tier_2_troop),
          (else_try),
            (faction_get_slot, ":troop_of_guard", ":town_faction", slot_faction_tier_2_troop),
          (try_end),

          (assign, ":last_nearest_entry_point", ":nearest_entry_point"),
          (assign, ":last_nearest_entry_distance", ":smallest_dist"),

          (add_visitors_to_current_scene, ":nearest_entry_point", ":troop_of_guard", 1, 0),
        (try_end),
      ]),

      (ti_tab_pressed, 0, 0, [],
       [(question_box,"str_do_you_wish_to_surrender")]),

      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),(eq,":answer",0),(jump_to_menu,"mnu_captivity_start_castle_defeat"),(finish_mission,0),]),

      (1, 0, ti_once, [],
       [
         (play_sound,"snd_sneak_town_halt"),
         (call_script, "script_music_set_situation_with_culture", mtf_sit_fight),
         ]),

      (0, 3, 0,
       [
          (main_hero_fallen,0),
        ],
       [
         (jump_to_menu,"mnu_captivity_start_castle_defeat"),
         (finish_mission,0),
       ]),

      (1, 0, 0, [],
       [
	    (get_player_agent_no, ":player_agent"),
	    (agent_get_position, pos0, ":player_agent"),

        (try_for_agents, ":agent_no"),
          (neq, ":agent_no", ":player_agent"),
          (agent_is_alive, ":agent_no"),
          (agent_get_team, ":agent_team", ":agent_no"),
          (eq, ":agent_team", 1),

          (agent_get_position, pos1, ":agent_no"),

          (get_distance_between_positions, ":dist", pos0, pos1),

          (try_begin),
            (le, ":dist", 800),
            (agent_clear_scripted_mode, ":agent_no"),
          (else_try),
            (agent_set_scripted_destination, ":agent_no", pos0, 0),
          (try_end),
        (try_end),
       ]),

	   (5, 1, ti_once,
	   [
	     (num_active_teams_le,1),
	     (neg|main_hero_fallen),

         (store_mission_timer_a,":cur_time"),
         (ge, ":cur_time", 5),
	   ],
       [
         (assign,"$auto_menu",-1),
         (jump_to_menu,"mnu_sneak_into_town_caught_dispersed_guards"),
         (finish_mission,1),
       ]),

	   (ti_on_leave_area, 0, ti_once, [],
       [(assign,"$auto_menu",-1),(jump_to_menu,"mnu_sneak_into_town_caught_ran_away"),(finish_mission,0)]),

      (ti_inventory_key_pressed, 0, 0, [(display_message,"str_cant_use_inventory_arena")],[]),

    ],
  ),

("ai_training",0,-1,
  "You start training.",[
    (0,0,0,aif_start_alarmed,30,[]),
  ],[
    can_spawn_commoners,
    (ti_tab_pressed, 0, 0, [
    ],[
      (finish_mission,0)
    ]),
    (0,0,ti_once,[],[
      (get_player_agent_no, ":player"),
      (call_script, "script_advanced_agent_set_speed_modifier", ":player", 500),
      (agent_set_no_death_knock_down_only, ":player", 1),
    ]),
]),
("fortuna_scene_testing",0,-1,
  "You start training.",[
    (0,0,0,aif_start_alarmed,1,[]),
  ],[
    can_spawn_commoners,
    (ti_tab_pressed, 0, 0, [],[
      (assign, "$talk_context", 0),
      (modify_visitors_at_site, "scn_camp_scene_plain"),
      (reset_visitors),
      (set_jump_entry, 0),
      (set_visitor, 1, "trp_fortuna"),
      (jump_to_scene, "scn_camp_scene_plain"),
      (set_jump_mission, "mt_fortuna_scene_testing2"),
      (change_screen_mission),
    ]),
    (0,0,ti_once,[],[
      (get_player_agent_no, ":player"),
      (call_script, "script_advanced_agent_set_speed_modifier", ":player", 500),
      (agent_set_no_death_knock_down_only, ":player", 1),
    ]),
    (0, 0, ti_once, [],[
      (set_fixed_point_multiplier, 100),
      (get_scene_boundaries, pos12,pos13),
      (position_get_x, reg12, pos12),
      (position_get_y, reg13, pos12),
      (position_get_x, reg14, pos13),
      (position_get_y, reg15, pos13),
      (display_message, "@Boundaries of scene: Minimum x: {reg12} y: {reg13} | Maximum x: {reg14} y: {reg15}"),
    ]),
]),
("fortuna_scene_testing2",0,-1,
  "You start training.",[
    (0,mtef_scene_source,0,aif_start_alarmed,1,[]),
    (1,mtef_visitor_source,0,aif_start_alarmed,1,[]),
  ], global_common_triggers +
  [
    can_spawn_commoners,
    (0, 0, ti_once, [(neg|conversation_screen_is_active),],[
      (start_mission_conversation, "trp_fortuna"),
    ]),
    (0,0,ti_once,[],[
      (get_player_agent_no, ":player"),
      (call_script, "script_advanced_agent_set_speed_modifier", ":player", 500),
      (agent_set_no_death_knock_down_only, ":player", 1),
    ]),
    (ti_tab_pressed, 0, 0, [],[
      (jump_to_menu, "mnu_cheat_menu2"),
      (finish_mission),
    ]),
]),
   (
    "camera_test",0,-1,
    "camera Test.",
    [
#     (0,mtef_attackers,0,aif_start_alarmed,5,[]),
     ], p_wetter + global_common_triggers +
    [
      can_spawn_commoners,
    improved_lightning,
      (1, 0, 0, [(mission_cam_set_mode,1),
          (entry_point_get_position, pos3, 3),
          (mission_cam_set_position, pos3)],[]),
#      (ti_before_mission_start, 0, 0, [],[(set_rain, 1,100)]),
      (ti_tab_pressed, 0, 0, [],
       [(finish_mission,0)]),
    ],
  ),

("arena_melee_fight",mtf_arena_fight,-1, "You enter a melee fight in the arena.",[
    (0,mtef_visitor_source|mtef_team_0,af_override_everything,aif_start_alarmed,1,[itm_practice_bow,itm_practice_arrows,itm_practice_horse]),
    (1,mtef_visitor_source|mtef_team_0,af_override_everything,aif_start_alarmed,1,[itm_heavy_practice_sword]),
    (2,mtef_visitor_source|mtef_team_0,af_override_everything,aif_start_alarmed,1,[itm_heavy_practice_sword,itm_practice_horse]),
    (3,mtef_visitor_source|mtef_team_0,af_override_everything,aif_start_alarmed,1,[itm_practice_lance,itm_practice_shield,itm_practice_horse]),
    (4,mtef_visitor_source|mtef_team_0,af_override_everything,aif_start_alarmed,1,[itm_practice_bow,itm_practice_arrows, itm_practice_dagger]),
    (5,mtef_visitor_source|mtef_team_0,af_override_everything,aif_start_alarmed,1,[itm_practice_sword,itm_practice_shield]),
    (6,mtef_visitor_source|mtef_team_0,af_override_everything,aif_start_alarmed,1,[itm_heavy_practice_sword,itm_practice_horse]),
    (7,mtef_visitor_source|mtef_team_0,af_override_everything,aif_start_alarmed,1,[itm_practice_lance,itm_practice_shield,itm_practice_horse]),

    (8,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[itm_practice_bow,itm_practice_arrows,itm_practice_dagger]),
    (9,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[itm_practice_lance,itm_practice_shield]),
    (10,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[itm_heavy_practice_sword]),
    (11,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[itm_practice_sword,itm_practice_shield,]),
    (12,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[itm_practice_bow,itm_practice_arrows]),
    (13,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[itm_practice_lance,itm_practice_shield]),
    (14,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[itm_heavy_practice_sword]),
    (15,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,[itm_practice_sword,itm_practice_shield]),

    (16,mtef_visitor_source|mtef_team_2,af_override_everything,aif_start_alarmed,1,[itm_practice_bow,itm_practice_arrows,itm_practice_horse]),
    (17,mtef_visitor_source|mtef_team_2,af_override_everything,aif_start_alarmed,1,[itm_heavy_practice_sword]),
    (18,mtef_visitor_source|mtef_team_2,af_override_everything,aif_start_alarmed,1,[itm_heavy_practice_sword,itm_practice_horse]),
    (19,mtef_visitor_source|mtef_team_2,af_override_everything,aif_start_alarmed,1,[itm_practice_lance,itm_practice_shield,itm_practice_horse]),
    (20,mtef_visitor_source|mtef_team_2,af_override_everything,aif_start_alarmed,1,[itm_practice_bow,itm_practice_arrows,itm_practice_dagger,]),
    (21,mtef_visitor_source|mtef_team_2,af_override_everything,aif_start_alarmed,1,[itm_practice_sword,itm_practice_shield]),
    (22,mtef_visitor_source|mtef_team_2,af_override_everything,aif_start_alarmed,1,[itm_heavy_practice_sword,itm_practice_horse]),
    (23,mtef_visitor_source|mtef_team_2,af_override_everything,aif_start_alarmed,1,[itm_practice_lance,itm_practice_shield,itm_practice_horse]),

    (24,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_practice_bow,itm_practice_arrows,itm_practice_horse]),
    (25,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_heavy_practice_sword]),
    (26,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_heavy_practice_sword,itm_practice_horse]),
    (27,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_practice_lance,itm_practice_shield,itm_practice_horse]),
    (28,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_practice_bow,itm_practice_arrows,itm_practice_dagger]),
    (29,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_practice_sword,itm_practice_shield]),
    (30,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_heavy_practice_sword,itm_practice_horse]),
    (31,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_practice_lance,itm_practice_shield,itm_practice_horse]),
    #32
    (32,mtef_visitor_source|mtef_team_1,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_heavy_practice_sword]),
    (33,mtef_visitor_source|mtef_team_2,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_practice_staff]),
    (34,mtef_visitor_source|mtef_team_3,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_practice_sword, itm_practice_shield]),
    (35,mtef_visitor_source|mtef_team_4,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_practice_staff]),
    (36,mtef_visitor_source|mtef_team_1,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_practice_bow,itm_practice_arrows_10_amount, itm_practice_dagger]), #SB : change this to lower ammo amount
    (37,mtef_visitor_source|mtef_team_2,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_practice_sword, itm_practice_shield]),
    (38,mtef_visitor_source|mtef_team_3,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_heavy_practice_sword]),
    (39,mtef_visitor_source|mtef_team_4,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_practice_staff]),
    #40-49 used for spectators
    (40,mtef_visitor_source,af_override_horse,0,1,[]),
    (41,mtef_visitor_source,af_override_horse,0,1,[]),
    (42,mtef_visitor_source,af_override_horse,0,1,[]),

    (43,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_dagger,itm_practice_shield, itm_arena_armor_blue, itm_tourney_helm_blue,itm_graves_simple]),
    (44,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_dreizack2, itm_arena_armor_red, itm_tourney_helm_red,itm_graves_simple]),

    (45,mtef_visitor_source,af_override_horse,0,1,[]),
    (46,mtef_visitor_source,af_override_horse,0,1,[]),
    (47,mtef_visitor_source,af_override_horse,0,1,[]),
    (48,mtef_visitor_source,af_override_horse,0,1,[]),
    (49,mtef_visitor_source,af_override_horse,0,1,[]),

    (50, mtef_scene_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (51, mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (52, mtef_visitor_source,af_override_horse,0,1,[]),
    #not used yet:
    (53, mtef_scene_source,af_override_horse,0,1,[]),
    (54, mtef_scene_source,af_override_horse,0,1,[]),
    (55, mtef_scene_source,af_override_horse,0,1,[]),
    #used for tournament master scene
    (54,mtef_visitor_source,af_override_horse,0,1,[]),
    (55,mtef_visitor_source,af_override_horse,0,1,[]),
    (56,mtef_visitor_source,af_override_horse|af_castle_lord,0,1,[]),
    (57,mtef_visitor_source,af_override_horse,0,1,[]),
    (58,mtef_visitor_source,af_override_horse|af_castle_lord,0,1,[]),
    (59,mtef_visitor_source,af_override_horse,0,1,[]),
    (60,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + storms + global_common_triggers +
  tournament_triggers
),

("arena_melee_fight_barbarian",mtf_arena_fight,-1, "You enter a melee fight in the arena.",[
    (0,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (1,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (2,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (3,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (4,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (5,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (6,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (7,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),

    (8,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (9,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (10,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (11,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (12,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (13,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (14,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (15,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),

    (16,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (17,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (18,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (19,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (20,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (21,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (22,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (23,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),

    (24,mtef_visitor_source|mtef_team_3,af_override_horse,aif_start_alarmed,1,[]),
    (25,mtef_visitor_source|mtef_team_3,af_override_horse,aif_start_alarmed,1,[]),
    (26,mtef_visitor_source|mtef_team_3,af_override_horse,aif_start_alarmed,1,[]),
    (27,mtef_visitor_source|mtef_team_3,af_override_horse,aif_start_alarmed,1,[]),
    (28,mtef_visitor_source|mtef_team_3,af_override_horse,aif_start_alarmed,1,[]),
    (29,mtef_visitor_source|mtef_team_3,af_override_horse,aif_start_alarmed,1,[]),
    (30,mtef_visitor_source|mtef_team_3,af_override_horse,aif_start_alarmed,1,[]),
    (31,mtef_visitor_source|mtef_team_3,af_override_horse,aif_start_alarmed,1,[]),
    #32
    (32,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_foot,aif_start_alarmed,1,[]),
    (33,mtef_visitor_source|mtef_team_2,af_override_horse|af_override_foot,aif_start_alarmed,1,[]),
    (34,mtef_visitor_source|mtef_team_3,af_override_horse|af_override_foot,aif_start_alarmed,1,[]),
    (35,mtef_visitor_source|mtef_team_4,af_override_horse|af_override_foot,aif_start_alarmed,1,[]),
    (36,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_foot,aif_start_alarmed,1,[]), #SB : change this to lower ammo amount
    (37,mtef_visitor_source|mtef_team_2,af_override_horse|af_override_foot,aif_start_alarmed,1,[]),
    (38,mtef_visitor_source|mtef_team_3,af_override_horse|af_override_foot,aif_start_alarmed,1,[]),
    (39,mtef_visitor_source|mtef_team_4,af_override_horse|af_override_foot,aif_start_alarmed,1,[]),
    #40-49 used for spectators
    (40,mtef_visitor_source,af_override_horse,0,1,[]),
    (41,mtef_visitor_source,af_override_horse,0,1,[]),
    (42,mtef_visitor_source,af_override_horse,0,1,[]),

    (43,mtef_visitor_source|mtef_team_3,af_override_horse,aif_start_alarmed,1,[]),
    (44,mtef_visitor_source|mtef_team_3,af_override_horse,aif_start_alarmed,1,[]),

    (45,mtef_visitor_source,af_override_horse,0,1,[]),
    (46,mtef_visitor_source,af_override_horse,0,1,[]),
    (47,mtef_visitor_source,af_override_horse,0,1,[]),
    (48,mtef_visitor_source,af_override_horse,0,1,[]),
    (49,mtef_visitor_source,af_override_horse,0,1,[]),

    (50, mtef_scene_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (51, mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (52, mtef_visitor_source,af_override_horse,0,1,[]),
    #not used yet:
    (53, mtef_scene_source,af_override_horse,0,1,[]),
    (54, mtef_scene_source,af_override_horse,0,1,[]),
    (55, mtef_scene_source,af_override_horse,0,1,[]),
    #used for tournament master scene
    (54,mtef_visitor_source,af_override_horse,0,1,[]),
    (55,mtef_visitor_source,af_override_horse,0,1,[]),
    (56,mtef_visitor_source,af_override_horse|af_castle_lord,0,1,[]),
    (57,mtef_visitor_source,af_override_horse,0,1,[]),
    (58,mtef_visitor_source,af_override_horse|af_castle_lord,0,1,[]),
    (59,mtef_visitor_source,af_override_horse,0,1,[]),
    (60,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + storms + global_common_triggers +
  tournament_triggers
),

  (
    "arena_challenge_fight",mtf_arena_fight|mtf_commit_casualties,-1,
    "You enter a melee fight in the arena.",
    [
      (56, mtef_visitor_source|mtef_team_0, 0, aif_start_alarmed, 1, []),
      (58, mtef_visitor_source|mtef_team_2, 0, aif_start_alarmed, 1, []),
    ], p_wetter + storms + global_common_triggers +
    [
      cannot_spawn_commoners,
    improved_lightning,
      # common_inventory_not_available,
      # (ti_tab_pressed, 0, 0, [(display_message, "str_cannot_leave_now")],[]),
      # (ti_before_mission_start, 0, 0, [],[(call_script, "script_change_banners_and_chest")]),

      # (0, 0, ti_once, [],
       # [
         # (call_script, "script_music_set_situation_with_culture", mtf_sit_arena),
         # ]),


	# #NOTE -- THIS IS A VESTIGIAL SCRIPT. FOR LORD DUELS, USE THE NEXT SCRIPT DOWN
      # (1, 4, ti_once, [
	  # (this_or_next|main_hero_fallen),
		# (num_active_teams_le,1)],
       # [
           # (try_begin),
             # (main_hero_fallen),
			 # (check_quest_active, "qst_duel_for_lady"),
			 # (quest_slot_eq, "qst_duel_for_lady", slot_quest_target_troop, "$g_duel_troop"),
             # (call_script, "script_fail_quest", "qst_duel_for_lady"),
           # (else_try),
			 # (check_quest_active, "qst_duel_for_lady"),
			 # (quest_slot_eq, "qst_duel_for_lady", slot_quest_target_troop, "$g_duel_troop"),
             # (call_script, "script_succeed_quest", "qst_duel_for_lady"),
		   # (else_try),
             # (main_hero_fallen),
			 # (check_quest_active, "qst_duel_courtship_rival"),
			 # (quest_slot_eq, "qst_duel_courtship_rival", slot_quest_target_troop, "$g_duel_troop"),
             # (call_script, "script_fail_quest", "qst_duel_courtship_rival"),
           # (else_try),
			 # (check_quest_active, "qst_duel_courtship_rival"),
			 # (quest_slot_eq, "qst_duel_courtship_rival", slot_quest_target_troop, "$g_duel_troop"),
             # (call_script, "script_succeed_quest", "qst_duel_courtship_rival"),
		   # (else_try),
             # (main_hero_fallen),
			 # (check_quest_active, "qst_duel_avenge_insult"),
			 # (quest_slot_eq, "qst_duel_avenge_insult", slot_quest_target_troop, "$g_duel_troop"),
             # (call_script, "script_fail_quest", "qst_duel_avenge_insult"),
           # (else_try),
			 # (check_quest_active, "qst_duel_avenge_insult"),
			 # (quest_slot_eq, "qst_duel_avenge_insult", slot_quest_target_troop, "$g_duel_troop"),
             # (call_script, "script_succeed_quest", "qst_duel_avenge_insult"),
		   # (else_try),
             # (main_hero_fallen),
			 # (check_quest_active, "qst_denounce_lord"),
			 # (quest_slot_eq, "qst_denounce_lord", slot_quest_target_troop, "$g_duel_troop"),
             # (call_script, "script_fail_quest", "qst_denounce_lord"),
           # (else_try),
			 # (check_quest_active, "qst_denounce_lord"),
			 # (quest_slot_eq, "qst_denounce_lord", slot_quest_target_troop, "$g_duel_troop"),
             # (call_script, "script_succeed_quest", "qst_denounce_lord"),
		   # (else_try),
			 # (quest_get_slot, ":target_troop", "qst_denounce_lord", slot_quest_target_troop),
		     # (str_store_troop_name, s4, ":target_troop"),
		   # (try_end),
           # (finish_mission),
           # ]),
    ],
  ),

  (
    "duel_with_lord",mtf_arena_fight|mtf_commit_casualties,-1,
    "You enter a melee fight in the arena.",
    [
      (0, mtef_visitor_source|mtef_team_0,af_override_weapons|af_override_horse,aif_start_alarmed,1,[itm_roman_spatha]), #dckplmc
      (16, mtef_visitor_source|mtef_team_1,af_override_weapons|af_override_horse,aif_start_alarmed,1,[itm_roman_spatha]),
      #SB : use these for castle courtyard duels
      (23, mtef_visitor_source|mtef_team_0,af_override_weapons|af_override_horse,aif_start_alarmed,1,[itm_roman_spatha]),
      (24, mtef_visitor_source|mtef_team_1,af_override_weapons|af_override_horse,aif_start_alarmed,1,[itm_roman_spatha]),

    ], p_wetter + storms + global_common_triggers +
    [
      cannot_spawn_commoners,
      improved_lightning,

      common_inventory_not_available,
      (ti_tab_pressed, 0, 0, [(display_message, "str_cannot_leave_now")],[]),
      (ti_before_mission_start, 0, 0, [],[(call_script, "script_change_banners_and_chest"),
        #SB : remove siege objects if we fight in castles
        (call_script, "script_remove_siege_objects"),
      ]),
      #SB : auto-lose duel if player leaves for some reason
      (ti_on_leave_area, 0, ti_once,
      [],
      [
          (try_for_range, ":quest", "qst_deliver_message_to_prisoner_lord", lady_quests_end),
            (try_begin),
              (eq, ":quest", "qst_deliver_message_to_prisoner_lord"),
              (assign, ":quest", "qst_denounce_lord"),
            (try_end),
            (check_quest_active, ":quest"),
            (quest_slot_eq, ":quest", slot_quest_target_troop, "$g_duel_troop"),
            (call_script, "script_fail_quest", ":quest"),
            (finish_mission),
          (try_end),
      ]),
      (0, 0, ti_once, [],
       [
         (call_script, "script_music_set_situation_with_culture", mtf_sit_arena),
         ]),

      (1, 4, ti_once, [
	  (this_or_next|main_hero_fallen),
		(num_active_teams_le,1)],
       [

          (try_begin),
            (main_hero_fallen),
            (assign, ":state", "script_fail_quest"),
          (else_try),
            (assign, ":state", "script_succeed_quest"),
          (try_end),
          #start at 1 before the duel quests
          (try_for_range, ":quest", "qst_deliver_message_to_prisoner_lord", lady_quests_end),
            (try_begin),
              (eq, ":quest", "qst_deliver_message_to_prisoner_lord"),
              (assign, ":quest", "qst_denounce_lord"),
            (try_end),
            (check_quest_active, ":quest"),
            (quest_slot_eq, ":quest", slot_quest_target_troop, "$g_duel_troop"),
            (call_script, ":state", ":quest"),
          (try_end),
          #SB : replace with loop
          (finish_mission),
           ]),
    ],
  ),

("wedding",0,-1,
  "Wedding",[
    (0,mtef_visitor_source,af_override_everything,0,1,[itm_roman_toga, itm_caligea]),
    (1,mtef_visitor_source,af_override_everything,0,1,[itm_bride_dress, itm_simple_hood_3, itm_caligea]),
    (2,mtef_visitor_source,af_castle_lord,0,1,[]),
    (3,mtef_visitor_source,af_override_everything,0,1,[itm_roman_toga,itm_simple_hood_4, itm_caligea]),
    (4,mtef_visitor_source,af_castle_lord,0,1,[]),
    (5,mtef_visitor_source,af_castle_lord,0,1,[]),
    (6,mtef_visitor_source,af_castle_lord,0,1,[]),
    (7,mtef_visitor_source,af_castle_lord,0,1,[]),
    (8,mtef_visitor_source,af_castle_lord,0,1,[]),
    (9,mtef_visitor_source,af_castle_lord,0,1,[]),
    (10,mtef_visitor_source,af_castle_lord,0,1,[]),
    (11,mtef_visitor_source,af_castle_lord,0,1,[]),
    (12,mtef_visitor_source,af_castle_lord,0,1,[]),
    (13,mtef_visitor_source,af_castle_lord,0,1,[]),
    (14,mtef_visitor_source,af_castle_lord,0,1,[]),
    (15,mtef_visitor_source,af_castle_lord,0,1,[]),
    (16,mtef_visitor_source,af_castle_lord,0,1,[]),
    (17,mtef_visitor_source,af_castle_lord,0,1,[]),
    (18,mtef_visitor_source,af_castle_lord,0,1,[]),
    (19,mtef_visitor_source,af_castle_lord,0,1,[]),
    (20,mtef_visitor_source,af_castle_lord,0,1,[]),
    (21,mtef_visitor_source,af_castle_lord,0,1,[]),
    (22,mtef_visitor_source,af_castle_lord,0,1,[]),
    (23,mtef_visitor_source,af_castle_lord,0,1,[]),
    (24,mtef_visitor_source,af_castle_lord,0,1,[]),
    (25,mtef_visitor_source,af_castle_lord,0,1,[]),
    (26,mtef_visitor_source,af_castle_lord,0,1,[]),
    (27,mtef_visitor_source,af_castle_lord,0,1,[]),
    (28,mtef_visitor_source,af_castle_lord,0,1,[]),
    (29,mtef_visitor_source,af_castle_lord,0,1,[]),
    (30,mtef_visitor_source,af_castle_lord,0,1,[]),
    (31,mtef_visitor_source,af_castle_lord,0,1,[]),
  ], global_common_triggers +
  [
    cannot_spawn_commoners,
    (ti_tab_pressed, 0, 0, [],[
      (show_object_details_overlay, 1),
      (finish_mission,0),
    ]),
    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (show_object_details_overlay, 1),
      (finish_mission,0),
    ]),
    (ti_after_mission_start, 0, 0, [],[
      (assign, "$g_wedding_state", 0),
      (play_track, "track_wedding", 2),
      (show_object_details_overlay, 0),
      (play_track, "track_cutscene_wedding", 2),
    ]),
    # remove snow and make weather nice on weddings
    (ti_before_mission_start, 0, 0, [
    ],[
      (set_global_cloud_amount, 0),
      (set_global_haze_amount, 0),
      (set_rain, 2, 0),
      (set_rain, 1, 0),
      (set_rain, 0, 100),
      ##shader, disable seasons in deserts or mediterrainian
      (set_fixed_point_multiplier, 1),
      (set_shader_param_float, "@vSeason",0),#no snow in deserts, 0 means spring
    ]),
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (agent_get_troop_id, ":troop_no", ":agent_no"),

      (assign, ":x_correction", 11900),
      (assign, ":y_correction", 13100),
      (assign, ":z_correction", 100),

      (try_begin),
        (call_script, "script_cf_dplmc_troop_is_female", ":troop_no"),
        (assign, ":gender", 1),
      (else_try),
        (assign, ":gender", 0),
      (try_end),
      (set_fixed_point_multiplier, 100),
      (try_begin),
        (eq, ":troop_no", "$g_wedding_bishop_troop"),
      (else_try),
        (eq, ":troop_no", "$g_wedding_bride_troop"),
        (try_begin),
          (eq, ":gender", 0),
          (agent_equip_item, ":agent_no", "itm_roman_toga"),
          (agent_equip_item, ":agent_no", "itm_caligea"),
          (agent_unequip_item, ":agent_no", "itm_bride_crown"),
        (try_end),
        (agent_set_no_dynamics, ":agent_no", 1),
        (init_position, pos16),
        (call_script, "script_point_move", 100, pos16, ":x_correction", ":y_correction", ":z_correction"),

        (position_set_z, pos16, -1000),
        (agent_set_position, ":agent_no", pos16),
      (else_try),
        (eq, ":troop_no", "$g_wedding_brides_dad_troop"),
        (agent_set_no_dynamics, ":agent_no", 1),
        (init_position, pos15),
        (call_script, "script_point_move", 100, pos15, ":x_correction", ":y_correction", ":z_correction"),

        (position_set_z, pos15, -1000),
        (agent_set_position, ":agent_no", pos15),
      (else_try),
        (eq, ":troop_no", "$g_wedding_groom_troop"),
        (try_begin),
          (eq, ":gender", 1),
          (agent_equip_item, ":agent_no", "itm_roman_noble_dress_5"),
          (agent_equip_item, ":agent_no", "itm_caligea"),
        (try_end),
        (agent_set_no_dynamics, ":agent_no", 1),
        (init_position, pos14),
        (call_script, "script_point_move", 100, pos14, ":x_correction", ":y_correction", ":z_correction"),

        (position_move_x, pos14, 175),
        (position_move_z, pos14, 10),
        (position_rotate_z, pos14, 180),
        (agent_set_position, ":agent_no", pos14),
        (agent_set_animation, ":agent_no", "anim_wedding_groom_wait"),
      (else_try),
        (try_begin),
          (eq, ":gender", 0), #male
          (store_random_in_range, ":random_no", 0, 3),
          (try_begin),
            (eq, ":random_no", 0),
            (agent_set_slot, ":agent_no", slot_agent_cur_animation, "anim_wedding_guest_notr"),
            (agent_set_animation, ":agent_no", "anim_wedding_guest_notr"),
          (else_try),
            (agent_set_slot, ":agent_no", slot_agent_cur_animation, "anim_wedding_guest"),
            (agent_set_animation, ":agent_no", "anim_wedding_guest"),
          (try_end),
        (else_try), #female
          (agent_set_slot, ":agent_no", slot_agent_cur_animation, "anim_wedding_guest_woman"),
          (agent_set_animation, ":agent_no", "anim_wedding_guest_woman"),
        (try_end),
        (store_random_in_range, ":progress", 0, 100),
        (agent_set_animation_progress, ":agent_no", ":progress"),
      (try_end),
    ]),
    (0, 0, 0,[
      (assign, ":x_correction", 11900),
      (assign, ":y_correction", 13100),
      (assign, ":z_correction", 100),
      (store_mission_timer_a, ":cur_time"),
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (try_begin),
          (eq, ":troop_no", "$g_wedding_groom_troop"),
        (else_try),
          (eq, ":troop_no", "$g_wedding_bride_troop"),
        (else_try),
          (eq, ":troop_no", "$g_wedding_brides_dad_troop"),
        (else_try),
          (eq, ":troop_no", "$g_wedding_bishop_troop"),
        (else_try),
          (agent_get_slot, ":cur_animation", ":agent_no", slot_agent_cur_animation),
          (agent_set_animation, ":agent_no", ":cur_animation"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$g_wedding_state", 0),
        (mission_cam_set_mode, 1, 0, 0),

        (init_position, pos1),
        (entry_point_get_position, pos1, 60),
        (mission_cam_set_position, pos1),

        # (position_get_x, reg1, pos1),
        # (position_get_y, reg2, pos1),
        # (position_get_z, reg3, pos1),
        # (display_message, "@x: {reg1} y: {reg2} z: {reg3}"),

        (init_position, pos1),
        (entry_point_get_position, pos1, 61),
        (mission_cam_animate_to_position, pos1, 4000, 0),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 1),
        (ge, ":cur_time", 4),

        (init_position, pos1),
        (entry_point_get_position, pos1, 62),
        (mission_cam_set_position, pos1),

        (init_position, pos1),
        (entry_point_get_position, pos1, 63),
        (mission_cam_animate_to_position, pos1, 6000, 1),

        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 2),
        (ge, ":cur_time", 9),
        (mission_cam_animate_to_screen_color, 0xFF000000, 1000),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 3),
        (ge, ":cur_time", 10),

        (init_position, pos1),
        (position_move_x, pos1, 175),
        (position_move_z, pos1, 10),
        (call_script, "script_point_move", 100, pos1, ":x_correction", ":y_correction", ":z_correction"),
        (position_rotate_z, pos1, 180),
        (try_for_agents, ":agent_no"),
          (agent_get_troop_id, ":agent_troop", ":agent_no"),
          (try_begin),
            (eq, ":agent_troop", "$g_wedding_bride_troop"),
            (agent_set_position, ":agent_no", pos1),
            (agent_set_animation, ":agent_no", "anim_wedding_bride_stairs"),
          (else_try),
            (eq, ":agent_troop", "$g_wedding_brides_dad_troop"),
            (agent_set_position, ":agent_no", pos1),
            (agent_set_animation, ":agent_no", "anim_wedding_dad_stairs"),
          (try_end),
        (try_end),

        (init_position, pos1),
        (entry_point_get_position, pos1, 64),
        (mission_cam_set_position, pos1),

        (init_position, pos1),
        (entry_point_get_position, pos1, 65),
        (mission_cam_animate_to_position, pos1, 4000, 0),
        (mission_cam_animate_to_screen_color, 0x00000000, 500),

        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 4),
        (ge, ":cur_time", 14),

        (init_position, pos1),
        (entry_point_get_position, pos1, 66),
        (mission_cam_set_position, pos1),

        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 5),
        (ge, ":cur_time", 20),

        (init_position, pos1),
        (call_script, "script_point_move", 100, pos1, ":x_correction", ":y_correction", ":z_correction"),
        (position_move_x, pos1, 175),
        (position_move_z, pos1, 10),
        (position_rotate_z, pos1, 180),
        (try_for_agents, ":agent_no"),
          (agent_get_troop_id, ":agent_troop", ":agent_no"),
          (try_begin),
            (eq, ":agent_troop", "$g_wedding_bride_troop"),
            (agent_set_position, ":agent_no", pos1),
            (agent_set_animation, ":agent_no", "anim_wedding_bride_walk"),
          (else_try),
            (eq, ":agent_troop", "$g_wedding_brides_dad_troop"),
            (agent_set_position, ":agent_no", pos1),
            (agent_set_animation, ":agent_no", "anim_wedding_dad_walk"),
          (try_end),
        (try_end),

        (init_position, pos1),
        (entry_point_get_position, pos1, 67),
        (mission_cam_set_position, pos1),

        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 6),
        (ge, ":cur_time", 22),
        (init_position, pos1),
        (entry_point_get_position, pos1, 68),
        (mission_cam_set_position, pos1),

        (position_rotate_z, pos1, 10),
        (mission_cam_animate_to_position, pos1, 2000, 0),

        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 7),
        (ge, ":cur_time", 24),

        (init_position, pos1),
        (call_script, "script_point_move", 100, pos1, ":x_correction", ":y_correction", ":z_correction"),
        (position_move_x, pos1, 175),
        (position_move_z, pos1, 10),
        (position_rotate_z, pos1, 180),
        (try_for_agents, ":agent_no"),
          (agent_get_troop_id, ":agent_troop", ":agent_no"),
          (try_begin),
            (eq, ":agent_troop", "$g_wedding_bride_troop"),
            (agent_set_position, ":agent_no", pos1),
            (agent_set_animation, ":agent_no", "anim_wedding_bride_last"),
          (else_try),
            (eq, ":agent_troop", "$g_wedding_brides_dad_troop"),
            (agent_set_position, ":agent_no", pos1),
            (agent_set_animation, ":agent_no", "anim_wedding_dad_last"),
          (else_try),
            (eq, ":agent_troop", "$g_wedding_groom_troop"),
            (agent_set_position, ":agent_no", pos1),
            (agent_set_animation, ":agent_no", "anim_wedding_groom_last"),
          (try_end),
        (try_end),

        (init_position, pos1),
        (entry_point_get_position, pos1, 67),
        (mission_cam_set_position, pos1),

        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 8),
        (ge, ":cur_time", 31),
        (init_position, pos1),
        (entry_point_get_position, pos1, 70),
        (particle_system_burst, "psys_wedding_rose", pos1, 750),

        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 9),
        (ge, ":cur_time", 33),

        (init_position, pos1),
        (entry_point_get_position, pos1, 71),
        (mission_cam_set_position, pos1),
        (position_rotate_z, pos1, -8),
        (position_set_z, pos1, 350),
        (position_rotate_x, pos1, 35),
        (mission_cam_animate_to_position_and_aperture, pos1, 10, 9000, 1),

        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 10),
        (ge, ":cur_time", 41),
        (mission_cam_set_screen_color, 0x00FFFFFF),
        (mission_cam_animate_to_screen_color, 0xFFFFFFFF, 3000),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 11),
        (ge, ":cur_time", 48),
        (show_object_details_overlay, 1),
        (finish_mission,0),
      (try_end),
    ],[]),
]),

("tutorial_training_ground",mtf_arena_fight,-1,
  "You enter the training ground.",
  [
    (0,mtef_visitor_source|mtef_team_0,0,0,1,[]),
  ],[
]),

("quick_battle_battle",mtf_battle_mode,-1,"You lead your men to battle.",[
    (0,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (1,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (2,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (3,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (4,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (5,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (6,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (7,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

    (8,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (9,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (10,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (11,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (12,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (13,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (14,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (15,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

    (16,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (17,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (18,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (19,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (20,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (21,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (22,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (23,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),

    (24,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (25,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (26,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (27,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (28,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (29,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (30,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (31,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,

    (2, 0, ti_once,[],[
      (tutorial_box, "@Some hints:^ You can make a shield taunt by pressing 'K', you can perform a war cry by pressing 'T' and you can change battle speed by pressing 'J'.", "@Ave, Commander!"),
    ]),

    (0, 0, 3,[
      (key_clicked, key_t),
    ],[
      (get_player_agent_no, ":player"),
      (agent_is_alive, ":player"),
      (le, "$warcry_loading", 0),
      (try_for_agents, ":cur_agent"),#effect
          (agent_is_human, ":cur_agent"),
          (agent_is_alive, ":cur_agent"),
          (agent_is_active,":cur_agent"),
          (agent_is_ally, ":cur_agent"),
          (neq, ":cur_agent", ":player"),
          (agent_set_damage_modifier, ":cur_agent", 105),
          (assign, "$warcry_loading", 30),
          (store_random_in_range, ":rand", 0, 100),
          (ge, ":rand", 50),
          (call_script,"script_agent_perform_warcry", ":cur_agent"),
      (try_end),
      (display_message, "str_war_cry",message_positive),
      (call_script, "script_change_courage_around_agent", 5, ":player"),
      (call_script, "script_change_courage_around_agent_for_routed_agents", 5, ":player"),
    ]),

    (0, 0, 1,[
      (gt, "$warcry_loading", 0),
    ],[
      (val_sub, "$warcry_loading", 1),
    ]),

    common_custom_battle_tab_press,
    common_custom_battle_question_answered,
    common_inventory_not_available,

    (ti_before_mission_start, 0, 0, [],[
      (scene_set_day_time, 15),
    ]),

    common_battle_init_banner,

    (0, 0, ti_once, [],[
      (assign, "$g_battle_result", 0),
      (call_script, "script_init_death_cam"), #SB : add camera
    ]),

    common_music_situation_update,
    custom_battle_check_victory_condition,
    common_battle_victory_display,
    custom_battle_check_defeat_condition,

    moral_trigger_decide_to_run_or_not,

    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),

      (assign, ":initial_courage_score", 5000),

      (agent_get_troop_id, ":troop_id", ":agent_no"),
      (store_character_level, ":troop_level", ":troop_id"),
      (val_mul, ":troop_level", 100), #was 35
      (val_add, ":initial_courage_score", ":troop_level"), #average : 20 * 35 = 700

      (store_random_in_range, ":randomized_addition_courage", 0, 3000), #average : 1500
      (val_add, ":initial_courage_score", ":randomized_addition_courage"),

      (assign, ":cur_morale", 100),

      (store_sub, ":morale_effect_on_courage", ":cur_morale", 70),
      (val_mul, ":morale_effect_on_courage", 30), #this can effect morale with -2100..900
      (val_add, ":initial_courage_score", ":morale_effect_on_courage"),

      #average = 5000 + 700 + 1500 = 7200; min : 5700, max : 8700
      #morale effect = min : -2100(party morale is 0), average : 0(party morale is 70), max : 900(party morale is 100)
      #min starting : 3600, max starting  : 9600, average starting : 7200
      (agent_set_slot, ":agent_no", slot_agent_courage_score, ":initial_courage_score"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent_no"),
      (store_trigger_param_2, ":killer_agent_no"),
      #(store_trigger_param_3, ":is_wounded"),

      (call_script, "script_apply_death_effect_on_courage_scores", ":dead_agent_no", ":killer_agent_no"),
    ]),
    common_battle_order_panel_tick,
  ]
  + improved_horse_archer_ai
  + jacobhinds_morale_triggers
  + ai_horn
  + utility_triggers + battle_panel_triggers + extended_battle_menu + common_division_data + division_order_processing + real_deployment + formations_triggers + AI_triggers
  ##diplomacy begin
  + dplmc_battle_mode_triggers
  ##diplomacy end
  + auxiliary_player
),

("quick_battle_siege", mtf_battle_mode,-1,
  "You lead your men to battle.",[
    (0,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (1,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (2,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (3,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (4,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (5,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (6,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (7,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

    (8,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (9,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (10,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (11,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (12,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (13,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (14,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
    (15,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

    (16,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (17,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (18,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (19,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (20,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (21,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (22,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (23,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),

    (24,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (25,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (26,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (27,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (28,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (29,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (30,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (31,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),

    (32,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (33,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (34,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (35,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (36,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (37,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (38,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (39,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (40,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (41,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (42,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (43,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (44,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (45,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (46,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (47,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (48,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (49,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (50,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (51,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (52,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (53,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (54,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (55,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (56,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (57,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (58,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (59,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (60,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (61,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (62,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (63,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (64,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (65,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (66,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (67,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (68,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (69,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (70,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (71,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (72,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (73,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (74,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (75,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (76,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (77,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (78,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (79,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (80,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (81,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (82,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (83,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (84,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (85,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (86,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (87,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (88,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (89,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (90,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (91,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (92,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (93,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (94,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (95,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (96,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (97,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (98,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (99,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (100,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (101,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (102,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (103,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (104,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (105,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (106,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (107,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (108,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (109,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (110,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (111,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (112,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (113,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (114,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (115,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (116,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (117,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (118,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (119,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (120,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (121,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (122,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (123,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (124,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (125,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (126,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (127,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    (ti_on_agent_spawn,1,0, [],[
      (try_for_agents, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_human, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
          (try_begin),
            (this_or_next|eq, ":troop", "trp_guest"),
            (this_or_next|eq, ":troop", "trp_slave"),
            (this_or_next|eq, ":troop", "trp_slave_female"),
            (eq, ":troop", "trp_guest_female"),
            (agent_set_stand_animation, ":agent", "anim_arena_stand_idle"),
            (agent_set_animation, ":agent", "anim_arena_stand_idle"),
            (store_random_in_range,":r",0,300),
          (try_end),
        (agent_set_animation_progress,":agent",":r"),
      (try_end),
    ]),

    (ti_on_agent_hit, 0, 0, [],[
      (store_trigger_param_1, ":inflicted_agent"),
      (store_trigger_param_2, ":dealer_agent"),
      (store_trigger_param_3, ":inflicted_damage"),

      (set_trigger_result, -1),
      (gt, ":inflicted_damage", 0),
      (set_trigger_result, ":inflicted_damage"),
      (get_player_agent_no, ":player_agent"),
      (try_begin),
        (agent_is_human, ":dealer_agent"),
        (assign, ":dealer_item_id", reg0),
        (is_between, ":dealer_item_id", all_items_begin, all_items_end),

        (try_begin),
          (agent_is_human, ":inflicted_agent"),
          (agent_get_position, pos1, ":inflicted_agent"),
          (agent_get_position, pos2, ":dealer_agent"),
          (try_begin),
            (position_is_behind_position, pos2, pos1),
            (item_get_type, ":item_type", ":dealer_item_id"),
            (this_or_next|eq, ":item_type", itp_type_one_handed_wpn),
            (this_or_next|eq, ":item_type", itp_type_two_handed_wpn),
            (eq, ":item_type", itp_type_polearm),
            # dest damage ratio is 1/2
            (assign, ":dest_damage", ":inflicted_damage"),
            (val_div, ":dest_damage", 2),
            (store_agent_hit_points, ":inflicted_agent_hp", ":inflicted_agent", 1),
            (val_sub, ":inflicted_agent_hp", ":dest_damage"),
            (val_max, ":inflicted_agent_hp", 0),
            (agent_set_hit_points, ":inflicted_agent", ":inflicted_agent_hp", 1),

            # messages for player
            (assign, reg1, ":dest_damage"),
            (try_begin),
              (eq, ":dealer_agent", ":player_agent"),
              (display_message, "@Delivered {reg1} extra damage from behind!", 0xFF0000),
            (else_try),
              (eq, ":inflicted_agent", ":player_agent"),
              (display_message, "@Received {reg1} extra damage from behind!", 0xFF0000),
            (try_end),
            (try_begin),
              (agent_get_horse, ":horse_yes_no", ":inflicted_agent"),
              (eq, ":horse_yes_no", -1),
              (agent_set_animation, ":inflicted_agent","anim_strike_fall_back_rise"),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, ti_once, [],[
      (mission_disable_talk),
      (play_sound, "snd_arena_ambiance", sf_looping),
      # 90 bis 95
      (entry_point_get_position, pos10, 90),
      (set_spawn_position, pos10),
      (spawn_item, "itm_stones_siege",0,0),
      (entry_point_get_position, pos10, 91),
      (set_spawn_position, pos10),
      (spawn_item, "itm_greek_fire",0,0),
      (entry_point_get_position, pos10, 92),
      (set_spawn_position, pos10),
      (spawn_item, "itm_greek_fire",0,0),
      (entry_point_get_position, pos10, 93),
      (set_spawn_position, pos10),
      (spawn_item, "itm_stones_siege",0,0),
      (entry_point_get_position, pos10, 94),
      (set_spawn_position, pos10),
      (spawn_item, "itm_greek_fire",0,0),
      (entry_point_get_position, pos10, 95),
      (set_spawn_position, pos10),
      (spawn_item, "itm_greek_fire",0,0),
		]),

	  (2, 0, ti_once,[],[
      (tutorial_box, "@Some hints:^ You can make a shield taunt by pressing 'K', you can perform a war cry by pressing 'T' and you can change battle speed by pressing 'J'. You and the AI can also perform a shield bash.", "@Ave Caesar, morituri te salutant"),
		]),

    (0, 0, 3,[
      (key_clicked, key_t),
    ],[
      (get_player_agent_no, ":player"),
      (agent_is_alive, ":player"),
      # (assign, reg40, "$battle_ratio"),
      # (display_message, "@Battle ratio: {reg40}"),
      (le, "$warcry_loading", 0),
      (try_for_agents, ":cur_agent"),#effect
          (agent_is_human, ":cur_agent"),
          (agent_is_alive, ":cur_agent"),
          (agent_is_active,":cur_agent"),
          (agent_is_ally, ":cur_agent"),
          (neq, ":cur_agent", ":player"),
          #(agent_set_damage_modifier, ":cur_agent", 105),
          (assign, "$warcry_loading", 30),
          (store_random_in_range, ":rand", 0, 100),
          (ge, ":rand", 50),
          (call_script,"script_agent_perform_warcry", ":cur_agent"),
      (try_end),
      (display_message, "str_war_cry",message_positive),
      (call_script, "script_agent_perform_warcry", ":player"),
      (call_script, "script_change_courage_around_agent", 10, ":player"),
      (call_script, "script_change_courage_around_agent_for_routed_agents", 10, ":player"),
    ]),
    (0, 0, 1,[
      (gt, "$warcry_loading", 0),
    ],[
      (val_sub, "$warcry_loading", 1),
    ]),
    common_battle_mission_start,
    common_battle_init_banner,

    (0, 0, ti_once,[
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],[
		  (call_script, "script_init_death_cam"), #SB : add camera
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (scene_set_day_time, 15),
    ]),

    common_custom_battle_tab_press,
    common_custom_battle_question_answered,
    common_inventory_not_available,
    common_music_situation_update,
    custom_battle_check_victory_condition,
    common_battle_victory_display,
    custom_battle_check_defeat_condition,
    common_battle_order_panel_tick,
  ]
    + theoris_decapitation
    + utility_triggers
	  + dplmc_battle_mode_triggers
    + auxiliary_player
),

("bandit_lair",mtf_battle_mode|mtf_synch_inventory,charge,
  "Ambushing a bandit lair",[
    (0,mtef_team_0|mtef_use_exact_number,af_override_horse, aif_start_alarmed, 40,[]),
    (1,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
    (2,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
    (3,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
    (4,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
    (5,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
    (6,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
    (7,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
    (8,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
    (9,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
    (10,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    common_nobody_stalls,
    cannot_spawn_commoners,
    common_battle_init_banner,
    improved_lightning,
    common_inventory_not_available,

    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (assign, "$relative_of_merchant_is_found", 0),
      (try_begin),
          (agent_is_human, ":agent_no"),
          (agent_is_alive, ":agent_no"),
          (agent_get_team, ":agent_team", ":agent_no"),
          (eq, ":agent_team", 1),

          (agent_get_position, pos4, ":agent_no"),
          (agent_set_scripted_destination, ":agent_no", pos4, 1),
      (try_end),
      (try_begin),
          (agent_get_troop_id, ":troop_no", ":agent_no"),
          (eq, ":troop_no", "trp_relative_of_merchant"),
          (agent_set_team, ":agent_no", 7),
          (team_set_relation, 0, 7, 0),
      (try_end),
    ]),

	  (0, 0, 0,[
      (party_get_template_id, ":template", "$g_encountered_party"),
      (eq, ":template", "pt_looter_lair"),
      (check_quest_active, "qst_save_relative_of_merchant"),
      (eq, "$relative_of_merchant_is_found", 0),
    ],[
      (get_player_agent_no, ":player_agent"),
      (agent_get_position, pos0, ":player_agent"),

      (try_for_agents, ":agent_no"),
          (agent_get_troop_id, ":troop_no", ":agent_no"),
          (eq, ":troop_no", "trp_relative_of_merchant"),
          (agent_set_scripted_destination, ":agent_no", pos0),
          (agent_get_position, pos1, ":agent_no"),
          (get_distance_between_positions, ":dist", pos0, pos1),
          (le, ":dist", 200),
          #(assign, "$g_talk_troop", "trp_relative_of_merchant"),
          (start_mission_conversation, "trp_relative_of_merchant"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0,[
      (display_message, "str_cannot_leave_now"),
    ],[]),

    (1, 0, ti_once, [],[
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$bandits_spawned_extra", 0),
    ]),
    (1, 0, 0, [],[
      (try_for_agents, ":bandit_id"),
        (agent_is_alive, ":bandit_id"),
        (agent_get_team, ":agent_team_1", ":bandit_id"),
        (eq, ":agent_team_1", 1),
        (agent_is_in_special_mode, ":bandit_id"),
        (agent_is_human, ":bandit_id"),

        (agent_get_position, pos0, ":bandit_id"),
        (try_for_agents, ":player_team_agent_id"),
          (agent_is_alive, ":player_team_agent_id"),
          (agent_get_team, ":agent_team_2", ":player_team_agent_id"),
          (eq, ":agent_team_2", 0),
          (agent_is_human, ":player_team_agent_id"),

          (store_agent_hit_points, ":bandit_hit_points", ":bandit_id"),

          (assign, ":continue", 0),
          (try_begin),
            (lt, ":bandit_hit_points", 100),

            (try_for_agents, ":bandit_2_id"),
              (agent_is_alive, ":bandit_2_id"),
              (agent_get_team, ":bandit_2_team", ":bandit_2_id"),
              (eq, ":bandit_2_team", 1),
              (neq, ":bandit_id", ":bandit_2_id"),
              (agent_is_in_special_mode, ":bandit_2_id"),
              (agent_is_human, ":bandit_2_id"),

              (agent_get_position, pos1, ":bandit_id"),
              (agent_get_position, pos2, ":bandit_2_id"),
              (get_distance_between_positions, ":distance", pos1, pos2),
              (le, ":distance", 1000),

              (agent_clear_scripted_mode, ":bandit_2_id"),
            (try_end),

            (assign, ":continue", 1),
          (else_try),
            (agent_get_position, pos1, ":bandit_id"),
            (agent_get_position, pos2, ":player_team_agent_id"),
            (get_distance_between_positions, ":distance", pos1, pos2),
            (le, ":distance", 4000),

            (try_for_agents, ":bandit_2_id"),
              (agent_is_alive, ":bandit_2_id"),
              (agent_get_team, ":bandit_2_team", ":bandit_2_id"),
              (eq, ":bandit_2_team", 1),
              (neq, ":bandit_id", ":bandit_2_id"),
              (agent_is_in_special_mode, ":bandit_2_id"),
              (agent_is_human, ":bandit_2_id"),

              (agent_get_position, pos1, ":bandit_id"),
              (agent_get_position, pos2, ":bandit_2_id"),
              (get_distance_between_positions, ":distance", pos1, pos2),
              (le, ":distance", 1000),

              (agent_clear_scripted_mode, ":bandit_2_id"),
            (try_end),

            (assign, ":continue", 1),
          (try_end),

          (eq, ":continue", 1),

          (agent_clear_scripted_mode, ":bandit_id"),
        (try_end),
      (try_end),
    ]),

	  (30, 0, 0,[
	    (le, "$defender_reinforcement_stage", 1),
	  ],[
      (store_character_level, ":player_level", "trp_player"),
      (store_add, ":number_of_bandits_will_be_spawned_at_each_period", 5, ":player_level"),
      (val_div, ":number_of_bandits_will_be_spawned_at_each_period", 3),

      (lt, "$bandits_spawned_extra", ":number_of_bandits_will_be_spawned_at_each_period"),
      (val_add, "$bandits_spawned_extra", 1),

      (party_get_template_id, ":template", "$g_encountered_party"),

      (try_begin),
        (eq, ":template", "pt_black_sea_pirates_lair"),
        (assign, ":bandit_troop", "trp_black_sea_priate"),
      (else_try),
        (eq, ":template", "pt_sea_raider_lair"),
        (assign, ":bandit_troop", "trp_sea_raider"),
      (else_try),
        (eq, ":template", "pt_forest_bandit_lair"),
        (assign, ":bandit_troop", "trp_forest_bandit"),
      (else_try),
        (eq, ":template", "pt_gaetuli_bandit_lair"),
        (assign, ":bandit_troop", "trp_gaetuli_horseman"),
      (else_try),
        (eq, ":template", "pt_numidian_bandit_lair"),
        (assign, ":bandit_troop", "trp_sarranid_horseman"),
      (else_try),
        (eq, ":template", "pt_nubian_lair"),
        (assign, ":bandit_troop", "trp_meroe_archers"),
      (else_try),
        (eq, ":template", "pt_desert_bandit_lair"),
        (assign, ":bandit_troop", "trp_desert_bandit"),
      (else_try),
        (eq, ":template", "pt_nabatean_lair"),
        (assign, ":bandit_troop", "trp_arab_noble_archers"),
      (else_try),
        (eq, ":template", "pt_mountain_bandit_lair"),
        (assign, ":bandit_troop", "trp_mountain_bandit"),
      (else_try),
        (eq, ":template", "pt_taiga_bandit_lair"),
        (assign, ":bandit_troop", "trp_taiga_bandit"),
      (else_try),
        (eq, ":template", "pt_steppe_bandit_lair"),
        (assign, ":bandit_troop", "trp_steppe_bandit"),
      (else_try),
        (eq, ":template", "pt_saka_camp"),
        (assign, ":bandit_troop", "trp_saka_heavy_cavalry"),
        (else_try),
          (eq, ":template", "pt_egyptian_bandit_lair"),
          (store_random_in_range, ":bandit_troop", "trp_egyptian_archers", "trp_arab_noble_archers"),
      (else_try),
        (assign, ":bandit_troop", "trp_looter"),
      (try_end),

      (store_current_scene, ":cur_scene"),
      (modify_visitors_at_site, ":cur_scene"),
      (store_random_in_range, ":random_entry_point", 2, 11),
      (add_visitors_to_current_scene, ":random_entry_point", ":bandit_troop", 2),
    ]),
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent_no"),
      #(store_trigger_param_2, ":killer_agent_no"),
      (store_trigger_param_3, ":is_wounded"),
      (try_begin),
        (ge, ":dead_agent_no", 0),
        (neg|agent_is_ally, ":dead_agent_no"),
        (agent_is_human, ":dead_agent_no"),
        (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
        (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
        (party_add_members, "p_temp_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
        (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),
        (try_begin),
            (call_script, "script_cf_force_wound_troop", ":dead_agent_troop_id"),
            (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
            (set_trigger_result, 2),
        (else_try),
            (neg|troop_is_hero, ":dead_agent_troop_id"),
            (eq, "$g_realistic_wounding", 1),
            (le, ":last_damage", 10),
            (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
            (party_wound_members, "p_temp_casualties", ":dead_agent_troop_id", 1),
            (set_trigger_result, 2),
        (else_try),
            (neg|troop_is_hero, ":dead_agent_troop_id"),
            (eq, "$g_realistic_wounding", 1),
            (ge, ":last_damage", 40),
            (set_trigger_result, 1),
        (else_try),
            (try_begin),
                (eq, ":is_wounded", 1),
                (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
                (party_wound_members, "p_temp_casualties", ":dead_agent_troop_id", 1),
            (try_end),
            (set_trigger_result, 0),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":dead_agent_no", 0),
        (agent_is_ally, ":dead_agent_no"),
        (agent_is_human, ":dead_agent_no"),
        (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
        (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),
        (party_get_skill_level, ":surgery", "p_main_party", skl_surgery),
        (store_mul, ":chance", ":surgery", 4),
        (val_add, ":chance", 25),
        (store_random_in_range, ":rand", 0, 100),
        (try_begin),
            (call_script, "script_cf_force_wound_troop", ":dead_agent_troop_id"),
            (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
            (set_trigger_result, 2),
        (else_try),
            (neg|troop_is_hero, ":dead_agent_troop_id"),
            (eq, "$g_realistic_wounding", 1),
            (le, ":last_damage", 10),
            (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
            (party_wound_members, "p_temp_casualties", ":dead_agent_troop_id", 1),
            (set_trigger_result, 2),
        (else_try),
            (neg|troop_is_hero, ":dead_agent_troop_id"),
            (eq, "$g_realistic_wounding", 1),
            (gt, ":rand", ":chance"),
            (ge, ":last_damage", 40),
            (set_trigger_result, 1),
        (else_try),
            (set_trigger_result, 0),
        (try_end),
      (try_end),
      (assign, ":number_of_enemies", 0),
      (try_for_agents, ":cur_agent"),
        (agent_is_active, ":cur_agent"),
        (agent_is_human, ":cur_agent"),
        (agent_is_alive, ":cur_agent"),
        (agent_is_non_player, ":cur_agent"),
        (neg|agent_is_ally, ":cur_agent"),
        (val_add, ":number_of_enemies", 1),
      (try_end),
      (try_begin),
        (le, ":number_of_enemies", 2),
        (le, "$defender_reinforcement_stage", 1),
        (val_add, "$defender_reinforcement_stage", 1),

        (store_character_level, ":player_level", "trp_player"),
        (store_add, ":number_of_bandits_will_be_spawned_at_each_period", 5, ":player_level"),
        (val_div, ":number_of_bandits_will_be_spawned_at_each_period", 3),
        (try_begin),
          (ge, "$defender_reinforcement_stage", 2),
          (val_sub, ":number_of_bandits_will_be_spawned_at_each_period", "$bandits_spawned_extra"),
        (try_end),

        (party_get_template_id, ":template", "$g_encountered_party"),

        (try_begin),
          (eq, ":template", "pt_black_sea_pirates_lair"),
          (assign, ":bandit_troop", "trp_black_sea_priate"),
        (else_try),
          (eq, ":template", "pt_sea_raider_lair"),
          (assign, ":bandit_troop", "trp_sea_raider"),
        (else_try),
          (eq, ":template", "pt_forest_bandit_lair"),
          (assign, ":bandit_troop", "trp_forest_bandit"),
        (else_try),
          (eq, ":template", "pt_gaetuli_bandit_lair"),
          (assign, ":bandit_troop", "trp_gaetuli_horseman"),
        (else_try),
          (eq, ":template", "pt_numidian_bandit_lair"),
          (assign, ":bandit_troop", "trp_sarranid_horseman"),
        (else_try),
          (eq, ":template", "pt_nubian_lair"),
          (assign, ":bandit_troop", "trp_meroe_archers"),
        (else_try),
          (eq, ":template", "pt_desert_bandit_lair"),
          (assign, ":bandit_troop", "trp_desert_bandit"),
        (else_try),
          (eq, ":template", "pt_nabatean_lair"),
          (assign, ":bandit_troop", "trp_arab_noble_archers"),
        (else_try),
          (eq, ":template", "pt_mountain_bandit_lair"),
          (assign, ":bandit_troop", "trp_mountain_bandit"),
        (else_try),
          (eq, ":template", "pt_taiga_bandit_lair"),
          (assign, ":bandit_troop", "trp_taiga_bandit"),
        (else_try),
          (eq, ":template", "pt_steppe_bandit_lair"),
          (assign, ":bandit_troop", "trp_steppe_bandit"),
        (else_try),
          (eq, ":template", "pt_saka_camp"),
          (assign, ":bandit_troop", "trp_saka_heavy_cavalry"),
        (else_try),
          (eq, ":template", "pt_egyptian_bandit_lair"),
          (store_random_in_range, ":bandit_troop", "trp_egyptian_archers", "trp_arab_noble_archers"),
        (else_try),
          (assign, ":bandit_troop", "trp_looter"),
        (try_end),
        (store_current_scene, ":cur_scene"),
        (modify_visitors_at_site, ":cur_scene"),
        (try_for_range, ":unused", 0, ":number_of_bandits_will_be_spawned_at_each_period"),
          (store_random_in_range, ":random_entry_point", 2, 11),
          (add_visitors_to_current_scene, ":random_entry_point", ":bandit_troop", 1),
        (try_end),
      (try_end),
    ]),
    (0, 0, ti_once, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_ambushed),
      (set_party_battle_mode),
    ]),
    (2, 0, ti_once,[
      (neg|main_hero_fallen),
      (num_active_teams_le, 1),
    ],[
      (party_get_template_id, ":template", "$g_encountered_party"),
      (try_begin),
        (eq, ":template", "pt_looter_lair"),
        (check_quest_active, "qst_save_relative_of_merchant"),

        (get_player_agent_no, ":player_agent"),
        (agent_get_position, pos0, ":player_agent"),
        (assign, ":minimum_distance", 100000),
        (try_for_range, ":entry_no", 1, 10),
          (entry_point_get_position, pos1, ":entry_no"),
          (get_distance_between_positions, ":dist", pos0, pos1),
          (le, ":dist", ":minimum_distance"),
          (ge, ":dist", 1000),
          (assign, ":nearest_entry_point", ":entry_no"),
          (assign, ":minimum_distance", ":dist"),
        (try_end),

        (add_visitors_to_current_scene, ":nearest_entry_point", "trp_relative_of_merchant", 1, 0),
      (try_end),
    ]),
    common_battle_order_panel_tick,
    (1, 4, ti_once,[
      (assign, ":continue", 0),
      (party_get_template_id, ":template", "$g_encountered_party"),
      (try_begin),
        (eq, ":template", "pt_looter_lair"),
        (check_quest_active, "qst_save_relative_of_merchant"),
        (this_or_next|main_hero_fallen),
        (eq, "$relative_of_merchant_is_found", 1),
        (assign, ":continue", 1),
      (else_try),
        (this_or_next|neq, ":template", "pt_looter_lair"),
        (neg|check_quest_active, "qst_save_relative_of_merchant"),

        (store_mission_timer_a,":cur_time"),
        (ge, ":cur_time", 5),
        (this_or_next|main_hero_fallen),
        (num_active_teams_le, 1),
        (assign, ":continue", 1),
      (try_end),
      (eq, ":continue", 1),
    ],[
      (try_begin),
        (main_hero_fallen),
      (else_try),
        (party_set_slot, "$g_encountered_party", slot_party_ai_substate, 2),
      (try_end),
      (finish_mission),
    ]),
] + battle_panel_triggers + dplmc_battle_mode_triggers
),

("alley_fight", mtf_battle_mode,charge,
  "Alley fight",[
    (0,mtef_team_0|mtef_use_exact_number,af_override_horse,aif_start_alarmed,7,[]),
    (1,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,20,[]),
    (2,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,20,[]),
    (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,20,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    common_battle_init_banner,
    common_inventory_not_available,

    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (get_player_agent_no, ":player_agent"),
      (neq, ":agent_no", ":player_agent"),
      (assign, "$g_main_attacker_agent", ":agent_no"),
      (agent_ai_set_aggressiveness, ":agent_no", 199),

      (try_begin),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (eq, ":troop_no", "trp_roman_start_merchant"),
        (agent_set_team, ":agent_no", 7),
        (team_set_relation, 0, 7, 0),
      (try_end),
    ]),

	  (0, 0, 0,[
	    (eq, "$talked_with_merchant", 0),
	  ],[
      (get_player_agent_no, ":player_agent"),
      (agent_get_position, pos0, ":player_agent"),

      (try_for_agents, ":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (eq, ":troop_no", "trp_roman_start_merchant"),
        (agent_set_scripted_destination, ":agent_no", pos0),
        (agent_get_position, pos1, ":agent_no"),
        (get_distance_between_positions, ":dist", pos0, pos1),
        (le, ":dist", 200),
        (assign, "$talk_context", tc_back_alley),
        (start_mission_conversation, ":troop_no"),
      (try_end),
    ]),
    (1, 0, 0, [],[
      (get_player_agent_no, ":player_agent"),
      (ge, "$g_main_attacker_agent", 0),
      (ge, ":player_agent", 0),
      (agent_is_active, "$g_main_attacker_agent"),
      (agent_is_active, ":player_agent"),
      (agent_get_position, pos0, ":player_agent"),
      (agent_get_position, pos1, "$g_main_attacker_agent"),
      (get_distance_between_positions, ":dist", pos0, pos1),
      (ge, ":dist", 5),
      (agent_set_scripted_destination, "$g_main_attacker_agent", pos0),
    ]),
    (ti_tab_pressed, 0, 0, [],[
      (display_message, "str_cannot_leave_now"),
    ]),

    (0, 0, ti_once, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_ambushed),
      (set_party_battle_mode),
    ]),

    (0, 0, ti_once,[
      (neg|main_hero_fallen),
      (num_active_teams_le, 1),
    ],[
      (add_visitors_to_current_scene, 3, "trp_roman_start_merchant", 1, 0),
    ]),

    (1, 0, ti_once,[
      (eq, "$talked_with_merchant", 1),
    ],[
      (try_begin),
        (main_hero_fallen),
        (assign, "$g_killed_first_bandit", 0),
      (else_try),
        (assign, "$g_killed_first_bandit", 1),
      (try_end),

      (finish_mission),
      (assign, "$g_main_attacker_agent", 0),
      (assign, "$talked_with_merchant", 1),

      (assign, "$current_startup_quest_phase", 1),

      (change_screen_return),
      (set_trigger_result, 1),

      (get_player_agent_no, ":player_agent"),
      (store_agent_hit_points, ":hit_points", ":player_agent"),

      (try_begin),
        (lt, ":hit_points", 90),
        (agent_set_hit_points, ":player_agent", 90),
      (try_end),
    ]),

    (1, 3, ti_once,[
      (main_hero_fallen),
    ],[
      (try_begin),
        (main_hero_fallen),
        (assign, "$g_killed_first_bandit", 0),
      (else_try),
        (assign, "$g_killed_first_bandit", 1),
      (try_end),

      (finish_mission),
      (assign, "$g_main_attacker_agent", 0),
      (assign, "$talked_with_merchant", 1),

      (assign, "$current_startup_quest_phase", 1),

      (change_screen_return),
      (set_trigger_result, 1),

      (get_player_agent_no, ":player_agent"),
      (store_agent_hit_points, ":hit_points", ":player_agent"),

      (try_begin),
        (lt, ":hit_points", 90),
        (agent_set_hit_points, ":player_agent", 90),
      (try_end),
    ]),
]),

("meeting_merchant",mtf_battle_mode,0,
  "Meeting with the merchant",[
    (0,mtef_visitor_source|mtef_team_0,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (1,mtef_visitor_source|mtef_team_0,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (2,mtef_visitor_source|mtef_team_0,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (3,mtef_visitor_source|mtef_team_0,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (4,mtef_visitor_source|mtef_team_0,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (5,mtef_visitor_source|mtef_team_0,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (6,mtef_visitor_source|mtef_team_0,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (7,mtef_visitor_source|mtef_team_0,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (8,mtef_visitor_source|mtef_team_0,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (9,mtef_visitor_source|mtef_team_0,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    can_spawn_commoners,
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (try_begin),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (eq, ":troop_no", "trp_roman_start_merchant"),
        (agent_set_team, ":agent_no", 7),
        (team_set_relation, 0, 7, 0),
      (try_end),
    ]),

    (1, 0, ti_once, [],[
      (mission_enable_talk),

      (assign, "$dialog_with_merchant_ended", 0),
      (store_current_scene, ":cur_scene"),
      (scene_set_slot, ":cur_scene", slot_scene_visited, 1),
      (try_begin),
        (gt, "$sneaked_into_town", disguise_none),
        (call_script, "script_music_set_situation_with_culture", mtf_sit_town_infiltrate),
      (else_try),
        (eq, "$talk_context", tc_tavern_talk),
        (call_script, "script_music_set_situation_with_culture", mtf_sit_tavern),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
      (try_end),
    ]),

    (1, 0, 0,[
      (assign, ":continue", 0),
      (try_begin),
        (ge, "$dialog_with_merchant_ended", 6),
        (assign, ":continue", 1),
      (else_try),
        (ge, "$dialog_with_merchant_ended", 1),
        (neg|conversation_screen_is_active),

        (try_begin),
          (eq, "$dialog_with_merchant_ended", 1),
          (check_quest_active, "qst_collect_men"),
          (tutorial_box, "str_start_up_first_quest", "@Tutorial"),
        (try_end),

        (val_add, "$dialog_with_merchant_ended", 1),
        (assign, ":continue", 0),
      (try_end),

      (try_begin),
        (conversation_screen_is_active),
        (tutorial_message, -1),
        (assign, ":continue", 0),
      (try_end),

      (eq, ":continue", 1),
    ],[
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "str_press_tab_to_exit_from_town"),
    ]),

    (ti_inventory_key_pressed, 0, 0,[
      (set_trigger_result, 1),
    ],[]),

    (ti_tab_pressed, 0, 0,[
      (try_begin),
        (gt, "$dialog_with_merchant_ended", 0),

        (party_relocate_near_party, "p_main_party", "$current_town", 1),
        (finish_mission),

        (assign, "$current_startup_quest_phase", 2),
        (tutorial_message, -1),
        (tutorial_message_set_background, 0),
        (try_begin),
          (check_quest_finished, "qst_save_town_from_bandits"),
          (assign, "$g_do_one_more_meeting_with_merchant", 1),
        (else_try),
          #will do this at first spawning in the map
          (set_spawn_radius, 50),
          (try_for_range, ":unused", 0, 20),
            (spawn_around_party, "p_main_party", "pt_looters"),
          (try_end),
        (try_end),
        (jump_to_menu, "mnu_auto_return_map"),
        (set_trigger_result, 1),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ],[]),
]),

  (
    "town_fight",0,-1,
    "Town Fight",
    [
      (0,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
      (1,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
      (2,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (3,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (4,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (5,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (6,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (7,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (9,mtef_visitor_source,af_override_horse,0,1,[]),
      (10,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (11,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (12,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (13,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (14,mtef_visitor_source,af_override_horse,0,1,[]),
      (15,mtef_visitor_source,af_override_horse,0,1,[]),
      (16,mtef_visitor_source,af_override_horse,0,1,[]),
      (17,mtef_visitor_source,af_override_horse,0,1,[]),
      (18,mtef_visitor_source,af_override_horse,0,1,[]),
      (19,mtef_visitor_source,af_override_horse,0,1,[]),
      (20,mtef_visitor_source,af_override_horse,0,1,[]),
      (21,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (22,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
	  (23,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #guard
      (24,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]), #guard
	  (25,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #guard
	  (26,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #guard
	  (27,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #guard
	  (28,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #guard
	  (29,mtef_visitor_source,af_override_horse,0,1,[]),
	  (30,mtef_visitor_source,af_override_horse,0,1,[]),
	  (31,mtef_visitor_source,af_override_horse,0,1,[]),
      (32,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #town walker point
	  (33,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #town walker point
	  (34,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #town walker point
	  (35,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #town walker point
	  (36,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #town walker point
	  (37,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #town walker point
	  (38,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #town walker point
	  (39,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #town walker point
      (40,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]), #in towns, can be used for guard reinforcements
	  (41,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]), #in towns, can be used for guard reinforcements
	  (42,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]), #in towns, can be used for guard reinforcements
	  (43,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]), #in towns, can be used for guard reinforcements
      (44,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
	  (45,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
	  (46,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
	  (47,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    ], p_wetter + storms + global_common_triggers +
    [
      cannot_spawn_commoners,
    improved_lightning,
      common_battle_init_banner,

      (ti_on_agent_spawn, 0, 0, [],
      [
        (store_trigger_param_1, ":agent_no"),

        (agent_set_team, ":agent_no", 0),
      ]),

      (ti_before_mission_start, 0, 0, [],
      [
        (mission_disable_talk),

        (assign, "$g_main_attacker_agent", 0),
        (set_party_battle_mode),

        (assign, "$number_of_bandits_killed_by_player", 0),
        (assign, "$number_of_civilian_loses", 0),

        (set_fixed_point_multiplier, 100),
	  ]),

      (1, 0, ti_once,
      [
        (call_script, "script_init_town_walker_agents"),
      ],
      []),

      (ti_on_agent_killed_or_wounded, 0, 0, [],
      [
        (store_trigger_param_1, ":dead_agent_no"),
        (store_trigger_param_2, ":killer_agent_no"),
        #(store_trigger_param_3, ":is_wounded"),

        (try_begin),
          (agent_get_team, ":dead_agent_team_no", ":dead_agent_no"),
          (eq, ":dead_agent_team_no", 1),

          (get_player_agent_no, ":player_agent"),
          (eq, ":player_agent", ":killer_agent_no"),

          (val_add, "$number_of_bandits_killed_by_player", 1),
        (else_try),
          (eq, ":dead_agent_team_no", 0),

          (val_add, "$number_of_civilian_loses", 1),
        (try_end),
      ]),

      (1, 0, 0,
      [
        (lt, "$merchant_sign_count", 8),
  	    (val_add, "$merchant_sign_count", 1),
  	    (try_begin),
  	      (eq, "$merchant_sign_count", 2),
          (get_player_agent_no, ":player_agent"),
  	      (try_for_agents, ":agent_no"),
  	        (agent_get_troop_id, ":agent_troop_id", ":agent_no"),
  	        (eq, ":agent_troop_id", "trp_roman_start_merchant"),

  	        (assign, "$g_city_merchant_troop_id", ":agent_troop_id"),
  	        (assign, "$g_city_merchant_agent_id", ":agent_no"),

  	        (agent_get_position, pos0, ":player_agent"),
  	        (agent_get_position, pos1, ":agent_no"),

  	        (assign, ":max_dif", -1000),
            (try_for_range, ":target_entry_point", 0, 64),
              #(neg|entry_point_is_auto_generated, ":target_entry_point"),
              (entry_point_get_position, pos6, ":target_entry_point"),
              (get_distance_between_positions, ":dist_to_player", pos0, pos6),
              (get_distance_between_positions, ":dist_to_merchant", pos1, pos6),
              (store_sub, ":dif", ":dist_to_merchant", ":dist_to_player"),
              (ge, ":dist_to_merchant", 15),
              (ge, ":dif", ":max_dif"),
              (copy_position, pos2, pos6),
              (assign, ":max_dif", ":dif"),
            (try_end),

            (agent_set_scripted_destination, ":agent_no", pos2, 0),
            (agent_set_speed_limit, ":agent_no", 10),
          (try_end),
        (else_try),
  	      (eq, "$merchant_sign_count", 5),

          (get_player_agent_no, ":player_agent"),
          (agent_get_position, pos0, ":player_agent"),

  	      (agent_set_scripted_destination, "$g_city_merchant_agent_id", pos0, 0),
          (agent_set_speed_limit, "$g_city_merchant_agent_id", 10),
        (else_try),
  	      (eq, "$merchant_sign_count", 7),

  	      (agent_clear_scripted_mode, "$g_city_merchant_agent_id"),

  	      (assign, "$talk_context", tc_town_talk),
  	      (start_mission_conversation, "$g_city_merchant_troop_id"),
  	    (try_end),
  	  ],
	  []),

	  (0, 0, 0, [], #dckplmc - was 1, 0, 0,
	  [
	    (ge, "$merchant_sign_count", 8),

	    (get_player_agent_no, ":player_agent"),

        (try_for_agents, ":agent_no"),
          (neq, ":agent_no", ":player_agent"),
          (agent_is_alive, ":agent_no"),
          (agent_get_team, ":agent_team", ":agent_no"),
          (eq, ":agent_team", 0),

          (agent_get_position, pos0, ":agent_no"),

          (assign, ":minimum_distance", 10000),
          (try_for_agents, ":bandit_no"),
            (agent_is_alive, ":bandit_no"),
            (agent_get_team, ":bandit_team", ":bandit_no"),
            (eq, ":bandit_team", 1),

            (agent_get_position, pos1, ":bandit_no"),

            (get_distance_between_positions, ":dist", pos0, pos1),
            (le, ":dist", ":minimum_distance"),
            (assign, ":minimum_distance", ":dist"),
            (copy_position, pos2, pos1),
          (try_end),

          (assign, reg1, ":dist"),
          (try_begin),
            (le, ":minimum_distance", 1000), #dckplmc - was 500
            (agent_clear_scripted_mode, ":agent_no"),
          (else_try),
            (lt, ":minimum_distance", 10000),
            (agent_set_scripted_destination, ":agent_no", pos2, 0),
          (try_end),
        (try_end),
      ]),

      (3, 0, 0,
      [
        (lt, "$merchant_sign_count", 8),
  	    (call_script, "script_tick_town_walkers")
  	  ],
	  []),

      (2, 0, 0,
      [
        (call_script, "script_center_ambiance_sounds")
      ],
      []),

      (ti_before_mission_start, 0, 0,
      [],
      [
        (call_script, "script_change_banners_and_chest")
      ]),

      (1, 4, ti_once,
       [
         (this_or_next|main_hero_fallen),
         (num_active_teams_le, 1),

         (ge, "$merchant_sign_count", 8),
       ],
       [
         (try_begin),
           (main_hero_fallen),
           (assign, "$g_killed_first_bandit", 0),
         (else_try),
           (assign, "$g_killed_first_bandit", 1),
         (try_end),
         (assign, "$current_startup_quest_phase", 4),
         (mission_enable_talk),
         (finish_mission),
         (change_screen_return),
         (set_trigger_result, 1),
       ]),

      (ti_inventory_key_pressed, 0, 0,
      [
        (try_begin),
          (eq, "$g_mt_mode", tcm_default),
          (set_trigger_result,1),
        (else_try),
          (eq, "$g_mt_mode", tcm_disguised),
          (display_message,"str_cant_use_inventory_disguised"),
        (else_try),
          (display_message, "str_cant_use_inventory_now"),
        (try_end),
      ],[]),

      (ti_tab_pressed, 0, 0,
      [
        (display_message, "str_cannot_leave_now"),
      ],[]),
  ]),

("camp",0,-1,
  "You start training.",[
    (0,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (1,mtef_visitor_source,af_override_horse|af_override_head|af_override_gloves|af_override_weapons,0,1,[]), #special companion
    (2,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]), #companions
    (3,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (4,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (5,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (6,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (7,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (8,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (9,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (10,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (11,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (12,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (13,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (14,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (15,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (16,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (17,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (18,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (19,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (20,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (21,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (22,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]), #companions
    (23,mtef_visitor_source,af_override_horse,0,1,[]), #guards
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse,0,1,[]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source,af_override_horse,0,1,[]),
    (33,mtef_visitor_source,af_override_horse,0,1,[]),
    (34,mtef_visitor_source,af_override_horse,0,1,[]),
    (35,mtef_visitor_source,af_override_horse,0,1,[]),
    (36,mtef_visitor_source,af_override_horse,0,1,[]),
    (37,mtef_visitor_source,af_override_horse,0,1,[]),
    (38,mtef_visitor_source,af_override_horse,0,1,[]),
    (39,mtef_visitor_source,af_override_horse,0,1,[]), #guards
    (40,mtef_visitor_source,af_override_everything,0,1,[]), #prisoners
    (41,mtef_visitor_source,af_override_everything,0,1,[]),
    (42,mtef_visitor_source,af_override_everything,0,1,[]),
    (43,mtef_visitor_source,af_override_everything,0,1,[]),
    (44,mtef_visitor_source,af_override_everything,0,1,[]),
    (45,mtef_visitor_source,af_override_everything,0,1,[]),
    (46,mtef_visitor_source,af_override_everything,0,1,[]),
    (47,mtef_visitor_source,af_override_everything,0,1,[]), #prisoners
    (48,mtef_visitor_source,af_override_everything,0,1,[]), #punish
    (49,mtef_visitor_source,af_override_everything,0,1,[]), #punish
  ], p_wetter + storms + global_common_triggers + vc_water +
  [
    spawn_alexandria_lighthouse,

    can_spawn_commoners,
    improved_lightning,
    (ti_before_mission_start, 0, 0, [],[
      (call_script, "script_change_banners_and_chest"),
      (try_begin),
          (troop_slot_eq, "trp_global_variables", g_player_trench, 0),
          (call_script, "script_remove_camp_objects"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, [],[(finish_mission,0)]),

		(1,0,ti_once,[
			(try_for_agents,":agent"),
        (agent_is_active,":agent"),
        (agent_is_human, ":agent"),
        (agent_is_alive, ":agent"),
				(agent_get_entry_no, ":entry_no", ":agent"),
				#(assign, reg4, ":entry_no"),
				#(display_message,"@DEBUG entry {reg4}"),
				(try_begin),
					(eq,":entry_no",1),
					#(agent_set_slot, ":agent", slot_agent_camp_lover, 1),
					(try_begin),
						(agent_has_item_equipped,":agent","itm_lute"),
						(agent_set_stand_animation, ":agent", "anim_lute_sitting"),
						(agent_set_animation, ":agent", "anim_lute_sitting"),
						(agent_play_sound,":agent","snd_dedal_tavern_lute"),
					(else_try),
						(agent_has_item_equipped,":agent","itm_lyre"),
						(agent_set_stand_animation, ":agent", "anim_lyre_sitting"),
						(agent_set_animation, ":agent", "anim_lyre_sitting"),
            (agent_play_sound,":agent","snd_dedal_tavern_lyre"),
					(else_try),
						(agent_set_stand_animation, ":agent", "anim_sitting_low"),
						(agent_set_animation, ":agent", "anim_sitting_low"),
					(try_end),

					(store_random_in_range,":r",0,300),
					(agent_set_animation_progress,":agent",":r"),

				(else_try),
					(is_between, ":entry_no", 23, 33),
					(agent_set_stand_animation, ":agent", "anim_stand_townguard"),
					(agent_set_animation, ":agent", "anim_stand_townguard"),
					(store_random_in_range,":r",0,100),
					(agent_set_animation_progress,":agent",":r"),
				#(else_try),
					#(is_between, ":entry_no", 40, 48),
					#(agent_set_slot, ":agent", slot_agent_camp_prisoner, 1),
				(try_end),
			(try_end),
		],[]),

    (ti_inventory_key_pressed, 0, 0,[
      (set_trigger_result, 1),
    ],[]),

    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent_no"),
      #(store_trigger_param_2, ":killer_agent_no"),
      (store_trigger_param_3, ":is_wounded"),

      (try_begin),
        (ge, ":dead_agent_no", 0),
        (neg|agent_is_ally, ":dead_agent_no"),
        (agent_is_human, ":dead_agent_no"),
        (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),

        (agent_get_entry_no, ":entry_no", ":dead_agent_no"),

        (try_begin),
            (eq, ":is_wounded", 1),
            (try_begin),
                (neg|is_between, ":entry_no", 40, 48),
                (party_wound_members, "p_main_party", ":dead_agent_troop_id", 1),
            (try_end),
        (else_try),
          (try_begin),
              (neg|is_between, ":entry_no", 40, 48),
              (set_trigger_result, 2),
              (party_wound_members, "p_main_party", ":dead_agent_troop_id", 1),
          (else_try),
              (party_remove_prisoners, "p_main_party", ":dead_agent_troop_id", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),
]),

("ambush_riversw",mtf_battle_mode,-1,"Forest",[
    (0,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]), #player go
    (1,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]), #player back
    (2,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,20,[]),
    (3,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,20,[]),
    (4,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,20,[]),
    (5,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (6,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (7,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (11,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (12,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (13,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (14,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (15,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (16,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (17,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (18,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (19,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (20,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (21,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (22,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (23,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (24,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (25,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (26,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (27,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (28,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (29,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (30,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (31,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
	  wounds_vc,
      (ti_before_mission_start, 0, 0, [],
        [
          (assign,"$g_battle_result",0),
          (team_set_relation, 0, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
          (team_set_relation,1,2,0),
          (team_set_relation,0,1,-1),
      ]),


      (0, 0, ti_once,
        [
          (assign, "$attacker_team", 0),
          (assign, "$defender_team_2", 2),
          ],[]
      ),

      (3, 0, ti_once,
        [
          (set_show_messages, 0),
          (team_give_order, "$attacker_team", grc_everyone, mordr_follow),
          (team_give_order, "$defender_team_2", grc_infantry, mordr_stand_closer),
          (team_give_order, "$defender_team_2", grc_archers, mordr_stand_closer),
          (team_give_order, "$defender_team_2", grc_cavalry, mordr_stand_closer),
          (set_show_messages, 1),
          ],[]
      ),

      (0.1, 0, ti_once, [
          (store_skill_level,":player_sneaking_skill","skl_athletics","trp_player"),

          (try_begin),
            (eq,":player_sneaking_skill",10),
            (assign,":sneak_distance",5400),
          (else_try),
            (eq,":player_sneaking_skill",9),
            (assign,":sneak_distance",5600),
          (else_try),
            (eq,":player_sneaking_skill",8),
            (assign,":sneak_distance",5800),
          (else_try),
            (eq,":player_sneaking_skill",7),
            (assign,":sneak_distance",6000),
          (else_try),
            (eq,":player_sneaking_skill",6),
            (assign,":sneak_distance",6200),
          (else_try),
            (eq,":player_sneaking_skill",5),
            (assign,":sneak_distance",6400),
          (else_try),
            (eq,":player_sneaking_skill",4),
            (assign,":sneak_distance",6600),
          (else_try),
            (eq,":player_sneaking_skill",3),
            (assign,":sneak_distance",6800),
          (else_try),
            (eq,":player_sneaking_skill",2),
            (assign,":sneak_distance",7000),
          (else_try),
            (eq,":player_sneaking_skill",1),
            (assign,":sneak_distance",7400),
          (else_try),
            (assign,":sneak_distance",8000),
          (try_end),
          (get_player_agent_no,":player_agent"),
          (agent_get_position,pos1,":player_agent"),
          (assign,":continue",0),
          (try_for_agents, ":cur_agent"),
            (agent_get_team, ":team", ":cur_agent"),
            (eq, ":team", 2),
            (agent_get_position,pos2,":cur_agent"),
            (get_distance_between_positions,":distance",pos1,pos2),
            (lt,":distance",":sneak_distance"),
            (agent_set_team, ":cur_agent", 1),
            (agent_ai_set_aggressiveness, ":cur_agent", 9),
            (assign,":continue",1),
          (try_end),
          (eq,":continue",1),
        ],
        [
          (set_party_battle_mode),
      ]),

      (1, 4, ti_once,
        [
          (this_or_next|main_hero_fallen),
          (all_enemies_defeated, 5),
        ],
        [
          (try_begin),
            (main_hero_fallen),
          #  (assign, "$g_campaign_death", 1),
            (jump_to_menu, "mnu_captivity_wilderness_taken_prisoner"),
          (else_try),
            ##         (set_mission_result,1),
            ##         (assign, "$g_battle_result", 1),
            (jump_to_menu, "mnu_emboscada_player"),
          (try_end),
          (finish_mission,0),
      ]),

      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)],[]),
      (ti_tab_pressed, 0, 0, [(set_trigger_result,1)],[]),


      (0, 0, ti_once, [],
        [
          (call_script, "script_music_set_situation_with_culture", 0),
      ]),

      (0, 0, ti_once, [
          (tutorial_message_set_size, 15, 15),
          (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
          (tutorial_message_set_center_justify, 0),
          (assign, "$cam_time", 0), #for cam times
          ],[]),

      (0,0,ti_once,[ (store_mission_timer_a, ":cur_time"),
          (ge, ":cur_time", 4),
        ],
        [
          (tutorial_message_set_background, 1),
          (tutorial_message, "@Your mission is to ambush the enemy when they come for water supplies. " +
          "If you feel lost at some point, press the K key to remember these goals."),
          (set_fixed_point_multiplier, 100),
          (assign, "$cam_time", 1),
          (entry_point_get_position, pos7, 31),
          (call_script, "script_save_cam_first_person_mode"),
          (mission_cam_set_mode, 1, 0, 0),
          (set_camera_in_first_person, 0),
          (mission_cam_animate_to_position, pos7, 2500, 0),
      ]),

      (0,0,0,[ (key_clicked, key_k),],[
        (tutorial_message_set_background, 1),
        (tutorial_message, "@Your mission is to ambush the enemy when they come for water supplies. " +
        "If you feel lost at some point, press the K key to remember these goals."),

        (assign, "$cam_time", 1),
        (entry_point_get_position, pos7, 31),
        (call_script, "script_save_cam_first_person_mode"),
        (mission_cam_set_mode, 1, 0, 0),
        (set_camera_in_first_person, 0),
        (mission_cam_animate_to_position, pos7, 2500, 0),
      ]),

      (0,10,0,[(eq, "$cam_time", 1),],[
        (tutorial_message, -1),
        (tutorial_message_set_background, 0),
        (call_script, "script_return_to_cam_first_person_mode_1_sec"),
        (assign, "$cam_time", 0),
      ]),

    ] + theoris_decapitation + jacobhinds_morale_triggers + morale_triggers +ai_horn
  ),

("center_plunder", mtf_battle_mode,-1,
    "plundering a settlement",
    [(1,mtef_team_0, 0,aif_start_alarmed,10,[]),
      (30,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (31,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (32,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (33,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (34,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (35,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (36,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (37,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (38,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (39,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (40,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      # (30,mtef_visitor_source|mtef_team_1,af_override_horse, 0, 12,[]),
      # (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),
      # (1,mtef_team_0, 0,aif_start_alarmed,12,[]),
    ], p_wetter + global_common_triggers +
    [
      cannot_spawn_commoners,
    improved_lightning,
    #  cannot_spawn_commoners,
      common_inventory_not_available,
      common_battle_init_banner,
      (0, 0, ti_once, [],		# Let it burn
        [

          (set_fixed_point_multiplier, 100),
          (try_begin),
            (eq, "$loot_option", 2),	# only fire for loot option 2
            (assign, reg1, "psys_village_fire_big"),
          (else_try),
            (assign, reg1, 0),
          (try_end),
          (assign, reg2, "psys_war_smoke_tall"),
          (assign, reg3, 0),
          (assign, ":counter", 0),
          (try_for_prop_instances, ":curr_instance", -1, somt_object),
             (lt, ":counter", 15),	#not more than 60 part sys, now 25 since people get performance issues
             (prop_instance_get_scene_prop_kind, ":scene_prop_kind", ":curr_instance"),
             (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_a"),
             (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_b"),
             (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_c"),
             (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_e"),
             (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_f"),
             (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_g"),
             (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_h"),
             (this_or_next|eq, ":scene_prop_kind", "spr_roman_villa_new_a"),
             (this_or_next|eq, ":scene_prop_kind", "spr_village_stable_a"),
             (this_or_next|eq, ":scene_prop_kind", "spr_full_stable_a"),
             (this_or_next|eq, ":scene_prop_kind", "spr_roman_market_new"),
             (this_or_next|eq, ":scene_prop_kind", "spr_house_bebanburh"),
             (this_or_next|is_between, ":scene_prop_kind", "spr_b_bathsevulus1_t3", "spr_b_romanwalls_t1"),
             (this_or_next|is_between, ":scene_prop_kind", "spr_b_roof0_t1", "spr_b_wall0_t1"),
             (this_or_next|is_between, ":scene_prop_kind", "spr_b_villasevulus0_t1", "spr_b_wall0_t1"),
             (this_or_next|is_between, ":scene_prop_kind", "spr_Kolba_a", "spr_wall_a"),
             (this_or_next|is_between, ":scene_prop_kind", "spr_long_house", "spr_arena_2"),
             (this_or_next|is_between, ":scene_prop_kind", "spr_viking_house_a", "spr_harbour_a"),
             (this_or_next|is_between, ":scene_prop_kind", "spr_fake_houses_steppe_a", "spr_destroy_heap"),
             (this_or_next|is_between, ":scene_prop_kind", "spr_village_house_e", "spr_village_wall_a"),
             (this_or_next|is_between, ":scene_prop_kind", "spr_town_house_steppe_a", "spr_carpet_a"),
             (this_or_next|is_between, ":scene_prop_kind", "spr_earth_house_a", "spr_town_house_aa"),
             (this_or_next|is_between, ":scene_prop_kind", "spr_village_house_a", "spr_crude_fence"),
             (this_or_next|is_between, ":scene_prop_kind", "spr_full_stable_a", "spr_arabian_house_i"),
             (this_or_next|is_between, ":scene_prop_kind", "spr_arabian_house_a2", "spr_arabian_village_stairs"),
             (is_between, ":scene_prop_kind", "spr_house_saxon", "spr_tree_log_half"),
             (shuffle_range, 1, 4),
              (neq, reg1, 0),
              (val_add, ":counter", 1),
              (try_for_range, ":unused", 0, 4),
                (store_random_in_range, ":rand23", -150, 150),
                (position_set_x, pos1, ":rand23"),
                (store_random_in_range, ":rand23", -150, 150),
                (position_set_y, pos1, ":rand23"),
                (store_random_in_range, ":rand23", 50, 150),
                (position_set_z, pos1, ":rand23"),
                (prop_instance_add_particle_system, ":curr_instance", reg1, pos1),
                (eq, reg1, "psys_village_fire_big"),
                (position_move_z, pos1, 100),
                (prop_instance_add_particle_system, ":curr_instance", "psys_village_fire_smoke_big", pos1),
                #(prop_instance_play_sound, ":curr_instance", "snd_fire", sf_looping),
              (try_end),
          (try_end),
      ]),

      (ti_on_agent_spawn, 0.5, 0, [],
        [
          (store_trigger_param_1, ":agent_no"),
          (agent_is_human, ":agent_no"),
          (agent_is_ally, ":agent_no"),
          (agent_get_wielded_item, ":old_item" , ":agent_no", 1),
          (try_begin),
            (gt, ":old_item" , 0),
            (agent_unequip_item, ":agent_no", ":old_item"),
          (try_end),
          (agent_equip_item, ":agent_no", "itm_torch"),
          (agent_set_wielded_item, ":agent_no", "itm_torch"),
      ]),

      (ti_before_mission_start, 0, 0, [],
        [
          (assign, "$tutorial_state", 0),	#reusing other variable...
          (assign,"$g_battle_result",0),
          (call_script, "script_change_banners_and_chest")
        ]),

      (0, 0, ti_once, [],	# make part of them run around/flee
        [
          (try_for_agents, ":agent_no"),
            # (agent_get_troop_id, ":troop_no", ":agent_no"),
            # (eq, ":troop_no", "trp_townsman"),
            (neg|agent_is_ally, ":agent_no"),
            (agent_set_slot, ":agent_no",  slot_agent_is_running_away, 1),
            (store_random_in_range, ":chance", 1, 101),
            (le, ":chance", 40),	# 40% want to fight at beginning
            (agent_set_slot, ":agent_no",  slot_agent_is_running_away, 0),
            (assign, reg1, "itm_quarter_staff"),
            (assign, reg2, "itm_knife"),
            (assign, reg3, "itm_butchering_knife"),
            (assign, reg4, "itm_dagger"),
            (assign, reg5, "itm_shortened_spear"),
            (assign, reg6, "itm_spear"),
            (assign, reg7, "itm_stones"),
            (assign, reg8, "itm_staff"),
            (assign, reg9, "itm_wooden_stick"),
            (shuffle_range, 1, 10),
            (agent_equip_item, ":agent_no", reg1, 1),
            (agent_set_wielded_item, ":agent_no", reg1),
          (try_end),

          #also make player knock down only
          (get_player_agent_no, ":player_agent"),
          (agent_set_no_death_knock_down_only, ":player_agent", 1),
      ]),

      (3, 0, 0, [],	# keep them fleeing
        [
          (assign, ":sound_played", 0),
          (try_for_agents, ":agent_no"),
            (agent_is_active, ":agent_no"),
            (agent_is_alive, ":agent_no"),
            (agent_is_human, ":agent_no"),
            (agent_slot_ge, ":agent_no",  slot_agent_is_running_away, 1),
            (neg|agent_is_ally, ":agent_no"),
            (store_random_in_range, ":rand", 32, 40),
            (entry_point_get_position, pos2, ":rand"),
            (agent_start_running_away, ":agent_no", pos2),
            (call_script, "script_advanced_agent_set_speed_modifier", ":agent_no", 85),	#make it less harder to catch them
            #sound:
            (eq, ":sound_played", 0),
            (assign, ":sound_played", 1),
            (store_random_in_range, ":rand", 1, 4),
            (eq, ":rand", 1),
            (agent_play_sound, ":agent_no", "snd_panic_cry"),
          (try_end),
      ]),
      # make damaged agents flee
      (ti_on_agent_hit, 0, 0, [],	[
          (store_trigger_param, ":inflicted_agent_id", 1),
          #(store_trigger_param, ":dealer_agent_id", 2),
          (store_trigger_param, ":inflicted_damage", 3),
          #(get_player_agent_no, ":player_agent"),
          #(eq, ":dealer_agent_id", ":player_agent"),
          (agent_is_active, ":inflicted_agent_id"),
          (agent_is_human, ":inflicted_agent_id"),
          (agent_is_alive, ":inflicted_agent_id"),
          (neg|agent_is_ally, ":inflicted_agent_id"),
          (store_agent_hit_points, ":hp", ":inflicted_agent_id"),
          (this_or_next|lt, ":hp", 75),
          (gt, ":inflicted_damage", 10),
          (store_random_in_range, ":rand", 10, 41),
          (entry_point_get_position, pos2, ":rand"),
          (agent_start_running_away, ":inflicted_agent_id", pos2),
          (agent_slot_eq, ":inflicted_agent_id",  slot_agent_is_running_away, 0),
          (agent_set_slot, ":inflicted_agent_id",  slot_agent_is_running_away, 1),
          #throw away weapon:
          (agent_get_wielded_item, ":weapon", ":inflicted_agent_id", 0),
          (ge, ":weapon", 1),
          (agent_unequip_item, ":inflicted_agent_id", ":weapon"),
          #sound:
          (store_random_in_range, ":rand", 1, 3),
          (eq, ":rand", 1),
          (agent_play_sound, ":inflicted_agent_id", "snd_panic_hit"),
      ]),

      (ti_on_agent_killed_or_wounded, 0, 0, [],
        [
          (store_trigger_param_1, ":dead_agent_no"),
          #(store_trigger_param_2, ":killer_agent_no"),
          (try_begin),
            (ge, ":dead_agent_no", 0),
            (neg|agent_is_ally, ":dead_agent_no"),
            (agent_is_human, ":dead_agent_no"),
            (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
            (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
           # (agent_slot_eq, ":dead_agent_no", slot_agent_vc_wounded, 1),	#new
           # (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
          (try_end),
          #(call_script, "script_apply_death_effect_on_courage_scores", ":dead_agent_no", ":killer_agent_no"),
      ]),

      (ti_tab_pressed, 0, 0, [],
        [
          (eq, "$tutorial_state", 0),
          (assign, "$tutorial_state", 1),
      ]),

      (1, 1, ti_once,
        [
          (this_or_next|main_hero_fallen),
          (num_active_teams_le,1)
        ],
        [
          (eq, "$tutorial_state", 0),
          (assign, "$tutorial_state", 1),
      ]),

      (1, 180, ti_once, [],	#end mission after 3 minutes
        [
          (eq, "$tutorial_state", 0),
          (assign, "$tutorial_state", 1),
      ]),

      (1, 2, ti_once,
        [
          (eq, "$tutorial_state", 1),
          (assign, "$tutorial_state", 2),
        ],
        [
          (set_fixed_point_multiplier, 100),
          # (entry_point_get_position, pos8, 0),
          # (entry_point_get_position, pos9, 1),
          # (entry_point_get_position, pos10, 2),
          # (get_distance_between_positions, ":distance", pos9, pos10),
          # (try_begin),
            # (gt, ":distance", 200),
            # (position_get_z, ":z", pos8),
            # (position_set_z, pos9, ":z"),
            # (get_distance_between_positions, "$cam_distance", pos8, pos9),
            # (val_mul, "$cam_distance", -1),
          # (else_try),
            # (assign, "$cam_distance", -5000),
          # (try_end),

          (try_begin),
            #(call_script, "script_save_cam_first_person_mode"),
            (mission_cam_set_mode, 1, 0, 0),
            (set_camera_in_first_person, 0),
            # #(position_move_x, pos8, 150),
            # (position_rotate_x, pos8, -8),
            # (position_move_y, pos8, "$cam_distance"),
            # (position_rotate_x, pos8, -10),
            # (position_get_distance_to_ground_level, ":distance", pos8),
            # (try_begin),
              # (lt, ":distance", 180),
              # (position_set_z_to_ground_level, pos8),
              # (position_move_z, pos8, 180),
            # (try_end),

            #get scene boundaries
            (init_position, pos11),
            (get_scene_boundaries, pos10, pos11),
            (position_get_x, ":scene_max_x", pos11),
            (position_get_y, ":scene_max_y", pos11),
            #get center of map
            (val_div, ":scene_max_x", 2),
            (val_div, ":scene_max_y", 2),
            (position_set_x, pos11, ":scene_max_x"),
            (position_set_y, pos11, ":scene_max_y"),
            (entry_point_get_position, pos10, 0),#that spawn is always there
            (call_script, "script_point_y_toward_position", pos10, pos11),
            #pos10 points now in direction of center
            (position_move_y, pos10, -7000),
            (position_move_z, pos10, 2200),
            (position_rotate_x, pos8, -35),

            (mission_cam_animate_to_position, pos10, 6000),
          (try_end),
      ]),

      (1, 10, ti_once,
        [
          (eq, "$tutorial_state", 2),
          (assign, "$tutorial_state", 3),
        ],
        [
          (stop_all_sounds, 1),
          (finish_mission,3),
      ]),
]),

("orgie",0,-1,
  "plundering a settlement",[
    (0,mtef_visitor_source,af_override_horse,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,0,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,af_override_horse,0,1,[]),
    (14,mtef_visitor_source,af_override_horse,0,1,[]),
    (15,mtef_visitor_source,af_override_horse,0,1,[]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),
    (17,mtef_visitor_source,af_override_horse,0,1,[]),
    (18,mtef_visitor_source,af_override_horse,0,1,[]),
    (19,mtef_visitor_source,af_override_horse,0,1,[]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_horse,0,1,[]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    can_spawn_commoners,
    (ti_before_mission_start, 0, 0, [ ],[
      (set_global_cloud_amount, 1),
      (set_rain, 2, 0),
      (set_rain, 1, 0),
      (set_rain, 0, 100),
    ]),
    common_inventory_not_available,
    (0,0,ti_once, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_tavern),
    ]),

    dedal_tavern_animations,

    (ti_on_agent_spawn,1,0,[
      (store_trigger_param_1,":agent"),
      (agent_get_troop_id,":troop",":agent"),
      (try_begin),
        (eq,":troop","trp_orgie_male1"),
        (try_begin),
          (agent_has_item_equipped,":agent","itm_dedal_kufel"),
          (agent_set_stand_animation, ":agent", "anim_sitting_drinking_low"),
          (agent_set_animation, ":agent", "anim_sitting_drinking_low"),
          (agent_ai_set_interact_with_player,":agent",0),
          (store_random_in_range,":r",0,300),
        (else_try),
          (agent_set_stand_animation, ":agent", "anim_sitting_low"),
          (agent_set_animation, ":agent", "anim_sitting_low"),
          (agent_ai_set_interact_with_player,":agent",0),
          (store_random_in_range,":r",0,300),
        (try_end),
        (agent_set_animation_progress,":agent",":r"),
      (try_end),
    ],[]),
    (ti_tab_pressed, 0, 0, [],[
      (try_begin),
        (eq, "$temp", 2),
        (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
        (finish_mission, 3),
        (jump_to_menu, "mnu_end_party"),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ]),
    (0, 0, 0,[(key_clicked, key_k),
      (tutorial_message, -1),
    ],[]),
	  (1,0,ti_once,[
      (eq,"$temp",1),
      (neg|conversation_screen_is_active),
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@ You can hardly move. Everything looks blurred. It seems you are in an advanced state of inebriation. ^^(press K to finish read)"),
		]),
]),
("cutscene_sacrifice",0,-1,
  "plundering a settlement",[
    (0,mtef_visitor_source,af_override_horse,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,af_override_horse,0,1,[]),
    (14,mtef_visitor_source,af_override_horse,0,1,[]),
    (15,mtef_visitor_source,af_override_horse,0,1,[]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),
    (17,mtef_visitor_source,af_override_horse,0,1,[]),
    (18,mtef_visitor_source,af_override_horse,0,1,[]),
    (19,mtef_visitor_source,af_override_horse,0,1,[]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_horse,0,1,[]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
    (23,mtef_visitor_source,af_override_horse,0,1,[]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse,0,1,[]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source,af_override_horse,0,1,[]),
    (33,mtef_visitor_source,af_override_horse,0,1,[]),
    (34,mtef_visitor_source,af_override_horse,0,1,[]),
    (35,mtef_visitor_source,af_override_horse,0,1,[]),
    (36,mtef_visitor_source,af_override_horse,0,1,[]),
    (37,mtef_visitor_source,af_override_horse,0,1,[]),
    (38,mtef_visitor_source,af_override_horse,0,1,[]),
    (39,mtef_visitor_source,af_override_horse,0,1,[]),
    (40,mtef_visitor_source,af_override_horse,0,1,[]),
    (41,mtef_visitor_source,af_override_horse,0,1,[]),
    (42,mtef_visitor_source,af_override_horse,0,1,[]),
    (43,mtef_visitor_source,af_override_horse,0,1,[]),
    (44,mtef_visitor_source,af_override_horse,0,1,[]),
    (45,mtef_visitor_source,af_override_horse,0,1,[]),
    (46,mtef_visitor_source,af_override_horse,0,1,[]),
    (47,mtef_visitor_source,af_override_horse,0,1,[]),
    (48,mtef_visitor_source,af_override_horse,0,1,[]),
    (49,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    (ti_after_mission_start, 0, ti_once, [],[
      (mission_cam_set_screen_color, 0xFF736252), #roughly the colour of the menu bg
      (mission_cam_animate_to_screen_color, 0x00736252, 1500),
      (show_object_details_overlay, 0),
    ]),

    deactivate_player_agent,
    dedal_tavern_animations,
    can_spawn_commoners,
    common_inventory_not_available,
    (ti_on_agent_spawn,1,0, [],[
      (try_for_agents, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_human, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (try_begin),
          (eq, ":troop", "trp_guest"),
          (agent_set_stand_animation, ":agent", "anim_wedding_guest"),
          (agent_set_animation, ":agent", "anim_wedding_guest"),
          (store_random_in_range,":r",0,100),
        (else_try),
          (eq, ":troop", "trp_guest_female"),
          (agent_set_stand_animation, ":agent", "anim_wedding_guest_woman"),
          (agent_set_animation, ":agent", "anim_wedding_guest_woman"),
          (store_random_in_range,":r",0,100),
        (else_try),
          (eq, ":troop", "trp_roman_priest_female"),
          (agent_set_stand_animation, ":agent", "anim_wedding_guest_woman"),
          (agent_set_animation, ":agent", "anim_wedding_guest_woman"),
          (store_random_in_range,":r",0,100),
        (else_try),
          (eq, ":troop", "trp_roman_priest"),
          (agent_set_stand_animation, ":agent", "anim_wedding_guest_notr"),
          (agent_set_animation, ":agent", "anim_wedding_guest_notr"),
          (store_random_in_range,":r",0,100),
        (try_end),
        (agent_set_animation_progress,":agent",":r"),
      (try_end),
    ]),
    (0,0,0,[],[
      (store_mission_timer_a, ":cur_time"),
      (set_fixed_point_multiplier, 100),
      (try_begin),
          (ge, ":cur_time", 31),
          (eq, "$tutorial_state", 3),
          (val_add, "$tutorial_state", 1),
          (show_object_details_overlay, 1),
          (stop_all_sounds, 1),
          (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
          (mission_disable_talk),
          (finish_mission, 4),
      (else_try),
          (ge, ":cur_time", 27),
          (eq, "$tutorial_state", 2),
          (val_add, "$tutorial_state", 1),
          (tutorial_message_set_size, 23, 23),
          (tutorial_message_set_position, 500, 650),
          (tutorial_message_set_center_justify, 0),
          (tutorial_message_set_background, 1),
          (tutorial_message, -1),
          (init_position, pos12),
          (entry_point_get_position, pos12, 45),
          (position_move_z, pos12, 500),
          (particle_system_burst, "psys_wedding_rose", pos12, 750),
      (else_try),
          (ge, ":cur_time", 4),
          (eq, "$tutorial_state", 1),
          (val_add, "$tutorial_state", 1),
          (tutorial_message_set_size, 19, 19),
          (tutorial_message_set_position, 500, 650),
          (tutorial_message_set_center_justify, 0),
          (tutorial_message_set_background, 1),
          (val_add, "$temp1", "str_priest_sacrifice_begin"),
          (str_store_string, s10, "$temp1"),
          (tutorial_message, "@{s10}"),
      (else_try),
          (eq, "$tutorial_state", 0),
          (call_script, "script_save_cam_first_person_mode"),
          (mission_cam_set_mode, 1, 0, 0),
          (set_camera_in_first_person, 0),
          (init_position, pos10),
          (entry_point_get_position, pos10, 45),
          (mission_cam_set_position, pos10),
          (val_add, "$tutorial_state", 1),
      (try_end),
    ]),
    (ti_before_mission_start, 0, 0,[],[
      (assign, "$tutorial_state", 0),
      (scene_set_day_time, 12),
      (set_global_cloud_amount, 10),
      (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
    ]),
    (2, 0, 0, [(call_script, "script_center_ambiance_sounds")],[]),
    (ti_tab_pressed, 0, 0, [],[
      (stop_all_sounds, 1),
      (show_object_details_overlay, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      (mission_disable_talk),
      (finish_mission, 4),
    ]),
]),
("visit_temple",0,-1,
  "plundering a settlement",[
    (0,mtef_visitor_source,af_override_horse,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,af_override_horse,0,1,[]),
    (14,mtef_visitor_source,af_override_horse,0,1,[]),
    (15,mtef_visitor_source,af_override_horse,0,1,[]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),
    (17,mtef_visitor_source,af_override_horse,0,1,[]),
    (18,mtef_visitor_source,af_override_horse,0,1,[]),
    (19,mtef_visitor_source,af_override_horse,0,1,[]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_horse,0,1,[]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
    (23,mtef_visitor_source,af_override_horse,0,1,[]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse,0,1,[]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
    (33,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
    (34,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
    (35,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
    (36,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
    (37,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
    (38,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #castle chief walkers
    (39,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #castle chief walkers
    (40,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #castle chief walkers
  ], p_wetter + global_common_triggers +
  [
    can_spawn_commoners,
    common_inventory_not_available,
    (ti_on_agent_spawn,1,0, [],[
      (try_for_agents, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_human, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (try_begin),
          (eq, ":troop", "trp_guest"),
          (agent_set_stand_animation, ":agent", "anim_wedding_guest"),
          (agent_set_animation, ":agent", "anim_wedding_guest"),
          (store_random_in_range,":r",0,100),
        (else_try),
          (eq, ":troop", "trp_guest_female"),
          (agent_set_stand_animation, ":agent", "anim_wedding_guest_woman"),
          (agent_set_animation, ":agent", "anim_wedding_guest_woman"),
          (store_random_in_range,":r",0,100),
        (else_try),
          (eq, ":troop", "trp_roman_priest_female"),
          (agent_set_stand_animation, ":agent", "anim_wedding_guest_woman"),
          (agent_set_animation, ":agent", "anim_wedding_guest_woman"),
          (store_random_in_range,":r",0,100),
        (else_try),
          (eq, ":troop", "trp_roman_priest"),
          (agent_set_stand_animation, ":agent", "anim_wedding_guest_notr"),
          (agent_set_animation, ":agent", "anim_wedding_guest_notr"),
          (store_random_in_range,":r",0,100),
        (try_end),
        (agent_set_animation_progress,":agent",":r"),
      (try_end),
    ]),
	  (0,0,1,[],[
      (store_mission_timer_a, ":timer2"),
      (try_begin),
        (eq, ":timer2", 1),
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ People perform various rituals to honor the gods."),
      (else_try),
        (gt, ":timer2", 6),
        (tutorial_message_set_size, 23, 23),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, -1),
      (try_end),
		]),
    (1, 0, ti_once,[],[
      (try_begin),
        (eq, "$g_mt_mode", tcm_default),
        (store_current_scene, ":cur_scene"),
        (scene_set_slot, ":cur_scene", slot_scene_visited, 1),
      (try_end),
      (call_script, "script_init_town_walker_agents"),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", mtf_sit_town_infiltrate),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
      (try_end),
    ]),
    (3, 0, 0, [(call_script, "script_tick_town_walkers")],[]),
    (2, 0, 0, [(call_script, "script_center_ambiance_sounds")],[]),

    (ti_tab_pressed, 0, 0, [],[
      (stop_all_sounds, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
      (mission_disable_talk),
      (finish_mission, 3),
    ]),
]),

("visit_sartemis",0,-1,"plundering a settlement",[
    (0,mtef_visitor_source,af_override_horse,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[itm_dedal_kufel]),
    (14,mtef_visitor_source,af_override_horse,0,1,[]),
    (15,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[itm_dedal_kufel]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),
    (17,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[itm_dedal_kufel]),
    (18,mtef_visitor_source,af_override_horse,0,1,[]),
    (19,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[itm_dedal_kufel]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[itm_dedal_kufel]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
    (23,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[itm_dedal_kufel]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse|af_override_gloves,0,1,[itm_dedal_kufel]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source,af_override_horse,0,1,[]),
    (33,mtef_visitor_source,af_override_horse,0,1,[]),
    (34,mtef_visitor_source,af_override_horse,0,1,[]),
    (35,mtef_visitor_source,af_override_horse,0,1,[]),
    (36,mtef_visitor_source,af_override_horse,0,1,[]),
    (37,mtef_visitor_source,af_override_horse,0,1,[]),
    (38,mtef_visitor_source,af_override_horse,0,1,[]),
    (39,mtef_visitor_source,af_override_horse,0,1,[]),
    (40,mtef_visitor_source,af_override_horse,0,1,[]),
    (41,mtef_visitor_source,af_override_horse,0,1,[]),
    (42,mtef_visitor_source,af_override_horse,0,1,[]),
    (43,mtef_visitor_source,af_override_horse,0,1,[]),
    (44,mtef_visitor_source,af_override_horse,0,1,[]),
    (45,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    improved_lightning,
    (ti_before_mission_start, 0, 0, [
      (is_currently_night),
      (quest_slot_eq, "qst_gardens_of_pleasure", slot_quest_current_state, 0),
      (quest_set_slot, "qst_gardens_of_pleasure", slot_quest_current_state, 1),
    ],[]),

    can_spawn_commoners,
    dedal_tavern_animations,
    (0.5,0.5,ti_once,[
      (quest_slot_ge, "qst_gardens_of_pleasure", slot_quest_current_state, 7)
    ],[
      (try_for_agents, ":agent"),
        (agent_is_active, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_human, ":agent"),
        (agent_get_entry_no, ":entry", ":agent"),
        (is_between, ":entry", 13,27),
        (try_begin),
          (agent_has_item_equipped,":agent","itm_dedal_kufel"),
          (agent_set_stand_animation, ":agent", "anim_sitting_drinking_low"),
          (agent_set_animation, ":agent", "anim_sitting_drinking_low"),
          (agent_ai_set_interact_with_player,":agent",0),
          (store_random_in_range,":r",0,300),
        (else_try),
          (agent_set_stand_animation, ":agent", "anim_sitting_low"),
          (agent_set_animation, ":agent", "anim_sitting_low"),
          (agent_ai_set_interact_with_player,":agent",0),
          (store_random_in_range,":r",0,300),
        (try_end),
        (agent_set_animation_progress,":agent",":r"),
      (try_end),
    ]),

    (0, 0, ti_once, [
      (is_currently_night),
      (quest_slot_eq, "qst_gardens_of_pleasure", slot_quest_current_state, 1),
    ],[(play_track, "track_final_glory", 1),]),

	  (0,0,0,[
      (quest_slot_eq, "qst_gardens_of_pleasure", slot_quest_current_state, 1),
      (is_currently_night),
    ],[
      (set_fixed_point_multiplier, 1),
      (store_mission_timer_a, ":timer1"),
      (try_begin),
        (eq, ":timer1", 7),
        (tutorial_message_set_size, 22, 22),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@A sweet voice sings: 'In those days! In those distant days! In those nights! In those ancient nights! In those years! In those distant years!'"),
      (else_try),
        (eq, ":timer1", 22),
        (tutorial_message_set_size, 23, 23),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@'In those ancient days, when all things had been created. In ancient time, when all things were given their place; when bread was first tasted in the sacred shrines of the land.'"),
      (else_try),
        (eq, ":timer1", 36),
        (tutorial_message_set_size, 23, 23),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@'When the ovens had been lighted; when the heavens had been separated from the earth; when the earth had been separated from the heavens; when mankind had been established,'"),
      (else_try),
        (eq, ":timer1", 50),
        (tutorial_message_set_size, 23, 23),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@-- The voice stops singing. She seems to have noticed you. -- ^^'Who are you? Why are you visiting my garden?'"),
        (add_visitors_to_current_scene, 6, "trp_fortuna", 1, 0),
        (quest_set_slot, "qst_gardens_of_pleasure", slot_quest_current_state, 2),
      (else_try),
        (eq, ":timer1", 55),
        (tutorial_message_set_size, 23, 23),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, -1),
      (try_end),
    ]),
    (0, 0, 0,[
      (conversation_screen_is_active),
      (tutorial_message, -1),
    ],[]),
	  (0, 0, 0,[
	    (quest_slot_eq, "qst_gardens_of_pleasure", slot_quest_current_state, 2),
	  ],[
      (get_player_agent_no, ":player_agent"),
      (agent_get_position, pos0, ":player_agent"),
      (try_for_agents, ":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (eq, ":troop_no", "trp_fortuna"),
        (agent_set_scripted_destination, ":agent_no", pos0),
        (agent_get_position, pos1, ":agent_no"),
        (get_distance_between_positions, ":dist", pos0, pos1),
        (le, ":dist", 200),
        (assign, "$talk_context", tc_back_alley),
        (start_mission_conversation, ":troop_no"),
      (try_end),
    ]),
    (1, 0, 0,[
      (gt, "$g_belligerent_drunk_leaving", 0),
      (agent_is_active, "$g_belligerent_drunk_leaving"),
      (agent_is_alive, "$g_belligerent_drunk_leaving"),
      (entry_point_get_position, pos0, 40),
      (agent_get_position, pos1, "$g_belligerent_drunk_leaving"),
      (get_distance_between_positions, ":dist", pos0, pos1),
      (le, ":dist", 350),
    ],[
      (agent_fade_out, "$g_belligerent_drunk_leaving"),
      (assign, "$g_belligerent_drunk_leaving", 0),
    ]),

    common_inventory_not_available,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
		wounds_vc,
    (1, 0, ti_once,[],[
      (try_begin),
        (eq, "$g_mt_mode", tcm_default),
        (store_current_scene, ":cur_scene"),
        (scene_set_slot, ":cur_scene", slot_scene_visited, 1),
      (try_end),
      (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
    ]),

    (2, 0, 0, [(call_script, "script_center_ambiance_sounds")],[]),

    (ti_tab_pressed, 0, 0, [],[
      (try_begin),
        (quest_slot_eq, "qst_gardens_of_pleasure", slot_quest_current_state, 2),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (stop_all_sounds, 1),
        (finish_mission,0),
      (try_end),
    ]),
]),

("slave_hideout", mtf_battle_mode, 0,
  "You visit the slave hideout.",[
    (0,mtef_leader_only, 0, 0, 1,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    improved_lightning,
    cannot_spawn_commoners,
    common_inventory_not_available,

    #1. Spawn the slave
    (0, 0, ti_once,[
      (get_player_agent_no, ":player_agent"),
      (agent_is_active, ":player_agent"),
    ],[
      (mission_enable_talk),

      (get_player_agent_no, ":agent_no"),
      (set_fixed_point_multiplier, 100),
      (agent_get_position, pos1, ":agent_no"),
      (store_random_in_range, ":rand", 6000, 9000),
      (position_move_y, pos1, ":rand"),
      (store_random_in_range, ":rand", -3000, 3000),
      (position_move_x, pos1, ":rand"),
      (store_random_in_range, ":rand", 0, 360),
      (position_rotate_z, pos1, ":rand"),

      (set_spawn_position, pos1),
      (spawn_agent, "trp_slave"),
      (assign, "$alpha_animal", reg0),
      (agent_get_position, pos1, "$alpha_animal"),

      (try_begin),
        (position_get_z, ":z", pos1),#VC-3485
        (lt, ":z", 0),
        (agent_get_position, pos2, ":agent_no"),
        (agent_set_scripted_destination, "$alpha_animal", pos2),
      (else_try),
        (set_spawn_position, pos1),
        (spawn_scene_prop, "spr_cooking_fire"),
        (position_move_y, pos1, -100),
        (agent_set_position, "$alpha_animal", pos1),
      (try_end),
      (agent_add_relation_with_agent, ":agent_no", "$alpha_animal", 0),
    ]),

    # End
    (3, 0, ti_once,[
      (this_or_next|main_hero_fallen),
      (neg|agent_is_alive, "$alpha_animal"),
    ],[
      (finish_mission, 10),
      (quest_get_slot, ":village", "qst_blank_quest_7", slot_quest_target_center),

      (try_begin),
        (main_hero_fallen),
        (quest_set_slot, "qst_blank_quest_7", slot_quest_current_state, 3),
        (call_script, "script_fail_quest", "qst_blank_quest_7"),
      (else_try),
        (quest_set_slot, "qst_blank_quest_7", slot_quest_current_state, 3),
        (call_script, "script_succeed_quest", "qst_blank_quest_7"),
        (call_script, "script_end_quest", "qst_blank_quest_7"),
        (call_script, "script_change_player_relation_with_center", ":village", 1),
        (add_xp_as_reward, 100),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, [],[
      (set_trigger_result, 0),
    ]),

    (0, 0, ti_once, [],[
      (play_sound,"snd_ambient_day_forest_loop"),
      (assign,"$g_battle_won",0),
      (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
      # (music_set_situation, 0),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),

      (party_clear, "p_routed_enemies"),

      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),
    ]),
]),

("visit_temple_jerusalem",0,-1,"plundering a settlement",[
    (0,mtef_visitor_source,af_override_horse,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,af_override_horse,0,1,[]),
    (14,mtef_visitor_source,af_override_horse,0,1,[]),
    (15,mtef_visitor_source,af_override_horse,0,1,[]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),
    (17,mtef_visitor_source,af_override_horse,0,1,[]),
    (18,mtef_visitor_source,af_override_horse,0,1,[]),
    (19,mtef_visitor_source,af_override_horse,0,1,[]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_horse,0,1,[]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
    (23,mtef_visitor_source,af_override_horse,0,1,[]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse,0,1,[]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
    (33,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
    (34,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
    (35,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
    (36,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
    (37,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
    (38,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #castle chief walkers
    (39,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #castle chief walkers
    (40,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #castle chief walkers
  ], p_wetter + storms + global_common_triggers +
  [
    can_spawn_commoners,
    improved_lightning,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    ambient_scene_play_loop,
    ambient_scene_play_random_sound,
    common_inventory_not_available,

    (0, 0, 0, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
      (mission_enable_talk),
    ]),
    (0, 0, 0,[
      (key_clicked, key_k),
      (tutorial_message, -1),
    ],[]),
	  (10,0,ti_once,[],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@ It is not allowed to enter the inner courtyard.^^(press K to finish read)"),
		]),
    ###chief walkers
    (1, 0, ti_once,[],[
      (try_begin),
        (eq, "$g_mt_mode", tcm_default),
        (store_current_scene, ":cur_scene"),
        (scene_set_slot, ":cur_scene", slot_scene_visited, 1),
      (try_end),
      (call_script, "script_init_town_walker_agents"),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", mtf_sit_town_infiltrate),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
      (try_end),
    ]),
    #chief walkers acaba

    #chief walkers en castillos
    (3, 0, 0, [(call_script, "script_tick_town_walkers")],[]),
    (2, 0, 0, [(call_script, "script_center_ambiance_sounds")],[]),
    #chief walkers en castillo acaba

    (ti_tab_pressed, 0, 0, [],[
      (stop_all_sounds, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      (mission_disable_talk),
      (finish_mission, 4),
    ]),
]),

("palace", mtf_battle_mode, -1,"You visit the imperial palace.",[
	  (0,mtef_visitor_source,af_override_horse,0,1,[]),
	  (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,af_override_horse,0,1,[]),
    (14,mtef_visitor_source,af_override_horse,0,1,[]),
    (15,mtef_visitor_source,af_override_horse,0,1,[]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),
    (17,mtef_visitor_source,af_override_horse,0,1,[]),
    (18,mtef_visitor_source,af_override_horse,0,1,[]),
    (19,mtef_visitor_source,af_override_horse,0,1,[]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_horse,0,1,[]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
    (23,mtef_visitor_source,af_override_horse,0,1,[]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse,0,1,[]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source,af_override_horse,0,1,[]),
    (33,mtef_visitor_source,af_override_horse,0,1,[]),
    (34,mtef_visitor_source,af_override_horse,0,1,[]),
    (35,mtef_visitor_source,af_override_horse,0,1,[]),
    (36,mtef_visitor_source,af_override_all,0,1,[itm_nothing_legs,itm_seiden_dress]),
    (37,mtef_visitor_source,af_override_horse,0,1,[]),
    (38,mtef_visitor_source,af_override_horse,0,1,[]),
    (39,mtef_visitor_source,af_override_horse,0,1,[]),
    (40,mtef_visitor_source,af_override_horse,0,1,[]),
    (41,mtef_visitor_source,af_castle_lord,0,1,[]),
    (42,mtef_visitor_source,af_override_horse,0,1,[]),
    (43,mtef_visitor_source,af_override_horse,0,1,[]),
    (44,mtef_visitor_source,af_override_horse,0,1,[]),
    (45,mtef_visitor_source,af_override_horse,0,1,[]),
    (46,mtef_visitor_source,af_override_horse,0,1,[]),
    (47,mtef_visitor_source,af_override_horse,0,1,[]),
    (48,mtef_visitor_source,af_override_horse,0,1,[]),
    (49,mtef_visitor_source,af_override_horse,0,1,[]),
    (50,mtef_visitor_source,af_override_horse,0,1,[]),
    (51,mtef_visitor_source,af_override_horse,0,1,[]),
    (52,mtef_visitor_source,af_override_horse,0,1,[]),
    (53,mtef_visitor_source,af_override_horse,0,1,[]),
    (54,mtef_visitor_source,af_override_horse,0,1,[]),
    (55,mtef_visitor_source,af_override_horse,0,1,[]),
    (56,mtef_visitor_source,af_override_horse,0,1,[]),
    (57,mtef_visitor_source,af_override_horse,0,1,[]),
    (58,mtef_visitor_source,af_override_horse,0,1,[]),
    (59,mtef_visitor_source,af_override_horse,0,1,[]),
    (60,mtef_visitor_source,af_override_horse,0,1,[]),
    (61,mtef_visitor_source,af_override_horse,0,1,[]),
    (62,mtef_visitor_source,af_override_horse,0,1,[]),
    (63,mtef_visitor_source,af_override_horse,0,1,[]),
    (64,mtef_visitor_source,af_override_horse,0,1,[]),
    (65,mtef_visitor_source,af_override_horse,0,1,[]),
    (66,mtef_visitor_source,af_override_horse,0,1,[]),
    (67,mtef_visitor_source,af_override_horse,0,1,[]),
    (68,mtef_visitor_source,af_override_horse,0,1,[]),
    (69,mtef_visitor_source,af_override_horse,0,1,[]),
    (70,mtef_visitor_source,af_override_horse,0,1,[]),
  ],
    p_wetter + global_common_triggers +
  [
    (ti_before_mission_start, 0, 0, [],[
      (call_script, "script_change_banners_and_chest"),
    ]),
    can_spawn_commoners,
    improved_lightning,
    (0, 0, 0,[
      (key_clicked, key_k),
      (tutorial_message, -1),
    ],[]),

    (1,0,ti_once,[
      (eq, "$talk_context", tc_pret_event_14),
      (this_or_next|eq, "$temp4", 2),
      (this_or_next|eq, "$temp4", 5),
      (eq, "$temp4", 3),
      (neg|conversation_screen_is_active),
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (try_begin),
          (eq, "$temp4", 5),
          (tutorial_message, "@ Find and talk with Poppaea Sabina.^^(press K to finish read)"),
      (else_try),
          (tutorial_message, "@ You returned to the party. Now talk with Poppaea Sabina to explain the situation.^^(press K to finish read)"),
      (try_end),
    ]),

    (4,0,ti_once,[
      (eq, "$talk_context", tc_pret_event_14),
      (eq, "$temp4", 8),
    ],
    [
      (stop_all_sounds),
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      (finish_mission,4),

      (assign, "$temp4", 9),
      (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
      (assign, "$auto_menu", "mnu_freelancer_event_pret_15_2"),
      (jump_to_menu, "mnu_auto_return_map"),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (set_rain, 1,0),
      (set_rain, 2,0),
    ]),

    (0, 0, ti_once, [],[
      (mission_enable_talk),
    ]),

    (0, 0, 3,[
      (key_clicked, key_t),
    ],[
      (get_player_agent_no, ":agent_no"),
      (agent_set_animation, ":agent_no", "anim_blow_kiss", 1),
    ]),

    (0, 0, ti_once, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
      (try_for_agents, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_is_human, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (eq, ":troop", "$g_heir_of_rome"),
          (neq, "$g_heir_of_rome", "trp_player"),
          (agent_set_stand_animation, ":agent", "anim_vyrn_sleeping_on_tree"),
          (agent_set_animation, ":agent", "anim_vyrn_sleeping_on_tree"),
      (try_end),
    ]),

    (1, 0, ti_once, [
      (store_mission_timer_a, ":timer"),
      (ge, ":timer", 3)
    ],[
      (assign, ":found", 0),
      (try_for_agents, ":agent"),
          (eq, ":found", 0),
          (agent_is_alive, ":agent"),
          (agent_is_human, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (troop_slot_eq, ":troop", slot_troop_spouse, "trp_player"),
          (is_between, ":troop", active_npcs_begin, kingdom_ladies_end),
          (agent_get_entry_no, ":entry", ":agent"),
          (eq, ":entry", 36),
          (assign, ":found", 1),
      (try_end),
      (try_begin),
          (eq, ":found", 1),
          (tutorial_box, "@A slave informs you that your spouse is currently dressing for lunch. If you want to talk to her go to the dressing-room next to the triclinium.", "@Information"),
      (try_end),
    ]),

    dedal_tavern_animations,

    (0,0,ti_once, [],[
      (try_for_agents, ":agent_no"),
          # (str_store_agent_name, s22, ":agent_no"),
          # (display_message, "@script called for {s22} 1"),
          (agent_is_active, ":agent_no"),
          # (str_store_agent_name, s22, ":agent_no"),
          # (display_message, "@script called for {s22} 2"),
          (agent_is_human, ":agent_no"),
          (agent_is_alive, ":agent_no"),

          (agent_get_troop_id, ":troop", ":agent_no"),
          (neg|is_between, ":troop", tavern_minstrels_begin, tavern_minstrels_end),
          (call_script, "script_init_town_agent", ":agent_no"),
      (try_end),
    ]),

    common_inventory_not_available,

    (0,8,0,[
      (neq, "$talk_context", tc_prison_break),
      (neq, "$talk_context", tc_pret_event_14),
    ],[
      (try_for_agents,":agent_no"),
        (agent_is_alive,":agent_no"),
        (agent_is_human,":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (is_between, ":troop_no", household_slaves_begin, cook_slaves_end),

        (assign, ":continue_walk", 0),
        (store_random_in_range, ":continue_walk", 1, 100),
        (try_begin),
          (le, ":continue_walk", 38),
          (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
          (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
          (agent_set_animation, ":agent_no", "anim_stand_man"),
          (agent_set_animation_progress, ":agent_no", 10),

          (agent_get_position, pos1, ":agent_no"),
          (store_random_in_range, ":points", 46, 60),
          (entry_point_get_position, pos2, ":points"),
          (agent_set_speed_limit, ":agent_no", 1),
          (agent_set_scripted_destination, ":agent_no", pos2),
        (try_end),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0,[
      (neq, "$talk_context", tc_prison_break),
      (neq, "$talk_context", tc_pret_event_14),
      (store_random_in_range, ":r", 0, 100),
      (try_begin),
          (lt, ":r", 45),
          (set_trigger_result,1),
      (else_try),
          (store_random_in_range, ":r2", 6, 22),
          (try_begin),
              (eq, ":r2", 6),
              (jump_to_menu, "mnu_emperor_event_11_1"),
          (else_try),
              (eq, ":r2", 7),
              (jump_to_menu, "mnu_emperor_event_07"),
          (else_try),
              (eq, ":r2", 8),
              (jump_to_menu, "mnu_emperor_event_08"),
          (else_try),
              (eq, ":r2", 9),
              (jump_to_menu, "mnu_emperor_event_09"),
          (else_try),
              (eq, ":r2", 10),
              (jump_to_menu, "mnu_emperor_event_10"),
          (else_try),
              (eq, ":r2", 11),
              (jump_to_menu, "mnu_emperor_event_11"),
          (else_try),
              (eq, ":r2", 12),
              (jump_to_menu, "mnu_emperor_event_12"),
          (else_try),
              (eq, ":r2", 13),
              (jump_to_menu, "mnu_emperor_event_13"),
          (else_try),
              (eq, ":r2", 14),
              (jump_to_menu, "mnu_emperor_event_14"),
          (else_try),
              (eq, ":r2", 15),
              (jump_to_menu, "mnu_emperor_event_15"),
          (else_try),
              (eq, ":r2", 16),
              (jump_to_menu, "mnu_emperor_event_16"),
          (else_try),
              (eq, ":r2", 17),
              (jump_to_menu, "mnu_emperor_event_17"),
          (else_try),
              (eq, ":r2", 18),
              (jump_to_menu, "mnu_emperor_event_18"),
          (else_try),
              (eq, ":r2", 19),
              (jump_to_menu, "mnu_emperor_event_19"),
          (else_try),
              (eq, ":r2", 20),
              (jump_to_menu, "mnu_emperor_event_20"),
          (else_try),
              (jump_to_menu, "mnu_emperor_event_23"),
          (try_end),
          (finish_mission, 0),
      (try_end),
    ],[]),
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("palace_nero_play", 0, -1,
  "You visit the imperial palace.",[
    (0,mtef_visitor_source,af_override_head|af_override_horse|af_override_weapons,0,1,[]),
    (1,mtef_visitor_source,af_castle_lord,0,1,[]),
    (2,mtef_visitor_source,af_castle_lord,0,1,[]),
    (3,mtef_visitor_source,af_castle_lord,0,1,[]),
    (4,mtef_visitor_source,af_castle_lord,0,1,[]),
    (5,mtef_visitor_source,af_castle_lord,0,1,[]),
    (6,mtef_visitor_source,af_castle_lord,0,1,[]),
    (7,mtef_visitor_source,af_castle_lord,0,1,[]),
    (8,mtef_visitor_source,af_castle_lord,0,1,[]),
    (9,mtef_visitor_source,af_castle_lord,0,1,[]),
    (10,mtef_visitor_source,af_castle_lord,0,1,[]),
    (11,mtef_visitor_source,af_override_everything,0,1,[itm_caligea,itm_roman_rich3,itm_lyre_rich]),
    (12,mtef_visitor_source,af_castle_lord,0,1,[]),
    (13,mtef_visitor_source,af_castle_lord,0,1,[]),
    (14,mtef_visitor_source,af_castle_lord,0,1,[]),
    (15,mtef_visitor_source,af_castle_lord,0,1,[]),
    (16,mtef_visitor_source,af_override_everything,0,1,[itm_caligea,itm_roman_toga]),
    (17,mtef_visitor_source,af_castle_lord,0,1,[]),
    (18,mtef_visitor_source,af_castle_lord,0,1,[]),
    (19,mtef_visitor_source,af_castle_lord,0,1,[]),
    (20,mtef_visitor_source,af_castle_lord,0,1,[]),
    (21,mtef_visitor_source,af_castle_lord,0,1,[]),
    (22,mtef_visitor_source,af_castle_lord,0,1,[]),
    (23,mtef_visitor_source,af_castle_lord,0,1,[]),
    (24,mtef_visitor_source,af_castle_lord,0,1,[]),
    (25,mtef_visitor_source,af_castle_lord,0,1,[]),
    (26,mtef_visitor_source,af_castle_lord,0,1,[]),
    (27,mtef_visitor_source,af_castle_lord,0,1,[]),
    (28,mtef_visitor_source,af_castle_lord,0,1,[]),
    (29,mtef_visitor_source,af_castle_lord,0,1,[]),
    (30,mtef_visitor_source,af_castle_lord,0,1,[]),
    (31,mtef_visitor_source,af_castle_lord,0,1,[]),
    (32,mtef_visitor_source,af_castle_lord,0,1,[]),
    (33,mtef_visitor_source,af_castle_lord,0,1,[]),
    (34,mtef_visitor_source,af_castle_lord,0,1,[]),
    (35,mtef_visitor_source,af_castle_lord,0,1,[]),
    (36,mtef_visitor_source,af_castle_lord,0,1,[]),
    (37,mtef_visitor_source,af_castle_lord,0,1,[]),
    (38,mtef_visitor_source,af_castle_lord,0,1,[]),
    (39,mtef_visitor_source,af_castle_lord,0,1,[]),
    (40,mtef_visitor_source,af_castle_lord,0,1,[]),
    (41,mtef_visitor_source,af_castle_lord,0,1,[]),
    (42,mtef_visitor_source,af_castle_lord,0,1,[]),
    (43,mtef_visitor_source,af_castle_lord,0,1,[]),
    (44,mtef_visitor_source,af_castle_lord,0,1,[]),
    (45,mtef_visitor_source,af_castle_lord,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    can_spawn_commoners,

    (ti_before_mission_start, 0, 0, [],[
      (mission_disable_talk),
	  ]),

    (0, 0, ti_once,[
      (store_mission_timer_a, ":cur_time"),
      (ge, ":cur_time", 4),
    ],[
      (mission_enable_talk),
      (start_mission_conversation, "trp_kingdom_7_lord"),
    ]),

    (0, 0, 0, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_feast),
    ]),


    (0,0,ti_once, [],[
      (try_for_agents, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_is_human, ":agent_no"),
          (agent_is_alive, ":agent_no"),
          (agent_get_troop_id,":troop",":agent_no"),
          (try_begin),
              (this_or_next|quest_slot_eq, "qst_nero_special_quest", slot_quest_target_dna, 6),# 6 one is also lute playing
              (quest_slot_eq, "qst_nero_special_quest", slot_quest_target_dna, 3),#only the 3 one is lute playing
              (eq,":troop","trp_kingdom_7_lord"),
              (play_track,0,2),
              (agent_equip_item, ":agent_no", "itm_lyre_rich"),
              (agent_set_wielded_item, ":agent_no", "itm_lyre_rich"),
              (agent_set_stand_animation, ":agent_no", "anim_lyre_standing"),
              (agent_set_animation, ":agent_no", "anim_lyre_standing"),
              (agent_play_sound,":agent_no","snd_dedal_tavern_lyre"),
              (store_random_in_range,":r",0,300),
              (agent_set_animation_progress,":agent_no",":r"),
          (else_try),
              (try_begin),
                  (eq,":troop","trp_kingdom_7_lord"),
                  (agent_unequip_item, ":agent_no", "itm_lyre_rich"),#remove it
              (try_end),
              (call_script, "script_init_town_agent", ":agent_no"),
          (try_end),
      (try_end),
    ]),
    common_inventory_not_available,
    (ti_tab_pressed, 0, 0,[],[
      (display_message, "str_cannot_leave_now"),
    ]),
	  ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("nero_final", 0, -1,
  "You visit the imperial palace.",[
    (0,mtef_visitor_source,af_override_head|af_override_horse,0,1,[]),
    (1,mtef_visitor_source,af_castle_lord,0,1,[]),
    (2,mtef_visitor_source,af_castle_lord,0,1,[]),
    (3,mtef_visitor_source,af_castle_lord,0,1,[]),
    (4,mtef_visitor_source,af_castle_lord,0,1,[]),
    (5,mtef_visitor_source,af_castle_lord,0,1,[]),
    (6,mtef_visitor_source,af_castle_lord,0,1,[]),
    (7,mtef_visitor_source,af_castle_lord,0,1,[]),
    (8,mtef_visitor_source,af_castle_lord,0,1,[]),
    (9,mtef_visitor_source,af_castle_lord,0,1,[]),
    (10,mtef_visitor_source,af_castle_lord,0,1,[]),
    (11,mtef_visitor_source,af_castle_lord,0,1,[]),
    (12,mtef_visitor_source,af_castle_lord,0,1,[]),
    (13,mtef_visitor_source,af_castle_lord,0,1,[]),
    (14,mtef_visitor_source,af_castle_lord,0,1,[]),
    (15,mtef_visitor_source,af_castle_lord,0,1,[]),
    (16,mtef_visitor_source,af_castle_lord,0,1,[]),
    (17,mtef_visitor_source,af_castle_lord|af_override_head,0,1,[itm_laurel_gold]),
    (18,mtef_visitor_source,af_castle_lord,0,1,[]),
    (19,mtef_visitor_source,af_castle_lord,0,1,[]),
    (20,mtef_visitor_source,af_castle_lord,0,1,[]),
    (21,mtef_visitor_source,af_castle_lord,0,1,[]),
    (22,mtef_visitor_source,af_castle_lord,0,1,[]),
    (23,mtef_visitor_source,af_castle_lord,0,1,[]),
    (24,mtef_visitor_source,af_castle_lord,0,1,[]),
    (25,mtef_visitor_source,af_castle_lord,0,1,[]),
    (26,mtef_visitor_source,af_castle_lord,0,1,[]),
    (27,mtef_visitor_source,af_castle_lord,0,1,[]),
    (28,mtef_visitor_source,af_castle_lord,0,1,[]),
    (29,mtef_visitor_source,af_castle_lord,0,1,[]),
    (30,mtef_visitor_source,af_castle_lord,0,1,[]),
    (31,mtef_visitor_source,af_castle_lord,0,1,[]),
    (32,mtef_visitor_source,af_castle_lord,0,1,[]),
    (33,mtef_visitor_source,af_castle_lord,0,1,[]),
    (34,mtef_visitor_source,af_castle_lord,0,1,[]),
    (35,mtef_visitor_source,af_castle_lord,0,1,[]),
    (36,mtef_visitor_source,af_override_head|af_override_horse|af_override_weapons,0,1,[itm_roman_gladius_rich_3,itm_laurel_gold]),
    (37,mtef_visitor_source,af_castle_lord,0,1,[]),
    (38,mtef_visitor_source,af_castle_lord,0,1,[]),
    (39,mtef_visitor_source,af_override_horse,0,1,[]),
    (40,mtef_visitor_source,af_castle_lord,0,1,[]),
    (41,mtef_visitor_source,af_castle_lord,0,1,[]),
    (42,mtef_visitor_source,af_castle_lord,0,1,[]),
    (43,mtef_visitor_source,af_castle_lord,0,1,[]),
    (44,mtef_visitor_source,af_castle_lord,0,1,[]),
    (45,mtef_visitor_source,af_castle_lord,0,1,[]),
    (46,mtef_visitor_source,af_castle_lord,0,1,[]),
    (47,mtef_visitor_source,af_castle_lord,0,1,[]),
    (48,mtef_visitor_source,af_castle_lord,0,1,[]),
    (49,mtef_visitor_source,af_castle_lord,0,1,[]),
    (50,mtef_visitor_source,af_castle_lord,0,1,[]),
    (51,mtef_visitor_source,af_castle_lord,0,1,[]),
    (52,mtef_visitor_source,af_castle_lord,0,1,[]),
    (53,mtef_visitor_source,af_castle_lord,0,1,[]),
    (54,mtef_visitor_source,af_castle_lord,0,1,[]),
    (55,mtef_visitor_source,af_castle_lord,0,1,[]),
    (56,mtef_visitor_source,af_castle_lord,0,1,[]),
    (57,mtef_visitor_source,af_castle_lord,0,1,[]),
    (58,mtef_visitor_source,af_castle_lord,0,1,[]),
    (59,mtef_visitor_source,af_castle_lord,0,1,[]),
    (60,mtef_visitor_source,af_castle_lord,0,1,[]),
    (61,mtef_visitor_source,af_castle_lord,0,1,[]),
    (62,mtef_visitor_source,af_castle_lord,0,1,[]),
    (63,mtef_visitor_source,af_castle_lord,0,1,[]),
    (64,mtef_visitor_source,af_castle_lord,0,1,[]),
    (65,mtef_visitor_source,af_castle_lord,0,1,[]),
    (66,mtef_visitor_source,af_castle_lord,0,1,[]),
    (67,mtef_visitor_source,af_castle_lord,0,1,[]),
    (68,mtef_visitor_source,af_castle_lord,0,1,[]),
    (69,mtef_visitor_source,af_castle_lord,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    (ti_on_agent_spawn,1,0,[
      (store_trigger_param_1,":agent"),
      (agent_get_troop_id,":troop",":agent"),
      (try_begin),
        (eq, ":troop", "trp_kingdom_7_lord"),
        (assign, "$temp3", ":agent"),
      (else_try),
        (eq, ":troop", "trp_tigellinus"),
        (assign, "$temp2", ":agent"),
      (else_try),
        (eq, ":troop", "trp_kingdom_7_lady_1"),
        (assign, "$temp1", ":agent"),
      (else_try),
        (eq, ":troop", "trp_courtier_female"),#acte
        (agent_set_visibility, ":agent", 0),
      (try_end),
    ],[]),

    (ti_before_mission_start, 0, 0, [],[
      (mission_disable_talk),
	  ]),

    (0, 1, ti_once,[],[
      (mission_enable_talk),
      (start_mission_conversation, "trp_courtier_female"),
    ]),

    common_inventory_not_available,

    (ti_tab_pressed, 0, 0,[],[(display_message, "str_cannot_leave_now"),]),

	  ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("underworld", mtf_battle_mode,charge,
  "You visit hades.",[
    (0,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (1,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (2,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (3,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (4,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (5,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (6,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (7,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (8,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
    (9,mtef_visitor_source,0,0,1,[]),
    (10,mtef_visitor_source,af_override_horse|af_override_head,0,1,[]),
  ], global_common_triggers +
  [
    cannot_spawn_commoners,
    (ti_after_mission_start, 0, ti_once, [],[
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00736252, 5000),
    ]),

    (0, 0, ti_once, [],[
      (get_player_agent_no, ":player"),
      (call_script, "script_advanced_agent_set_speed_modifier", ":player", 0),
      (agent_set_no_death_knock_down_only, ":player", 1),
    ]),

    (ti_on_agent_spawn,1,0,[
      (store_trigger_param_1,":agent"),
      (agent_get_troop_id,":troop",":agent"),
      (try_begin),
          (this_or_next|eq,":troop","trp_sisyphus"),
          (eq,":troop", "trp_herakles"),
          (try_begin),
              (agent_has_item_equipped,":agent","itm_dedal_kufel"),
              (agent_set_stand_animation, ":agent", "anim_sitting_drinking_low"),
              (agent_set_animation, ":agent", "anim_sitting_drinking_low"),
              (store_random_in_range,":r",0,300),
          (else_try),
              (agent_set_stand_animation, ":agent", "anim_sitting_low"),
              (agent_set_animation, ":agent", "anim_sitting_low"),
              (store_random_in_range,":r",0,300),
          (try_end),
          (agent_set_animation_progress,":agent",":r"),
      (try_end),
    ],[]),

    (ti_before_mission_start, 0, 0,[
      (check_quest_active, "qst_blank_quest_5"),],[
      (store_random_in_range, ":fog_distance", 50, 75),
      (store_random_in_range, ":haze_power", 25, 65),
      (set_global_haze_amount, ":haze_power"),
      (set_fog_distance, ":fog_distance", 0x333333),
      (scene_set_day_time, 1),
    ]),

    (0, 0, ti_once, [],[(mission_enable_talk),]),

    (5,0,ti_once,[
      (check_quest_active, "qst_blank_quest_5"),
      (neg|conversation_screen_is_active),
      (store_mission_timer_a, ":time"),
      (ge, ":time", 5),
    ],[
      (get_player_agent_no, ":player"),
      (call_script, "script_advanced_agent_set_speed_modifier", ":player", 150),
      (start_mission_conversation, "trp_whore"),
    ]),

    (0, 0, 0,[
      (key_clicked, key_k),
      (tutorial_message, -1),
    ],[]),

    (10,0,ti_once,[
      (check_quest_active, "qst_blank_quest_5"),
      (neg|conversation_screen_is_active),
      (store_mission_timer_a, ":time"),
      (ge, ":time", 5),
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@Everywhere this awful smoke... hopefully Kerberos wont see you.^^(press K to finish read)"),
    ]),

    (100,0,ti_once,[
      (check_quest_active, "qst_blank_quest_5"),
      (neg|conversation_screen_is_active),
      (store_mission_timer_a, ":time"),
      (ge, ":time", 10),
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@ Everywhere rocks and smoke from the ground... But whats that, was it a ghost?^^(press K to finish read)"),
		]),

    (250,0,ti_once,[
      (check_quest_active, "qst_blank_quest_5"),
      (neg|conversation_screen_is_active),
      (store_mission_timer_a, ":time"),
      (ge, ":time", 15),
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@ You hear a voice whisper: The night steals from the day and grows long, while the frost threatens to do away with the weak and the old ... ^^(press K to finish read)"),
		]),

    (400,0,ti_once,[
      (check_quest_active, "qst_blank_quest_5"),
      (neg|conversation_screen_is_active),
      (store_mission_timer_a, ":time"),
      (ge, ":time", 20),
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@ You hear the dead crying. They want you to bring them out from this awful place.^^(press K to finish read)"),
      (get_player_agent_no, ":player"),
      (agent_play_sound, ":player", "snd_panic_cry"),
    ]),

    (25,0,0,[
      (check_quest_active, "qst_blank_quest_5"),
    ],[
      (store_random_in_range, ":r", 0, 100),
      (try_begin),
          (lt, ":r", 30),
          (get_player_agent_no, ":player"),
          (display_message,"@ The dead cry.", message_negative),
          (agent_play_sound, ":player", "snd_panic_cry"),
      (try_end),
		]),
    (40,0,0,[(check_quest_active, "qst_blank_quest_5"),],[
      (store_random_in_range, ":r", 0, 100),
      (try_begin),
          (lt, ":r", 25),
          (display_message,"@ You hear something. Kerberos?", message_negative),
          (get_player_agent_no, ":player"),
          (agent_play_sound, ":player", "snd_horse_body_fall_end"),
      (try_end),
    ]),
    (550,0,ti_once,[
      (neg|conversation_screen_is_active),
      (check_quest_active, "qst_blank_quest_5"),
      (store_mission_timer_a, ":time"),
      (ge, ":time", 25),
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@ You have a sense of being overwhelmed, you feel small. Men are gone. We are dust and our life is so ephemeral... Who could live forever?^^(press K to finish read)"),
      (get_player_agent_no, ":player"),
      (agent_play_sound, ":player", "snd_panic_cry"),
    ]),

    (800,0,ti_once,[
      (check_quest_active, "qst_blank_quest_5"),
      (neg|conversation_screen_is_active),
      (store_mission_timer_a, ":time"),
      (ge, ":time", 30),
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@Life is short, live is intensely.^^(press K to finish read)"),
    ]),
    (ti_tab_pressed, 0, 0, [],[(display_message, "str_cannot_leave_now")]),

    (ti_inventory_key_pressed, 0, 0, [(display_message, "str_cant_use_inventory_now")],[]),
]),

("church", 0, -1,
    "You visit a chruch.",
    [
	 (0,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
	 (1,mtef_visitor_source,af_override_horse,0,1,[]),
	 (2,mtef_visitor_source,af_override_horse,0,1,[]),
	 (3,mtef_visitor_source,af_override_horse,0,1,[]),
	 (4,mtef_visitor_source,af_override_horse,0,1,[]),
	 (5,mtef_visitor_source,af_override_horse,0,1,[]),
	 (6,mtef_visitor_source,af_override_horse,0,1,[]),
	 (7,mtef_visitor_source,af_override_horse,0,1,[]),
	 (8,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),

    ],  p_wetter + global_common_triggers +
    [
      cannot_spawn_commoners,
        (0, 0, 0,[(key_clicked, key_k),
            (tutorial_message, -1),
        ],[]),
	   (ti_tab_pressed, 0, 0, [],
       [(jump_to_menu, "mnu_town"),
            (finish_mission,0),
        ]),


        (0,1,ti_once,[
            (check_quest_active, "qst_blank_quest_8"),
            (quest_slot_eq, "qst_blank_quest_8", slot_quest_temp_slot, 1),],
        [
            (tutorial_message_set_size, 19, 19),
            (tutorial_message_set_position, 500, 650),
            (tutorial_message_set_center_justify, 0),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@You follow Petronius. He leads you through isolated streets. Then he blindfolds you. You hear female laughs, then a female hand removes the blindfolds from your eyes. You see strangers, but Petronius is gone.^^(press K to finish read)"),
		]),
	]
),


("temple_raid", mtf_battle_mode,-1, "monasterio",
  [
	  (1,mtef_team_0, af_override_horse,aif_start_alarmed,15,[]),
    (30,mtef_visitor_source|mtef_team_1,af_override_horse, 0, 10,[]),
    (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,10,[]),
    (1,mtef_team_0, af_override_horse,aif_start_alarmed,15,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    common_inventory_not_available,
    common_battle_init_banner,

    (ti_before_mission_start, 0, 0, [],
      [
        (assign,"$g_battle_result",0),
        (call_script, "script_change_banners_and_chest"),
        (set_party_battle_mode),
      ]
    ),

    (ti_after_mission_start, 0, 0, [],[
	    (play_track, "track_travel_neutral2", 1),
	  ]),

    (ti_on_agent_killed_or_wounded, 0, 0, [], #new
    [
        (store_trigger_param_1, ":dead_agent_no"),
        #(store_trigger_param_2, ":killer_agent_no"),
        (store_trigger_param_3, ":is_wounded"),

        (try_begin),
            (ge, ":dead_agent_no", 0),
            (neg|agent_is_ally, ":dead_agent_no"),
            (agent_is_human, ":dead_agent_no"),
            (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),

            (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties

            (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),

            (try_begin),
                (call_script, "script_cf_force_wound_troop", ":dead_agent_troop_id"),
                (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
                (set_trigger_result, 2),
            (else_try),
                (neg|troop_is_hero, ":dead_agent_troop_id"),
                (eq, "$g_realistic_wounding", 1),
                (le, ":last_damage", 10),
                (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
                (set_trigger_result, 2),
            (else_try),
                (neg|troop_is_hero, ":dead_agent_troop_id"),
                (eq, "$g_realistic_wounding", 1),
                (ge, ":last_damage", 40),
                (set_trigger_result, 1),
            (else_try),
                (try_begin),
                    (eq, ":is_wounded", 1),
                    (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
                (try_end),
                (set_trigger_result, 0),
            (try_end),
        (try_end),

        (try_begin),
            (ge, ":dead_agent_no", 0),
            (agent_is_ally, ":dead_agent_no"),
            (agent_is_human, ":dead_agent_no"),

            (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),

            (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),

            (party_get_skill_level, ":surgery", "p_main_party", skl_surgery),
            (store_mul, ":chance", ":surgery", 4),
            (val_add, ":chance", 25),
            (store_random_in_range, ":rand", 0, 100),

            (try_begin),
                (call_script, "script_cf_force_wound_troop", ":dead_agent_troop_id"),
                (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
                (set_trigger_result, 2),
            (else_try),
                (neg|troop_is_hero, ":dead_agent_troop_id"),
                (eq, "$g_realistic_wounding", 1),
                (le, ":last_damage", 10),
                (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
                (set_trigger_result, 2),
            (else_try),
                (neg|troop_is_hero, ":dead_agent_troop_id"),
                (eq, "$g_realistic_wounding", 1),
                (gt, ":rand", ":chance"),
                (ge, ":last_damage", 40),
                (set_trigger_result, 1),
            (else_try),
                (set_trigger_result, 0),
            (try_end),
        (try_end),
    ]),

    (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

    (1, 4, ti_once, [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le,1)
    ],[
      (try_begin),
          (main_hero_fallen),
			    (assign, "$temp", 0),
          (jump_to_menu, "mnu_death_waits"),
      (else_try),
          (check_quest_active, "qst_poking_the_lion"),
          (quest_slot_eq, "qst_poking_the_lion", slot_quest_current_state, 4),
          (jump_to_menu, "mnu_temple_jerusalem_story_loot_2"),
      (else_try),
          (jump_to_menu, "mnu_great_jewish_reolt_start"),
      (try_end),
      (stop_all_sounds, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
      (finish_mission, 3),
    ]),
]),

("visit_forest",0,-1,
    "visit gweny",
    [
      (0,mtef_scene_source,0,0,1,[]),
      (1,mtef_visitor_source,af_override_horse,0,1,[]),
    ], p_wetter + storms + global_common_triggers +
    [
      cannot_spawn_commoners,
      improved_lightning,
      common_inventory_not_available,
   ###chief walkers
      (1, 0, ti_once,
      [],
      [
          (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),

      ]),


      (0, 0, ti_once, [
          (store_current_scene, reg33),
          (neq, reg33, "scn_slavic_holy_side"),
          (tutorial_message_set_size, 15, 15),
          (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
          (tutorial_message_set_center_justify, 0),
          ],[]),

      (1,0,0,[
          (neg|conversation_screen_is_active),
          (neg|is_presentation_active, "prsnt_battle"),
          (neg|is_presentation_active, "prsnt_order_display"),
          (store_mission_timer_a, ":cur_time"),
          (le, ":cur_time", 20),
          (store_current_scene, reg33),
          (neq, reg33, "scn_slavic_holy_side"),
        ],
        [
          (store_mission_timer_a, ":cur_time"),
          (try_begin),
            (ge, ":cur_time", 16),
            (tutorial_message, -1),
            (tutorial_message_set_background, 0),
          (else_try),
            (ge, ":cur_time", 8),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@I think there is a path. Shall I follow it to see where it brings me?"),
          (try_end),
      ]),

   (ti_on_agent_spawn,1,0,[
    (store_trigger_param_1,":agent"),
		(agent_get_troop_id,":troop",":agent"),
		(try_begin),
			(eq,":troop", "trp_gwenhwyfar"),
			(agent_set_stand_animation, ":agent", "anim_sitting_low"),
			(agent_set_animation, ":agent", "anim_sitting_low"),
			(store_random_in_range,":r",0,300),
			(agent_set_animation_progress,":agent",":r"),
		(try_end),],[]),

      (ti_tab_pressed, 0, 0, [],
       [(stop_all_sounds, 1),(finish_mission,0)]),
    ]
  ),

  ("visit_vally_of_kings",mtf_battle_mode,-1,
    "visit gweny",
    [
      (0,mtef_scene_source|mtef_team_0,0,0,1,[]),
      (1,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
      (2,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
      (3,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
      (4,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    ], p_wetter + storms + global_common_triggers +
    [
      cannot_spawn_commoners,
    improved_lightning,
      (ti_before_mission_start, 0, 0, [],
        [
          (team_set_relation, 0, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
      ]),
  dedal_shield_bash_AI,
  dedal_shield_bash,
  custom_commander_critical_strike,
  miracle_battle_trigger,
  more_difficult_damage,
  realistic_wounding,
      (ti_on_agent_spawn, 0, 0, [],
        [
          (store_trigger_param_1, ":agent"),
          (agent_is_active, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (neq, ":troop", "trp_player"),
          (neg|troop_is_hero, ":troop"),
          (agent_set_team, ":agent", 7),
      ]),
      (2, 0, 0, [
          (store_skill_level,":player_sneaking_skill","skl_athletics","trp_player"),
          (assign,":sneak_distance",1500),
          (val_mul, ":player_sneaking_skill", 10),
          (val_sub, ":sneak_distance", ":player_sneaking_skill"),
          (get_player_agent_no,":player_agent"),
          (agent_get_position,pos1,":player_agent"),
          (assign,":continue",0),
          (try_for_agents, ":cur_agent"),
            (agent_get_troop_id, ":troop", ":cur_agent"),
            (neq, ":troop", "trp_player"),
            (neg|is_between, ":troop", companions_begin, companions_end),
            (agent_get_position,pos2,":cur_agent"),
            (get_distance_between_positions,":distance",pos1,pos2),
            (lt,":distance",":sneak_distance"),
            (assign,":continue",1),
          (try_end),
          (eq,":continue",1),
        ],
        [
         (team_set_relation,0,7,-1),
         (set_party_battle_mode),
      ]),

      wounds_vc,
      common_inventory_not_available,

      (1, 0, ti_once,
      [],
      [
          (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),

      ]),


      (0, 0, ti_once, [
          (tutorial_message_set_size, 15, 15),
          (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
          (tutorial_message_set_center_justify, 0),
          ],[]),

      (1,0,0,[                        (neg|conversation_screen_is_active),
          (neg|is_presentation_active, "prsnt_battle"),
          (neg|is_presentation_active, "prsnt_order_display"),
          (store_mission_timer_a, ":cur_time"),
          (le, ":cur_time", 20),
        ],
        [
          (store_mission_timer_a, ":cur_time"),
          (try_begin),
            (ge, ":cur_time", 16),
            (tutorial_message, -1),
            (tutorial_message_set_background, 0),
          (else_try),
            (ge, ":cur_time", 8),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@Thousand years ago the Egyptian kings were buried here. Now, this place is only populated by animals.\
 Traps and tomb raiders are a serious threat."),
          (try_end),
      ]),

       (0, 0, ti_once,
        [
          (main_hero_fallen),
        ],
        [
          (call_script, "script_change_troop_renown", "trp_player", -5),
          (display_message, "@You fall in a puddle of blood. Slowly live escapes from your body...",color_terrible_news),
          (assign, "$temp", 1),
          (jump_to_menu, "mnu_death_waits"),
          (finish_mission,5),
      ]),

      (ti_tab_pressed, 0, 0, [],
       [(stop_all_sounds, 1),(finish_mission,0)]),
    ],
),

("paganholysite",0,-1, #Pagan holy site
    "Nordic Place",
    [(0,mtef_scene_source|mtef_team_0,0,0,1,[]),
      (1,mtef_scene_source|mtef_team_0,0,0,1,[]),
      (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
      (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
      (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
      (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
      (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
      (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),

      (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (11,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (12,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (13,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (14,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (15,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (16,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (17,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (18,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (19,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (20,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (21,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (22,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (23,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (24,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (25,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (26,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (27,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (28,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (29,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (30,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(31,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (32,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(33,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (34,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(35,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (36,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(37,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (38,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(39,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (40,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (41,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),	#for leaving door
      (42,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(43,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (44,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(45,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (46,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(47,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    ], p_wetter + storms + global_common_triggers +
    [
      can_spawn_commoners,
      (ti_before_mission_start, 0, 0,[
        (eq, "$g_encountered_party", "p_arabian_holy_side_1"),
        (party_slot_eq, "$g_encountered_party", slot_holy_side_event, 1),
      ],[
        (replace_scene_props, "spr_x_goddess_of_fertility", "spr_empty"),
      ]),

      improved_lightning,
      #can_spawn_commoners,
      (ti_before_mission_start, 0, 0, [],[(call_script, "script_change_banners_and_chest")]),
      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)],[]),
      (ti_after_mission_start, 0, 0, [],[(call_script, "script_music_set_situation_with_culture", mtf_sit_town)]),


      (ti_tab_pressed, 0, 0, [(set_trigger_result,1)],[]),

      (ti_on_agent_spawn, 0, 0, [],
        [
          (store_trigger_param_1, ":agent_no"),
          (get_player_agent_no, ":player_agent"),

          (try_begin),
            (neq, ":player_agent", ":agent_no"),
            (agent_set_team, ":agent_no", 7),
          (try_end),
      ]),

    (0,0,ti_once, [],
    [
      (try_for_agents, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_is_human, ":agent_no"),
          (agent_is_alive, ":agent_no"),
          (call_script, "script_init_town_agent", ":agent_no"),
      (try_end),
    ]),

      # (1, 0, ti_once, [],
        # [
          # #(call_script, "script_init_town_walker_agents"),
          # (play_track, "track_paganholysite", 1),
      # ]),

      (0,8,0,[],
        [
          (try_for_agents,":agent_no"),
            (agent_is_alive,":agent_no"),
            (agent_is_human,":agent_no"),
            (agent_get_entry_no, ":entry", ":agent_no"),
            (this_or_next|is_between, ":entry", 2, 19),
            (is_between, ":entry", 25, 33),
            (assign, ":continue_walk", 0),
            (store_random_in_range, ":continue_walk", 1, 100),
            (try_begin),
              (le, ":continue_walk", 40),
              (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
              (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
              (agent_set_animation, ":agent_no", "anim_stand_man"),
              (agent_set_animation_progress, ":agent_no", 10),

              (agent_get_position, pos1, ":agent_no"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                (eq, ":r", 1),
                (store_random_in_range, ":points", 4, 19),
                (entry_point_get_position, pos2, ":points"),
                (agent_set_speed_limit, ":agent_no", 1),
                (agent_set_scripted_destination, ":agent_no", pos2),
              (else_try),
                (store_random_in_range, ":points", 25, 33),
                (entry_point_get_position, pos2, ":points"),
                (agent_set_speed_limit, ":agent_no", 1),
                (agent_set_scripted_destination, ":agent_no", pos2),
              (try_end),
            (try_end),
          (try_end),
      ]),

      (0, 0, ti_once, [],
        [
          (party_slot_eq, "$current_town", slot_party_type, spt_town),
          (call_script, "script_town_init_doors", 0),
          (try_begin),
            (eq, "$town_nighttime", 0),
            (play_sound, "snd_town_ambiance", sf_looping),
          (try_end),
      ]),

      ambient_scene_play_loop,
      (5, 0, 0,[],[(call_script,"script_sp_scene_play_random_ambient_sound",1)]),
      ambient_set_agents_for_sounds,
      ambient_agent_play_sound,

      # (3, 0, 0, [
          # (call_script, "script_tick_town_walkers"),
          # ],[]),


      (0, 0, ti_once, [
          (tutorial_message_set_size, 15, 15),
          (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
          (tutorial_message_set_center_justify, 0),
          ],[]),

      (1,0,0,[                        (neg|conversation_screen_is_active),
          (neg|is_presentation_active, "prsnt_battle"),
          (neg|is_presentation_active, "prsnt_order_display"),
          (store_mission_timer_a, ":cur_time"),
          (le, ":cur_time", 20),
        ],
        [
          (store_mission_timer_a, ":cur_time"),
          (try_begin),
            (ge, ":cur_time", 16),
            (tutorial_message, -1),
            (tutorial_message_set_background, 0),
          (else_try),
            (ge, ":cur_time", 8),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@You can feel the proximity of the gods. You can make sacrifices to the gods. If you're lucky, the gods may hear you and grant your wish."),
          (try_end),
      ]),

      (ti_on_leave_area, 0, 0, [
          (assign,"$g_leave_town",1),
          ],[]),

    ]+ bodyguard_triggers,
),

("paganholysites_atacado", mtf_battle_mode,-1,"monasterio",[
    (1,mtef_team_0,af_override_horse,aif_start_alarmed,60,[]),
    (30,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed, 12,[]),
    (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),
    (1,mtef_team_0,af_override_horse,aif_start_alarmed,60,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,
    (0.5, 0, ti_once, [],[
      (set_show_messages, 0),
      (try_for_range, ":cur_group", 0, grc_everyone),
        (team_give_order, 1, ":cur_group", mordr_hold),
        (team_give_order, 1, ":cur_group", mordr_stand_closer),
        (team_give_order, 1, ":cur_group", mordr_stand_closer),
        (team_give_order, 1, ":cur_group", mordr_hold),
        (team_give_order, 1, ":cur_group", mordr_stand_closer),
        (team_give_order, 1, ":cur_group", mordr_stand_closer),
      (try_end),
      (set_show_messages, 1),
    ]),

    improved_lightning,
    common_inventory_not_available,
    common_battle_init_banner,
    #common_realistic_casualties, 		#!
    wounds_vc,
    dedal_shield_bash,
    dedal_shield_bash_AI,
    common_battle_check_friendly_kills,

    common_battle_player_fallen_renown_lose,
    common_music_situation_update,

    (ti_before_mission_start, 0,0, [],[
      (assign,"$g_battle_result",0),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, [],[
      (call_script, "script_combat_music_set_situation_with_culture"),
      (call_script, "script_init_death_cam"),
    ]),

    (ti_on_agent_hit, 0, 0, [],[
      (store_trigger_param, ":inflicted_agent_id", 1),
      #(store_trigger_param, ":dealer_agent_id", 2),
      #(store_trigger_param, ":inflicted_damage", 3),
      #(get_player_agent_no, ":player_agent"),
      #(eq, ":dealer_agent_id", ":player_agent"),
      (agent_is_active, ":inflicted_agent_id"),
      (agent_is_human, ":inflicted_agent_id"),
      (agent_is_alive, ":inflicted_agent_id"),
      (neg|agent_is_ally, ":inflicted_agent_id"),
      #sound:
      (store_random_in_range, ":rand", 1, 8),
      (eq, ":rand", 1),
      (agent_play_sound, ":inflicted_agent_id", "snd_panic_hit"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent_no"),
      (store_trigger_param_3, ":is_wounded"),
      #(store_trigger_param_2, ":killer_agent_no"),
      (get_player_agent_no, ":player"),
      (neq, ":dead_agent_no", ":player"),
      (try_begin),
        (ge, ":dead_agent_no", 0),
        (agent_is_ally, ":dead_agent_no"),
        (agent_is_human, ":dead_agent_no"),
        (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
        (try_begin),
            (eq, ":is_wounded", 1),
            (party_wound_members, "p_main_party", ":dead_agent_troop_id", 1),
        (else_try),
            (party_remove_members, "p_main_party", ":dead_agent_troop_id", 1),
        (try_end),
        #(party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
        #(agent_slot_eq, ":dead_agent_no", slot_agent_vc_wounded, 1),	#new
        #(party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
      (try_end),
      #(call_script, "script_apply_death_effect_on_courage_scores", ":dead_agent_no", ":killer_agent_no"),
    ]),

    (ti_tab_pressed, 0, 0,[
      (try_begin),
        (neg|main_hero_fallen),
        (num_active_teams_le,1),
        (jump_to_menu, "mnu_saquear_paganholysite"),
      (else_try),
        (question_box, "@Do you wish to retreat?"),
      (try_end),
    ],[]),

    (ti_question_answered, 0, 0,[],[
      (store_trigger_param_1, ":number"),
      (eq, ":number", 0),
      (stop_all_sounds),
      (jump_to_menu, "mnu_saquear_paganholysite_lost"),
      (finish_mission),
    ]),


    # (ti_tab_pressed, 0, 0, [ ],[
    # (try_begin),
      # (num_active_teams_le,1),
      # (jump_to_menu, "mnu_saquear_paganholysite"),
    # (else_try),
      # (jump_to_menu, "mnu_saquear_paganholysite_lost"),
    # (try_end),
    # (stop_all_sounds, 1),
    # (finish_mission),
    # ]),

    (1, 4, ti_once, [
      (num_active_teams_le,1),
    ],[
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_saquear_paganholysite_lost"),
      (else_try),
        (jump_to_menu, "mnu_saquear_paganholysite"),
      (try_end),
      (stop_all_sounds, 1),
      (finish_mission),
    ]),

    (1, 4, 0, [(main_hero_fallen)],[
      ##diplomacy begin
      (try_begin),
          (call_script, "script_cf_dplmc_battle_continuation"),
      (else_try),
          (jump_to_menu, "mnu_saquear_paganholysite_lost"),
          (stop_all_sounds, 1),
          (finish_mission,0),
      (try_end),
    ]),

    (0, 0, ti_once, [],[
      (call_script, "script_init_death_cam"), #SB : add camera
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),
    common_battle_inventory,
    common_battle_order_panel_tick,
  ]
  + theoris_decapitation
  + ai_horn
  + utility_triggers + battle_panel_triggers + extended_battle_menu
  + dplmc_battle_mode_triggers
  + auxiliary_player
  + camera_controls
),

  ("visit_pyramid",0,-1,
    "visit pyramid",
    [
      (0,mtef_scene_source,0,0,1,[]),
      (1,mtef_visitor_source,af_override_horse,0,1,[]),
      (2,mtef_visitor_source,af_override_horse,0,1,[]),
      (3,mtef_visitor_source,af_override_horse,0,1,[]),
      (4,mtef_visitor_source,af_override_horse,0,1,[]),
      (5,mtef_visitor_source,af_override_horse,0,1,[]),
      (6,mtef_visitor_source,af_override_horse,0,1,[]),
      (7,mtef_visitor_source,af_override_horse,0,1,[]),
      (8,mtef_visitor_source,af_override_horse,0,1,[]),
      (9,mtef_visitor_source,af_override_horse,0,1,[]),
      (10,mtef_visitor_source,af_override_horse,0,1,[]),
      (11,mtef_visitor_source,af_override_horse,0,1,[]),
      (12,mtef_visitor_source,af_override_horse,0,1,[]),
      (13,mtef_visitor_source,af_override_horse,0,1,[]),
      (14,mtef_visitor_source,af_override_horse,0,1,[]),
      (15,mtef_visitor_source,af_override_horse,0,1,[]),
      (16,mtef_visitor_source,af_override_horse,0,1,[]),
      (17,mtef_visitor_source,af_override_horse,0,1,[]),
      (18,mtef_visitor_source,af_override_horse,0,1,[]),
      (19,mtef_visitor_source,af_override_horse,0,1,[]),
      (20,mtef_visitor_source,af_override_horse,0,1,[]),
      (21,mtef_visitor_source,af_override_horse,0,1,[]),
      (22,mtef_visitor_source,af_override_horse,0,1,[]),
      (23,mtef_visitor_source,af_override_horse,0,1,[]),
      (24,mtef_visitor_source,af_override_horse,0,1,[]),
      (25,mtef_visitor_source,af_override_horse,0,1,[]),
      (26,mtef_visitor_source,af_override_horse,0,1,[]),
    ], p_wetter + storms + global_common_triggers +
    [
      can_spawn_commoners,
    improved_lightning,
      common_inventory_not_available,

      (ti_on_agent_spawn, 0, 0, [],
        [
          (store_trigger_param_1, ":agent_no"),
          (get_player_agent_no, ":player_agent"),
          (try_begin),
            (neq, ":player_agent", ":agent_no"),
            (agent_set_team, ":agent_no", 7),
          (try_end),
      ]),
    (0,0,ti_once, [],
    [
    (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_get_troop_id, ":t", ":agent_no"),
        (neq, ":t", "trp_slave_mine"),
        (call_script, "script_init_town_agent", ":agent_no"),
    (try_end),
    ]),

   (ti_on_agent_spawn,1,0,[
		(store_trigger_param_1,":agent"),
		(agent_get_troop_id,":troop",":agent"),
		  # (try_begin),
			# (agent_get_item_slot,":gloves",":agent",ek_gloves),
			# (try_begin),
			  # (gt,":gloves",0),
			  # (agent_unequip_item,":agent",":gloves"),
			# (try_end),

		  # (try_end),
		(try_begin),
			(eq,":troop","trp_slave_mine"),
			(agent_equip_item,":agent","itm_pickaxe_work"),
			#(agent_set_wielded_item, ":agent", "itm_pickaxe"),
			(agent_set_stand_animation, ":agent", "anim_mining"),
			(agent_set_animation, ":agent", "anim_mining"),
			(agent_play_sound,":agent","snd_dedal_mine_pickaxe"),
			(agent_ai_set_interact_with_player,":agent",0),
			  (assign,":end",1),
			  (convert_to_fixed_point,":end"),
			  (store_random_in_range,":progress",0,":end"),
			  (agent_set_animation_progress,":agent",":progress"),
		(try_end),
	],[]),

   (
	ti_on_agent_spawn,1,0,[
		(store_trigger_param_1,":agent"),
		(agent_get_troop_id,":troop",":agent"),
		(try_begin),
			(eq,":troop", "trp_refugee"),
			(agent_set_stand_animation, ":agent", "anim_sitting_low"),
			(agent_set_animation, ":agent", "anim_sitting_low"),
			(store_random_in_range,":r",0,300),
			(agent_set_animation_progress,":agent",":r"),
		(try_end),
	],[]),

   ###chief walkers
       (1, 0, ti_once,
       [],
       [
           (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),

       ]),
#infiltration_eastern
      #(2, 0, 0, [],[
	  #(play_track, "track_infiltration_eastern", 1),
	  #]),

      (0, 0, ti_once, [
          (tutorial_message_set_size, 15, 15),
          (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
          (tutorial_message_set_center_justify, 0),
          ],[]),

      (1,0,0,[                        (neg|conversation_screen_is_active),
          (neg|is_presentation_active, "prsnt_battle"),
          (neg|is_presentation_active, "prsnt_order_display"),
          (store_mission_timer_a, ":cur_time"),
          (le, ":cur_time", 20),
        ],
        [
          (store_mission_timer_a, ":cur_time"),
          (try_begin),
            (ge, ":cur_time", 16),
            (tutorial_message, -1),
            (tutorial_message_set_background, 0),
          (else_try),
            (ge, ":cur_time", 8),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@You feel overwhelmed! How was it possible that men built such structures?"),
          (try_end),
      ]),

     # ambient_scene_play_loop,
     # (5, 0, 0,[],[(call_script,"script_sp_scene_play_random_ambient_sound",1)]),
      ambient_set_agents_for_sounds,
      ambient_agent_play_sound,
	  #chief walkers acaba

      (0,8,0,[],
        [
          (try_for_agents,":agent_no"),
            (agent_is_alive,":agent_no"),
            (agent_is_human,":agent_no"),
            (agent_get_troop_id, ":troop_no", ":agent_no"),
            (eq, ":troop_no", "trp_slave"),

            (assign, ":continue_walk", 0),
            (store_random_in_range, ":continue_walk", 1, 100),
            (try_begin),
              (le, ":continue_walk", 40),
              (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
              (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
              (agent_set_animation, ":agent_no", "anim_stand_man"),
              (agent_set_animation_progress, ":agent_no", 10),

              (agent_get_position, pos1, ":agent_no"),
              (store_random_in_range, ":points", 6, 21),
              (entry_point_get_position, pos2, ":points"),
              (agent_set_speed_limit, ":agent_no", 1),
              (agent_set_scripted_destination, ":agent_no", pos2),
            (try_end),
          (try_end),
      ]),
      (ti_tab_pressed, 0, 0, [],
       [(stop_all_sounds, 1),(finish_mission,0)]),
    ]+ bodyguard_triggers,
  ),

    ("visit_mine",0,-1,
    "visit mine",
    [
      (0,mtef_scene_source,0,0,1,[]),
      (1,mtef_visitor_source,af_override_horse,0,1,[]),
      (2,mtef_visitor_source,af_override_horse,0,1,[]),
      (3,mtef_visitor_source,af_override_horse,0,1,[]),
      (4,mtef_visitor_source,af_override_horse,0,1,[]),
      (5,mtef_visitor_source,af_override_horse,0,1,[]),
      (6,mtef_visitor_source,af_override_horse,0,1,[]),
      (7,mtef_visitor_source,af_override_horse,0,1,[]),
      (8,mtef_visitor_source,af_override_horse,0,1,[]),
      (9,mtef_visitor_source,af_override_horse,0,1,[]),
      (10,mtef_visitor_source,af_override_horse,0,1,[]),
      (11,mtef_visitor_source,af_override_horse,0,1,[]),
      (12,mtef_visitor_source,af_override_horse,0,1,[]),
      (13,mtef_visitor_source,af_override_horse,0,1,[]),
      (14,mtef_visitor_source,af_override_horse,0,1,[]),
      (15,mtef_visitor_source,af_override_horse,0,1,[]),
      (16,mtef_visitor_source,af_override_horse,0,1,[]),
      (17,mtef_visitor_source,af_override_horse,0,1,[]),
      (18,mtef_visitor_source,af_override_horse,0,1,[]),
      (19,mtef_visitor_source,af_override_horse,0,1,[]),
      (20,mtef_visitor_source,af_override_horse,0,1,[]),
      (21,mtef_visitor_source,af_override_horse,0,1,[]),
      (22,mtef_visitor_source,af_override_horse,0,1,[]),
      (23,mtef_visitor_source,af_override_horse,0,1,[]),
      (24,mtef_visitor_source,af_override_horse,0,1,[]),
      (25,mtef_visitor_source,af_override_horse,0,1,[]),
      (26,mtef_visitor_source,af_override_horse,0,1,[]),
      (27,mtef_visitor_source,af_override_horse,0,1,[]),
      (28,mtef_visitor_source,af_override_horse,0,1,[]),
      (29,mtef_visitor_source,af_override_horse,0,1,[]),
      (30,mtef_visitor_source,af_override_horse,0,1,[]),
    ], p_wetter + storms + global_common_triggers +
    [
      can_spawn_commoners,
    improved_lightning,
      common_inventory_not_available,

      (ti_on_agent_spawn, 0, 0, [],
        [
          (store_trigger_param_1, ":agent_no"),
          (get_player_agent_no, ":player_agent"),

          (try_begin),
            (neq, ":player_agent", ":agent_no"),
            (agent_set_team, ":agent_no", 7),
          (try_end),
      ]),

    (0,0,ti_once, [],
    [
    (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_get_troop_id, ":t", ":agent_no"),
        (neq, ":t", "trp_slave_mine"),
        (call_script, "script_init_town_agent", ":agent_no"),
    (try_end),
    ]),

    (ti_on_agent_spawn,1,0,[
		(store_trigger_param_1,":agent"),
		(agent_get_troop_id,":troop",":agent"),
		(try_begin),
			(eq,":troop","trp_slave_mine"),
			(agent_equip_item,":agent","itm_pickaxe_work"),
			#(agent_set_wielded_item, ":agent", "itm_pickaxe"),
			(agent_set_stand_animation, ":agent", "anim_mining"),
			(agent_set_animation, ":agent", "anim_mining"),
			(agent_play_sound, ":agent", "snd_pickaxesound"),
			(agent_ai_set_interact_with_player,":agent",0),
			  (assign,":end",1),
			  (convert_to_fixed_point,":end"),
			  (store_random_in_range,":progress",0,":end"),
			  (agent_set_animation_progress,":agent",":progress"),
		(try_end),
	],[]),

   ###chief walkers
       (1, 0, ti_once,
       [],
       [
           (call_script, "script_music_set_situation_with_culture", mtf_sit_town),

       ]),

      ambient_scene_play_loop,
      ambient_scene_play_random_sound,
      ambient_set_agents_for_sounds,
      ambient_agent_play_sound,
	  #chief walkers acaba

      (0,8,0,[],
        [
          (try_for_agents,":agent_no"),
            (agent_is_alive,":agent_no"),
            (agent_is_human,":agent_no"),
            (agent_get_troop_id, ":troop_no", ":agent_no"),
            (eq, ":troop_no", "trp_slave"),

            (assign, ":continue_walk", 0),
            (store_random_in_range, ":continue_walk", 1, 100),
            (try_begin),
              (le, ":continue_walk", 40),
              (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
              (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
              (agent_set_animation, ":agent_no", "anim_stand_man"),
              (agent_set_animation_progress, ":agent_no", 10),

              (agent_get_position, pos1, ":agent_no"),
              (store_random_in_range, ":points", 6, 21),
              (entry_point_get_position, pos2, ":points"),
              (agent_set_speed_limit, ":agent_no", 1),
              (agent_set_scripted_destination, ":agent_no", pos2),
            (try_end),
          (try_end),
      ]),
      (0, 0, ti_once, [
          (tutorial_message_set_size, 15, 15),
          (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
          (tutorial_message_set_center_justify, 0),
          ],[]),

      (1,0,0,[                        (neg|conversation_screen_is_active),
          (neg|is_presentation_active, "prsnt_battle"),
          (neg|is_presentation_active, "prsnt_order_display"),

        ],
        [
          (store_mission_timer_a, ":cur_time"),
          (try_begin),
            (ge, ":cur_time", 21),
            (tutorial_message, -1),
            (tutorial_message_set_background, 0),
          (else_try),
            (ge, ":cur_time", 13),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@Your own life seems not so bad, now that you see these poor wretches working themselves into an early grave just for the bread to survive."),
          (else_try),
            (ge, ":cur_time", 12),
            (tutorial_message, -1),
            (tutorial_message_set_background, 0),
          (else_try),
            (ge, ":cur_time", 4),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@The rattle of spikes on the stone is deafening. Below, you can see people working hard under the command of a foreman."),
          (try_end),
      ]),

	  (20, 0, 0, [(play_sound,"snd_pickaxesound"),
          ],[]),
      (ti_tab_pressed, 0, 0, [],
       [(stop_all_sounds, 1),(finish_mission,0)]),
    ]+ bodyguard_triggers,
  ),

    ("visit_delphi",0,-1,
    "visit delphi",
    [
      (0,mtef_scene_source,0,0,1,[]),
      (1,mtef_visitor_source,af_override_horse,0,1,[]),
      (2,mtef_visitor_source,af_override_horse,0,1,[]),
      (3,mtef_visitor_source,af_override_horse,0,1,[]),
      (4,mtef_visitor_source,af_override_horse,0,1,[]),
      (5,mtef_visitor_source,af_override_horse,0,1,[]),
      (6,mtef_visitor_source,af_override_horse,0,1,[]),
      (7,mtef_visitor_source,af_override_horse,0,1,[]),
      (8,mtef_visitor_source,af_override_horse,0,1,[]),
      (9,mtef_visitor_source,af_override_horse,0,1,[]),
      (10,mtef_visitor_source,af_override_horse,0,1,[]),
      (11,mtef_visitor_source,af_override_horse,0,1,[]),
      (12,mtef_visitor_source,af_override_horse,0,1,[]),
      (13,mtef_visitor_source,af_override_horse,0,1,[]),
      (14,mtef_visitor_source,af_override_horse,0,1,[]),
      (15,mtef_visitor_source,af_override_horse,0,1,[]),
      (16,mtef_visitor_source,af_override_horse,0,1,[]),
      (17,mtef_visitor_source,af_override_horse,0,1,[]),
      (18,mtef_visitor_source,af_override_horse,0,1,[]),
      (19,mtef_visitor_source,af_override_horse,0,1,[]),
      (20,mtef_visitor_source,af_override_horse,0,1,[]),
      (21,mtef_visitor_source,af_override_horse,0,1,[]),
      (22,mtef_visitor_source,af_override_horse,0,1,[]),
      (23,mtef_visitor_source,af_override_horse,0,1,[]),
      (24,mtef_visitor_source,af_override_horse,0,1,[]),
      (25,mtef_visitor_source,af_override_horse,0,1,[]),
      (26,mtef_visitor_source,af_override_horse,0,1,[]),
      (27,mtef_visitor_source,af_override_horse,0,1,[]),
      (28,mtef_visitor_source,af_override_horse,0,1,[]),
      (29,mtef_visitor_source,af_override_horse,0,1,[]),
      (30,mtef_visitor_source,af_override_horse,0,1,[]),
    ], p_wetter + storms + global_common_triggers +
    [
      can_spawn_commoners,
    improved_lightning,
      common_inventory_not_available,

      (ti_on_agent_spawn, 0, 0, [],
        [
          (store_trigger_param_1, ":agent_no"),
          (get_player_agent_no, ":player_agent"),

          (try_begin),
            (neq, ":player_agent", ":agent_no"),
            (agent_set_team, ":agent_no", 7),
          (try_end),
      ]),

    (0,0,ti_once, [],
    [
    (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (call_script, "script_init_town_agent", ":agent_no"),
    (try_end),
    ]),


   ###chief walkers
       (1, 0, ti_once,
       [],
       [
           (call_script, "script_music_set_situation_with_culture", mtf_sit_town),

       ]),
      ambient_scene_play_loop,
      ambient_scene_play_random_sound,
      ambient_set_agents_for_sounds,
      ambient_agent_play_sound,
	  #chief walkers acaba

      (0,8,0,[],
        [
          (try_for_agents,":agent_no"),
            (agent_is_alive,":agent_no"),
            (agent_is_human,":agent_no"),
            (agent_get_troop_id, ":troop_no", ":agent_no"),
            (this_or_next|eq, ":troop_no", "trp_guest_female"),
            (eq, ":troop_no", "trp_guest"),

            (assign, ":continue_walk", 0),
            (store_random_in_range, ":continue_walk", 1, 100),
            (try_begin),
              (le, ":continue_walk", 38),
              (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
              (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
              (agent_set_animation, ":agent_no", "anim_stand_man"),
              (agent_set_animation_progress, ":agent_no", 10),

              (agent_get_position, pos1, ":agent_no"),
              (store_random_in_range, ":points", 2, 21),
              (entry_point_get_position, pos2, ":points"),
              (agent_set_speed_limit, ":agent_no", 1),
              (agent_set_scripted_destination, ":agent_no", pos2),
            (try_end),
          (try_end),
      ]),
      (0, 0, ti_once, [
          (tutorial_message_set_size, 15, 15),
          (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
          (tutorial_message_set_center_justify, 0),
          ],[]),

      (1,0,0,[                        (neg|conversation_screen_is_active),
          (neg|is_presentation_active, "prsnt_battle"),
          (neg|is_presentation_active, "prsnt_order_display"),

        ],
        [
          (store_mission_timer_a, ":cur_time"),
          (try_begin),
            (ge, ":cur_time", 21),
            (tutorial_message, -1),
            (tutorial_message_set_background, 0),
          (else_try),
            (ge, ":cur_time", 13),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@You feel the proximity of the gods."),
          (else_try),
            (ge, ":cur_time", 12),
            (tutorial_message, -1),
            (tutorial_message_set_background, 0),
          (else_try),
            (ge, ":cur_time", 4),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@You smell the fresh air of Greece. It is so delightful."),
          (try_end),
      ]),

      (ti_tab_pressed, 0, 0, [],
       [(stop_all_sounds, 1),(finish_mission,0)]),
    ]+ bodyguard_triggers,
  ),

    ("visit_pythia",0,-1,
    "visit pythia",
    [
      (0,mtef_scene_source,af_override_horse|af_override_head,0,1,[]),
      (1,mtef_visitor_source,af_override_horse,0,1,[]),
    ],  global_common_triggers +
    [

      common_inventory_not_available,

   ###chief walkers
       (1, 0, ti_once,
       [],
       [
           (call_script, "script_music_set_situation_with_culture", mtf_sit_town_infiltrate),

       ]),
      ambient_scene_play_loop,
      ambient_scene_play_random_sound,
      ambient_set_agents_for_sounds,
      ambient_agent_play_sound,
	  #chief walkers acaba
  (ti_on_agent_spawn,1,0, [],
   [
	(try_for_agents, ":agent"),
		(agent_is_alive, ":agent"),
		(agent_is_human, ":agent"),
		(agent_get_troop_id, ":troop", ":agent"),
		#(set_fixed_point_multiplier, 100),
			(try_begin),
				(eq, ":troop", "trp_pythia"),
				(agent_set_stand_animation, ":agent", "anim_wedding_guest_woman"),
				(agent_set_animation, ":agent", "anim_wedding_guest_woman"),
				(store_random_in_range,":r",0,100),
			(try_end),
		(agent_set_animation_progress,":agent",":r"),
	(try_end),
   ]),



      (ti_tab_pressed, 0, 0, [],
       [(display_message, "@Can't leave now.")]),
    ]
  ),

    ("visit_olympia",0,-1,
    "visit olympia",
    [
      (0,mtef_scene_source,0,0,1,[]),
      (1,mtef_scene_source,0,0,1,[]),
      (2,mtef_visitor_source,af_override_horse,0,1,[]),
      (3,mtef_visitor_source,af_override_horse,0,1,[]),
      (4,mtef_visitor_source,af_override_horse,0,1,[]),
      (5,mtef_visitor_source,af_override_horse,0,1,[]),
      (6,mtef_visitor_source,af_override_horse,0,1,[]),
      (7,mtef_visitor_source,af_override_horse,0,1,[]),
      (8,mtef_visitor_source,af_override_horse,0,1,[]),
      (9,mtef_visitor_source,af_override_horse,0,1,[]),
      (10,mtef_visitor_source,af_override_horse,0,1,[]),
      (11,mtef_visitor_source,af_override_horse,0,1,[]),
      (12,mtef_visitor_source,af_override_horse,0,1,[]),
      (13,mtef_visitor_source,af_override_horse,0,1,[]),
      (14,mtef_visitor_source,af_override_horse,0,1,[]),
      (15,mtef_visitor_source,af_override_horse,0,1,[]),
      (16,mtef_visitor_source,af_override_horse,0,1,[]),
      (17,mtef_visitor_source,af_override_horse,0,1,[]),
      (18,mtef_visitor_source,af_override_horse,0,1,[]),
      (19,mtef_visitor_source,af_override_horse,0,1,[]),
      (20,mtef_visitor_source,af_override_horse,0,1,[]),
      (21,mtef_visitor_source,af_override_horse,0,1,[]),
      (22,mtef_visitor_source,af_override_horse,0,1,[]),
      (23,mtef_visitor_source,af_override_horse,0,1,[]),
      (24,mtef_visitor_source,af_override_horse,0,1,[]),
      (25,mtef_visitor_source,af_override_horse,0,1,[]),
      (26,mtef_visitor_source,af_override_horse,0,1,[]),
      (27,mtef_visitor_source,af_override_horse,0,1,[]),
      (28,mtef_visitor_source,af_override_horse,0,1,[]),
      (29,mtef_visitor_source,af_override_horse,0,1,[]),
      (30,mtef_visitor_source,af_override_horse,0,1,[]),
      (31,mtef_visitor_source,af_override_horse,0,1,[]),
      (32,mtef_visitor_source,af_override_horse,0,1,[]),
      (33,mtef_visitor_source,af_override_horse,0,1,[]),
      (34,mtef_visitor_source,af_override_horse,0,1,[]),
      (35,mtef_visitor_source,af_override_horse,0,1,[]),
      (36,mtef_visitor_source,af_override_horse,0,1,[]),
      (37,mtef_visitor_source,af_override_horse,0,1,[]),
      (38,mtef_visitor_source,af_override_horse,0,1,[]),
      (39,mtef_visitor_source,af_override_horse,0,1,[]),
      (40,mtef_scene_source,0,0,1,[]),
      (41,mtef_visitor_source,af_override_horse,0,1,[]),
      (42,mtef_visitor_source,af_override_horse,0,1,[]),
      (43,mtef_visitor_source,af_override_horse,0,1,[]),
      (44,mtef_visitor_source,af_override_horse,0,1,[]),
      (45,mtef_visitor_source,af_override_horse,0,1,[]),
      (46,mtef_visitor_source,af_override_horse,0,1,[]),
      (47,mtef_visitor_source,af_override_horse,0,1,[]),
      (48,mtef_visitor_source,af_override_horse,0,1,[]),
      (49,mtef_visitor_source,af_override_horse,0,1,[]),
      (50,mtef_visitor_source,af_override_horse,0,1,[]),
    ], p_wetter + storms + global_common_triggers +
    [
      can_spawn_commoners,
    improved_lightning,
  (ti_before_mission_start, 0, 0, [(troop_slot_eq, "trp_organiser", olympia_easter_egg, 0),],
   [(call_script, "script_remove_easter_eggs"),
     ]),
      common_inventory_not_available,

   (
	ti_on_agent_spawn,1,0,[
		(store_trigger_param_1,":agent"),
		(agent_get_troop_id,":troop",":agent"),
		(try_begin),
			(is_between,":troop",tavern_minstrels_begin,tavern_minstrels_end),
			(play_track,0,2),
			(try_begin),
				(agent_has_item_equipped,":agent","itm_lute"),
				(agent_set_stand_animation, ":agent", "anim_lute_standing"),
				(agent_set_animation, ":agent", "anim_lute_standing"),
				(agent_play_sound,":agent","snd_dedal_tavern_lute"),
			(else_try),
				(agent_has_item_equipped,":agent","itm_lyre"),
				(agent_set_stand_animation, ":agent", "anim_lyre_standing"),
				(agent_set_animation, ":agent", "anim_lyre_standing"),
                (agent_play_sound,":agent","snd_dedal_tavern_lyre"),
			(else_try),
				(agent_has_item_equipped,":agent","itm_flute"),
				(agent_set_stand_animation, ":agent", "anim_flute_player"),
				(agent_set_animation, ":agent", "anim_flute_player"),
				(agent_play_sound,":agent","snd_dedal_tavern_flute"),
			(try_end),
			(store_random_in_range,":r",0,300),
			(agent_set_animation_progress,":agent",":r"),
		(try_end),
	],[]),


      (ti_on_agent_spawn, 0, 0, [],
        [
          (store_trigger_param_1, ":agent_no"),
          (get_player_agent_no, ":player_agent"),

          (try_begin),
            (neq, ":player_agent", ":agent_no"),
            (agent_set_team, ":agent_no", 7),
          (try_end),
      ]),

    (0,0,ti_once, [],
    [
    (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_get_troop_id,":troop",":agent_no"),
        (neg|is_between, ":troop", tavern_minstrels_begin, tavern_minstrels_end),
        (call_script, "script_init_town_agent", ":agent_no"),
    (try_end),
    ]),

   ###chief walkers
       (1, 0, ti_once,
       [],
       [
           (call_script, "script_music_set_situation_with_culture", mtf_sit_town),

       ]),
      ambient_scene_play_loop,
      ambient_scene_play_random_sound,
      ambient_set_agents_for_sounds,
      ambient_agent_play_sound,
	  #chief walkers acaba

      (0,8,0,[],
        [
          (try_for_agents,":agent_no"),
            (agent_is_alive,":agent_no"),
            (agent_is_human,":agent_no"),
            (agent_get_troop_id, ":troop_no", ":agent_no"),
            (this_or_next|eq, ":troop_no", "trp_guest_female"),
            (eq, ":troop_no", "trp_guest"),

            (assign, ":continue_walk", 0),
            (store_random_in_range, ":continue_walk", 1, 100),
            (try_begin),
              (le, ":continue_walk", 38),
              (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
              (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
              (agent_set_animation, ":agent_no", "anim_stand_man"),
              (agent_set_animation_progress, ":agent_no", 10),

              (agent_get_position, pos1, ":agent_no"),
              (store_random_in_range, ":points", 4, 22),
              (entry_point_get_position, pos2, ":points"),
              (agent_set_speed_limit, ":agent_no", 1),
              (agent_set_scripted_destination, ":agent_no", pos2),
            (try_end),
          (try_end),
      ]),



      (ti_tab_pressed, 0, 0, [],
       [(stop_all_sounds, 1),(finish_mission,0)]),
    ]+ bodyguard_triggers,
  ),

("ship_battle",mtf_battle_mode,-1,"You close in and board the enemy ships",[
    (0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,2,[]),
    (1,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,2,[]),
    (2,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,2,[]),
    (3,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,2,[]),
    (4,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,2,[]),
    (5,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,2,[]),
    (6,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,2,[]),
    (7,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,2,[]),
    (8,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,2,[]),
    (9,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,2,[]),
    (10,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,2,[]),
    (11,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,2,[]),
    (12,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,2,[]),
    (13,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,2,[]),
    (14,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,2,[]),
    (15,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,2,[]),
    (16,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,2,[]),
    (17,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,2,[]),
    (18,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,2,[]),
    (19,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,2,[]),
  ],  p_wetter + storms + global_common_triggers + vc_water +
  [
    common_nobody_stalls,

    spawn_alexandria_lighthouse,

    cannot_spawn_commoners,
    improved_lightning,
    common_battle_init_banner,
    wounds_vc,
    common_battle_player_fallen_renown_lose,
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (get_player_agent_no, ":player_agent"),
      (neq, ":agent_no", ":player_agent"),
      (try_begin),
        (eq, "$enlisted_party", -1),
        (call_script, "script_agent_reassign_team", ":agent_no"),
      (else_try),
        (call_script, "script_agent_reassign_team_freelancer", ":agent_no"),
      (try_end),
    ]),
    (ti_before_mission_start, 0, 0, [],[
      (assign,"$g_battle_won",0),
      (assign,"$defender_reinforcement_stage",0),
      (assign,"$attacker_reinforcement_stage",0),
    ]),
    (0, 0, ti_once, [],[
      (call_script, "script_place_player_banner_near_inventory"),
      (call_script, "script_combat_music_set_situation_with_culture"),
      ##diplomacy begin
      (call_script, "script_init_death_cam"),
      # (assign, "$g_dplmc_charge_when_dead", 0),
      ##diplomacy end
    ]),
    common_music_situation_update,
    common_battle_check_friendly_kills,
    (1, 0, 5, [
      (lt,"$defender_reinforcement_stage","$defender_threshold"),
      (store_mission_timer_a,":mission_time"),
      (ge,":mission_time",10),
      (store_normalized_team_count,":num_defenders", 0),
      (lt,":num_defenders",6),
    ],[
      (add_reinforcements_to_entry,10,2),
      (add_reinforcements_to_entry,16,2),
      (add_reinforcements_to_entry,14,1),
      (val_add,"$defender_reinforcement_stage",1),
    ]),
    (1, 0, 5, [
      (lt,"$attacker_reinforcement_stage","$defender_threshold"),
      (store_mission_timer_a,":mission_time"),
      (ge,":mission_time",10),
      (store_normalized_team_count,":num_attackers", 1),
      (lt,":num_attackers",6),
    ],[
      (add_reinforcements_to_entry,0,1),
      (add_reinforcements_to_entry,5,2),
      (add_reinforcements_to_entry,8,2),
      (val_add,"$attacker_reinforcement_stage",1),
    ]),
    common_battle_check_victory_condition,
    common_battle_victory_display,
    common_battle_tab_press,
    (0, 1, ti_once, [],[
      (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_is_non_player, ":agent_no"),
        # (agent_get_team, ":agent_team", ":agent_no"),
        # (this_or_next|eq, ":agent_team", "$defender_team"),
        # (eq, ":agent_team", "$defender_team_2"),

        (agent_get_troop_id, ":troop", ":agent_no"),
        (store_character_level, ":level", ":troop"),
        (le, ":level", 30), #only for basic troops. Elite troops prefer use javelins only.
        (neg|troop_is_guarantee_horse, ":troop"),
        (neg|troop_is_guarantee_ranged, ":troop"),
        (store_random_in_range, ":r", 0, 100),
        (try_begin),
          (lt, ":r", 30),
          (agent_equip_item, ":agent_no", "itm_greek_fire"),
        (try_end),
      (try_end),
    ]),
	  (0, 0, 45, [
      (play_sound,"snd_schiff_liegt"),
    ],[]),
    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":elapsed_time"),
        (gt, ":elapsed_time", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission,0),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (party_clear, "p_routed_enemies"),
      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),
    ]),
    common_maritime_drowning,
    common_music_situation_update,
    common_battle_check_friendly_kills,
    common_battle_check_victory_condition,
    (1, 4,0,[
      (main_hero_fallen),
    ],[
      (try_begin),
        (call_script, "script_cf_dplmc_battle_continuation"),
      (else_try),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result,-1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),
      (try_end),
    ]),
    common_battle_inventory,
    common_battle_order_panel_tick,
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent_no"),
      # (store_trigger_param_2, ":killer_agent_no"),
      (store_trigger_param_3, ":is_wounded"),

      (try_begin),
        (ge, ":dead_agent_no", 0),
        (neg|agent_is_ally, ":dead_agent_no"),
        (agent_is_human, ":dead_agent_no"),
        (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),

        (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties

        (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),

        (try_begin),
          (call_script, "script_cf_force_wound_troop", ":dead_agent_troop_id"),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
          (set_trigger_result, 2),
        (else_try),
          (neg|troop_is_hero, ":dead_agent_troop_id"),
          (eq, "$g_realistic_wounding", 1),
          (le, ":last_damage", 10),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
          (set_trigger_result, 2),
        (else_try),
          (neg|troop_is_hero, ":dead_agent_troop_id"),
          (eq, "$g_realistic_wounding", 1),
          (ge, ":last_damage", 40),
          (set_trigger_result, 1),
        (else_try),
          (try_begin),
            (eq, ":is_wounded", 1),
            (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
          (try_end),
          (set_trigger_result, 0),
        (try_end),
      (try_end),

      (try_begin),
        (ge, ":dead_agent_no", 0),
        (agent_is_ally, ":dead_agent_no"),
        (agent_is_human, ":dead_agent_no"),
        (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),

        (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),

        (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),

        (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),

        (party_get_skill_level, ":surgery", "p_main_party", skl_surgery),
        (store_mul, ":chance", ":surgery", 4),
        (val_add, ":chance", 25),
        (store_random_in_range, ":rand", 0, 100),

        (try_begin),
          (call_script, "script_cf_force_wound_troop", ":dead_agent_troop_id"),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
          (set_trigger_result, 2),
        (else_try),
          (neg|troop_is_hero, ":dead_agent_troop_id"),
          (eq, "$g_realistic_wounding", 1),
          (le, ":last_damage", 10),
          (set_trigger_result, 2),
        (else_try),
          (neg|troop_is_hero, ":dead_agent_troop_id"),
          (eq, "$g_realistic_wounding", 1),
          (gt, ":rand", ":chance"),
          (ge, ":last_damage", 40),
          (set_trigger_result, 1),
        (else_try),
          (set_trigger_result, 0),
        (try_end),
      (try_end),
    ]),
] + theoris_decapitation + auxiliary_player + dplmc_battle_mode_triggers),

("visit_villa",mtf_battle_mode,-1,
  "visit your villa",[
    (0,mtef_scene_source,0,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,af_override_horse,0,1,[]),
    (14,mtef_visitor_source,af_override_horse,0,1,[]),
    (15,mtef_visitor_source,af_override_horse,0,1,[]),
    (16,mtef_visitor_source,af_castle_lord|af_override_gloves,0,1,[itm_dedal_kufel]),#guest1
    (17,mtef_visitor_source,af_castle_lord|af_override_gloves,0,1,[itm_dedal_kufel]),#guest2
    (18,mtef_visitor_source,af_castle_lord|af_override_gloves,0,1,[itm_dedal_kufel]),#guest3
    (19,mtef_visitor_source,af_castle_lord|af_override_gloves,0,1,[itm_dedal_kufel]),#guest4
    (20,mtef_visitor_source,af_castle_lord|af_override_gloves,0,1,[itm_dedal_kufel]),#guest5
    (21,mtef_scene_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
    (23,mtef_visitor_source,af_override_horse,0,1,[]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse,0,1,[]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source,af_override_horse,0,1,[]),
    (33,mtef_visitor_source,af_override_horse,0,1,[]),
    (34,mtef_visitor_source,af_override_horse,0,1,[]),
    (35,mtef_visitor_source,af_override_horse,0,1,[]),
    (36,mtef_scene_source,af_override_horse,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    (ti_on_agent_spawn,0,0,[
      (store_current_scene, ":scn"),
      (this_or_next|eq, ":scn", "scn_domus_mare_interior"),
      (eq, ":scn", "scn_domus_mare_interior_2"),
      (store_trigger_param_1, ":agent"),
      (agent_is_active, ":agent"),
      (agent_get_troop_id, ":troop", ":agent"),
      (this_or_next|eq, ":troop", "trp_guest"),
      (eq, ":troop", "trp_guest_female"),
      (agent_is_non_player, ":agent"),
      (agent_set_no_dynamics, ":agent", 1),
      (agent_set_stand_animation, ":agent", "anim_female_lie_sexy"),
      (agent_set_animation, ":agent", "anim_female_lie_sexy"),
      (store_random_in_range,":r",0,300),
      (agent_set_animation_progress,":agent",":r"),

      (set_fixed_point_multiplier, 1),
      (agent_get_position, pos1, ":agent"),
      (agent_set_no_dynamics, ":agent", 1),
      (position_move_z, pos1, -100),
      (agent_set_position, ":agent", pos1),
    ],[]),

    can_spawn_commoners,
    improved_lightning,
    common_inventory_not_available,
    dedal_tavern_animations,

    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (get_player_agent_no, ":player_agent"),
      (try_begin),
        (neq, ":player_agent", ":agent_no"),
        (agent_set_team, ":agent_no", 7),
      (try_end),
    ]),
    (1, 0, ti_once,[],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
      (mission_enable_talk),
    ]),

    ambient_scene_play_loop,
    ambient_scene_play_random_sound,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,

    (0,8,0,[],[
      (try_for_agents,":agent_no"),
        (agent_is_alive,":agent_no"),
        (agent_is_human,":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (this_or_next|is_between, ":troop_no", slaves_begin, slaves_end),
        (is_between, ":troop_no", household_slaves_begin, cook_slaves_end),

        (assign, ":continue_walk", 0),
        (store_random_in_range, ":continue_walk", 1, 100),
        (try_begin),
          (le, ":continue_walk", 38),
          (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
          (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
          (agent_set_animation, ":agent_no", "anim_stand_man"),
          (agent_set_animation_progress, ":agent_no", 10),

          (agent_get_position, pos1, ":agent_no"),
          (store_random_in_range, ":points", 1, 11),
          (entry_point_get_position, pos2, ":points"),
          (agent_set_speed_limit, ":agent_no", 1),
          (agent_set_scripted_destination, ":agent_no", pos2),
        (try_end),
      (try_end),
    ]),
    # (ti_on_agent_spawn,1,0,[
    #   (troop_slot_eq, "trp_array_villa_feast", 9, 0),
    #   (store_trigger_param_1,":agent"),
    #   (agent_get_troop_id,":troop",":agent"),
    #   (try_begin),
    #     (this_or_next|eq,":troop", "trp_guest"),
    #     (this_or_next|is_between,":troop", active_npcs_begin, kingdom_ladies_end),
    #     (eq,":troop", "trp_guest_female"),
    #     (try_begin),
    #       (agent_has_item_equipped,":agent","itm_dedal_kufel"),
    #       (agent_set_stand_animation, ":agent", "anim_sitting_drinking_low"),
    #       (agent_set_animation, ":agent", "anim_sitting_drinking_low"),
    #       (store_random_in_range,":r",0,300),
    #     (else_try),
    #       (agent_set_stand_animation, ":agent", "anim_sitting_low"),
    #       (agent_set_animation, ":agent", "anim_sitting_low"),
    #       (store_random_in_range,":r",0,300),
    #     (try_end),
    #     (agent_set_animation_progress,":agent",":r"),
    #   (try_end),
    # ],[]),
    (ti_tab_pressed, 0, 0, [
      (troop_slot_eq, "trp_array_villa_feast", 9, 0),
    ],[
      (question_box,"@Do you want to conclude the feast?"),
    ]),
    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (jump_to_menu, "mnu_villa"),
      (stop_all_sounds, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
      (mission_disable_talk),
      (finish_mission, 3),
      (try_for_range, ":guest", 0, 11),
          (troop_set_slot, "trp_array_villa_feast", ":guest", -1),
      (try_end),
      (display_message, "@The feast concludes", message_alert),
    ]),
    (ti_tab_pressed, 0, 0, [
      (neg|troop_slot_eq, "trp_array_villa_feast", 9, 0),
    ],[
      (stop_all_sounds, 1),
      (finish_mission, 3),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
      (mission_disable_talk),
    ]),
  ] + bodyguard_triggers,
),

("horde",0,-1,
  "visit a hord",[
    (0,mtef_scene_source,0,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    improved_lightning,
    can_spawn_commoners,
    common_inventory_not_available,

   ###chief walkers
       (1, 0, ti_once,
       [],
       [
           (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
       ]),
      ambient_scene_play_loop,
      ambient_scene_play_random_sound,
      ambient_set_agents_for_sounds,
      ambient_agent_play_sound,
	  #chief walkers acaba

      (0,8,0,[],
        [
          (try_for_agents,":agent_no"),
            (agent_is_alive,":agent_no"),
            (agent_is_human,":agent_no"),
            (agent_get_troop_id, ":troop_no", ":agent_no"),
            (this_or_next|eq, ":troop_no", "trp_sarmatian_village_walker_female"),
            (this_or_next|eq, ":troop_no", "trp_sarmatian_light_horseman"),
            (eq, ":troop_no", "trp_sarmatian_light_horsearcher"),

            (assign, ":continue_walk", 0),
            (store_random_in_range, ":continue_walk", 1, 100),
            (try_begin),
              (le, ":continue_walk", 38),
              (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
              (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
              (agent_set_animation, ":agent_no", "anim_stand_man"),
              (agent_set_animation_progress, ":agent_no", 10),

              (agent_get_position, pos1, ":agent_no"),
              (store_random_in_range, ":points", 1, 13),
              (entry_point_get_position, pos2, ":points"),
              (agent_set_speed_limit, ":agent_no", 1),
              (agent_set_scripted_destination, ":agent_no", pos2),
            (try_end),
          (try_end),
      ]),

      (ti_tab_pressed, 0, 0, [],
       [(stop_all_sounds, 1),(finish_mission,0)]),
    ] + bodyguard_triggers,
  ),

  ("visit_scriptorium",0,-1,
    "plundering a settlement",
    [
      (0,mtef_visitor_source,af_override_horse,0,1,[]),
      (1,mtef_visitor_source,af_override_horse,0,1,[]),
      (2,mtef_visitor_source,af_override_horse,0,1,[]),
	  (3,mtef_visitor_source,af_override_horse,0,1,[]),
      (4,mtef_visitor_source,af_override_horse,0,1,[]),
      (5,mtef_visitor_source,af_override_horse,0,1,[]),
      (6,mtef_visitor_source,af_override_horse,0,1,[]),
      (7,mtef_visitor_source,af_override_horse,0,1,[]),
      (8,mtef_visitor_source,af_override_horse,0,1,[]),
      (9,mtef_visitor_source,af_override_horse,0,1,[]),
      (10,mtef_visitor_source,af_override_horse,0,1,[]),
      (11,mtef_visitor_source,af_override_horse,0,1,[]),
      (12,mtef_visitor_source,af_override_horse,0,1,[]),
      (13,mtef_visitor_source,af_override_horse,0,1,[]),
      (14,mtef_visitor_source,af_override_horse,0,1,[]),
      (15,mtef_visitor_source,af_override_horse,0,1,[]),

    ],  p_wetter + global_common_triggers +
    [
      can_spawn_commoners,
 common_inventory_not_available,
##(add_visitors_to_current_scene, <entry_no>, <troop_id>, <number_of_troops>, <team_no>, <group_no>),
  (4,1,ti_once,[],
  [
	# (try_begin),
		# (party_slot_eq, "$current_town", slot_party_type, spt_town),
		# (lt, ":rand", 30),
		# (party_get_slot, ":guildmaster", "$current_town", slot_town_elder),
		# (assign, ":spawn_troop", ":guildmaster"),
	# (try_end),
  (add_visitors_to_current_scene, 6, "trp_slave", 1, 1, 0),
  ]
  ),
      (0,8,0,[],
        [
          (try_for_agents,":agent_no"),
            (agent_is_alive,":agent_no"),
            (agent_is_human,":agent_no"),
            (agent_get_troop_id, ":troop_no", ":agent_no"),
            (this_or_next|eq, ":troop_no", "trp_slave"),
            (is_between, ":troop_no", mayors_begin,mayors_end),

            (assign, ":continue_walk", 0),
            (store_random_in_range, ":continue_walk", 1, 100),
            (try_begin),
              (le, ":continue_walk", 38),
              (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
              (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
              (agent_set_animation, ":agent_no", "anim_stand_man"),
              (agent_set_animation_progress, ":agent_no", 10),

              (agent_get_position, pos1, ":agent_no"),
              (store_random_in_range, ":points", 1, 13),
              (entry_point_get_position, pos2, ":points"),
              (agent_set_speed_limit, ":agent_no", 1),
              (agent_set_scripted_destination, ":agent_no", pos2),
            (try_end),
          (try_end),
      ]),

  (0, 0, 0, [],
   [
    (call_script, "script_music_set_situation_with_culture", mtf_sit_feast),
	(mission_enable_talk),
   ]),

      (1, 0, ti_once,
      [],
      [
        (try_begin),
          (eq, "$g_mt_mode", tcm_default),
          (store_current_scene, ":cur_scene"),
          (scene_set_slot, ":cur_scene", slot_scene_visited, 1),
        (try_end),
      ]),


    (0,0,ti_once, [],
    [
    (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (call_script, "script_init_town_agent", ":agent_no"),
    (try_end),
    ]),
      (ti_tab_pressed, 0, 0, [],
       [

       (stop_all_sounds, 1),

       (finish_mission,0)]),
    ]
  ),

("triumph",0,-1,
  "Memento mori. Respice post te. Hominem te esse memento.",[
    (0,mtef_scene_source,af_override_everything,0,1,[itm_caligea, itm_laurel_gold, itm_roman_rich_emperor_2]),#player
    (1,mtef_visitor_source,af_override_horse,0,1,[]),#guard
    (2,mtef_visitor_source,af_override_horse,0,1,[]),#guard
	  (3,mtef_visitor_source,af_override_horse,0,1,[]),#legatus
    (4,mtef_visitor_source,af_override_horse,0,1,[]),#legatus

    (5,mtef_visitor_source,af_override_horse,0,1,[]),#unused
    (6,mtef_visitor_source,af_override_horse,0,1,[]),#unused
    (7,mtef_visitor_source,af_override_horse,0,1,[]),#unused
		#spectators begin
		#69 bis 73 sind mindestens 5 pro spawn
    (8,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (9,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (10,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (11,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (12,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (13,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (14,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (15,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (16,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (17,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (18,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (19,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (20,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (21,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (22,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (23,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (24,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (25,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (26,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (27,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (28,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (29,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (30,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (31,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (32,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (33,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (34,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (35,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (36,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (37,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (38,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (39,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (40,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (41,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (42,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (43,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (44,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (45,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (46,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (47,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (48,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (49,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (50,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (51,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (52,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (53,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (54,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (55,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (56,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (57,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (58,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (59,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (60,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (61,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (62,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (63,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (64,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (65,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (66,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (67,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (68,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (69,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (70,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (71,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (72,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (73,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (74,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (75,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (76,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (77,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (78,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (79,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (80,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (81,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (82,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (83,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (84,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (85,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (86,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (87,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (88,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (89,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (90,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (91,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (92,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (93,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (94,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (95,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (96,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (97,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (98,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (99,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (100,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (101,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (102,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (103,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (104,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (105,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (106,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (107,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (108,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (109,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (110,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (111,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (112,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (113,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (114,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (115,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (116,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (117,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (118,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (119,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (120,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (121,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (122,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (123,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (124,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (125,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (126,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (127,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
  ], global_common_triggers +
  [
    (ti_before_mission_start, 0, 0, [],[
      (scene_set_day_time, 12),
    ]),

    cannot_spawn_commoners,
    improved_lightning,
		(1,0,0,[],[
      (val_add, reg50, 1),
      (try_begin),
        (eq, reg50, 95),
        #(start_presentation, "prsnt_screen_out"),
        (jump_to_menu, "$g_next_menu"),
        (finish_mission),
      (try_end),
		]),
    (ti_after_mission_start, 0, ti_once, [],[
      (start_presentation, "prsnt_screen_write2"),
    ]),

    (0,0,0,[],[
      (entry_point_get_position, pos0, 122),
      (try_for_agents,":cur_agent"),
          (agent_get_position, pos1, ":cur_agent"),
          (get_distance_between_positions, ":dist", pos0, pos1),
          (le, ":dist", 400),
          (agent_fade_out, ":cur_agent"),
          #(display_message, "@agent leaves scene"),
      (try_end),
	  ]),

	  ##spanw troops
    (0, 0, ti_once,[
    ],[
		  (assign, reg50,0),##primitive zeitmessung
      #spawn a standard bearer and ranks of soldiers
      (set_fixed_point_multiplier, 100),
      (init_position, pos1),
		  (entry_point_get_position, pos1, 123),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_aux_archer_praetoriana"),
      (try_for_range, ":unused", 0, 30), #ranks
          (set_spawn_position, pos1),
          (spawn_agent, "trp_aux_archer_praetoriana"),
          (position_move_x, pos1, -160), #1.5m between columns
      (try_end),
    ]),

    ##spawn triumph marsh
    ###praetoriani
    (1, 0, 0,[
      (eq, reg50, 9),
    ],[
      #spawn a standard bearer and ranks of soldiers
      (set_fixed_point_multiplier, 100),
      (init_position, pos1),

      (entry_point_get_position, pos1, 121),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_legatus_legionis"),

      (agent_set_speed_modifier,reg0, 500),
      (agent_set_horse_speed_factor, reg0, 500),
      (agent_set_speed_limit, reg0, 9),

      (position_move_x, pos1, -225), #1.5x column width
      (position_move_y, pos1, -200), # bearer ahead of troops
      (try_for_range, ":unused", 0, 20), #ranks
        (try_for_range, ":unused2", 0, 4), #columns
          (set_spawn_position, pos1),
          (try_begin),
            (eq, ":unused", 0),
            (try_begin),
              (eq, ":unused2", 0),
              (spawn_agent, "trp_centurio_preatoriani"),
              (agent_set_speed_modifier,reg0, 500),
              (agent_set_horse_speed_factor, reg0, 500),
              (agent_set_speed_limit, reg0, 3),


            (else_try),
              (eq, ":unused2", 1),
              (spawn_agent, "trp_vexilarius_praetoriani"),

              (agent_set_speed_modifier,reg0, 500),
              (agent_set_horse_speed_factor, reg0, 500),
              (agent_set_speed_limit, reg0, 3),
            (else_try),
              (eq, ":unused2", 2),
              (spawn_agent, "trp_aquilifer_praetoriani"),

              (agent_set_speed_modifier,reg0, 500),
              (agent_set_horse_speed_factor, reg0, 500),
              (agent_set_speed_limit, reg0, 3),
            (else_try),
              (eq, ":unused2", 3),
              (spawn_agent, "trp_signifer"),

              (agent_set_speed_modifier,reg0, 500),
              (agent_set_horse_speed_factor, reg0, 500),
              (agent_set_speed_limit, reg0, 3),
            (try_end),
          (else_try),
            # (troop_remove_item, "trp_praetoriani_milites","itm_pilum"),
            # (troop_remove_item, "trp_praetoriani_milites","itm_pilum"),
            (spawn_agent, "trp_praetoriani_milites"),

            (agent_set_speed_modifier,reg0, 500),
            (agent_set_horse_speed_factor, reg0, 500),
            (agent_set_speed_limit, reg0, 3),
          (try_end),
          (position_move_x, pos1, 150), #1.5m between columns
        (try_end),
        # get back to first column of previous rank
        (position_move_x, pos1, -600), #4x1.5m
        (position_move_y, pos1, -150), #next rank 1.5m behind
      (try_end),
      # (troop_add_item, "trp_praetoriani_milites","itm_pilum"),
      # (troop_add_item, "trp_praetoriani_milites","itm_pilum"),
    ]),
    (1,0,0,[
    (eq, reg50, 10),
    #(key_is_down,key_k),
    ],[
      # march the troops down the bridge
      (try_for_agents, ":agent_no"), # find everyone and march them off
        (agent_get_troop_id, ":agent_troop", ":agent_no"),
        (this_or_next|eq, ":agent_troop", "trp_signifer"),
        (this_or_next|eq, ":agent_troop", "trp_legatus_legionis"),
        (this_or_next|eq, ":agent_troop", "trp_aquilifer_praetoriani"),
        (this_or_next|eq, ":agent_troop", "trp_vexilarius_praetoriani"),
        (this_or_next|eq, ":agent_troop", "trp_centurio_preatoriani"),
        (eq, ":agent_troop", "trp_praetoriani_milites"),
        (agent_get_position, pos1, ":agent_no"),
        (position_move_x, pos1, -105), # correction for angle numerical loss
        (position_move_y, pos1, 26000),
        (agent_set_scripted_destination, ":agent_no", pos1, 1),
      (try_end),
    ]),
    ##spawn triumph marsh
    ##auxilia
    (0, 31, ti_once,[
    ],[
      #spawn a standard bearer and ranks of soldiers
      (set_fixed_point_multiplier, 100),
      (init_position, pos1),

      (entry_point_get_position, pos1, 121),

      (set_spawn_position, pos1),
      (spawn_agent, "trp_aux_centurio"), #has to be in a condition block, or it will crash
      #(set_fixed_point_multiplier, 1),
      (agent_set_speed_modifier,reg0, 500),
      (agent_set_horse_speed_factor, reg0, 500),
      (agent_set_speed_limit, reg0, 3),
      (position_move_x, pos1, -225), #1.5x column width
      (position_move_y, pos1, -200), # bearer ahead of troops
      (try_for_range, ":unused", 0, 20), #ranks
        (try_for_range, ":unused2", 0, 4), #columns
          (set_spawn_position, pos1),
          (try_begin),
            (eq, ":unused", 0),
            (try_begin),
              (eq, ":unused2", 0),
              (spawn_agent, "trp_aux_signifer"),

              (agent_set_speed_modifier,reg0, 500),
              (agent_set_horse_speed_factor, reg0, 500),
              (agent_set_speed_limit, reg0, 3),
            (else_try),
              (eq, ":unused2", 1),
              (spawn_agent, "trp_aux_inf_batavorum"),
              (agent_set_speed_modifier,reg0, 500),
              (agent_set_horse_speed_factor, reg0, 500),
              (agent_set_speed_limit, reg0, 3),
            (else_try),
              (eq, ":unused2", 2),
              (spawn_agent, "trp_aux_inf_batavorum"),
              (agent_set_speed_modifier,reg0, 500),
              (agent_set_horse_speed_factor, reg0, 500),
              (agent_set_speed_limit, reg0, 3),
            (else_try),
              (eq, ":unused2", 3),
              (spawn_agent, "trp_aux_inf_batavorum"),
              (agent_set_speed_modifier,reg0, 500),
              (agent_set_horse_speed_factor, reg0, 500),
              (agent_set_speed_limit, reg0, 3),
            (try_end),
          (else_try),
            (spawn_agent, "trp_aux_inf_tungrorum"),
            (agent_set_speed_modifier,reg0, 500),
            (agent_set_horse_speed_factor, reg0, 500),
            (agent_set_speed_limit, reg0, 3),
          (try_end),
          (position_move_x, pos1, 150), #1.5m between columns
        (try_end),
        # get back to first column of previous rank
        (position_move_x, pos1, -600), #4x1.5m
        (position_move_y, pos1, -150), #next rank 1.5m behind
      (try_end),
      # march the troops down the bridge
      (try_for_agents, ":agent_no"), # find everyone and march them off
        (agent_get_troop_id, ":agent_troop", ":agent_no"),
        (this_or_next|eq, ":agent_troop", "trp_aux_centurio"),
        (this_or_next|eq, ":agent_troop", "trp_aux_signifer"),
        (this_or_next|eq, ":agent_troop", "trp_aux_inf_batavorum"),
        (eq, ":agent_troop", "trp_aux_inf_tungrorum"),
        (agent_get_position, pos1, ":agent_no"),
        (position_move_x, pos1, -105), # correction for angle numerical loss
        (position_move_y, pos1, 30000),
        (agent_set_scripted_destination, ":agent_no", pos1, 1),
      (try_end),
    ]),

    (0, 55, ti_once,[
    ],[
      #spawn a standard bearer and ranks of soldiers
      (set_fixed_point_multiplier, 100),
      (init_position, pos1),
		  (entry_point_get_position, pos1, 121),
      (set_spawn_position, pos1),
      #(spawn_agent, "trp_aux_centurio"), #has to be in a condition block, or it will crash
      #(set_fixed_point_multiplier, 1),
      #(agent_set_speed_modifier,reg0, 500),
      #(agent_set_horse_speed_factor, reg0, 500),
      #(agent_set_speed_limit, reg0, 3),
      (position_move_x, pos1, -225), #1.5x column width
      (position_move_y, pos1, -200), # bearer ahead of troops
      (try_for_range, ":unused", 0, 20), #ranks
        (try_for_range, ":unused2", 0, 4), #columns
          (set_spawn_position, pos1),
          (try_begin),
            (eq, ":unused", 0),
            (try_begin),
              (eq, ":unused2", 0),
              (spawn_agent, "trp_aux_archer_sryrorum"),
              (agent_set_speed_modifier,reg0, 500),
              (agent_set_horse_speed_factor, reg0, 500),
              (agent_set_speed_limit, reg0, 3),
            (else_try),
              (eq, ":unused2", 1),
              (spawn_agent, "trp_aux_archer_sryrorum"),
              (agent_set_speed_modifier,reg0, 500),
              (agent_set_horse_speed_factor, reg0, 500),
              (agent_set_speed_limit, reg0, 3),
            (else_try),
              (eq, ":unused2", 2),
              (spawn_agent, "trp_aux_archer_sryrorum"),
              (agent_set_speed_modifier,reg0, 500),
              (agent_set_horse_speed_factor, reg0, 500),
              (agent_set_speed_limit, reg0, 3),
            (else_try),
              (eq, ":unused2", 3),
              (spawn_agent, "trp_aux_archer_sryrorum"),
              (agent_set_speed_modifier,reg0, 500),
              (agent_set_horse_speed_factor, reg0, 500),
              (agent_set_speed_limit, reg0, 3),
            (try_end),
          (else_try),
            (spawn_agent, "trp_aux_archer"),
            (agent_set_speed_modifier,reg0, 500),
            (agent_set_horse_speed_factor, reg0, 500),
            (agent_set_speed_limit, reg0, 3),
			    (try_end),
          (position_move_x, pos1, 150), #1.5m between columns
        (try_end),
        # get back to first column of previous rank
        (position_move_x, pos1, -600), #4x1.5m
        (position_move_y, pos1, -150), #next rank 1.5m behind
      (try_end),
      # march the troops down the bridge
      (try_for_agents, ":agent_no"), # find everyone and march them off
        (agent_get_troop_id, ":agent_troop", ":agent_no"),
        (this_or_next|eq, ":agent_troop", "trp_aux_archer_sryrorum"),
        (eq, ":agent_troop", "trp_aux_archer"),
        (agent_get_position, pos1, ":agent_no"),
        (position_move_x, pos1, -105), # correction for angle numerical loss
        (position_move_y, pos1, 30000),
        (agent_set_scripted_destination, ":agent_no", pos1, 1),
      (try_end),
    ]),
    (ti_tab_pressed, 0, 0, [],[
      (display_message, "@You cann't leave now!")
    ]),
    (1, 0, ti_once,[],[
      (mission_disable_talk),
      (play_sound, "snd_arena_ambiance", sf_looping),
    ]),
    (ti_on_agent_spawn,1,0, [],[
      (try_for_agents, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_human, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
          (try_begin),
            (eq, ":troop", "trp_guest"),
            (agent_set_stand_animation, ":agent", "anim_wedding_guest"),
            (agent_set_animation, ":agent", "anim_wedding_guest"),
            (store_random_in_range,":r",0,100),
          (else_try),
            (eq, ":troop", "trp_guest_female"),
            (agent_set_stand_animation, ":agent", "anim_wedding_guest_woman"),
            (agent_set_animation, ":agent", "anim_wedding_guest_woman"),
            (store_random_in_range,":r",0,100),
          (else_try),
            (eq, ":troop", "trp_slave"),
            (agent_set_stand_animation, ":agent", "anim_cheer_loop"),
            (agent_set_animation, ":agent", "anim_cheer_loop"),
            (store_random_in_range,":r",0,100),
          (else_try),
            (eq, ":troop", "trp_slave_female"),
            (agent_set_stand_animation, ":agent", "anim_cheer_loop"),
            (agent_set_animation, ":agent", "anim_cheer_loop"),
            (store_random_in_range,":r",0,100),
          (try_end),
        (agent_set_animation_progress,":agent",":r"),
      (try_end),
    ]),

    (8, 0, 0, [
      (try_for_agents, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_troop_id, ":id", ":agent_no"),
      #(display_message, "@Launch trigger."),
      (try_begin),
          (eq, ":id", "trp_cornicen"),
          (try_begin),
            (agent_has_item_equipped, ":agent_no", "itm_f_cornu"),
          (else_try),
            (agent_equip_item, ":agent_no", "itm_f_cornu"),
          (try_end),
          (agent_set_wielded_item, ":agent_no", "itm_f_cornu"),
          (agent_set_animation, ":agent_no", "anim_cornu_play", 1),
          (agent_play_sound, ":agent_no", "snd_cornu"),
        (try_end),
      (try_end),
    ],[]),
    common_inventory_not_available,
]),

("ceremony_pharaoh",0,-1,
    "plundering a settlement",
    [
      (0,mtef_scene_source,af_override_horse,0,1,[]),
      (1,mtef_visitor_source,af_override_horse,0,1,[]),#guard
      (2,mtef_visitor_source,af_override_horse,0,1,[]),#guard
	    (3,mtef_visitor_source,af_override_horse,0,1,[]),#legatus
      (4,mtef_visitor_source,af_override_horse,0,1,[]),#legatus

      (5,mtef_visitor_source,af_override_horse,0,1,[]),#unused
      (6,mtef_visitor_source,af_override_horse,0,1,[]),#unused
      (7,mtef_visitor_source,af_override_horse,0,1,[]),#unused
		#spectators begin
		#69 bis 73 sind mindestens 5 pro spawn
      (8,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (9,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (10,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (11,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (12,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (13,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (14,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (15,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (16,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (17,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (18,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (19,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (20,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (21,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (22,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (23,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (24,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (25,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (26,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (27,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (28,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (29,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (30,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (31,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (32,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (33,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (34,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (35,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (36,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (37,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (38,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (39,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (40,mtef_visitor_source,af_override_everything,0,1,[itm_female_caligea_gold,itm_pharaoh_crown,itm_roman_rich3]),#player
      (41,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (42,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (43,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (44,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (45,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (46,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (47,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (48,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (49,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (50,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (51,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (52,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (53,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (54,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (55,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (56,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (57,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (58,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (59,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
      (60,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    ],p_wetter + global_common_triggers +
    [
      cannot_spawn_commoners,
      improved_lightning,
      (ti_before_mission_start, 0, 0, [],[
        (scene_set_day_time, 12),
        (call_script, "script_change_banners_and_chest"),
      ]),

		(1,0,0,[],[(val_add, reg50, 1),
		(try_begin),
			(eq, reg50, 80),
			(jump_to_menu, "$g_next_menu"),
			(finish_mission),
		(try_end),
		]),
# screen write
		  (ti_after_mission_start, 0, ti_once, [],
		  [(start_presentation, "prsnt_screen_write2"),]),
	##spanw troops
      (0, 0, ti_once,
       [
       ],[
		(assign, reg50,0),##primitive zeitmessung

        #spawn a standard bearer and ranks of soldiers
        (set_fixed_point_multiplier, 100),
        (init_position, pos1),
        (entry_point_get_position, pos1, 43),

        (set_spawn_position, pos1),
        (spawn_agent, "trp_praetoriani_milites_exp"),
        (try_for_range, ":unused", 0, 10), #ranks
          (set_spawn_position, pos1),
          (spawn_agent, "trp_praetoriani_milites_exp"),
          (position_move_x, pos1, -150), #1.5m between columns
        (try_end),
	   ]),

	(ti_tab_pressed, 0, 0, [],
       [(display_message, "@You cann't leave now!")]),

      (1, 0, ti_once,
      [],
      [

		 (mission_disable_talk),
		 (play_sound, "snd_arena_ambiance", sf_looping),
      ]),

  (ti_on_agent_spawn,1,0, [],
   [
	(try_for_agents, ":agent"),
		(agent_is_alive, ":agent"),
		(agent_is_human, ":agent"),
		(agent_get_troop_id, ":troop", ":agent"),
			(try_begin),
				(eq, ":troop", "trp_guest"),
				(agent_set_stand_animation, ":agent", "anim_wedding_guest"),
				(agent_set_animation, ":agent", "anim_wedding_guest"),
				(store_random_in_range,":r",0,100),
			(else_try),
				(eq, ":troop", "trp_guest_female"),
				(agent_set_stand_animation, ":agent", "anim_wedding_guest_woman"),
				(agent_set_animation, ":agent", "anim_wedding_guest_woman"),
				(store_random_in_range,":r",0,100),
			(else_try),
				(eq, ":troop", "trp_slave"),
				(agent_set_stand_animation, ":agent", "anim_cheer_loop"),
				(agent_set_animation, ":agent", "anim_cheer_loop"),
				(store_random_in_range,":r",0,100),
			(else_try),
				(eq, ":troop", "trp_slave_female"),
				(agent_set_stand_animation, ":agent", "anim_cheer_loop"),
				(agent_set_animation, ":agent", "anim_cheer_loop"),
				(store_random_in_range,":r",0,100),
			(try_end),
		(agent_set_animation_progress,":agent",":r"),
	(try_end),
   ]),
 common_inventory_not_available,

       (0, 0, ti_once,
       [
           (ge, reg50, 20),
           (set_fixed_point_multiplier, 1),
           (init_position, pos1),
           (entry_point_get_position, pos1, 60),
           (particle_system_burst, "psys_wedding_rose", pos1, 1200),

           (entry_point_get_position, pos1, 61),
           (particle_system_burst, "psys_wedding_rose", pos1, 1200),

           (entry_point_get_position, pos1, 62),
           (particle_system_burst, "psys_wedding_rose", pos1, 1200),
         ],[]),


      (0,0,0,[
        ],
        [
          (try_begin),
            (eq, reg50, 15),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@Praise, oh gods, our new Pharaoh! After a time of disorientation, Egypt has a divine father again, to whom it can cling!"),
          (else_try),
            (eq, reg50, 25),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@Today we praise his name, honor him and make sacrifices! May he bless us, may he gift us wealth, may he protect us from our enemies and may he defend our ancient rights! He will guard us in times of need and will lead us in imes of war! Praised be his name forever!"),
          (else_try),
            (eq, reg50, 40),
            (tutorial_message, -1),
          (try_end),
      ]),


    (0, 0, 1,
    [],
    [
      (get_player_agent_no, ":player"),

      (try_for_agents, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_active, ":agent"),
        (neq, ":agent", ":player"),
        (agent_get_troop_id, ":troop_id", ":agent"),
        (neg|is_between, ":troop_id", "trp_legio_xxii_primigenia", "trp_looter"),
        (agent_set_look_target_agent, ":agent", ":player"),
      (try_end),
    ]),

    ],
  ),

("visit_desert_town",0,-1,"plundering a settlement",[
    (0,mtef_scene_source|mtef_team_0,0,0,1,[]),#player
    (1,mtef_visitor_source,af_override_horse,0,1,[]),#guard
    (2,mtef_visitor_source,af_override_horse,0,1,[]),#guard
    (3,mtef_visitor_source,af_override_horse,0,1,[]),#legatus
    (4,mtef_visitor_source,af_override_horse,0,1,[]),#legatus

    (5,mtef_visitor_source,af_override_horse,0,1,[]),#unused
    (6,mtef_visitor_source,af_override_horse,0,1,[]),#unused
    (7,mtef_visitor_source,af_override_horse,0,1,[]),#unused
    #spectators begin
    #69 bis 73 sind mindestens 5 pro spawn
    (8,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (9,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (10,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (11,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (12,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (13,mtef_visitor_source,af_override_horse|af_override_gloves|af_override_weapons,0,1,[]),#spectators
    (14,mtef_visitor_source,af_override_horse|af_override_gloves|af_override_weapons,0,1,[]),#spectators
    (15,mtef_visitor_source,af_override_horse|af_override_gloves|af_override_weapons,0,1,[]),#spectators
    (16,mtef_visitor_source,af_override_horse|af_override_gloves|af_override_weapons,0,1,[]),#spectators
    (17,mtef_visitor_source,af_override_horse|af_override_gloves|af_override_weapons,0,1,[]),#spectators
    (18,mtef_visitor_source,af_override_horse|af_override_gloves|af_override_weapons,0,1,[]),#spectators
    (19,mtef_visitor_source,af_override_horse|af_override_gloves|af_override_weapons,0,1,[]),#spectators
    (20,mtef_visitor_source,af_override_horse|af_override_gloves|af_override_weapons,0,1,[]),#spectators
    (21,mtef_visitor_source,af_override_horse|af_override_gloves|af_override_weapons,0,1,[]),#spectators
    (22,mtef_visitor_source,af_override_horse|af_override_gloves|af_override_weapons,0,1,[]),#spectators
    (23,mtef_visitor_source,af_override_horse|af_override_gloves|af_override_weapons,0,1,[]),#spectators
    (24,mtef_visitor_source,af_override_horse|af_override_gloves|af_override_weapons,0,1,[]),#spectators
    (25,mtef_visitor_source,af_override_horse|af_override_gloves|af_override_weapons,0,1,[]),#spectators
    (26,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (27,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (28,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (29,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (30,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (31,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (32,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (33,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (34,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (35,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (36,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (37,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (38,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (39,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (40,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (41,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (42,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (43,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (44,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (45,mtef_visitor_source,af_override_horse|af_override_weapons,0,1,[]),#spectators
    (46,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (47,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (48,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (49,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (50,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (51,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (52,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (53,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (54,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (55,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (56,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (57,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (58,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (59,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (60,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
  ], p_wetter + storms + global_common_triggers +
  [
    can_spawn_commoners,
    improved_lightning,
    (ti_before_mission_start, 0, 0, [],[
      (assign, "$g_main_attacker_agent", 0),
    ]),
    common_inventory_not_available,

    (3, 0, 0,[
      (eq, "$talk_context", tc_escape),
      (neg|main_hero_fallen,0),
      (store_mission_timer_a, ":time"),
      (ge, ":time", 10),
      (all_enemies_defeated, 1), #1 is default enemy team for in-town battles
    ],[
      (call_script, "script_deduct_casualties_from_garrison"),
      (jump_to_menu,"mnu_desert_victory"),

      (mission_enable_talk),
      (finish_mission,0)
    ]),
    (3, 0, 0,[
      (eq, "$talk_context", tc_escape),
      (main_hero_fallen,0),
      (store_mission_timer_a, ":time"),
      (ge, ":time", 10),
    ],[
      (assign, "$temp", 1),
      (jump_to_menu,"mnu_death_waits"),
      (mission_enable_talk),
      (finish_mission,0)
    ]),
    (0,0,ti_once,[
      (try_for_agents, ":agent"),
        (agent_get_entry_no, ":entry", ":agent"),
        (try_begin),
          (is_between, ":entry", 13,26),
          (try_begin),
            (agent_has_item_equipped,":agent","itm_dedal_kufel"),
            (agent_set_stand_animation, ":agent", "anim_sitting_drinking_low"),
            (agent_set_animation, ":agent", "anim_sitting_drinking_low"),
            (store_random_in_range,":r",0,300),
          (else_try),
            (agent_set_stand_animation, ":agent", "anim_sitting_low"),
            (agent_set_animation, ":agent", "anim_sitting_low"),
            (store_random_in_range,":r",0,300),
          (try_end),
          (agent_set_animation_progress,":agent",":r"),
        (try_end),
      (try_end),
    ],[]),

    (3, 0, 0, [
      (eq, "$talk_context", tc_escape),
    ],[
      (assign, ":sound_played", 0),
      (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_slot_ge, ":agent_no",  slot_agent_is_running_away, 1),
        # (neg|agent_is_ally, ":agent_no"),
        (store_random_in_range, ":rand", 32, 40),
        (entry_point_get_position, pos2, ":rand"),
        (agent_start_running_away, ":agent_no", pos2),
        (call_script, "script_advanced_agent_set_speed_modifier", ":agent_no", 125),	#make them run around
        #sound:
        (eq, ":sound_played", 0),
        (assign, ":sound_played", 1),
        (store_random_in_range, ":rand", 1, 4),
        (eq, ":rand", 1),
        (agent_play_sound, ":agent_no", "snd_panic_cry"),
      (try_end),
    ]),

    (0,8,0,[
      (neq, "$talk_context", tc_escape),
    ],[
      (try_for_agents,":agent_no"),
        (agent_is_alive,":agent_no"),
        (agent_is_human,":agent_no"),
        (agent_get_entry_no, ":entry", ":agent_no"),
        (is_between, ":entry", 26,46),
        (assign, ":continue_walk", 0),
        (store_random_in_range, ":continue_walk", 1, 100),
        (try_begin),
          (le, ":continue_walk", 38),
          (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
          (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
          (agent_set_animation, ":agent_no", "anim_stand_man"),
          (agent_set_animation_progress, ":agent_no", 10),

          (agent_get_position, pos1, ":agent_no"),
          (store_random_in_range, ":points", 25, 46),
          (entry_point_get_position, pos2, ":points"),
          (agent_set_speed_limit, ":agent_no", 1),
          (agent_set_scripted_destination, ":agent_no", pos2),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_ambushed),
    ]),

    (1, 0, ti_once,[],[
      (try_begin),
          (eq, "$g_mt_mode", tcm_default),
          (store_current_scene, ":cur_scene"),
          (scene_set_slot, ":cur_scene", slot_scene_visited, 1),
      (try_end),
    ]),

    (0,0,ti_once, [],[
      (try_for_agents, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_is_human, ":agent_no"),
          (agent_is_alive, ":agent_no"),
          (call_script, "script_init_town_agent", ":agent_no"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0,[
      (try_begin),
          (this_or_next|eq, "$talk_context", tc_escape),
          (eq, "$talk_context", tc_prison_break),
          (display_message, "str_cannot_leave_now"),
      (else_try),
          (stop_all_sounds, 1),
          (finish_mission,0),
      (try_end),
    ],[]),

    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    ambient_scene_play_loop,
    ambient_scene_play_random_sound,
    wounds_vc,
  ] + bodyguard_triggers
),

("charge_desert_town",mtf_battle_mode|mtf_synch_inventory,charge,
  "You lead your men to battle.",
    [
      (0,mtef_attackers|mtef_team_0,0,0,0,[]),#player
      (1,mtef_defenders|mtef_team_1,0,0,0,[]),#guard
      (2,mtef_defenders|mtef_team_1,0,0,0,[]),#guard
	    (3,mtef_defenders|mtef_team_1,0,0,0,[]),#legatus
      (4,mtef_defenders|mtef_team_1,0,0,0,[]),#legatus

      (5,mtef_defenders|mtef_team_1,0,0,0,[]),#unused
      (6,mtef_defenders|mtef_team_1,0,0,0,[]),#unused
      (7,mtef_defenders|mtef_team_1,0,0,0,[]),#unused
		#spectators begin
		#69 bis 73 sind mindestens 5 pro spawn
      (8,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (9,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (10,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (11,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (12,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (13,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (14,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (15,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (16,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (17,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (18,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (19,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (20,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (21,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (22,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (23,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (24,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (25,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (26,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (27,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (28,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (29,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (30,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (31,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (32,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (33,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (34,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (35,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (36,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (37,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (38,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (39,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (40,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (41,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (42,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (43,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (44,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (45,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (46,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (47,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (48,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators
      (49,mtef_defenders|mtef_team_1,0,0,0,[]),#spectators

      (50,mtef_defenders|mtef_team_1,0,aif_start_alarmed,0,[]),
      (51,mtef_attackers|mtef_team_0,0,aif_start_alarmed,0,[]),
      (52,mtef_attackers|mtef_team_0,0,aif_start_alarmed,9,[]),
      (53,mtef_attackers|mtef_team_0,0,aif_start_alarmed,9,[]),
      (54,mtef_defenders|mtef_team_1,0,aif_start_alarmed,11,[]),
      (55,mtef_defenders|mtef_team_1,0,aif_start_alarmed,11,[]),
      (56,mtef_defenders|mtef_team_1,0,aif_start_alarmed,11,[]),
      (57,mtef_defenders|mtef_team_1,0,aif_start_alarmed,12,[]),
      (58,mtef_attackers|mtef_team_0,0,aif_start_alarmed,9,[]),
      (59,mtef_attackers|mtef_team_0,0,aif_start_alarmed,9,[]),

     ], p_wetter + storms + global_common_triggers +
    [
      cannot_spawn_commoners,
        improved_lightning,
      common_battle_init_banner,
	   	wounds_vc,
      common_battle_tab_press,

      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (assign, "$pin_player_fallen", 0),
        (try_begin),
          (store_mission_timer_a, ":elapsed_time"),
          (gt, ":elapsed_time", 20),
          (str_store_string, s5, "str_retreat"),
          (call_script, "script_simulate_retreat", 10, 20, 1),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),]),

      (ti_before_mission_start, 0, 0, [],
       [
         (team_set_relation, 0, 2, 1),
         (team_set_relation, 1, 3, 1),
         (call_script, "script_place_player_banner_near_inventory_bms"),

         (party_clear, "p_routed_enemies"),

         (assign, "$g_latest_order_1", 1),
         (assign, "$g_latest_order_2", 1),
         (assign, "$g_latest_order_3", 1),
         (assign, "$g_latest_order_4", 1),
         ]),

     (ti_before_mission_start, 0, 0, [],[(assign,"$g_battle_won",0),
                           (assign,"$defender_reinforcement_stage",0),
                           (assign,"$attacker_reinforcement_stage",0),
                           ]),
      (0, 0, ti_once, [],[
                           (call_script, "script_place_player_banner_near_inventory"),
                           (call_script, "script_combat_music_set_situation_with_culture"),
                           ##diplomacy begin
                           (call_script, "script_init_death_cam"),
                           # (assign, "$g_dplmc_charge_when_dead", 0),
                           ##diplomacy end
                           ]),

      common_music_situation_update,
      common_battle_check_friendly_kills,
      common_battle_check_victory_condition,

      (1, 0, 0, [
          (store_mission_timer_a,":mission_time"),
          (ge,":mission_time",10),
          (store_normalized_team_count,":num_defenders", 1),
          (lt,":num_defenders",40)],
           [(add_reinforcements_to_entry,57,15),]),

      (1, 0, 5, [(store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_attackers", 0),
                 (lt,":num_attackers",30)],
           [(add_reinforcements_to_entry,51,19),]),

    # (1, 60, ti_once,
      # [
        # (store_mission_timer_a,reg(1)),
        # (ge,reg(1),10),
        # (call_script, "script_all_enemies_routed"),
        # (eq, reg10, 0),
        # ##diplomacy begin
        # (this_or_next|eq, "$g_dplmc_battle_continuation", 0),
        # (neg|main_hero_fallen),
        # ##diplomacy end
        # (set_mission_result,1),
        # (display_message,"str_msg_battle_won"),
        # (assign,"$g_battle_won",1),
        # (assign, "$g_battle_result", 1),
        # (call_script, "script_play_victorious_sound"),
        # ],
      # [
        # (call_script, "script_count_mission_casualties_from_agents"),
        # (finish_mission, 1),
        # ]),

	(0, 0, ti_once,
      [

        ],
      [
    (set_show_messages, 0),
    (try_for_range, ":cur_group", 0, grc_everyone),
      (team_give_order, 0, ":cur_group", mordr_stand_ground),
      (team_give_order, 0, ":cur_group", mordr_spread_out),

      (team_give_order, 1, ":cur_group", mordr_stand_ground),
      (team_give_order, 1, ":cur_group", mordr_spread_out),
    (try_end),
    (set_show_messages, 1),
        ]),

	(6, 0, ti_once,
      [

        ],
      [
    (set_show_messages, 0),
    (try_for_range, ":cur_group", 0, grc_everyone),
      (team_give_order, 1, ":cur_group", mordr_charge),
      (team_give_order, 1, ":cur_group", mordr_use_any_weapon),
    (try_end),
    (set_show_messages, 1),
        ]),

      common_battle_victory_display,
      (1, 4,
      ##diplomacy begin
      0,
      ##diplomacy end
      [(main_hero_fallen)],
          [
              ##diplomacy begin
              (try_begin),
                (call_script, "script_cf_dplmc_battle_continuation"),
              (else_try),
                ##diplomacy end
                (assign, "$pin_player_fallen", 1),

                (str_store_string, s5, "str_retreat"),
                (call_script, "script_simulate_retreat", 10, 20, 1),
                (assign, "$g_battle_result", -1),
                (set_mission_result,-1),
                (call_script, "script_count_mission_casualties_from_agents"),
                (finish_mission,0),
                ##diplomacy begin
              (try_end),
              ##diplomacy end
            ]),

      common_battle_inventory,
      common_battle_order_panel_tick,

    ]
    + improved_horse_archer_ai
    + theoris_decapitation
    + jacobhinds_morale_triggers
    + utility_triggers + battle_panel_triggers + extended_battle_menu
    + common_division_data

    + division_order_processing + real_deployment + formations_triggers
    # + AI_triggers
    + morale_triggers
    ##diplomacy begin
    + dplmc_battle_mode_triggers
      ##diplomacy end
    + auxiliary_player
  ),

("conspiracy_fight", mtf_battle_mode,-1,"monasterio",[
    (0,mtef_scene_source|mtef_team_0, af_override_horse,aif_start_alarmed,1,[]),
    (1,mtef_scene_source|mtef_team_0, af_override_horse,aif_start_alarmed,1,[]),
    (2,mtef_scene_source|mtef_team_0,af_override_horse, 0, 1,[]),
    (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (4,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (5,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (6,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (7,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (8,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (9,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (10,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (11,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (12,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (13,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (14,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (15,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (16,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (17,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (18,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (19,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (20,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (21,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (22,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (23,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (24,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (25,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (26,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (27,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (28,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (29,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (30,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (31,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (32,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (33,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (34,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (35,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    common_inventory_not_available,
    common_battle_init_banner,
		wounds_vc,
    (ti_before_mission_start, 0, 0, [],[
		  (team_set_relation, 0, 1, -1),
      (assign,"$g_battle_result",0),
      (call_script, "script_change_banners_and_chest"),
		  (set_party_battle_mode),
    ]),
    (ti_after_mission_start, 0, 0, [],[
	    (play_track, "track_travel_neutral2", 1),
	  ]),
    (ti_tab_pressed, 0, 0, [
      (display_message,"str_cannot_leave_now")
    ],[]),
    (1, 4, ti_once, [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le,1)
    ],[
      (try_begin),
        (main_hero_fallen),
        (assign, "$temp", 0),
        (jump_to_menu, "mnu_death_waits"),
      (else_try),
        (jump_to_menu, "mnu_conspiracy_2"),
      (try_end),
      (stop_all_sounds, 1),
      (finish_mission),
    ]),
]),

  ("slave_market",0,-1, #Pagan holy site
    "Nordic Place",
    [(0,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
      (1,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (2,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (3,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (4,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (5,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (6,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (7,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),

      (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (11,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (12,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (13,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (14,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (15,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (16,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (17,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (18,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (19,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (20,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (21,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (22,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (23,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (24,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (25,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (26,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (27,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (28,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (29,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (30,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(31,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (32,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(33,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (34,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(35,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (36,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(37,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (38,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(39,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (40,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (41,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),	#for leaving door
      (42,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(43,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (44,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(45,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (46,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(47,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    ], p_wetter + global_common_triggers +
    [
      can_spawn_commoners,
      #can_spawn_commoners,
      (ti_before_mission_start, 0, 0, [],[(call_script, "script_change_banners_and_chest")]),
      (ti_after_mission_start, 0, 0, [],[(call_script, "script_music_set_situation_with_culture", mtf_sit_town)]),
      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)],[]),

      (ti_tab_pressed, 0, 0, [(set_trigger_result,1)],[]),

      (ti_on_agent_spawn, 0, 0, [],
        [
          (store_trigger_param_1, ":agent_no"),
          (get_player_agent_no, ":player_agent"),
          (try_begin),
            (neq, ":player_agent", ":agent_no"),
            (agent_set_team, ":agent_no", 7),
          (try_end),
      ]),

    (0,0,ti_once, [],
    [
    (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (call_script, "script_init_town_agent", ":agent_no"),
    (try_end),
    ]),
      (0,8,0,[],
        [
          (try_for_agents,":agent_no"),
            (agent_is_alive,":agent_no"),
            (agent_is_human,":agent_no"),
            (agent_get_troop_id, ":troop_no", ":agent_no"),
            (this_or_next|eq, ":troop_no", "trp_roman_town_walker"),
            (eq, ":troop_no", "trp_roman_town_walker_female"),

            (assign, ":continue_walk", 0),
            (store_random_in_range, ":continue_walk", 1, 100),
            (try_begin),
              (le, ":continue_walk", 40),
              (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
              (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
              (agent_set_animation, ":agent_no", "anim_stand_man"),
              (agent_set_animation_progress, ":agent_no", 10),

              (agent_get_position, pos1, ":agent_no"),
              (store_random_in_range, ":points", 1, 10),
              (entry_point_get_position, pos2, ":points"),
              (agent_set_speed_limit, ":agent_no", 1),
              (agent_set_scripted_destination, ":agent_no", pos2),
            (try_end),
          (try_end),
      ]),

      (0, 0, ti_once, [],
        [
          (party_slot_eq, "$current_town", slot_party_type, spt_town),
          (call_script, "script_town_init_doors", 0),
          (try_begin),
            (eq, "$town_nighttime", 0),
            (play_sound, "snd_town_ambiance", sf_looping),
          (try_end),
      ]),

      ambient_set_agents_for_sounds,
      ambient_agent_play_sound,


    ]+ bodyguard_triggers,
  ),

("gods_judgment",mtf_battle_mode|mtf_commit_casualties,-1,
  "Fight bastard.",[
    (0, mtef_visitor_source|mtef_team_0, af_override_horse, aif_start_alarmed, 1, []), #player start
    (1, mtef_visitor_source|mtef_team_1, af_override_horse, aif_start_alarmed, 1, []), #opponent start
    (2, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []), #start enemy spectators
    (3, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
    (4, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
  ], global_common_triggers +
  [
    cannot_spawn_commoners,
    custom_commander_critical_strike,
    (ti_after_mission_start, 0, 0, [],[
	    (play_track, "track_travel_neutral2", 1),
	  ]),

    (1, 0, ti_once, [],[
      (mission_disable_talk),
      (entry_point_get_position, pos10, 90),
      (set_spawn_position, pos10),
      (spawn_item, "itm_stones_siege",0,0),
      (entry_point_get_position, pos10, 91),
      (set_spawn_position, pos10),
      (spawn_item, "itm_greek_fire",0,0),
      # (entry_point_get_position, pos10, 92),
      # (set_spawn_position, pos10),
      # (spawn_item, "itm_greek_fire",0,0),
      # (entry_point_get_position, pos10, 93),
      # (set_spawn_position, pos10),
      # (spawn_item, "itm_stones_siege",0,0),
      # (entry_point_get_position, pos10, 94),
      # (set_spawn_position, pos10),
      # (spawn_item, "itm_greek_fire",0,0),
      # (entry_point_get_position, pos10, 95),
      # (set_spawn_position, pos10),
      # (spawn_item, "itm_greek_fire",0,0),
    ]),
    common_inventory_not_available,

    (14, 0, ti_once, [],[
      (get_player_agent_no, ":player"),
      (agent_set_damage_modifier,":player",90),
    ]),

    (ti_tab_pressed, 0, 0, [(display_message, "str_cannot_leave_now")],[]),

    (ti_before_mission_start, 0, 0, [],[
      #  (scene_set_day_time, 13),
      # (call_script, "script_change_banners_and_chest"),
      (store_random_in_range, ":haze_power", 35, 65),
      (set_global_haze_amount, ":haze_power"),
      (set_fog_distance, 60, 0x333333),
    ]),

    (0, 0, ti_once, [
      (tutorial_message_set_size, 15, 15),
      (tutorial_message_set_position, 500, 450), #650 for tutorial or mission msg, 450 for dialogs
      (tutorial_message_set_center_justify, 0),
      (assign, "$cam_time", 0), #for cam times
    ],[]),

    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (agent_get_troop_id, ":troop_no", ":agent_no"),
      (neq, ":troop_no", "trp_player"),
      (agent_set_no_death_knock_down_only, ":agent_no", 1),
      (assign, "$temp", 0),
    ]),

    (ti_on_agent_knocked_down, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent"),
      (agent_get_troop_id, ":troop", ":dead_agent"),
      (neq, ":troop", "trp_player"),
      (val_add, "$temp", 1),
      (try_begin),
        (gt, "$temp", 1),
        (agent_set_no_death_knock_down_only, ":dead_agent", 0),
      (try_end),
    ]),

    (0, 0, ti_once, [
      (neg|conversation_screen_is_active),
      (neg|is_presentation_active, "prsnt_battle"),
      (neg|is_presentation_active, "prsnt_order_display"),
      (store_mission_timer_a, ":cur_time"),
      (ge, ":cur_time", 2),
    ],[
      (set_fixed_point_multiplier, 100),
      # character picture
      (tutorial_message_set_background, 1),

      (tutorial_message, "@A voice whispers: 'We test your skills, {playername}. If you survive, you will gain our blessings. Defeat your opponent!'", 0xFFd6d3ce, 15),
      (set_fixed_point_multiplier, 100),
      (assign, "$cam_time", 1),
      (entry_point_get_position, pos7, 2),
      (call_script, "script_save_cam_first_person_mode"),
      (mission_cam_set_mode, 1, 0, 0),
      (set_camera_in_first_person, 0),
      (mission_cam_animate_to_position, pos7, 100, 0),
    ]),
    (0, 0, 0, [
      (eq, "$cam_time", 1),
      (store_mission_timer_a, ":cur_time"),
      (ge, ":cur_time", 10),
    ],[
      (tutorial_message, -1),
      (tutorial_message_set_background, 0),
      (call_script, "script_return_to_cam_first_person_mode_1_sec"),
      (assign, "$cam_time", 0),
    ]),

    (1, 4, ti_once, [
      (neg|main_hero_fallen),
      (num_active_teams_le, 1),
    ],[
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
      (finish_mission, 3),
      (jump_to_menu, "mnu_won_judgment"),
    ]),
    (1, 4, ti_once,[
      (main_hero_fallen),
      #(eq, "$cam_mode", 0),
    ],[
      (jump_to_menu, "mnu_lost_judgment"),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
      (finish_mission, 3),
    ]),
]),

("barracks",0,-1,"You will fight a match in the holmgang.",[
  (0, mtef_scene_source|mtef_team_0, af_override_horse, 0, 1, []), #player start
  (1, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_head, 0, 1, []), #opponent start
  (2, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []), #start enemy spectators
  (3, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []),
  (4, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []),
  (5, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []),
  (6, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []),
  (7, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []),
  (8, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []),
  (9, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []),
  (10, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (11, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (12, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (13, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (14, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (15, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (16, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (17, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (18, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (19, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (20, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (21, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (22, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (23, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (24, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (25, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
  (26, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_graves_simple_2,itm_roman_poor1]),
], p_wetter + storms + global_common_triggers +
[
  can_spawn_commoners,
  improved_lightning,
  ambient_scene_play_loop,
  ambient_scene_play_random_sound,
  ambient_set_agents_for_sounds,
  ambient_agent_play_sound,

  (ti_inventory_key_pressed, 0, 0,[
    (set_trigger_result, 1),
  ],[]),

  (ti_tab_pressed, 0, 0, [
    (try_begin),
        (eq, "$temp", 1),
        (display_message, "str_cannot_leave_now"),
    (else_try),
        (finish_mission),
    (try_end),
  ],[]),

  (0,0,ti_once, [],[
    (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (call_script, "script_init_town_agent", ":agent_no"),
    (try_end),
  ]),

  (0, 0, 0,[
    (key_clicked, key_k),
    (tutorial_message, -1),
  ],[]),
  # (1,0,ti_once,[
  #   (eq,"$temp",1),
  #   (neg|conversation_screen_is_active),
  # ],[
  #   (tutorial_message_set_size, 19, 19),
  #   (tutorial_message_set_position, 500, 650),
  #   (tutorial_message_set_center_justify, 0),
  #   (tutorial_message_set_background, 1),
  #   (tutorial_message, "@ Go and talk with the troops to assign equipment to them. They are awaiting you in the courtyard. When you have finished, talk with the Praetor again.^^(press K to finish read)"),
  # ]),
]),

("lucias_villa",0,-1,
  "You will fight a match in the holmgang.",[
    (0, mtef_scene_source|mtef_team_0, af_override_horse, 0, 1, []), #player start
    (1, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []), #opponent start
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    ambient_scene_play_loop,
    ambient_scene_play_random_sound,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,

    (ti_tab_pressed, 0, 0, [
      (try_begin),
          (eq, "$temp", 1),
          (display_message, "str_cannot_leave_now"),
      (else_try),
         (jump_to_menu, "mnu_auto_return"),
         (finish_mission),
      (try_end),
    ],[]),

    (0,0,ti_once, [],[
      (try_for_agents, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_is_human, ":agent_no"),
          (agent_is_alive, ":agent_no"),
          (call_script, "script_init_town_agent", ":agent_no"),
      (try_end),
    ]),
    (0, 0, 0,[
      (key_clicked, key_k),
      (tutorial_message, -1),
    ],[]),
	  (1,0,ti_once,[
      (eq,"$temp",1),
      (neg|conversation_screen_is_active),
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@ Find Lucia and talk with her.^^(press K to finish read)"),
    ]),
]),

  ("witch",0,-1,
    "You will fight a match in the holmgang.",
    [
      (0, mtef_scene_source|mtef_team_0, af_override_horse, 0, 1, []), #player start
      (1, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []), #opponent start

     ], p_wetter + storms + global_common_triggers +
     [
      cannot_spawn_commoners,
      ambient_scene_play_loop,
      ambient_scene_play_random_sound,
      ambient_set_agents_for_sounds,
      ambient_agent_play_sound,

      (ti_before_mission_start, 0, ti_once, [],[

      (store_random_in_range, ":fog_distance", 40, 55),
      (store_random_in_range, ":haze_power", 25, 65),
      (set_global_haze_amount, ":haze_power"),
      (set_fog_distance, ":fog_distance", 0x333333),
      ] ),

      (ti_tab_pressed, 0, 0, [
         (jump_to_menu, "mnu_grove"),
         (finish_mission),
      ],[]),


    ],
  ),
  ("arminius_grove",0,-1,
    "You will fight a match in the holmgang.",
    [
    (0, mtef_scene_source|mtef_team_0, 0, 0, 1, []), #player start
     ], p_wetter + storms + global_common_triggers +
     [
      cannot_spawn_commoners,
      (0, 0, ti_once, [
          (tutorial_message_set_size, 15, 15),
          (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
          (tutorial_message_set_center_justify, 0),
          ],[]),

      (1,0,0,[
        (neg|conversation_screen_is_active),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),  ],
        [
          (store_mission_timer_a, ":cur_time"),
          (try_begin),
            (ge, ":cur_time", 17),
            (tutorial_message, -1),
            (tutorial_message_set_background, 0),
          (else_try),
            (ge, ":cur_time", 10),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@This area is sacred for the local population. Be careful and do not anger them."),
          (try_end),
      ]),

      ambient_scene_play_loop,
      ambient_scene_play_random_sound,
      ambient_set_agents_for_sounds,
      ambient_agent_play_sound,

      (ti_before_mission_start, 0, ti_once, [],[

      (store_random_in_range, ":fog_distance", 100, 125),
      (store_random_in_range, ":haze_power", 10, 50),
      (set_global_haze_amount, ":haze_power"),
      (set_fog_distance, ":fog_distance"),#0x333333
      ] ),

      (1, 0, 0, [(troop_slot_eq, "trp_witch", slot_troop_wealth, 1),],	# keep them fleeing
        [
        (set_fixed_point_multiplier, 1),
        (entry_point_get_position, pos2, 1),
        (get_player_agent_no, ":player"),
        (agent_get_position, pos1, ":player"),
        (get_distance_between_positions_in_meters, ":distance", pos1, pos2),
        (le, ":distance", 3),
        (display_message, "@You found Arminius tomb!", color_good_news),
        (add_xp_as_reward, 1000),
        (troop_set_slot, "trp_witch", slot_troop_wealth, 2),
      ]),

      (ti_tab_pressed, 0, 0, [
         (jump_to_menu, "mnu_grove_2"),
         (finish_mission),
      ],[]),

    (ti_question_answered, 0, 0,
    [(troop_slot_eq, "trp_witch", slot_troop_leaded_party, 0),],
    [
    (store_trigger_param_1, ":number"),
    (eq, ":number", 0),
    (display_message, "@Your action angered the Germans!", color_terrible_news),
    (display_log_message, "@You desecrate Arminius tomb!", color_terrible_news),
    (troop_set_slot, "trp_witch", slot_troop_leaded_party, 1),

    (assign, ":min_dist", 100),
    (assign, ":min_dist_village", -1),
    (try_for_range, ":cur_village", villages_begin, villages_end),
      (store_distance_to_party_from_party, ":cur_dist", ":cur_village", "p_main_party"),
      (lt, ":cur_dist", ":min_dist"),
      (assign, ":min_dist", ":cur_dist"),
      (assign, ":min_dist_village", ":cur_village"),
    (try_end),
    (try_begin),
      (gt, ":min_dist_village", -1),
      (store_faction_of_party, ":village_faction", ":min_dist_village"),
      (is_between, ":village_faction", "fac_kingdom_1", kingdoms_end),
      (faction_slot_eq, ":village_faction", slot_faction_culture, "fac_culture_4"),
      (call_script, "script_change_player_relation_with_faction", ":village_faction", -5),
    (try_end),

    (call_script, "script_change_player_honor", -5),
    (call_script, "script_change_troop_renown", "trp_player", 15),

    (set_show_messages, 0),
    (set_fixed_point_multiplier, 100),
    (try_for_range, ":center", centers_begin, centers_end),#reduce relacion con cada centro chief
      (party_slot_eq, ":center", slot_center_culture, "fac_culture_4"),
      (store_distance_to_party_from_party, ":cur_distance", "p_main_party", ":center"),
      (lt,":cur_distance", 20),
      (call_script, "script_change_player_relation_with_center", ":center", -5),
    (try_end),
    (try_for_range, ":npc", active_npcs_begin, active_npcs_end),
        (neg|troop_slot_eq, ":npc", slot_troop_occupation, dplmc_slto_dead),
        (store_faction_of_troop, ":fac", ":npc"),
        (eq, ":fac", "$players_kingdom"),
        (troop_get_slot, ":personality", ":npc", slot_lord_reputation_type),
        (try_begin),
            (is_between, ":personality", lrep_goodnatured, lrep_custodian),
            (neq, ":personality", lrep_roguish),
            (troop_slot_eq, ":npc", slot_troop_culture, "fac_culture_7"),
            (store_random_in_range, ":rand", 0, 3),
            (call_script, "script_change_player_relation_with_troop", ":npc", ":rand"),
        (else_try),
            (troop_slot_eq, ":npc", slot_troop_culture, "fac_culture_7"),
            (store_random_in_range, ":rand", 1, 3),
            (call_script, "script_change_player_relation_with_troop", ":npc", ":rand"),
        (try_end),
    (try_end),
    (set_show_messages, 1),
    (add_xp_as_reward, 500),
    ]),

    ],
  ),

("witch_2",mtf_battle_mode|mtf_commit_casualties,-1,
  "You will fight a match in the holmgang.",[
    (0, mtef_scene_source|mtef_team_0, af_override_horse, aif_start_alarmed, 1, []), #player start
    (1, mtef_visitor_source|mtef_team_1, af_override_horse, aif_start_alarmed, 1, []), #opponent start
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,

    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (agent_get_troop_id, ":troop_no", ":agent_no"),
      (eq, ":troop_no", "trp_scandia"),
      # (agent_set_team, ":agent_no", 1),
      # (agent_set_is_alarmed, ":agent_no", 1),
      # (agent_ai_set_aggressiveness, ":agent_no", 10),
      # (team_set_relation, 0, 1, -1),
      # (team_set_relation, 1, 0, -1),
      # (team_give_order, 1, grc_everyone, mordr_charge),
      (agent_set_no_death_knock_down_only, ":agent_no", 1),
      (assign, "$temp", 0),
    ]),

    (ti_on_agent_knocked_down, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent"),
      (agent_get_troop_id, ":troop", ":dead_agent"),
      (eq, ":troop", "trp_scandia"),
      (val_add, "$temp", 1),
      (try_begin),
        (gt, "$temp", 2),
        (agent_set_no_death_knock_down_only, ":dead_agent", 0),
      (try_end),
    ]),

    ambient_scene_play_loop,
    ambient_scene_play_random_sound,
    dedal_shield_bash,
    dedal_shield_bash_AI,

    (ti_before_mission_start, 0, ti_once, [],[
      (store_random_in_range, ":fog_distance", 80, 100),
      (store_random_in_range, ":haze_power", 70, 100),
      (set_global_haze_amount, ":haze_power"),
      (set_fog_distance, ":fog_distance", 0x333333),
    ]),

    (1, 4, ti_once, [
      (assign, ":continue", 0),
      (try_for_agents,":cur_agent"),
        (agent_get_troop_id,":cur_troop_id",":cur_agent"),
        (eq,":cur_troop_id","trp_scandia"),
        (neg|agent_is_alive,":cur_agent"),
        (assign, ":continue", 1),
      (try_end),
      (eq, ":continue", 1),
    ],[
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      (finish_mission,4),
      (jump_to_menu, "mnu_won_witch"),
    ]),
    (1, 4, ti_once,[
      (main_hero_fallen),
    ],[
      (assign, "$temp", 22),
      (jump_to_menu, "mnu_death_waits"),
      (finish_mission,0),
    ]),
]),

("apostel_paul",0,-1,"You will fight a match in the holmgang.",[
    (0, mtef_scene_source|mtef_team_0, af_override_horse, 0, 1, []), #player start
    (1, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []), #opponent start
  ], global_common_triggers +p_wetter+
  [
    cannot_spawn_commoners,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    (ti_tab_pressed, 0, 0, [
      (try_begin),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ],[]),
],),

("kill_supporters", mtf_battle_mode,-1,"monasterio",[
    (0,mtef_visitor_source|mtef_team_0, af_override_horse|af_override_head|af_override_weapons,aif_start_alarmed,1,[itm_laurel_gold, itm_roman_gladius_rich_3]),
    (1,mtef_visitor_source|mtef_team_0, af_override_horse,aif_start_alarmed,1,[itm_roman_gladius]),
    (2,mtef_visitor_source|mtef_team_0,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (3,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (4,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (5,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (6,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (7,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (8,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (9,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (10,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (11,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (12,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (13,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (14,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (15,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (16,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (17,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (18,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (19,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (20,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (21,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (22,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (23,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (24,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (25,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (26,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (27,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (28,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (29,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (30,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (31,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (32,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (33,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (34,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (35,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (36,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (37,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (38,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (39,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (40,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (41,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (42,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (43,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (44,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (45,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (46,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (47,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (48,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (49,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (50,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (51,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (52,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (53,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (54,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (55,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (56,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (57,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (58,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
    (59,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_roman_gladius]),
  ], global_common_triggers +
  [
    cannot_spawn_commoners,
    common_inventory_not_available,
    common_battle_init_banner,
    wounds_vc,

    (0, 0, ti_once,[
      (store_mission_timer_a, ":time"),
      (ge, ":time", 3),
    ],[
      (mission_enable_talk),
      (quest_get_slot, ":goy", "qst_four_emperors", slot_quest_target_troop),
      (start_mission_conversation, ":goy"),
    ]),

    (ti_after_mission_start, 0.5, ti_once,[
    ],[
      (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_get_troop_id, ":troop", ":agent_no"),
        (try_begin),
          (this_or_next|eq, ":troop", "trp_kingdom_7_lady_1"),
          (eq, ":troop", "trp_antonia"),
          (call_script, "script_advanced_agent_set_speed_modifier", ":agent_no", 0),
        (else_try),
          (neg|troop_is_hero, ":troop"),
          (call_script, "script_advanced_agent_set_speed_modifier", ":agent_no", 75),
        (try_end),
      (try_end),

      (set_show_messages, 0),
      (get_player_agent_no, ":player"),
      (agent_get_team, ":playerteam", ":player"),
      (team_give_order, ":playerteam", grc_everyone, mordr_follow),

      (try_for_range, ":cur_group", 0, grc_everyone),
        (team_give_order, 1, ":cur_group", mordr_hold),
        (team_give_order, 1, ":cur_group", mordr_stand_closer),
        (team_give_order, 1, ":cur_group", mordr_stand_closer),
      (try_end),

      (set_show_messages, 1),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (call_script, "script_change_banners_and_chest"),
      (mission_disable_talk),
      # (set_party_battle_mode),
    ]),
    (ti_after_mission_start, 0, 0, [],[
      (play_track, "track_travel_neutral2", 1),
      (team_set_relation, 0, 1, 1),
      (team_set_relation, 1, 0, 1),
      (assign,"$g_battle_result",0),
      (set_cheer_at_no_enemy, 0), # no cheer
    ]),

    (ti_tab_pressed, 0, 0, [
      (display_message,"str_cannot_leave_now"),
    ],[]),

    (1, 4, ti_once, [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],[
      (try_begin),
        (main_hero_fallen),
        (assign, "$temp", 0),
        (jump_to_menu, "mnu_death_waits"),
      (else_try),
        (jump_to_menu, "mnu_meeting_with_centurio_2"),
      (try_end),
      (stop_all_sounds, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
      (finish_mission, 3),
    ]),
]),

("kill_christs", mtf_battle_mode,-1,"monasterio",[
    (0,mtef_scene_source|mtef_team_0, af_override_horse,aif_start_alarmed,1,[]),
    (1,mtef_visitor_source|mtef_team_1, af_override_horse,aif_start_alarmed,1,[]),
    (2,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed, 1,[]),
    (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
  ], global_common_triggers + p_wetter +
  [
    cannot_spawn_commoners,
    (ti_before_mission_start, 0, ti_once, [],[
      (store_random_in_range, ":fog_distance", 50, 75),
      (store_random_in_range, ":haze_power", 25, 65),
      (set_global_haze_amount, ":haze_power"),
      (set_fog_distance, ":fog_distance", 0x333333),
	  ]),
    common_inventory_not_available,
    common_battle_init_banner,
    wounds_vc,

    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 0, 1, -1),
      (assign,"$g_battle_result",0),
      (call_script, "script_change_banners_and_chest"),
      (set_party_battle_mode),
    ]),
    (ti_after_mission_start, 0, 0, [],[
      (play_track, "track_travel_neutral2", 1),
    ]),

    (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

    (1, 4, ti_once, [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le,1),
    ],[
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_rom_burns_2"),
        (troop_remove_gold, "trp_player", 500),
        (display_message, "@After you fall the bandits rob you!", message_negative),
      (else_try),
        (jump_to_menu, "mnu_rom_burns_2"),
      (try_end),
      (stop_all_sounds, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      (finish_mission, 4),
    ]),
    (0, 0, ti_once, [
      (tutorial_message_set_size, 15, 15),
      (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
      (tutorial_message_set_center_justify, 0),
    ],[]),
    (1,0,0,[
      (neg|conversation_screen_is_active),
      (neg|is_presentation_active, "prsnt_battle"),
      (neg|is_presentation_active, "prsnt_order_display"),
    ],[
      (store_mission_timer_a, ":cur_time"),
      (try_begin),
        (ge, ":cur_time", 21),
        (tutorial_message, -1),
        (tutorial_message_set_background, 0),
      (else_try),
        (ge, ":cur_time", 13),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@The smoke is getting thicker, it becomes harder to breathe."),
      (try_end),
    ]),
    (0, 0, ti_once, [],[
      (try_for_prop_instances, ":curr_instance", -1, somt_object),
        (prop_instance_get_scene_prop_kind, ":scene_prop_kind", ":curr_instance"),
        (eq, ":scene_prop_kind", "spr_Village_fire_big"),
        (prop_instance_add_particle_system, ":curr_instance", "psys_village_fire_smoke_big", pos1),
        (store_random_in_range, reg40, 0, 100),
        (lt, reg40, 45),
        # (prop_instance_play_sound, ":curr_instance", "snd_fire", sf_looping),
      (try_end),
    ]),
]),

("lucillus_1", mtf_battle_mode,-1,
    "monasterio",
    [
      (0,mtef_scene_source|mtef_team_0, af_override_horse,aif_start_alarmed,1,[]),
      (1,mtef_visitor_source|mtef_team_1, af_override_horse,aif_start_alarmed,1,[]),
      (2,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed, 1,[]),
      (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (4,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),

    ], global_common_triggers + p_wetter +
    [
      cannot_spawn_commoners,
      remove_banners,
      improved_lightning,
      common_inventory_not_available,
      common_battle_init_banner,
      wounds_vc,

        (ti_before_mission_start, 0, 0, [],
          [
          (team_set_relation, 0, 1, -1),
          (assign,"$g_battle_result",0),
          (call_script, "script_change_banners_and_chest"),
          (set_party_battle_mode),
          ]
        ),
        (ti_after_mission_start, 0, 0, [],[
      (play_track, "track_travel_neutral2", 1),
      ]),

      (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

      (1, 4, ti_once, [(this_or_next|main_hero_fallen),(num_active_teams_le,1)],
        [
          (try_begin),
            (main_hero_fallen),
            (jump_to_menu, "mnu_luc_def"),
          (else_try),
            (jump_to_menu, "mnu_luc_vic"),
          (try_end),
          (stop_all_sounds, 1),
          (finish_mission),
      ]),


]),

("lucillus_2", 0,-1,
    "monasterio",
    [
      (0,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
      (1,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (2,mtef_visitor_source|mtef_team_1,af_override_horse,0, 1,[]),
      (3,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (4,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (5,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (6,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (7,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (8,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (9,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),

    ], global_common_triggers + p_wetter +
    [
      cannot_spawn_commoners,
    improved_lightning,
       (ti_before_mission_start, 0, 0, [],[
          (team_set_relation, 0, 1, -1), # -1 for enemy, 1 for friend, 0 for neutral
          # (team_set_relation,1,2,0),
          # (team_set_relation,0,1,0),
      ]),

      (0.5, 0, ti_once, [],[
          (set_show_messages, 0),
          (get_player_agent_no, ":player"),
          (agent_get_team, ":playerteam", ":player"),
          (team_give_order, ":playerteam", 8, mordr_follow), #Division 8 to avoid potential conflicts
          (set_show_messages, 1),
      ]),
      (3, 0, 0, [],	# keep them fleeing
        [
          (assign, ":sound_played", 0),
          (try_for_agents, ":agent_no"),
            (agent_is_active, ":agent_no"),
            (agent_is_alive, ":agent_no"),
            (agent_is_human, ":agent_no"),
            (agent_slot_ge, ":agent_no",  slot_agent_is_running_away, 1),
            (agent_get_troop_id, ":troop_no", ":agent_no"),
            (this_or_next|eq, ":troop_no", "trp_senator"),
            (eq, ":troop_no", "trp_lucillus"),
            (store_random_in_range, ":rand", 0, 11),
            (entry_point_get_position, pos2, ":rand"),
            (agent_start_running_away, ":agent_no", pos2),
            (call_script, "script_advanced_agent_set_speed_modifier", ":agent_no", 85),	#make it less harder to catch them
            #sound:
            (eq, ":sound_played", 0),
            (assign, ":sound_played", 1),
            (store_random_in_range, ":rand", 1, 4),
            (eq, ":rand", 1),
            (agent_play_sound, ":agent_no", "snd_panic_cry"),
          (try_end),
      ]),

      (ti_on_agent_hit, 0, 0, [],		# make damaged agents flee
        [
          (store_trigger_param, ":inflicted_agent_id", 1),
          #(store_trigger_param, ":dealer_agent_id", 2),
          (store_trigger_param, ":inflicted_damage", 3),
          #(get_player_agent_no, ":player_agent"),
          #(eq, ":dealer_agent_id", ":player_agent"),
          (agent_is_active, ":inflicted_agent_id"),
          (agent_is_human, ":inflicted_agent_id"),
          (agent_is_alive, ":inflicted_agent_id"),
          (neg|agent_is_ally, ":inflicted_agent_id"),
          #
          (agent_get_troop_id, ":troop_no", ":inflicted_agent_id"),#VC-2111
          (this_or_next|eq, ":troop_no", "trp_senator"),
          (eq, ":troop_no", "trp_lucillus"),
          #
          (store_agent_hit_points, ":hp", ":inflicted_agent_id"),
          (this_or_next|lt, ":hp", 75),
          (gt, ":inflicted_damage", 10),
          (store_random_in_range, ":rand", 4, 11),
          (entry_point_get_position, pos2, ":rand"),
          (agent_start_running_away, ":inflicted_agent_id", pos2),
          (agent_slot_eq, ":inflicted_agent_id",  slot_agent_is_running_away, 0),
          (agent_set_slot, ":inflicted_agent_id",  slot_agent_is_running_away, 1),
          #throw away weapon:
          (agent_get_wielded_item, ":weapon", ":inflicted_agent_id", 0),
          (ge, ":weapon", 1),
          (agent_unequip_item, ":inflicted_agent_id", ":weapon"),
          #sound:
          (store_random_in_range, ":rand", 1, 4),
          (eq, ":rand", 1),
          (agent_play_sound, ":inflicted_agent_id", "snd_panic_hit"),
      ]),
      ###companion support in some events
      (ti_after_mission_start, 0, ti_once, [],[
          #player companions
          (assign, ":companions_count", 0),
          (party_get_num_companion_stacks, ":num_of_stacks", "p_main_party"),
          (try_for_range, ":i", 0, ":num_of_stacks"),
            (party_stack_get_troop_id, ":troop_id", "p_main_party", ":i"),
            (neq, ":troop_id", "trp_player"),
            (is_between,":troop_id",companions_begin,companions_end),
            (neg|troop_is_wounded, ":troop_id"),
            (val_add, ":companions_count", 1),
            (assign, ":entry_point", 10), # 10 near player

            (store_current_scene, ":cur_scene"),
            (modify_visitors_at_site, ":cur_scene"),
            (add_visitors_to_current_scene, ":entry_point", ":troop_id", 1),

            (eq, ":companions_count", 4), #4 companions max with player
            (assign, ":num_of_stacks", 0),
          (try_end),
          (mission_disable_talk),
      ]),

      (ti_on_agent_spawn, 0, 0, [],[
        (store_trigger_param_1, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (neq, ":troop", "trp_player"),

        (try_begin),
            (neg|troop_is_hero, ":troop"),
            (agent_set_team, ":agent", 7),
        (else_try),
            (eq, ":troop", "trp_lucillus"),
            (agent_set_team, ":agent", 7),
        (else_try),
            (main_party_has_troop, ":troop"),
            (get_player_agent_no, ":player"),
            (agent_get_team, ":playerteam", ":player"),
            (agent_set_team, ":agent", ":playerteam"),
            (agent_set_division, ":agent", 8),
            (agent_add_relation_with_agent, ":agent", ":player", 1),
            (agent_set_is_alarmed, ":agent", 1),
        (try_end),
      ]),

      (ti_on_agent_killed_or_wounded, 0, 0, [],
        [
          (store_trigger_param_1, ":dead_agent"),

          (agent_get_troop_id, ":troop", ":dead_agent"),
          (neq, ":troop", "trp_player"),
          (troop_is_hero, ":troop"),
          (main_party_has_troop, ":troop"),
          (party_wound_members, "p_main_party", ":troop", 1),
      ]),
      #################


      (0, 0, ti_once, [

          (tutorial_message_set_size, 15, 15),
          (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
          (tutorial_message_set_center_justify, 0),
          ],[]),

      (1,0,0,[                        (neg|conversation_screen_is_active),
          (neg|is_presentation_active, "prsnt_battle"),
          (neg|is_presentation_active, "prsnt_order_display"),

        ],
        [
          (store_mission_timer_a, ":cur_time"),
          (try_begin),
            (ge, ":cur_time", 10),
            (tutorial_message, -1),
            (tutorial_message_set_background, 0),
          (else_try),
            (ge, ":cur_time", 4),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@Kill Lucillus, his guards and slaves! No witness shall survive."),
          (try_end),
      ]),

      common_inventory_not_available,
      common_battle_init_banner,
      wounds_vc,




        (ti_after_mission_start, 0, 0, [],[
      (play_track, "track_travel_neutral2", 1),
      ]),

      (5, 0, 0, [
          (store_skill_level,":player_sneaking_skill","skl_athletics","trp_player"),
          (assign,":sneak_distance",1500),
          (val_mul, ":player_sneaking_skill", 10),
          (val_sub, ":sneak_distance", ":player_sneaking_skill"),
          (get_player_agent_no,":player_agent"),
          (agent_get_position,pos1,":player_agent"),
          (assign,":continue",0),
          (try_for_agents, ":cur_agent"),
            (agent_get_troop_id, ":troop", ":cur_agent"),
            (neq, ":troop", "trp_player"),
            (neg|is_between, ":troop", companions_begin, companions_end),
            (agent_get_position,pos2,":cur_agent"),
            (get_distance_between_positions,":distance",pos1,pos2),
            (lt,":distance",":sneak_distance"),
           # (agent_set_team, ":cur_agent", 1),
            (assign,":continue",1),
          (try_end),
          (eq,":continue",1),
        ],
        [
         (team_set_relation,0,7,-1),
          (set_party_battle_mode),
          # (try_for_agents, ":cur_agent"),
            # (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
            # (eq, ":cur_agent_troop", "trp_lucillus"),
            # (agent_set_team, ":cur_agent", 1),
          # (try_end),
      ]),


      (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

      (1, 4, ti_once, [
      (neg|main_hero_fallen),
      (assign, ":continue", 1),
      (try_for_agents,":cur_agent"),
        (agent_get_troop_id,":cur_troop_id",":cur_agent"),
        (neq,":cur_troop_id","trp_player"),
        (neg|is_between,":cur_troop_id",companions_begin,companions_end),
        (agent_is_alive,":cur_agent"),
        (assign, ":continue", 0),
      (try_end),
      (ge, ":continue", 1),
      ],
        [
          (jump_to_menu, "mnu_luc_vic_2"),
          (stop_all_sounds, 1),
          (finish_mission),
      ]),
      (5, 3, ti_once, #normal mode
        [		 (main_hero_fallen),
        ],
        [(assign, "$temp", 2),
          (jump_to_menu, "mnu_death_waits"),
          (stop_all_sounds, 1),
          (finish_mission),
      ]),

    remove_banners,
]),


  ("abduction_nero_1", 0,-1,
    "monasterio",
    [
      (0,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (1,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (2,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed, 1,[]),
      (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (4,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (5,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (6,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (7,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (8,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (9,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (10,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (11,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (12,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (13,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (14,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (15,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (16,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (17,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (18,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (19,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (20,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (21,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (22,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (23,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (24,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (25,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (26,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (27,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (28,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (29,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (30,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (31,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (32,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (33,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (34,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (35,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (36,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
      (37,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[itm_caligea,itm_roman_gladius,itm_generic_poor1,itm_simple_hood_1]),
      (38,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,[]),
    ], p_wetter + storms + global_common_triggers +
    [
      cannot_spawn_commoners,
    improved_lightning,
    (ti_before_mission_start, 0, 0, [],[
    (team_set_relation, 0, 1, 1),
    (scene_set_day_time, 0),
    ]),
    (0.5, 0.5, ti_once,
    [],
    [
    (start_mission_conversation, "trp_guest_female"),
    ]),

      common_inventory_not_available,
      wounds_vc,
      (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

    ]
  ),

  ("starting_mission", mtf_battle_mode,charge,"monasterio",[
    (0,mtef_scene_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (1,mtef_visitor_source|mtef_team_1,af_override_weapons,aif_start_alarmed,1,[itm_butchering_knife]),
    (2,mtef_visitor_source|mtef_team_1,af_override_weapons,aif_start_alarmed, 1,[itm_wooden_stick]),
    (3,mtef_visitor_source|mtef_team_1,af_override_weapons,aif_start_alarmed,1,[itm_pickaxe]),
    (4,mtef_visitor_source|mtef_team_1,af_override_weapons,aif_start_alarmed,1,[itm_warhammer]),
    (5,mtef_visitor_source|mtef_team_1,af_override_weapons,aif_start_alarmed,1,[itm_hammer]),
    (6,mtef_visitor_source|mtef_team_1,af_override_weapons,aif_start_alarmed,1,[itm_warhammer]),
    (7,mtef_visitor_source|mtef_team_1,af_override_weapons,aif_start_alarmed,1,[itm_pitch_fork]),
    (8,mtef_visitor_source|mtef_team_1,af_override_weapons,aif_start_alarmed,1,[itm_scythe]),
    (9,mtef_visitor_source|mtef_team_1,af_override_weapons,aif_start_alarmed,1,[itm_mace_1]),
    (10,mtef_visitor_source|mtef_team_1,af_override_weapons,aif_start_alarmed,1,[itm_butchering_knife]),
    (11,mtef_visitor_source|mtef_team_1,af_override_weapons,aif_start_alarmed,1,[itm_hammer]),
    (12,mtef_visitor_source|mtef_team_1,af_override_weapons,aif_start_alarmed,1,[itm_pitch_fork]),
    (13,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (14,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (15,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (16,mtef_visitor_source|mtef_team_0,af_override_everything,0,1,[itm_roman_gladius,itm_roman_toga,itm_caligea]),
    (17,mtef_visitor_source|mtef_team_0,af_override_weapons,0,1,[itm_knife]),
    (18,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (19,mtef_visitor_source|mtef_team_0,af_override_weapons,0,1,[itm_knife]),
    (20,mtef_visitor_source|mtef_team_0,af_override_weapons,0,1,[itm_knife]),
    (21,mtef_visitor_source|mtef_team_0,af_override_weapons,0,1,[itm_knife]),
    (22,mtef_visitor_source|mtef_team_0,af_override_weapons,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    (ti_before_mission_start, 0, 0, [(eq, "$temp", 0),],[
      (team_set_relation, 0, 1, 1),
    ]),
    (0.5, 0.5, ti_once,
    [(eq, "$temp", 0),],
    [
    (start_mission_conversation, "trp_guest"),
    ]),

      (3, 0, 0, [(eq, "$temp", 2),],	# keep them fleeing
        [
          (assign, ":sound_played", 0),
          (try_for_agents, ":agent_no"),
            (agent_is_active, ":agent_no"),
            (agent_is_alive, ":agent_no"),
            (agent_is_human, ":agent_no"),
            (agent_slot_ge, ":agent_no",  slot_agent_is_running_away, 1),
            (agent_get_troop_id, ":troop_no", ":agent_no"),
            (this_or_next|eq, ":troop_no", "trp_guest"),
            (this_or_next|eq, ":troop_no", "trp_guest_female"),
            (this_or_next|eq, ":troop_no", "trp_roman_town_walker"),
            (eq, ":troop_no", "trp_roman_town_walker_female"),
            (store_random_in_range, ":rand", 13, 25),
            (entry_point_get_position, pos2, ":rand"),
            (agent_start_running_away, ":agent_no", pos2),
            (call_script, "script_advanced_agent_set_speed_modifier", ":agent_no", 85),	#make it less harder to catch them
            #sound:
            (eq, ":sound_played", 0),
            (assign, ":sound_played", 1),
            (store_random_in_range, ":rand", 1, 4),
            (eq, ":rand", 1),
            (agent_play_sound, ":agent_no", "snd_panic_cry"),
          (try_end),
      ]),

      (1, 0, ti_once, [(eq, "$temp", 2),],	# keep them fleeing
        [
          (team_set_relation,0,1,-1),
          (set_party_battle_mode),
          (mission_disable_talk),
      ]),

      (ti_on_agent_hit, 0, 0, [(eq, "$temp", 2),],		# make damaged agents flee
        [
          (store_trigger_param, ":inflicted_agent_id", 1),
          #(store_trigger_param, ":dealer_agent_id", 2),
          (store_trigger_param, ":inflicted_damage", 3),
          #(get_player_agent_no, ":player_agent"),
          #(eq, ":dealer_agent_id", ":player_agent"),
          (agent_is_active, ":inflicted_agent_id"),
          (agent_is_human, ":inflicted_agent_id"),
          (agent_is_alive, ":inflicted_agent_id"),
          (neg|agent_is_ally, ":inflicted_agent_id"),
          #
          (agent_get_troop_id, ":troop_no", ":inflicted_agent_id"),#VC-2111
          (this_or_next|eq, ":troop_no", "trp_guest"),
          (this_or_next|eq, ":troop_no", "trp_guest_female"),
          (this_or_next|eq, ":troop_no", "trp_roman_town_walker"),
          (eq, ":troop_no", "trp_roman_town_walker_female"),
          #
          (store_agent_hit_points, ":hp", ":inflicted_agent_id"),
          (this_or_next|lt, ":hp", 75),
          (gt, ":inflicted_damage", 10),
          (store_random_in_range, ":rand", 4, 11),
          (entry_point_get_position, pos2, ":rand"),
          (agent_start_running_away, ":inflicted_agent_id", pos2),
          (agent_slot_eq, ":inflicted_agent_id",  slot_agent_is_running_away, 0),
          (agent_set_slot, ":inflicted_agent_id",  slot_agent_is_running_away, 1),
          #throw away weapon:
          (agent_get_wielded_item, ":weapon", ":inflicted_agent_id", 0),
          (ge, ":weapon", 1),
          (agent_unequip_item, ":inflicted_agent_id", ":weapon"),
          #sound:
          (store_random_in_range, ":rand", 1, 4),
          (eq, ":rand", 1),
          (agent_play_sound, ":inflicted_agent_id", "snd_panic_hit"),
      ]),
      common_inventory_not_available,
      common_battle_init_banner,
      wounds_vc,
      (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

    (3, 0, ti_once,[
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],[
      #keep looted items
      (get_player_agent_no, ":player"),
      (try_for_range, ":item_slot", ek_item_0, ek_horse),
          (agent_get_item_slot, ":slot_item", ":player", ":item_slot"),
          (troop_set_inventory_slot, "trp_player", ":item_slot", ":slot_item"),
      (try_end),
      (jump_to_menu, "mnu_starting_mission_finished"),
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      (finish_mission, 4),
    ]),
  ]+dplmc_battle_mode_triggers,
),

("roman_intro_1", mtf_battle_mode,charge,
  "monasterio",[
    (0,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
    (1,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
    (2,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
    (3,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
    (4,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
    (5,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
    (6,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    common_inventory_not_available,
    wounds_vc,

    (ti_tab_pressed, 0, 0, [
      (display_message,"str_cannot_leave_now")
    ],[
        (set_trigger_result, 0)
    ]),

    (ti_before_mission_start, 0, 0, [],
    [
      (scene_set_day_time, 14),
      (set_global_cloud_amount, 20),
    ]),

    (1, 0, ti_once, [
      (get_player_agent_no,":player_agent"),
      (agent_get_position,pos15,":player_agent"),
      (assign,":continue",0),
      (try_for_agents, ":cur_agent"),
          (agent_is_alive,":cur_agent"),
          (agent_is_human,":cur_agent"),
          (agent_get_troop_id, ":troop", ":cur_agent"),
          (eq, ":troop", "trp_old_man"),
          (agent_get_position, pos16, ":cur_agent"),
          (get_distance_between_positions,":distance",pos15,pos16),
          (le,":distance",1000),
          (assign,":continue",1),
      (try_end),
      (eq,":continue",1),
      (mission_enable_talk),
    ],[
      (start_mission_conversation, "trp_old_man"),
    ]),

    (0,0,ti_once,[],
    [
      (try_for_agents,":agent_no"),
          (agent_is_alive,":agent_no"),
          (agent_is_human,":agent_no"),
          (agent_get_troop_id, ":troop_no", ":agent_no"),
          (try_begin),
              (this_or_next|eq,":troop_no", "trp_guest"),
              (eq,":troop_no", "trp_guest_female"),
              (agent_set_stand_animation, ":agent_no", "anim_sitting_low"),
              (agent_set_animation, ":agent_no", "anim_sitting_low"),
              (store_random_in_range,":r",0,300),
              (agent_set_animation_progress,":agent_no",":r"),
          (else_try),
              (eq, ":troop_no", "trp_player"),
              (call_script, "script_advanced_agent_set_speed_modifier", ":agent_no", 0),
              (agent_set_no_death_knock_down_only, ":agent_no", 1),
          (else_try),
              (eq, ":troop_no", "trp_old_man"),
              (call_script, "script_advanced_agent_set_speed_modifier", ":agent_no", 75),
              (entry_point_get_position, pos15, 4),
              (agent_set_scripted_destination, ":agent_no", pos15),
          (try_end),
      (try_end),
    ]),

    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    ambient_scene_play_loop,
    ambient_scene_play_random_sound,

    ],
),

("roman_intro_2", mtf_battle_mode,charge,
    "monasterio",
    [
      (0,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
      (1,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
      (2,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
      (3,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
      (4,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
      (5,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
      (6,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
    ], p_wetter + global_common_triggers +
    [
      cannot_spawn_commoners,
    improved_lightning,
    common_inventory_not_available,
    wounds_vc,

    (ti_tab_pressed, 0, 0, [
      (display_message,"str_cannot_leave_now")
    ],[
        (set_trigger_result, 0)
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (scene_set_day_time, 10),
      (set_global_cloud_amount, 25),
      (assign, "$tutorial_state", 0),
    ]),


    (0,0,ti_once,[],[
      (show_object_details_overlay, 0),
      (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
      (get_player_agent_no, ":player"),
      (call_script, "script_advanced_agent_set_speed_modifier", ":player", 0),
      (agent_set_no_death_knock_down_only, ":player", 1),
    ]),

    (0,0,0,[],[
        (store_mission_timer_a, ":cur_time"),
        (set_fixed_point_multiplier, 100),
        (try_begin),
            (ge, ":cur_time", 42),
            (eq, "$tutorial_state", 6),
            (show_object_details_overlay, 1),
            (mission_enable_talk),
            (start_mission_conversation, "trp_claudia"),
            (val_add, "$tutorial_state", 1),
        (else_try),
            (ge, ":cur_time", 38),
            (eq, "$tutorial_state", 5),
            (mission_cam_animate_to_screen_color, 0x00000000, 3000),
            (mission_cam_set_mode, 0, 0, 0),
            # (get_player_agent_no, ":player"),
            # (agent_get_position, pos12, ":player"),
            # (try_for_agents,":agent_no"),
                # (agent_is_alive,":agent_no"),
                # (agent_is_human,":agent_no"),
                # (agent_get_troop_id, ":troop_no", ":agent_no"),
                # (try_begin),
                    # (eq, ":troop_no", "trp_claudia"),
                    # (agent_clear_scripted_mode, ":agent_no"),
                    # (entry_point_get_position, pos11, 6),
                    # (agent_set_position, ":agent_no", pos11),
                    # (agent_set_look_target_position, ":agent_no", pos12),
                # (else_try),
                    # (eq, ":troop_no", "trp_amokos"),
                    # (agent_clear_scripted_mode, ":agent_no"),
                    # (entry_point_get_position, pos11, 5),
                    # (agent_set_position, ":agent_no", pos11),
                    # (agent_set_look_target_position, ":agent_no", pos12),
                # (try_end),
            # (try_end),
            (val_add, "$tutorial_state", 1),
        (else_try),
            (ge, ":cur_time", 34),
            (eq, "$tutorial_state", 4),
            (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
            (val_add, "$tutorial_state", 1),
        (else_try),
            (ge, ":cur_time", 20),
            (eq, "$tutorial_state", 3),
            (init_position, pos9),
            (entry_point_get_position, pos9, 62),
            (mission_cam_animate_to_position, pos9, 17500, 0),
            (val_add, "$tutorial_state", 1),
        (else_try),
            (ge, ":cur_time", 6),
            (eq, "$tutorial_state", 2),
            (play_sound,"snd_thunder_close"),
            (init_position, pos9),
            (entry_point_get_position, pos9, 61),
            (mission_cam_animate_to_position, pos9, 14000, 0),
            (val_add, "$tutorial_state", 1),
        (else_try),
            (ge, ":cur_time", 1),
            (eq, "$tutorial_state", 1),
            (init_position, pos9),
            (entry_point_get_position, pos9, 60),
            (mission_cam_animate_to_position, pos9, 7000, 0),

            # (try_for_agents,":agent_no"),
                # (agent_is_alive,":agent_no"),
                # (agent_is_human,":agent_no"),
                # (agent_get_troop_id, ":troop_no", ":agent_no"),
                # (try_begin),
                    # (eq, ":troop_no", "trp_claudia"),
                    # (entry_point_get_position, pos11, 3),
                    # (agent_set_scripted_destination, ":agent_no", pos11),
                # (else_try),
                    # (eq, ":troop_no", "trp_amokos"),
                    # (entry_point_get_position, pos11, 4),
                    # (agent_set_scripted_destination, ":agent_no", pos11),
                # (try_end),
            # (try_end),

            (val_add, "$tutorial_state", 1),
        (else_try),
            (eq, "$tutorial_state", 0),
            (call_script, "script_save_cam_first_person_mode"),
            (mission_cam_set_mode, 1, 0, 0),
            (set_camera_in_first_person, 0),
            (init_position, pos10),
            (entry_point_get_position, pos10, 59),
            (mission_cam_set_position, pos10),
            (assign, "$tutorial_state", 1),
        (try_end),
    ]),


    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    ambient_scene_play_loop,
    ambient_scene_play_random_sound,

    ],
),
("roman_intro_3", mtf_battle_mode, -1,
    "monasterio",
    [
      (0,mtef_visitor_source,af_override_weapons|af_override_horse,0,1,[]),
      (1,mtef_visitor_source,af_override_all,0,1,[itm_caligea,itm_roman_poor5]),
      (2,mtef_visitor_source,af_override_weapons|af_override_horse,0,1,[]),
      (3,mtef_visitor_source,af_override_weapons|af_override_horse,0,1,[]),
      (4,mtef_visitor_source,af_override_weapons|af_override_horse,0,1,[]),
    ], global_common_triggers +
    [
      cannot_spawn_commoners,
    ###BEGIN THUNDER STORM
        (ti_before_mission_start, 0, 0, [],
        [
            (scene_set_day_time, 24),
            (set_global_cloud_amount, 20),
            (set_global_haze_amount, 100),
            (set_fog_distance, 350, 0xFF6c6c6c),
            # (set_rain, 1, 250),

            (assign, "$tutorial_state", 0),
            #   for testing
            # (scene_set_day_time, 12),
            # (set_global_cloud_amount, 0),
            # (set_global_haze_amount, 0),
        ]),
        (0, 0, ti_once, #preparations 2
        [],
        [
            (assign, "$lightning_cycle", 0),
            (play_sound,"snd_thunder_close"),
            (set_fixed_point_multiplier, 100),
            (get_startup_sun_light, pos20),
            (position_get_x, "$sun_r", pos20),	# r
            (position_get_y, "$sun_g", pos20), # g
            (position_get_z, "$sun_b", pos20),	# b
            (get_startup_ambient_light, pos21),
            (position_get_x, "$amb_r", pos21),	# r
            (position_get_y, "$amb_g", pos21), # g
            (position_get_z, "$amb_b", pos21),	# b
        ]),
        (3, 0.2, 6, 			#lightning 1
        [
            (eq,"$lightning_cycle",0),
            # (store_random_in_range,":chance",0,2),
            # (eq,":chance",1),
            (play_sound,"snd_thunder_close"),
            (set_startup_sun_light, 10000, 10000, 10000),
            (set_startup_ambient_light, 10000, 10000, 10000),
            # (display_message, "@set light 1"),
        ],
        [
            (set_startup_sun_light, 0, 0, 0),
            (set_startup_ambient_light, 0, 0, 0),
            (assign, "$lightning_cycle",1),
            # (display_message, "@set light 2"),
        ]),
        (0.4,0.1, 6,			#lightning 2
        [
            (eq,"$lightning_cycle",1),

            (set_startup_sun_light, 220, 220, 220),
            (set_startup_ambient_light, 220, 220, 220),
            # (display_message, "@set light 3"),
        ],
        [
            (set_startup_sun_light, 1, 1, 1),
            (set_startup_ambient_light, 1, 1, 1),
            (assign,"$lightning_cycle",2),
            # (display_message, "@set light 4"),
        ]),
        (0.5,0.1, 6,			#lightning 3
        [
            (eq,"$lightning_cycle",2),
            (set_startup_sun_light, 150, 150, 150),
            (set_startup_ambient_light, 150, 150, 150),
            # (display_message, "@set light 5"),
        ],
        [
            (set_startup_sun_light, "$sun_r", "$sun_g", "$sun_b"),
            (set_startup_ambient_light, "$amb_r", "$amb_g", "$amb_b"),
            (assign,"$lightning_cycle", 0),
            # (display_message, "@set light 6"),
        ]),
    ###END THUNDER STORM

        common_inventory_not_available,

        (ti_tab_pressed, 0, 0, [
            (display_message,"str_cannot_leave_now")
        ],[
            (set_trigger_result, 0)
        ]),

        (0,0,ti_once,[],
        [
            (show_object_details_overlay, 0),
            (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
        ]),

        (ti_on_agent_spawn,0,0,[
            (store_trigger_param_1, ":agent"),
            (agent_is_active, ":agent"),
            (agent_set_no_death_knock_down_only, ":agent", 1),
            (agent_set_no_dynamics, ":agent", 1),
            (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 0),
        ],[]),

        (0,0,0,[
            (try_for_agents, ":agent"),
                (agent_is_active, ":agent"),
                (agent_set_stand_animation, ":agent", "anim_lie_normal"),
                (agent_set_animation, ":agent", "anim_lie_normal"),
                # (store_random_in_range,":r",0,300),
                # (agent_set_animation_progress,":agent",":r"),
            (try_end),
        ],[]),


        (0,0,0,[],
        [
            (store_mission_timer_a, ":cur_time"),
            (set_fixed_point_multiplier, 100),
            (try_begin),
                (ge, ":cur_time", 16),
                (eq, "$tutorial_state", 3),
                (start_mission_conversation, "trp_antonia"),
                (val_add, "$tutorial_state", 1),
            (else_try),
                (ge, ":cur_time", 12),
                (eq, "$tutorial_state", 2),
                (mission_cam_animate_to_screen_color, 0x00000000, 3000),
                (mission_cam_set_mode, 0, 0, 0),
                (show_object_details_overlay, 1),
                (mission_enable_talk),
                (set_fixed_point_multiplier, 100),
                (try_for_agents, ":agent"),
                    (agent_is_active, ":agent"),
                    (agent_set_stand_animation, ":agent", "anim_lie_normal"),
                    (agent_set_animation, ":agent", "anim_lie_normal"),
                    # (store_random_in_range,":r",0,300),
                    # (agent_set_animation_progress,":agent",":r"),
                    (agent_get_position, pos10, ":agent"),
                    (position_move_z, pos10, -105),
                    (agent_set_position, ":agent", pos10),
                (try_end),
                (val_add, "$tutorial_state", 1),
            (else_try),
                (ge, ":cur_time", 12),
                (eq, "$tutorial_state", 1),
                (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
                (val_add, "$tutorial_state", 1),
            (else_try),
                (eq, "$tutorial_state", 0),
                (call_script, "script_save_cam_first_person_mode"),
                (mission_cam_set_mode, 1, 0, 0),
                (set_camera_in_first_person, 0),
                (init_position, pos10),
                (entry_point_get_position, pos10, 60),
                (mission_cam_set_position, pos10),
                (assign, "$tutorial_state", 1),
            (try_end),
        ]),


        ambient_set_agents_for_sounds,
        ambient_agent_play_sound,

    ],
),

("roman_intro_4", mtf_battle_mode, -1,
    "monasterio",
    [
      (0,mtef_visitor_source,af_override_weapons|af_override_horse,0,1,[]),
      (1,mtef_visitor_source,af_override_all,0,1,[itm_caligea,itm_roman_poor5]),
      (2,mtef_visitor_source,af_override_weapons|af_override_horse,0,1,[]),
      (3,mtef_visitor_source,af_override_weapons|af_override_horse,0,1,[]),
      (4,mtef_visitor_source,af_override_weapons|af_override_horse,0,1,[]),
    ], global_common_triggers +
    [
        cannot_spawn_commoners,
        (ti_before_mission_start, 0, 0, [],
        [
            (scene_set_day_time, 12),
            (set_global_cloud_amount, 20),
            (set_global_haze_amount, 20),
            # (set_rain, 1, 250),

            (assign, "$tutorial_state", 0),
            #   for testing
            # (scene_set_day_time, 12),
            # (set_global_cloud_amount, 0),
            # (set_global_haze_amount, 0),
        ]),


        common_inventory_not_available,

        (ti_tab_pressed, 0, 0, [
            (display_message,"str_cannot_leave_now")
        ],[
            (set_trigger_result, 0)
        ]),

        (0,0,ti_once,[],
        [
            (show_object_details_overlay, 0),
            (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
        ]),

        (ti_on_agent_spawn,0,0,[
            (store_trigger_param_1, ":agent"),
            (agent_is_active, ":agent"),
            (agent_set_no_death_knock_down_only, ":agent", 1),
            (agent_set_no_dynamics, ":agent", 1),
            (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 0),
        ],[]),

        (0,0,0,[
            (try_for_agents, ":agent"),
                (agent_is_active, ":agent"),
                (agent_set_stand_animation, ":agent", "anim_lie_normal"),
                (agent_set_animation, ":agent", "anim_lie_normal"),
                # (store_random_in_range,":r",0,300),
                # (agent_set_animation_progress,":agent",":r"),
            (try_end),
        ],[]),


        (0,0,0,[],
        [
            (store_mission_timer_a, ":cur_time"),
            (set_fixed_point_multiplier, 100),
            (try_begin),
                (ge, ":cur_time", 24),
                (eq, "$tutorial_state", 3),
                (start_mission_conversation, "trp_antonia"),
                (val_add, "$tutorial_state", 1),
            (else_try),
                (ge, ":cur_time", 20),
                (eq, "$tutorial_state", 2),
                (mission_cam_animate_to_screen_color, 0x00000000, 3000),
                (mission_cam_set_mode, 0, 0, 0),
                (show_object_details_overlay, 1),
                (mission_enable_talk),
                (set_fixed_point_multiplier, 100),
                (try_for_agents, ":agent"),
                    (agent_is_active, ":agent"),
                    (agent_set_stand_animation, ":agent", "anim_lie_normal"),
                    (agent_set_animation, ":agent", "anim_lie_normal"),
                    # (store_random_in_range,":r",0,300),
                    # (agent_set_animation_progress,":agent",":r"),
                    (agent_get_position, pos10, ":agent"),
                    (position_move_z, pos10, -105),
                    (agent_set_position, ":agent", pos10),
                (try_end),
                (val_add, "$tutorial_state", 1),
            (else_try),
                (ge, ":cur_time", 15),
                (eq, "$tutorial_state", 1),
                (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
                (val_add, "$tutorial_state", 1),
            (else_try),
                (eq, "$tutorial_state", 0),
                (call_script, "script_save_cam_first_person_mode"),
                (mission_cam_set_mode, 1, 0, 0),
                (set_camera_in_first_person, 0),
                (init_position, pos10),
                (entry_point_get_position, pos10, 60),
                (mission_cam_set_position, pos10),
                (assign, "$tutorial_state", 1),
            (try_end),
        ]),
        ambient_set_agents_for_sounds,
        ambient_agent_play_sound,
    ],
),

("roman_even_fire", mtf_battle_mode,charge,
  "monasterio",[
    (0,mtef_visitor_source,af_override_weapons|af_override_horse,aif_start_alarmed,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,

    (ti_tab_pressed, 0, 0,[
        (eq, "$temp1", 0),

        (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
        (finish_mission, 4),
        (jump_to_menu, "mnu_auto_return_map"),

        (val_add, "$g_unrest", 5),
        (display_message, "@Stability of the Empire decreases", color_bad_news),
        (set_spawn_radius, 10),
        (try_for_range, ":unused", 0, 6),
            (call_script, "script_spawn_party", "p_town_6", "pt_looters"),
            (call_script, "script_spawn_party", "p_town_6", "pt_generic_bandits"),
        (try_end),
        (assign, "$g_fire", 1),
        (try_for_range, ":buildings", walled_center_improvements_begin, walled_center_improvements_end),
            (party_set_slot, "p_town_6",":buildings", 0),
        (try_end),
        (call_script, "script_destroy_center", "p_town_6"),

        (try_begin),
            (troop_slot_eq, "trp_global_variables", g_destroyed_rome, 0),
            (call_script, "script_add_to_troop_wealth", "trp_kingdom_7_lord", -250000),
            (display_message, "@As a reaction to the fire Princeps Nero issued a new edict. See reports for more information."),
            (assign, "$edict4", 1),
        (else_try),
            (call_script, "script_change_player_honor", -100),
            (call_script, "script_change_troop_renown", "trp_player", -500),
            (call_script, "script_change_player_relation_with_center", "p_town_6", -200),
            (call_script, "script_change_senate_support", -100, 0),
        (try_end),

        (try_begin),
            (party_slot_eq, "p_town_6", slot_center_rome_rebuild, 0),
            (party_set_icon, "p_town_6", "icon_town_rome_after_fire"),
        (try_end),
        (call_script, "script_get_event_details", event_fire_of_rome),
        (call_script, "script_change_center_prosperity", "p_town_6", reg1),
        (party_set_slot, "p_town_6", slot_center_event, event_fire_of_rome),
        (assign, "$temp1", 1),
    ],[]),

    (ti_before_mission_start, 0, 0, [],[
        (scene_set_day_time, 0),
        (set_global_cloud_amount, 20),
        (store_random_in_range, ":fog_distance", 300, 315),
        (store_random_in_range, ":haze_power", 30, 35),
        (set_global_haze_amount, ":haze_power"),
        (set_fog_distance, ":fog_distance", 0x333333),

        (assign, "$temp1", 0),
    ]),


    (0, 1.5, ti_once, [],[
        (tutorial_message_set_size, 17, 17),
        (tutorial_message_set_position, 500, 600),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 0),

        (try_begin),
            (troop_slot_eq, "trp_global_variables", g_destroyed_rome, 0),
            (str_store_troop_name, s1, "trp_kingdom_7_lord"),
        (else_try),
            (str_store_troop_name, s1, "trp_player"),
        (try_end),

        (tutorial_message,
        "@Fires are common in Rome, but today the greatest fire in history struck the eternal city. This disaster lasted for six days and destroyed nearly the entire city, killing thousands and thousands of people."
        +" Rumors spread {s1} has ordered to set the fire! Other say the gods have rage against Rome. Still others accuse the Christians of setting the fire."+
        " To counter the rumors, {s1} also accuses the Christians of arson!^^Press tab to leave.",
        0x000000),
    ]),

    deactivate_player_agent,

    (0,0,ti_once,[],[
        (set_fixed_point_multiplier, 100),
        (assign, ":counter", 0),
        (try_for_prop_instances, ":curr_instance", -1, somt_object),
            (le, ":counter", 1),	#not more then 60 part sys, now 25 since people get performance issues
            (store_random_in_range, ":rand", 0, 100),
            (le, ":rand", 50),
            (prop_instance_get_scene_prop_kind, ":scene_prop_kind", ":curr_instance"),
            (eq, ":scene_prop_kind", "spr_b_house3_t1"),
            (val_add, ":counter", 1),
            (store_random_in_range, ":rand23", -150, 150),
            (position_set_x, pos1, ":rand23"),
            (store_random_in_range, ":rand23", -150, 150),
            (position_set_y, pos1, ":rand23"),
            (store_random_in_range, ":rand23", 50, 150),
            (position_set_z, pos1, ":rand23"),
            (prop_instance_add_particle_system, ":curr_instance", "psys_vulcan_fire_gigantic", pos1),
            (position_move_z, pos1, 100),
            (prop_instance_add_particle_system, ":curr_instance", "psys_vulcan_fire_gigantic_smoke", pos1),
        (try_end),

        (assign, ":counter", 0),
        (try_for_prop_instances, ":curr_instance", -1, somt_object),
            (le, ":counter", 1),	#not more then 60 part sys, now 25 since people get performance issues
            (store_random_in_range, ":rand", 0, 100),
            (le, ":rand", 80),
            (prop_instance_get_scene_prop_kind, ":scene_prop_kind", ":curr_instance"),
            (eq, ":scene_prop_kind", "spr_b_house1_t1"),
            (val_add, ":counter", 1),
            (store_random_in_range, ":rand23", -150, 150),
            (position_set_x, pos1, ":rand23"),
            (store_random_in_range, ":rand23", -150, 150),
            (position_set_y, pos1, ":rand23"),
            (store_random_in_range, ":rand23", 50, 150),
            (position_set_z, pos1, ":rand23"),
            (prop_instance_add_particle_system, ":curr_instance", "psys_vulcan_fire_gigantic", pos1),
            (position_move_z, pos1, 100),
            (prop_instance_add_particle_system, ":curr_instance", "psys_vulcan_fire_gigantic_smoke", pos1),
        (try_end),

        (assign, ":counter", 0),
        (try_for_prop_instances, ":curr_instance", -1, somt_object),
            (le, ":counter", 2),	#not more then 60 part sys, now 25 since people get performance issues
            (store_random_in_range, ":rand", 0, 100),
            (le, ":rand", 90),
            (prop_instance_get_scene_prop_kind, ":scene_prop_kind", ":curr_instance"),
            (this_or_next|eq, ":scene_prop_kind", "spr_b_templesevulus2_t1"),
            (eq, ":scene_prop_kind", "spr_b_templesevulus_t1"),
            (val_add, ":counter", 1),
            (store_random_in_range, ":rand23", -150, 150),
            (position_set_x, pos1, ":rand23"),
            (store_random_in_range, ":rand23", -150, 150),
            (position_set_y, pos1, ":rand23"),
            (store_random_in_range, ":rand23", 50, 150),
            (position_set_z, pos1, ":rand23"),
            (prop_instance_add_particle_system, ":curr_instance", "psys_village_fire_big", pos1),
            (position_move_z, pos1, 100),
            (prop_instance_add_particle_system, ":curr_instance", "psys_village_fire_smoke_big", pos1),
        (try_end),

        (call_script, "script_save_cam_first_person_mode"),
        (mission_cam_set_mode, 1, 0, 0),
        (set_camera_in_first_person, 0),
        (init_position, pos10),
        (entry_point_get_position, pos10, 0),
        (position_get_z, ":z", pos10),
        (val_mul, ":z", 3),
        (position_set_z, pos10, ":z"),
        (mission_cam_set_position, pos10),
    ]),
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    ambient_scene_play_loop,
    ambient_scene_play_random_sound,
]),

("viking_duel_normal",mtf_battle_mode|mtf_commit_casualties,-1,
  "Prepare to duel.",[
    (0, mtef_visitor_source|mtef_team_0, af_override_horse, aif_start_alarmed, 1, []), #player start
    (1, mtef_visitor_source|mtef_team_2, af_override_horse, aif_start_alarmed, 1, []), #opponent start
    (2, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []), #start enemy spectators
    (3, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
    (4, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
    (5, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
    (6, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
    (7, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []), #start friendly spectators
    (13, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
    (14, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
    (15, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
    (16, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    common_inventory_not_available,

    (1,0,3,[
      (this_or_next|main_hero_fallen),
      (num_active_teams_le,3),
    ],[
      (try_for_agents,":cur_agent"),
        (agent_is_alive,":cur_agent"),
        (agent_is_human,":cur_agent"),
        (agent_get_team, ":agent_team", ":cur_agent"),
        (try_begin),
          (eq,":agent_team", 1),
          (main_hero_fallen),
          (agent_set_animation, ":cur_agent", "anim_cheer"),
          (play_sound, "snd_man_yell"),
        (else_try),
          (eq,":agent_team",3),
          (neg|main_hero_fallen),
          (agent_set_animation, ":cur_agent", "anim_cheer"),
          (play_sound, "snd_man_victory"),
        (try_end),
      (try_end),
    ]),
    # (14, 0, ti_once, [],[
    #   (get_player_agent_no, ":player"),
    #   (agent_set_damage_modifier,":player",50),
    # ]),
    (ti_tab_pressed, 0, 0, [
      (display_message, "str_cannot_leave_now"),
    ],[]),
    (ti_before_mission_start, 0, 0, [], 	[	#(call_script, "script_change_banners_and_chest"),
      (team_set_relation, 0, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
      (team_set_relation,1,3,0),
      (team_set_relation,0,1,0),
      (team_set_relation,0,3,0),
      (team_set_relation,2,1,0),
      (team_set_relation,2,3,0),
    ]),
    (0, 0, ti_once, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_arena),
    ]),
    (1, 8, ti_once, [
      (this_or_next|main_hero_fallen),
      (all_enemies_defeated, 5),
      #(eq, "$cam_mode", 0),
    ],[
      (try_begin),
        (check_quest_active, "qst_slave_revolt"),
        (quest_slot_eq,"qst_slave_revolt",slot_quest_current_state, 2),#orm quest
        (quest_set_slot,"qst_slave_revolt",slot_quest_current_state, 3),
        (try_begin),
          (main_hero_fallen),
          (assign, "$temp", 2),
          (jump_to_menu, "mnu_death_waits"),
        (else_try),
          (call_script, "script_play_victorious_sound"),
          (jump_to_menu,"mnu_duel_win"),	#recompensa armas de orm y dinero de Ulf
        (try_end),
      (else_try),
        (check_quest_active, "qst_werdheri"),
        (quest_slot_eq, "qst_werdheri", slot_quest_current_state, 2),#orm quest
        (quest_set_slot,"qst_werdheri", slot_quest_current_state, 3),
        (try_begin),
          (main_hero_fallen),
          (jump_to_menu, "mnu_werdheri_duel_lost"),
        (else_try),
          (call_script, "script_play_victorious_sound"),
          (jump_to_menu, "mnu_werdheri_duel_won"),	#recompensa armas de orm y dinero de Ulf
        (try_end),
      (else_try),
        (neg|check_quest_active, "qst_werdheri"),
        (neg|check_quest_active, "qst_slave_revolt"),
        (try_begin),
          (main_hero_fallen),
          (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
          (assign, "$auto_menu", "mnu_freelancer_event_10_defeat"),
          (jump_to_menu, "mnu_auto_return_map"),
        (else_try),
          (call_script, "script_play_victorious_sound"),
          (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
          (assign, "$auto_menu", "mnu_freelancer_event_10_victory"),
          (jump_to_menu, "mnu_auto_return_map"),
        (try_end),
      (try_end),
      (stop_all_sounds),
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      (finish_mission, 4),
    ]),
]),

("pygmachia",mtf_battle_mode,-1,
  "Prepare to duel.",[
    (0, mtef_visitor_source, 0, 0, 1, []), #player start
    (1, mtef_visitor_source, 0, 0, 1, []), #player start
    (2, mtef_visitor_source, 0, 0, 1, []), #player start
    (3, mtef_visitor_source, 0, 0, 1, []), #player start
    (4, mtef_visitor_source, 0, 0, 1, []), #player start
    (5, mtef_visitor_source, 0, 0, 1, []), #player start
    (6, mtef_visitor_source, 0, 0, 1, []), #player start
    (7, mtef_visitor_source, 0, 0, 1, []), #player start
    (8, mtef_visitor_source, 0, 0, 1, []), #player start
    (9, mtef_visitor_source, 0, 0, 1, []), #player start
    (10, mtef_visitor_source, 0, 0, 1, []), #player start
    (11, mtef_visitor_source, 0, 0, 1, []), #player start
    (12, mtef_visitor_source, 0, 0, 1, []), #player start
    (13, mtef_visitor_source, 0, 0, 1, []), #player start
    (14, mtef_visitor_source, 0, 0, 1, []), #player start
    (15, mtef_visitor_source, 0, 0, 1, []), #player start
    (16, mtef_visitor_source, 0, 0, 1, []), #player start
    (17, mtef_visitor_source, 0, 0, 1, []), #player start
    (18, mtef_visitor_source, 0, 0, 1, []), #player start
    (19, mtef_visitor_source, 0, 0, 1, []), #player start
    (20, mtef_visitor_source, 0, 0, 1, []), #player start
    (21, mtef_visitor_source, 0, 0, 1, []), #player start
    (22, mtef_visitor_source, 0, 0, 1, []), #player start
    (23, mtef_visitor_source, 0, 0, 1, []), #player start
    (24, mtef_visitor_source, 0, 0, 1, []), #player start
    (25, mtef_visitor_source, 0, 0, 1, []), #player start
    (26, mtef_visitor_source, 0, 0, 1, []), #player start
    (27, mtef_visitor_source, 0, 0, 1, []), #player start
    (28, mtef_visitor_source, 0, 0, 1, []), #player start
    (29, mtef_visitor_source, 0, 0, 1, []), #player start
    (30, mtef_visitor_source|mtef_team_0, af_override_everything|af_override_foot, aif_start_alarmed, 1, []), #player start
    (31, mtef_visitor_source|mtef_team_2, af_override_everything|af_override_foot, aif_start_alarmed, 1, []), #opponent start
    (32, mtef_team_1|mtef_visitor_source, 0, 0, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, 0, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, 0, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, 0, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, 0, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, 0, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, 0, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, 0, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, 0, 1, []),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    common_inventory_not_available,
      ( 1,0,3,[	(this_or_next|main_hero_fallen),
          (num_active_teams_le,2),],

        [(try_for_agents,":cur_agent"),
            (agent_is_alive,":cur_agent"),
            (agent_is_human,":cur_agent"),
            (agent_get_troop_id, ":troop",":cur_agent"),
            (try_begin),
              (main_hero_fallen),
              (try_begin),
                (call_script, "script_cf_dplmc_troop_is_female", ":troop"),
                (agent_play_sound,":cur_agent", "snd_woman_yell"),
              (else_try),
                (agent_play_sound,":cur_agent", "snd_man_yell"),
              (try_end),
            (else_try),
              (neg|main_hero_fallen),
              (try_begin),
                (call_script, "script_cf_dplmc_troop_is_female", ":troop"),
                (agent_play_sound,":cur_agent", "snd_woman_victory"),
              (else_try),
                (agent_play_sound,":cur_agent", "snd_man_victory"),
              (try_end),
            (try_end),
            (agent_set_animation, ":cur_agent", "anim_cheer"),
          (try_end),
        ]),
    (ti_tab_pressed, 0, 0, [	(this_or_next|main_hero_fallen),
          (num_active_teams_le,2),],[(display_message, "str_cannot_leave_now"),]),

    (ti_tab_pressed, 0, 0,
    [(neg|main_hero_fallen),(neg|num_active_teams_le,2),],[  (question_box,  "@Do you wish to give up?^You will lose the competition."),]),

##leave2
    (ti_question_answered, 0, 0,
    [],
    [
    (store_trigger_param_1, ":number"),
    (eq, ":number", 0),
    (stop_all_sounds),
    (store_current_hours, ":hours"),
    (troop_set_slot, "trp_organiser", rest_olympia, ":hours"),
    (troop_set_slot, "trp_organiser", olympia_auto_menu, "mnu_pygmachia_defeat"),
    (jump_to_menu, "mnu_auto_return_map"),
    (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, [], 	[
      (team_set_relation, 0, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
      (team_set_relation,1,3,0),
      (team_set_relation,0,1,0),
      (team_set_relation,0,3,0),
      (team_set_relation,2,1,0),
      (team_set_relation,2,3,0),
    ]),
      (0, 0, ti_once, [],
        [
          (call_script, "script_music_set_situation_with_culture", mtf_sit_arena),
      ]),
      (1, 8, ti_once, [
    (this_or_next|main_hero_fallen),
    (num_active_teams_le,2),
        ],
        [
          (try_begin),
            (main_hero_fallen),
            (assign, ":menu", "mnu_pygmachia_defeat"),
          (else_try),
            (assign, ":menu", "mnu_pygmachia_won"),
            (add_xp_as_reward, 150),
          (try_end),

            (store_current_hours, ":hours"),
            (troop_set_slot, "trp_organiser", rest_olympia, ":hours"),
            (troop_set_slot, "trp_organiser", olympia_auto_menu, ":menu"),
            (jump_to_menu, "mnu_auto_return_map"),

          (stop_all_sounds),
          (mission_cam_animate_to_screen_color, 0xFF000000, 1000),
          (finish_mission,4),
      ]),

      (0, 0, ti_once, [
        ],
        [#get your opponents id
        (try_for_agents,":cur_agent"),
            (agent_is_alive,":cur_agent"),
            (agent_is_human,":cur_agent"),
            (agent_get_entry_no, ":entry", ":cur_agent"),
            (eq, ":entry",31),
            (agent_get_troop_id, "$g_tournament_player_team_won", ":cur_agent"),
        (try_end),
      ]),
    ],
),

("senate_meeting",0,-1,
    "You will fight a match in the holmgang.",
    [
      (0, mtef_scene_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #player start
      (1, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []), #opponent start
      (2, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []), #opponent start
      (3, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []), #opponent start
      (4, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []), #opponent start
      (5, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (6, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (7, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (8, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (9, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (10, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (11, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (12, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (13, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (14, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (15, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (16, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (17, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (18, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (19, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (20, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (21, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (22, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (23, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (24, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (25, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (26, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (27, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (28, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (29, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (30, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (31, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (32, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (33, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (34, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (35, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (36, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (37, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (38, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (39, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (40, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (41, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (42, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (43, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (44, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (45, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (46, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (47, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (48, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (49, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (50, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (51, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (52, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (53, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (54, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (55, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (56, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start

     ], global_common_triggers + vc_menu +
     [
      cannot_spawn_commoners,
      (ti_inventory_key_pressed, 0, 0,[
        (set_trigger_result,1)
      ],[]),

  (ti_before_mission_start, 0, 0, [ ],
   [
   (play_track, 0, 2),
     ]),
      ambient_set_agents_for_sounds,
      ambient_agent_play_sound,
(
  0, 0, ti_once, [],
  [
    (eq, "$temp", 1),
    (call_script, "script_music_set_situation_with_culture", mtf_sit_multiplayer_fight),
    ]),

  (2,0,ti_once,[],
  [
  (neq, "$temp", 1),
  (store_random_in_range, ":rand", 0, 2),
  (assign, ":spawn_troop", "trp_slave"),
	(try_begin),
		(eq, ":rand", 1),
		(assign, ":spawn_troop", "trp_senator"),
	(try_end),
  (add_visitors_to_current_scene, 52, ":spawn_troop", 1, 1, 0),
  ]
  ),
      (1, 0, ti_once, [],
      [
      #turn fraction of senate support into actual number of senators supporting the player
      (eq,"$temp",1),
      (troop_get_slot, reg1, "trp_senator_dummy", slot_senate_support),
      (store_mul, ":counter", "$temp2",reg1),#0 to 4000
      (val_add, ":counter", 50),
      (val_div, ":counter", 100), ##
      (assign, reg1, "$temp2"),

      (assign,reg2,0),
      (try_for_agents, ":agent_no"),
        (agent_get_troop_id, ":troop", ":agent_no"),
        (eq, ":troop", "trp_senator"),
        (ge, ":counter", 1),
        (agent_set_slot, ":agent_no", slot_agent_courage_score, 1),
        (val_sub, ":counter", 1),
        (val_add, reg2, 1),
      (try_end),

      (display_message, "@{reg2} of {reg1} senators support you in this meeting.", message_alert),
        ]),

      (ti_after_mission_start, 0, ti_once, [],[
            (mission_cam_set_screen_color, 0xFF736252), #roughly the colour of the menu bg
            (mission_cam_animate_to_screen_color, 0x00736252, 1500),
        ]),


  (7, 0, 0, [],
   [
       (eq, "$temp", 1),
       (play_track, "track_senate", 2),
     ]),


      (0,4,0,[],
        [
        (neq, "$temp", 1),
          (try_for_agents,":agent_no"),
            (agent_is_alive,":agent_no"),
            (agent_is_human,":agent_no"),
            (agent_get_troop_id, ":troop_no", ":agent_no"),
            (this_or_next|eq, ":troop_no", "trp_slave"),
            (eq, ":troop_no", "trp_senator"),

            (assign, ":continue_walk", 0),
            (store_random_in_range, ":continue_walk", 1, 100),
            (try_begin),
              (le, ":continue_walk", 50),
              (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
              (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
              (agent_set_animation, ":agent_no", "anim_stand_man"),
              (agent_set_animation_progress, ":agent_no", 10),

              (agent_get_position, pos1, ":agent_no"),
              (store_random_in_range, ":r", 0, 4),
              (try_begin),
                (eq, ":r", 1),
                (assign, ":points", 0),
              (else_try),
                (eq, ":r", 2),
                (assign, ":points", 51),
              (else_try),
                (assign, ":points", 50),
              (try_end),
              (entry_point_get_position, pos2, ":points"),
              (agent_set_speed_limit, ":agent_no", 1),
              (agent_set_scripted_destination, ":agent_no", pos2),
            (try_end),
          (try_end),
      ]),

     (0,0,ti_once, [],
    [
    (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (call_script, "script_init_town_agent", ":agent_no"),
        (eq, "$temp", 1),
        (agent_get_troop_id, ":troop", ":agent_no"),
        (try_begin),
          (eq, ":troop", "trp_senator"),
          (agent_set_slot, ":agent_no", slot_agent_courage_score, 0),
          (store_random_in_range, ":r", 40, 104),
          (troop_get_slot, ":relation", "p_town_6", slot_center_player_relation),
          (val_mul, ":relation", -1),
          (val_add, ":relation", 100),
          (val_mul, ":relation", 40),

          (troop_get_slot, ":renown", "trp_player", slot_troop_renown),
          (val_div, ":renown", 10),
          (val_clamp, ":renown", 1, 101),
          (val_mul, ":renown", -1),
          (val_add, ":renown", 102),
          (val_mul, ":r", ":renown"),
          (val_add, ":r", ":relation"),
          (agent_set_slot, ":agent_no", slot_agent_fatiga, ":r"),
          (val_add, "$temp2", 1),#stores number of senators which are spawned

          (agent_set_stand_animation, ":agent_no", "anim_senator_listen"),
          (agent_set_animation, ":agent_no", "anim_senator_listen"),
          (store_random_in_range,":r",0,300),
          (agent_set_animation_progress,":agent_no",":r"),
        (else_try),
          (eq, ":troop", "trp_senator_dummy"),
          (agent_set_stand_animation, ":agent_no", "anim_senator_speak"),
          (agent_set_animation, ":agent_no", "anim_senator_speak"),
          (store_random_in_range,":r",0,300),
          (agent_set_animation_progress,":agent_no",":r"),
        (try_end),
    (try_end),
    ]),



      (ti_tab_pressed, 0, 0, [
          # (try_begin),
             # (eq,"$temp",1),
             # (ge, "$temp3", 1),
             # (call_script, "script_change_senate_support", "$temp3",1),
          # (try_end),
        (stop_all_sounds),
        (try_begin),
            (eq, "$temp4", 1),
            (jump_to_menu, "mnu_debate_in_senat_2"),
            (troop_get_slot, "$temp", "trp_senator_dummy", slot_senate_backup1),##get back the back up for temp variables
            (troop_get_slot, "$temp2", "trp_senator_dummy", slot_senate_backup2),
            (troop_get_slot, "$temp3", "trp_senator_dummy", slot_senate_backup3),
            (troop_get_slot, "$temp4", "trp_senator_dummy", slot_senate_backup4),
            (finish_mission),
        (else_try),
            (jump_to_menu, "mnu_senatus"),
            (finish_mission),
            # (assign, "$vc_menu_active", "prsnt_senate"),
        (try_end),
      ],[]),

      # (0, 0, 0,[(key_clicked, key_k),
          # (tutorial_message, -1),
          # ],[]),
	  # (1,0.5,ti_once,[
      # (eq,"$temp",1),
      # (neg|conversation_screen_is_active),
      # (eq, "$vc_menu_active", 0),
      # ],
		# [
        # (tutorial_message_set_size, 19, 19),
        # (tutorial_message_set_position, 500, 650),
        # (tutorial_message_set_center_justify, 0),
        # (tutorial_message_set_background, 1),
        # (tutorial_message, "@ You can try to bribe senators by talking with them.^^(press K to finish read)"),]),

##end of the mission
]),

("senate_cuttscene",0,-1,
    "You will fight a match in the holmgang.",
    [
      (0, mtef_visitor_source|mtef_team_0, af_override_everything, 0, 1, [itm_caligea,itm_roman_rich3,itm_laurel_gold]), #player start
      (1, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []), #opponent start
      (2, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []), #opponent start
      (3, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []), #opponent start
      (4, mtef_visitor_source|mtef_team_0, af_override_horse, 0, 1, []), #opponent start
      (5, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (6, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (7, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (8, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (9, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (10, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (11, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (12, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (13, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (14, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (15, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (16, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (17, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (18, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (19, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (20, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (21, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (22, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (23, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (24, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (25, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (26, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (27, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (28, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (29, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (30, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (31, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (32, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (33, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (34, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (35, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (36, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (37, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (38, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (39, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (40, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (41, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (42, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (43, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (44, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (45, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (46, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (47, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (48, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (49, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (50, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (51, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (52, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (53, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (54, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (55, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (56, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (57, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (58, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (59, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (60, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (61, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (62, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (63, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start
      (64, mtef_visitor_source|mtef_team_0, af_override_horse|af_override_weapons, 0, 1, []), #opponent start

    ], global_common_triggers +
    [
      cannot_spawn_commoners,
  (ti_before_mission_start, 0, 0, [ ],
   [
    (assign, "$tutorial_state", 0),
    (play_track, "track_triumph_track", 1),
     ]),

      (ti_after_mission_start, 0, ti_once, [],[
            (mission_cam_set_screen_color, 0xFF736252), #roughly the colour of the menu bg
            (mission_cam_animate_to_screen_color, 0x00736252, 1500),
            (show_object_details_overlay, 0),
        ]),

      (0,0,ti_once,[],
        [
            (try_for_agents, ":agent_no"),
              (agent_get_troop_id, ":id", ":agent_no"),
              (eq, ":id", "trp_pseudo_troop_end"),
              (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
              (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
              (agent_set_animation, ":agent_no", "anim_stand_man"),
              (agent_set_animation_progress, ":agent_no", 10),

              (entry_point_get_position, pos2, 62),
              (agent_set_speed_limit, ":agent_no", 1),
              (agent_set_scripted_destination, ":agent_no", pos2),
              (assign, "$temp3", ":agent_no"),
            (try_end),
      ]),

     (0,0,ti_once, [],
    [
    (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (call_script, "script_init_town_agent", ":agent_no"),
        (agent_get_troop_id, ":troop", ":agent_no"),
        (try_begin),
          (eq, ":troop", "trp_senator"),
          (agent_set_no_dynamics, ":agent_no", 1),
          (agent_set_stand_animation, ":agent_no", "anim_senator_listen"),
          (agent_set_animation, ":agent_no", "anim_senator_listen"),
          (store_random_in_range,":r",0,300),
          (agent_set_animation_progress,":agent_no",":r"),
        (try_end),
    (try_end),
    ]),

      (ti_tab_pressed, 0, 0, [
        (display_message, "str_cannot_leave_now"),
      ],[]),

      (0, 0, ti_once, [],[
          (tutorial_message_set_size, 15, 15),
          (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
          (tutorial_message_set_center_justify, 0),
      ]),

      (0,0,0,[
        ],
        [
          (store_mission_timer_a, ":cur_time"),
          (set_fixed_point_multiplier, 100),
          (try_begin),
            (ge, ":cur_time", 51),
            (eq, "$tutorial_state", 11),
            (stop_all_sounds, 1),
            (show_object_details_overlay,1),
            (finish_mission),
            (jump_to_menu, "mnu_senatus"),
            (val_add, "$tutorial_state", 1),
          (else_try),
            (ge, ":cur_time", 44),
            (eq, "$tutorial_state", 10),
            (tutorial_message, -1),
            (tutorial_message_set_background, 0),
            (mission_cam_set_screen_color, 0x00FFFFFF),
            (mission_cam_animate_to_screen_color, 0xFFFFFFFF, 3000),
            (val_add, "$tutorial_state", 1),
          (else_try),
            (ge, ":cur_time", 40),
            (eq, "$tutorial_state", 9),
            (init_position, pos9),
            (entry_point_get_position, pos9, 54),
            (mission_cam_animate_to_position, pos9, 8000, 0),
            (val_add, "$tutorial_state", 1),
          (else_try),
            (ge, ":cur_time", 32),
            (eq, "$tutorial_state", 8),
            (init_position, pos9),
            (entry_point_get_position, pos9, 56),
            (mission_cam_animate_to_position, pos9, 8000, 0),
            (val_add, "$tutorial_state", 1),
          (else_try),
            (ge, ":cur_time", 24),
            (eq, "$tutorial_state", 7),
            (init_position, pos9),
            (entry_point_get_position, pos9, 55),
            (mission_cam_animate_to_position, pos9, 8000, 0),
            (val_add, "$tutorial_state", 1),
          (else_try),
            (ge, ":cur_time", 19),
            (eq, "$tutorial_state", 6),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@'Smart as Odysseus, strong as Heracles! Your father, Jupiter, gifted you with many skills!\
 May your reign lead Rome to Glory, Power and Wealth! We have high hopes in your rule and I am sure, we will not be disappointed!'"),
            (val_add, "$tutorial_state", 1),
          (else_try),
            (ge, ":cur_time", 18),
            (eq, "$tutorial_state", 5),
            (tutorial_message_set_background, 0),
            (tutorial_message, -1),
            (val_add, "$tutorial_state", 1),
          (else_try),
            (ge, ":cur_time", 11),
            (eq, "$tutorial_state", 4),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@'You, son of Jupiter, are the only true Caesar and divine Augustus!'"),
            (val_add, "$tutorial_state", 1),
          (else_try),
            (ge, ":cur_time", 10),
            (eq, "$tutorial_state", 3),
            (tutorial_message_set_background, 0),
            (tutorial_message, -1),
            # (set_fixed_point_multiplier, 100),
            (init_position, pos9),
            (entry_point_get_position, pos9, 54),
            (mission_cam_animate_to_position, pos9, 10000, 0),
            (val_add, "$tutorial_state", 1),
          (else_try),
            (ge, ":cur_time", 3),
            (eq, "$tutorial_state", 2),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@Speaker: 'Today! We, the people of Rome, accept you as Princeps and divine Caesar!'"),
            (val_add, "$tutorial_state", 1),
          (else_try),
            (ge, ":cur_time", 2),
            (eq, "$tutorial_state", 1),
            # (mission_cam_set_mode, 1, 0, 0),
            # (set_camera_in_first_person, 0),
            (init_position, pos9),
            (entry_point_get_position, pos9, 53),
           # (mission_cam_set_position, pos9),
            (mission_cam_animate_to_position, pos9, 7000, 0),
            (val_add, "$tutorial_state", 1),
          (else_try),
            (eq, "$tutorial_state", 0),
            (call_script, "script_save_cam_first_person_mode"),
            (mission_cam_set_mode, 1, 0, 0),
            (set_camera_in_first_person, 0),
            (init_position, pos10),
            (entry_point_get_position, pos10, 0),
            (position_get_z, ":z", pos10),
            (val_mul, ":z", 4),
            (position_set_z, pos10, ":z"),
          #  (mission_cam_set_target_agent, "$temp3", 0),
            (mission_cam_set_position, pos10),
            (assign, "$tutorial_state", 1),
          (try_end),
    ]),

##end of the mission
]),
##new horse races
("horse_racing", mtf_battle_mode, -1,
  "horse races yay",[
    (0, mtef_team_0|mtef_scene_source, af_override_everything, 0, 1, [itm_parthian_horse_a,itm_caligea,itm_roman_poor1]),
    (1, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    ##horse racers
    (8, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_parthian_horse_a,itm_caligea,itm_roman_poor1]),
    (9, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_parthian_horse_a,itm_caligea,itm_roman_poor1]),
    (10, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_parthian_horse_a,itm_caligea,itm_roman_poor1]),
    (11, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_parthian_horse_a,itm_caligea,itm_roman_poor1]),
    (12, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_parthian_horse_a,itm_caligea,itm_roman_poor1]),
    (13, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_parthian_horse_a,itm_caligea,itm_roman_poor1]),
    (14, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_parthian_horse_a,itm_caligea,itm_roman_poor1]),
    (15, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_parthian_horse_a,itm_caligea,itm_roman_poor1]),
    #rest
    (16, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (32, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (33, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (34, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (35, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (36, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (37, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (38, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (39, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (40, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (41, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (42, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (43, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (44, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (45, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (46, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (47, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (48, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (49, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (50, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (51, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (52, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (53, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (54, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (55, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (56, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (57, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (58, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (59, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (60, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (61, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (62, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (63, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (64, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (65, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (66, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (67, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (68, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (69, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (70, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (71, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (72, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (73, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (74, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (75, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (76, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (77, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
  ], global_common_triggers + p_wetter +
  [
    cannot_spawn_commoners,
    improved_lightning,
    wounds_vc,

    (ti_before_mission_start, 0, 0,[
      (troop_slot_eq, "trp_organiser", olympia_easter_egg, 0),
    ],[
      (call_script, "script_remove_easter_eggs"),
    ]),
    ##init list
    (ti_before_mission_start, 0, 0,[],[
      (play_sound, "snd_arena_ambiance", sf_looping),
      (call_script, "script_music_set_situation_with_culture", mtf_sit_thermae),
      (assign, "$temp", -1),
      (assign, "$temp_2", 0),
      (assign, "$temp_3", 999999),
      (try_for_range, ":slot", 0, 49),
        (troop_set_slot, "trp_temp_array_olympia_a", ":slot", -1),
      (try_end),
    ]),

    (1, 2, ti_once,[
      (lt, "$temp_3", 0),
    ],[
      (stop_all_sounds),
      (assign, ":menu",  -1),
      (try_begin),
          (eq, "$temp4_1", 1),
          (eq, "$g_tournament_player_team_won", "trp_player"),
          (assign, ":menu", "mnu_town_tournament_won"),
      (else_try),
          (eq, "$temp4_1", 1),
          (assign, ":menu", "mnu_town_race_won_by_another"),
      (else_try),
          (eq, "$g_tournament_player_team_won", "trp_player"),
          (assign, ":menu", "mnu_running_race_one"),
      (else_try),
          (assign, ":menu", "mnu_running_race_one_by_another"),
      (try_end),
      (gt, ":menu",  -1),
      #(jump_to_menu, ":menu"),
      (store_current_hours, ":hours"),
      (troop_set_slot, "trp_organiser", rest_olympia, ":hours"),
      (troop_set_slot, "trp_organiser", olympia_auto_menu, ":menu"),
      (jump_to_menu, "mnu_auto_return_map"),
      (mission_cam_animate_to_screen_color, 0xFF000000, 1000),
      (finish_mission, 4),
    ]),
    ##leave1
    (ti_tab_pressed, 0, 0,[
      (lt, "$temp_3", 0),
    ],[
      (display_message, "str_cannot_leave_now"),
    ]),

    (ti_tab_pressed, 0, 0,[
      (ge, "$temp_3", 0),
    ],[
      (try_begin),
        (eq, "$temp4_1", 1),
        (str_store_string, s11, "@Do you wish to give up?^All the money you have bet will be lost."),
      (else_try),
        (str_store_string, s11, "@Do you wish to give up?^You will lose the competition."),
      (try_end),
      (question_box, s11),
    ]),
    ##leave2
    (ti_question_answered, 0, 0,[],[
      (store_trigger_param_1, ":number"),
      (eq, ":number", 0),
      (stop_all_sounds),
      (assign, ":menu",  -1),
      (try_begin),
        (eq, "$temp4_1", 1),
        (assign, ":menu",  "mnu_town"),
      (else_try),
        (try_for_range, ":slot", 1, 8),
            (troop_slot_ge, "trp_temp_array_olympia_b", ":slot", 1),
            (troop_get_slot, "$g_tournament_player_team_won", "trp_temp_array_olympia_b", ":slot"),
        (try_end),
        # (store_current_hours, ":hours"),
        # (troop_set_slot, "trp_organiser", rest_olympia, ":hours"),
        # (troop_set_slot, "trp_organiser", olympia_auto_menu, "mnu_running_race_one_by_another"),
        (assign, ":menu",  "mnu_running_race_one_by_another"),
      (try_end),
      #(call_script, "script_add_notification_menu", ":menu", 0,0),
      (gt, ":menu",  -1),
      #(jump_to_menu, ":menu"),
      (store_current_hours, ":hours"),
      (troop_set_slot, "trp_organiser", rest_olympia, ":hours"),
      (troop_set_slot, "trp_organiser", olympia_auto_menu, ":menu"),
      (jump_to_menu, "mnu_auto_return_map"),
      (finish_mission),
    ]),
    ###race start
    (0.3, 0, 0,[
      (try_begin),
          (eq, "$temp", -1),
          (str_clear, s1),
          (assign, reg1, 1),
          (try_for_range, ":slot", 0, 8),
            (troop_get_slot, ":troop", "trp_temp_array_olympia_b", ":slot"),
            (ge, ":troop", 0),
            (str_store_troop_name, s2, ":troop"),
            (str_store_string, s1, "@{s1}^^Number {reg1}:  {s2} "),
            (val_add, reg1, 1),
          (try_end),
          (str_store_string, s1, "@Participants list:^^^{s1}^^^<<   Press 'K' to start the race!   >>"),
          (tutorial_message_set_size, 17, 17),
          (tutorial_message_set_position, 500, 600),
          (tutorial_message_set_center_justify, 0),
          (tutorial_message_set_background, 0),
          (tutorial_message, "@{s1}", 0x000000),

          (get_player_agent_no, ":agent_player"),
          (try_begin),
            (agent_get_horse, ":horse", ":agent_player"),
            (agent_is_active, ":horse"),
            (agent_is_alive, ":horse"),
            (set_fixed_point_multiplier, 100),
            (agent_set_position, ":horse", pos40),
          (else_try),
            (set_fixed_point_multiplier, 100),
            (agent_set_position, ":agent_player", pos40),
          (try_end),
      (else_try),
          (ge, "$temp_3", 0),
          (ge, "$temp", 1),
          (get_player_agent_no, ":player"),
          (try_begin),
              (agent_slot_ge, ":player", slot_agent_race_state, 20),
              (str_store_string, s1, "@final round"),
          (else_try),
              (agent_slot_ge, ":player", slot_agent_race_state, 10),
              (try_begin),
                  (eq, "$temp4", 1),
                  (str_store_string, s1, "@final round"),
              (else_try),
                  (str_store_string, s1, "@2nd round"),
              (try_end),
          (else_try),
              (agent_slot_ge, ":player", slot_agent_race_state, 0),
              (try_begin),
                  (eq, "$temp4", 2),
                  (str_store_string, s1, "@first and final round"),
              (else_try),
                  (this_or_next|eq, "$temp4", 1),
                  (eq, "$temp4", 0),
                  (str_store_string, s1, "@1st round"),
              (try_end),
          (try_end),
          (tutorial_message_set_size, 22, 22),
          (tutorial_message_set_position, 500, 650),
          (tutorial_message_set_center_justify, 1),
          (tutorial_message_set_background, 0),
          (tutorial_message, "@{s1}", 0x000000),
      (try_end),
    ],
    []),
    ##player cant move at the beginning
    # (0, 0, 0,
    # [
      # (eq, "$temp", -1),
    # ],
    # [
      # (get_player_agent_no, ":agent"),
      # (entry_point_get_position, pos1, 0),
      # (agent_set_position, ":agent", pos1),
      # (try_begin),
        # (agent_get_horse, ":horse", ":agent"),
        # (gt, ":horse", 0),
        # (agent_set_position, ":horse", pos1),
        # (agent_set_animation, ":horse", "anim_unused_horse_anim_1"),
      # (try_end),
      # ]),

    (ti_on_agent_spawn, 0, 0,[],[
      (store_trigger_param_1, ":agent"),
      (agent_is_alive, ":agent"),
      (agent_is_human, ":agent"),
      (agent_get_troop_id, ":troop", ":agent"),
      (try_begin),
        (neq, ":troop", "trp_guest"),
        (neq, ":troop", "trp_guest_female"),
        (agent_get_position, pos1, ":agent"),
        (agent_set_slot, ":agent", 8, -1),
        (agent_set_slot, ":agent", slot_agent_target_entry_point, 48),
        (agent_set_slot, ":agent", slot_horse_sprinting, 0),
        (agent_set_slot, ":agent", slot_agent_race_state, 0),
        (try_for_range, ":entries", 8, 17),
          (agent_set_slot, ":agent", 12, ":entries"),
          (entry_point_get_position, pos2, ":entries"),
          (get_distance_between_positions, ":distance", pos1, pos2),
          (lt, ":distance", 50),
          (store_sub, ":distance_correction", ":entries", 8),
          (agent_set_slot, ":agent", 8, ":distance_correction"),
        (try_end),
        (try_begin),
          (eq, ":troop", "trp_player"),
          (set_fixed_point_multiplier, 100),
          (agent_get_position, pos40, ":agent"),
          (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 0),
        (else_try),
          (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 100),
        (try_end),
      (else_try),
        (this_or_next|eq, ":troop", "trp_guest"),
        (eq, ":troop", "trp_guest_female"),
        (agent_set_stand_animation, ":agent", "anim_arena_stand_idle"),
        (agent_set_animation, ":agent", "anim_arena_stand_idle"),
        (store_random_in_range,":r",0,300),
        (agent_set_animation_progress,":agent",":r"),
      (try_end),
    ]),

    (0, 0, ti_once,[
      (key_clicked, key_k),
    ],[
      (assign, "$temp", 1),
      (get_player_agent_no, ":agent_player"),

      (call_script, "script_advanced_agent_set_speed_modifier", ":agent_player", 100),

      (try_for_agents, ":agent"),
        (agent_is_human, ":agent"),
        (agent_is_alive, ":agent"),
        (neq, ":agent", ":agent_player"),
        (agent_get_troop_id, ":troop", ":agent"),
        (neq, ":troop", "trp_guest"),
        (neq, ":troop", "trp_guest_female"),
        (entry_point_get_position, pos2, 48),
        (copy_position, pos3, pos2),
        (try_begin),
          #(neg|agent_slot_eq, ":agent", 12, 14),
          (neg|agent_slot_eq, ":agent", 12, 15),
          (neg|agent_slot_eq, ":agent", 12, 16),
          (agent_get_slot, ":distance_correction", ":agent", 8),
          (val_mul, ":distance_correction", 400),
          (val_max, ":distance_correction", 8),
          (position_move_x, pos3, ":distance_correction"),
        (try_end),
        (agent_set_scripted_destination, ":agent", pos3),
      (try_end),
      (tutorial_message, -1),
    ]),

    (0, 0, 0,[
      (key_clicked, key_g),
      (neq, "$temp", -1),
    ],[
      (get_player_agent_no, ":player"),
      (agent_get_horse, ":horse", ":player"),
      (agent_is_active, ":horse"),
      (agent_is_alive, ":horse"),
      (agent_get_slot, ":timer2", ":player", slot_horse_sprinting),
      (try_begin),
          (eq, ":timer2", 0),
          (display_message, "@You urge your horse into a swift, thunderous sprint!", message_alert),
          (agent_set_slot, ":player", slot_horse_sprinting, 1),
          (call_script, "script_advanced_agent_set_speed_modifier", ":player", 115),
      (else_try),
          (ge, ":timer2", 1),
          (display_message, "@Your horse stops sprinting.", message_alert),
          (agent_set_slot, ":player", slot_horse_sprinting, 0),
          (call_script, "script_advanced_agent_set_speed_modifier", ":player", 100),
      (try_end),
    ]),
    (ti_on_agent_dismount, 0, 0, [],[
      (store_trigger_param_2, ":horse"),
      (neg|agent_is_alive, ":horse"),
      (store_trigger_param_1, ":rider"),
      (agent_is_alive, ":rider"),
      (agent_deliver_damage_to_agent, ":rider", ":rider", 1000, "itm_club"),
      (agent_get_troop_id, ":troop", ":rider"),
      (str_store_troop_name, s35, ":troop"),
      (display_message, "@{s35}'s horse stumbled and fall.", color_terrible_news),
    ]),
    (0.3, 0, 0,[
      (ge, "$temp", 1),
      (try_for_agents, ":agent"),
          (agent_is_human, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (neq, ":troop", "trp_guest"),
          (neq, ":troop", "trp_guest_female"),

          (agent_get_slot, ":timer2", ":agent", slot_horse_sprinting),
          (store_skill_level, ":riding", "skl_riding", ":troop"),
          (try_begin),
              (store_random_in_range, ":rand", 0, 250),
              (val_add, ":rand", ":riding"),
              (le, ":rand", ":timer2"),
              (agent_get_horse, ":horse", ":agent"),
              (agent_is_active, ":horse"),
              (agent_is_alive, ":horse"),
              (store_random_in_range, ":random", 16, 31),
              (val_sub, ":random", ":riding"),
              (agent_deliver_damage_to_agent, ":agent", ":horse", ":random", "itm_club"),
              (try_begin),
                  (eq, ":troop", "trp_player"),
                  (display_message, "@Your horse is getting tired. You better stop sprinting before it dies!", color_terrible_news),
              (try_end),
          (try_end),
          (try_begin),
              (neq, ":troop", "trp_player"),
              (eq, ":timer2", 0),
              (agent_get_horse, ":horse", ":agent"),
              (agent_is_active, ":horse"),
              (agent_is_alive, ":horse"),
              (store_agent_hit_points, ":hitpoints", ":horse", 0),
              (try_begin),
                  (gt, ":hitpoints", 75),
                  (store_random_in_range, ":rand", 0, 200),
                  (le, ":rand", 5),
                  (agent_set_slot, ":agent", slot_horse_sprinting, 1),
                  (str_store_troop_name, s35, ":troop"),
                  (display_message, "@{s35} encourages his horse to sprint."),
                  (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 115),
              (else_try),
                  (gt, ":hitpoints", 50),
                  (store_random_in_range, ":rand", 0, 300),
                  (le, ":rand", 4),
                  (agent_set_slot, ":agent", slot_horse_sprinting, 1),
                  (str_store_troop_name, s35, ":troop"),
                  (display_message, "@{s35} encourages his horse to sprint."),
                  (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 115),
              (else_try),
                  (gt, ":hitpoints", 30),
                  (store_random_in_range, ":rand", 0, 400),
                  (le, ":rand", 3),
                  (agent_set_slot, ":agent", slot_horse_sprinting, 1),
                  (str_store_troop_name, s35, ":troop"),
                  (display_message, "@{s35} encourages his horse to sprint."),
                  (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 115),
              (try_end),
          (else_try),
              (neq, ":troop", "trp_player"),
              (gt, ":timer2", 5),
              (agent_get_horse, ":horse", ":agent"),
              (agent_is_active, ":horse"),
              (agent_is_alive, ":horse"),
              (store_agent_hit_points, ":hitpoints", ":horse", 0),
              (store_random_in_range, ":rand", 0, 450),
              (val_div, ":hitpoints", 3),
              (val_add,":rand", ":hitpoints"),
              (lt, ":rand", ":timer2"),
              (str_store_troop_name, s35, ":troop"),
              (display_message, "@{s35} stops sprinting."),
              (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 100),
              (agent_set_slot,":agent", slot_horse_sprinting, 0),
          (else_try),
              (ge, ":timer2", 1),
              (val_add, ":timer2", 1),
              (agent_set_slot,":agent", slot_horse_sprinting, ":timer2"),
          (try_end),
          # (agent_get_horse, ":horse_agent", ":agent"),
          # (this_or_next|eq, ":agent", ":player_agent"),
          # (gt, ":horse_agent", 0),
          (agent_get_slot, ":agent_slot", ":agent", slot_agent_race_state),
          (ge, ":agent_slot", 0),

          (try_begin),
              (eq, "$temp4", 2),
              (assign, ":win", 10),
          (else_try),
              (eq, "$temp4", 1),
              (assign, ":win", 20),
          (else_try),
              (assign, ":win", 30),
          (try_end),

          (lt, ":agent_slot", ":win"),
          (assign, ":c", 1),
          (agent_get_position, pos1, ":agent"),
          (agent_get_slot, ":race_state", ":agent", slot_agent_target_entry_point),
          (try_begin),
              # (neq, ":race_state", 48),
              # (neq, ":race_state", 52),
              # (neq, ":race_state", 54),
              # (neq, ":race_state", 57),
            # (is_between, ":race_state", 48, 58),
              (store_sub, ":race_substate", ":race_state", 30),
            #  (is_between, ":race_substate", 18, 27)
              (entry_point_get_position, pos2, ":race_state"),
              (entry_point_get_position, pos3, ":race_substate"),
              (position_is_behind_position, pos3, pos1),
              (position_is_behind_position, pos1, pos2),

              (get_distance_between_positions_in_meters, ":distance1", pos1, pos2),
              (get_distance_between_positions_in_meters, ":distance2", pos1, pos3),
              (lt, ":distance1", 35),
              (lt, ":distance2", 35),

              (assign, ":c", 0),
              (try_begin),
                  (ge, "$cheat_mode", 1),
                  (assign, reg44, ":race_state"),
                  (assign, reg45, ":race_substate"),
                  (agent_get_troop_id, ":troop", ":agent"),
                  (str_store_troop_name, s33, ":troop"),
                  (display_message, "@{s33}, state {reg44} substate {reg45}"),
              (try_end),
          # (else_try),
              # (this_or_next|eq, ":race_state", 48),
              # (this_or_next|eq, ":race_state", 52),
              # (this_or_next|eq, ":race_state", 54),
              # (eq, ":race_state", 57),
              # (store_sub, ":race_substate2", ":race_state", 30),
              # (entry_point_get_position, pos2, ":race_state"),
              # (entry_point_get_position, pos3, ":race_substate2"),
              # (position_is_behind_position, pos3, pos1),
              # (position_is_behind_position, pos1, pos2),
              # (assign, ":c", 0),
          (try_end),
          (eq, ":c", 0),

          (agent_get_slot, ":agent_slot", ":agent", slot_agent_race_state),
          (val_add, ":agent_slot", 1),
          (agent_set_slot, ":agent", slot_agent_race_state, ":agent_slot"),

          (val_add, ":race_state", 1),
          (try_begin),
              (gt, ":race_state", 57),
              (assign, ":race_state", 48),
          (try_end),
          (agent_set_slot, ":agent", slot_agent_target_entry_point, ":race_state"),
          (try_begin),
              (get_player_agent_no, ":player_agent"),
              (neq, ":agent", ":player_agent"),
              (entry_point_get_position, pos3, ":race_state"),
              (agent_get_slot, ":distance_correction", ":agent", 8),
              (val_mul, ":distance_correction", 250),
              (val_max, ":distance_correction", 8),
              (position_move_x, pos3, ":distance_correction"),
              (agent_set_scripted_destination, ":agent", pos3),
          (try_end),
      (try_end),
    ],[]),
    ##victory
    (0, 0, 0.3,[
      (ge, "$temp", 1),
      (lt, "$temp_2", 9),
      (ge, "$temp_3", 0),
      # (get_player_agent_no, ":player"),
      (try_for_agents, ":agent"),
        (agent_is_human, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (neq, ":troop", "trp_guest"),
        (neq, ":troop", "trp_guest_female"),
        (try_begin),
            (eq, "$temp4", 2),
            (assign, ":win", 10),
        (else_try),
            (eq, "$temp4", 1),
            (assign, ":win", 20),
        (else_try),
            (assign, ":win", 30),
        (try_end),

        (agent_slot_ge, ":agent", slot_agent_race_state, ":win"),
        (agent_set_slot, ":agent", slot_agent_race_state, -1),
        (agent_clear_scripted_mode, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (troop_set_slot, "trp_temp_array_olympia_a", "$temp_2", ":troop"),
        (val_add, "$temp_2", 1),
        (try_begin),
          (eq, "$temp_2", 1),
          (troop_get_slot, ":winer", "trp_temp_array_olympia_a", 0),
          (str_store_troop_name, s1, ":winer"),
          (assign, "$g_tournament_player_team_won", ":winer"),
          (display_message, "@{s1} won the race!"),
          (store_mission_timer_a, "$temp_3"),
          (agent_set_animation, ":agent", "anim_cheer", 1),
          (agent_get_troop_id, ":troop2", ":agent"),
          (try_begin),##winer animation
            (call_script, "script_cf_dplmc_troop_is_female", ":troop2"),
            (agent_play_sound, ":agent", "snd_woman_victory"),
          (else_try),
            (agent_play_sound, ":agent", "snd_man_victory"),
          (try_end),
          (agent_set_slot, ":agent", slot_horse_sprinting, 0),#stop sprinting
        (try_end),
      (try_end),
    ],[]),
    ##win money
    (0.1, 1, ti_once,[
      (store_mission_timer_a, ":timer_mission"),
      (val_sub, ":timer_mission", "$temp_3"),
      (get_player_agent_no, ":player"),
      (this_or_next|ge, ":timer_mission", 30),
      (agent_slot_eq, ":player", slot_agent_race_state, -1),
    ],[
      (assign, "$temp_3", -1),
      (tutorial_message, -1),
      # (get_player_agent_no, ":player"),
      (try_for_range, ":unused", 0, 9),
        (assign, ":winer_state", -1),
        (assign, ":winer", -1),
        (try_for_agents, ":agents"),
          (agent_get_troop_id, ":troop", ":agents"),
          (neq, ":troop", "trp_guest"),
          (neq, ":troop", "trp_guest_female"),
          (agent_get_slot, ":race_state", ":agents", slot_agent_race_state),
          (ge, ":race_state", 0),
          (try_begin),
              (eq, "$temp4", 2),
              (assign, ":win", 10),
          (else_try),
              (eq, "$temp4", 1),
              (assign, ":win", 20),
          (else_try),
              (assign, ":win", 30),
          (try_end),
          (lt, ":race_state", ":win"),
          (gt, ":race_state", ":winer_state"),
          (agent_get_troop_id, ":troop1", ":agents"),
          (assign, ":continue", 1),
          (try_for_range, ":slots", 0, 8),
            (troop_get_slot, ":troop2", "trp_temp_array_olympia_a", ":slots"),
            (eq, ":troop2", ":troop1"),
            (assign, ":continue", 0),
          (try_end),
          (eq, ":continue", 1),

          (agent_set_slot, ":agents", slot_horse_sprinting, 0),#stop sprinting

          (assign, ":winer_state", ":race_state"),
          (assign, ":winer", ":troop1"),
        (try_end),
        (ge, ":winer", 0),
        (assign, ":c", 0),
        (try_for_range, ":slot", 0, 8),
          (eq, ":c", 0),
          (troop_get_slot, ":troop2", "trp_temp_array_olympia_a", ":slot"),
          (eq, ":troop2", -1),
          (troop_set_slot, "trp_temp_array_olympia_a", ":slot", ":winer"),
          (assign, ":c", 1),
        (try_end),
      (try_end),
      (str_clear, s10),
      (assign, reg10, 1),
      (try_for_range, ":slots", 0, 8),
        (troop_get_slot, ":troop2", "trp_temp_array_olympia_a", ":slots"),
        (ge, ":troop2", 0),
        (str_store_troop_name, s2, ":troop2"),
        (str_store_string, s10, "@{s10}^^{reg10}:  {s2} "),#display who has won and the rest
        (val_add, reg10, 1),
        (try_begin),
          (eq, ":troop2", "trp_player"),
          (try_begin),
            (eq, "$temp4_1", 1),
            (assign, "$g_player_eligible_feast_center_no", "$current_town"),#to allow player to enter court
          (try_end),
          (store_sub, ":experience", 10, reg10),
          (val_add, ":experience", 10),
          (val_mul, ":experience", 15),
          (gt, ":experience", 0),#non negative
          (add_xp_as_reward, ":experience"),
        (try_end),
        (try_begin),
          (eq, ":troop2", "trp_player"),
          (gt, "$g_tournament_bet_placed", 0),
          (le, reg10, 5),
          (store_sub, "$g_tournament_bet_win_amount", 6, reg10),
          (val_mul, "$g_tournament_bet_win_amount", "$g_tournament_bet_placed"),
          (val_div, "$g_tournament_bet_win_amount", 5),
          (val_max, "$g_tournament_bet_win_amount", 1),
          (val_add, "$g_tournament_bet_win_amount", "$g_tournament_bet_placed"),
        (try_end),
      (try_end),
      (str_store_string, s10, "@Ranking:^^^{s10}"),
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, 500, 600),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 0),
      (tutorial_message, "@{s10}", 0x000000),
    ]),
]),

("spear_throwing", mtf_battle_mode, -1,
  "spear throwing yay",[
    (0, mtef_team_0|mtef_scene_source, af_override_everything, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    ##horse racers
    (8, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (10, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (11, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (12, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (13, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (14, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (15, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    #rest
    (16, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (32, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (33, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (34, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (35, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (36, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (37, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (38, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (39, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (40, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (41, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (42, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (43, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (44, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (45, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (46, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (47, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (48, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (49, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (50, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (51, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (52, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (53, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (54, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (55, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (56, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (57, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (58, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (59, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (60, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (61, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (62, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (63, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (64, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (65, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (66, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (67, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (68, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (69, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (70, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (71, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (72, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (73, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (74, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (75, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (76, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (77, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
  ], global_common_triggers +
   p_wetter +[
    cannot_spawn_commoners,
   improved_lightning,
  (ti_before_mission_start, 0, 0, [(troop_slot_eq, "trp_organiser", olympia_easter_egg, 0),],
   [(call_script, "script_remove_easter_eggs"),
     ]),

##init list
    (ti_before_mission_start, 0, 0,
    [],
    [
      (play_sound, "snd_arena_ambiance", sf_looping),
      (call_script, "script_music_set_situation_with_culture", mtf_sit_thermae),
      (assign, "$temp", -1),
      (assign, "$temp2", -1),
      (assign, "$temp3", 0),
      (assign, "$temp4", 0),
      (assign, "$temp_3", -1),
    ]),
##leave1
    (ti_tab_pressed, 0, 0,
    [(eq, "$temp_3", -1),],
    [(question_box, "@Do you wish to give up?"),]),

    (1, 2, ti_once,
    [(neq, "$temp_3", -1),],
    [(stop_all_sounds),
        (try_begin),
          (get_player_agent_no, ":agent_player"),
          (eq, ":agent_player", "$temp2"),
          (assign, ":menu", "mnu_throwing_one"),
        (else_try),
          (assign, ":menu", "mnu_throwing_one_by_another"),
        (try_end),
        (mission_cam_animate_to_screen_color, 0xFF000000, 1000),
        (finish_mission,4),
        (store_current_hours, ":hours"),
        (troop_set_slot, "trp_organiser", rest_olympia, ":hours"),
        (troop_set_slot, "trp_organiser", olympia_auto_menu, ":menu"),
        (jump_to_menu, "mnu_auto_return_map"),  ]),
##leave2
    (ti_question_answered, 0, 0,
    [],
    [
    (store_trigger_param_1, ":number"),
    (eq, ":number", 0),
    (stop_all_sounds),
    (finish_mission),
    (try_for_range, ":slot", 1, 8),
        (troop_slot_ge, "trp_temp_array_olympia_b", ":slot", 1),
        (troop_get_slot, "$g_tournament_player_team_won", "trp_temp_array_olympia_b", ":slot"),
    (try_end),
    (store_current_hours, ":hours"),
    (troop_set_slot, "trp_organiser", rest_olympia, ":hours"),
    (troop_set_slot, "trp_organiser", olympia_auto_menu, "mnu_throwing_one_by_another"),
    (jump_to_menu, "mnu_auto_return_map"),
    ]),
###race start
    (0.5, 0, 0,
    [
      (try_begin),
        (eq, "$temp", -1),
        (str_store_string, s1, "@<<   Press 'K' to start the competition!   >>"),
        (tutorial_message_set_size, 17, 17),
        (tutorial_message_set_position, 500, 600),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 0),
        (tutorial_message, "@{s1}", 0x000000),
      (try_end),
    ],
    []),

    (ti_on_agent_spawn, 0, 0,
    [],
    [
      (store_trigger_param_1, ":agent"),
      (agent_is_alive, ":agent"),
      (agent_is_human, ":agent"),
      (agent_get_troop_id, ":troop", ":agent"),
      (try_begin),
        (this_or_next|eq, ":troop", "trp_guest"),
        (eq, ":troop", "trp_guest_female"),
        (agent_set_stand_animation, ":agent", "anim_arena_stand_idle"),
        (agent_set_animation, ":agent", "anim_arena_stand_idle"),
        (store_random_in_range,":r",0,300),
        (agent_set_animation_progress,":agent",":r"),
      (else_try),
        (agent_set_speed_modifier, ":agent", 0),
        (try_begin),
          (eq, "$temp4_1", 2),
          (agent_set_wielded_item, ":agent", "itm_throwing_spears_olymp"),
        (else_try),
          (agent_set_wielded_item, ":agent", "itm_discus"),
        (try_end),
        (agent_set_no_dynamics, ":agent", 1),
        (agent_ai_set_interact_with_player, ":agent", 0),
      (try_end),
    ]),

    (0, 0, ti_once,
    [
      (key_clicked, key_k),
    ],
    [
      (assign, "$temp", 1),
      (get_player_agent_no, ":agent_player"),
      (try_begin),
        (eq, "$temp4_1", 2),
        (agent_equip_item, ":agent_player", "itm_throwing_spears_olymp"),
        (agent_set_wielded_item, ":agent_player", "itm_throwing_spears_olymp"),
      (else_try),
        (agent_equip_item, ":agent_player", "itm_discus"),
        (agent_set_wielded_item, ":agent_player", "itm_discus"),
      (try_end),
      (tutorial_message, -1),
    ]),

    (0, 2, ti_once,
    [
      (eq, "$temp", 1),
    ],
    [

      (get_player_agent_no, ":agent_player"),
      (try_for_agents, ":agent"),
        (agent_is_human, ":agent"),
        (agent_is_alive, ":agent"),
        (neq, ":agent", ":agent_player"),
        (agent_get_troop_id, ":troop", ":agent"),
        (neq, ":troop", "trp_guest"),
        (neq, ":troop", "trp_guest_female"),
        (try_begin),
          (eq, "$temp4_1", 2),
          (agent_set_wielded_item, ":agent", "itm_throwing_spears_olymp"),
        (else_try),
          (agent_set_wielded_item, ":agent", "itm_discus"),
        (try_end),
        (agent_set_attack_action,":agent",0,1),
      (try_end),
      (assign, "$temp", 2),
    ]),
    (0, 2, ti_once,
    [
      (eq, "$temp", 2),
    ],
    [
      (set_fixed_point_multiplier, 1),
      (get_player_agent_no, ":agent_player"),
      (try_for_agents, ":agent"),
        (agent_is_human, ":agent"),
        (agent_is_alive, ":agent"),
        (neq, ":agent", ":agent_player"),
        (agent_get_troop_id, ":troop", ":agent"),
        (neq, ":troop", "trp_guest"),
        (neq, ":troop", "trp_guest_female"),
        (try_begin),
          (eq, "$temp4_1", 2),
          (agent_set_wielded_item, ":agent", "itm_throwing_spears_olymp"),
        (else_try),
          (agent_set_wielded_item, ":agent", "itm_discus"),
        (try_end),

        (agent_get_entry_no, ":entry", ":agent"),
        (entry_point_get_position, pos22, ":entry"),
        (position_get_y, ":y", pos22),
        (position_get_x, ":x", pos22),
        (position_get_z, ":z", pos22),
        (val_sub, ":y", 2),
        (val_add, ":z", 20),
        (val_add, ":x", 30),
        (position_set_z,  pos22, ":z"),
        (position_set_y,  pos22, ":y"),
        (position_set_x,  pos22, ":x"),
        (agent_set_look_target_position, ":agent", pos22),

        (agent_set_attack_action,":agent",0,0),
      (try_end),
    ]),

##victory
    (1, 0, 0,
    [
    (neq, "$temp_3", 1),
    (ge, "$temp4", 8),#all have thrown their spears
      (agent_is_active, "$temp2"),
      (gt, "$temp3", 0),

      (agent_get_troop_id, ":troop", "$temp2"),
      (str_store_troop_name, s1, ":troop"),
      (assign, reg18, "$temp3"),
      (display_message, "@{s1} won the competition with a distance of {reg18} units"),

      (assign, "$temp_3", 1),
      (agent_set_animation, "$temp2", "anim_cheer", 1),
      (try_begin),##winer animation
        (call_script, "script_cf_dplmc_troop_is_female", ":troop"),
        (agent_play_sound, "$temp2", "snd_woman_victory"),
      (else_try),
        (agent_play_sound, "$temp2", "snd_man_victory"),
      (try_end),
    ],
    []),
    (1, 0, ti_once,
    [
     (ge, "$temp4", 8),#all have thrown their spears
      (agent_is_active, "$temp2"),
      (gt, "$temp3", 0),
      (eq, "$temp_3", 1),
    ],
    [
    (get_player_agent_no, ":player"),
    (try_begin),
        (eq, "$temp2", ":player"),
        (add_xp_as_reward, 500),
    (try_end),

    (agent_get_troop_id, "$g_tournament_player_team_won", "$temp2"),

    (str_store_string, s10, "@The competition is over."),
    (tutorial_message_set_size, 17, 17),
    (tutorial_message_set_position, 500, 600),
    (tutorial_message_set_center_justify, 0),
    (tutorial_message_set_background, 0),
    (tutorial_message, "@{s10}", 0x000000),
    ]),

  ]),

("latifundium", 0, -1,"lala",[
    (0, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (32, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (33, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (34, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (35, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (36, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (37, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (38, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (39, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (40, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (41, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (42, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (43, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (44, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (45, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (46, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (47, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (48, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (49, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (50, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (51, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (52, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (53, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (54, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (55, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (56, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (57, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (58, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (59, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (60, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (61, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (62, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (63, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (64, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (65, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (66, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (67, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (68, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (69, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (70, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (71, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (72, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (73, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (74, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (75, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (76, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (77, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
  ], p_wetter + storms + global_common_triggers +
  [
    can_spawn_commoners,
    improved_lightning,

    (ti_after_mission_start, 0, 0, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
    ]),

 	  (ti_before_mission_start, 0, ti_once, [],[
      (store_current_scene, ":scene"),
      (call_script, "script_remove_objects", ":scene"),
	  ]),
    ##init list
    (ti_before_mission_start, 0, 0,[],[
      (store_current_scene, ":scene"),
      (scene_set_slot, ":scene", slot_scene_visited, 1),
    ]),

    (1,0,7,[],[
      (try_for_agents,":agent_no"),
        (agent_is_alive,":agent_no"),
        (agent_is_human,":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (try_begin),
          (is_between, ":troop_no", slaves_begin, slaves_end),

          (assign, ":continue_walk", 0),
          (store_random_in_range, ":continue_walk", 1, 100),
          (try_begin),
            (this_or_next|agent_slot_eq, ":agent_no", slot_agent_is_in_scripted_mode, 0),
            (le, ":continue_walk", 40),
            (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
            (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
            (agent_set_animation, ":agent_no", "anim_stand_man"),
            (agent_set_animation_progress, ":agent_no", 10),

            (agent_get_position, pos1, ":agent_no"),
            (store_random_in_range, ":points", 14, 41),
            (entry_point_get_position, pos2, ":points"),
            (agent_set_speed_limit, ":agent_no", 1),
            (agent_set_scripted_destination, ":agent_no", pos2),
            (agent_set_slot, ":agent_no", slot_agent_is_in_scripted_mode, 1),
          (try_end),
        (else_try),
          (this_or_next|eq,":troop_no", "trp_guest"),
          (eq,":troop_no", "trp_guest_female"),
          (try_begin),
            (agent_has_item_equipped,":agent_no","itm_dedal_kufel"),
            (agent_set_stand_animation, ":agent_no", "anim_sitting_drinking_low"),
            (agent_set_animation, ":agent_no", "anim_sitting_drinking_low"),
            (store_random_in_range,":r",0,300),
          (else_try),
            (agent_set_stand_animation, ":agent_no", "anim_sitting_low"),
            (agent_set_animation, ":agent_no", "anim_sitting_low"),
            (store_random_in_range,":r",0,300),
          (try_end),
          (agent_set_animation_progress,":agent_no",":r"),
        (try_end),
      (else_try),
        (eq, ":troop_no", "trp_whore"),
        (agent_set_stand_animation, ":agent_no", "anim_vyrn_shieldmaiden_stand"),
        (agent_set_animation, ":agent_no", "anim_vyrn_shieldmaiden_stand"),
      (else_try),
        (is_between,":troop_no",tavern_minstrels_begin,tavern_minstrels_end),
        (play_track,0,2),
        (try_begin),
          (agent_has_item_equipped,":agent_no","itm_lute"),
          (agent_set_stand_animation, ":agent_no", "anim_lute_standing"),
          (agent_set_animation, ":agent_no", "anim_lute_standing"),
          (agent_play_sound,":agent_no","snd_dedal_tavern_lute"),
        (else_try),
          (agent_has_item_equipped,":agent_no","itm_lyre"),
          (agent_set_stand_animation, ":agent_no", "anim_lyre_standing"),
          (agent_set_animation, ":agent_no", "anim_lyre_standing"),
          (agent_play_sound,":agent_no","snd_dedal_tavern_lyre"),
        (else_try),
          (agent_has_item_equipped,":agent_no","itm_flute"),
          (agent_set_stand_animation, ":agent_no", "anim_flute_player"),
          (agent_set_animation, ":agent_no", "anim_flute_player"),
          (agent_play_sound,":agent_no","snd_dedal_tavern_flute"),
        (try_end),
        (store_random_in_range,":r",0,300),
        (agent_set_animation_progress,":agent_no",":r"),
      (try_end),
    ]),

    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,

    (ti_inventory_key_pressed, 0, 0,[
      (set_trigger_result, 1),
    ],[]),

    (ti_tab_pressed, 0, 0, [],[
      (finish_mission),
    ]),
]),

("lucillus_peaceful", 0, -1,
  "lala",[
    (0, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (14, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (15, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
  ], p_wetter + global_common_triggers +
  [
    can_spawn_commoners,
    improved_lightning,
##init list
    (ti_before_mission_start, 0, 0,
    [],
    [
      (store_current_scene, ":scene"),
      (scene_set_slot, ":scene", slot_scene_visited, 1),
    ]),

    (0,8,0,[],
      [
        (try_for_agents,":agent_no"),
          (agent_is_alive,":agent_no"),
          (agent_is_human,":agent_no"),
          (agent_get_troop_id, ":troop_no", ":agent_no"),

          (this_or_next|eq, ":troop_no", "trp_slave_female"),
          (eq, ":troop_no", "trp_slave"),

          (assign, ":continue_walk", 0),
          (store_random_in_range, ":continue_walk", 1, 100),
          (try_begin),
            (le, ":continue_walk", 40),
            (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
            (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
            (agent_set_animation, ":agent_no", "anim_stand_man"),
            (agent_set_animation_progress, ":agent_no", 10),

            (agent_get_position, pos1, ":agent_no"),
            (store_random_in_range, ":points", 1, 10),
            (entry_point_get_position, pos2, ":points"),
            (agent_set_speed_limit, ":agent_no", 1),
            (agent_set_scripted_destination, ":agent_no", pos2),
          (try_end),
        (try_end),  ]),

      ambient_set_agents_for_sounds,
      ambient_agent_play_sound,

      (ti_inventory_key_pressed, 0, 0,[
        (set_trigger_result, 1),
      ],[]),

  (ti_tab_pressed, 0, 0, [],[(finish_mission), ]),

  ]),

("marshing_camp", 0, -1,"lala",[
    (0, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_legion_segmentata_2]),
    (11, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_legion_segmentata_3]),
    (12, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (13, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (14, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (15, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (16, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (17, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_1]),
    (18, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_2]),
    (19, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_3]),
    (20, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),
    (21, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_1]),
    (22, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_2]),
    (23, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_3]),
    (24, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),
    (25, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_1]),
    (26, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_2]),
    (27, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_3]),
    (28, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),
    (29, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_1]),
    (30, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_2]),
    (31, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_3]),
    (32, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),
    (33, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_1]),
    (34, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_2]),
    (35, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_3]),
    (36, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),
    (37, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_1]),
    (38, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_2]),
    (39, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_3]),
    (40, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),
    (41, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, [itm_roman_gladius]),
  ], p_wetter + storms + global_common_triggers +
  [
    can_spawn_commoners,
    improved_lightning,
    (0,8,0,[],[
      (try_for_agents,":agent_no"),
        (agent_is_active,":agent_no"),
        (agent_is_alive,":agent_no"),
        (agent_is_human,":agent_no"),
        (agent_get_entry_no, ":entry_spawn", ":agent_no"),
        (neg|is_between, ":entry_spawn", 0, 17),
        (ge, ":entry_spawn", 17),
        (assign, ":continue_walk", 0),
        (store_random_in_range, ":continue_walk", 1, 100),
        (try_begin),
          (le, ":continue_walk", 40),
          (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
          (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
          (agent_set_animation, ":agent_no", "anim_stand_man"),
          (agent_set_animation_progress, ":agent_no", 10),

          (agent_get_position, pos1, ":agent_no"),
          (store_random_in_range, ":points", 17, 41),
          (entry_point_get_position, pos2, ":points"),
          (agent_set_speed_limit, ":agent_no", 1),
          (agent_set_scripted_destination, ":agent_no", pos2),
        (try_end),
      (try_end),
    ]),
	  ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    (ti_inventory_key_pressed, 0, 0,[
      (set_trigger_result, 1),
    ],[]),
    (ti_tab_pressed, 0, 0, [],[
      (finish_mission),
    ]),
]),
("freelancer_task_training", mtf_arena_fight|mtf_no_blood, -1,"lala",[
    (0, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (11, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (12, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (13, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (14, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (15, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (16, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (17, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (18, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (19, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (20, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (21, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (22, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (23, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (24, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (25, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (26, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (27, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (28, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (29, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (30, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (31, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (33, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (34, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (35, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (36, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (37, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (38, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (39, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (40, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (41, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (42, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (43, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (44, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (45, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (46, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (47, mtef_team_0|mtef_visitor_source, af_override_head|af_override_horse|af_override_weapons|af_override_body, 0, 1, [itm_tutorial_sword,itm_arena_shield_red,itm_practice_javelin_amo4,itm_military_tunic_1]),
    (48, mtef_team_1|mtef_visitor_source, af_override_head|af_override_horse|af_override_weapons|af_override_body, 0, 1, [itm_tutorial_sword,itm_arena_shield_blue,itm_practice_javelin_amo4,itm_military_tunic_2]),
    (49, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    dedal_shield_bash,
    dedal_shield_bash_AI,
    common_inventory_not_available,
    common_battle_check_friendly_kills,
    # (ti_before_mission_start, 0, 0, [],[
    #   (scene_set_day_time, 10),
    # ]),
    (0, 0, ti_once,[],[
      (team_set_relation, 0, 1, -1), # -1 for enemy, 1 for friend, 0 for neutral
    ]),
    (3, 0, 0,[],[
      (try_begin),
        (main_hero_fallen),
        (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
        (get_player_agent_no, ":player_agent"),
        (agent_get_kill_count, "$g_arena_training_kills", ":player_agent", 1),#use this for conversation
        (assign, "$auto_menu", "mnu_freelancer_task_training_debrief"),
        (jump_to_menu, "mnu_auto_return_map"),
        (stop_all_sounds, 1),
        (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
        (finish_mission, 3),
      (else_try),
        (num_active_teams_le,1),
        (display_message, "@The training is over. Press tab to leave."),
      (try_end),
    ]),
    (ti_tab_pressed, 0, 0, [],[
      (try_begin),
        (num_active_teams_le,1),
        (get_player_agent_no, ":player_agent"),
        (agent_get_kill_count, "$g_arena_training_kills", ":player_agent", 1),#use this for conversation
        (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
        (assign, "$auto_menu", "mnu_freelancer_task_training_debrief"),
        (jump_to_menu, "mnu_auto_return_map"),
        (stop_all_sounds, 1),
        (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
        (finish_mission, 3),
      (else_try),
        (question_box,"str_give_up_fight"),
      (try_end),
    ]),
    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (get_player_agent_no, ":player_agent"),
      (agent_get_kill_count, "$g_arena_training_kills", ":player_agent", 1),#use this for conversation
      (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
      (assign, "$auto_menu", "mnu_freelancer_task_training_debrief"),
      (jump_to_menu, "mnu_auto_return_map"),
      (stop_all_sounds, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
      (finish_mission, 3),
    ]),
]),

("first_training", 0, -1,"lala",[
    (0, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (11, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (12, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (13, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (14, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (15, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (16, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (17, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (18, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (19, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (20, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (21, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (22, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (23, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (24, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (25, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (26, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (27, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (28, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (29, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (30, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (31, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (33, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (34, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (35, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (36, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (37, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (38, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (39, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (40, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (41, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (42, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, [itm_roman_gladius]),#centurio
    (43, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_1]),#player
    (44, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_2]),#special recruit
    (45, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_3]),#recruit
    (46, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),#recruit
  ], p_wetter + global_common_triggers +
  [
    (ti_before_mission_start, 0, 0, [],[
      (scene_set_day_time, 9),
    ]),
    cannot_spawn_commoners,
    improved_lightning,
    (0.5, 0.5, ti_once,[],[
      (start_mission_conversation, "trp_centurio_west"),
    ]),
	  ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("training_centurio", mtf_no_blood, -1,"Training.",[
    (0,mtef_visitor_source|mtef_team_0,af_override_everything,0,1,[itm_graves_simple_2,itm_military_tunic_1,itm_practice_javelin_amo4,itm_tutorial_sword,itm_arena_shield_blue]),
    (1,mtef_visitor_source|mtef_team_2,af_override_horse|af_override_weapons,0,1,[itm_roman_gladius]),
    (2,mtef_visitor_source|mtef_team_0,af_override_everything,0,1,[itm_graves_simple_2,itm_military_tunic_4,itm_tutorial_sword,itm_arena_shield_blue]),
    (3,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_3]),
    (4,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_2]),
    (5,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_1]),
    (6,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_4]),
    (7,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_3]),
    (8,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_2]),
    (9,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_1]),
    (10,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_4]),
    (11,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_3]),
    (12,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_2]),
    (13,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_1]),
    (14,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_4]),
    (15,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_3]),
    (16,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_2]),
    (17,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_1]),
    (18,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_4]),
    (19,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_3]),
    (20,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_2]),
    (21,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_1]),
    (22,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_4]),
    (23,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_3]),
    (24,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_2]),
    (25,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_1]),
    (26,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_4]),
    (27,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_3]),
    (28,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_2]),
    (29,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_1]),
    (30,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_4]),
    (31,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_3]),
    (32,mtef_visitor_source|mtef_team_4,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_2]),
    (33,mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,[itm_graves_simple_2,itm_military_tunic_1]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    (ti_before_mission_start, 0, 0, [],[
      (scene_set_day_time, 10),
    ]),
    (0, 0, ti_once,[],[
      (team_set_relation, 1, 2, 1), # -1 for enemy, 1 for friend, 0 for neutral
      (team_set_relation,2,1,1),
      (team_set_relation,0,1,1),
      (team_set_relation,0,2,1),
      (team_set_relation,2,0,1),
      (team_set_relation,1,3,1),
      (team_set_relation,1,4,1),
      (team_set_relation,0,3,1),
      (team_set_relation,0,4,1),
      (team_set_relation,2,3,1),
      (team_set_relation,2,4,1),
      (team_set_relation,3,4,-1),
    ]),
	  ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    common_inventory_not_available,
    (0.5, 0.5, ti_once,[],[
      (start_mission_conversation, "trp_centurio_west"),
    ]),

    (0,0, 1,[
      (eq, "$temp", 2),
    ],[
      (team_set_relation, 1, 2, 1), # -1 for enemy, 1 for friend, 0 for neutral
      (team_set_relation,2,1,1),
      (team_set_relation,0,1,1),
      (team_set_relation,0,2,1),
      (team_set_relation,2,0,1),
      (team_set_relation,1,3,1),
      (team_set_relation,1,4,1),
      (team_set_relation,0,3,1),
      (team_set_relation,0,4,1),
      (team_set_relation,2,3,1),
      (team_set_relation,2,4,1),
      (team_set_relation,3,4,-1),
      (finish_party_battle_mode),
      (start_mission_conversation, "trp_centurio_west"),
    ]),

    (0, 0, 0,[
      (key_clicked, key_k),
      (tutorial_message, -1),
    ],[]),
	  (1,0,ti_once,[
      (eq,"$temp",1),
      (neg|conversation_screen_is_active),
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@Train with your partner.^^Tutorial:^You can switch between different weapon modes for the gladius by pressing X key: The primary one has only upper and lower stab, the second one has also right and left slash.^^(press K to finish read)"),
		]),
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent"),
      (agent_set_no_death_knock_down_only, ":agent", 1),

      (agent_get_troop_id,":troop",":agent"),
      (try_begin),
        (eq, ":troop", "trp_legio_xxii_primigenia"),
        (agent_equip_item, ":agent", "itm_tutorial_sword", 0),
        (agent_set_wielded_item, ":agent", "itm_tutorial_sword"),
        (agent_equip_item, ":agent", "itm_arena_shield_blue", 0),
        (agent_set_wielded_item, ":agent", "itm_arena_shield_blue"),
        (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 25),
      (else_try),
        (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 80),
      (try_end),
    ]),
    (ti_on_agent_knocked_down, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent"),
      (agent_get_troop_id, ":troop", ":dead_agent"),
      (eq, ":troop", "trp_superbus"),
      (val_add, "$temp2", 1),

      (try_begin),
        (eq, "$temp2", 5),
        (assign, "$temp", 2),
      (try_end),
    ]),
    dedal_shield_bash_AI,
    dedal_shield_bash,
]),

("event1_talk", mtf_battle_mode, -1,
  "lala",[
    (0, mtef_team_1|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (11, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, []),
    (12, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (13, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (14, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_weapons, 0, 1, []),
    (15, mtef_team_2|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_3]),
    (16, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_2]),
    (17, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),
    (18, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_1]),
    (19, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_3]),
    (20, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_2]),
    (21, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),
    (22, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_1]),
    (23, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_3]),
    (24, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_2]),
    (25, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_1]),
    (26, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),
    (27, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_3]),
    (28, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_2]),
    (29, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),
    (30, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_1]),
    (31, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_3]),
    (32, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_2]),
    (33, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),
    (34, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_1]),
    (35, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_3]),
    (36, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_2]),
    (37, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),
    (38, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_1]),
    (39, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_3]),
    (40, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_2]),
    (41, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_4]),
    (42, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_graves_simple_2,itm_military_tunic_1]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    remove_banners,
    improved_lightning,
    (0,0,ti_once, [],[
      (team_set_relation, 1, 2, 1),
      (team_set_relation,2,1,1),
      (team_set_relation,0,1,1),
      (team_set_relation,0,2,1),
      (team_set_relation,2,0,1),
      (team_set_relation,1,0,1),
    ]),
    (1, 0.5, ti_once,[],[
      (start_mission_conversation, "trp_avaritia"),
    ]),
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent"),
      (agent_set_no_death_knock_down_only, ":agent", 1),
      (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 80),
    ]),
    (ti_on_agent_knocked_down, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent"),
      (agent_get_troop_id, ":troop", ":dead_agent"),
      (eq, ":troop", "trp_quest_miles"),
      (assign, "$temp2", 2),
    ]),
    (3, 0, 0,[
      (eq, "$temp1", 1),
      (neq, "$temp2", 3),
    ],[
      (finish_mission, 2),
      (mission_cam_animate_to_screen_color, 0xFF000000, 1500),
      (jump_to_menu, "mnu_auto_return_map"),
    ]),
    (0.5, 0, 0,[(eq, "$temp2", 1),],[
      (team_set_relation, 1, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
      (team_set_relation,2,1,-1),
      (team_set_relation,0,1,1),
      (team_set_relation,0,2,1),
      (team_set_relation,2,0,1),
      (team_set_relation,1,0,1),
      (set_party_battle_mode),
      (try_for_agents, ":agent"),
        (agent_is_active, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_human, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (eq, ":troop", "trp_quest_miles"),
        (agent_ai_set_aggressiveness, ":agent", 10000),
        (agent_force_rethink, ":agent"),
        (agent_ai_set_always_attack_in_melee, ":agent", 1),
        (agent_set_damage_modifier, ":agent", 200),
      (try_end),
      (get_player_agent_no, ":player"),
      (agent_set_damage_modifier, ":player", 200),
      (mission_disable_talk),
    ]),
    (1, 0, 0,[(eq, "$temp2", 2),],[
      (team_set_relation, 1, 2,1), # -1 for enemy, 1 for friend, 0 for neutral
      (team_set_relation,2,1,1),
      (team_set_relation,0,1,1),
      (team_set_relation,0,2,1),
      (team_set_relation,2,0,1),
      (team_set_relation,1,0,1),
      (finish_party_battle_mode),
      (mission_enable_talk),
      (start_mission_conversation, "trp_quest_miles"),
    ]),
	  ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("event2_talk", 0, -1,
  "lala",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (10, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (11, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (12, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (13, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (14, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (15, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (16, mtef_team_0|mtef_visitor_source, af_castle_lord, 0, 1, []),
    (17, mtef_team_0|mtef_visitor_source, af_castle_lord, 0, 1, []),
    (18, mtef_team_0|mtef_visitor_source, af_castle_lord, 0, 1, []),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    remove_banners,
    improved_lightning,
    (1, 0.5, ti_once,
    [],
    [
    (try_begin),
      (eq, "$temp1", 0),
      (start_mission_conversation, "trp_centurio_west"),
    (else_try),
      (start_mission_conversation, "$temp2"),
    (try_end),
    ]),

    (ti_tab_pressed, 0, 0,
    [
       (set_trigger_result, 1),
    ],[]),

	  ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("event3_talk", mtf_battle_mode, -1,
  "lala",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, [itm_roman_gladius]),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, [itm_roman_gladius]),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, [itm_dagger]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    remove_banners,
    (ti_before_mission_start, 0, 0, [],
    [
       (set_global_cloud_amount, 0),
       (set_rain, 2, 0),
       (set_rain, 1, 0),
       (set_rain, 0, 100),
    ]),
      (1, 0, 0, [
          (eq, "$temp1", 0),
          (get_player_agent_no,":player_agent"),
          (agent_get_position,pos1,":player_agent"),
          (assign,":continue",0),
          (try_for_agents, ":cur_agent"),
            (agent_get_troop_id, ":troop", ":cur_agent"),
            (neq, ":troop", "trp_player"),
            (neg|is_between, ":troop", companions_begin, companions_end),
            (agent_get_position,pos2,":cur_agent"),
            (get_distance_between_positions,":distance",pos1,pos2),
            (lt,":distance",1000),
           # (agent_set_team, ":cur_agent", 1),
            (assign,":continue",1),
          (try_end),
          (eq,":continue",1),
        ],
        [
    (start_mission_conversation, "trp_avaritia"),
    (assign, "$temp1", 1),
      ]),

    (1, 0, 0,
    [
       (eq, "$temp1", 2),
    ],[
    (jump_to_menu, "mnu_auto_return_map"),
    (finish_mission),
    (display_message, "@As the stolen wine was not found, all soldiers of your centuria are punished.", color_terrible_news),
    ]),
      (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

      (1, 4, ti_once, [
      (neg|main_hero_fallen),
      (assign, ":continue", 1),
      (try_for_agents,":cur_agent"),
        (agent_get_troop_id,":cur_troop_id",":cur_agent"),
        (this_or_next|eq, ":cur_troop_id", "trp_superbus"),
        (eq, ":cur_troop_id", "trp_avaritia"),
        (agent_is_alive,":cur_agent"),
        (assign, ":continue", 0),
      (try_end),
      (ge, ":continue", 1),
      ],
        [
        #  (jump_to_menu, "mnu_freelancer_event_3_victory"),
          (stop_all_sounds, 1),
          (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
          (assign, "$auto_menu", "mnu_freelancer_event_1_wine_vic"),
          (jump_to_menu, "mnu_auto_return_map"),
          (finish_mission),

         # (jump_to_menu, "mnu_freelancer_event_3_victory"),
      ]),
      (1, 0, ti_once, [
      (main_hero_fallen),
      ],
        [
        (assign, "$temp1", 2),
      ]),
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("pandateria", mtf_battle_mode, -1,
  "lala",
  [
    (0, mtef_team_3|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (1, mtef_team_1|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, [itm_roman_gladius]),
    (2, mtef_team_1|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, [itm_roman_gladius]),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, [itm_roman_gladius]),
    (4, mtef_team_1|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, [itm_roman_gladius]),
    (5, mtef_team_1|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, [itm_roman_gladius]),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (7, mtef_team_2|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (8, mtef_team_2|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (9, mtef_team_2|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (10, mtef_team_2|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (11, mtef_team_2|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (12, mtef_team_2|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
  ], p_wetter + global_common_triggers  +
  [
    cannot_spawn_commoners,
    remove_banners,
    improved_lightning,

    (ti_before_mission_start, 0, 0, [],
    [
        (scene_set_day_time, 12),
        (team_set_relation, 0, 1, 1), # -1 for enemy, 1 for friend, 0 for neutral
        (team_set_relation, 0, 2, 1), # -1 for enemy, 1 for friend, 0 for neutral
        (team_set_relation, 1, 2, 1), # -1 for enemy, 1 for friend, 0 for neutral
        (team_set_relation, 0, 3, 1), # -1 for enemy, 1 for friend, 0 for neutral
        (team_set_relation, 1, 3, 1), # -1 for enemy, 1 for friend, 0 for neutral
        (team_set_relation, 2, 3, 1), # -1 for enemy, 1 for friend, 0 for neutral
        (set_global_cloud_amount, 0),
        (set_rain, 2, 0),
        (set_rain, 1, 0),
        (set_rain, 0, 100),
    ]),

    (0, 0, ti_once, [],[
        (get_player_agent_no, ":player"),
        (try_for_agents, ":agent"),
            (agent_is_active, ":agent"),
            (agent_set_no_death_knock_down_only, ":agent", 1),
            (neq, ":agent", ":player"),
            (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 0),
        (try_end),
    ]),

    (ti_on_agent_knocked_down, 0, 0, [],
    [
        (store_trigger_param_1, ":dead_agent"),
        (agent_get_troop_id, ":troop", ":dead_agent"),
        (eq, ":troop", "trp_slave_female"),

        (val_add, "$temp", 1),
        (store_mod,":continue", "$temp", 2),
        (try_begin),
            (eq, ":continue", 0),
            (agent_set_no_death_knock_down_only, ":dead_agent", 0),
        (try_end),
    ]),

    (0, 1, ti_once, [
        (eq, "$temp1", 0),
    ],
    [
        (mission_enable_talk),
        (start_mission_conversation, "trp_centurio_preatoriani"),
        (assign, "$temp1", 1),
    ]),

    (6, 0, 0, [
        (num_active_teams_le, 3),
    ],
    [
        (stop_all_sounds, 1),
        (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
        (assign, "$auto_menu", "mnu_freelancer_event_pret_2_end"),
        (jump_to_menu, "mnu_auto_return_map"),
        (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
        (finish_mission, 3),
    ]),

    (0, 0, 0,[
        (key_clicked, key_k),
        (tutorial_message, -1),
    ],[]),
        (3,0,0,[
        (eq,"$temp1",2),
        (neg|conversation_screen_is_active),
    ],
    [
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@Kill the slaves using the staff. ^^(press K to finish read)"),
        (assign,"$temp1",3),
    ]),

    (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("event_pret_talk", 0, -1,
  "lala",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, [itm_roman_gladius]),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, [itm_roman_gladius]),
    (9, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_roman_gladius,itm_praetorian_segmentata_2,itm_graves_simple]),
    (10, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (11, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (12, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    remove_banners,
    improved_lightning,
      (1, 0, 0, [
        (eq, "$temp1", 0),
        (neg|conversation_screen_is_active),],
        [
    (start_mission_conversation, "trp_praetoriani_milites_exp"),
    (assign, "$temp1", 1),
      ]),

    (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("seneca_talk", 0, -1,
  "lala",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head|af_override_weapons, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse|af_override_head, 0, 1, []),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    remove_banners,
    improved_lightning,
      (1, 0, 0, [
          (eq, "$temp1", 0),
          (neg|conversation_screen_is_active),
        ],
        [
    (start_mission_conversation, "trp_seneca"),
    (assign, "$temp1", 1),
      ]),

     (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

 	  ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("bandit_fight", 0,-1,
  "monasterio",[
    (0,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (1,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (2,mtef_visitor_source|mtef_team_1,af_override_horse,0, 1,[]),
    (3,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (4,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (5,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (6,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (7,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
  ],p_wetter+ global_common_triggers +
  [
    improved_lightning,
    cannot_spawn_commoners,
    (dedal_shield_bash),
    (dedal_shield_bash_AI),
       (ti_before_mission_start, 0, 0, [],[
          (team_set_relation, 0, 1, -1), # -1 for enemy, 1 for friend, 0 for neutral
          # (team_set_relation,1,2,0),
          # (team_set_relation,0,1,0),
      ]),

      (0.5, 0, ti_once, [],[
          (mission_disable_talk),
          (set_show_messages, 0),
          (get_player_agent_no, ":player"),
          (agent_get_team, ":playerteam", ":player"),
          (team_give_order, ":playerteam", 8, mordr_follow), #Division 8 to avoid potential conflicts
          (set_show_messages, 1),
      ]),


      (ti_on_agent_spawn, 0, 0, [],
        [
          (store_trigger_param_1, ":agent"),
          (agent_is_active, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_is_human, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (neq, ":troop", "trp_player"),

          (try_begin),
            (this_or_next|eq, ":troop", "trp_brigand"),
            (this_or_next|eq, ":troop", "trp_bandit"),
            (eq, ":troop", "trp_looter"),
            (agent_set_team, ":agent", 7),
          (else_try),
            (is_between, ":troop", "trp_legio_xxii_primigenia", "trp_looter"),
            (get_player_agent_no, ":player"),
            (agent_get_team, ":playerteam", ":player"),
            (agent_set_team, ":agent", ":playerteam"),
            (agent_set_division, ":agent", 8),
            (agent_add_relation_with_agent, ":agent", ":player", 1),
            (agent_set_is_alarmed, ":agent", 1),
          (try_end),
      ]),

      # (ti_on_agent_killed_or_wounded, 0, 0, [],
        # [
          # (store_trigger_param_1, ":dead_agent"),

          # (agent_get_troop_id, ":troop", ":dead_agent"),
          # (neq, ":troop", "trp_player"),
          # (troop_is_hero, ":troop"),
          # (main_party_has_troop, ":troop"),
          # (party_wound_members, "$enlisted_party", ":troop", 1),
      # ]),
      #################


      (0, 0, ti_once, [

          (tutorial_message_set_size, 15, 15),
          (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
          (tutorial_message_set_center_justify, 0),
          ],[]),

      (1,0,0,[                        (neg|conversation_screen_is_active),
          (neg|is_presentation_active, "prsnt_battle"),
          (neg|is_presentation_active, "prsnt_order_display"),

        ],
        [
          (store_mission_timer_a, ":cur_time"),
          (try_begin),
            (ge, ":cur_time", 10),
            (tutorial_message, -1),
            (tutorial_message_set_background, 0),
          (else_try),
            (ge, ":cur_time", 4),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@You have tracked down the bandits to their camp. They are not expecting you. Attack and defeat them."),
          (try_end),
      ]),
      custom_commander_critical_strike,
      common_inventory_not_available,
      common_battle_init_banner,
      wounds_vc,

      (5, 0, 0, [
          (store_skill_level,":player_sneaking_skill","skl_athletics","trp_player"),
          (assign,":sneak_distance",1500),
          (val_mul, ":player_sneaking_skill", 10),
          (val_sub, ":sneak_distance", ":player_sneaking_skill"),
          (get_player_agent_no,":player_agent"),
          (agent_get_position,pos1,":player_agent"),
          (assign,":continue",0),
          (try_for_agents, ":cur_agent"),
            (agent_get_troop_id, ":troop", ":cur_agent"),
            (neq, ":troop", "trp_player"),
            (neg|is_between, ":troop", "trp_legio_xxii_primigenia", "trp_looter"),
            (agent_get_position,pos2,":cur_agent"),
            (get_distance_between_positions,":distance",pos1,pos2),
            (lt,":distance",":sneak_distance"),
           # (agent_set_team, ":cur_agent", 1),
            (assign,":continue",1),
          (try_end),
          (eq,":continue",1),
        ],
        [
         (team_set_relation,0,7,-1),
          (set_party_battle_mode),
          # (try_for_agents, ":cur_agent"),
            # (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
            # (eq, ":cur_agent_troop", "trp_lucillus"),
            # (agent_set_team, ":cur_agent", 1),
          # (try_end),
      ]),


      (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

      (1, 4, ti_once, [
      (neg|main_hero_fallen),
      (assign, ":continue", 1),
      (try_for_agents,":cur_agent"),
        (agent_get_troop_id,":cur_troop_id",":cur_agent"),
        (this_or_next|eq, ":cur_troop_id", "trp_bandit"),
        (this_or_next|eq, ":cur_troop_id", "trp_brigand"),
        (eq, ":cur_troop_id", "trp_looter"),
        (agent_is_alive,":cur_agent"),
        (assign, ":continue", 0),
      (try_end),
      (ge, ":continue", 1),
      ],
        [
        #  (jump_to_menu, "mnu_freelancer_event_3_victory"),
          (stop_all_sounds, 1),
          (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
          (assign, "$auto_menu", "mnu_freelancer_event_3_victory"),
          (jump_to_menu, "mnu_auto_return_map"),
          (finish_mission),

         # (jump_to_menu, "mnu_freelancer_event_3_victory"),
      ]),
      (5, 3, ti_once, #normal mode
        [		 (main_hero_fallen),
        ],
        [
        #  (jump_to_menu, "mnu_freelancer_event_3_defeat"),
          (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
          (assign, "$auto_menu", "mnu_freelancer_event_3_defeat"),
          (jump_to_menu, "mnu_auto_return_map"),
          (stop_all_sounds, 1),
          (finish_mission),
       #   (jump_to_menu, "mnu_freelancer_event_3_defeat"),
      ]),
]),

("street_fight", mtf_battle_mode,-1,
    "monasterio",
    [
      (0,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (1,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
      (2,mtef_visitor_source|mtef_team_2,af_override_horse,0, 1,[]),
      (3,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
      (4,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
      (5,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (6,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (7,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (8,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (9,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (10,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (11,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (12,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_old_gladius_1,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (13,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (14,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (15,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_old_gladius_1,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (16,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (17,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_old_gladius_1,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (18,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (19,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_old_gladius_1,itm_knife,itm_wooden_stick,itm_pitch_fork]),
      (20,mtef_visitor_source|mtef_team_1,af_override_weapons,0,1,[itm_dagger,itm_old_gladius_1,itm_knife,itm_wooden_stick,itm_pitch_fork]),
  ],p_wetter+ global_common_triggers +
  [
    cannot_spawn_commoners,
    remove_banners,
    improved_lightning,
       (ti_before_mission_start, 0, 0, [],[
          (team_set_relation, 0, 1, -1), # -1 for enemy, 1 for friend, 0 for neutral
          (team_set_relation, 0, 2, 1), # -1 for enemy, 1 for friend, 0 for neutral
          (team_set_relation, 1, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
      ]),


      (ti_on_agent_spawn, 0, 0, [],
        [
          (store_trigger_param_1, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_is_active, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (neq, ":troop", "trp_player"),
         # (agent_get_entry_no, ":entry", ":agent"),
         # (assign, reg0, ":entry"),
          (agent_get_team, ":team", ":agent"),
         # (str_store_troop_name, s1, ":troop"),
         # (display_message, "@team: {reg1}, troop: {s1}"),
          (agent_set_is_alarmed, ":agent", 1),
          (try_begin),
            (eq, ":team", 0),
            (is_between, ":troop", "trp_legio_xxii_primigenia", "trp_looter"),
            (get_player_agent_no, ":player"),
            (agent_get_team, ":playerteam", ":player"),
            (agent_set_team, ":agent", ":playerteam"),
            (agent_set_division, ":agent", 8),
            (agent_add_relation_with_agent, ":agent", ":player", 1),
            (quest_get_slot, ":lord", "qst_freelancing", slot_quest_giver_troop),
            (cur_agent_set_banner_tableau_material, "tableau_game_troop_label_banner", ":lord"),
          (try_end),
      ]),


       (1, 4, ti_once, [
      (neg|main_hero_fallen),
      (all_enemies_defeated, 1),
      ],
        [
        #  (jump_to_menu, "mnu_freelancer_event_3_victory"),
          (stop_all_sounds, 1),
          (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
          (assign, "$temp4", 1),
          (assign, "$auto_menu", "mnu_freelancer_event_pret_1_vitory"),
          (jump_to_menu, "mnu_auto_return_map"),
          (finish_mission),

         # (jump_to_menu, "mnu_freelancer_event_3_victory"),
      ]),
      (5, 3, ti_once, #normal mode
        [		 (main_hero_fallen),
        ],
        [
        #  (jump_to_menu, "mnu_freelancer_event_3_defeat"),
          (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
          (assign, "$temp4", -1),
          (assign, "$auto_menu", "mnu_freelancer_event_pret_1_vitory"),
          (jump_to_menu, "mnu_auto_return_map"),
          (stop_all_sounds, 1),
          (finish_mission),
       #   (jump_to_menu, "mnu_freelancer_event_3_defeat"),
      ]),
      common_inventory_not_available,
      wounds_vc,
  dedal_shield_bash_AI,
	dedal_shield_bash,
  custom_commander_critical_strike,
]),

("street_fight_2", mtf_battle_mode,-1,
    "monasterio",
    [
      (0,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (1,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
      (2,mtef_visitor_source|mtef_team_2,af_override_horse,0, 1,[]),
      (3,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
      (4,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
      (5,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (6,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (7,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (8,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (9,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (10,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (11,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (12,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (13,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (14,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (15,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (16,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (17,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (18,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (19,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (20,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    ],p_wetter+ global_common_triggers +
    [
      cannot_spawn_commoners,
    remove_banners,
    improved_lightning,
       (ti_before_mission_start, 0, 0, [],[
          (team_set_relation, 0, 1, -1), # -1 for enemy, 1 for friend, 0 for neutral
          (team_set_relation, 0, 2, 1), # -1 for enemy, 1 for friend, 0 for neutral
          (team_set_relation, 1, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
      ]),


      (ti_on_agent_spawn, 0, 0, [],
        [
          (store_trigger_param_1, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_is_active, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (neq, ":troop", "trp_player"),
         # (agent_get_entry_no, ":entry", ":agent"),
         # (assign, reg0, ":entry"),
          (agent_get_team, ":team", ":agent"),
         # (str_store_troop_name, s1, ":troop"),
         # (display_message, "@team: {reg1}, troop: {s1}"),
          (agent_set_is_alarmed, ":agent", 1),
          (try_begin),
            (eq, ":team", 0),
            (is_between, ":troop", "trp_legio_xxii_primigenia", "trp_looter"),
            (get_player_agent_no, ":player"),
            (agent_get_team, ":playerteam", ":player"),
            (agent_set_team, ":agent", ":playerteam"),
            (agent_set_division, ":agent", 8),
            (agent_add_relation_with_agent, ":agent", ":player", 1),
            (quest_get_slot, ":lord", "qst_freelancing", slot_quest_giver_troop),
            (cur_agent_set_banner_tableau_material, "tableau_game_troop_label_banner", ":lord"),
          (try_end),
      ]),


       (1, 4, ti_once, [
      (neg|main_hero_fallen),
      (all_enemies_defeated, 1),
      ],
        [
        #  (jump_to_menu, "mnu_freelancer_event_3_victory"),
          (stop_all_sounds, 1),
          (call_script, "script_change_player_relation_with_center", "p_town_6", 4),
          (call_script, "script_change_player_honor", 5),
          (call_script, "script_change_troop_renown", "trp_player", 10),
          (jump_to_menu, "mnu_crushed_revolt"),
          (finish_mission),

         # (jump_to_menu, "mnu_freelancer_event_3_victory"),
      ]),
      (5, 3, ti_once, #normal mode
        [		 (main_hero_fallen),
        ],
        [
          (stop_all_sounds, 1),
          (call_script, "script_change_player_relation_with_center", "p_town_6", 2),
          (jump_to_menu, "mnu_crushed_revolt"),
          (finish_mission),
      ]),
      common_inventory_not_available,
      wounds_vc,
  dedal_shield_bash_AI,
	dedal_shield_bash,
  custom_commander_critical_strike,
]),

("bandit_fight_farmestead", mtf_battle_mode,-1,
    "monasterio",
    [
      (0,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
      (1,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
      (2,mtef_visitor_source|mtef_team_2,af_override_horse,0, 1,[]),
      (3,mtef_visitor_source|mtef_team_3,af_override_horse,0,1,[]),
    ],
    p_wetter+ global_common_triggers +
    [
      cannot_spawn_commoners,
        remove_banners,
        improved_lightning,
       (ti_before_mission_start, 0, 0, [],[
          (team_set_relation, 0, 1, 1), # -1 for enemy, 1 for friend, 0 for neutral
          (team_set_relation, 1, 0, 1), # -1 for enemy, 1 for friend, 0 for neutral
          (team_set_relation, 1, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
          (team_set_relation, 1, 3, -1), # -1 for enemy, 1 for friend, 0 for neutral
          (team_set_relation, 2, 3, -1), # -1 for enemy, 1 for friend, 0 for neutral
          (team_set_relation, 0, 3, -1), # -1 for enemy, 1 for friend, 0 for neutral
          (team_set_relation, 0, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
          # (team_set_relation,1,2,0),
          # (team_set_relation,0,1,0),
      ]),

 (ti_on_agent_killed_or_wounded, 0, 0, [],
    [
     #(neq, "$temp1", -1),
     (store_trigger_param_1, ":dead_agent"),

     (agent_get_troop_id, ":troop", ":dead_agent"),
     (this_or_next|eq, ":troop", "trp_slave"),
     (this_or_next|eq, ":troop", "trp_slave_female"),
     (this_or_next|eq, ":troop", "trp_roman_village_walker"),
     (eq, ":troop", "trp_peasant_woman"),
     (val_add, "$temp1", 1),
    ]),

      (ti_on_agent_spawn, 0, 0, [],
        [
          (store_trigger_param_1, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_is_active, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (neq, ":troop", "trp_player"),
         # (agent_get_entry_no, ":entry", ":agent"),
         # (assign, reg0, ":entry"),
          (agent_get_team, ":team", ":agent"),
         # (str_store_troop_name, s1, ":troop"),
         # (display_message, "@team: {reg1}, troop: {s1}"),
          (agent_set_is_alarmed, ":agent", 1),
          (try_begin),
            (eq, ":team", 0),
            (is_between, ":troop", "trp_legio_xxii_primigenia", "trp_looter"),
            (get_player_agent_no, ":player"),
            (agent_get_team, ":playerteam", ":player"),
            (agent_set_team, ":agent", ":playerteam"),
            (agent_set_division, ":agent", 8),
            (agent_add_relation_with_agent, ":agent", ":player", 1),
            (quest_get_slot, ":lord", "qst_freelancing", slot_quest_giver_troop),
            (cur_agent_set_banner_tableau_material, "tableau_game_troop_label_banner", ":lord"),
          (else_try),
            (eq, ":team", 1),
            (this_or_next|eq, ":troop", "trp_slave"),
            (this_or_next|eq, ":troop", "trp_slave_female"),
            (this_or_next|eq, ":troop", "trp_roman_village_walker"),
            (eq, ":troop", "trp_peasant_woman"),
            (agent_set_division, ":agent", 8),
            (quest_get_slot, ":lord", "qst_freelancing", slot_quest_giver_troop),
            (cur_agent_set_banner_tableau_material, "tableau_game_troop_label_banner", ":lord"),
          (try_end),
      ]),
      (0.5, 0, ti_once, [],[
          (mission_disable_talk),
          (set_show_messages, 0),
          (get_player_agent_no, ":player"),
          (agent_get_team, ":playerteam", ":player"),
          (team_give_order, ":playerteam", 8, mordr_follow),

          (try_for_range, ":cur_group", 0, grc_everyone),
            (team_give_order, 1, ":cur_group", mordr_hold),
            (team_give_order, 1, ":cur_group", mordr_stand_closer),
            (team_give_order, 1, ":cur_group", mordr_stand_closer),
            (team_give_order, 1, ":cur_group", mordr_hold),
            (team_give_order, 1, ":cur_group", mordr_stand_closer),
            (team_give_order, 1, ":cur_group", mordr_stand_closer),
          (try_end),

          (try_for_range, ":cur_group", 0, grc_everyone),
            (team_give_order, 3, ":cur_group", mordr_charge),
            (team_give_order, 3, ":cur_group", mordr_stand_closer),
            (team_give_order, 3, ":cur_group", mordr_stand_closer),
            (team_give_order, 3, ":cur_group", mordr_charge),
            (team_give_order, 3, ":cur_group", mordr_stand_closer),
            (team_give_order, 3, ":cur_group", mordr_stand_closer),
          (try_end),

          (try_for_range, ":cur_group", 0, grc_everyone),
            (team_give_order, 2, ":cur_group", mordr_charge),
            (team_give_order, 2, ":cur_group", mordr_stand_closer),
            (team_give_order, 2, ":cur_group", mordr_stand_closer),
            (team_give_order, 2, ":cur_group", mordr_charge),
            (team_give_order, 2, ":cur_group", mordr_stand_closer),
            (team_give_order, 2, ":cur_group", mordr_stand_closer),
          (try_end),
          (set_show_messages, 1),
      ]),
       (1, 4, ti_once, [
      (neg|main_hero_fallen),
      (all_enemies_defeated, 2),
      (all_enemies_defeated, 3),
      ],
        [
        #  (jump_to_menu, "mnu_freelancer_event_3_victory"),
          (stop_all_sounds, 1),
          (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
          (assign, "$auto_menu", "mnu_freelancer_event_9_victory"),
          (jump_to_menu, "mnu_auto_return_map"),
          (finish_mission),

         # (jump_to_menu, "mnu_freelancer_event_3_victory"),
      ]),
      (5, 3, ti_once, #normal mode
        [		 (main_hero_fallen),
        ],
        [
        #  (jump_to_menu, "mnu_freelancer_event_3_defeat"),
          (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
          (assign, "$auto_menu", "mnu_freelancer_event_9_defeat"),
          (jump_to_menu, "mnu_auto_return_map"),
          (stop_all_sounds, 1),
          (finish_mission),
       #   (jump_to_menu, "mnu_freelancer_event_3_defeat"),
      ]),
  wounds_vc,
  dedal_shield_bash_AI,
	dedal_shield_bash,
  custom_commander_critical_strike,
]),

("legion_marsh",0,-1,
  "plundering a settlement",
  [
    (0,mtef_scene_source,af_override_horse,0,1,[]),#player
    (1,mtef_visitor_source,af_override_horse,0,1,[]),#guard
    (2,mtef_visitor_source,af_override_horse,0,1,[]),#guard
    (3,mtef_visitor_source,af_override_horse,0,1,[]),#legatus
    (4,mtef_visitor_source,af_override_horse,0,1,[]),#legatus
    (5,mtef_visitor_source,af_override_horse,0,1,[]),#unused
    (6,mtef_visitor_source,af_override_horse,0,1,[]),#unused
    (7,mtef_visitor_source,af_override_horse,0,1,[]),#unused
  ], p_wetter + # global_common_triggers + # not needed and conflicts
  [
    cannot_spawn_commoners,
    improved_lightning,

    (ti_after_mission_start, 0, ti_once, [],[
      (mission_cam_set_screen_color, 0xFF736252), #roughly the colour of the menu bg
      (mission_cam_animate_to_screen_color, 0x00736252, 1500),
    ]),

		(1,0,0,[],[
      (store_mission_timer_a, ":cur_time"),
      (set_fixed_point_multiplier, 100),
      (ge, ":cur_time", 90),
      (call_script, "script_freelancer_add_progress", 10),
      (add_xp_as_reward, 500),
			(jump_to_menu, "mnu_auto_return_map"),
			(finish_mission),
		]),

    (0, 0, ti_once,[],[
      #spawn a standard bearer and ranks of soldiers
      (set_fixed_point_multiplier, 100),
      (init_position, pos1),

      (entry_point_get_position, pos1, 121),

      (set_spawn_position, pos1),
      (spawn_agent, "$temp1"),
      (assign, "$temp4", reg0),

      (agent_set_speed_modifier, reg0, 500),
      (agent_set_horse_speed_factor, reg0, 500),
      (agent_set_speed_limit, reg0, 9),

      (position_move_x, pos1, -225), #1.5x column width
      (position_move_y, pos1, -200), # bearer ahead of troops
      (try_for_range, ":unused", 0, 20), #ranks
          (try_for_range, ":unused2", 0, 4), #columns
              (set_spawn_position, pos1),
              (try_begin),
                  (eq, ":unused", 0),
                  (try_begin),
                      (eq, ":unused2", 0),
                      (spawn_agent, "trp_cornicen"),
                      (agent_set_speed_modifier,reg0, 500),
                      (agent_set_horse_speed_factor, reg0, 500),
                      (agent_set_speed_limit, reg0, 3),
                  (else_try),
                      (eq, ":unused2", 1),
                      (spawn_agent, "$temp2"),
                      (agent_set_speed_modifier,reg0, 500),
                      (agent_set_horse_speed_factor, reg0, 500),
                      (agent_set_speed_limit, reg0, 3),
                  (else_try),
                      (eq, ":unused2", 2),
                      (spawn_agent, "$temp3"),
                      (agent_set_speed_modifier,reg0, 500),
                      (agent_set_horse_speed_factor, reg0, 500),
                      (agent_set_speed_limit, reg0, 3),
                  (else_try),
                      (eq, ":unused2", 3),
                      (spawn_agent, "trp_signifer"),
                      (agent_set_speed_modifier,reg0, 500),
                      (agent_set_horse_speed_factor, reg0, 500),
                      (agent_set_speed_limit, reg0, 3),
                  (try_end),
              (else_try),
                  (spawn_agent, "$temp"),
                  (agent_set_speed_modifier,reg0, 500),
                  (agent_set_horse_speed_factor, reg0, 500),
                  (agent_set_speed_limit, reg0, 3),
              (try_end),
              (position_move_x, pos1, 150), #1.5m between columns
          (try_end),
          # get back to first column of previous rank
          (position_move_x, pos1, -600), #4x1.5m
          (position_move_y, pos1, -150), #next rank 1.5m behind
      (try_end),
      (assign, reg50, 2),
    ]),

    (0, 0, 0,[
      (gt, "$temp4", 0),
      (agent_get_position, pos1, "$temp4"),
      (position_move_z, pos1, 350),
      (position_move_y, pos1, -1300),
      (mission_cam_set_position, pos1),
      (mission_cam_set_mode, 1, 0, 1),
      (set_fixed_point_multiplier, 100),
    ],[]),

    (1,0.5,0,[(eq, reg50, 2),],
    [
      (set_fixed_point_multiplier, 1000),
      # march the troops down the bridge
      (try_for_agents, ":agent_no"), # find everyone and march them off
          (agent_get_troop_id, ":agent_troop", ":agent_no"),
          (this_or_next|eq, ":agent_troop", "trp_signifer"),
          (this_or_next|eq, ":agent_troop", "$temp"),
          (this_or_next|eq, ":agent_troop", "$temp1"),
          (this_or_next|eq, ":agent_troop", "$temp2"),
          (this_or_next|eq, ":agent_troop", "$temp3"),
          (eq, ":agent_troop", "trp_cornicen"),
          (agent_get_position, pos1, ":agent_no"),
          (position_move_x, pos1, -59950), # correction for angle numerical loss
          (position_move_y, pos1, 200000),
          (agent_set_scripted_destination, ":agent_no", pos1, 1),
      (try_end),
      (assign, reg50, 3),
    ]),

    (10, 0, 0, [
      (try_for_agents, ":agent_no"),
          (agent_is_human, ":agent_no"),
          (agent_is_alive, ":agent_no"),
          (agent_get_troop_id, ":id", ":agent_no"),
          (try_begin),
              (eq, ":id", "trp_cornicen"),
              (try_begin),
                  (agent_has_item_equipped, ":agent_no", "itm_f_cornu"),
              (else_try),
                  (agent_equip_item, ":agent_no", "itm_f_cornu"),
              (try_end),
              (agent_set_wielded_item, ":agent_no", "itm_f_cornu"),
              (agent_set_animation, ":agent_no", "anim_cornu_play", 1),
              (agent_play_sound, ":agent_no", "snd_cornu"),
          (try_end),
      (try_end),
    ],[]),

    (ti_tab_pressed, 0, 0, [],[
      (question_box,"@Do you want to skip the cutscene? You won't recieve any progress points if you skip."),
    ]),

    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (jump_to_menu, "mnu_auto_return_map"),
      (stop_all_sounds, 1),
      (finish_mission,0),
    ]),
    common_inventory_not_available,
]),

("faustus_last_battle", mtf_battle_mode, -1, "monasterio",[
    (0,mtef_visitor_source|mtef_team_1,  0,aif_start_alarmed,1,[]),
    (1,mtef_visitor_source|mtef_team_1,  0,aif_start_alarmed,1,[]),
    (2,mtef_visitor_source|mtef_team_0,  0,aif_start_alarmed,1,[]),
    (3,mtef_visitor_source|mtef_team_0,  0,aif_start_alarmed,1,[]),
    (4,mtef_visitor_source|mtef_team_0,  0,aif_start_alarmed,1,[]),
    (5,mtef_visitor_source|mtef_team_0,  0,aif_start_alarmed,1,[]),
    (6,mtef_visitor_source|mtef_team_0,  0,aif_start_alarmed,1,[]),
    (7,mtef_visitor_source|mtef_team_0,  0,aif_start_alarmed,1,[]),
    (8,mtef_visitor_source|mtef_team_0,  0,aif_start_alarmed,1,[]),
    (9,mtef_visitor_source|mtef_team_0,  0,aif_start_alarmed,1,[]),
    (10,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    remove_banners,
    improved_lightning,
    common_siege_attacker_do_not_stall,
    (2, 4, 1,[
      (main_hero_fallen),
      (call_script, "script_cf_dplmc_battle_continuation"),
    ],[]),

    (0, 0, ti_once, [],[
      (call_script, "script_init_death_cam"), #SB : add camera
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),
    #cannot_spawn_commoners,
    common_inventory_not_available,
    common_battle_init_banner,
    #common_realistic_casualties, 		#!
    wounds_vc,
    dedal_shield_bash,
    dedal_shield_bash_AI,

    (ti_before_mission_start, 0, 0, [],[
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
      (call_script, "script_change_banners_and_chest")
    ]),
    (ti_after_mission_start, 0, 0, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_fight)
    ]),
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_2, ":killer_agent_no"),
      (get_player_agent_no, ":player"),
      (eq, ":killer_agent_no", ":player"),
      (val_add, "$temp", 1),
    ]),
    (ti_tab_pressed, 0, 0, [
      (display_message,"str_cannot_leave_now")
    ],[]),
    (1, 10, 1, [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le,1)
    ],[
      (try_begin),
          (num_active_teams_le,1),
          (main_hero_fallen),
          # (jump_to_menu, "mnu_freelancer_event_pret_9_lost"),
          (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
          (assign, "$auto_menu", "mnu_freelancer_event_pret_9_lost"),
          (jump_to_menu, "mnu_auto_return_map"),
          (stop_all_sounds, 1),
          (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
          (finish_mission, 3),
      (else_try),
          (neg|main_hero_fallen),
          (num_active_teams_le,1),
          # (jump_to_menu, "mnu_freelancer_event_pret_9_vic"),
          (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
          (assign, "$auto_menu", "mnu_freelancer_event_pret_9_vic"),
          (jump_to_menu, "mnu_auto_return_map"),
          (stop_all_sounds, 1),
          (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
          (finish_mission, 3),
      (try_end),
    ]),

    (0, 1, ti_once, [
      (main_hero_fallen),
    ],[
      (team_set_order_listener, "$attacker_team", grc_everyone),
      (team_give_order, "$attacker_team", grc_everyone, mordr_use_any_weapon),
      (team_give_order, "$attacker_team", grc_everyone, mordr_fire_at_will),
      (team_give_order, "$attacker_team", grc_everyone, mordr_charge),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent_no"),
      (try_begin),
          (ge, ":dead_agent_no", 0),
          (neg|agent_is_ally, ":dead_agent_no"),
          (agent_is_human, ":dead_agent_no"),
          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),

          (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),

          (try_begin),
              (call_script, "script_cf_force_wound_troop", ":dead_agent_troop_id"),
              (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
              (set_trigger_result, 2),
          (else_try),
              (neg|troop_is_hero, ":dead_agent_troop_id"),
              (eq, "$g_realistic_wounding", 1),
              (le, ":last_damage", 13),
              (set_trigger_result, 2),
          (else_try),
              (neg|troop_is_hero, ":dead_agent_troop_id"),
              (eq, "$g_realistic_wounding", 1),
              (ge, ":last_damage", 40),
              (set_trigger_result, 1),
          (else_try),
              (set_trigger_result, 0),
          (try_end),
      (try_end),
    ]),
    (0, 0, ti_once, [],[
      (set_show_messages, 0),
      (try_for_range, ":cur_group", 0, 9),
          (team_give_order, "$defender_team", ":cur_group", mordr_stand_ground),
          (team_give_order, "$defender_team", ":cur_group", mordr_stand_closer),
          (team_give_order, "$defender_team", ":cur_group", mordr_stand_closer),
          # (team_give_order, 0, ":cur_group", mordr_hold_fire),
      (try_end),
      (set_show_messages, 1),
    ]),
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent"),
      (agent_is_alive, ":agent"),
      (agent_is_active, ":agent"),
      (agent_is_ally, ":agent"),
      (quest_get_slot, ":lord", "qst_freelancing", slot_quest_giver_troop),
      (cur_agent_set_banner_tableau_material, "tableau_game_troop_label_banner", ":lord"),
    ]),
    (240, 0, 0, [],[
      (get_player_agent_no, ":player_no"),
      (try_for_agents,":cur_agent"),
          (neq, ":cur_agent", ":player_no"),
          (agent_is_active, ":cur_agent"),
          (agent_is_alive, ":cur_agent"),
          (agent_is_human, ":cur_agent"),
          (agent_get_team, ":agent_team", ":cur_agent"),
          (eq, ":agent_team", 1),
          (agent_refill_ammo, ":cur_agent"),
      (try_end),
    ]),
  ] + dplmc_battle_mode_triggers + auxiliary_player
),
("thunder_god_fight", mtf_battle_mode,-1,
    "monasterio",
    [ (0,mtef_team_0, af_override_horse,aif_start_alarmed,60,[]),
      (1,mtef_team_0, af_override_horse,aif_start_alarmed,60,[]),
      (2,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed, 12,[]),
      (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),
      (4,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),
      (5,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),
      (6,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),
      (7,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),
      (8,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),
      (9,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),
      (10,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),
      (11,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,12,[]),
    ], p_wetter + storms + global_common_triggers +
    [
      cannot_spawn_commoners,
      improved_lightning,
      #cannot_spawn_commoners,
      common_inventory_not_available,
      common_battle_init_banner,
      #common_realistic_casualties, 		#!
      wounds_vc,
      dedal_shield_bash,
      dedal_shield_bash_AI,
      (ti_before_mission_start, 0, 0, [],
        [
          (assign,"$g_battle_result",0),
          (call_script, "script_change_banners_and_chest")
        ]
      ),
     (ti_after_mission_start, 0, 0, [],[(call_script, "script_music_set_situation_with_culture", mtf_sit_fight)]),

      (ti_on_agent_killed_or_wounded, 0, 0, [],
        [
          (store_trigger_param_1, ":dead_agent_no"),
          (store_trigger_param_3, ":is_wounded"),
          #(store_trigger_param_2, ":killer_agent_no"),
          (get_player_agent_no, ":player"),
          (neq, ":dead_agent_no", ":player"),
          (try_begin),
            (ge, ":dead_agent_no", 0),
            (agent_is_ally, ":dead_agent_no"),
            (agent_is_human, ":dead_agent_no"),
            (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
            (try_begin),
                (eq, ":is_wounded", 1),
                (party_wound_members, "p_main_party", ":dead_agent_troop_id", 1),
            (else_try),
                (party_remove_members, "p_main_party", ":dead_agent_troop_id", 1),
            (try_end),
            #(party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
            #(agent_slot_eq, ":dead_agent_no", slot_agent_vc_wounded, 1),	#new
            #(party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
          (try_end),
          #(call_script, "script_apply_death_effect_on_courage_scores", ":dead_agent_no", ":killer_agent_no"),
      ]),

      (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

      (1, 10, ti_once, [(this_or_next|main_hero_fallen),(num_active_teams_le,1)],
        [
          (try_begin),
            (main_hero_fallen),
            (assign, "$temp",1),
            (jump_to_menu, "mnu_attack_thunder_god_win"),
          (else_try),
            (assign, "$temp",2),
            (jump_to_menu, "mnu_attack_thunder_god_win"),
          (try_end),
          (stop_all_sounds, 1),
          (finish_mission),
      ]),
]),
("nile_fight", mtf_battle_mode,-1,"monasterio",[
    (0,mtef_visitor_source|mtef_team_0, af_override_horse,aif_start_alarmed,0,[]),
    (1,mtef_visitor_source|mtef_team_0, af_override_horse,aif_start_alarmed,0,[]),
    (2,mtef_visitor_source|mtef_team_0,af_override_horse, aif_start_alarmed, 0,[]),
    (3,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),
    (4,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),
    (5,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),
    (6,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),
    (7,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),
    (8,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),
    (9,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    improved_lightning,
    cannot_spawn_commoners,
 (ti_before_mission_start, 0, 0, [
			 ],
   [
   (scene_set_day_time, 16),
   (set_global_cloud_amount, 0),
   # (set_shader_param_float, "@vAltDiffuse",0),#no snow
     ]),
      #cannot_spawn_commoners,
      common_inventory_not_available,
      common_battle_init_banner,
      #common_realistic_casualties, 		#!
      wounds_vc,
      dedal_shield_bash,
      dedal_shield_bash_AI,

     (ti_after_mission_start, 0, 0, [],[(call_script, "script_music_set_situation_with_culture", mtf_sit_fight)]),

      (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

      (1, 10, ti_once, [(this_or_next|main_hero_fallen),(num_active_teams_le,1)],
        [
          (try_begin),
            (main_hero_fallen),
            (assign, "$temp",1),
          (else_try),
            (assign, "$temp",2),
          (try_end),
          #(jump_to_menu, "mnu_freelancer_event_pret_11_2"),
          (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
          (assign, "$auto_menu", "mnu_freelancer_event_pret_11_2"),
          (jump_to_menu, "mnu_auto_return_map"),
          (stop_all_sounds, 1),
          (finish_mission),
      ]),
   (
  0, 0, ti_once, [],
  [
  (set_show_messages, 0),
    (try_for_range, ":cur_group", 0, 9),
      (team_give_order, 0, ":cur_group", mordr_stand_ground),
      (team_give_order, 0, ":cur_group", mordr_stand_closer),
      (team_give_order, 0, ":cur_group", mordr_stand_closer),
    (try_end),
  (set_show_messages, 1),
    ]
  ),
      (ti_on_agent_spawn, 0, 0, [],
        [
          (store_trigger_param_1, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_is_active, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (neq, ":troop", "trp_player"),
          (agent_set_is_alarmed, ":agent", 1),
          (try_begin),
            (is_between, ":troop", "trp_legio_xxii_primigenia", "trp_looter"),
            (get_player_agent_no, ":player"),
            (agent_get_team, ":playerteam", ":player"),
            (agent_set_team, ":agent", ":playerteam"),
            (agent_add_relation_with_agent, ":agent", ":player", 1),
            (quest_get_slot, ":lord", "qst_freelancing", slot_quest_giver_troop),
            (cur_agent_set_banner_tableau_material, "tableau_game_troop_label_banner", ":lord"),
          (try_end),
      ]),
]),

("pret_event_12", mtf_battle_mode,-1,
  "monasterio",[
    (0,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,0,[itm_roman_gladius]),
    (1,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,0,[itm_knife]),
    (2,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons, aif_start_alarmed, 0,[itm_roman_gladius]),
    (3,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,0,[itm_knife]),
    (4,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,0,[itm_roman_gladius]),
    (5,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,0,[itm_staff,itm_knife,itm_butchering_knife]),
    (6,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),
    (7,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),
    (8,mtef_visitor_source|mtef_team_1,af_override_horse|af_override_weapons,aif_start_alarmed,0,[itm_knife,itm_butchering_knife]),
    (9,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,0,[itm_staff,itm_knife,itm_butchering_knife]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    remove_banners,
    improved_lightning,

    #cannot_spawn_commoners,
    common_inventory_not_available,
    common_battle_init_banner,
    #common_realistic_casualties, 		#!
    wounds_vc,
    dedal_shield_bash,
    dedal_shield_bash_AI,
    (ti_before_mission_start, 0, 0, [],[
      (assign,"$g_battle_result",0),
      (call_script, "script_change_banners_and_chest")
    ]),
    (ti_after_mission_start, 0, 0, [],[(call_script, "script_music_set_situation_with_culture", mtf_sit_fight)]),

    (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

    (1, 10, ti_once, [(this_or_next|main_hero_fallen),(num_active_teams_le,1)],[
      (try_begin),
          (main_hero_fallen),
          (assign, "$temp",1),
      (else_try),
          (assign, "$temp",2),
      (try_end),
      #(jump_to_menu, "mnu_freelancer_event_pret_11_2"),
      (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
      (assign, "$auto_menu", "mnu_freelancer_event_pret_12_vic"),
      (jump_to_menu, "mnu_auto_return_map"),
      (stop_all_sounds, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
      (finish_mission, 3),
    ]),
    (0, 0, ti_once, [],[
      (set_show_messages, 0),
      (try_for_range, ":cur_group", 0, 9),
          (team_give_order, 1, ":cur_group", mordr_stand_ground),
          (team_give_order, 1, ":cur_group", mordr_stand_closer),
          (team_give_order, 1, ":cur_group", mordr_stand_closer),
      (try_end),
      (set_show_messages, 1),
    ]),
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent"),
      (agent_is_alive, ":agent"),
      (agent_is_active, ":agent"),
      (agent_get_troop_id, ":troop", ":agent"),
      (neq, ":troop", "trp_player"),
      (agent_set_is_alarmed, ":agent", 1),
      (try_begin),
        (is_between, ":troop", "trp_legio_xxii_primigenia", "trp_looter"),
        (get_player_agent_no, ":player"),
        (agent_get_team, ":playerteam", ":player"),
        (agent_set_team, ":agent", ":playerteam"),
        (agent_add_relation_with_agent, ":agent", ":player", 1),
        (quest_get_slot, ":lord", "qst_freelancing", slot_quest_giver_troop),
        (cur_agent_set_banner_tableau_material, "tableau_game_troop_label_banner", ":lord"),
      (try_end),
    ]),
]),

("freelancer_mission_bandit", mtf_battle_mode,-1,
  "monasterio",[
    (0,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,0,[]),
    (1,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,0,[]),
    (2,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,0,[]),
    (3,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,0,[]),
    (4,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,0,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    common_battle_check_friendly_kills,

    (ti_before_mission_start, 0, 0, [],[
      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),
      (team_set_relation, 0, 1, -1), # -1 for enemy, 1 for friend, 0 for neutral
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (team_set_relation, 2, 1, -1),
      (team_set_relation, 2, 3, -1),
      (quest_set_slot, "qst_freelancing", slot_quest_freelancer_agent_spawned, 0),
      (set_party_battle_mode),
    ]),

    common_inventory_not_available,
    common_battle_init_banner,
    wounds_vc,

    (ti_tab_pressed, 0, 0, [],[
      (question_box,"str_do_you_want_to_retreat"),
    ]),

    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (get_player_agent_no, ":player_agent"),
      (agent_get_kill_count, "$g_arena_training_kills", ":player_agent", 1),
      (agent_get_kill_count, ":wounded", ":player_agent"),
      (val_add, "$g_arena_training_kills", ":wounded"),
      (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
      (assign, "$auto_menu", "mnu_freelancer_task_failed"),
      (jump_to_menu, "mnu_auto_return_map"),
      (stop_all_sounds, 1),

      (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
      (finish_mission, 3),
    ]),
    (2, 6, 1, [],[
      (try_begin),
        (all_enemies_defeated),
        (get_player_agent_no, ":player_agent"),
        (agent_get_kill_count, "$g_arena_training_kills", ":player_agent", 1),
        (agent_get_kill_count, ":wounded", ":player_agent"),
        (val_add, "$g_arena_training_kills", ":wounded"),
        (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
        (assign, "$auto_menu", "mnu_freelancer_task_completed"),
        (jump_to_menu, "mnu_auto_return_map"),
        (stop_all_sounds, 1),
        (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
        (finish_mission, 3),
      (else_try),
        (num_active_teams_le,1),
        (main_hero_fallen),
        (get_player_agent_no, ":player_agent"),
        (agent_get_kill_count, "$g_arena_training_kills", ":player_agent", 1),
        (agent_get_kill_count, ":wounded", ":player_agent"),
        (val_add, "$g_arena_training_kills", ":wounded"),
        (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
        (assign, "$auto_menu", "mnu_freelancer_task_failed"),
        (jump_to_menu, "mnu_auto_return_map"),
        (stop_all_sounds, 1),
        (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
        (finish_mission, 3),
      (try_end),
    ]),

    (2, 4, 1, [
      (main_hero_fallen),
      (call_script, "script_cf_dplmc_battle_continuation"),
    ],[]),
    (0, 0, ti_once, [],[
      (call_script, "script_init_death_cam"), #SB : add camera
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),
    (0, 0, ti_once,[
    ],[
      (get_player_agent_no, ":player_agent"),
      (try_for_agents, ":agent_no"),
        (neq, ":agent_no", ":player_agent"),
        (agent_is_ally, ":agent_no"),
        (try_begin),
          (quest_get_slot,":spawned", "qst_freelancing", slot_quest_freelancer_agent_spawned),
          (quest_get_slot,":limit", "qst_freelancing", slot_quest_freelancer_agent_limit),
          (lt, ":spawned", ":limit"),
          (agent_get_team, ":player_team", ":player_agent"),
          (agent_set_team, ":agent_no", ":player_team"),
          (val_add, ":spawned", 1),
          (quest_set_slot, "qst_freelancing", slot_quest_freelancer_agent_spawned,":spawned"),
        (else_try),
        ##player should not command other guys
          (agent_get_team, ":player_team", ":player_agent"),
          (try_begin),
            (this_or_next|eq, ":player_team", 2),
            (eq, ":player_team", 3),
            (val_sub, ":player_team", 2),
          (else_try),
            (this_or_next|eq, ":player_team", 1),
            (eq, ":player_team", 0),
            (val_add, ":player_team", 2),
          (else_try),
            (display_message, "@Error, hahaha!"),
          (try_end),
          (agent_set_team, ":agent_no", ":player_team"),
        (try_end),

      (try_end),
    ]),
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_is_active, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_ally, ":agent_no"),
      (quest_get_slot, ":lord", "qst_freelancing", slot_quest_giver_troop),
      (cur_agent_set_banner_tableau_material, "tableau_game_troop_label_banner", ":lord"),
    ]),
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent_no"),

      (try_begin),
        (ge, ":dead_agent_no", 0),
        (neg|agent_is_ally, ":dead_agent_no"),
        (agent_is_human, ":dead_agent_no"),
        (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),

        (agent_get_slot, ":last_damage", ":dead_agent_no", slot_agent_last_damage),

        (try_begin),
          (call_script, "script_cf_force_wound_troop", ":dead_agent_troop_id"),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
          (set_trigger_result, 2),
        (else_try),
          (neg|troop_is_hero, ":dead_agent_troop_id"),
          (eq, "$g_realistic_wounding", 1),
          (le, ":last_damage", 13),
          (set_trigger_result, 2),
        (else_try),
          (neg|troop_is_hero, ":dead_agent_troop_id"),
          (eq, "$g_realistic_wounding", 1),
          (ge, ":last_damage", 40),
          (set_trigger_result, 1),
        (else_try),
          (set_trigger_result, 0),
        (try_end),
      (try_end),
    ]),
    common_battle_order_panel_tick,
  ]
  + theoris_decapitation
  + ai_horn
  + utility_triggers + battle_panel_triggers + extended_battle_menu
  + common_division_data + division_order_processing + real_deployment
  + formations_triggers + AI_triggers
  + dplmc_battle_mode_triggers
  + auxiliary_player
),

("hunting", mtf_battle_mode, 0,
  "You go hunting.",[
      (0,mtef_leader_only, af_override_horse|af_override_head, 0,1,[]),		#|af_override_weapons|af_override_head	#[itm_practice_bow_2,itm_barbed_arrows,itm_practice_lance,itm_practice_dagger]
  ], p_wetter + storms + creeping + global_common_triggers +
  [
    improved_lightning,
    cannot_spawn_commoners,
    (ti_before_mission_start, 0, 0,[
      (init_position, pos1),
      (position_move_z, pos1, -1000000),
      (try_begin),
        (scene_prop_get_instance, ":flag_object", banner_scene_props_begin, 0),
        (ge, ":flag_object", 0),
        (prop_instance_set_position, ":flag_object", pos1),
      (try_end),
      (try_begin),
        (scene_prop_get_instance, ":pole_object", "spr_banner_pole", 0),
        (ge, ":pole_object", 0),
        (prop_instance_set_position, ":pole_object", pos1),
      (try_end),
    ],[]),
      #common_inventory_not_available,
    (ti_inventory_key_pressed, 0, 0, [],[
      (set_trigger_result, 1),
    ]),
    #1. Spawn the animals
    (ti_on_agent_spawn, 0, ti_once, [],[
      (store_trigger_param, ":agent_no", 1),
      (set_fixed_point_multiplier, 100),
      (agent_get_position, pos1, ":agent_no"),
      (store_random_in_range, ":rand", 6000, 9000),
      (position_move_y, pos1, ":rand"),
      (store_random_in_range, ":rand", -1500, 1500),
      (position_move_x, pos1, ":rand"),
      (store_random_in_range, ":rand", 0, 360),
      (position_rotate_z, pos1, ":rand"),
      #(get_player_agent_no, ":player_agent"),
      #(agent_get_position, pos1, ":player_agent"),
      (set_spawn_position, pos1),
      (assign, reg1, 0),
      (assign, reg2, imod_cracked),
      (shuffle_range, 1, 3),
      (store_random_in_range, "$temp3", 0,2),
      (try_begin),
        (eq, "$temp3", 0),#boar
        (spawn_horse, "itm_animal_boar", reg1),
      (else_try),
        (spawn_horse, "itm_animal_dear", reg1),
      (try_end),
      (assign, "$alpha_animal", reg0),
      (party_get_num_companions, ":herd_size", "p_dhorak_keep"),
      (gt, ":herd_size", 1),
      (try_for_range, ":unused", 1, ":herd_size"),
        (copy_position, pos2, pos1),
        (store_random_in_range, ":rand", -500, 500),
        (position_move_x, pos2, ":rand"),
        (store_random_in_range, ":rand", -500, 500),
        (position_move_y, pos2, ":rand"),
        (store_random_in_range, ":rand", -3000, 3000),
        (position_rotate_z, pos2, ":rand"),
        (set_spawn_position, pos2),
        (assign, reg1, 0),
        (assign, reg2, imod_cracked),
        (shuffle_range, 1, 3),
        (try_begin),
          (eq, "$temp3", 0),#boar
          (spawn_horse, "itm_animal_boar", reg1),
        (else_try),
          (spawn_horse, "itm_animal_dear", reg1),
        (try_end),
      (try_end),
    ]),
    #2. Animals wandering
    (5, 0, 0,[
      (eq, "$animals_flee", 0),
      (agent_is_alive, "$alpha_animal"),
      (store_random_in_range, ":rand", 0, 3),
      (eq, ":rand", 0),
    ],[
      #(display_message, "@Animals wander!"),
      (set_fixed_point_multiplier, 100),
      (agent_get_position, pos1, "$alpha_animal"),
      (store_random_in_range, ":rand", -3000, 3000),
      (position_move_x, pos1, ":rand"),
      (store_random_in_range, ":rand", -3000, 3000),
      (position_move_y, pos1, ":rand"),
      (store_random_in_range, ":rand", 0, 360),
      (position_rotate_z, pos1, ":rand"),
      (try_for_agents, ":agent"),
        (neg|agent_is_human, ":agent"),
        (agent_is_alive, ":agent"),
        #(agent_set_speed_modifier, ":agent", 10),
        #(agent_set_horse_speed_factor, ":agent", 25),
        (copy_position, pos2, pos1),
        (store_random_in_range, ":rand", -500, 500),
        (position_move_x, pos2, ":rand"),
        (store_random_in_range, ":rand", -500, 500),
        (position_move_y, pos2, ":rand"),
        (store_random_in_range, ":rand", -3000, 3000),
        (position_rotate_z, pos2, ":rand"),
        (set_spawn_position, pos2),
        (agent_set_speed_limit, ":agent", 1),
        (agent_set_scripted_destination, ":agent", pos2, 1),
      (try_end),
    ]),
    #3. Animals react on player
    (0.5, 0, 0,[
      (try_begin),
        (gt, "$animals_flee", 1),
        (val_sub, "$animals_flee", 1),
      (try_end),
      (agent_is_alive, "$alpha_animal"),
    ],[
      (set_fixed_point_multiplier, 100),
      (agent_get_position, pos1, "$alpha_animal"),
      (get_player_agent_no, ":player_agent"),
      (agent_get_position, pos2, ":player_agent"),
      (get_distance_between_positions, ":distance", pos1, pos2),
      (try_begin),
        (eq, "$player_is_creeping", 1),
        (val_add, ":distance", 500),
      (try_end),
      (try_begin),
        (eq, "$animals_flee", 0),
        (lt, ":distance", 2500),
        (try_begin),
          (eq, "$temp3", 0),#boar
          (assign, reg1, 6),
          (assign, reg2, 4),
          (assign, reg3, -1),
          (shuffle_range, 1, 4),
          (assign, "$animals_flee", reg1),
        (else_try),
          (assign, reg1, 3),
          (assign, reg2, 2),
          (assign, reg3, 1),
          (shuffle_range, 1, 4),
          (assign, "$animals_flee", reg1),#deer
        (try_end),
        #(display_message, "@Animals react on low distance!"),
        (try_for_agents, ":agent"),
          (agent_is_active, ":agent"),
          (neg|agent_is_human, ":agent"),
          (agent_is_alive, ":agent"),
          #run:
          (agent_clear_scripted_mode, ":agent"),
          (agent_set_speed_limit, ":agent", 100),
          (agent_start_running_away, ":agent", 0),
        (try_end),
      (else_try),
        (eq, "$animals_flee", 1),
        (lt, ":distance", 5000),
        (assign, "$animals_flee", 0),
        (try_for_agents, ":agent"),
          (neg|agent_is_human, ":agent"),
          (agent_is_alive, ":agent"),
          #stop:
          (agent_set_speed_limit, ":agent", 1),
          (agent_stop_running_away, ":agent"),
        (try_end),
      (else_try),
        (eq, "$animals_flee", -1),	# =animals attack
        (try_for_agents, ":agent"),
          (agent_is_active, ":agent"),
          (neg|agent_is_human, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_get_position, pos1, ":agent"),
          (copy_position, pos3, pos1),
          (position_move_y, pos3, -10),	#-10cm
          (get_distance_between_positions, ":back_distance", pos2, pos3),
          (position_move_y, pos3, 25),	#+15cm
          (get_distance_between_positions, ":front_distance", pos2, pos3),
          (this_or_next|lt, ":front_distance", ":back_distance"),
          (gt, ":distance", 1000),
          (call_script, "script_point_y_toward_position", pos1, pos2),
          (set_fixed_point_multiplier, 100),
          (position_move_y, pos1, 5000),	#50m
          (agent_start_running_away, ":agent", pos1),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_hit, 0, 0, [],[
      # Animals react on hit
      (try_begin),
        (eq, "$temp3", 0),#boar
        (assign, reg1, -1),
        (assign, reg2, -1),
        (assign, reg3, 4),
        (shuffle_range, 1, 4),
        (assign, "$animals_flee", reg1),
      (else_try),
        (assign, "$animals_flee", 4),
      (try_end),
      #(display_message, "@Animals react on hit!"),
      (try_for_agents, ":agent"),
        (agent_is_active, ":agent"),
        (neg|agent_is_human, ":agent"),
        (agent_is_alive, ":agent"),
        #run:
        (agent_clear_scripted_mode, ":agent"),
        (agent_set_speed_limit, ":agent", 100),
        (agent_start_running_away, ":agent", 0),
      (try_end),

      (store_trigger_param, ":inflicted_agent_id", 1),
      (agent_is_active, ":inflicted_agent_id"),
      (agent_is_alive, ":inflicted_agent_id"),
      (try_begin),
        #Player stops creeping on hit
        (agent_is_human, ":inflicted_agent_id"),
        (assign, "$player_is_creeping", 0),
      (else_try),
        # Wounded animals get slower
        (store_agent_hit_points, ":agent_hp", ":inflicted_agent_id", 0),
        #(agent_set_speed_modifier, ":inflicted_agent_id", ":agent_hp"),
        #(agent_set_horse_speed_factor, ":agent", ":agent_hp"),
        (agent_set_speed_limit, ":inflicted_agent_id", ":agent_hp"),
      (try_end),
    ]),
    # Kill count
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param, ":agent_no", 1),
      (neg|agent_is_human, ":agent_no"),
      (val_add, "$hunted_animals", 1),
      (troop_add_items, "trp_temp_troop", "itm_venison", 1),
      (add_xp_as_reward, 150),
      (eq, "$alpha_animal", ":agent_no"),
      (try_for_agents, ":agent"),
        (neg|agent_is_human, ":agent"),
        (agent_is_alive, ":agent"),
        (assign, "$alpha_animal", ":agent"),
      (try_end),
      (eq, "$alpha_animal", ":agent_no"),
      #(finish_mission, 10),
      (assign,"$g_battle_won", 1),
    ]),
    # If alpha animal flee
    (1, 0, 2,[
      (this_or_next|neg|agent_is_alive, "$alpha_animal"),
      (neg|agent_is_active, "$alpha_animal"),
    ],[
      (try_for_agents, ":agent"),
        (neg|agent_is_human, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_active, ":agent"),
        (assign, "$alpha_animal", ":agent"),
      (try_end),
      (this_or_next|neg|agent_is_alive, "$alpha_animal"),
      (neg|agent_is_active, "$alpha_animal"),
      #(finish_mission, 10),
      (assign,"$g_battle_won", 1),
    ]),
    # End
    (3, 0, ti_once,[
      (this_or_next|main_hero_fallen),
      (eq, "$g_battle_won", 1),
    ],[
      (try_begin),	#VC-2635
        (main_hero_fallen),
        (assign, "$hunted_animals", 0),
        (troop_clear_inventory, "trp_temp_troop"),
      (try_end),

      (try_begin),##while freeancing
        (check_quest_active, "qst_freelancing"),
        (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
        (assign, "$auto_menu", "mnu_after_hunt"),
        (jump_to_menu, "mnu_auto_return_map"),
        (stop_all_sounds, 1),
      (try_end),
      (finish_mission, 6),
    ]),
    (ti_tab_pressed, 0, 0, [
      (neq, "$g_battle_won", 1),
      (neg|main_hero_fallen),
    ],[
      (try_begin),##while freeancing
        (check_quest_active, "qst_freelancing"),
        (quest_set_slot, "qst_freelancing", slot_quest_freelancer_event, 1),
        (assign, "$auto_menu", "mnu_after_hunt"),
        (jump_to_menu, "mnu_auto_return_map"),
        (stop_all_sounds, 1),
        (finish_mission, 1),
      (else_try),
        (set_trigger_result, 1),
        (stop_all_sounds, 1),
      (try_end),
    ]),
    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (party_clear, "p_routed_enemies"),
      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),
      (assign, "$animals_flee", 0),
      (assign, "$hunted_animals", 0),
      (assign, "$g_battle_won", 0),
      (assign, "$animals_flee", 0),
      (play_sound,"snd_ambient_day_forest_loop"),
      (music_set_situation, 0),
    ]),
    (0, 0, 0,[
      (key_clicked, key_k),
      (tutorial_message, -1),
    ],[]),
	  (1,0,ti_once,[
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@You may encounter two types of anmials: deers or boars. Deers will run away once you approach them, while boars may attack you. If an anmial reaches the border of the map it will disappear from the scene.^^You can walk crouched by pressing Y.^^(press K to finish read)"),
		]),
]),

("hunting_elephants", mtf_battle_mode|mtf_synch_inventory, 0,
  "You go hunting.",[
    (0,mtef_visitor_source|mtef_team_0, af_override_horse|af_override_head|af_override_weapons, aif_start_alarmed,1,[itm_throwing_spears,itm_jarid,itm_throwing_spears,itm_boar_spear]),
    (1,mtef_visitor_source|mtef_team_1, 0, aif_start_alarmed,1,[]),
  ], p_wetter + creeping + storms + global_common_triggers +
  [
    improved_lightning,
    cannot_spawn_commoners,
    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 1, 0, -1),
      (team_set_relation, 0, 1, -1),
      (mission_disable_talk),
    ]),
    ###spawn hunting party
    (ti_after_mission_start, 0, ti_once, [],[
      (store_current_scene, ":cur_scene"),
      (modify_visitors_at_site, ":cur_scene"),

      (quest_get_slot, ":lord", "qst_elephant_hunt", slot_quest_giver_troop),
      (store_faction_of_troop, ":fac", ":lord"),

      (faction_get_slot, ":troop", ":fac", slot_faction_tier_2_troop),
      (add_visitors_to_current_scene, 0, ":troop", 4),
    ]),
    #common_inventory_not_available,
    (ti_inventory_key_pressed, 0, 0, [],[
      (set_trigger_result, 1),
    ]),

    elephant_attack,
    wild_cat_attack,

    #1. Spawn the animals
    (ti_on_agent_spawn, 0, ti_once, [],[
      (store_trigger_param, ":agent_no", 1),
      (agent_get_troop_id, ":troop", ":agent_no"),
      (eq, ":troop", "trp_player"),
      (set_fixed_point_multiplier, 100),
      (agent_get_position, pos1, ":agent_no"),
      (store_random_in_range, ":rand", 6000, 9000),
      (position_move_y, pos1, ":rand"),
      (store_random_in_range, ":rand", -1500, 1500),
      (position_move_x, pos1, ":rand"),
      (store_random_in_range, ":rand", 0, 360),
      (position_rotate_z, pos1, ":rand"),
      #(get_player_agent_no, ":player_agent"),
      #(agent_get_position, pos1, ":player_agent"),
      (set_spawn_position, pos1),

      (quest_get_slot, ":animal", "qst_elephant_hunt", slot_quest_target_troop),
      (spawn_agent, ":animal"),
      (assign, "$alpha_animal", reg0),
      (agent_get_horse, ":horse", "$alpha_animal"),
      (agent_set_slot, ":horse", slot_agent_bought_horse, "$alpha_animal"),
      # (agent_set_visibility, "$alpha_animal", 0),
      (agent_set_team, "$alpha_animal", 1),
      (agent_set_no_death_knock_down_only,"$alpha_animal", 1),

      (quest_get_slot, ":herd_size", "qst_elephant_hunt", slot_quest_target_faction),
      (ge, ":herd_size", 1),
      (try_for_range, ":unused", 1, ":herd_size"),
        (copy_position, pos2, pos1),
        (store_random_in_range, ":rand", -500, 500),
        (position_move_x, pos2, ":rand"),
        (store_random_in_range, ":rand", -500, 500),
        (position_move_y, pos2, ":rand"),
        (store_random_in_range, ":rand", -3000, 3000),
        (position_rotate_z, pos2, ":rand"),
        (set_spawn_position, pos2),
        (spawn_agent, ":animal"),
        (assign, ":agent", reg0),
        (agent_get_horse, ":horse", ":agent"),
        (agent_set_slot, ":horse", slot_agent_bought_horse, ":agent"),
        (agent_set_no_death_knock_down_only,":agent", 1),
        #(agent_set_visibility, ":agent", 0),
        (agent_set_team, ":agent", 1),
      (try_end),
    ]),

      #2. Animals wandering
    (5, 0, 0,[
      (eq, "$animals_flee", 0),
      (agent_is_alive, "$alpha_animal"),
      (store_random_in_range, ":rand", 0, 3),
      (eq, ":rand", 0),
    ],[
      #(display_message, "@Animals wander!"),
      (set_fixed_point_multiplier, 100),
      (agent_get_position, pos1, "$alpha_animal"),
      (store_random_in_range, ":rand", -3000, 3000),
      (position_move_x, pos1, ":rand"),
      (store_random_in_range, ":rand", -3000, 3000),
      (position_move_y, pos1, ":rand"),
      (store_random_in_range, ":rand", 0, 360),
      (position_rotate_z, pos1, ":rand"),
      (try_for_agents, ":agent"),
        (agent_is_human, ":agent"),
        (agent_is_active, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (this_or_next|eq, ":troop", "trp_elephant"),
        (this_or_next|eq, ":troop", "trp_wild_cat_2"),
        (this_or_next|eq, ":troop", "trp_wolf"),
        (eq, ":troop", "trp_wild_cat"),
        (copy_position, pos2, pos1),
        (store_random_in_range, ":rand", -500, 500),
        (position_move_x, pos2, ":rand"),
        (store_random_in_range, ":rand", -500, 500),
        (position_move_y, pos2, ":rand"),
        (store_random_in_range, ":rand", -3000, 3000),
        (position_rotate_z, pos2, ":rand"),
        (set_spawn_position, pos2),
        (agent_set_speed_limit, ":agent", 1),
        (agent_set_scripted_destination, ":agent", pos2, 1),
      (try_end),
    ]),

      #3. Animals react on player
    (0.5, 0, 0,[
      (try_begin),
        (gt, "$animals_flee", 1),
        (val_sub, "$animals_flee", 1),
      (try_end),
      (agent_is_alive, "$alpha_animal"),
    ],[
      (set_fixed_point_multiplier, 100),
      (agent_get_position, pos1, "$alpha_animal"),
      (get_player_agent_no, ":player_agent"),
      (agent_get_position, pos2, ":player_agent"),
      (get_distance_between_positions, ":distance", pos1, pos2),
      (try_begin),
        (eq, "$player_is_creeping", 1),
        (val_add, ":distance", 500),
      (try_end),
      (try_begin),
        (eq, "$animals_flee", 0),
        (lt, ":distance", 2500),
        (assign, reg1, 2),
        (assign, reg2, -1),
        (assign, reg3, -1),
        (shuffle_range, 1, 4),
        (assign, "$animals_flee", reg1),
        #(display_message, "@Animals react on low distance!"),
        (try_for_agents, ":agent"),
          (agent_is_active, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_is_human, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (this_or_next|eq, ":troop", "trp_elephant"),
          (this_or_next|eq, ":troop", "trp_wild_cat_2"),
          (this_or_next|eq, ":troop", "trp_wolf"),
          (eq, ":troop", "trp_wild_cat"),
          (agent_is_human, ":agent"),
          (agent_is_active, ":agent"),
          #run:
          (agent_clear_scripted_mode, ":agent"),
          (agent_set_speed_limit, ":agent", 100),
          (agent_set_scripted_destination, ":agent", pos1),
        (try_end),
      (else_try),
        (eq, "$animals_flee", 1),
        (lt, ":distance", 5000),
        (assign, "$animals_flee", 0),
        (try_for_agents, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (this_or_next|eq, ":troop", "trp_elephant"),
          (this_or_next|eq, ":troop", "trp_wild_cat_2"),
          (this_or_next|eq, ":troop", "trp_wolf"),
          (eq, ":troop", "trp_wild_cat"),
          (agent_is_human, ":agent"),
          (agent_is_active, ":agent"),
          #stop:
          (agent_set_speed_limit, ":agent", 1),
          (agent_stop_running_away, ":agent"),
        (try_end),
      (else_try),
        (eq, "$animals_flee", -1),	# =animals attack
        (try_for_agents, ":agent"),
          (agent_is_active, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_is_human, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (this_or_next|eq, ":troop", "trp_elephant"),
          (this_or_next|eq, ":troop", "trp_wild_cat_2"),
          (this_or_next|eq, ":troop", "trp_wolf"),
          (eq, ":troop", "trp_wild_cat"),
          (agent_is_human, ":agent"),
          (agent_is_active, ":agent"),
          (agent_get_position, pos1, ":agent"),
          (copy_position, pos3, pos1),
          (position_move_y, pos3, -10),	#-10cm
          (get_distance_between_positions, ":back_distance", pos2, pos3),
          (position_move_y, pos3, 25),	#+15cm
          (get_distance_between_positions, ":front_distance", pos2, pos3),
          (this_or_next|lt, ":front_distance", ":back_distance"),
          (gt, ":distance", 1000),
          (call_script, "script_point_y_toward_position", pos1, pos2),
          (set_fixed_point_multiplier, 100),
          (position_move_y, pos1, 5000),	#50m
          (agent_set_scripted_destination, ":agent", pos1),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_hit, 0, 0, [],[
      # Animals react on hit
      (assign, "$animals_flee", -1),
      #(display_message, "@Animals react on hit!"),
      (try_for_agents, ":agent"),
        (agent_is_active, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_human, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (this_or_next|eq, ":troop", "trp_elephant"),
        (this_or_next|eq, ":troop", "trp_wild_cat_2"),
        (this_or_next|eq, ":troop", "trp_wolf"),
        (eq, ":troop", "trp_wild_cat"),
        (agent_is_human, ":agent"),
        (agent_is_active, ":agent"),

        (agent_get_position, pos1, ":agent"),
        (copy_position, pos3, pos1),
        (position_move_y, pos3, -10),	#-10cm
        (position_move_y, pos3, 25),	#+15cm
        (call_script, "script_point_y_toward_position", pos1, pos2),
        (set_fixed_point_multiplier, 100),
        (position_move_y, pos1, 5000),	#50m
        #run:
        (agent_clear_scripted_mode, ":agent"),
        (agent_set_speed_limit, ":agent", 100),
        (agent_set_scripted_destination, ":agent", pos1),
      (try_end),

      (store_trigger_param, ":inflicted_agent_id", 1),
      (agent_is_active, ":inflicted_agent_id"),
      (agent_is_alive, ":inflicted_agent_id"),
      (try_begin),
        #Player stops creeping on hit
        (agent_is_human, ":inflicted_agent_id"),
        (assign, "$player_is_creeping", 0),
      (else_try),
        # Wounded animals get slower
        (store_agent_hit_points, ":agent_hp", ":inflicted_agent_id", 0),
        #(agent_set_speed_modifier, ":inflicted_agent_id", ":agent_hp"),
        #(agent_set_horse_speed_factor, ":agent", ":agent_hp"),
        (agent_set_speed_limit, ":inflicted_agent_id", ":agent_hp"),
      (try_end),
    ]),
    # Kill count
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param, ":agent_no", 1),
      (neg|agent_is_human, ":agent_no"),

      #kill rider
      (agent_get_slot, ":rider", ":agent_no", slot_agent_bought_horse),
      (agent_set_no_death_knock_down_only,":rider", 0),
      (get_player_agent_no, ":player"),
      (agent_deliver_damage_to_agent, ":player", ":rider", 1000),

      (val_add, "$hunted_animals", 1),
      (agent_get_troop_id, ":troop_no", ":agent_no"),
      (try_begin),
        (this_or_next|eq, ":troop_no", "trp_wild_cat_2"),
        (eq, ":troop_no", "trp_wild_cat"),
        (troop_add_items, "trp_temp_troop", "itm_raw_leather", 1),
        (troop_add_items, "trp_temp_troop", "itm_raw_leather", 1),
        (add_xp_as_reward, 350),
      (else_try),
        (eq, ":troop_no", "trp_wolf"),
        (try_begin),
            (store_random_in_range, ":r", 0, 5),
            (eq, ":r", 0),
            (store_random_in_range, ":skin", "itm_wolf_skin_1", "itm_bear_skin_1"),
            (troop_add_items, "trp_temp_troop", ":skin", 1),
            (add_xp_as_reward, 200),
        (else_try),
            (troop_add_items, "trp_temp_troop", "itm_furs", 1),
        (try_end),
        (add_xp_as_reward, 200),
      (else_try),
        (eq, ":troop_no", "trp_elephant"),
        (troop_add_items, "trp_temp_troop", "itm_ivory", 1),
        (add_xp_as_reward, 550),
      (try_end),
      (try_begin),
        (eq, "$alpha_animal", ":agent_no"),
        (try_for_agents, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (this_or_next|eq, ":troop", "trp_elephant"),
          (this_or_next|eq, ":troop", "trp_wild_cat_2"),
          (this_or_next|eq, ":troop", "trp_wolf"),
          (eq, ":troop", "trp_wild_cat"),
          (agent_is_human, ":agent"),
          (agent_is_active, ":agent"),
          (agent_is_alive, ":agent"),
          (assign, "$alpha_animal", ":agent"),
        (try_end),
        (eq, "$alpha_animal", ":agent_no"),
        #(finish_mission, 10),
        (assign,"$g_battle_won", 1),
      (try_end),
    ]),
    (1, 0, 2,[
      (this_or_next|neg|agent_is_alive, "$alpha_animal"),
      (neg|agent_is_active, "$alpha_animal"),
    ],[
      (try_for_agents, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (this_or_next|eq, ":troop", "trp_elephant"),
        (this_or_next|eq, ":troop", "trp_wild_cat_2"),
        (this_or_next|eq, ":troop", "trp_wolf"),
        (eq, ":troop", "trp_wild_cat"),
        (agent_is_human, ":agent"),
        (agent_is_active, ":agent"),
        (agent_is_alive, ":agent"),
        (assign, "$alpha_animal", ":agent"),
      (try_end),
      (this_or_next|neg|agent_is_alive, "$alpha_animal"),
      (neg|agent_is_active, "$alpha_animal"),
      (assign,"$g_battle_won", 1),
    ]),

    # End
    (3, 0, ti_once,[
      (this_or_next|main_hero_fallen),
      (eq, "$g_battle_won", 1),
    ],[
      (try_begin),
        (main_hero_fallen),
        (assign, "$hunted_animals", 0),
      (try_end),
      (jump_to_menu, "mnu_desert_hunt_end"),
      (finish_mission, 6),
    ]),

    (ti_tab_pressed, 0, 0, [],[
      (display_message, "str_cannot_leave_now"),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),

      (party_clear, "p_routed_enemies"),

      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),
      (assign, "$animals_flee", 0),
      (assign, "$hunted_animals", 0),
      (assign, "$g_battle_won", 0),
      (assign, "$animals_flee", 0),
      (play_sound,"snd_ambient_day_forest_loop"),
      (music_set_situation, 0),
    ]),
    (0, 0, 0,[
      (key_clicked, key_k),
      (tutorial_message, -1),
    ],[]),

	  (1,0,ti_once,[],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@You can walk crouched by pressing Y.^^(press K to finish read)"),
		]),
]),

("give_speech_story",mtf_battle_mode|mtf_synch_inventory,charge,
  "You lead your men to battle.",[
    (0,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (1,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (2,mtef_visitor_source,af_override_everything,aif_start_alarmed,0,[itm_caligea,itm_roman_lupa_dress_4,itm_cloak_5]),#guard
    (3,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (4,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (5,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),  #
    (6,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (7,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (8,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),  #
    (9,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),  #
    (10,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),  #
    (11,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (12,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (13,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (14,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),  #
    (15,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (16,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (17,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (18,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (19,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (20,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),  #
    (21,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (22,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (23,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (24,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),  #
    (25,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (26,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (27,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (28,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
    (29,mtef_visitor_source,af_override_horse,aif_start_alarmed,0,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    (ti_before_mission_start, 0, 0, [ ],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_fight),
      (assign, "$tutorial_state", 0),
    ]),

    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param, ":agent", 1),
      (agent_is_alive, ":agent"),
      (agent_is_human, ":agent"),

      (try_for_range, ":item_slot", ek_item_0, ek_head),
          (agent_get_item_slot, ":item", ":agent", ":item_slot"),
          (gt, ":item", -1),
          (try_begin),
              (is_between, ":item", weapons_begin, weapons_end),
              (agent_set_wielded_item,":agent",":item"),
          (else_try),
              (is_between, ":item", shields_begin, shields_end),
              (agent_set_wielded_item,":agent",":item"),
          (try_end),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, [],[
      (assign, "$temp", 2),
      (assign, ":menu", "mnu_death_waits"),
      (try_begin),
        (quest_slot_eq, "qst_four_emperors", slot_quest_current_state, 10),
        (quest_slot_eq, "qst_four_emperors", slot_quest_target_troop, "trp_legatus_11"),
        (quest_set_slot, "qst_four_emperors", slot_quest_current_state, 11),
        (assign, ":menu", "mnu_simple_encounter"),
      (else_try),
        (quest_slot_eq, "qst_four_emperors", slot_quest_current_state, 14),
        (this_or_next|quest_slot_eq, "qst_four_emperors", slot_quest_target_troop, "trp_senator_2"),
        (quest_slot_eq, "qst_four_emperors", slot_quest_target_troop, "trp_statthalter_9"),
        (quest_set_slot, "qst_four_emperors", slot_quest_current_state, 15),
        (assign, ":menu", "mnu_simple_encounter"),
      (else_try),
        (display_message, "@BUG BUG BUG"),
        (display_message, "@YOU DIE NOW BECAUSE OF A BUG"),
        (display_message, "@BUG BUG BUG"),
      (try_end),
      (stop_all_sounds, 1),
      (jump_to_menu, ":menu"),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
      (finish_mission, 3),
    ]),

    (0, 0, ti_once, [],[
      (tutorial_message_set_size, 15, 15),
      (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
      (tutorial_message_set_center_justify, 0),
    ]),

    (0,0,0,[],
    [
      (store_mission_timer_a, ":cur_time"),
      (set_fixed_point_multiplier, 100),
      (try_begin),
          (ge, ":cur_time", 120),
          (tutorial_message, -1),
          (tutorial_message_set_background, 0),
          (eq, "$tutorial_state", 13),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 118),
          (eq, "$tutorial_state", 12),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (call_script,"script_agent_perform_warcry", ":agent"),
              (else_try),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 103),
          (eq, "$tutorial_state", 11),
          (get_player_agent_no, ":player"),
          (agent_play_sound, ":player", "snd_antonia_speech_5"),
          (str_store_string, s1, "str_antonia_speech_5"),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@{s1}"),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (call_script,"script_agent_perform_warcry", ":agent"),
              (else_try),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
      (else_try),
          (ge, ":cur_time", 100),
          (eq, "$tutorial_state", 10),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
      (else_try),
          (ge, ":cur_time", 92),
          (eq, "$tutorial_state", 9),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (call_script,"script_agent_perform_warcry", ":agent"),
              (else_try),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
      (else_try),
          (ge, ":cur_time", 85),
          (eq, "$tutorial_state", 8),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
      (else_try),
          (ge, ":cur_time", 74),
          (eq, "$tutorial_state", 7),
          (get_player_agent_no, ":player"),
          (agent_play_sound, ":player", "snd_antonia_speech_4"),
          (str_store_string, s1, "str_antonia_speech_4"),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@{s1}"),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (call_script,"script_agent_perform_warcry", ":agent"),
              (else_try),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 53),
          (eq, "$tutorial_state", 6),
          (get_player_agent_no, ":player"),
          (agent_play_sound, ":player", "snd_antonia_speech_3"),
          (str_store_string, s1, "str_antonia_speech_3"),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@{s1}"),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
      (else_try),
          (ge, ":cur_time", 36),
          (eq, "$tutorial_state", 5),
          # (tutorial_message_set_background, 0),
          # (tutorial_message, -1),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
      (else_try),
          (ge, ":cur_time", 26),
          (eq, "$tutorial_state", 4),
          (get_player_agent_no, ":player"),
          (agent_play_sound, ":player", "snd_antonia_speech_2"),
          (str_store_string, s1, "str_antonia_speech_2"),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@{s1}"),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (call_script,"script_agent_perform_warcry", ":agent"),
              (else_try),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 10),
          (eq, "$tutorial_state", 3),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (call_script,"script_agent_perform_warcry", ":agent"),
              (else_try),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
      (else_try),
          (ge, ":cur_time", 2),
          (eq, "$tutorial_state", 2),
          (get_player_agent_no, ":player"),
          (agent_play_sound, ":player", "snd_antonia_speech_1"),
          (str_store_string, s1, "str_antonia_speech_1"),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@{s1}"),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 0),
          (eq, "$tutorial_state", 1),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent_no"),
              (agent_is_human, ":agent_no"),
              (agent_is_alive, ":agent_no"),
              (agent_get_troop_id, ":id", ":agent_no"),
              (try_begin),
                  (eq, ":id", "trp_cornicen"),
                  (try_begin),
                      (agent_has_item_equipped, ":agent_no", "itm_f_cornu"),
                  (else_try),
                      (agent_equip_item, ":agent_no", "itm_f_cornu"),
                  (try_end),
                  (agent_set_wielded_item, ":agent_no", "itm_f_cornu"),
                  (agent_set_animation, ":agent_no", "anim_cornu_play", 1),
                  (agent_play_sound, ":agent_no", "snd_cornu"),
              (try_end),
          (try_end),
      (else_try),
          (eq, "$tutorial_state", 0),
          (assign, "$tutorial_state", 1),
      (try_end),
    ]),

    (0.5, 0, 0,[(ge, "$tutorial_state", 12),],[
      (get_player_agent_no, ":player"),
      (try_for_agents, ":agent"),
          (agent_is_human, ":agent"),
          (agent_is_alive, ":agent"),
          (neq, ":agent", ":player"),
          (try_begin),
              (store_random_in_range, ":taunt", 1, 100),
              (gt, ":taunt", 50),
              (agent_get_wielded_item,":item",":agent",1),
              (gt,":item",0),#has shield
              (agent_get_wielded_item,":item",":agent",0),
              (gt,":item",0),#has weapon
              (item_get_type,":item_type",":item"),
              (this_or_next | eq,":item_type",itp_type_polearm),
              (eq,":item_type",itp_type_one_handed_wpn),
              (agent_set_animation, ":agent", "anim_shield_taunt", 1),
              (agent_play_sound, ":agent", "snd_shield_taunt"),
          (else_try),
              (store_random_in_range, ":taunt", 1, 100),
              (gt, ":taunt", 50),
              (agent_set_animation, ":agent", "anim_cheer", 1),
          (try_end),
          #man_victory
          (try_begin),
              (store_random_in_range, ":r", 0, 100),
              (lt, ":r", 10),
              (agent_play_sound,":agent","snd_man_victory"),
          (try_end),
      (try_end),
    ]),

    (6, 0, 0,[(ge, "$tutorial_state", 12),],[(display_message, "str_string_speech_1_end"),]),

    (0, 0, 3,[(key_clicked, key_t),],
    [
      (get_player_agent_no, ":agent"),
      (try_begin),
          (ge, "$tutorial_state", 12),
          (agent_get_troop_id, ":troop_id", ":agent"),
          (call_script, "script_cf_dplmc_troop_is_female", ":troop_id"),
          (agent_play_sound,":agent","snd_woman_yell"),
      (else_try),
          (ge, "$tutorial_state", 12),
          (agent_play_sound,":agent","snd_man_victory"),
      (try_end),
      (agent_set_animation, ":agent", "anim_cheer", 1),
    ]),
]),

("give_speech",mtf_battle_mode|mtf_synch_inventory,charge,
  "You lead your men to battle.",[
    (1,mtef_ally_party|mtef_team_0,0,aif_start_alarmed,65,[]),
    (0,mtef_ally_party|mtef_team_0,0,aif_start_alarmed,0,[]),
    (4,mtef_visitor_source,0,aif_start_alarmed,65,[]),
    (4,mtef_visitor_source,0,aif_start_alarmed,0,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,

    (ti_before_mission_start, 0, 0, [ ],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_fight),
      (assign, "$tutorial_state", 0),
    ]),

    (0.1, 0.25, 0, [
      (eq, "$temp1", 0),
      (mission_tpl_are_all_agents_spawned),
    ],[
      #get scene boundaries
      (set_fixed_point_multiplier, 100),
      (init_position, pos11),
      (get_scene_boundaries, pos10, pos11),
      (position_get_x, ":scene_max_x", pos11),
      (position_get_y, ":scene_max_y", pos11),
      #get center of map
      (val_div, ":scene_max_x", 2),
      (val_div, ":scene_max_y", 2),

      # (assign, reg10, ":scene_max_x"),
      # (assign, reg11, ":scene_max_y"),
      # (display_message, "@scene_max_x {reg10}, scene_max_y {reg11}"),

      # (position_get_x, ":scene_min_x", pos10),
      # (position_get_y, ":scene_min_y", pos10),
      # (assign, reg10, ":scene_min_x"),
      # (assign, reg11, ":scene_min_y"),
      # (display_message, "@scene_min_x {reg10}, scene_min_y {reg11}"),

      (position_set_x, pos11, ":scene_max_x"),
      (position_set_y, pos11, ":scene_max_y"),
      # (assign, ":total_agents", 0),
      # (try_for_agents, ":agent"),
      #   (agent_is_active, ":agent"),
      #   (agent_is_alive, ":agent"),
      #   (val_add, ":total_agents", 1),
      # (try_end),
      # (gt, ":total_agents", 0),
      # (store_div, ":x_step", 6000, ":total_agents"),
      (assign, ":x_addition", 150),
      (try_for_agents, ":agent"),
        (agent_is_active, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_get_position, pos10, ":agent"),

        (call_script, "script_point_y_toward_position", pos10, pos11),
        # (init_position, pos20),
        # (position_transform_position_to_local, pos20, pos10, pos11),
        (position_get_x, ":x", pos10),
        (val_add, ":x", ":x_addition"),
        (position_set_x, pos10, ":x"),
        (try_begin),
          (agent_is_non_player, ":agent"),
          (try_begin),
            (faction_slot_eq, "$players_kingdom", slot_faction_culture, "fac_culture_7"),
            (assign, ":randon_y", 6000),
          (else_try),
            (store_random_in_range, ":randon_y", 6000, 6501),
          (try_end),
          (position_move_y, pos10, ":randon_y"),
        (else_try),
          (position_move_y, pos10, 9000),
        (try_end),

        (agent_set_position, ":agent", pos10),
        (val_add, ":x_addition", 150),
        (gt, ":x_addition", 7000),
        (assign, ":x_addition", 150),
      (try_end),
      (assign, "$temp1", 1),
    ]),

    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param, ":agent", 1),
      (agent_is_alive, ":agent"),
      (agent_is_human, ":agent"),

      (try_for_range, ":item_slot", ek_item_0, ek_head),
          (agent_get_item_slot, ":item", ":agent", ":item_slot"),
          (gt, ":item", -1),
          (try_begin),
              (is_between, ":item", weapons_begin, weapons_end),
              (agent_set_wielded_item,":agent",":item"),
          (else_try),
              (is_between, ":item", shields_begin, shields_end),
              (agent_set_wielded_item,":agent",":item"),
          (try_end),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, [],[
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
      (finish_mission,3),
      (stop_all_sounds, 1),
    ]),

    (0, 0, ti_once, [],[
      (tutorial_message_set_size, 15, 15),
      (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
      (tutorial_message_set_center_justify, 0),

      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00000000, 9000),
    ]),

    (0,0,0,[],[
      (store_mission_timer_a, ":cur_time"),
      (set_fixed_point_multiplier, 100),
      (try_begin),
          (ge, ":cur_time", 37+10),
          (tutorial_message, -1),
          (tutorial_message_set_background, 0),
          (eq, "$tutorial_state", 13),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 35+10),
          (eq, "$tutorial_state", 12),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (call_script,"script_agent_perform_warcry", ":agent"),
              (else_try),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 33+10),
          (eq, "$tutorial_state", 11),
          # (tutorial_message, -1),
          # (tutorial_message_set_background, 0),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (call_script,"script_agent_perform_warcry", ":agent"),
              (else_try),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
      (else_try),
          (ge, ":cur_time", 30+10),
          (eq, "$tutorial_state", 10),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
      (else_try),
          (ge, ":cur_time", 26+10),
          (eq, "$tutorial_state", 9),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (call_script,"script_agent_perform_warcry", ":agent"),
              (else_try),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
      (else_try),
          (ge, ":cur_time", 22+10),
          (eq, "$tutorial_state", 8),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
      (else_try),
          (ge, ":cur_time", 18+10),
          (eq, "$tutorial_state", 7),
          # (tutorial_message_set_background, 1),
          # (tutorial_message, "@Blabla3"),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (call_script,"script_agent_perform_warcry", ":agent"),
              (else_try),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 14+10),
          (eq, "$tutorial_state", 6),
          # (tutorial_message_set_background, 0),
          # (tutorial_message, -1),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
      (else_try),
          (ge, ":cur_time", 12+10),
          (eq, "$tutorial_state", 5),
          # (tutorial_message_set_background, 0),
          # (tutorial_message, -1),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
      (else_try),
          (ge, ":cur_time", 10+10),
          (eq, "$tutorial_state", 4),
          # (tutorial_message_set_background, 1),
          # (tutorial_message, "@{s1}"),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (call_script,"script_agent_perform_warcry", ":agent"),
              (else_try),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 8+10),
          (eq, "$tutorial_state", 3),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (store_random_in_range, ":r", 0, 2),
              (try_begin),
                  (eq, ":r", 0),
                  (call_script,"script_agent_perform_warcry", ":agent"),
              (else_try),
                  (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
                  (call_script,"script_agent_perform_shield_taunt", ":agent"),
              (try_end),
          (try_end),
      (else_try),
          (ge, ":cur_time", 3+10),
          (eq, "$tutorial_state", 2),
          (store_random_in_range, ":string", "str_string_speech_1_1", "str_string_speech_1_end"),
          (str_store_string, s1, ":string"),

          (store_sub, ":sound", ":string", "str_string_speech_1_1"),
          (val_add, ":sound", "snd_battle_speech_1"),
          (get_player_agent_no, ":player"),
          (agent_play_sound, ":player", ":sound"),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@{s1}"),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 2),
          (eq, "$tutorial_state", 1),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (eq, "$tutorial_state", 0),
          (assign, "$tutorial_state", 1),
      (try_end),
    ]),

    (0.5, 0, 0,[
      (ge, "$tutorial_state", 12),
    ],[
      (try_for_agents, ":agent"),
          (agent_is_active, ":agent"),
          (agent_is_human, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_is_non_player, ":agent"),
          (try_begin),
              (store_random_in_range, ":taunt", 1, 100),
              (gt, ":taunt", 50),
              (agent_get_wielded_item,":item",":agent",1),
              (gt,":item",0),#has shield
              (agent_get_wielded_item,":item",":agent",0),
              (gt,":item",0),#has weapon
              (item_get_type,":item_type",":item"),
              (this_or_next | eq,":item_type",itp_type_polearm),
              (eq,":item_type",itp_type_one_handed_wpn),
              (agent_set_animation, ":agent", "anim_shield_taunt", 1),
              (agent_play_sound, ":agent", "snd_shield_taunt"),
          (else_try),
              (store_random_in_range, ":taunt", 1, 100),
              (gt, ":taunt", 50),
              (agent_set_animation, ":agent", "anim_cheer", 1),
          (try_end),
          #man_victory
          (try_begin),
              (store_random_in_range, ":r", 0, 100),
              (lt, ":r", 10),
              (agent_play_sound,":agent","snd_man_victory"),
          (try_end),
      (try_end),
    ]),

    (6, 0, 0,[(ge, "$tutorial_state", 12),],[(display_message, "str_string_speech_1_end"),]),

    (0, 0, 3,[
      (key_clicked, key_t),
    ],[
      (get_player_agent_no, ":agent"),
      (try_begin),
          (ge, "$tutorial_state", 12),
          (agent_get_troop_id, ":troop_id", ":agent"),
          (call_script, "script_cf_dplmc_troop_is_female", ":troop_id"),
          (agent_play_sound,":agent","snd_woman_yell"),
      (else_try),
          (ge, "$tutorial_state", 12),
          (agent_play_sound,":agent","snd_man_victory"),
      (try_end),
      (agent_set_animation, ":agent", "anim_cheer", 1),
    ]),
]),

  ("library", 0, -1,
    "You visit the Alexandrian library.",
    [
    (0,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (1,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (2,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,af_override_horse,0,1,[]),
    (14,mtef_visitor_source,af_override_horse,0,1,[]),
    (15,mtef_visitor_source,af_override_horse,0,1,[]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),
    (17,mtef_visitor_source,af_override_horse,0,1,[]),
    (18,mtef_visitor_source,af_override_horse,0,1,[]),
    (19,mtef_visitor_source,af_override_horse,0,1,[]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_horse,0,1,[]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
    (23,mtef_visitor_source,af_override_horse,0,1,[]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse,0,1,[]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source,af_override_horse,0,1,[]),
    (33,mtef_visitor_source,af_override_horse,0,1,[]),
    (34,mtef_visitor_source,af_override_horse,0,1,[]),
    (35,mtef_visitor_source,af_override_horse,0,1,[]),
    (36,mtef_visitor_source,af_override_horse,0,1,[]),
    (37,mtef_visitor_source,af_override_horse,0,1,[]),
    (38,mtef_visitor_source,af_override_horse,0,1,[]),
    (39,mtef_visitor_source,af_override_horse,0,1,[]),
    (40,mtef_visitor_source,af_override_horse,0,1,[]),
    (41,mtef_visitor_source,af_override_horse,0,1,[]),
    (42,mtef_visitor_source,af_override_horse,0,1,[]),
    (43,mtef_visitor_source,af_override_horse,0,1,[]),
    (44,mtef_visitor_source,af_override_horse,0,1,[]),
    (45,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    improved_lightning,
    can_spawn_commoners,
    (0, 0, 0,[
      (get_player_agent_no, ":agent"),
      (agent_get_entry_no,":entry", ":agent"),#if ti_on_agent_spawn this results in -1
      (eq, ":entry", 27),
      (key_clicked, key_k),
      (tutorial_message, -1),
    ],[
      (try_begin),
        (this_or_next|eq, "$temp3", 2),
        (this_or_next|eq, "$temp3", 5),
        (this_or_next|eq, "$temp3", 8),
        (this_or_next|eq, "$temp3", 11),
        (eq, "$temp3", 14),
        (add_xp_to_troop, 500, "trp_player"),
        (jump_to_menu, "mnu_town"),
        (finish_mission),
        (display_message, "@The lecture has ended"),
        (troop_get_slot,":progress", "trp_director_akademia", slot_troop_banner_scene_prop),
        (val_add, ":progress", 3),
        (troop_set_slot, "trp_director_akademia", slot_troop_banner_scene_prop,":progress"),
      (else_try),
        (val_add, "$temp3", 1),
      (try_end),
    ]),
	  (1,0,0,[
      (get_player_agent_no, ":agent"),
      (agent_get_entry_no,":entry", ":agent"),#if ti_on_agent_spawn this results in -1
      (eq, ":entry", 27),
      (neg|conversation_screen_is_active),
      ],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (store_add, ":string", "$temp3", "str_lecture_1_1"),
        (str_store_string, s20, ":string"),
        (tutorial_message, "@'{s20}'^^(Press K once finished reading.)"),
        (troop_set_slot,"trp_global_variables", g_nero_intro_feast, 1),
		]),


      (ti_before_mission_start, 0, 0, [],
        [
        (set_rain, 1,0),
        (set_rain, 2,0),
      ]),

      (0, 0, ti_once, [],
        [
        (store_current_scene, ":scene"),
        (scene_set_slot, ":scene", slot_scene_visited, 1),
      ]),

  (0,0,ti_once,[
		(try_for_agents,":agent"),
      (agent_get_troop_id,":troop",":agent"),
      (try_begin),
        (eq,":troop","trp_guest_sitting"),
        (agent_set_stand_animation, ":agent", "anim_sitting_low"),
        (agent_set_animation, ":agent", "anim_sitting_low"),
        (store_random_in_range,":r",0,300),
        (agent_set_animation_progress,":agent",":r"),
      (else_try),
        (eq, ":troop", "trp_player"),
        (agent_get_entry_no,":entry", ":agent"),#if ti_on_agent_spawn this results in -1
        (eq, ":entry", 27),
        (agent_set_stand_animation, ":agent", "anim_sitting_low"),
        (agent_set_animation, ":agent", "anim_sitting_low"),
        (store_random_in_range,":r",0,300),
        (agent_set_animation_progress,":agent",":r"),
      (try_end),
		(try_end),
	],[]),

   (ti_tab_pressed, 0, 0,
	  [
			(finish_mission, 0),],[]),
	  ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    ]
  ),

("caves_of_olymp", 0, -1,
  "You visit the caves.",
  [
    (0,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (1,mtef_visitor_source|mtef_team_1,af_castle_lord,0,1,[]),
    (2,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (3,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (4,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (5,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (6,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (7,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (8,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (9,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (10,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (11,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    (0, 0, 0,[
      (check_quest_active, "qst_neros_fate"),
      (quest_slot_eq, "qst_neros_fate", slot_quest_current_state, 3),
	    (neg|conversation_screen_is_active),
	  ],[
	    (try_for_agents, ":agent"),
        (agent_is_active, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (eq, ":troop", "trp_kingdom_7_lord"),
	      (eq, "$g_start_belligerent_drunk_fight", 0),
	      (get_player_agent_no, ":player_agent"),
        (init_position, pos0),
        (init_position, pos1),
	      (agent_get_position, pos0, ":player_agent"),
	      (agent_get_position, pos1, ":agent"),
	      (get_distance_between_positions_in_meters, ":dist", pos0, pos1),
	      (le, ":dist", 4),
  		  (start_mission_conversation, "trp_kingdom_7_lord"),
        (assign, "$g_start_belligerent_drunk_fight", 1),
	    (try_end),
	  ]),

    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 0, 1, 1),
      (team_set_relation, 1, 0, 1),
      (check_quest_active, "qst_neros_fate"),
      (play_track, "track_cutscene_to_hades",2),
    ]),

    (ti_after_mission_start, 0, 0, [],[
      (scene_set_slot, "scn_cave_olympia", slot_scene_visited, 1),
    ]),

    (ti_on_agent_spawn,1,0,[
      (store_trigger_param_1,":agent"),
      (agent_is_active, ":agent"),
      (agent_is_non_player, ":agent"),
      (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 0),

      (agent_get_troop_id,":troop",":agent"),
      (eq, ":troop", "trp_kingdom_7_lord"),

      (agent_equip_item,":agent","itm_lyre_rich"),
      (agent_set_stand_animation, ":agent", "anim_lyre_standing"),
      (agent_set_animation, ":agent", "anim_lyre_standing"),
      (agent_play_sound,":agent","snd_dedal_tavern_lyre"),

      (store_random_in_range,":r",0,300),
      (agent_set_animation_progress,":agent",":r"),
    ],[]),

    (0, 0, ti_once, [(main_hero_fallen)],[
      (assign, "$temp", 0),
      (jump_to_menu, "mnu_death_waits"),
      (finish_mission, 3),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
    ]),

    (0, 0, ti_once, [
      (neg|check_quest_active, "qst_neros_fate"),
      (quest_slot_eq, "qst_neros_fate", slot_quest_current_state, -1),
      (all_enemies_defeated, 1),
    ],[
      (jump_to_menu, "mnu_neros_death"),
      (finish_mission, 3),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
    ]),

    (ti_tab_pressed, 0, 0,[
      (try_begin),
        (main_hero_fallen),
        (display_message, "str_cannot_leave_now"),
      (else_try),
			  (question_box,"str_cave_leave"),
      (try_end),
    ],[]),

    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (finish_mission,0),
    ]),
	  ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("caves_of_bacchus", 0, -1,
  "You visit the caves.",
  [
    (0,mtef_visitor_source,af_override_horse,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    can_spawn_commoners,
    (0, 0, 0,[
      (quest_slot_eq, "qst_bacchhus_quest", slot_quest_current_state, 1),
	    (neg|conversation_screen_is_active),
	  ],[
	    (try_for_agents, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (eq, ":troop", "trp_bacchus"),
	      (eq, "$g_start_belligerent_drunk_fight", 0),
	      (get_player_agent_no, ":player_agent"),
        (init_position, pos0),
        (init_position, pos1),
	      (agent_get_position, pos0, ":player_agent"),
	      (agent_get_position, pos1, ":agent"),
  		  (start_mission_conversation, "trp_bacchus"),
        (assign, "$g_start_belligerent_drunk_fight", 1),
	    (try_end),
	  ]),

    (ti_after_mission_start, 0, 0, [],[
      (scene_set_slot, "scn_cave", slot_scene_visited, 1),
    ]),
 	  (ti_before_mission_start, 0, ti_once, [],[
      (try_begin),
        (neg|quest_slot_ge, "qst_bacchhus_quest", slot_quest_current_state, 4),
        (replace_scene_props, "spr_chest_a", "spr_empty"),
      (try_end),
	  ]),

    (0.5,0.5,ti_once,[
      (neg|quest_slot_ge, "qst_bacchhus_quest", slot_quest_current_state, 2),
    ],[
      (try_for_agents, ":agent"),
        (agent_is_active, ":agent"),
        (agent_is_alive, ":agent"),
        (agent_is_human, ":agent"),
        (agent_get_entry_no, ":entry", ":agent"),
        (is_between, ":entry", 1,5),
        (try_begin),
          (agent_has_item_equipped,":agent","itm_dedal_kufel"),
          (agent_set_stand_animation, ":agent", "anim_sitting_drinking_low"),
          (agent_set_animation, ":agent", "anim_sitting_drinking_low"),
          (agent_ai_set_interact_with_player,":agent",0),
          (store_random_in_range,":r",0,300),
        (else_try),
          (agent_set_stand_animation, ":agent", "anim_sitting_low"),
          (agent_set_animation, ":agent", "anim_sitting_low"),
          (agent_ai_set_interact_with_player,":agent",0),
          (store_random_in_range,":r",0,300),
        (try_end),
        (agent_set_animation_progress,":agent",":r"),
      (try_end),
    ]),

    (1, 1, 0, [(main_hero_fallen)],[
      (jump_to_menu, "mnu_bacchus_escape"),
      (finish_mission,2),
    ]),

    (ti_tab_pressed, 0, 0,[
      (try_begin),
        (main_hero_fallen),
        (display_message, "str_cannot_leave_now"),
      (else_try),
			  (question_box,"str_cave_leave"),
      (try_end),
    ],[]),

    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (finish_mission,0),
    ]),
	  ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("outor_of_bacchus", 0, -1,
  "You visit the caves.",[
    (0,mtef_visitor_source,0,0,1,[]),
    (1,mtef_visitor_source,0,0,1,[]),
  ], p_wetter + storms + global_common_triggers +
  [ improved_lightning,
    cannot_spawn_commoners,
    (ti_tab_pressed, 0, 0,[
      (finish_mission)
    ],[]),
	  ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    ambient_scene_play_random_sound,
    ambient_scene_play_loop,
]),

("cutscene_start", mtf_battle_mode, -1,
  "You visit the caves.",[
    (0,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (1,mtef_visitor_source,af_override_body,0,1,[itm_new_dress_2]),
    (2,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,af_override_horse,0,1,[]),
    (14,mtef_visitor_source,af_override_horse,0,1,[]),
    (15,mtef_visitor_source,af_override_horse,0,1,[]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),
    (17,mtef_visitor_source,af_override_horse,0,1,[]),
    (18,mtef_visitor_source,af_override_horse,0,1,[]),
    (19,mtef_visitor_source,af_override_horse,0,1,[]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_horse,0,1,[]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
    (23,mtef_visitor_source,af_override_horse,0,1,[]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse,0,1,[]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source,af_override_horse,0,1,[]),
    (33,mtef_visitor_source,af_override_horse,0,1,[]),
    (34,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_practice_axe]),
    (35,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_arena_sword]),
    (36,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_dreizack1]),
    (37,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_dreizack2]),
    (38,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_dagger]),
    (39,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_arena_sword]),
    (40,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_practice_axe]),
    (41,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_dreizack2]),
    (42,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_dagger]),
    (43,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_dreizack1]),
    (44,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_dagger]),
    (45,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_practice_axe]),
    (46,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_arena_sword]),
    (47,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_dreizack1]),
    (48,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_dagger]),
    (49,mtef_visitor_source|mtef_team_0,af_override_everything|af_override_foot,aif_start_alarmed,1,[itm_dagger]),
    (50,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (51,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (52,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (53,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (54,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (55,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (56,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (57,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (58,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (59,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (60,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (61,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (62,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (63,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (64,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (65,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
    (66,mtef_visitor_source,af_override_horse,0,1,[]),
    (67,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head|af_override_body,0,1,[itm_f_cornu,itm_military_tunic_2]),
    (68,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head|af_override_body,0,1,[itm_f_cornu,itm_military_tunic_4]),
    (69,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head|af_override_body,0,1,[itm_f_cornu,itm_military_tunic_1]),
    (70,mtef_visitor_source,af_override_horse,0,1,[]),
    (71,mtef_visitor_source,af_override_horse,0,1,[]),
    (72,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,

    (0, 0, 0, [],[(set_show_messages, 0),]),

    (0,0,0,[
      (eq, "$temp4", 1),
    ],[
      (store_mission_timer_a, ":cur_time"),
      (set_fixed_point_multiplier, 100),
      (try_begin),
        (ge, ":cur_time", 34),
        (eq, "$tutorial_state", 9),
        (tutorial_message_set_background, 1),
        (tutorial_message, -1),
        (try_for_agents, ":agent"),
            (agent_is_human, ":agent"),
            (agent_is_active, ":agent"),
            (agent_get_troop_id, ":troop", ":agent"),
            (eq, ":troop", "trp_wild_cat"),
            (agent_get_horse, ":animal", ":agent"),
            (agent_set_visibility, ":agent", 1),
            (agent_set_visibility, ":animal", 1),
        (try_end),
        (assign, "$temp1", 1),
        (try_for_agents, ":agent_no"),
            (agent_is_human, ":agent_no"),
            (agent_is_alive, ":agent_no"),
            (agent_get_troop_id, ":id", ":agent_no"),
            (try_begin),
                (eq, ":id", "trp_cornicen"),
                (try_begin),
                    (agent_has_item_equipped, ":agent_no", "itm_f_cornu"),
                (else_try),
                    (agent_equip_item, ":agent_no", "itm_f_cornu"),
                (try_end),
                (agent_set_wielded_item, ":agent_no", "itm_f_cornu"),
                (agent_set_animation, ":agent_no", "anim_cornu_play", 1),
                (agent_play_sound, ":agent_no", "snd_cornu"),
            (try_end),
        (try_end),
        (val_add, "$tutorial_state", 1),
      (else_try),
        (ge, ":cur_time", 29),
        (eq, "$tutorial_state", 8),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@Auctor: 'I see you can hardly wait! Let us welcome: The lions!'"),
        (try_for_agents, ":agent_no"),
            (agent_is_human, ":agent_no"),
            (agent_is_alive, ":agent_no"),
            (agent_get_troop_id, ":id", ":agent_no"),
            (try_begin),
                (eq, ":id", "trp_cornicen"),
                (try_begin),
                    (agent_has_item_equipped, ":agent_no", "itm_f_cornu"),
                (else_try),
                    (agent_equip_item, ":agent_no", "itm_f_cornu"),
                (try_end),
                (agent_set_wielded_item, ":agent_no", "itm_f_cornu"),
                (agent_set_animation, ":agent_no", "anim_cornu_play", 1),
                (agent_play_sound, ":agent_no", "snd_cornu"),
            (try_end),
        (try_end),
        (try_for_agents, ":agent"),
            (agent_is_alive, ":agent"),
            (agent_is_human, ":agent"),
            (agent_is_active, ":agent"),
            (agent_get_troop_id, ":troop", ":agent"),
            (eq, ":troop", "trp_wild_cat"),
            (agent_play_sound, ":agent", "snd_wild_cat"),
        (try_end),
        (val_add, "$tutorial_state", 1),
      (else_try),
        (ge, ":cur_time", 26),
        (eq, "$tutorial_state", 7),
        (try_for_agents, ":agent"),
            (agent_is_alive, ":agent"),
            (agent_is_human, ":agent"),
            (agent_is_active, ":agent"),
            (agent_get_troop_id, ":troop", ":agent"),
            (eq, ":troop", "trp_wild_cat"),
            (agent_play_sound, ":agent", "snd_wild_cat"),
        (try_end),
        (val_add, "$tutorial_state", 1),
      (else_try),
        (ge, ":cur_time", 23),
        (eq, "$tutorial_state", 6),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@Mob: 'Lions! Lions! Lions! Lions! Lions!'"),
        (val_add, "$tutorial_state", 1),
      (else_try),
        (ge, ":cur_time", 20),
        (eq, "$tutorial_state", 5),
        (try_for_agents, ":agent"),
            (agent_is_alive, ":agent"),
            (agent_is_human, ":agent"),
            (agent_is_active, ":agent"),
            (agent_get_troop_id, ":troop", ":agent"),
            (eq, ":troop", "trp_wild_cat"),
            (agent_play_sound, ":agent", "snd_wild_cat"),
        (try_end),
        (val_add, "$tutorial_state", 1),
      (else_try),
        (ge, ":cur_time", 17),
        (eq, "$tutorial_state", 4),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@Auctor: 'We haven't feed the lions for months and now they are starving. You can already hear them.'"),
        (try_for_agents, ":agent"),
            (agent_is_alive, ":agent"),
            (agent_is_human, ":agent"),
            (agent_is_active, ":agent"),
            (agent_get_troop_id, ":troop", ":agent"),
            (eq, ":troop", "trp_wild_cat"),
            (agent_play_sound, ":agent", "snd_wild_cat"),
        (try_end),
        (val_add, "$tutorial_state", 1),
      (else_try),
        (ge, ":cur_time", 15),
        (eq, "$tutorial_state", 3),
        (try_for_agents, ":agent"),
            (agent_is_alive, ":agent"),
            (agent_is_human, ":agent"),
            (agent_is_active, ":agent"),
            (agent_get_troop_id, ":troop", ":agent"),
            (eq, ":troop", "trp_wild_cat"),
            (agent_play_sound, ":agent", "snd_wild_cat"),
        (try_end),
        (val_add, "$tutorial_state", 1),
      (else_try),
        (ge, ":cur_time", 11),
        (eq, "$tutorial_state",2),
        (try_for_agents, ":agent"),
            (agent_is_alive, ":agent"),
            (agent_is_human, ":agent"),
            (agent_is_active, ":agent"),
            (agent_get_troop_id, ":troop", ":agent"),
            (eq, ":troop", "trp_wild_cat"),
            (agent_play_sound, ":agent", "snd_wild_cat"),
        (try_end),
        (val_add, "$tutorial_state", 1),
      (else_try),
        (ge, ":cur_time", 8),
        (eq, "$tutorial_state", 1),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@Auctor: 'Look at those ugly criminals. They will be fighting with the beasts today! They have committed the most evil crimes and now they get the punishment they deserve!'"),
        (try_for_agents, ":agent_no"),
            (agent_is_human, ":agent_no"),
            (agent_is_alive, ":agent_no"),
            (agent_get_troop_id, ":id", ":agent_no"),
            (try_begin),
                (eq, ":id", "trp_cornicen"),
                (try_begin),
                    (agent_has_item_equipped, ":agent_no", "itm_f_cornu"),
                (else_try),
                    (agent_equip_item, ":agent_no", "itm_f_cornu"),
                (try_end),
                (agent_set_wielded_item, ":agent_no", "itm_f_cornu"),
                (agent_set_animation, ":agent_no", "anim_cornu_play", 1),
                (agent_play_sound, ":agent_no", "snd_cornu"),
            (try_end),
        (try_end),
        (val_add, "$tutorial_state", 1),
      (else_try),
        (ge, ":cur_time", 2),
        (eq, "$tutorial_state", 0),
        (tutorial_message_set_background, 1),
        (str_store_party_name, s39, "$current_town"),
        (tutorial_message, "@Auctor: 'People of {s39}, today you will see a grant spectacle!'"),
        (val_add, "$tutorial_state", 1),
      (try_end),
    ]),
    (0,0,0,[(eq, "$temp4", 2),],[
      (store_mission_timer_a, ":cur_time"),
      (set_fixed_point_multiplier, 100),
      (try_begin),
          (ge, ":cur_time", 147),#152
          (eq, "$tutorial_state", 14),
          (stop_all_sounds, 1),
          (show_object_details_overlay,1),
          (finish_mission),
          (jump_to_menu, "mnu_cutscene_2"),
          (val_add, "$tutorial_state", 1),
          (set_show_messages, 1),
      (else_try),
          (ge, ":cur_time", 142),#147
          (eq, "$tutorial_state", 13),
          (tutorial_message, -1),
          (tutorial_message_set_background, 0),
          (mission_cam_set_screen_color, 0x00FFFFFF),
          (mission_cam_animate_to_screen_color, 0xFFFFFFFF, 3500),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 101),
          (eq, "$tutorial_state", 12),
          (tutorial_message_set_background, 1),
          (tutorial_message, -1),
          (try_for_agents, ":agent"),
              (agent_is_human, ":agent"),
              (agent_is_active, ":agent"),
              (agent_get_troop_id, ":troop", ":agent"),
              (try_begin),
                  (eq, ":troop", "trp_wild_cat"),
                  (agent_get_horse, ":animal", ":agent"),
                  (agent_set_visibility, ":agent", 1),
                  (agent_set_visibility, ":animal", 1),
              (else_try),
                  (eq, ":troop", "trp_prisoner"),
                  (agent_set_speed_modifier,":agent", 100),
              (else_try),
                  (eq, ":troop", "trp_cornicen"),
                  (try_begin),
                      (agent_has_item_equipped, ":agent", "itm_f_cornu"),
                  (else_try),
                      (agent_equip_item, ":agent", "itm_f_cornu"),
                  (try_end),
                  (agent_set_wielded_item, ":agent", "itm_f_cornu"),
                  (agent_set_animation, ":agent", "anim_cornu_play", 1),
                  (agent_play_sound, ":agent", "snd_cornu"),
              (try_end),
          (try_end),
          (assign, "$temp1", 1),
          (val_add, "$tutorial_state", 1),
          (init_position, pos9),
          (entry_point_get_position, pos9, 85),
          (mission_cam_animate_to_position, pos9, 12000, 0),
      (else_try),
          (ge, ":cur_time", 96),
          (eq, "$tutorial_state", 11),

          (agent_force_rethink, "$g_main_attacker_agent"),
          (agent_clear_scripted_mode, "$g_main_attacker_agent"),

          (tutorial_message_set_background, 1),
          (tutorial_message, "@Auctor: 'Bring the lions! Bring the lions, quickly! Hornmen give the signal!'"),
          (try_for_agents, ":agent_no"),
              (agent_is_human, ":agent_no"),
              (agent_is_alive, ":agent_no"),
              (agent_get_troop_id, ":id", ":agent_no"),
              (try_begin),
                  (eq, ":id", "trp_cornicen"),
                  (try_begin),
                      (agent_has_item_equipped, ":agent_no", "itm_f_cornu"),
                  (else_try),
                      (agent_equip_item, ":agent_no", "itm_f_cornu"),
                  (try_end),
                  (agent_set_wielded_item, ":agent_no", "itm_f_cornu"),
                  (agent_set_animation, ":agent_no", "anim_cornu_play", 1),
                  (agent_play_sound, ":agent_no", "snd_cornu"),
              (else_try),
                  (eq, ":id", "trp_wild_cat"),
                  (agent_play_sound, ":agent_no", "snd_wild_cat"),
              (try_end),
          (try_end),
          (val_add, "$tutorial_state", 1),
          (play_sound, "snd_arena_ambiance", sf_looping),
      (else_try),
          (ge, ":cur_time", 86),
          (eq, "$tutorial_state", 10),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@Prisoner: 'He fears death! He is a god is he not? What god can he be if he fears death?! I spit at you- motherslayer!'^^-- The mob roars.--"),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (agent_is_active, ":agent"),
              (agent_get_troop_id, ":troop", ":agent"),
              (eq, ":troop", "trp_guest"),
              (agent_play_sound, ":agent", "snd_man_yell"),
          (try_end),
      (else_try),
          (ge, ":cur_time", 75),
          (eq, "$tutorial_state", 9),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@Prisoner: 'I don't fear death! I have never feared it! I know of no one among you fear it, otherwise wouldn't survive in this city. Except one person!'^-- He points at Nero. --"),
          (val_add, "$tutorial_state", 1),
          (try_for_agents, ":agent"),
              (agent_is_human, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_get_troop_id, ":troop", ":agent"),
              (this_or_next|eq, ":troop", "trp_guest"),
              (eq, ":troop", "trp_guest_female"),
              (agent_set_stand_animation, ":agent", "anim_senator_listen"),
              (agent_set_animation, ":agent", "anim_senator_listen"),
              (store_random_in_range,":r",0,300),
              (agent_set_animation_progress,":agent",":r"),
              (agent_set_no_dynamics,":agent",1),
              (agent_ai_set_interact_with_player,":agent", 0),
          (try_end),
      (else_try),
          (ge, ":cur_time", 64),
          (eq, "$tutorial_state", 8),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (agent_is_active, ":agent"),
              (agent_get_troop_id, ":troop", ":agent"),
              (eq, ":troop", "trp_wild_cat"),
              (agent_play_sound, ":agent", "snd_wild_cat"),
          (else_try),
              (eq, ":troop", "trp_guest"),
              (agent_play_sound, ":agent", "snd_man_yell"),
          (try_end),
          (val_add, "$tutorial_state", 1),
          (init_position, pos9),
          (entry_point_get_position, pos9, 84),
          (mission_cam_animate_to_position, pos9, 14000, 0),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@Prisoner: 'Yet, is this a crime? Romans, is this a crime?'^^-- The mob roars. --"),
      (else_try),
          (ge, ":cur_time", 53),
          (eq, "$tutorial_state", 7),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@Prisoner: 'I strived for these goals! Alas- I have failed. I have no home, nobody ever loved me and my stomach is empty day by day.'"),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 43),
          (eq, "$tutorial_state", 6),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (agent_is_active, ":agent"),
              (agent_get_troop_id, ":troop", ":agent"),
              (eq, ":troop", "trp_wild_cat"),
              (agent_play_sound, ":agent", "snd_wild_cat"),
          (try_end),
          (val_add, "$tutorial_state", 1),
          (init_position, pos9),
          (entry_point_get_position, pos9, 83),
          (mission_cam_animate_to_position, pos9, 11000, 0),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@Prisoner: 'All I ever wanted was a small house I could call my home, a woman who loves me and who I love and something to eat every day.' "),
      (else_try),
          (ge, ":cur_time", 31),
          (eq, "$tutorial_state", 5),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@Prisoner: 'All I ever wanted was...' ^^--As the mob notice he wants to speak they fall silent.--"),

          (stop_all_sounds),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (agent_is_active, ":agent"),
              (agent_get_troop_id, ":troop", ":agent"),
              (try_begin),
                  (this_or_next|eq, ":troop", "trp_guest"),
                  (eq, ":troop", "trp_guest_female"),
                  (agent_set_stand_animation, ":agent", "anim_stand"),
                  (agent_set_animation, ":agent", "anim_stand"),
                  (store_random_in_range,":r",0,300),
                  (agent_set_animation_progress,":agent",":r"),
                  (agent_set_no_dynamics,":agent",1),
                  (agent_ai_set_interact_with_player,":agent", 0),
              (else_try),
                  (eq, ":troop", "trp_wild_cat"),
                  (agent_play_sound, ":agent", "snd_wild_cat"),
              (try_end),
          (try_end),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 25),
          (eq, "$tutorial_state", 4),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (agent_is_active, ":agent"),
              (agent_get_troop_id, ":troop", ":agent"),
              (eq, ":troop", "trp_wild_cat"),
              (agent_play_sound, ":agent", "snd_wild_cat"),
          (try_end),
          (val_add, "$tutorial_state", 1),
          (init_position, pos9),
          (entry_point_get_position, pos9, 82),
          (mission_cam_animate_to_position, pos9, 11000, 0),
          (init_position, pos10),
          (entry_point_get_position, pos10, 60),
          (agent_set_speed_modifier,"$g_main_attacker_agent", 80),
          (agent_set_scripted_destination_no_attack, "$g_main_attacker_agent", pos10),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@-- Meanwhile one of the prisoners steps forward. -- "),
      (else_try),
          (ge, ":cur_time", 22),
          (eq, "$tutorial_state",3),
          (try_for_agents, ":agent"),
              (agent_is_alive, ":agent"),
              (agent_is_human, ":agent"),
              (agent_is_active, ":agent"),
              (agent_get_troop_id, ":troop", ":agent"),
              (eq, ":troop", "trp_wild_cat"),
              (agent_play_sound, ":agent", "snd_wild_cat"),
          (try_end),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 19),
          (eq, "$tutorial_state", 2),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@Auctor: 'Princeps was so kind to gift them some weapons they can use to fight the lions! If they should survive, they are forgiven!'"),

          (try_for_agents, ":agent_no"),
              (agent_is_human, ":agent_no"),
              (agent_is_alive, ":agent_no"),
              (agent_get_troop_id, ":id", ":agent_no"),
              (try_begin),
                  (eq, ":id", "trp_cornicen"),
                  (try_begin),
                      (agent_has_item_equipped, ":agent_no", "itm_f_cornu"),
                  (else_try),
                      (agent_equip_item, ":agent_no", "itm_f_cornu"),
                  (try_end),
                  (agent_set_wielded_item, ":agent_no", "itm_f_cornu"),
                  (agent_set_animation, ":agent_no", "anim_cornu_play", 1),
                  (agent_play_sound, ":agent_no", "snd_cornu"),
              (try_end),
          (try_end),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 4),
          (eq, "$tutorial_state", 1),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@Auctor: 'My fellow Romans! Today you will see the execution of traitors. They were part of a conspiracy to overthrow Caesar. Yet, they failed and now justice is done!'"),
          (val_add, "$tutorial_state", 1),
          (init_position, pos9),
          (entry_point_get_position, pos9, 81),
          (mission_cam_animate_to_position, pos9, 10000, 0),
      (else_try),
          (eq, "$tutorial_state", 0),
          (call_script, "script_save_cam_first_person_mode"),
          (mission_cam_set_mode, 1, 0, 0),
          (set_camera_in_first_person, 0),
          (init_position, pos10),
          (entry_point_get_position, pos10, 80),
          (mission_cam_set_position, pos10),
          (assign, "$tutorial_state", 1),
      (try_end),
    ]),
    (ti_before_mission_start, 0, 0, [],[
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 2, 1),
      (team_set_relation, 2, 1, 1),
      (team_set_relation, 2, 0, 1),
      (team_set_relation, 0, 1, -1),
      (assign, "$temp1", 0),
      (assign, "$tutorial_state", 0),
      (try_begin),
          (eq, "$temp4",2),
          (scene_set_day_time,12),
      (try_end),
    ]),

    (0, 0, ti_once, [],[
      (try_for_range, ":cur_group", 0, grc_everyone),
        (team_give_order, 0, ":cur_group", mordr_hold),
        #(team_give_order, 0, ":cur_group", mordr_stand_closer),
      (try_end),
    ]),

    (ti_on_agent_spawn,0,0, [],[
      (store_trigger_param_1, ":agent"),
      (agent_get_troop_id, ":troop", ":agent"),
      (try_begin),#invisible at the start
          (neg|agent_is_human, ":agent"),
          (agent_set_visibility, ":agent", 0),
      (else_try),#invisible at the start and unkillable
          (eq, ":troop", "trp_wild_cat"),
          (agent_set_no_death_knock_down_only, ":agent", 1),
          (agent_set_visibility, ":agent", 0),
          (assign, "$alpha_animal", ":agent"),
      (else_try),#make them cheer
          (this_or_next|eq, ":troop", "trp_guest"),
          (eq, ":troop", "trp_guest_female"),
          (agent_set_stand_animation, ":agent", "anim_arena_stand_idle"),
          (agent_set_animation, ":agent", "anim_arena_stand_idle"),
          (store_random_in_range,":r",0,300),
          (agent_set_animation_progress,":agent",":r"),
          (agent_set_no_dynamics,":agent",1),
          (agent_ai_set_interact_with_player,":agent", 0),
      (else_try),#set no player interaction
          (is_between, ":troop", active_npcs_begin, kingdom_ladies_end),
          (agent_set_no_dynamics,":agent",1),
          (agent_ai_set_interact_with_player,":agent", 0),
      (else_try),#set no player interaction
          (eq, ":troop", "trp_prisoner"),
          (assign, "$g_main_attacker_agent", ":agent"),
          (agent_set_speed_modifier,":agent", 0),
      (try_end),
    ]),
    # Animals move and attack
    (1, 0, 0,[
      (eq, "$temp1", 1),
      (agent_is_alive, "$alpha_animal"),
    ],[
      (set_fixed_point_multiplier, 100),
      (agent_get_position, pos1, "$alpha_animal"),

      (store_random_in_range, ":entry", 60, 64),
      (entry_point_get_position, pos2, ":entry"),
      (get_distance_between_positions, ":distance", pos1, pos2),

      (try_for_agents, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (this_or_next|eq, ":troop", "trp_elephant"),
          (this_or_next|eq, ":troop", "trp_wild_cat_2"),
          (eq, ":troop", "trp_wild_cat"),
          (agent_is_human, ":agent"),
          (agent_is_active, ":agent"),
          (agent_get_position, pos1, ":agent"),
          (copy_position, pos3, pos1),
          (position_move_y, pos3, -10),	#-10cm
          (get_distance_between_positions, ":back_distance", pos2, pos3),
          (position_move_y, pos3, 25),	#+15cm
          (get_distance_between_positions, ":front_distance", pos2, pos3),
          (this_or_next|lt, ":front_distance", ":back_distance"),
          (gt, ":distance", 1000),
          (call_script, "script_point_y_toward_position", pos1, pos2),
          (set_fixed_point_multiplier, 100),
          (position_move_y, pos1, 2000),	#20m,
          (agent_set_scripted_destination, ":agent", pos1),
          #(agent_play_sound, ":agent", "snd_wild_cat"),
      (try_end),
    ]),
    # Kill rider
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param, ":agent_no", 1),

      (try_begin),
          (agent_is_human, ":agent_no"),
          (set_trigger_result, 1),
      (else_try),

          #kill rider
          (agent_get_rider, ":rider", ":agent_no"),
          (agent_set_no_death_knock_down_only,":rider", 0),
          (agent_deliver_damage_to_agent, ":rider", ":rider", 1000),

          (try_begin),
            (eq, "$alpha_animal", ":agent_no"),
            (try_for_agents, ":agent"),
              (agent_get_troop_id, ":troop", ":agent"),
              (this_or_next|eq, ":troop", "trp_elephant"),
              (this_or_next|eq, ":troop", "trp_wild_cat_2"),
              (eq, ":troop", "trp_wild_cat"),
              (agent_is_human, ":agent"),
              (agent_is_active, ":agent"),
              (agent_is_alive, ":agent"),
              (assign, "$alpha_animal", ":agent"),
            (try_end),
          (try_end),
      (try_end),
    ]),
    (ti_on_agent_hit, 0, 0, [],[
      (store_trigger_param, ":inflicted_agent_id", 1),
      (store_trigger_param, ":inflicted_damage", 3),

      (agent_is_active, ":inflicted_agent_id"),
      (agent_is_human, ":inflicted_agent_id"),
      (agent_is_alive, ":inflicted_agent_id"),
      (agent_get_troop_id, ":troop", ":inflicted_agent_id"),
      (eq, ":troop", "trp_prisoner"),

      (store_agent_hit_points, ":hp", ":inflicted_agent_id"),
      (this_or_next|lt, ":hp", 70),
      (gt, ":inflicted_damage", 10),
      (store_random_in_range, ":rand", 52, 65),
      (entry_point_get_position, pos2, ":rand"),
      (agent_start_running_away, ":inflicted_agent_id", pos2),
      (agent_slot_eq, ":inflicted_agent_id",  slot_agent_is_running_away, 0),
      (agent_set_slot, ":inflicted_agent_id",  slot_agent_is_running_away, 1),
      #throw away weapon:
      (agent_get_wielded_item, ":weapon", ":inflicted_agent_id", 0),
      (ge, ":weapon", 1),
      (agent_unequip_item, ":inflicted_agent_id", ":weapon"),
      #sound:
      (store_random_in_range, ":rand", 1, 3),
      (eq, ":rand", 1),
      (agent_play_sound, ":inflicted_agent_id", "snd_panic_hit"),

      (agent_set_speed_modifier,":inflicted_agent_id", 100),
    ]),
    (3, 0, 0, [(eq, "$temp1", 1),],[
      (assign, ":sound_played", 0),
      (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_slot_eq, ":agent_no", slot_agent_is_running_away, 1),
        (agent_get_troop_id, ":troop", ":agent_no"),
        (eq, ":troop", "trp_prisoner"),
        (store_random_in_range, ":rand", 52, 65),
        (entry_point_get_position, pos2, ":rand"),
        (agent_start_running_away, ":agent_no", pos2),
        #sound:
        (eq, ":sound_played", 0),
        (store_random_in_range, ":rand", 1, 4),
        (eq, ":rand", 1),
        (assign, ":sound_played", 1),
        (agent_play_sound, ":agent_no", "snd_panic_cry"),
      (try_end),
    ]),

    (0,0,ti_once, [],[
      (try_for_agents, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_is_human, ":agent_no"),
          (agent_is_alive, ":agent_no"),
          (call_script, "script_init_town_agent", ":agent_no"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0,[
    ],[
      (try_begin),
        (eq, "$temp4", 1),
      (else_try),
        (jump_to_menu, "mnu_cutscene_2"),
      (try_end),
      (show_object_details_overlay, 1),
      (set_show_messages, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
      (finish_mission, 3),
    ]),
    wild_cat_attack,

    (0, 0, ti_once, [],[
      (play_sound, "snd_arena_ambiance", sf_looping),
    ]),
    (ti_after_mission_start, 0, 0, [],[
      (show_object_details_overlay, 0),
      (try_begin),
          (eq, "$temp4", 1),
          (call_script, "script_music_set_situation_with_culture", mtf_sit_arena),
      (else_try),
          (play_track, "track_cutscene_1_track", 2),
      (try_end),
    ]),
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("minotau", 0, -1,"You visit the caves.",[
    (0,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (1,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (2,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    dedal_shield_bash,
    dedal_shield_bash_AI,

    (1, 0, 0, [
      (scene_slot_eq, "scn_labyrinth", slot_scene_visited, 0),
    ],[
      (get_player_agent_no, ":player"),
      (init_position, pos1),
      (init_position, pos2),
      (agent_get_position, pos2, ":player"),
      (entry_point_get_position, pos1, 2),

      (get_distance_between_positions_in_meters, ":distance", pos1, pos2),
      (le, ":distance", 5),
      (display_message, "@Someone says: 'Waaargg!!! Who is there?'"),
      (agent_play_sound, ":player", "snd_man_warcry"),
      (scene_set_slot, "scn_labyrinth", slot_scene_visited, 1),
    ]),

    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent_no"),
      (agent_get_troop_id, ":troop_no", ":agent_no"),
      (eq, ":troop_no", "trp_minotau"),
      (agent_set_no_death_knock_down_only, ":agent_no", 1),
      (assign, "$temp", 0),
    ]),

    (ti_on_agent_knocked_down, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent"),
      (agent_get_troop_id, ":troop", ":dead_agent"),
      (eq, ":troop", "trp_minotau"),
      (val_add, "$temp", 1),
      (try_begin),
        (gt, "$temp", "$temp4_1"),
        (agent_set_no_death_knock_down_only, ":dead_agent", 0),
      (try_end),
    ]),

    (1, 0, ti_once, [
      (main_hero_fallen)
    ],[
      (assign, "$temp", 1),
      (jump_to_menu, "mnu_death_waits"),
      (finish_mission,2),
    ]),

    (1, 1, ti_once, [
      (neg|main_hero_fallen),(num_active_teams_le, 1),
      (this_or_next|scene_slot_eq, "scn_labyrinth", slot_scene_visited, 1),
      (scene_slot_eq, "scn_labyrinth", slot_scene_visited, 0),
    ],[
      (jump_to_menu, "mnu_minotau_defeated"),
      (finish_mission,2),
    ]),

    (ti_tab_pressed, 0, 0,[
      (try_begin),
        (main_hero_fallen),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (question_box,"str_cave_leave"),
      (try_end),
    ],[]),

    (ti_before_mission_start, 0, 0,[],[
      (team_set_relation, 0, 1, 1),
    ]),

    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1,":answer"),
      (eq,":answer",0),
      (jump_to_menu, "mnu_town"),
      (finish_mission,0),
    ]),
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("diggus_event_1", 0, -1,
  "You visit the caves.",[
    (0,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,af_override_horse,0,1,[]),
    (14,mtef_visitor_source,af_override_horse,0,1,[]),
    (15,mtef_visitor_source,af_override_horse,0,1,[]),
    (16,mtef_visitor_source,af_override_body|af_override_foot,0,1,[itm_new_dress_1,itm_female_caligea_gold]),
    (17,mtef_visitor_source,af_override_horse,0,1,[]),
    (18,mtef_visitor_source,af_override_horse,0,1,[]),
    (19,mtef_visitor_source,af_override_horse|af_override_body|af_override_head|af_override_weapons,0,1,[itm_roman_toga_2]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_body|af_override_foot,0,1,[itm_new_dress_2,itm_female_caligea_gold]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    (ti_tab_pressed, 0, 0,[],[(display_message, "str_cannot_leave_now"),]),

    (ti_on_agent_spawn,1,0, [],[
      (store_trigger_param_1, ":agent"),
      (agent_get_troop_id, ":troop", ":agent"),
      (this_or_next|eq, ":troop", "trp_orgie_fem4"),
      (eq, ":troop", "trp_tristitia"),
      (agent_set_stand_animation, ":agent", "anim_stand_lady"),
      (agent_set_animation, ":agent", "anim_stand_lady"),
      (store_random_in_range,":r",0,300),
      (agent_set_animation_progress,":agent",":r"),
    ]),

	  #tavern brawl triggers - drunk
    (0, 0, 0,[
      (eq, "$g_start_belligerent_drunk_fight", 0),
	    (neg|conversation_screen_is_active),
	  ],[
	    (try_for_agents, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (eq, ":troop", "trp_desperatius"),
	      (eq, "$g_start_belligerent_drunk_fight", 0),
	      (get_player_agent_no, ":player_agent"),
        (init_position, pos0),
        (init_position, pos1),
	      (agent_get_position, pos0, ":player_agent"),
	      (agent_get_position, pos1, ":agent"),
	      (get_distance_between_positions_in_meters, ":dist", pos0, pos1),
	      (le, ":dist", 4),
  		  (start_mission_conversation, "trp_desperatius"),
        (assign, "$g_start_belligerent_drunk_fight", 1),
      (try_end),
	  ]),

    (0, 0, 0,[
      (eq, "$g_start_belligerent_drunk_fight", 3),
	    (neg|conversation_screen_is_active),
	  ],[
	    (try_for_agents, ":agent"),
        (agent_get_troop_id, ":troop", ":agent"),
        (eq, ":troop", "trp_diggus"),
	      (eq, "$g_start_belligerent_drunk_fight", 3),
	      (get_player_agent_no, ":player_agent"),
        (init_position, pos0),
        (init_position, pos1),
	      (agent_get_position, pos0, ":player_agent"),
	      (agent_get_position, pos1, ":agent"),
	      (get_distance_between_positions_in_meters, ":dist", pos0, pos1),
	      (le, ":dist", 3),
  		  (start_mission_conversation, "trp_diggus"),
        (assign, "$g_start_belligerent_drunk_fight", 4),
	    (try_end),
    ]),

    (0, 0, 0,[
      (eq, "$g_start_belligerent_drunk_fight", 2),
      (neg|conversation_screen_is_active),
	  ],[
      (assign, "$g_start_belligerent_drunk_fight", 3),
      (try_for_agents, ":agent"),
          (agent_get_troop_id,":troop",":agent"),
          (eq, ":troop", "trp_desperatius"),
          (init_position, pos2),
          (entry_point_get_position, pos2, 0),
          (agent_set_scripted_destination, ":agent",pos2),
          (assign, "$g_belligerent_drunk_leaving", ":agent"),
      (try_end),
	  ]),
    (1, 0, 0,[
      (agent_is_active, "$g_belligerent_drunk_leaving"),
      (agent_is_alive, "$g_belligerent_drunk_leaving"),
      (entry_point_get_position, pos0, 0),
      (agent_get_position, pos1, "$g_belligerent_drunk_leaving"),
      (get_distance_between_positions, ":dist", pos0, pos1),
      (le, ":dist", 150),
    ],[
      (agent_fade_out, "$g_belligerent_drunk_leaving"),
      (assign, "$g_belligerent_drunk_leaving", 0),
    ]),
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("mount_olymp", mtf_battle_mode, -1,
  "You visit the caves.",
  [
    (0,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (1,mtef_visitor_source|mtef_team_1,0,0,1,[]),
    (2,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (3,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (4,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (5,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (6,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (7,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (8,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (9,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (10,mtef_visitor_source|mtef_team_0,0,0,1,[]),
    (11,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (12,mtef_visitor_source|mtef_team_0,0,0,1,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,
    (0, 0, 0,[
        (quest_slot_eq, "qst_amor_quest", slot_quest_current_state, 5),
        (neg|quest_slot_eq, "qst_amor_quest", slot_quest_gold_reward, -1),
        (eq, "$g_start_belligerent_drunk_fight", 0),
	      (neg|conversation_screen_is_active),
    ],
	  [
      (try_for_agents, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (eq, ":troop", "trp_wild_cat"),
          (eq, "$g_start_belligerent_drunk_fight", 0),
          (get_player_agent_no, ":player_agent"),
          (init_position, pos0),
          (init_position, pos1),
          (agent_get_position, pos0, ":player_agent"),
          (agent_get_position, pos1, ":agent"),
          (get_distance_between_positions_in_meters, ":dist", pos0, pos1),
          (le, ":dist", 7),
          (start_mission_conversation, "trp_wild_cat"),
          (assign, "$g_start_belligerent_drunk_fight", 1),
      (try_end),
	  ]),

    (0, 0, ti_once, [],	[
      (team_set_relation, 1,0,1),
      (mission_enable_talk),
    ]),

    (ti_on_agent_spawn,0,0, [],[
      (store_trigger_param_1, ":agent"),
      (neg|agent_is_human, ":agent"),
      (agent_get_rider, ":rider", ":agent"),
      (agent_set_slot, ":agent", slot_agent_bought_horse, ":rider"),
      (agent_get_troop_id, ":troop", ":rider"),
      (try_begin),#invisible at the start
          (eq, ":troop", "trp_wild_cat"),
          (agent_set_no_death_knock_down_only, ":rider", 1),
          (assign, "$alpha_animal", ":rider"),
      (try_end),
    ]),

    # Animals move and attack
    (1, 0, 0,[
      (quest_slot_eq, "qst_amor_quest", slot_quest_current_state, 5),
      (quest_slot_eq, "qst_amor_quest", slot_quest_gold_reward, -1),
      (agent_is_alive, "$alpha_animal"),
    ],[
      (set_fixed_point_multiplier, 100),
      (agent_get_position, pos1, "$alpha_animal"),

      (store_random_in_range, ":entry", 1, 9),
      (entry_point_get_position, pos2, ":entry"),
      (get_distance_between_positions, ":distance", pos1, pos2),

      (try_for_agents, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (eq, ":troop", "trp_wild_cat"),
          (agent_is_human, ":agent"),
          (agent_is_active, ":agent"),
          (agent_get_position, pos1, ":agent"),
          (copy_position, pos3, pos1),
          (position_move_y, pos3, -10),	#-10cm
          (get_distance_between_positions, ":back_distance", pos2, pos3),
          (position_move_y, pos3, 25),	#+15cm
          (get_distance_between_positions, ":front_distance", pos2, pos3),
          (this_or_next|lt, ":front_distance", ":back_distance"),
          (gt, ":distance", 1000),
          (call_script, "script_point_y_toward_position", pos1, pos2),
          (set_fixed_point_multiplier, 100),
          (position_move_y, pos1, 1000),	#20m,
          (agent_set_scripted_destination, ":agent", pos1),
      (try_end),
    ]),

      # Kill rider
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param, ":agent_no", 1),
      (agent_get_troop_id, ":troop", ":agent_no"),
      (try_begin),
          (agent_is_human, ":agent_no"),
          (set_trigger_result, 1),
          (try_begin),
              (eq, ":troop", "trp_player"),
              (finish_mission, 3),
              (assign, "$temp", 2),
              (jump_to_menu, "mnu_death_waits"),
          (try_end),
      (else_try),
          #kill rider
          (agent_get_slot, ":rider", ":agent_no", slot_agent_bought_horse),
          (agent_set_no_death_knock_down_only,":rider", 0),
          (agent_deliver_damage_to_agent, ":rider", ":rider", 1000),
          (finish_mission, 3),
          (jump_to_menu, "mnu_aslan_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0,[
    ],[
      (try_begin),
          (quest_slot_eq, "qst_amor_quest", slot_quest_current_state, 5),
          (quest_slot_eq, "qst_amor_quest", slot_quest_gold_reward, -1),
          (display_message, "str_cannot_leave_now"),
      (else_try),
          (set_trigger_result, 1),
      (try_end),
    ]),
    (2, 0, 0,[
      (quest_slot_eq, "qst_amor_quest", slot_quest_current_state, 5),
      (quest_slot_eq, "qst_amor_quest", slot_quest_gold_reward, -1),
      (try_for_agents, ":tigger"),
          (agent_is_active, ":tigger"),
          (agent_is_alive, ":tigger"),
          (agent_get_troop_id, ":troop", ":tigger"),
          (eq, ":troop", "trp_wild_cat"),
          (agent_get_position,pos1,":tigger"),
          (assign, ":attack", 0),
          (try_for_agents,":agent"),
              (agent_is_active,":agent"),
              (agent_is_alive,":agent"),
              (agent_is_human,":agent"),
              (agent_get_team, ":grenadiers_team", ":tigger"),
              (agent_get_team, ":targets_team", ":agent"),
              (teams_are_enemies, ":grenadiers_team", ":targets_team"),
              (agent_get_position,pos3,":agent"),
              (get_distance_between_positions,":dist",pos1,pos3),
              (le,":dist",250),
              (try_begin),
                  (agent_slot_eq, ":agent", slot_agent_walker_occupation, 0),
                  (agent_set_animation, ":agent", "anim_rider_fall_roll"),
                  (agent_set_slot, ":agent", slot_agent_walker_occupation, 2),
              (else_try),
                  (agent_get_slot, ":timer1", ":agent", slot_agent_walker_occupation),
                  (val_sub, ":timer1", 1),
                  (val_max, ":timer1", 0),
                  (agent_set_slot, ":agent", slot_agent_walker_occupation, ":timer1"),
              (try_end),

              (store_agent_hit_points, ":cur_hit_points",":agent",1),
              (val_sub,":cur_hit_points",10),
              (agent_set_hit_points,":agent",":cur_hit_points",1),
              (agent_deliver_damage_to_agent, ":tigger", ":agent", 0),
              (assign, ":attack", 1),
          (try_end),
          (try_begin),
              (eq, ":attack", 1),
              (agent_slot_eq, ":tigger", slot_agent_walker_occupation, 0),
              (agent_get_horse,":animal",":tigger"),
              (agent_is_active, ":animal"),
              (agent_is_alive, ":animal"),
              (agent_set_animation, ":animal", "anim_wild_cat_attack"),
              (agent_play_sound, ":tigger", "snd_wild_cat"),
              (agent_set_slot, ":tigger", slot_agent_walker_occupation, 2),
          (else_try),
              (agent_get_slot, ":timer1", ":tigger", slot_agent_walker_occupation),
              (val_sub, ":timer1", 1),
              (val_max, ":timer1", 0),
              (agent_set_slot, ":tigger", slot_agent_walker_occupation, ":timer1"),
          (try_end),
      (try_end),
    ],[]),

    (0, 0, 0,[
      (key_clicked, key_k),
      (tutorial_message, -1),
    ],[]),
	  (1,0,ti_once,[
      (quest_slot_eq, "qst_amor_quest", slot_quest_current_state, 5),
      (neg|conversation_screen_is_active),
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@Climb on the mountain to find this creature.^^(press K to finish read)"),
		]),
]),

("desperatius_final", 0, -1,
  "You visit the caves.",[
    (0,mtef_visitor_source,af_override_horse,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,af_override_horse,0,1,[]),
    (14,mtef_visitor_source,af_override_horse,0,1,[]),
    (15,mtef_visitor_source,af_override_horse,0,1,[]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),
    (17,mtef_visitor_source,af_override_horse,0,1,[]),
    (18,mtef_visitor_source,af_override_horse,0,1,[]),
    (19,mtef_visitor_source,af_override_horse,0,1,[]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_horse,0,1,[]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
    (23,mtef_visitor_source,af_override_horse,0,1,[]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse,0,1,[]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,
    remove_banners,
    improved_lightning,
    (0, 0, 0,[
      (eq, "$g_start_belligerent_drunk_fight", 0),
      (neg|conversation_screen_is_active),
      (store_mission_timer_a,":mission_time"),
      (ge,":mission_time",3),
	  ],[
      (try_for_agents, ":agent"),
          (agent_get_troop_id,":troop",":agent"),
          (eq, ":troop", "trp_desperatius"),
          (start_mission_conversation, "trp_desperatius"),
          (assign, "$g_start_belligerent_drunk_fight", 1),
      (try_end),
	  ]),
    (0, 0, ti_once, [],[
      (set_fixed_point_multiplier, 100),
      (assign, reg1, "psys_village_fire_big"),
      (assign, reg2, "psys_war_smoke_tall"),
      (assign, reg3, 0),
      (assign, ":counter", 0),
      (try_for_prop_instances, ":curr_instance", -1, somt_object),
          (lt, ":counter", 20),	#not more then 60 part sys, now 25 since people get performance issues
          (prop_instance_get_scene_prop_kind, ":scene_prop_kind", ":curr_instance"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_a"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_b"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_c"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_e"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_f"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_g"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_h"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_villa_new_a"),
          (this_or_next|eq, ":scene_prop_kind", "spr_village_stable_a"),
          (this_or_next|eq, ":scene_prop_kind", "spr_full_stable_a"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_market_new"),
          (this_or_next|eq, ":scene_prop_kind", "spr_house_bebanburh"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_b_bathsevulus1_t3", "spr_b_romanwalls_t1"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_b_roof0_t1", "spr_b_wall0_t1"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_b_villasevulus0_t1", "spr_b_wall0_t1"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_Kolba_a", "spr_wall_a"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_long_house", "spr_arena_2"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_viking_house_a", "spr_harbour_a"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_fake_houses_steppe_a", "spr_destroy_heap"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_village_house_e", "spr_village_wall_a"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_town_house_steppe_a", "spr_carpet_a"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_earth_house_a", "spr_town_house_aa"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_village_house_a", "spr_crude_fence"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_full_stable_a", "spr_arabian_house_i"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_arabian_house_a2", "spr_arabian_village_stairs"),
          (is_between, ":scene_prop_kind", "spr_house_saxon", "spr_tree_log_half"),
          (shuffle_range, 1, 4),
          (neq, reg1, 0),
          (val_add, ":counter", 1),
          (try_for_range, ":unused", 0, 4),
            (store_random_in_range, ":rand23", -150, 150),
            (position_set_x, pos1, ":rand23"),
            (store_random_in_range, ":rand23", -150, 150),
            (position_set_y, pos1, ":rand23"),
            (store_random_in_range, ":rand23", 50, 150),
            (position_set_z, pos1, ":rand23"),
            (prop_instance_add_particle_system, ":curr_instance", reg1, pos1),
            (eq, reg1, "psys_village_fire_big"),
            (position_move_z, pos1, 100),
            (prop_instance_add_particle_system, ":curr_instance", "psys_village_fire_smoke_big", pos1),
            #(prop_instance_play_sound, ":curr_instance", "snd_fire", sf_looping),
          (try_end),
      (try_end),
    ]),
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),


("visit_sagala", mtf_battle_mode, -1,"You visit the caves.",[
    (0,mtef_visitor_source,0,0,1,[]),
    (1,mtef_visitor_source,0,0,1,[]),
    (2,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (3,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,af_override_horse,0,1,[]),
    (14,mtef_visitor_source,af_override_horse,0,1,[]),
    (15,mtef_visitor_source,af_override_horse,0,1,[]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),
    (17,mtef_visitor_source,af_override_horse,0,1,[]),
    (18,mtef_visitor_source,af_override_horse,0,1,[]),
    (19,mtef_visitor_source,af_override_horse,0,1,[]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_horse,0,1,[]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
    (23,mtef_visitor_source,af_override_horse,0,1,[]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse,0,1,[]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source,af_override_horse,0,1,[]),
    (33,mtef_visitor_source,af_override_horse,0,1,[]),
    (34,mtef_visitor_source,af_override_horse,0,1,[]),
    (35,mtef_visitor_source,af_override_horse,0,1,[]),
    (36,mtef_visitor_source,af_override_horse,0,1,[]),
    (37,mtef_visitor_source,af_override_horse,0,1,[]),
    (38,mtef_visitor_source,af_override_horse,0,1,[]),
    (39,mtef_visitor_source,af_override_horse,0,1,[]),
    (40,mtef_visitor_source,af_override_horse,0,1,[]),
    (41,mtef_visitor_source,af_override_horse,0,1,[]),
    (42,mtef_visitor_source,af_override_horse,0,1,[]),
    (43,mtef_visitor_source,af_override_horse,0,1,[]),
    (44,mtef_visitor_source,af_override_horse,0,1,[]),
    (45,mtef_visitor_source,af_override_horse,0,1,[]),
    (46,mtef_visitor_source,af_override_horse,0,1,[]),
    (47,mtef_visitor_source,af_override_horse,0,1,[]),
    (48,mtef_visitor_source,af_override_horse,0,1,[]),
    (49,mtef_visitor_source,af_override_horse,0,1,[]),
    (50,mtef_visitor_source,af_override_horse,0,1,[]),
    (51,mtef_visitor_source,af_override_horse,0,1,[]),
    (52,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    can_spawn_commoners,
    improved_lightning,
    (ti_before_mission_start, 0, 0, [],[
      (scene_set_day_time, 12),
      (try_begin),
          (check_quest_active, "qst_wlodowiecus_adventure_1"),
          (quest_slot_eq, "qst_wlodowiecus_adventure_1", slot_quest_current_state, 4),
          (team_set_relation, 0, 1, -1),
          (set_party_battle_mode),
          (mission_disable_talk),
      (try_end),
      (mission_enable_talk),#because it has the battle flag
    ]),
    (ti_tab_pressed, 0, 0,[
      (check_quest_active, "qst_wlodowiecus_adventure_1"),
    ],[
      (display_message, "str_cannot_leave_now"),
    ]),
    (ti_tab_pressed, 0, 0,[
      (neg|check_quest_active, "qst_wlodowiecus_adventure_1"),
    ],[
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
      (finish_mission, 3),
      (mission_disable_talk),
    ]),
	  (1,0,ti_once,[
      (check_quest_active, "qst_wlodowiecus_adventure_1"),
      (quest_slot_eq, "qst_wlodowiecus_adventure_1", slot_quest_current_state, 4),
      (neg|conversation_screen_is_active),
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@Objective: Escape from Sagala through the main gate."),
		]),
    (0, 0, 0,[
      (eq, "$g_start_belligerent_drunk_fight", 3),
	    (neg|conversation_screen_is_active),
      (check_quest_active, "qst_wlodowiecus_adventure_1"),
      (quest_slot_eq, "qst_wlodowiecus_adventure_1", slot_quest_current_state, 2),
	  ],[
      (agent_is_active, "$g_belligerent_drunk"),
      (eq, "$g_start_belligerent_drunk_fight", 3),
      (get_player_agent_no, ":player_agent"),
      (init_position, pos11),
      (init_position, pos12),
      (agent_get_position, pos11, ":player_agent"),
      (agent_get_position, pos12, "$g_belligerent_drunk"),
      (set_fixed_point_multiplier, 1),
      (get_distance_between_positions_in_meters, ":dist", pos11, pos12),
      (le, ":dist", 5),
      (start_mission_conversation, "trp_wlodowiecus"),
      (assign, "$g_start_belligerent_drunk_fight", 4),
	  ]),
    (0, 0, 0,[
      (check_quest_active, "qst_wlodowiecus_adventure_1"),
      (quest_slot_eq, "qst_wlodowiecus_adventure_1", slot_quest_current_state, 4),
	  ],[
      (get_player_agent_no, ":player_agent"),
      (agent_is_active, ":player_agent"),
      (init_position, pos13),
      (init_position, pos14),
      (agent_get_position, pos13, ":player_agent"),
      (entry_point_get_position, pos14, 51),
      (set_fixed_point_multiplier, 1),
      (get_distance_between_positions_in_meters, ":dist", pos13, pos14),
      (le, ":dist", 6),
      (jump_to_menu, "mnu_escaped_sagala"),
      (finish_mission),
	  ]),
    (ti_after_mission_start, 0, ti_once, [],[
      (store_current_scene, ":cur_scene"),
      (scene_set_slot, ":cur_scene", slot_scene_visited, 1),
      (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
      (try_for_agents, ":agent"),
          (agent_is_alive,":agent"),
          (agent_is_active,":agent"),
          (agent_is_human,":agent"),
          (agent_get_entry_no,":entry",":agent"),
          (try_begin),
              (check_quest_active, "qst_wlodowiecus_adventure_1"),
              (quest_slot_eq, "qst_wlodowiecus_adventure_1", slot_quest_current_state, 4),
              (agent_get_troop_id, ":troop",":agent"),
              (try_begin),
                  (this_or_next|eq, ":troop", "trp_indian_spearman"),
                  (eq, ":troop", "trp_indian_archer"),
                  (agent_set_team, ":agent", 1),
              (else_try),
                  (agent_set_team, ":agent", 0),
              (try_end),
          (else_try),
              (try_begin),
                  (is_between, ":entry", 4,27),
                  (call_script, "script_init_town_agent", ":agent"),
              (else_try),
                  (eq, ":entry", 3),
                  (assign, "$g_belligerent_drunk", ":agent"),
              (try_end),
          (try_end),
      (try_end),

      (try_begin),
          (check_quest_active, "qst_wlodowiecus_adventure_1"),
          (quest_slot_eq, "qst_wlodowiecus_adventure_1", slot_quest_current_state, 4),
          (get_player_agent_no, ":player"),
          (agent_get_team, ":playerteam", ":player"),
          (set_show_messages, 0),
          (try_for_range, ":unit", 0, grc_everyone),
              (team_give_order, ":playerteam", ":unit", mordr_follow), #Division 8 to avoid potential conflicts
          (try_end),
          (set_show_messages, 1),
      (try_end),
    ]),
    dedal_shield_bash,
    dedal_shield_bash_AI,
    custom_commander_critical_strike,
    wounds_vc,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,

    (ti_after_mission_start, 0, 0,[],[
      (play_sound,"snd_ambient_day_plains_loop"),
    ]),

    ambient_scene_play_random_sound,

    (1, 4, ti_once, [
      (check_quest_active, "qst_wlodowiecus_adventure_1"),
      (quest_slot_eq, "qst_wlodowiecus_adventure_1", slot_quest_current_state, 4),
      (this_or_next|main_hero_fallen),
      (num_active_teams_le,1)
    ],[
      (num_active_teams_le,1),
      (jump_to_menu, "mnu_escaped_sagala"),
      (stop_all_sounds, 1),
      (finish_mission),
    ]),
    (1, 0, ti_once, [
      (main_hero_fallen),
    ],[
      (assign, "$temp", 2),
      (jump_to_menu, "mnu_death_waits"),
      (stop_all_sounds, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
      (finish_mission,3),
    ]),
    (8,0,0,[
      (neg|quest_slot_eq, "qst_wlodowiecus_adventure_1", slot_quest_current_state, 4),
    ],[
      (try_for_agents,":agent_no"),
        (agent_is_alive,":agent_no"),
        (agent_is_human,":agent_no"),
        (agent_get_entry_no,":entry",":agent_no"),
        (is_between, ":entry", 27,50),
        (assign, ":continue_walk", 0),
        (store_random_in_range, ":continue_walk", 1, 100),
        (try_begin),
          (le, ":continue_walk", 40),
          (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
          (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
          (agent_set_animation, ":agent_no", "anim_stand_man"),
          (agent_set_animation_progress, ":agent_no", 10),

          (agent_get_position, pos1, ":agent_no"),
          (store_random_in_range, ":points", 27, 50),
          (entry_point_get_position, pos2, ":points"),
          (agent_set_speed_limit, ":agent_no", 1),
          (agent_set_scripted_destination, ":agent_no", pos2),
        (try_end),
      (try_end),
    ]),
    (ti_inventory_key_pressed, 0, 0, [
      (set_trigger_result,1),
    ],[]),
]),

("jungle_lair_final", 0, -1,
    "You visit the caves.",
    [
    (0,mtef_visitor_source,af_override_horse,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    ], p_wetter + global_common_triggers +
    [
      cannot_spawn_commoners,
      improved_lightning,
      (0, 0, 0,
      [
        (eq, "$g_start_belligerent_drunk_fight", 0),
        (neg|conversation_screen_is_active),
        (store_mission_timer_a,":mission_time"),
        (ge,":mission_time",2),
	  ],
	  [

    (try_for_agents, ":agent"),
        (agent_get_troop_id,":troop",":agent"),
        (eq, ":troop", "trp_mancinellus"),
        (start_mission_conversation, "trp_mancinellus"),
        (assign, "$g_start_belligerent_drunk_fight", 1),
    (try_end),
	  ]),


    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    ]
  ),

("visit_bedroom",0,-1,
  "plundering a room",[
    (0,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),#player
    (1,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave1,itm_female_crown]),#
    (2,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave2,itm_flower_crown]),#
    (3,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave3,itm_flower_crown]),#
    (4,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave4,itm_flower_crown]),#
    (5,mtef_visitor_source,af_override_everything,0,1,[]),#unused
    (6,mtef_visitor_source,af_override_everything,0,1,[]),#unused
    (7,mtef_visitor_source,af_override_everything,0,1,[]),#unused
  ], p_wetter + global_common_triggers +
  [
    can_spawn_commoners,
    (ti_on_agent_spawn,0,0,[
      (store_trigger_param_1, ":agent"),
      (agent_is_active, ":agent"),
      (neg|agent_slot_ge, ":agent", slot_agent_is_blocked, 1),
      (agent_is_non_player, ":agent"),
      (agent_set_no_dynamics, ":agent", 1),
      (agent_set_stand_animation, ":agent", "anim_female_lie_sexy"),
      (agent_set_animation, ":agent", "anim_female_lie_sexy"),
      (store_random_in_range,":r",0,300),
      (agent_set_animation_progress,":agent",":r"),
    ],[]),

    (0, 0, ti_once, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_feast),
    ]),

    (0, 0, ti_once, [
      (agent_is_active, "$g_belligerent_drunk_leaving"),
      (agent_is_alive, "$g_belligerent_drunk_leaving"),
      (agent_is_human, "$g_belligerent_drunk_leaving"),
    ],[
      (set_fixed_point_multiplier, 1),
      (agent_get_position, pos1, "$g_belligerent_drunk_leaving"),
      (agent_set_no_dynamics, "$g_belligerent_drunk_leaving", 1),
      (position_move_z, pos1, 110),
      (agent_set_position, "$g_belligerent_drunk_leaving", pos1),
      (agent_set_stand_animation, "$g_belligerent_drunk_leaving", "anim_dance"),
      (agent_set_animation, "$g_belligerent_drunk_leaving", "anim_dance"),
    ]),

    (0, 0, ti_once, [
      (try_for_agents, ":agent"),
          (agent_is_active, ":agent"),
          (agent_is_non_player, ":agent"),
          (set_fixed_point_multiplier, 1),
          (agent_get_position, pos1, ":agent"),
          (agent_set_no_dynamics, ":agent", 1),
          (position_move_z, pos1, -110),
          (agent_set_position, ":agent", pos1),
      (try_end),
    ],[]),
    (ti_tab_pressed, 0, 0,[
      (stop_all_sounds, 1),
      (finish_mission,0),
    ],[]),

    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("special_mission_poppaea_1",mtf_battle_mode,-1,
  "plundering a room",
  [
    (0,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),#player
    (1,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_seiden_dress,itm_female_crown]),#
    (2,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (3,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_seiden_dress,itm_female_crown]),#
  ], p_wetter + global_common_triggers +
  [
    can_spawn_commoners,
    (0,0,ti_once, [],[
      (try_for_agents, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_is_human, ":agent_no"),
          (agent_is_alive, ":agent_no"),

          (agent_get_troop_id, ":troop", ":agent_no"),
          (eq, ":troop", "trp_kingdom_7_lady_1"),

          (agent_set_no_dynamics, ":agent_no", 1),
          (agent_set_stand_animation, ":agent_no", "anim_female_lie_sexy"),
          (agent_set_animation, ":agent_no", "anim_female_lie_sexy"),
          (store_random_in_range,":r",0,300),
          (agent_set_animation_progress,":agent_no",":r"),

          (set_fixed_point_multiplier, 1),
          (agent_get_position, pos1, ":agent_no"),
          (agent_set_no_dynamics, ":agent_no", 1),
          (position_move_z, pos1, -100),
          (agent_set_position, ":agent_no", pos1),
      (try_end),
      (mission_enable_talk),
      (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
    ]),

    (ti_tab_pressed, 0, 0,[
      (display_message, "str_cannot_leave_now"),
    ],[]),
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("visit_bedroom_augusta",0,-1,
  "plundering a room",[
    (0,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),#player
    (1,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_seiden_dress,itm_female_crown]),#
    (2,mtef_visitor_source,0,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    can_spawn_commoners,
    (0,0,ti_once, [],[
      (try_for_agents, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_is_human, ":agent_no"),
          (agent_is_alive, ":agent_no"),
          (agent_get_troop_id, ":troop", ":agent_no"),
          (neg|is_between, ":troop", tavern_minstrels_begin, tavern_minstrels_end),
          (call_script, "script_init_town_agent", ":agent_no"),
      (try_end),
    ]),

    (0, 0, ti_once, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_feast),
    ]),

    (ti_tab_pressed, 0, 0,[
      (stop_all_sounds, 1),
      (finish_mission,0),
    ],[]),

    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),


("visit_petrus",0,-1,
  "plundering a christ",[
    (0,mtef_visitor_source,0,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
	  (0,0,0,[
      (troop_slot_eq, "trp_petrus", slot_troop_occupation, 0),
    ],[
      (set_fixed_point_multiplier, 1),
      (store_mission_timer_a, ":timer1"),
      (try_begin),
        (eq, ":timer1", 2),
        (tutorial_message_set_size, 22, 22),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@Someone says: 'Please, please! Tell Christos to save us, tell him to save us! He can't let us all die! Isn't he not almighty?'"),
      (else_try),
        (eq, ":timer1", 9),
        (tutorial_message_set_size, 23, 23),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@Someone else: 'Save us, oh Lord! Tell our Lord to save us!'"),
      (else_try),
        (eq, ":timer1", 14),
        (tutorial_message_set_size, 23, 23),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@Old man: 'Do not be afraid. The lord is near. We cannot and must not run away. Now go, and live as the Lord wanted, and die as the Lord wants as dying is part of life.'"),
      (else_try),
        (eq, ":timer1", 24),
        (tutorial_message_set_size, 23, 23),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@'Praised be the Lord!'"),
      (else_try),
        (eq, ":timer1", 28),
        (tutorial_message_set_size, 23, 23),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, -1),
        (troop_set_slot, "trp_petrus", slot_troop_occupation, 1),
      (try_end),
		]),
    (0, 0, 0,[
      (conversation_screen_is_active),
      (tutorial_message, -1),
    ],[]),
	  (0, 0, 0,[
      (troop_slot_eq, "trp_petrus", slot_troop_occupation, 1),
    ],[
      (try_for_agents, ":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (this_or_next|eq, ":troop_no", "trp_christ"),
        (eq, ":troop_no", "trp_christ_fem"),
        (entry_point_get_position, pos0, 40),
        (agent_set_scripted_destination, ":agent_no", pos0),
      (try_end),
      (troop_set_slot, "trp_petrus", slot_troop_occupation, 2),
    ]),

    ##start conversation with Petrus
    (1, 0, 0,[
	    (troop_slot_eq, "trp_petrus", slot_troop_occupation, 2),
      (eq, "$temp", 0),
	  ],[
      (try_for_agents, ":agent_no"),
        (eq, "$temp", 0),
        (agent_is_active, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (eq, ":troop_no", "trp_petrus"),
        (init_position, pos0),
        (init_position, pos1),
        (get_player_agent_no, ":player_agent"),
      (agent_get_position, pos0, ":player_agent"),
      (agent_get_position, pos1, ":agent_no"),

      (get_distance_between_positions_in_meters, ":dist", pos0, pos1),
      (le, ":dist", 5),
        (mission_enable_talk),
        (start_mission_conversation, "trp_petrus"),
        (assign, "$temp", 1),
      (try_end),
    ]),
    #people leaving
    (1, 0, 0,[],[
      (troop_slot_eq, "trp_petrus", slot_troop_occupation, 2),
      (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (this_or_next|eq, ":troop_no", "trp_christ"),
        (eq, ":troop_no", "trp_christ_fem"),
        (entry_point_get_position, pos0, 40),
        (agent_get_position, pos1, ":agent_no"),
        (get_distance_between_positions, ":dist", pos0, pos1),
        (le, ":dist", 350),
        (agent_fade_out, ":agent_no"),
      (try_end),
    ]),
    common_inventory_not_available,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    (0, 0, ti_once,[],[
      (mission_disable_talk),
      (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
    ]),
    (ti_tab_pressed, 0, 0, [],[
      (display_message, "str_cannot_leave_now"),
      (set_trigger_result, 0),
    ]),
]),

 ("fake_nero_fight",mtf_battle_mode,-1,"dungeon",[
    (0,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (1,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,20,[]),
    (2,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,20,[]),
    (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,20,[]),
    (4,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,20,[]),
    (5,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (6,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (7,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (8,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (9,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (10,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (11,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    (ti_after_mission_start, 0, ti_once, [],[
      (set_cheer_at_no_enemy, 0),
      #player companions
      (assign, ":companions_count", 0),
      (party_get_num_companion_stacks, ":num_of_stacks", "p_main_party"),
      (try_for_range, ":i", 0, ":num_of_stacks"),
        (party_stack_get_troop_id, ":troop_id", "p_main_party", ":i"),
        (neq, ":troop_id", "trp_player"),
        (is_between,":troop_id",companions_begin,companions_end),
        (neg|troop_is_wounded, ":troop_id"),
        (val_add, ":companions_count", 1),

        (store_current_scene, ":cur_scene"),
        (modify_visitors_at_site, ":cur_scene"),
        (add_visitors_to_current_scene, 0, ":troop_id", 1),

        (eq, ":companions_count", 20), #20 companions max with player
        (assign, ":num_of_stacks", 0),
      (try_end),
      (mission_disable_talk),
      (team_give_order, "$attacker_team", grc_everyone, mordr_follow),
    ]),
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent"),
      (agent_get_troop_id, ":troop", ":agent"),
      (neq, ":troop", "trp_player"),
      (try_begin),
        (main_party_has_troop, ":troop"),
        (get_player_agent_no, ":player"),
        (agent_get_team, ":playerteam", ":player"),
        (agent_set_team, ":agent", ":playerteam"),
        (agent_set_division, ":agent", 8),
        (agent_add_relation_with_agent, ":agent", ":player", 1),
        (agent_set_is_alarmed, ":agent", 1),
      (try_end),
    ]),
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent"),
      (agent_get_troop_id, ":troop", ":dead_agent"),
      (neq, ":troop", "trp_player"),
      (troop_is_hero, ":troop"),
      (main_party_has_troop, ":troop"),
      (party_wound_members, "p_main_party", ":troop", 1),
    ]),
    #################
    dedal_shield_bash,
    dedal_shield_bash_AI,
    custom_commander_critical_strike,
    wounds_vc,
    (ti_before_mission_start, 0, 0, [],[
      (assign,"$g_battle_result",0),
      (assign, "$attacker_team", 0),
      (assign, "$defender_team_2", 2),
      (team_set_relation, 0, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
      (team_set_relation,1,2,0),
      (team_set_relation,0,1,0),
    ]),
    (3, 0, ti_once,[
      (set_show_messages, 0),
      (team_give_order, "$defender_team_2", grc_everyone, mordr_stand_ground),
      (set_show_messages, 1),
      # (try_for_agents, ":agent"),
        # (agent_is_active, ":agent"),
        # (agent_get_team, ":team", ":agent"),
        # (eq, ":team", "$defender_team_2"),
        # (agent_get_position, pos1, ":agent"),
        # (agent_set_scripted_destination, ":agent",pos1),
      # (try_end),
      (set_party_battle_mode),
    ],[]),
    (1, 0, 0, [
      (store_skill_level,":player_sneaking_skill","skl_athletics","trp_player"),
      (assign,":sneak_distance",30000),
      (val_mul, ":player_sneaking_skill", 1000),
      (val_sub, ":sneak_distance", ":player_sneaking_skill"),
      (val_clamp, ":sneak_distance", 2000, 30000),
      (assign,":continue",0),
      (get_player_agent_no, ":player"),
      (agent_get_position,pos23,":player"),

      (try_for_agents, ":cur_agent"),
        (neq, ":cur_agent", ":player"),
        (agent_get_troop_id, ":troop", ":cur_agent"),
        (neg|main_party_has_troop, ":troop"),
        ##                 (agent_get_team, ":team", ":cur_agent"),
        ##		(eq, ":team", 2),
        (agent_get_position,pos22,":cur_agent"),
        (get_distance_between_positions,":distance",pos23,pos22),
        (lt,":distance",":sneak_distance"),
        (agent_set_team, ":cur_agent", 2),
        (assign,":continue",1),
      (try_end),
      (eq,":continue",1),
      (set_party_battle_mode),
    ],[]),

    (5, 3, ti_once,[
      (main_hero_fallen),
      (assign,"$g_battle_result",-1),
      (assign,"$g_encountered_party",-1),
      (call_script, "script_change_troop_renown", "trp_player", -5),
      (display_message, "@Bandits strike at you furiously, and you fall in a puddle of blood. They think you're dead...",color_good_news),
      (store_troop_gold, ":gold", "trp_player"),
      (try_begin),
        (ge, ":gold", 500),
        (troop_remove_gold, "trp_player", 500),
      (else_try),
        (call_script, "script_change_troop_renown", "trp_player", -25),
      (try_end),
    ],[
      (finish_mission),
    ]),

    #Victory normal
    ( 1, 1, ti_once,[
      (num_active_teams_le, 1),
      (neg|main_hero_fallen),
    ],[
      (assign, "$g_battle_result", 1),
      (assign,"$g_encountered_party",-1),
      (tutorial_message_set_background, 1),
      (tutorial_message,"@The bandits have been dealt with.^^When you want to leave, press TAB."),
    ]),

    common_inventory_not_available,
    (ti_tab_pressed, 0, 0, [(eq, "$g_battle_result", 0),],[
      (display_message, "str_cannot_leave_now"),
    ]),
    (ti_tab_pressed, 0, 0, [(eq, "$g_battle_result", 1),],[
      (jump_to_menu, "mnu_fake_nero_defeated"),
      (finish_mission),
    ]),

    (0, 0, ti_once, [],[
      (call_script, "script_music_set_situation_with_culture", 0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent"),
      (store_trigger_param_2, ":killer"),
      (agent_get_troop_id,":cur_troop_id",":dead_agent"),
      (eq,":cur_troop_id","trp_fake_nero"),
      (neg|agent_is_non_player, ":killer"),
      (display_message,"@You have just killed Nero reborn. Rummaging through his things, you find some treasures. You still need to defeat the other enemies before you can collect your reward.",color_good_news),
      (call_script, "script_change_player_honor", 2),
      (call_script, "script_change_troop_renown", "trp_player", 15),
      (add_xp_as_reward, 150),
      (val_sub, "$g_unrest", 5),
      (display_message, "@Stability of the Empire increases", color_good_news),
    ]),
    (0, 0, ti_once, [
      (tutorial_message_set_size, 15, 15),
      (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
      (tutorial_message_set_center_justify, 0),
    ],[]),

    (2,0,0,[
      (neg|conversation_screen_is_active),
      (neg|is_presentation_active, "prsnt_battle"),
      (eq, "$g_battle_result", 0),
    ],[
      (store_mission_timer_a, ":cur_time"),
      (try_begin),
        (ge, ":cur_time", 140),
        (tutorial_message, -1),
      (else_try),
        (ge, ":cur_time", 100),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@You spot the false Nero in the distance. He's hiding in the ruins."),
      (else_try),
        (ge, ":cur_time", 60),
        (tutorial_message, -1),
      (else_try),
        (ge, ":cur_time", 40),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@Follow the path to find the false Nero."),
      (else_try),
        (ge, ":cur_time", 16),
        (tutorial_message, -1),
      (else_try),
        (ge, ":cur_time", 6),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@The enemies spotted your ships and prepared an ambush. Defend!"),
      (try_end),
    ]),
]),

("center_management",0,-1,
  "dungeon",[
    (0,mtef_visitor_source,af_override_all,0,1,[]),
  ],[
    cannot_spawn_commoners,
    (0, 0, 0, [
      (neg|is_presentation_active, "prsnt_center_management"),
    ],[
      (start_presentation, "prsnt_center_management"),
    ]),

    (ti_after_mission_start, 0, ti_once, [],[
      (mission_cam_set_screen_color, 0xFF000000),
      # (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
    ]),

    (0, 0, ti_once, [],[
      (set_rain, 2, 0),
      (set_rain, 1, 0),
      (set_rain, 0, 100),
      (assign, "$g_improvement_type", -1),
    ]),

    deactivate_player_agent,

    (ti_question_answered, 0, 0, [],[
      (store_trigger_param_1, ":answer"),
      (try_begin),
          (eq, ":answer", 0),
          (try_begin),#extort
              (eq, "$g_presentation_next_presentation", 3),
              (jump_to_menu, "mnu_center_extort_reaction"),
              (finish_mission),
          (else_try), #decrees
              (eq, "$g_presentation_next_presentation", 2),
              (try_begin),
                  (eq, "$temp", 1),#revoke decree
                  (try_begin),
                      (this_or_next|key_is_down, key_left_control),
                      (key_is_down, key_right_control),
                      (faction_slot_eq, "$g_encountered_party_faction", slot_faction_government_type, gov_imperial),
                      (faction_slot_eq, "$g_encountered_party_faction", slot_faction_leader, "trp_player"),
                      (faction_get_slot, reg5, "$g_encountered_party_faction", slot_faction_treasury),
                      (ge, reg5, decree_cost),
                      (store_mul, ":take", decree_cost, -1),
                      (call_script, "script_add_to_faction_treasury", ":take", "$g_encountered_party_faction"),
                      (party_set_slot, "$g_encountered_party", "$g_improvement_type", 0),
                  (else_try),
                      (store_troop_gold, ":private_treasury", "trp_household_possessions"),
                      (store_troop_gold, ":player_gold", "trp_player"),
                      (val_add, ":player_gold", ":private_treasury"),
                      (ge, ":player_gold", decree_cost),
                      (call_script, "script_dplmc_remove_gold_from_lord_and_holdings", decree_cost, "trp_player"),
                      (party_set_slot, "$g_encountered_party", "$g_improvement_type", 0),
                  (else_try),
                      (display_message, "@Insufficient funds", message_alert),
                  (try_end),
                  #clear variables
                  (assign, "$g_improvement_type", -1),
                  (assign, "$temp", 0),
              (else_try),
                  (eq, "$temp", 2),#issue it!
                  (try_begin),
                      (this_or_next|key_is_down, key_left_control),
                      (key_is_down, key_right_control),
                      (faction_slot_eq, "$g_encountered_party_faction", slot_faction_government_type, gov_imperial),
                      (faction_slot_eq, "$g_encountered_party_faction", slot_faction_leader, "trp_player"),
                      (faction_get_slot, reg5, "$g_encountered_party_faction", slot_faction_treasury),
                      (ge, reg5, decree_cost),
                      (store_mul, ":take", decree_cost, -1),
                      (call_script, "script_add_to_faction_treasury", ":take", "$g_encountered_party_faction"),
                      (party_set_slot, "$g_encountered_party", "$g_improvement_type", 0),
                  (else_try),
                      (store_troop_gold, ":private_treasury", "trp_household_possessions"),
                      (store_troop_gold, ":player_gold", "trp_player"),
                      (val_add, ":player_gold", ":private_treasury"),
                      (ge, ":player_gold", decree_cost),
                      (call_script, "script_dplmc_remove_gold_from_lord_and_holdings", decree_cost, "trp_player"),
                      (party_set_slot, "$g_encountered_party", "$g_improvement_type", 1),
                  (else_try),
                      (display_message, "@Insufficient funds", message_alert),
                  (try_end),
                  #clear variables
                  (assign, "$g_improvement_type", -1),
                  (assign, "$temp", 0),
              (try_end),
          (else_try), #buildings
              (eq, "$g_presentation_next_presentation", 1),
              (try_begin),
                  (eq, "$temp", 1),#destroy a building
                  (call_script, "script_get_improvement_details", "$g_improvement_type", "$g_encountered_party"),
                  (val_mul, reg0, 3),
                  (val_div, reg0, 5),
                  (display_message, "@{s0} has been destroyed. You gained {reg0} of denars.", message_alert),
                  (troop_add_gold, "trp_player", reg0),
                  (party_set_slot, "$g_encountered_party", "$g_improvement_type", 0),

                  (try_begin),#clear also for temple god
                      (eq, "$g_improvement_type", slot_center_has_temple),
                      (party_set_slot, "$g_encountered_party", slot_center_has_temple_god, 0),
                  (try_end),
                  #clear variables
                  (assign, "$g_improvement_type", -1),
                  (assign, "$temp", 0),
                  (call_script, "script_change_center_prosperity", "$g_encountered_party", -4),
                  (call_script, "script_change_player_relation_with_center", "$g_encountered_party", -2),
              (else_try),
                  (eq, "$temp", 3),#cancle a building
                  (party_set_slot, "$g_encountered_party", slot_center_current_improvement, 0),
                  (party_get_slot, ":hours_left", "$g_encountered_party", slot_center_improvement_end_hour),
                  #player gets some money back
                  (store_current_hours, ":cur_hours"),
                  (val_sub, ":hours_left", ":cur_hours"),
                  (val_mul, ":hours_left", 10), #a paltry sum
                  (troop_add_gold, "trp_player", ":hours_left"),

                  #clear variables
                  (try_begin),#clear also for temple god
                      (eq, "$g_improvement_type", slot_center_has_temple),
                      (party_set_slot, "$g_encountered_party", slot_center_has_temple_god, 0),
                  (try_end),
                  (assign, "$g_improvement_type", -1),
                  (assign, "$temp", 0),
                  (call_script, "script_change_center_prosperity", "$g_encountered_party", -4),
                  (call_script, "script_change_player_relation_with_center", "$g_encountered_party", -2),
              (else_try),
                  (eq, "$temp", 4),#cancle a building
                  (party_set_slot, "$g_encountered_party", slot_center_current_improvement_2, 0),
                  (party_get_slot, ":hours_left", "$g_encountered_party", slot_center_improvement_2_end_hour),
                  #player gets some money back
                  (store_current_hours, ":cur_hours"),
                  (val_sub, ":hours_left", ":cur_hours"),
                  (val_mul, ":hours_left", 10), #a paltry sum
                  (troop_add_gold, "trp_player", ":hours_left"),
                  #clear variables
                  (try_begin),#clear also for temple god
                      (eq, "$g_improvement_type", slot_center_has_temple),
                      (party_set_slot, "$g_encountered_party", slot_center_has_temple_god, 0),
                  (try_end),
                  (assign, "$g_improvement_type", -1),
                  (assign, "$temp", 0),
                  (call_script, "script_change_center_prosperity", "$g_encountered_party", -4),
                  (call_script, "script_change_player_relation_with_center", "$g_encountered_party", -2),
              (else_try),
                  (eq, "$temp", 2),#build it!
                  (try_begin), #fast build
                      (ge, "$cheat_mode", 1),
                      (assign, "$diplomacy_var2", 0),
                      (call_script, "script_improve_center", "$g_encountered_party", "$lord_selected", "$diplomacy_var2"),
                  (else_try),
                      (try_begin),
                          (this_or_next|key_is_down, key_left_control),
                          (key_is_down, key_right_control),
                          (faction_slot_eq, "$g_encountered_party_faction", slot_faction_government_type, gov_imperial),
                          (faction_slot_eq, "$g_encountered_party_faction", slot_faction_leader, "trp_player"),
                          (faction_get_slot, reg5, "$g_encountered_party_faction", slot_faction_treasury),
                          (ge, reg5, "$diplomacy_var"),
                          (store_mul, ":take", "$diplomacy_var", -1),
                          (call_script, "script_add_to_faction_treasury", ":take", "$g_encountered_party_faction"),
                          (call_script, "script_improve_center", "$g_encountered_party", "$lord_selected", "$diplomacy_var2"),
                      (else_try),
                          (store_troop_gold, ":private_treasury", "trp_household_possessions"),
                          (store_troop_gold, ":player_gold", "trp_player"),
                          (val_add, ":player_gold", ":private_treasury"),
                          (ge, ":player_gold", "$diplomacy_var"),
                          (call_script, "script_dplmc_remove_gold_from_lord_and_holdings", "$diplomacy_var", "trp_player"),
                          (call_script, "script_improve_center", "$g_encountered_party", "$lord_selected", "$diplomacy_var2"),
                      (else_try),
                          (display_message, "@Insufficient funds", message_alert),
                      (try_end),
                  (try_end),
                  #clear variables
                  (assign, "$g_improvement_type", -1),
                  (assign, "$temp", 0),
              (try_end),
          (try_end),
      (else_try),
          (assign, "$g_improvement_type", -1),
          (assign, "$temp", 0),
          # (start_presentation, "prsnt_center_management"),
      (try_end),
    ]),
]),

("return_to_game_options",0,-1,
  "dungeon",[
    (0,mtef_visitor_source,af_override_all,0,1,[]),
  ],[
    cannot_spawn_commoners,
    (0, 0, 0, [
    ],[
      (try_begin),
        (eq, "$temp", 2),
        (jump_to_menu, "mnu_simple_encounter"),
        (finish_mission),
      (else_try),
        (eq, "$temp", 1),
        (change_screen_options),
        (assign, "$temp", 2),
      (try_end),
    ]),
    (ti_after_mission_start, 0, ti_once, [],[
      (mission_cam_set_screen_color, 0xFF000000),
    ]),
]),

("greek_game",mtf_battle_mode,-1,#cueva odin chief mainquest #cueva de odin chief
  "dungeon",[
    (0,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (1,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (2,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (3,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (4,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (5,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (6,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (7,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (8,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (9,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (10,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (11,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (12,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (13,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (14,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (15,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (16,mtef_visitor_source|mtef_team_2,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_dagger]),
    (17,mtef_visitor_source|mtef_team_2,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_dagger]),
    (18,mtef_visitor_source|mtef_team_2,af_override_horse|af_override_weapons,aif_start_alarmed,1,[itm_dagger]),
    (19,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (20,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (21,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (22,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (23,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (24,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (25,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (26,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (27,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (28,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (29,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (30,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (31,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (32,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (33,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (34,mtef_visitor_source|mtef_team_2,af_override_horse,aif_start_alarmed,1,[]),
    (35,mtef_visitor_source|mtef_team_2,af_override_everything|af_override_foot,0,1,[itm_female_caligea_gold,itm_roman_femal_rich3_new,itm_flower_crown]),
    (36,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    dedal_shield_bash,
    dedal_shield_bash_AI,
    custom_commander_critical_strike,
    wounds_vc,

    (ti_before_mission_start, 0, 0, [],
    [
    (assign,"$g_battle_result",0),
    (team_set_relation, 0, 1, -1), # -1 for enemy, 1 for friend, 0 for neutral
    (team_set_relation, 0, 2, 1), # -1 for enemy, 1 for friend, 0 for neutral
    (team_set_relation, 1, 2, 1), # -1 for enemy, 1 for friend, 0 for neutral
    ]),

    (5, 3, ti_once, #normal mode
    [

    (main_hero_fallen),
    (assign,"$g_battle_result",-1),
    (assign,"$g_encountered_party",-1),
    (call_script, "script_change_troop_renown", "trp_player", -5),
    (display_message, "@You fall, the game is over..."),

    ],
    [
    (jump_to_menu, "mnu_greek_game_defeat"),
    (finish_mission),
    ]),

    (5, 3, ti_once, #normal mode
    [

    (neg|main_hero_fallen),
    (eq,"$g_battle_result",1),
    (assign,"$g_encountered_party",-1),
    ],
    [
    (jump_to_menu, "mnu_greek_game_won"),
    (finish_mission),
    ]),
    common_inventory_not_available,

    (ti_tab_pressed, 0, 0, [(eq, "$g_battle_result", 0),],
    [
      (display_message, "str_cannot_leave_now"),
    ]),

    (0, 0, ti_once, [],
    [
    (mission_enable_talk),
    (call_script, "script_music_set_situation_with_culture", 0),
    ]),


    ##start conversation with troops
    (1, 0, 0,[
      (this_or_next|eq, "$temp", 17),
      (this_or_next|eq, "$temp", 15),
      (this_or_next|eq, "$temp", 12),
      (this_or_next|eq, "$temp", 9),
      (this_or_next|eq, "$temp", 5),
      (this_or_next|eq, "$temp", 0),
      (eq, "$temp", 2),
      (neg|conversation_screen_is_active),
    ],[
      (try_for_agents, ":agent_no"),
        (this_or_next|eq, "$temp", 17),
        (this_or_next|eq, "$temp", 15),
        (this_or_next|eq, "$temp", 12),
        (this_or_next|eq, "$temp", 9),
        (this_or_next|eq, "$temp", 5),
        (this_or_next|eq, "$temp", 0),
        (eq, "$temp", 2),
        (agent_is_active, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (try_begin),
          (eq, "$temp", 0),
          (assign, ":talk_troop", "trp_roman_town_walker"),
        (else_try),
          (eq, "$temp", 2),
          (assign, ":talk_troop", "trp_brigand"),
        (else_try),
          (eq, "$temp", 5),
          (assign, ":talk_troop", "trp_vigilia_vet"),
        (else_try),
          (eq, "$temp", 9),
          (assign, ":talk_troop", "trp_legio_xxii_primigenia_vet"),
        (else_try),
          (eq, "$temp", 12),
          (assign, ":talk_troop", "trp_praetoriani_milites_vet"),
        (else_try),
          (eq, "$temp", 15),
          (assign, ":talk_troop", "trp_courtier_female"),
        (else_try),
          (eq, "$temp", 17),
          (assign, ":talk_troop", "trp_greek_scholar"),
        (try_end),
        (eq, ":troop_no", ":talk_troop"),
        (init_position, pos0),
        (init_position, pos1),
        (get_player_agent_no, ":player_agent"),
        (agent_get_position, pos0, ":player_agent"),
        (agent_get_position, pos1, ":agent_no"),
        (set_fixed_point_multiplier, 1),
        (get_distance_between_positions_in_meters, ":dist", pos0, pos1),
        (le, ":dist", 3),
        (mission_enable_talk),
        (start_mission_conversation, ":talk_troop"),
        (try_begin),
          (eq, "$temp", 0),
          (assign, "$temp", 1),
        (else_try),
          (eq, "$temp", 2),
          (assign, "$temp", 3),
        (else_try),
          (eq, "$temp", 5),
          (assign, "$temp", 6),
        (else_try),
          (eq, "$temp", 9),
          (assign, "$temp", 10),
        (else_try),
          (eq, "$temp", 12),
          (assign, "$temp", 13),
        (else_try),
          (eq, "$temp", 15),
          (assign, "$temp", 16),
        (else_try),
          (eq, "$temp", 17),
          (assign, "$temp", 18),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0,
    [
    ],
    [
    (try_begin),
        (eq, "$temp", -1),
        (set_fixed_point_multiplier, 1),
        (entry_point_get_position, pos3, 60),
        (get_player_agent_no, ":player"),
        (agent_get_position, pos4, ":player"),
        (get_distance_between_positions_in_meters, ":dist", pos3, pos4),
        (le, ":dist", 2),
        (display_message, "@You can't advance now.", message_alert),
        (position_get_y, ":y", pos3),
        (val_add, ":y", 8),
        (position_set_y, pos3, ":y"),
        (agent_set_position, ":player", pos3),
    (else_try),
        (eq, "$temp", 4),
        (set_fixed_point_multiplier, 1),
        (entry_point_get_position, pos3, 61),
        (get_player_agent_no, ":player"),
        (agent_get_position, pos4, ":player"),
        (get_distance_between_positions_in_meters, ":dist", pos3, pos4),
        (le, ":dist", 2),
        (display_message, "@You can't advance now. Defeat the enemies first.", message_alert),
        (position_get_y, ":y", pos3),
        (val_add, ":y", 8),
        (position_set_y, pos3, ":y"),
        (agent_set_position, ":player", pos3),
    (else_try),
        (eq, "$temp", 5),
        (set_fixed_point_multiplier, 1),
        (entry_point_get_position, pos3, 62),
        (get_player_agent_no, ":player"),
        (agent_get_position, pos4, ":player"),
        (get_distance_between_positions_in_meters, ":dist", pos3, pos4),
        (le, ":dist", 2),
        (display_message, "@You can't advance now. Defeat the enemies first.", message_alert),
        (position_get_y, ":y", pos3),
        (val_add, ":y", 8),
        (position_set_y, pos3, ":y"),
        (agent_set_position, ":player", pos3),
    (else_try),
        (eq, "$temp", 8),
        (set_fixed_point_multiplier, 1),
        (entry_point_get_position, pos3, 63),
        (get_player_agent_no, ":player"),
        (agent_get_position, pos4, ":player"),
        (get_distance_between_positions_in_meters, ":dist", pos3, pos4),
        (le, ":dist", 2),
        (display_message, "@You can't advance now.", message_alert),
        (position_get_y, ":y", pos3),
        (val_add, ":y", 8),
        (position_set_y, pos3, ":y"),
        (agent_set_position, ":player", pos3),
    (else_try),
        (eq, "$temp", 11),
        (set_fixed_point_multiplier, 1),
        (entry_point_get_position, pos3, 64),
        (get_player_agent_no, ":player"),
        (agent_get_position, pos4, ":player"),
        (get_distance_between_positions_in_meters, ":dist", pos3, pos4),
        (le, ":dist", 2),
        (display_message, "@You can't advance now. Defeat the enemies first.", message_alert),
        (position_get_y, ":y", pos3),
        (val_add, ":y", 8),
        (position_set_y, pos3, ":y"),
        (agent_set_position, ":player", pos3),
    (else_try),
        (eq, "$temp", 14),
        (set_fixed_point_multiplier, 1),
        (entry_point_get_position, pos3, 65),
        (get_player_agent_no, ":player"),
        (agent_get_position, pos4, ":player"),
        (get_distance_between_positions_in_meters, ":dist", pos3, pos4),
        (le, ":dist", 2),
        (display_message, "@You can't advance now. Defeat the enemies first.", message_alert),
        (position_get_y, ":y", pos3),
        (val_add, ":y", 8),
        (position_set_y, pos3, ":y"),
        (agent_set_position, ":player", pos3),
    (try_end),
    ]),

    (1, 0, 0, [],
    [
    (get_player_agent_no, ":player"),
    (agent_get_kill_count, ":kill", ":player"),#killed
    (agent_get_kill_count, ":kill2", ":player",1),#wounded
    (val_add, ":kill", ":kill2"),
    (try_begin),
        (eq, ":kill", 5),
        (lt, "$temp", 5),
        (assign, "$temp", 5),
    (else_try),
        (eq, ":kill", 8),
        (lt, "$temp", 8),
        (assign, "$temp", 8),
    (else_try),
        (eq, ":kill", 11),
        (lt, "$temp", 12),
        (assign, "$temp", 12),
    (else_try),
        (eq, ":kill", 14),
        (lt, "$temp", 15),
        (assign, "$temp", 15),
    (try_end),
    ]),

      (0, 0, ti_once, [
          (tutorial_message_set_size, 15, 15),
          (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
          (tutorial_message_set_center_justify, 0),
          ],[]),

      (1,0,0,[
    (neg|conversation_screen_is_active),
    (eq, "$g_battle_result", 0),
        ],
        [
          (try_begin),
            (eq, "$temp", 10),
            (tutorial_message_set_background, 1),
            (tutorial_message, -1),
          (else_try),
            (eq, "$temp", 9),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@There is another level above. Grip your weapon and ascend."),
          (else_try),
            (eq, "$temp", 8),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@You have made it. Now you can see the pot. It is very much real.^You can move it. You can break it. If you do, you will change reality for all those in the bottom level in ways they themselves never could. ^That means you are responsible not only for yourself, but for them as well.^^Press K to continue."),
          (else_try),
            (eq, "$temp", 1),
            (tutorial_message_set_background, 1),
            (tutorial_message, -1),
          (else_try),
            (eq, "$temp", 0),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@Take your weapon and climb the stairs now."),
          (else_try),
            (eq, "$temp", -1),
            (tutorial_message_set_background, 1),
            (tutorial_message, "@This is the lowest level of Plato's Cave. It is where most people live, happy to go about their lives.^They see shadows on the wall, cast from above, and these shadows ARE their world. They see the shadow of that pot, but they don't see the pot. It is all they have ever known and all they will ever know.^If you try to drag them up the stairs they will hate you. They will fight you.^You can stay here with them and live a happy life, but then you will never know how the world truly is.^^Press K to continue."),
          (try_end),
      ]),

    (0, 0, 1, [
    (key_is_down,key_k),
    ],[
    (try_begin),
        (eq, "$temp", -1),
        (assign, "$temp", 0),
    (else_try),
        (eq, "$temp", 8),
        (assign, "$temp", 9),
    (try_end),
	]),

    (ti_on_agent_spawn, 0, 0,
    [],
    [
    (store_trigger_param_1, ":agent"),
    (agent_is_alive, ":agent"),
    (agent_is_human, ":agent"),
    (agent_is_non_player, ":agent"),
    (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 0),
    ]),
]),

("elysium",mtf_battle_mode,-1,#cueva odin chief mainquest #cueva de odin chief
  "dungeon",
  [
    (0,mtef_visitor_source|mtef_team_0,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (1,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (2,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (3,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (4,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (5,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (6,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (7,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
  ],p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    (ti_before_mission_start, 0, 0, [],[
      (scene_set_day_time, 12),
      (set_global_cloud_amount, 0),
      (set_global_haze_amount, 0),
    ]),

    common_inventory_not_available,

    (ti_tab_pressed, 0, 0, [],[
      (display_message, "str_cannot_leave_now"),
      #(set_trigger_result, 1),
    ]),

    (ti_after_mission_start, 0, 0, [],[
      (assign, "$temp", 0),
      (mission_enable_talk),
      (play_track, "track_final_glory", 1),
    ]),
 # (ti_on_agent_spawn,0,0,[
    # (store_trigger_param_1, ":agent"),
    # (agent_is_active, ":agent"),
    # (agent_is_non_player, ":agent"),
    # (agent_set_no_dynamics, ":agent", 1),
    # (agent_set_stand_animation, ":agent", "anim_female_lie_sexy"),
    # (agent_set_animation, ":agent", "anim_female_lie_sexy"),
    # (store_random_in_range,":r",0,300),
    # (agent_set_animation_progress,":agent",":r"),
	# ],[]),
   # (0, 0, ti_once, [
    # (try_for_agents, ":agent"),
        # (agent_is_active, ":agent"),
        # (agent_is_non_player, ":agent"),
        # (set_fixed_point_multiplier, 1),
        # (agent_get_position, pos1, ":agent"),
        # (agent_set_no_dynamics, ":agent", 1),
        # (position_move_z, pos1, -110),
        # (agent_set_position, ":agent", pos1),
    # (try_end),
   # ],
   # []),

    ##start conversation with troops
    (1, 0, 0,[
      (neg|conversation_screen_is_active),
    ],[
      (try_for_agents, ":agent_no"),
        (eq, "$temp", 0),
        (agent_is_active, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (this_or_next|eq, ":troop_no", "trp_desiderius"),
        (this_or_next|eq, ":troop_no", "trp_odius"),
        (this_or_next|eq, ":troop_no", "trp_amalia"),
        (eq, ":troop_no", "trp_fiducia"),
        (init_position, pos0),
        (init_position, pos1),
        (get_player_agent_no, ":player_agent"),
        (agent_get_position, pos0, ":player_agent"),
        (agent_get_position, pos1, ":agent_no"),
        (set_fixed_point_multiplier, 1),
        (get_distance_between_positions_in_meters, ":dist", pos0, pos1),
        (le, ":dist", 8),
        (start_mission_conversation, "trp_fiducia"),
        (assign, "$temp", 1),
      (try_end),
    ]),

    (0, 0, ti_once, [
      (tutorial_message_set_size, 15, 15),
      (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
      (tutorial_message_set_center_justify, 0),
    ],[]),

    (1,0,0,[
      (neg|conversation_screen_is_active),
    ],[
      (store_mission_timer_a, ":time"),
      (try_begin),
        (ge, ":time", 25),
        (tutorial_message_set_background, 1),
        (tutorial_message, -1),
      (else_try),
        (ge, ":time", 2),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@You wake up with a terrible headache. You smell beautiful flowers and the trees are full of fruits. You hear a sweet voice in the distance. This must be Elysium. Now its time to explore it."),
      (try_end),
    ]),
]),

("conversation_generic",mtf_battle_mode,-1,"Conversation_encounter",[
    (0,mtef_visitor_source,0,0,1,[]),
    (1,mtef_visitor_source,0,0,1,[]),
    (2,mtef_visitor_source,0,0,1,[]),
    (3,mtef_visitor_source,0,0,1,[]),
    (4,mtef_visitor_source,0,0,1,[]),
    (5,mtef_visitor_source,0,0,1,[]),
    (6,mtef_visitor_source,0,0,1,[]),
    (7,mtef_visitor_source,0,0,1,[]),
    (8,mtef_visitor_source,0,0,1,[]),
    (9,mtef_visitor_source,0,0,1,[]),
    (10,mtef_visitor_source,0,0,1,[]),
    (11,mtef_visitor_source,0,0,1,[]),
    (12,mtef_visitor_source,0,0,1,[]),
    (13,mtef_visitor_source,0,0,1,[]),
    (14,mtef_visitor_source,0,0,1,[]),
    (15,mtef_visitor_source,0,0,1,[]),
    (16,mtef_visitor_source,0,0,1,[]),
    (17,mtef_visitor_source,0,0,1,[]),
    (18,mtef_visitor_source,0,0,1,[]),
    (19,mtef_visitor_source,0,0,1,[]),
    (20,mtef_visitor_source,0,0,1,[]),
    (21,mtef_visitor_source,0,0,1,[]),
    (22,mtef_visitor_source,0,0,1,[]),
    (23,mtef_visitor_source,0,0,1,[]),
    (24,mtef_visitor_source,0,0,1,[]),
    (25,mtef_visitor_source,0,0,1,[]),
    (26,mtef_visitor_source,0,0,1,[]),
    (27,mtef_visitor_source,0,0,1,[]),
    (28,mtef_visitor_source,0,0,1,[]),
    (29,mtef_visitor_source,0,0,1,[]),
    (30,mtef_visitor_source,0,0,1,[]),
    (31,mtef_visitor_source,0,0,1,[]),
    (32,mtef_visitor_source,0,0,1,[]),
    (33,mtef_visitor_source,0,0,1,[]),
    (34,mtef_visitor_source,0,0,1,[]),
    (35,mtef_visitor_source,0,0,1,[]),
    (36,mtef_visitor_source,0,0,1,[]),
    (37,mtef_visitor_source,0,0,1,[]),
    (38,mtef_visitor_source,0,0,1,[]),
    (39,mtef_visitor_source,0,0,1,[]),
    (40,mtef_visitor_source,0,0,1,[]),
    (41,mtef_visitor_source,0,0,1,[]),
    (42,mtef_visitor_source,0,0,1,[]),
    (43,mtef_visitor_source,0,0,1,[]),
    (44,mtef_visitor_source,0,0,1,[]),
    (45,mtef_visitor_source,0,0,1,[]),
    (46,mtef_visitor_source,0,0,1,[]),
    (47,mtef_visitor_source,0,0,1,[]),
  ], p_wetter + global_common_triggers +
  [
    (0,8,0,[
      (assign, ":c", 0),
      (try_begin),
        (check_quest_active, "qst_wlodowiecus_adventure_4"),
        (eq, "$temp1", 10),
        (assign, ":c", 1),
      (else_try),
        (store_current_scene, ":scene"),
        (eq, ":scene", "scn_kashar"),
        (eq, "$temp1", 13),
        (assign, ":c", 1),
      (try_end),
      (eq, ":c", 1),
    ],[
      (try_for_agents,":agent_no"),
        (agent_is_alive,":agent_no"),
        (agent_is_human,":agent_no"),
        (agent_get_entry_no, ":entry", ":agent_no"),
        (is_between, ":entry", 26,43),
        (assign, ":continue_walk", 0),
        (store_random_in_range, ":continue_walk", 1, 100),
        (try_begin),
          (le, ":continue_walk", 38),
          (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
          (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
          (agent_set_animation, ":agent_no", "anim_stand_man"),
          (agent_set_animation_progress, ":agent_no", 10),

          (agent_get_position, pos1, ":agent_no"),
          (store_random_in_range, ":points", 25, 46),
          (entry_point_get_position, pos2, ":points"),
          (agent_set_speed_limit, ":agent_no", 1),
          (agent_set_scripted_destination, ":agent_no", pos2),
        (try_end),
      (try_end),
    ]),
    cannot_spawn_commoners,
    improved_lightning,
    (0, 0, ti_once,[
      (check_quest_active, "qst_wlodowiecus_adventure_4"),
      (this_or_next|eq, "$temp1", 9),
      (this_or_next|eq, "$temp1", 8),
      (eq, "$temp1", 7),
    ],[
      (try_for_agents, ":agent_no"),
          (call_script, "script_init_town_agent", ":agent_no"),
      (try_end),
      (try_begin),
          (check_quest_active, "qst_wlodowiecus_adventure_4"),
          (call_script, "script_music_set_situation_with_culture", mtf_sit_ambushed),
      (else_try),
          (call_script, "script_music_set_situation_with_culture", mtf_sit_feast),
      (try_end),
    ]),
    (ti_after_mission_start, 0, 0, [],[(mission_enable_talk),]),
    (0, 0, ti_once,[
      (this_or_next|eq, "$temp1", 1),
      (this_or_next|eq, "$temp1", 4),
      (eq, "$temp1", 2),
      (neg|conversation_screen_is_active),
      (gt, "$temp2", 0),
    ],[
      (start_mission_conversation, "$temp2"),
    ]),
    (0, 0, ti_once,[
      (eq, "$temp1", 9),
      (check_quest_active, "qst_wlodowiecus_adventure_4"),
      (neg|conversation_screen_is_active),
    ],[
      (try_for_agents, ":agent"),
          (agent_is_active, ":agent"),
          (agent_get_troop_id,":troop",":agent"),
          (this_or_next|eq, ":troop", "trp_hadrianus"),
          (eq, ":troop", "trp_diggus"),
          (agent_fade_out, ":agent"),
      (try_end),
    ]),
    (1, 1, ti_once,[
      (eq, "$temp1", 3),
      (check_quest_active, "qst_wlodowiecus_adventure_4"),
      (quest_slot_eq, "qst_wlodowiecus_adventure_4", slot_quest_current_state, 8),
      (neg|conversation_screen_is_active),
    ],[
      (try_for_agents, ":agent"),
          (agent_is_active, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (eq, ":troop", "trp_lombard_vetran"),
          (agent_set_no_death_knock_down_only, ":agent", 0),
          (agent_deliver_damage_to_agent, ":agent", ":agent", 10000),
      (try_end),
      (assign, "$temp1", 4),
    ]),
    (1, 2, ti_once,[
      (eq, "$temp1", 4),
      (check_quest_active, "qst_wlodowiecus_adventure_4"),
      (quest_slot_eq, "qst_wlodowiecus_adventure_4", slot_quest_current_state, 8),
      (neg|conversation_screen_is_active),
    ],[
      (mission_enable_talk),
      (start_mission_conversation, "$temp2"),
    ]),
    (1, 1, ti_once,[
      (eq, "$temp1", 5),
      (check_quest_active, "qst_wlodowiecus_adventure_4"),
      (quest_slot_eq, "qst_wlodowiecus_adventure_4", slot_quest_current_state, 8),
      (neg|conversation_screen_is_active),
    ],[
      (try_for_agents, ":agent"),
          (agent_is_active, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (eq, ":troop", "trp_alan_guide"),
          (agent_set_no_death_knock_down_only, ":agent", 0),
          (agent_deliver_damage_to_agent, ":agent", ":agent", 10000),
      (try_end),
      (assign, "$temp1", 6),
    ]),
    (1, 2, ti_once,[
      (eq, "$temp1", 6),
      (check_quest_active, "qst_wlodowiecus_adventure_4"),
      (quest_slot_eq, "qst_wlodowiecus_adventure_4", slot_quest_current_state, 8),
      (neg|conversation_screen_is_active),
    ],[
      (mission_enable_talk),
      (start_mission_conversation, "$temp2"),
    ]),
    (ti_before_mission_start, 0, 0, [],[
      (try_begin),
          (check_quest_active, "qst_wlodowiecus_adventure_2"),
          (this_or_next|eq, "$temp1", 3),
          (eq, "$temp1", 2),
          (scene_set_day_time, 19),
          (set_global_cloud_amount, 0),
      (else_try),
          (check_quest_active, "qst_wlodowiecus_adventure_4"),
          (eq, "$temp1", 1),
          (scene_set_day_time, 19),
          (set_global_cloud_amount, 0),
      (else_try),
          (check_quest_active, "qst_wlodowiecus_adventure_4"),
          (eq, "$temp1", 2),
          (scene_set_day_time, 16),
          (set_global_cloud_amount, 40),
      (else_try),
          (check_quest_active, "qst_wlodowiecus_adventure_4"),
          (eq, "$temp1", 7),
          (scene_set_day_time, 16),
          (set_global_cloud_amount, 0),
      (else_try),
          (check_quest_active, "qst_wlodowiecus_adventure_4"),
          (eq, "$temp1", 8),
          (scene_set_day_time, 20),
          (set_global_cloud_amount, 0),
      (else_try),
          (check_quest_active, "qst_wlodowiecus_adventure_4"),
          (eq, "$temp1", 10),
          (scene_set_day_time, 12),
          (set_global_cloud_amount, 0),
      (else_try),
          (check_quest_active, "qst_wlodowiecus_adventure_4"),
          (eq, "$temp1", 11),
          (scene_set_day_time, 12),
          (set_global_cloud_amount, 0),
      (try_end),
    ]),
    (ti_tab_pressed, 0, 0, [
      (try_begin),
        (check_quest_active, "qst_wlodowiecus_adventure_4"),
        (quest_slot_eq, "qst_wlodowiecus_adventure_4", slot_quest_current_state, 8),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (eq, "$temp1", 3),
        (tutorial_box,"@Speak with Mancinellus!"),
      (else_try),
        (eq, "$temp1", 5),
        (tutorial_box,"@Speak with Hludwig!"),
      (else_try),
        (eq, "$temp1", 7),
        (tutorial_box,"@Speak with The Lybian!"),
      (else_try),
        (eq, "$temp1", 8),
        (tutorial_box,"@Speak with other guests to conclude the feast!^^[Hint: Either help Hadrianus or flirt with a Roman Noble Lady.]"),
      (else_try),
        (eq, "$temp1", 9),
        (tutorial_box,"@Speak with other guests to conclude the feast!^^[Hint: Hadrian is gone now. Flirt with a Roman Noble Lady to escape.]"),
      (else_try),
        (eq, "$temp1", 10),
        (tutorial_box,"@Speak with Wlodowiecus"),
      (else_try),
        (eq, "$temp1", 11),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (neg|check_quest_active, "qst_wlodowiecus_adventure_4"),
        (neg|check_quest_active, "qst_wlodowiecus_adventure_3"),
        (neg|check_quest_active, "qst_wlodowiecus_adventure_2"),
        (neg|check_quest_active, "qst_wlodowiecus_adventure_1"),
        (eq, "$temp1", 12),
        (tutorial_box,"@Enjoy or survive your time at the lupanar..."),
      (else_try),
        (neg|check_quest_active, "qst_wlodowiecus_adventure_4"),
        (neg|check_quest_active, "qst_wlodowiecus_adventure_3"),
        (neg|check_quest_active, "qst_wlodowiecus_adventure_2"),
        (neg|check_quest_active, "qst_wlodowiecus_adventure_1"),
        (eq, "$temp1", 13),
        (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
        (finish_mission, 3),
        (mission_disable_talk),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ],[]),
]),

("wlods_advantures_fight", mtf_battle_mode,-1,
  "monasterio",[
    (0,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (1,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (2,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (3,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (4,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent"),
      (agent_is_human, ":agent"),
      (agent_is_ally, ":agent"),
      (agent_get_troop_id, ":troop", ":agent"),
      (neq, ":troop", "trp_player"),
      (try_begin),
          (troop_is_hero, ":troop"),
          (agent_set_damage_modifier,  ":agent", 250),
          (agent_set_accuracy_modifier,  ":agent", 500),
      (else_try),
          (agent_set_damage_modifier,  ":agent", 150),
          (agent_set_accuracy_modifier,  ":agent", 500),
      (try_end),
    ]),
    (ti_before_mission_start, 0, 0, [],[
      (try_begin),
          (eq, "$temp3", 1),
          (try_begin),
              (check_quest_active, "qst_wlodowiecus_adventure_2"),
              (scene_set_day_time, 16),
              (set_global_cloud_amount, 0),
          (else_try),
              (check_quest_active, "qst_wlodowiecus_adventure_3"),
              (scene_set_day_time, 10),
          (else_try),
              (check_quest_active, "qst_wlodowiecus_adventure_4"),
              (scene_set_day_time, 14),
          (try_end),
      (else_try),
          (eq, "$temp3", 2),
          (try_begin),
              (check_quest_active, "qst_wlodowiecus_adventure_3"),
              (scene_set_day_time, 0),
          (try_end),
      (try_end),
    ]),

    common_inventory_not_available,
    common_battle_init_banner,
    wounds_vc,

    (ti_after_mission_start, 0, 0, [],[(call_script, "script_music_set_situation_with_culture", mtf_sit_fight)]),

    (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

    (1, 10, ti_once, [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le,1)
    ],[
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "$temp2"),
      (else_try),
        (jump_to_menu, "$temp1"),
      (try_end),
      (stop_all_sounds, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      (finish_mission, 4),
    ]),

    (0, 0, ti_once, [],[
      (assign, "$g_battle_won", 0),
      (set_fixed_point_multiplier, 100),
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 1),
      (position_get_y, ":y", pos10),
      (val_add, ":y", 10000),
      (position_set_y, pos10, ":y"),
      (try_for_range, ":cur_group", 0, grc_everyone),
        (team_give_order, 0, ":cur_group", mordr_hold),
        (team_give_order, 0, ":cur_group", mordr_spread_out),
        (team_set_order_position, 0, ":cur_group", pos10),
      (try_end),

      (entry_point_get_position, pos10, 4),
      (position_get_y, ":y", pos10),
      (val_add, ":y", 10000),
      (position_set_y, pos10, ":y"),
      (try_for_range, ":cur_group", 0, grc_everyone),
        (team_give_order, 1, ":cur_group", mordr_hold),
        (team_give_order, 1, ":cur_group", mordr_spread_out),
        (team_set_order_position, 1, ":cur_group", pos10),
      (try_end),
      (set_show_messages, 1),
    ]),

    (0, 0, ti_once, [
      (store_mission_timer_a, ":time"),
      (gt, ":time", 20),
    ],[
      (set_show_messages, 0),
      (try_for_range, ":cur_group", 0, grc_everyone),
        (team_give_order, 0, ":cur_group", mordr_charge),
        (team_give_order, 0, ":cur_group", mordr_spread_out),
      (try_end),

      (try_for_range, ":cur_group", 0, grc_everyone),
        (team_give_order, 1, ":cur_group", mordr_charge),
        (team_give_order, 1, ":cur_group", mordr_spread_out),
      (try_end),
      (set_show_messages, 1),
    ]),
    common_battle_order_panel,
    common_battle_order_panel_tick,
] + utility_triggers + battle_panel_triggers + improved_horse_archer_ai + dplmc_battle_mode_triggers_no_deathcam + theoris_decapitation),

("wlods_advantures_jilu_siege", mtf_battle_mode,-1,
  "monasterio",[
    (0,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (1,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (2,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (4,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (5,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (6,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (7,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (8,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (9,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (10,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (11,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (12,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (13,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (14,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (15,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (16,mtef_visitor_source|mtef_team_4,af_override_horse,aif_start_alarmed,1,[]),
    (17,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (18,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (19,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (20,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (21,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (22,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (23,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (24,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (25,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (26,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (27,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (28,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (29,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (30,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (31,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (32,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (33,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (34,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (35,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (36,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (37,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (38,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (39,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (40,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (41,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (42,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (43,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (44,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (45,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (46,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (47,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    common_siege_attacker_do_not_stall,
    cannot_spawn_commoners,
    improved_lightning,
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent"),
      (agent_is_human, ":agent"),
      (agent_is_ally, ":agent"),
      (agent_get_troop_id, ":troop", ":agent"),
      (neq, ":troop", "trp_player"),
      (try_begin),
          (troop_is_hero, ":troop"),
          (agent_set_no_death_knock_down_only, ":agent", 1),
          (try_begin),
              (eq, ":troop", "trp_hadrianus"),
              (agent_set_damage_modifier,  ":agent", 500),
              (agent_set_accuracy_modifier,  ":agent", 500),
              (agent_ai_set_aggressiveness, ":agent", 10000),
              (agent_ai_set_always_attack_in_melee, ":agent", 1),
              (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 250),
          (else_try),
              (agent_set_damage_modifier,  ":agent", 120),
          (try_end),
      (else_try),
          (agent_set_damage_modifier,  ":agent", 115),
      (try_end),
    ]),
    (ti_before_mission_start, 0, 0, [],[
      (try_begin),
          (check_quest_active, "qst_wlodowiecus_adventure_4"),
          (scene_set_day_time, 11),
          (set_global_cloud_amount, 50),
      (try_end),
    ]),

    common_inventory_not_available,
    common_battle_init_banner,
    wounds_vc,

    (ti_after_mission_start, 0, 0, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_siege),
    ]),

    (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

    (1, 3, ti_once, [
      (neg|main_hero_fallen),
      (neg|conversation_screen_is_active),
      (eq, "$temp3", 1),
    ],[
      (start_mission_conversation, "$temp1"),
    ]),
    (1, 3, ti_once, [
      (neg|main_hero_fallen),
      (neg|conversation_screen_is_active),
      (eq, "$temp3", 2),
    ],[
      (tutorial_box, "@New objective: Follow Hadrianus to battle and conquer the fortress!"),
      (get_player_agent_no, ":player"),
      (agent_play_sound, ":player", "snd_horn"),
    ]),
    (1, 0, ti_once,[
      (neg|main_hero_fallen),
      (neg|conversation_screen_is_active),
      (num_active_teams_le, 2),
      (eq, "$temp3", 2),
    ],[
      (start_mission_conversation, "$temp1"),
    ]),
    (1, 10, ti_once, [
      (main_hero_fallen),
    ],[
      (jump_to_menu, "$temp2"),
      (stop_all_sounds, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      (finish_mission, 4),
    ]),
    (0, 0, ti_once, [
      (eq, "$temp3", 2),
      (neg|conversation_screen_is_active),
    ],[
      (set_show_messages, 0),
      (try_for_range, ":cur_group", 0, grc_everyone),
        (team_give_order, "$attacker_team", ":cur_group", mordr_charge),
        (team_give_order, "$attacker_team_2", ":cur_group", mordr_charge),
      (try_end),
      (set_show_messages, 1),
      (team_set_relation, "$defender_team", "$attacker_team", -1),
      (team_set_relation, "$attacker_team", "$defender_team", -1),
      (team_set_relation, "$defender_team_2", "$attacker_team_2", -1),
      (team_set_relation, "$attacker_team_2", "$defender_team_2", -1),
      (set_party_battle_mode),
    ]),
    #let defenders hold position
    (0, 0, ti_once,[
      #set variables
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),

      (team_set_relation, "$defender_team", 4, 1),
      (team_set_relation, "$attacker_team", 4, 1),
      (team_set_relation, "$defender_team_2", 4, 1),
      (team_set_relation, "$attacker_team_2", 4, 1),

      (team_set_relation, "$defender_team", "$attacker_team", 1),
      (team_set_relation, "$attacker_team", "$defender_team", 1),
      (team_set_relation, "$defender_team_2", "$attacker_team_2", 1),
      (team_set_relation, "$attacker_team_2", "$defender_team_2", 1),

      (assign,"$defender_reinforcement_stage",0),
      (assign,"$attacker_reinforcement_stage",0),

      (set_show_messages, 0),
      (try_for_range, ":cur_group", 0, grc_everyone),
          (team_give_order, "$defender_team", ":cur_group", mordr_stand_ground),
          (team_give_order, "$defender_team", ":cur_group", mordr_stand_closer),
          (team_give_order, "$defender_team", ":cur_group", mordr_stand_closer),
          (team_give_order, "$defender_team", ":cur_group", mordr_stand_closer),
          (team_give_order, "$defender_team_2", ":cur_group", mordr_stand_ground),
          (team_give_order, "$defender_team_2", ":cur_group", mordr_stand_closer),
          (team_give_order, "$defender_team_2", ":cur_group", mordr_stand_closer),
          (team_give_order, "$defender_team_2", ":cur_group", mordr_stand_closer),
      (try_end),
      (set_show_messages, 1),
    ],[]),
    common_battle_order_panel,
    common_battle_order_panel_tick,
] + utility_triggers + battle_panel_triggers + dplmc_battle_mode_triggers_no_deathcam + theoris_decapitation),

("wlods_advantures_sogdia_siege", mtf_battle_mode,-1,
  "monasterio",[
    #attacker spawn + reinforcements
    (0,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (1,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (2,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (4,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (5,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (6,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (7,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (8,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (9,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),

    #defender spawns
    (10,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (11,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (12,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (13,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (14,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (15,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (16,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (17,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (18,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (19,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),

    (20,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (21,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (22,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (23,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (24,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (25,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (26,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (27,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (28,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (29,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (30,mtef_visitor_source|mtef_team_4,af_override_horse,aif_start_alarmed,1,[]),

    (31,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (32,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (33,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (34,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (35,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (36,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (37,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (38,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (39,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),

    #defender archer positions
    (40,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (41,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (42,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (43,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (44,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (45,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (46,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
    (47,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    common_siege_attacker_do_not_stall,
    cannot_spawn_commoners,
    improved_lightning,
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":agent"),
      (agent_is_human, ":agent"),
      (try_begin),
          (agent_is_ally, ":agent"),
          (val_sub, "$defender_reinforcement_stage", 1),
      (else_try),
          (neg|agent_is_ally, ":agent"),
          (val_sub, "$attacker_reinforcement_stage", 1),
      (try_end),
    ]),
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent"),
      (agent_is_human, ":agent"),
      (agent_is_active, ":agent"),
      (try_begin),
          (agent_is_ally, ":agent"),
          (val_add, "$defender_reinforcement_stage", 1),
          (agent_get_troop_id, ":troop", ":agent"),
          (neq, ":troop", "trp_player"),
          (try_begin),
              (troop_is_hero, ":troop"),
              (agent_set_damage_modifier,  ":agent", 175),
              (agent_set_accuracy_modifier,  ":agent", 500),
              (agent_set_no_death_knock_down_only, ":agent", 1),
              (try_begin),
                  (eq, ":troop", "$temp4"),
                  (agent_set_slot, ":agent", slot_agent_is_in_scripted_mode, 1),
                  (agent_get_position, pos10, ":agent"),
                  (agent_set_scripted_destination, ":agent", pos10, 0, 0),
              (else_try),
                  (agent_set_division, ":agent", sdt_bodyguard),
              (try_end),
          (else_try),
              (agent_set_damage_modifier,  ":agent", 125),
              (agent_set_accuracy_modifier,  ":agent", 500),
          (try_end),
      (else_try),
          (neg|agent_is_ally, ":agent"),
          (val_add, "$attacker_reinforcement_stage", 1),
      (try_end),
    ]),
    (ti_before_mission_start, 0, 0, [],[
      (try_begin),
          (check_quest_active, "qst_wlodowiecus_adventure_4"),
          (scene_set_day_time, 12),
          (set_global_cloud_amount, 40),
      (try_end),
      (assign, "$siege_threshold_attacker", 1000),#used in siege_move_archers_to_archer_positions
      (assign, "$siege_threshold_defender", 1000),#used in siege_move_archers_to_archer_positions
      # we abuse those threshold gobals to count agents as the normalized_team count is not satisfacting with output

      (assign,"$defender_reinforcement_stage",0),
      (assign,"$attacker_reinforcement_stage",0),
      #set variables
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ]),

    common_inventory_not_available,
    common_battle_init_banner,
    wounds_vc,

    (ti_after_mission_start, 0, 0, [],[(call_script, "script_music_set_situation_with_culture", mtf_sit_siege)]),

    (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

    (1, 10, ti_once, [
      (neg|main_hero_fallen),
      (ge, "$tutorial_state", 4),#at least 4 reinforcements appeared so far
      (neg|conversation_screen_is_active),
    ],[
      (start_mission_conversation, "$temp1"),
    ]),
    (1, 2, ti_once, [
      (neg|main_hero_fallen),
      (neg|conversation_screen_is_active),
      (eq, "$temp3", 2),
    ],[
      (tutorial_box, "@New objective: Find the ugly Alani warrior and escape through the hidden entrance."),
      (assign, "$temp3", 3),
      (set_fixed_point_multiplier, 100),
      (init_position, pos10),
      (entry_point_get_position, pos10, 30),
      (try_for_agents, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_is_alive, ":agent_no"),
          (agent_is_non_player, ":agent_no"),
          (agent_get_division, ":agent_division", ":agent_no"),
          (eq, ":agent_division", sdt_bodyguard),
          (agent_set_scripted_destination, ":agent_no", pos10),
          (agent_ai_set_aggressiveness, ":agent_no", 0),
          (agent_set_slot, ":agent_no", slot_agent_is_in_scripted_mode, 1),
          (agent_ai_set_always_attack_in_melee, ":agent_no", 0),
          (agent_force_rethink, ":agent_no"),
      (try_end),
    ]),
    (1, 0, ti_once,[
      (neg|main_hero_fallen),
      (neg|conversation_screen_is_active),
      (eq, "$temp3", 3),
      (get_player_agent_no, ":player_agent"),
      (agent_get_position, pos12, ":player_agent"),
      (entry_point_get_position, pos13, 30),
      (get_distance_between_positions_in_meters, ":distance", pos13, pos12),
      (le, ":distance", 4),
    ],[
      (start_mission_conversation, "$temp4"),
    ]),

    (1, 10, ti_once, [
      (main_hero_fallen),
    ],[
      (jump_to_menu, "$temp2"),
      (stop_all_sounds, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      (finish_mission, 4),
    ]),

    (0, 0, ti_once, [
      (store_mission_timer_a, ":time"),
      (gt, ":time", 50),
    ],[
      (set_show_messages, 0),
      (try_for_range, ":cur_group", 0, grc_everyone),
        (team_give_order, "$attacker_team", ":cur_group", mordr_charge),
        (team_give_order, "$attacker_team_2", ":cur_group", mordr_charge),
      (try_end),
      (set_show_messages, 1),
    ]),

    (1, 0, 0,[
      (mission_tpl_are_all_agents_spawned),
      (le, "$defender_reinforcement_stage", 32),
    ],[
      (try_for_range, ":entry", 12, 16),
        (add_visitors_to_current_scene, ":entry", "trp_saka_horse_archer", 10),
      (try_end),
      (display_message, "@New reinforcements arrive!", message_positive),
      (get_player_agent_no, ":player"),
      (agent_play_sound, ":player", "snd_horn"),
      (val_add, "$tutorial_state", 1),
    ]),

    (1, 0, 0,[
      (mission_tpl_are_all_agents_spawned),
      (le, "$attacker_reinforcement_stage", 25),
    ],[
      (try_for_range, ":entry", 5, 9),
        (add_visitors_to_current_scene, ":entry", "trp_xingnu_barbarian", 16),
      (try_end),
      (display_message, "@New enemies arrive!", message_negative),
      (get_player_agent_no, ":player"),
      (agent_play_sound, ":player", "snd_horn"),
      (val_add, "$tutorial_state", 1),
    ]),

    common_siege_defender_reinforcement_archer_reposition,
    #let defenders hold position
    (0, 0, ti_once,[
      (team_set_relation, "$defender_team", 4, 1),
      (team_set_relation, "$attacker_team", 4, 1),
      (team_set_relation, "$defender_team_2", 4, 1),
      (team_set_relation, "$attacker_team_2", 4, 1),

      (set_show_messages, 0),

      #give orders!
      (team_give_order, "$defender_team", grc_archers, mordr_stand_ground),
      (team_give_order, "$defender_team", grc_archers, mordr_stand_closer),
      (team_give_order, "$defender_team_2", grc_archers, mordr_stand_ground),
      (team_give_order, "$defender_team_2", grc_archers, mordr_stand_closer),
      (try_for_agents, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_is_alive, ":agent_no"),
          (agent_is_non_player, ":agent_no"),
          (agent_get_team, ":agent_team", ":agent_no"),#is a defender
          (try_begin),
              (this_or_next|eq, ":agent_team", "$defender_team"),
              (eq, ":agent_team", "$defender_team_2"),
              (agent_set_slot, ":agent_no", slot_agent_is_not_reinforcement, 1),
              (agent_get_entry_no, ":entry", ":agent_no"),
              (try_begin),
                  (eq, ":entry", 16),
                  (agent_set_division,":agent_no", 0),
              (else_try),
                  (eq, ":entry", 17),
                  (agent_set_division,":agent_no", 2),
              (else_try),
                  (eq, ":entry", 18),
                  (agent_set_division,":agent_no", 3),
              (else_try),
                  (eq, ":entry", 19),
                  (agent_set_division,":agent_no", 4),
              (try_end),
          (else_try),
              (try_begin),
                  #has a bow
                  (call_script, "script_cf_has_bow", ":agent_no"),
                  #(agent_get_troop_id, ":troop", ":agent_no"),
                  #(troop_is_guarantee_ranged, ":troop"),#archers go to archer point
                  # (agent_get_entry_no, ":entry", ":agent_no"),
                  # (try_begin),
                      # (eq, ":entry", 4),
                      # (agent_set_division,":agent_no", 5),
                  # (else_try),
                      # (eq, ":entry", 6),
                      # (agent_set_division,":agent_no", 6),
                  # (else_try),
                      # (eq, ":entry", 8),
                      # (agent_set_division,":agent_no", 7),
                  # (else_try),
                      # (eq, ":entry", 10),
                      # (agent_set_division,":agent_no", 8),
                  # (try_end),
                  (store_mod, ":division", ":agent_no", 4),
                  (val_add, ":division", 5),
                  (agent_set_division,":agent_no", ":division"),
                  # (assign, reg1, ":division"),
                  # (assign, reg2, ":agent_no"),
                  # (agent_get_troop_id, ":troop", ":agent_no"),
                  # (str_store_troop_name, s1, ":troop"),
                  # (display_message, "@{s1}: id {reg2}, division {reg1}"),
              (else_try),
                  (agent_get_entry_no, ":entry", ":agent_no"),
                  (try_begin),
                      (eq, ":entry", 5),
                      (agent_set_division,":agent_no", 0),
                  (else_try),
                      (eq, ":entry", 6),
                      (agent_set_division,":agent_no", 1),
                  (else_try),
                      (eq, ":entry", 7),
                      (agent_set_division,":agent_no", 2),
                  (else_try),
                      (eq, ":entry", 8),
                      (agent_set_division,":agent_no", 3),
                  (try_end),
              (try_end),
          (try_end),
      (try_end),

      (team_give_order, "$defender_team", 0, mordr_hold),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),
      (team_give_order, "$defender_team", 0, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 0, mordr_hold),
      (team_give_order, "$defender_team_2", 0, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 0, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 0, mordr_stand_closer),
      (entry_point_get_position, pos10, 16),
      (team_set_order_position, "$defender_team_2", 0, pos10),
      (team_set_order_position, "$defender_team", 0, pos10),

      (team_give_order, "$defender_team", 2, mordr_hold),
      (team_give_order, "$defender_team", 2, mordr_stand_closer),
      (team_give_order, "$defender_team", 2, mordr_stand_closer),
      (team_give_order, "$defender_team", 2, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 2, mordr_hold),
      (team_give_order, "$defender_team_2", 2, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 2, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 2, mordr_stand_closer),
      (entry_point_get_position, pos10, 17),
      (team_set_order_position, "$defender_team_2", 2, pos10),
      (team_set_order_position, "$defender_team", 2, pos10),

      (team_give_order, "$defender_team", 3, mordr_hold),
      (team_give_order, "$defender_team", 3, mordr_stand_closer),
      (team_give_order, "$defender_team", 3, mordr_stand_closer),
      (team_give_order, "$defender_team", 3, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 3, mordr_hold),
      (team_give_order, "$defender_team_2", 3, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 3, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 3, mordr_stand_closer),
      (entry_point_get_position, pos10, 18),
      (team_set_order_position, "$defender_team_2", 3, pos10),
      (team_set_order_position, "$defender_team", 3, pos10),

      (team_give_order, "$defender_team", 4, mordr_hold),
      (team_give_order, "$defender_team", 4, mordr_stand_closer),
      (team_give_order, "$defender_team", 4, mordr_stand_closer),
      (team_give_order, "$defender_team", 4, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 4, mordr_hold),
      (team_give_order, "$defender_team_2", 4, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 4, mordr_stand_closer),
      (team_give_order, "$defender_team_2", 4, mordr_stand_closer),
      (entry_point_get_position, pos10, 19),
      (team_set_order_position, "$defender_team_2", 4, pos10),
      (team_set_order_position, "$defender_team", 4, pos10),

      # have companions follow player
      (team_give_order, "$defender_team", sdt_bodyguard, mordr_follow),
      (team_give_order, "$defender_team_2", sdt_bodyguard, mordr_follow),

      (team_give_order, "$attacker_team", 5, mordr_hold),
      (team_give_order, "$attacker_team_2", 5, mordr_hold),
      (entry_point_get_position, pos10, 1),
      (team_set_order_position, "$attacker_team_2", 5, pos10),
      (team_set_order_position, "$attacker_team", 5, pos10),

      (team_give_order, "$attacker_team", 6, mordr_hold),
      (team_give_order, "$attacker_team_2", 6, mordr_hold),
      (entry_point_get_position, pos10, 2),
      (team_set_order_position, "$attacker_team_2", 6, pos10),
      (team_set_order_position, "$attacker_team", 6, pos10),

      (team_give_order, "$attacker_team", 7, mordr_hold),
      (team_give_order, "$attacker_team_2", 7, mordr_hold),
      (entry_point_get_position, pos10, 3),
      (team_set_order_position, "$attacker_team_2", 7, pos10),
      (team_set_order_position, "$attacker_team", 7, pos10),

      (team_give_order, "$attacker_team", 8, mordr_hold),
      (team_give_order, "$attacker_team_2", 8, mordr_hold),
      (entry_point_get_position, pos10, 4),
      (team_set_order_position, "$attacker_team_2", 8, pos10),
      (team_set_order_position, "$attacker_team", 8, pos10),

      (set_show_messages, 1),
    ],[]),
    (150, 0, 0, [],[##changed to 2 min, 30sec
      (try_for_agents,":cur_agent"),
          (agent_is_active, ":cur_agent"),
          (agent_is_alive, ":cur_agent"),
          (agent_is_human, ":cur_agent"),
          (agent_is_ally, ":cur_agent"),
          (agent_refill_ammo, ":cur_agent"),
      (try_end),
      (display_message, "@Defenders received ammunition supplies."),
    ]),
    common_battle_order_panel,
    common_battle_order_panel_tick,
] + utility_triggers + battle_panel_triggers + dplmc_battle_mode_triggers_no_deathcam + theoris_decapitation),

("wlods_advantures_3_sciri_battle", mtf_battle_mode,-1,
  "monasterio",[
    (0,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (1,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (2,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (3,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (4,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (5,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (6,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (7,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (8,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (9,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (10,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (11,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (12,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (13,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (14,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (15,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (16,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (17,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (18,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (19,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (20,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (21,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (22,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (23,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (24,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (25,mtef_visitor_source|mtef_team_0, 0,aif_start_alarmed,0,[]),
    (26,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (27,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (28,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (29,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (30,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (31,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (32,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (33,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (34,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (35,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (36,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (37,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (38,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (39,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (40,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (41,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (42,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (43,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (44,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
    (45,mtef_visitor_source|mtef_team_1, 0,aif_start_alarmed,0,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,
    (0, 0, ti_once, [],[# Let it burn
      (set_fixed_point_multiplier, 100),
      (assign, reg1, "psys_village_fire_big"),
      (assign, reg2, "psys_war_smoke_tall"),
      (assign, reg3, 0),
      (assign, ":counter", 0),
      (try_for_prop_instances, ":curr_instance", -1, somt_object),
          (lt, ":counter", 15),	#not more then 60 part sys, now 25 since people get performance issues
          (prop_instance_get_scene_prop_kind, ":scene_prop_kind", ":curr_instance"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_a"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_b"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_c"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_e"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_f"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_g"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_house_h"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_villa_new_a"),
          (this_or_next|eq, ":scene_prop_kind", "spr_village_stable_a"),
          (this_or_next|eq, ":scene_prop_kind", "spr_full_stable_a"),
          (this_or_next|eq, ":scene_prop_kind", "spr_roman_market_new"),
          (this_or_next|eq, ":scene_prop_kind", "spr_house_bebanburh"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_b_bathsevulus1_t3", "spr_b_romanwalls_t1"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_b_roof0_t1", "spr_b_wall0_t1"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_b_villasevulus0_t1", "spr_b_wall0_t1"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_Kolba_a", "spr_wall_a"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_long_house", "spr_arena_2"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_viking_house_a", "spr_harbour_a"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_fake_houses_steppe_a", "spr_destroy_heap"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_village_house_e", "spr_village_wall_a"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_town_house_steppe_a", "spr_carpet_a"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_earth_house_a", "spr_town_house_aa"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_village_house_a", "spr_crude_fence"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_full_stable_a", "spr_arabian_house_i"),
          (this_or_next|is_between, ":scene_prop_kind", "spr_arabian_house_a2", "spr_arabian_village_stairs"),
          (is_between, ":scene_prop_kind", "spr_house_saxon", "spr_tree_log_half"),
          (shuffle_range, 1, 4),
          (neq, reg1, 0),
          (val_add, ":counter", 1),
          (try_for_range, ":unused", 0, 4),
            (store_random_in_range, ":rand23", -150, 150),
            (position_set_x, pos1, ":rand23"),
            (store_random_in_range, ":rand23", -150, 150),
            (position_set_y, pos1, ":rand23"),
            (store_random_in_range, ":rand23", 50, 150),
            (position_set_z, pos1, ":rand23"),
            (prop_instance_add_particle_system, ":curr_instance", reg1, pos1),
            (eq, reg1, "psys_village_fire_big"),
            (position_move_z, pos1, 100),
            (prop_instance_add_particle_system, ":curr_instance", "psys_village_fire_smoke_big", pos1),
            #(prop_instance_play_sound, ":curr_instance", "snd_fire", sf_looping),
          (try_end),
      (try_end),
    ]),

    improved_lightning,
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent"),
      (agent_is_human, ":agent"),
      (agent_is_ally, ":agent"),
      (agent_get_troop_id, ":troop", ":agent"),
      (neq, ":troop", "trp_player"),
      (try_begin),
          (troop_is_hero, ":troop"),
          (agent_set_damage_modifier,  ":agent", 250),
          (agent_set_accuracy_modifier,  ":agent", 500),
      (else_try),
          (agent_set_damage_modifier,  ":agent", 150),
          (agent_set_accuracy_modifier,  ":agent", 500),
      (try_end),
    ]),
    (ti_before_mission_start, 0, 0, [],[
        (scene_set_day_time, 3),
    ]),
    common_inventory_not_available,
    common_battle_init_banner,
    wounds_vc,
    dedal_shield_bash,
    dedal_shield_bash_AI,

    (ti_after_mission_start, 0, 0, [],[(call_script, "script_music_set_situation_with_culture", mtf_sit_fight)]),

    (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")],[]),

    (1, 10, ti_once, [
    ],[
      (tutorial_box, "@Objetive: Defeat all enemies and rescue Mathildiz otherwise she will not survive battle!^^(Hint: Go towards Hludwig's house and press F at the door.)"),
    ]),

    (1, 10, ti_once, [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le,1)
    ],[
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "$temp2"),
      (else_try),
        (jump_to_menu, "$temp1"),
      (try_end),
      (stop_all_sounds, 1),
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      (finish_mission, 4),
    ]),
] + utility_triggers + battle_panel_triggers + theoris_decapitation + dplmc_battle_mode_triggers_no_deathcam),


("desert_cutscene",mtf_battle_mode,-1,
  "plundering a settlement",[
    (0,mtef_visitor_source,0,0,1,[]),#player
    (1,mtef_visitor_source,af_override_horse,0,1,[]),#player
    (2,mtef_visitor_source,0,0,1,[]),#guard
    (3,mtef_visitor_source,0,0,1,[]),#legatus
    (4,mtef_visitor_source,0,0,1,[]),#legatus

    (5,mtef_visitor_source,0,0,1,[]),#unused
    (6,mtef_visitor_source,0,0,1,[]),#unused
    (7,mtef_visitor_source,0,0,1,[]),#unused
    (8,mtef_visitor_source,0,0,1,[]),#spectators
    (9,mtef_visitor_source,0,0,1,[]),#spectators
    (10,mtef_visitor_source,0,0,1,[]),#spectators
    (11,mtef_visitor_source,0,0,1,[]),#spectators
    (12,mtef_visitor_source,0,0,1,[]),#spectators
    (13,mtef_visitor_source,0,0,1,[]),#spectators
    (14,mtef_visitor_source,0,0,1,[]),#spectators
    (15,mtef_visitor_source,0,0,1,[]),#spectators
    (16,mtef_visitor_source,0,0,1,[]),#spectators
    (17,mtef_visitor_source,0,0,1,[]),#spectators
    (18,mtef_visitor_source,0,0,1,[]),#spectators
    (19,mtef_visitor_source,0,0,1,[]),#spectators
    (20,mtef_visitor_source,0,0,1,[]),#spectators
    (21,mtef_visitor_source,0,0,1,[]),#spectators
    (22,mtef_visitor_source,0,0,1,[]),#spectators
    (23,mtef_visitor_source,0,0,1,[]),#spectators
    (24,mtef_visitor_source,0,0,1,[]),#spectators
    (25,mtef_visitor_source,0,0,1,[]),#spectators
    (26,mtef_visitor_source,0,0,1,[]),#spectators
    (27,mtef_visitor_source,0,0,1,[]),#spectators
    (28,mtef_visitor_source,0,0,1,[]),#spectators
    (29,mtef_visitor_source,0,0,1,[]),#spectators
    (30,mtef_visitor_source,0,0,1,[]),#spectators
  ],p_wetter + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    (ti_before_mission_start, 0, 0, [],
    [
      (scene_set_day_time, 19),
      (set_global_cloud_amount, 0),
    ]),
    (ti_tab_pressed,0,0,[],[
      (show_object_details_overlay, 1),
      (jump_to_menu, "$g_next_menu"),
      (finish_mission),
    ]),
    (ti_after_mission_start,0,0,[],[
      (show_object_details_overlay, 0),
    ]),
    #debug code
    # (1,0,ti_once,[
    # (store_mission_timer_a, ":time"),
    # (ge, ":time", 2),
    # ],[

    # (try_for_agents, ":agent"),
        # (agent_is_active, ":agent"),
        # (agent_is_alive, ":agent"),
        # (agent_is_human, ":agent"),
        # (agent_get_troop_id, ":troop", ":agent"),
        # (str_store_troop_name, s1,":troop"),
        # (display_message, "@{s1}"),
    # (try_end),
    # ]),
    (0, 0, ti_once,[],[
      (try_begin),
          (store_current_scene, ":scene"),
          (eq, ":scene", "scn_scene_camp_desert"),
          (play_track, "track_cutscene_2_track",2),
      (else_try),
          (eq, ":scene", "scn_cutscene_parthia"),
          (play_track, "track_cutscene_3_track",2),
      (else_try),
          (eq, ":scene", "scn_cutscene_steppe"),
          (play_track, "track_cutscene_6_track",2),
      (else_try),
          (eq, ":scene", "scn_scene_camp_forest"),
          (play_track, "track_cutscene_5_track",2),
      (try_end),
      #spawn a standard bearer and ranks of soldiers
      (set_fixed_point_multiplier, 100),
      (init_position, pos1),
      (entry_point_get_position, pos1, 20),

      (try_for_range, ":unused", 0, 7), #ranks
        (try_for_range, ":unused2", 0, 3), #columns
          (set_spawn_position, pos1),
          (try_begin),
            (eq, ":unused", 0),
            (try_begin),
              (eq, ":unused2", 0),
              (troop_get_slot, ":troop_to_spawn", "trp_temp_array_a", 1),
              (spawn_agent, ":troop_to_spawn"),
              (assign, ":cur_agent", reg0),
            (else_try),
              (eq, ":unused2", 1),
              (troop_get_slot, ":troop_to_spawn", "trp_temp_array_a", 2),
              (spawn_agent, ":troop_to_spawn"),
              (assign, ":cur_agent", reg0),
            (else_try),
              (eq, ":unused2", 2),
              (troop_get_slot, ":troop_to_spawn", "trp_temp_array_a", 3),
              (spawn_agent, ":troop_to_spawn"),
              (assign, ":cur_agent", reg0),
            (try_end),
            (agent_get_horse, ":horse", ":cur_agent"),
            (try_begin),
              (neg|agent_is_active, ":horse"),
              (agent_set_speed_modifier,":cur_agent", 500),
              (agent_set_speed_limit, ":cur_agent", 9),
            (else_try),
              (agent_set_speed_modifier,":cur_agent", 500),
              (agent_set_horse_speed_factor, ":cur_agent", 500),
              (agent_set_speed_limit, ":cur_agent", 19),
            (try_end),
          (else_try),
            (eq, ":unused", 1),
            (try_begin),
              (eq, ":unused2", 0),
              (troop_get_slot, ":troop_to_spawn", "trp_temp_array_a", 4),
              (spawn_agent, ":troop_to_spawn"),
              (assign, ":cur_agent", reg0),
            (else_try),
              (eq, ":unused2", 1),
              (troop_get_slot, ":troop_to_spawn", "trp_temp_array_a", 5),
              (spawn_agent, ":troop_to_spawn"),
              (assign, ":cur_agent", reg0),
            (else_try),
              (eq, ":unused2", 2),
              (troop_get_slot, ":troop_to_spawn", "trp_temp_array_a", 7),
              (spawn_agent, ":troop_to_spawn"),
              (assign, ":cur_agent", reg0),
            (try_end),
            (agent_get_horse, ":horse", ":cur_agent"),
            (try_begin),
              (neg|agent_is_active, ":horse"),
              (agent_set_speed_modifier,":cur_agent", 500),
              (agent_set_speed_limit, ":cur_agent", 9),
            (else_try),
              (agent_set_speed_modifier,":cur_agent", 500),
              (agent_set_horse_speed_factor, ":cur_agent", 500),
              (agent_set_speed_limit, ":cur_agent", 19),
            (try_end),
          (else_try),
            (troop_get_slot, ":troop_to_spawn", "trp_temp_array_a", 6),
            (spawn_agent, ":troop_to_spawn"),
            (assign, ":cur_agent", reg0),
            (agent_get_horse, ":horse", ":cur_agent"),
            (try_begin),
              (neg|agent_is_active, ":horse"),
              (agent_set_speed_modifier,":cur_agent", 500),
              (agent_set_speed_limit, ":cur_agent", 9),
            (else_try),
              (agent_set_speed_modifier,":cur_agent", 500),
              (agent_set_horse_speed_factor, ":cur_agent", 500),
              (agent_set_speed_limit, ":cur_agent", 19),
            (try_end),
          (try_end),
          (position_move_x, pos1, 250), #2.5m between columns
        (try_end),
        # get back to first column of previous rank
        (position_move_x, pos1, -1000), #4x2.5m
        (position_move_y, pos1, -250), #next rank 2.5m behind
      (try_end),
    ]),

    deactivate_player_agent,

    (0,0,0,[],[
      (store_mission_timer_a, ":cur_time"),
      (set_fixed_point_multiplier, 100),
      (try_begin),
          (eq, "$tutorial_state", 5),
          (ge, ":cur_time", 71),
          (jump_to_menu, "$g_next_menu"),
          (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
          (show_object_details_overlay,1),
          (finish_mission, 3),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 68),
          (eq, "$tutorial_state", 4),
          (set_fixed_point_multiplier, 1000),
          (entry_point_get_position, pos9, 30),
          (mission_cam_animate_to_position, pos9, 6000, 0),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 45),
          (eq, "$tutorial_state", 3),
          (set_fixed_point_multiplier, 1000),
          (entry_point_get_position, pos9, 29),
          (mission_cam_animate_to_position, pos9, 25000, 0),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 23),
          (eq, "$tutorial_state", 2),
          (entry_point_get_position, pos9, 28),
          (mission_cam_animate_to_position, pos9, 25000, 0),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 1),
          (eq, "$tutorial_state", 1),
          (entry_point_get_position, pos9, 27),
          (mission_cam_animate_to_position, pos9, 25000, 0),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (eq, "$tutorial_state", 0),
          (set_fixed_point_multiplier, 1000),
          # march the troops down the bridge
          (entry_point_get_position, pos1, 25),
          (try_for_agents, ":agent_no"), # find everyone and march them off
              (agent_get_troop_id, ":agent_troop", ":agent_no"),
              (this_or_next|troop_slot_eq, "trp_temp_array_a", 1, ":agent_troop"),
              (this_or_next|troop_slot_eq, "trp_temp_array_a", 2, ":agent_troop"),
              (this_or_next|troop_slot_eq, "trp_temp_array_a", 3, ":agent_troop"),
              (this_or_next|troop_slot_eq, "trp_temp_array_a", 4, ":agent_troop"),
              (this_or_next|troop_slot_eq, "trp_temp_array_a", 5, ":agent_troop"),
              (this_or_next|troop_slot_eq, "trp_temp_array_a", 6, ":agent_troop"),
              (troop_slot_eq, "trp_temp_array_a", 7, ":agent_troop"),
              (store_random_in_range, ":r", 0, 1000),
              (val_mul, ":r", -1),
              (position_move_x, pos1, ":r"), # correction for angle numerical loss
              (val_mul, ":r", -1),
              (position_move_y, pos1, ":r"),
              (agent_set_scripted_destination, ":agent_no", pos1, 1),
              (entry_point_get_position, pos1, 25),
          (try_end),
          (call_script, "script_save_cam_first_person_mode"),
          (mission_cam_set_mode, 1, 0, 0),
          (set_camera_in_first_person, 0),
          (init_position, pos10),
          (entry_point_get_position, pos10, 26),
          (mission_cam_set_position, pos10),
          (val_add, "$tutorial_state", 1),
      (try_end),
    ]),
    common_inventory_not_available,
]),

("langobard_battle",mtf_battle_mode,-1,
    "plundering a settlement",
    [(0,mtef_visitor_source,0,0,1,[]),#player
    (1,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),#
    (2,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),#
    (3,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),#
    (4,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),#
    (5,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),#
    (6,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),#
    (7,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),#
    (8,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),#
    (9,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),#
    (10,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),#
    (11,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),#
    (12,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),#
    (13,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),#
    (14,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),#
    (15,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),#
    (16,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),#
    (17,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),#
    (18,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),#
    (19,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),#
    (20,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),#
    (21,mtef_visitor_source,0,0,1,[]),#
    (22,mtef_visitor_source,0,0,1,[]),#
    (23,mtef_visitor_source,0,0,1,[]),#
    (24,mtef_visitor_source,0,0,1,[]),#
    (25,mtef_visitor_source,0,0,1,[]),#
    (26,mtef_visitor_source,0,0,1,[]),#
    (27,mtef_visitor_source,0,0,1,[]),#
    (28,mtef_visitor_source,0,0,1,[]),#
    (29,mtef_visitor_source,0,0,1,[]),#
    (30,mtef_visitor_source,0,0,1,[]),
    ],p_wetter + global_common_triggers +
    [
    improved_lightning,
    cannot_spawn_commoners,
    (ti_before_mission_start, 0, 0, [
			 ],
    [
    (assign, "$tutorial_state", 0),
    (scene_set_day_time, 9),
    (set_global_cloud_amount, 0),]),

      (4,0,ti_once,[
    (main_hero_fallen),
      ],
		[
      (stop_all_sounds),
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      (finish_mission,4),

      (jump_to_menu, "mnu_langobard_defeat"),
		]),

    (ti_tab_pressed,0,0,[],[
    (display_message, "str_cannot_leave_now"),
    # (jump_to_menu, "mnu_auto_return_map"),
    # (finish_mission),
    ]),

    (0, 0, ti_once,
       [],[
    (team_set_relation, 0, 1, -1),
    (team_set_relation, 1, 0, -1),
    (play_track, "track_cutscene_4_track",2),
	   ]),

    (1, 1, 1,[
      (quest_slot_eq, "qst_langobard_arrive", slot_quest_current_state, 3),
      (num_active_teams_le, 1),
      (neg|main_hero_fallen),
    ],[
      (store_current_scene, ":cur_scene"),
      (modify_visitors_at_site, ":cur_scene"),
      (try_for_range, ":entry", 12, 21),
          (store_random_in_range, ":warriors", "trp_lombard_skirmisher", "trp_slavic_skirmisher"),
          (add_visitors_to_current_scene, ":entry", ":warriors", 10),
      (try_end),
    ]),

    (0,0,0,[],
    [
    (store_mission_timer_a, ":cur_time"),
    (set_fixed_point_multiplier, 100),
    (try_begin),
        (ge, ":cur_time", 52),
        (eq, "$tutorial_state", 4),
        (val_add, "$tutorial_state", 1), #
        (start_mission_conversation, "trp_kingdom_13_lord"),
    (else_try),
        (ge, ":cur_time", 50),
        (eq, "$tutorial_state", 3),
        (call_script, "script_return_to_cam_first_person_mode_1_sec"),
        (val_add, "$tutorial_state", 1),
        (tutorial_message_set_size, 23, 23),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, -1),
        (try_for_agents, ":agent"),
            (agent_is_active, ":agent"),
            (agent_is_alive, ":agent"),
            (agent_is_human, ":agent"),
            (agent_get_troop_id, ":agent_troop", ":agent"),
            (call_script, "script_cf_troop_is_hornman", ":agent_troop"),
            (call_script, "script_agent_perform_horn", ":agent"),
        (try_end),
        (try_for_agents, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_is_human, ":agent"),
          (store_random_in_range, ":r", 0, 2),
          (try_begin),
            (eq, ":r", 0),
            (call_script,"script_agent_perform_warcry", ":agent"),
          (else_try),
            (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
            (call_script,"script_agent_perform_shield_taunt", ":agent"),
          (try_end),
        (try_end),
    (else_try),
        (ge, ":cur_time", 25),
        (eq, "$tutorial_state", 2),
        (entry_point_get_position, pos9, 23),
        (mission_cam_animate_to_position, pos9, 20000, 0),
        (val_add, "$tutorial_state", 1),
        (tutorial_message_set_size, 22, 22),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@We will defeat those beastmen, who came from Scandia to steal our land, our cattle and our wives! Get in formation! Ready your shield and spear! Battle is near!"),
        (try_for_agents, ":agent"),
            (agent_is_active, ":agent"),
            (agent_is_alive, ":agent"),
            (agent_is_human, ":agent"),
            (agent_get_troop_id, ":agent_troop", ":agent"),
            (call_script, "script_cf_troop_is_hornman", ":agent_troop"),
            (call_script, "script_agent_perform_horn", ":agent"),
        (try_end),
        (try_for_agents, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_is_human, ":agent"),
          (store_random_in_range, ":r", 0, 2),
          (try_begin),
            (eq, ":r", 0),
            (call_script,"script_agent_perform_warcry", ":agent"),
          (else_try),
            (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
            (call_script,"script_agent_perform_shield_taunt", ":agent"),
          (try_end),
        (try_end),
    (else_try),
        (ge, ":cur_time", 2),
        (eq, "$tutorial_state", 1),
        (entry_point_get_position, pos9, 22),
        (mission_cam_animate_to_position, pos9, 25000, 0),
        (val_add, "$tutorial_state", 1),
        (tutorial_message_set_size, 22, 22),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@Warriors! Today the day of battle has finally come! The bards will sing about this day even after centuries have past! Whoever fights today will be famous, will be a legend!^Warrios, our enemies are more beasts than human. They are from Scandia! And as we all know Scandia is inhabited by beastmen."),
        (try_for_agents, ":agent"),
            (agent_is_active, ":agent"),
            (agent_is_alive, ":agent"),
            (agent_is_human, ":agent"),
            (agent_get_troop_id, ":agent_troop", ":agent"),
            (call_script, "script_cf_troop_is_hornman", ":agent_troop"),
            (call_script, "script_agent_perform_horn", ":agent"),
        (try_end),
        (try_for_agents, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_is_human, ":agent"),
          (store_random_in_range, ":r", 0, 2),
          (try_begin),
            (eq, ":r", 0),
            (call_script,"script_agent_perform_warcry", ":agent"),
          (else_try),
            (agent_play_sound, ":agent", "snd_inmersive_troops_cv"),
            (call_script,"script_agent_perform_shield_taunt", ":agent"),
          (try_end),
        (try_end),
    (else_try),
        (eq, "$tutorial_state", 0),
        (call_script, "script_save_cam_first_person_mode"),
        (mission_cam_set_mode, 1, 0, 0),
        (set_camera_in_first_person, 0),
        (init_position, pos10),
        (entry_point_get_position, pos10, 21),
        (mission_cam_set_position, pos10),
        (val_add, "$tutorial_state", 1),
        (try_for_agents, ":agent"),
            (agent_is_active, ":agent"),
            (agent_is_alive, ":agent"),
            (agent_is_human, ":agent"),
            (agent_is_non_player, ":agent"),
            (try_for_range, ":slot", 0, 4),
                (agent_get_item_slot,":item_no", ":agent", ":slot"),
                (gt, ":item_no", -1),
                (agent_set_wielded_item, ":agent", ":item_no"),
            (try_end),
            (agent_get_entry_no, ":entry", ":agent"),
            (try_begin),
                (eq, ":entry", 3),
                (assign, "$temp1", ":agent"),
                (agent_get_troop_id, "$temp2", ":agent"),
            (try_end),
        (try_end),
    (try_end),
      ]),
    add_horn_hornman,
    #wounds_vc,
    common_inventory_not_available,]
    + theoris_decapitation
    + dplmc_battle_mode_triggers
),

("island_cythnus",mtf_battle_mode,-1,"dungeon",[
    (0,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (1,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (2,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (3,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (4,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (5,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (6,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (7,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (8,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (9,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (10,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (11,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    common_maritime_drowning,
    (1, 0, 0,[
      (neg|conversation_screen_is_active),
      (eq, "$temp", 0),
    ],[
      (try_for_agents, ":agent_no"),
        (eq, "$temp", 0),
        (agent_is_active, ":agent_no"),
        (agent_is_alive, ":agent_no"),
        (agent_is_human, ":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (eq, ":troop_no", "trp_sussus_amogus"),
        (init_position, pos10),
        (init_position, pos11),
        (get_player_agent_no, ":player_agent"),
        (agent_get_position, pos10, ":player_agent"),
        (agent_get_position, pos11, ":agent_no"),
        (set_fixed_point_multiplier, 1),
        (get_distance_between_positions_in_meters, ":dist", pos10, pos11),
        (le, ":dist", 20),
        (mission_enable_talk),
        (start_mission_conversation, "trp_sussus_amogus"),
        (assign, "$temp", 1),
      (try_end),
    ]),

    improved_lightning,
    cannot_spawn_commoners,
    # (5, 0, 0, [],[
    #   (try_for_agents, ":agent_no"),
    #     (agent_is_human, ":agent_no"),
    #     (agent_is_alive, ":agent_no"),
    #     (agent_ai_set_always_attack_in_melee, ":agent_no", 1),
    #     (neg|agent_is_non_player, ":agent_no"),
    #     (call_script, "script_advanced_agent_set_speed_modifier", ":agent_no", 1000),
    #   (try_end),
    # ]),

    (ti_before_mission_start, 0, 0, [],[
      (assign,"$g_battle_result",0),
      (team_set_relation, 0, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
      (team_set_relation,1,2,0),
      (team_set_relation,0,1,0),
    ]),
    ###companion support in some events
    (ti_after_mission_start, 0, ti_once, [],[
      #player companions
      (assign, ":companions_count", 0),
      (party_get_num_companion_stacks, ":num_of_stacks", "p_main_party"),
      (try_for_range, ":i", 0, ":num_of_stacks"),
        (party_stack_get_troop_id, ":troop_id", "p_main_party", ":i"),
        (neq, ":troop_id", "trp_player"),
        (is_between,":troop_id",companions_begin,companions_end),
        (neg|troop_is_wounded, ":troop_id"),
        (val_add, ":companions_count", 1),
        (assign, ":entry_point", 11), # 1 near player

        (store_current_scene, ":cur_scene"),
        (modify_visitors_at_site, ":cur_scene"),
        (add_visitors_to_current_scene, ":entry_point", ":troop_id", 1),

        (eq, ":companions_count", 20), #20 companions max with player
        (assign, ":num_of_stacks", 0),
      (try_end),
      (mission_disable_talk),
    ]),
    (ti_on_agent_spawn, 0, 0, [],[
      (store_trigger_param_1, ":agent"),
      (agent_get_troop_id, ":troop", ":agent"),
      (neq, ":troop", "trp_player"),

      (try_begin),
        (neg|troop_is_hero, ":troop"),
        (agent_set_team, ":agent", 7),
      (else_try),
        (main_party_has_troop, ":troop"),

        (get_player_agent_no, ":player"),
        (agent_get_team, ":playerteam", ":player"),
        (agent_set_team, ":agent", ":playerteam"),
        (agent_set_division, ":agent", 8),
        (agent_add_relation_with_agent, ":agent", ":player", 1),
        (agent_set_is_alarmed, ":agent", 1),
      (try_end),
    ]),
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent"),
      (agent_get_troop_id, ":troop", ":dead_agent"),
      (neq, ":troop", "trp_player"),
      (troop_is_hero, ":troop"),
      (main_party_has_troop, ":troop"),
      (party_wound_members, "p_main_party", ":troop", 1),
    ]),
    ##companion support END
    wounds_vc,
    #############
    (0, 0, ti_once,[
      (assign, "$attacker_team", 0),
      (assign, "$defender_team", 1),
      (assign, "$defender_team_2", 2),
      (set_cheer_at_no_enemy, 0),
    ],[]),
    (3, 0, ti_once,[
      (set_show_messages, 0),
      (team_give_order, "$attacker_team", grc_everyone, mordr_follow),
      (team_give_order, "$defender_team_2", grc_everyone, mordr_stand_closer),
      (team_give_order, "$defender_team_2", grc_everyone, mordr_stand_closer),
      (team_give_order, "$defender_team_2", grc_everyone, mordr_stand_closer),
      (team_give_order, "$defender_team_2", grc_everyone, mordr_stand_ground),
      (team_give_order, "$defender_team", grc_everyone, mordr_stand_closer),
      (team_give_order, "$defender_team", grc_everyone, mordr_stand_closer),
      (team_give_order, "$defender_team", grc_everyone, mordr_stand_closer),
      (team_give_order, "$defender_team", grc_everyone, mordr_stand_ground),
      (set_show_messages, 1),
    ],[]),
    (5, 0, 0, [
      (store_skill_level,":player_sneaking_skill","skl_athletics","trp_player"),
      (assign,":sneak_distance",11000),
      (val_mul, ":player_sneaking_skill", 1000),
      (val_sub, ":sneak_distance", ":player_sneaking_skill"),
      (try_begin),
        (eq,":player_sneaking_skill",10),
        (assign,":sneak_distance",1500),
        # (else_try),
        # (eq,":player_sneaking_skill",9),
        # (assign,":sneak_distance",2000),
        # (else_try),
        # (eq,":player_sneaking_skill",8),
        # (assign,":sneak_distance",3000),
        # (else_try),
        # (eq,":player_sneaking_skill",7),
        # (assign,":sneak_distance",4000),
        # (else_try),
        # (eq,":player_sneaking_skill",6),
        # (assign,":sneak_distance",5000),
        # (else_try),
        # (eq,":player_sneaking_skill",5),
        # (assign,":sneak_distance",6000),
        # (else_try),
        # (eq,":player_sneaking_skill",4),
        # (assign,":sneak_distance",7000),
        # (else_try),
        # (eq,":player_sneaking_skill",3),
        # (assign,":sneak_distance",8000),
        # (else_try),
        # (eq,":player_sneaking_skill",2),
        # (assign,":sneak_distance",9000),
        # (else_try),
        # (eq,":player_sneaking_skill",1),
        # (assign,":sneak_distance",10000),
        # (else_try),
        # (assign,":sneak_distance",11000),
      (try_end),
      # (get_player_agent_no,":player_agent"),
      #(agent_get_position,pos1,":player_agent"),
      (assign,":continue",0),
      (try_for_agents, ":cur_agent"),
        (agent_get_troop_id, ":troop", ":cur_agent"),
        (try_begin),
          (agent_get_troop_id, ":troop", ":cur_agent"),
          (eq, ":troop", "trp_player"),
          (agent_get_position,pos1,":cur_agent"),
        (try_end),
        (neg|troop_is_hero, ":troop"),
        ##                 (agent_get_team, ":team", ":cur_agent"),
        ##		(eq, ":team", 2),
        (agent_get_position,pos2,":cur_agent"),
        (get_distance_between_positions,":distance",pos1,pos2),
        (lt,":distance",":sneak_distance"),
        (agent_set_team, ":cur_agent", 2),
        (assign,":continue",1),
      (try_end),
      (eq,":continue",1),
      (set_party_battle_mode),
    ],[]),
    (5, 3, ti_once,[
      (main_hero_fallen),
      (assign,"$g_battle_result",-1),
      (assign,"$g_encountered_party",-1),
      (call_script, "script_change_troop_renown", "trp_player", -5),
      (display_message, "@Pirates strike at you furiously, and you fall in a puddle of blood. They think you're dead...",color_bad_news),
      (store_troop_gold, ":gold", "trp_player"),
      (try_begin),
        (ge, ":gold", 500),
        (troop_remove_gold, "trp_player", 500),
      (else_try),
        (call_script, "script_change_troop_renown", "trp_player", -5),
      (try_end),
    ],[
      (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
      (finish_mission, 3),
    ]),
    #Victory normal
    ( 1, 1, ti_once,[
      (troop_slot_ge, "trp_global_variables",g_cythus_3,1),
      (all_enemies_defeated, 5),
      (neg|main_hero_fallen),
    ],[
      (assign, "$g_battle_result", 1),
      (assign,"$g_encountered_party",-1),
      (tutorial_message_set_background, 1),
      (tutorial_message,"@The pirates have been dealt with. Get the loot and leave.^^When you want to leave, press TAB."),
    ]),
    common_inventory_not_available,
    (ti_tab_pressed, 0, 0, [
      (set_trigger_result,1)
    ],[]),
    (0, 0, ti_once, [],[
      (call_script, "script_music_set_situation_with_culture", 0), #prison
    ]),
    #Premios
    (2, 0, ti_once, [
      (assign, ":continue", 0),
      (try_for_agents,":cur_agent"),
        (agent_get_troop_id,":cur_troop_id",":cur_agent"),
        (eq,":cur_troop_id","trp_brigand"),
        (neg|agent_is_alive,":cur_agent"),
        (assign, ":continue", 1),
      (try_end),
      (ge, ":continue", 1),
      (troop_slot_eq, "trp_global_variables",g_cythus_1,0),
    ],[
      (display_message,"@You have just killed the bodyguard of Sussus. Rummaging through his things, you find some treasures. You still need to defeat the other bandits before you can collect your reward.",color_good_news),
      (call_script, "script_change_player_honor", 1),
      (call_script, "script_troop_add_gold", "trp_player", 50),
      (troop_set_slot, "trp_global_variables",g_cythus_1,1),
    ]),
    (2, 0, ti_once, [
      (assign, ":continue", 0),
      (try_for_agents,":cur_agent"),
        (agent_get_troop_id,":cur_troop_id",":cur_agent"),
        (eq,":cur_troop_id","trp_bandit"),
        (neg|agent_is_alive,":cur_agent"),
        (assign, ":continue", 1),
      (try_end),
      (ge, ":continue", 1),
      (troop_slot_eq, "trp_global_variables",g_cythus_2,0),
    ],[
      (display_message,"@You have killed the captain, an ugly guy, big and crooked and smelling like a rat. Picking through the remains, you find a few useful things. You still need to defeat the other bandits before you can collect your reward.",color_good_news),
      (call_script, "script_change_player_honor", 5),
      (call_script, "script_troop_add_gold", "trp_player", 100),
      (troop_set_slot, "trp_global_variables",g_cythus_2,1),
    ]),
    (2, 0, ti_once, [
      (all_enemies_defeated, 5),
      (assign, ":continue", 0),
      (try_for_agents,":cur_agent"),
        (agent_get_troop_id,":cur_troop_id",":cur_agent"),
        (eq,":cur_troop_id","trp_sussus_amogus"),
        (neg|agent_is_alive,":cur_agent"),
        (assign, ":continue", 1),
      (try_end),
      (ge, ":continue", 1),
      (troop_slot_eq, "trp_global_variables",g_cythus_3,0),
    ],[
      (display_message,"@You killed the famous pirate Sussus Amogus. Rising victorious over his body, your steel stained with blood, you put an end to a long reign of terror and banditry with all its horrors. You loot:",color_good_news),
      (call_script, "script_change_player_honor", 15),
      (call_script, "script_change_troop_renown", "trp_player", 25),
      (call_script, "script_troop_add_gold", "trp_player", 1500),
      (troop_add_item, "trp_player","itm_old_gladius_1",0),
      (mission_disable_talk),
      (troop_set_slot, "trp_global_variables",g_cythus_3,1),
    ]),

    (0, 0, ti_once, [
      (tutorial_message_set_size, 15, 15),
      (tutorial_message_set_position, 500, 650), #650 for tutorial or mission msg, 450 for dialogs
      (tutorial_message_set_center_justify, 0),
    ],[]),

    (2,0,0,[
      (neg|conversation_screen_is_active),
      (neg|is_presentation_active, "prsnt_battle"),
      (store_mission_timer_a, ":cur_time"),
      (le, ":cur_time", 300),
    ],[
      (store_mission_timer_a, ":cur_time"),
      (try_begin),
        (ge, ":cur_time", 81),
        (tutorial_message, -1),
      (else_try),
        (ge, ":cur_time", 85),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@In the distance you spot some ruins. Be careful, as they are most likely also populated with bandits."),
      (else_try),
        (ge, ":cur_time", 56),
        (tutorial_message, -1),
      (else_try),
        (ge, ":cur_time", 50),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@There is a path you may follow. What treasures will you find?"),
      (else_try),
        (ge, ":cur_time", 12),
        (tutorial_message, -1),
      (else_try),
        (ge, ":cur_time", 6),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@It is said, the famous pirate Sussus Amogus has set up his camp on this island..."),
      (try_end),
    ]),
]),

("rags_to_riches",mtf_battle_mode,-1,#cueva odin chief mainquest #cueva de odin chief
    "dungeon",
    [
    (0,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
    (1,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (2,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (3,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (4,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (5,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (6,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (7,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (11,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (12,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (13,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (14,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (15,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (16,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (17,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (18,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (19,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (20,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (21,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (22,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (23,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (24,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (25,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (26,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (27,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (28,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (29,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (30,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (31,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (32,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (33,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (34,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (35,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (36,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (37,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (38,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (39,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (40,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (41,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (42,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (43,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (44,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (45,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (46,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    ], p_wetter + global_common_triggers +
    [
      cannot_spawn_commoners,
    (ti_before_mission_start, 0, 0, [],
        [
        (quest_set_slot, "qst_rags_to_riches", slot_quest_current_state, 4),
        (assign,"$g_battle_result",0),
        (team_set_relation, 0, 1, -1), # -1 for enemy, 1 for friend, 0 for neutral
        (mission_disable_talk),
      ]),

      ###companion support in some events
      (0, 0, ti_once, [(eq,"$g_battle_result",1),],  #after player has spawned
        [
        (start_mission_conversation, "trp_sittius"),
        (mission_enable_talk),
      ]),

      (0, 0, ti_once, [
        (eq,"$g_battle_result",0),
        (num_active_teams_le, 1),
      ],  #after player has spawned
        [
    (assign,"$g_battle_result",1),
      ]),

      (ti_on_agent_spawn, 0, 0, [],
        [
          (store_trigger_param_1, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (this_or_next|eq, ":troop", "trp_player"),
          (this_or_next|eq, ":troop", "trp_sittius"),
          (eq, ":troop", "trp_agrippina"),
          (agent_set_no_death_knock_down_only, ":agent", 1),
      ]),
    ##companion support END
      wounds_vc,

    ],
),

("visit_royal_tombs",mtf_battle_mode,-1,
    "plundering a settlement",
    [
      (0,mtef_visitor_source,af_override_horse,0,1,[]),
      (1,mtef_visitor_source,af_override_all,0,1,[itm_caligea,itm_roman_lupa_dress_2,itm_cloak_4]),
      (2,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
    ], p_wetter + storms + global_common_triggers +
    [
      cannot_spawn_commoners,
        improved_lightning,
        common_inventory_not_available,

        (0, 0, ti_once, [],
        [
            (mission_cam_set_screen_color, 0xFF000000),
            (mission_cam_animate_to_screen_color, 0x00000000, 2000),
        ]),

        (0, 0, ti_once, [
            (neg|conversation_screen_is_active),
            (get_player_agent_no, ":player_agent"),
            (agent_get_position, pos12, ":player_agent"),

            (entry_point_get_position, pos13, 1),
            (get_distance_between_positions_in_meters, ":distance", pos13, pos12),
            (le, ":distance", 4),
        ],
        [
            (mission_enable_talk),
            (start_mission_conversation, "trp_antonia"),
        ]),

        (ti_on_agent_spawn,1,0, [
        ],
        [
            (try_for_agents, ":agent"),
                (agent_is_alive, ":agent"),
                (agent_is_human, ":agent"),
                (agent_get_troop_id, ":troop", ":agent"),
                (eq, ":troop", "trp_antonia"),
                (agent_set_stand_animation, ":agent", "anim_vyrn_shieldmaiden_stand"),
                (agent_set_animation, ":agent", "anim_vyrn_shieldmaiden_stand"),
            (try_end),
        ]),

        (ti_tab_pressed, 0, 0, [],
        [
          (display_message, "str_cannot_leave_now"),
        ]),

        ambient_agent_play_sound,
        ambient_scene_play_loop,
        ambient_scene_play_random_sound,
        ambient_set_agents_for_sounds
    ]
),

("visit_tarquinii",mtf_battle_mode,-1,
    "plundering a settlement",
    [
      (0,mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
      (1,mtef_visitor_source,af_override_all,0,1,[itm_caligea,itm_roman_lupa_dress_2,itm_cloak_4]),
      (2,mtef_visitor_source,af_override_all,0,1,[itm_caligea,itm_roman_lupa_dress_2]),
    ], p_wetter + storms + global_common_triggers +
    [
      cannot_spawn_commoners,
        improved_lightning,
        common_inventory_not_available,

        (0, 0, ti_once, [],
        [
            (try_begin),
                (check_quest_active, "qst_blank_quest_19"),
                (quest_slot_eq,"qst_blank_quest_19", slot_quest_object_state, 1),
                (play_track, "track_cutscene_to_hades",2),
            (else_try),
                (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
            (try_end),

            (try_begin),
                (neg|quest_slot_eq, "qst_blank_quest_19", slot_quest_object_state, 2),
                (neg|quest_slot_eq, "qst_blank_quest_19", slot_quest_object_state, 3),
                (mission_enable_talk),
            (try_end),
            (mission_cam_set_screen_color, 0xFF000000),
            (mission_cam_animate_to_screen_color, 0x00000000, 2000),
        ]),

        (0, 0, ti_once, [
            (check_quest_active, "qst_blank_quest_19"),
            (this_or_next|quest_slot_eq, "qst_blank_quest_19", slot_quest_object_state, 2),
            (quest_slot_eq, "qst_blank_quest_19", slot_quest_object_state, 3),
            (store_mission_timer_a, ":timer"),
            (eq, ":timer", 3),
        ],
        [
            (mission_enable_talk),
            (start_mission_conversation, "trp_antonia"),
        ]),

        (ti_on_agent_spawn,1,0, [
            (this_or_next|quest_slot_eq, "qst_blank_quest_19", slot_quest_object_state, 2),
            (quest_slot_eq, "qst_blank_quest_19", slot_quest_object_state, 3),
        ],
        [
            (try_for_agents, ":agent"),
                (agent_is_alive, ":agent"),
                (agent_is_human, ":agent"),
                (agent_get_troop_id, ":troop", ":agent"),
                (eq, ":troop", "trp_antonia"),
                (agent_set_stand_animation, ":agent", "anim_vyrn_shieldmaiden_stand"),
                (agent_set_animation, ":agent", "anim_vyrn_shieldmaiden_stand"),
            (try_end),
        ]),

        (ti_tab_pressed, 0, 0, [],
        [
          (try_begin),
              (check_quest_active, "qst_blank_quest_19"),
              (this_or_next|quest_slot_eq, "qst_blank_quest_19", slot_quest_object_state, 1),
              (this_or_next|quest_slot_eq, "qst_blank_quest_19", slot_quest_object_state, 2),
              (quest_slot_eq, "qst_blank_quest_19", slot_quest_object_state, 3),
              (display_message, "str_cannot_leave_now"),
          (else_try),
              (stop_all_sounds, 1),
              (finish_mission,0),
          (try_end),
        ]),

        ambient_agent_play_sound,
        ambient_scene_play_loop,
        ambient_scene_play_random_sound,
        ambient_set_agents_for_sounds
    ]
),

("roman_story_player_tent", mtf_battle_mode, -1,
  "Test.",[
    (0,mtef_visitor_source,af_override_everything,0,1,[itm_caligea,itm_roman_poor2]),
    (1,mtef_visitor_source,af_override_weapons,0,1,[]),
    (2,mtef_visitor_source,af_override_everything,0,1,[itm_caligea,itm_roman_poor2]),
    (3,mtef_visitor_source,af_override_everything,0,1,[itm_caligea,itm_roman_lupa_dress_2,itm_cloak_4]),
    (4,mtef_visitor_source,af_override_everything,0,1,[itm_caligea,itm_roman_poor2]),
    (5,mtef_visitor_source,af_override_everything,0,1,[itm_caligea,itm_roman_lupa_dress_2]),
    (6,mtef_visitor_source,af_override_everything,0,1,[itm_caligea,itm_roman_poor2]),
  ], p_wetter + storms + global_common_triggers +
  [
    cannot_spawn_commoners,
    improved_lightning,
    (ti_before_mission_start, 0, 0, [],[
      (set_rain, 1,0),
      (set_rain, 2,0),
      (set_rain, 0, 100),
      (scene_set_day_time, 10),
      (mission_disable_talk),
    ]),
    (0, 0, ti_once,[
      (eq, "$temp", 0),
      (store_mission_timer_a, ":cur_time"),
      (ge, ":cur_time", 2),
      (gt, "$temp1", 0),
    ],[
      (mission_enable_talk),
      (start_mission_conversation, "$temp1"),
    ]),
    (0, 0, ti_once,[
      (eq, "$temp", 6),
      (store_mission_timer_a, ":cur_time"),
      (ge, ":cur_time", 4),
    ],[
      (mission_enable_talk),
      (start_mission_conversation, "trp_antonia"),
    ]),
    (0, 0, ti_once,[],[
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00000000, 2000),
    ]),
    (0,0,ti_once, [],[
      (try_for_agents, ":agent_no"),
          (agent_is_active, ":agent_no"),
          (agent_get_troop_id, ":troop_no", ":agent_no"),
          (call_script, "script_advanced_agent_set_speed_modifier", ":agent_no", 0),
          (agent_set_no_death_knock_down_only, ":agent_no", 1),
          (try_begin),
              (gt, "$temp", 0),
              (agent_set_no_dynamics, ":agent_no", 1),

              (agent_get_position, pos12, ":agent_no"),
              (position_move_z, pos12, -70),
              (agent_set_position, ":agent_no", pos12),

              (agent_set_stand_animation, ":agent_no", "anim_dedal_sitting_2"),
              (agent_set_animation, ":agent_no", "anim_dedal_sitting_2"),
              (store_random_in_range, ":random_no", 0, 100),
              (agent_set_animation_progress, ":agent_no", ":random_no"),
          (else_try),
              (eq, "$temp", 0),
              (eq, ":troop_no", "trp_antonia"),
              (agent_set_visibility, ":agent_no", 0),
              (agent_set_stand_animation, ":agent_no", "anim_vyrn_shieldmaiden_stand"),
              (agent_set_animation, ":agent_no", "anim_vyrn_shieldmaiden_stand"),
              (store_random_in_range, ":random_no", 0, 100),
              (agent_set_animation_progress, ":agent_no", ":random_no"),
          (try_end),
      (try_end),
    ]),
    (0, 0, 3.5, [],[
      (try_begin),
          (eq, "$temp", 1),
          (assign, "$temp", 2),
          (try_for_agents, ":agent_no"),
              (agent_is_active, ":agent_no"),
              (agent_get_troop_id, ":troop_no", ":agent_no"),
              (eq, "$temp1", ":troop_no"),
              (agent_fade_out, ":agent_no"),
          (try_end),
      (else_try),
          (eq, "$temp", 2),
          (try_for_agents, ":agent_no"),
              (agent_is_active, ":agent_no"),
              (agent_get_troop_id, ":troop_no", ":agent_no"),
              (eq, ":troop_no", "trp_antonia"),
              (agent_set_visibility, ":agent_no", 1),
          (try_end),
          (mission_cam_animate_to_screen_color, 0x00000000, 3500),
          (assign, "$temp", 3),
      (else_try),
          (eq, "$temp", 3),
          (mission_enable_talk),
          (start_mission_conversation, "trp_antonia"),
          (assign, "$temp", 4),
      (try_end),
    ]),
    common_inventory_not_available,
    (ti_tab_pressed, 0, 0,[],[
      (display_message, "str_cannot_leave_now"),
    ]),
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("explore_kurgan", 0, -1,
  "Test.",[
    (0,mtef_visitor_source,af_override_horse,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
  ], global_common_triggers +
  [
    cannot_spawn_commoners,

    # add some facial animations by changing the face key
    (0, 0, 0,[
      (try_begin),
        (eq, "$temp2", 1),
        (call_script, "script_change_agent_face", "$temp3", "trp_zarinaia", "str_zarinaia_face_normal"),
        # (display_message, "@normal"),
        (assign, "$temp2", 0),
      (else_try),
        (eq, "$temp2", 2),
        (call_script, "script_change_agent_face", "$temp3", "trp_zarinaia", "str_zarinaia_face_surprized"),
        # (display_message, "@surprized"),
        (assign, "$temp2", 0),
      (try_end),
    ],[]),


    (0, 0, 0,[(key_clicked, key_k),
      (tutorial_message, -1),
    ],[]),
	  (1,0,ti_once,[
      (neg|conversation_screen_is_active),
    ],[
      (tutorial_message_set_size, 19, 19),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "@The air is stale. The tomb has not been accessed for hundreds of years. You are hardly able to breathe.^^(press K to finish read)"),
		]),

    (0, 0, ti_once, [],[
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x4D000000, 3000),#black

      (scene_set_slot, "scn_kurgan_enter", slot_scene_visited, 1),
    ]),

    (ti_tab_pressed, 0, 0,[],[
      (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
      (finish_mission, 3),
    ]),

    (0, 0, ti_once,[],[
      (try_for_agents, ":agent_no"),
        (agent_is_active, ":agent_no"),
        (agent_get_troop_id, ":troop_no", ":agent_no"),
        (eq, ":troop_no", "trp_zarinaia"),
        (agent_ai_set_interact_with_player, ":agent_no", 0),
        (agent_set_no_dynamics, ":agent_no"),
        (agent_set_stand_animation, ":agent_no", "anim_stand_still"),
        (assign, "$temp3", ":agent_no"),
      (try_end),
    ]),

    common_inventory_not_available,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    ambient_scene_play_loop,
    ambient_scene_play_random_sound,
]),

("baths", 0, -1,
  "Test.",[
    (0,mtef_visitor_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
    (1,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (2,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (3,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (4,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (5,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (6,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (7,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (8,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (9,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (10,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (11,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (12,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (13,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (14,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (15,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (16,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (17,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (18,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (19,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (20,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (21,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (22,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (23,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (24,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (25,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (26,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (27,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (28,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
    (29,mtef_visitor_source|mtef_team_0,af_castle_lord,0,1,[]),
  ], global_common_triggers +
  [
    (0, 0, ti_once, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_thermae),
    ]),
    (0, 0, ti_once, [],[
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00000000, 2000),
    ]),
    (ti_tab_pressed, 0, 0,[
    ],[
      (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
      (finish_mission, 3),
    ]),
    (ti_inventory_key_pressed, 0, 0, [],[
      (try_begin),
        (neg|troop_slot_eq, "trp_global_variables", g_toilet_talk, -5),
        (neg|troop_slot_eq, "trp_global_variables", g_toilet_talk, -6),
        (set_trigger_result, 1),
      (else_try),
        (display_message, "str_cant_use_inventory_now"),
      (try_end),
    ]),
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("toiletboys", 0, -1,
  "Test.",[
    (0,mtef_visitor_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
    (1,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (2,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (3,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (4,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (5,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (6,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (7,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
    (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
  ], global_common_triggers +
  [
    (0, 0, ti_once, [],[
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00000000, 2000),
    ]),

    (0, 0, ti_once, [
      (main_hero_fallen),
    ],[
      (try_begin),
        (troop_slot_eq, "trp_global_variables", g_toilet_talk, -6),
        (jump_to_menu, "mnu_toilet_brothel_defeat"),
      (else_try),
        (troop_slot_eq, "trp_global_variables", g_toilet_talk, -5),
        (jump_to_menu, "mnu_toilet_tavern_escape"),
      (try_end),
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00000000, 2000),
      (finish_mission, 3),
    ]),

    (ti_tab_pressed, 0, 0,[
    ],[
      (try_begin),
        (neg|troop_slot_eq, "trp_global_variables", g_toilet_talk, -5),
        (neg|troop_slot_eq, "trp_global_variables", g_toilet_talk, -6),
        (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
        (finish_mission, 3),
      (else_try),
        (neg|main_hero_fallen),
        (num_active_teams_le, 2),
        (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
        (finish_mission, 3),
        (try_begin),
          (troop_slot_eq, "trp_global_variables", g_toilet_talk, -6),
          (jump_to_menu, "mnu_toilet_brothel_victory"),
        (else_try),
          (troop_slot_eq, "trp_global_variables", g_toilet_talk, -5),
          (jump_to_menu, "mnu_toilet_tavern_victory"),
        (try_end),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, [],[
      (try_begin),
        (neg|troop_slot_eq, "trp_global_variables", g_toilet_talk, -5),
        (neg|troop_slot_eq, "trp_global_variables", g_toilet_talk, -6),
        (set_trigger_result, 1),
      (else_try),
        (display_message, "str_cant_use_inventory_now"),
      (try_end),
    ]),

    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),
("explore_carthage", mtf_battle_mode, -1,
  "Test.",[
    (0,mtef_visitor_source,0,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    (ti_before_mission_start, 0, 0, [
      (quest_slot_ge, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 10),
    ],[
      (replace_scene_props, "spr_mp_mound_a_path", "spr_empty"),
      (replace_scene_props, "spr_mp_mound_b_path", "spr_empty"),
      (replace_scene_props, "spr_mp_mound_c_path", "spr_empty"),
      (replace_scene_props, "spr_mp_mound_d_path", "spr_empty"),
      (replace_scene_props, "spr_mp_mound_e_path", "spr_empty"),
      (replace_scene_props, "spr_mp_mound_f_path", "spr_empty"),
    ]),
    (ti_before_mission_start, 0, 0, [
      (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
      (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 12),
    ],[
      (scene_set_day_time, 0),
    ]),
    (ti_after_mission_start, 0, 0, [
      (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
      (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 12),
    ],[
      (set_fog_distance, 50, 0xA75862),
      (play_sound, "snd_thunder_close"),
    ]),
    (ti_on_agent_knocked_down, 0, 0, [
      (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
      (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 13),
    ],[
      (store_trigger_param_1, ":dead_agent"),
      (neg|agent_is_non_player, ":dead_agent"),
      (val_add, "$temp3", 1),
    ]),
    (0.5, 0.5, ti_once, [
      (neg|conversation_screen_is_active),
      (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
      (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 12),
      (store_mission_timer_a, ":time"),
      (ge, ":time", 3),
    ],[
      (mission_enable_talk),
      (start_mission_conversation, "trp_african_myth_hero_4"),
    ]),
    (1, 0, 0, [
      (neg|conversation_screen_is_active),
      (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
      (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 13),
      (gt, "$temp3", 0),
      (store_mod, ":beaten", "$temp3", 3),
      (eq, ":beaten", 0),
    ],[
      (finish_party_battle_mode),
      (mission_enable_talk),
      (start_mission_conversation, "trp_african_myth_hero_4"),
      (val_add, "$temp3", 1),
    ]),

    (ti_on_agent_spawn,1,0,[
      (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
      (store_trigger_param_1,":agent"),
      (agent_get_troop_id,":troop",":agent"),
      (try_begin),
        (eq,":troop","trp_slave_mine"),
        (agent_equip_item,":agent","itm_pickaxe_work"),
        (agent_set_stand_animation, ":agent", "anim_mining"),
        (agent_set_animation, ":agent", "anim_mining"),
        (agent_play_sound,":agent","snd_dedal_mine_pickaxe"),
        (agent_ai_set_interact_with_player,":agent",0),
        (assign,":end",1),
        (convert_to_fixed_point,":end"),
        (store_random_in_range,":progress",0,":end"),
        (agent_set_animation_progress,":agent",":progress"),
      (else_try),
        (eq, ":troop", "trp_african_myth_hero_4"),
        (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 12),
        (agent_set_no_death_knock_down_only, ":agent", 1),
        (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 200),
        (agent_set_damage_modifier, ":agent", 200),
      (else_try),
        (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 12),
        (neg|agent_is_non_player, ":agent"),
        (agent_set_no_death_knock_down_only, ":agent", 1),
        (assign, "$temp3", 0), # use this to count player falling
        (call_script, "script_advanced_agent_set_speed_modifier", ":agent", 75),
        (agent_set_damage_modifier, ":agent", 10),
      (try_end),
    ],[]),

    (0, 0, 0, [
      (this_or_next|key_is_down, key_left_alt),
      (key_is_down, key_right_alt),
      (key_is_down, key_f4),
      (this_or_next|key_is_down, key_left_control),
      (key_is_down, key_right_control),
    ],[
      (get_player_agent_no, ":player"),
      (agent_deliver_damage_to_agent,":player",":player",10000,"itm_warhammer"),
      (display_message, "@DIE CHEATER! DIE CHEATER! DIE CHEATER!"),
      (assign, "$temp", 2),
      (jump_to_menu, "mnu_death_waits"),
      (finish_mission),
    ]),


    (0.5, 0, 0, [
      (neg|conversation_screen_is_active),
      (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
    ],[
      (try_begin),
        (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 2),
        (eq, "$temp2", 1),

        (assign, ":save_fpm", 1),# dave fixed point value
        (convert_to_fixed_point, ":save_fpm"),

        (agent_is_active, "$g_belligerent_drunk_leaving"),
        (agent_clear_scripted_mode, "$g_belligerent_drunk_leaving"),
        (set_fixed_point_multiplier, 100),
        (entry_point_get_position, pos50, 18),
        (agent_set_scripted_destination, "$g_belligerent_drunk_leaving", pos50, 0, 1),
        (display_message, "@Follow him.", message_alert),

        (assign, "$temp2", 2),
        (set_fixed_point_multiplier, ":save_fpm"),
      (else_try),
        (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 4),
        (eq, "$temp2", 3),

        (assign, ":save_fpm", 1),# dave fixed point value
        (convert_to_fixed_point, ":save_fpm"),

        (agent_is_active, "$g_belligerent_drunk_leaving"),
        (agent_clear_scripted_mode, "$g_belligerent_drunk_leaving"),
        (set_fixed_point_multiplier, 100),
        (entry_point_get_position, pos50, 2),
        (agent_set_scripted_destination, "$g_belligerent_drunk_leaving", pos50, 0, 1),
        (display_message, "@Follow him.", message_alert),

        (assign, "$temp2", 4),
        (set_fixed_point_multiplier, ":save_fpm"),
      (try_end),
    ]),

    (ti_on_agent_spawn,1,0,[
      (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
      (store_trigger_param_1,":agent"),
      (agent_get_troop_id,":troop",":agent"),
      (eq, ":troop", "trp_statthalter_new_12"),
      (assign, "$g_belligerent_drunk_leaving", ":agent"),
    ],[]),

    (0.5, 0.5, ti_once, [
      (neg|conversation_screen_is_active),
      (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
      (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 1),
      (neg|is_currently_night),
      (store_mission_timer_a, ":time"),
      (ge, ":time", 4),
    ],[
      (mission_enable_talk),
      (start_mission_conversation, "trp_statthalter_new_12"),
    ]),
    (0.5, 0.5, ti_once, [
      (neg|conversation_screen_is_active),
      (is_currently_night),
      (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
      (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 1),
    ],[
      (tutorial_box, "@Caeselius Bassus hasn't reached the ruins yet. Come back during day time."),
    ]),
    (0.5, 0.5, ti_once, [
      (neg|conversation_screen_is_active),
      (is_currently_night),
      (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
      (quest_slot_ge, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 2),
    ],[
      (tutorial_box, "@Caeselius Bassus is asleep. Come back during day time."),
    ]),
    (0.5, 0, 0, [
      (neg|conversation_screen_is_active),
      (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 2),
    ],[
      (agent_is_active, "$g_belligerent_drunk_leaving"),
      (agent_get_position, pos13, "$g_belligerent_drunk_leaving"),
      (entry_point_get_position, pos12, 18),
      (get_distance_between_positions_in_meters, reg22, pos12,pos13),
      (le, reg22, 3),
      (quest_set_slot, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 3),
      (mission_enable_talk),
      (start_mission_conversation, "trp_statthalter_new_12"),
    ]),
    (0.5, 0, 0, [
      (neg|conversation_screen_is_active),
      (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 4),
    ],[
      (agent_is_active, "$g_belligerent_drunk_leaving"),
      (agent_get_position, pos13, "$g_belligerent_drunk_leaving"),
      (entry_point_get_position, pos12, 2),
      (get_distance_between_positions_in_meters, reg22, pos12,pos13),
      (le, reg22, 2),
      (quest_set_slot, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 5),
      (mission_enable_talk),
      (start_mission_conversation, "trp_statthalter_new_12"),
    ]),
    cannot_spawn_commoners,
    (0, 0, ti_once, [],[
      (mission_enable_talk),
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00000000, 2000),
    ]),
    (ti_tab_pressed, 0, 0,[],[
      (try_begin),
        (neg|is_currently_night),
        (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
        (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 1),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (neg|is_currently_night),
        (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
        (neg|quest_slot_ge, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 6),
        (tutorial_box, "@Follow Caeselius Bassus!"),
      (else_try),
        (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
        (this_or_next|quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 13),
        (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 12),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (check_quest_active, "qst_prophecy_of_caeselius_bassus"),
        (quest_slot_ge, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 9),
        (tutorial_box, "@Bring Caeselius Bassus the items inside the chest!"),
      (else_try),
        (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
        (finish_mission, 3),
      (try_end),
    ]),
    (2, 0, 0,[
      (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 9),
    ],[
      (set_fixed_point_multiplier, 1000),
      (try_for_prop_instances, ":earth"),
          (prop_instance_get_scene_prop_kind, ":is_earth", ":earth"),
          (is_between, ":is_earth", "spr_mp_mound_a_turf", "spr_mp_parts_a"),
          (prop_instance_get_position, pos11, ":earth"),
          (position_get_z, ":z", pos11),
          (assign, reg1, ":z"),
          # (display_message, "@z: {reg1}"),
          (try_begin),
              (gt, ":z", 6500),
              (val_sub, ":z", 250),
              (position_set_z, pos11, ":z"),
              (prop_instance_animate_to_position, ":earth", pos11, 100),
              (display_message, "@Digging continues...."),
          (else_try),
              (quest_slot_eq, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 9),
              (quest_set_slot, "qst_prophecy_of_caeselius_bassus", slot_quest_current_state, 10),
              (mission_enable_talk),
              (start_mission_conversation, "trp_statthalter_new_12"),
              (try_for_agents, ":agent"),
                (agent_is_active, ":agent"),
                (agent_get_troop_id,":troop",":agent"),
                (eq,":troop","trp_slave_mine"),
                (agent_unequip_item,":agent","itm_pickaxe_work"),
                (agent_set_stand_animation, ":agent", "anim_end_animation"),
                (agent_set_animation, ":agent", "anim_end_animation"),
                (agent_stop_sound,":agent"),
                (agent_ai_set_interact_with_player,":agent",1),
              (try_end),
          (try_end),
      (try_end),
    ]),
    improved_lightning,
    common_inventory_not_available,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    ambient_scene_play_loop,
    ambient_scene_play_random_sound,
]),
("explore_secret_place", 0, -1,
  "Test.",[
    (0,mtef_scene_source,0,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
  ], p_wetter + storms + global_common_triggers +
  [
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent_no"),
      (agent_is_active, ":dead_agent_no"),
      (neg|agent_is_non_player, ":dead_agent_no"),#player
      (display_message, "@You lost money!", color_terrible_news),
      (troop_remove_gold, "trp_player", 250),
    ]),
    (ti_on_agent_killed_or_wounded, 0, 0, [],[
      (store_trigger_param_1, ":dead_agent_no"),
      (agent_is_active, ":dead_agent_no"),
      (agent_get_troop_id, ":troop_id", ":dead_agent_no"),#player
      (eq, ":troop_id", "trp_dj_pence"),
      (set_trigger_result, 1),# force kill
    ]),
    cannot_spawn_commoners,
    (0, 0, ti_once, [],[
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00000000, 2000),
    ]),

    (ti_tab_pressed, 0, 0,[],[
      (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
      (finish_mission, 3),
    ]),

    improved_lightning,
    common_inventory_not_available,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    ambient_scene_play_loop,
    ambient_scene_play_random_sound,
]),

("walhalla_indoor", 0, -1,
  "Test.",[
    (0,mtef_scene_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (1,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (2,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (3,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (4,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (5,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
  ], global_common_triggers +
  [
    cannot_spawn_commoners,
    (0, 0, ti_once, [],[
      (mission_cam_set_screen_color, 0xFF736252), #roughly the colour of the menu bg
      (mission_cam_animate_to_screen_color, 0x00736252, 1500),
    ]),

    (ti_tab_pressed, 0, 0,[],[
      (display_message, "str_cannot_leave_now"),
    ]),

    common_inventory_not_available,
    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
]),

("walhalla", 0, -1,
  "Test.",[
    (0,mtef_scene_source,0,0,1,[]),
    (1,mtef_scene_source,0,0,1,[]),
  ], global_common_triggers +
  [
    cannot_spawn_commoners,
    (ti_before_mission_start, 0, 0, [],[
      (scene_set_day_time, 0),
      (set_global_cloud_amount, 100),
      (set_global_haze_amount, 100),
    ]),
    (ti_after_mission_start, 0, 0, [],[
      (set_fog_distance, 75, 0x808080),
    ]),

    (0, 0, ti_once, [],[
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00000000, 2000),
    ]),

    (ti_tab_pressed, 0, 0,[],[
      (tutorial_box, "@Hint: Enter the longhouse.", "str_cannot_leave_now"),
      # (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
      # (finish_mission, 3),
    ]),

    common_inventory_not_available,
    ambient_scene_play_loop,
    ambient_scene_play_random_sound,
]),

("parthian_palace_garden", 0, -1,
  "Test.",[
    (0,mtef_visitor_source,af_override_horse|af_override_head|af_override_weapons,0,1,[]),
    (1,mtef_visitor_source,0,0,1,[]),
    (2,mtef_visitor_source,0,0,1,[]),
    (3,mtef_visitor_source,0,0,1,[]),
    (4,mtef_visitor_source,0,0,1,[]),
    (5,mtef_visitor_source,0,0,1,[]),
    (6,mtef_visitor_source,0,0,1,[]),
    (7,mtef_visitor_source,0,0,1,[]),
    (8,mtef_visitor_source,0,0,1,[]),
    (9,mtef_visitor_source,0,0,1,[]),
    (10,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave2,itm_flower_crown]),
    (11,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave1,itm_flower_crown]),
    (12,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave2,itm_flower_crown]),
    (13,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave3,itm_flower_crown]),
    (14,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave4,itm_flower_crown]),
    (15,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave1,itm_flower_crown]),
    (16,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave2,itm_flower_crown]),
    (17,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave3,itm_flower_crown]),
    (18,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave4,itm_flower_crown]),
    (19,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave1,itm_flower_crown]),
    (20,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave2,itm_flower_crown]),
    (21,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave3,itm_flower_crown]),
    (22,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave4,itm_flower_crown]),
    (23,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave1,itm_flower_crown]),
    (24,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave2,itm_flower_crown]),
    (25,mtef_visitor_source,af_override_everything,0,1,[itm_nothing_legs,itm_female_slave3,itm_flower_crown]),
  ], p_wetter + global_common_triggers +
  [
    can_spawn_commoners,
    (0, 0, ti_once, [],[
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00000000, 2000),
    ]),
    common_inventory_not_available,
    (ti_tab_pressed, 0, 0,[],[
      (mission_disable_talk),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
      (finish_mission, 3),
    ]),
    (0, 0, ti_once, [],[
      (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
    ]),

    (0, 0, ti_once, [
      (try_for_agents, ":agent"),
          (agent_is_active, ":agent"),
          (agent_is_non_player, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (eq, ":troop", "trp_courtier_female"),
          (set_fixed_point_multiplier, 1),
          (agent_get_position, pos1, ":agent"),
          (agent_set_no_dynamics, ":agent", 1),
          (position_move_z, pos1, -110),
          (agent_set_position, ":agent", pos1),
      (try_end),
    ],[]),

    dedal_tavern_animations,

    (0,0,ti_once, [],[
      (try_for_agents, ":agent_no"),
          # (str_store_agent_name, s22, ":agent_no"),
          # (display_message, "@script called for {s22} 1"),
          (agent_is_active, ":agent_no"),
          # (str_store_agent_name, s22, ":agent_no"),
          # (display_message, "@script called for {s22} 2"),
          (agent_is_human, ":agent_no"),
          (agent_is_alive, ":agent_no"),

          (agent_get_troop_id, ":troop", ":agent_no"),
          (neg|is_between, ":troop", tavern_minstrels_begin, tavern_minstrels_end),
          (call_script, "script_init_town_agent", ":agent_no"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (call_script, "script_change_banners_and_chest"),
    ]),

    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    ambient_scene_play_loop,
    ambient_scene_play_random_sound,
]),

("gardens_of_maceneas", mtf_battle_mode, -1,
  "Test.",[
    (0,mtef_visitor_source,af_override_everything,0,1,[itm_caligea,itm_roman_toga]),
    (1,mtef_visitor_source,0,0,1,[]),
    (2,mtef_visitor_source,0,0,1,[]),
    (3,mtef_visitor_source,0,0,1,[]),
    (4,mtef_visitor_source,0,0,1,[]),
    (5,mtef_visitor_source,0,0,1,[]),
    (6,mtef_visitor_source,0,0,1,[]),
    (7,mtef_visitor_source,0,0,1,[]),
    (8,mtef_visitor_source,0,0,1,[]),
    (9,mtef_visitor_source,0,0,1,[]),
    (10,mtef_visitor_source,0,0,1,[]),
    (11,mtef_visitor_source,0,0,1,[]),
    (12,mtef_visitor_source,0,0,1,[]),
    (13,mtef_visitor_source,0,0,1,[]),
    (14,mtef_visitor_source,0,0,1,[]),
    (15,mtef_visitor_source,0,0,1,[]),
    (16,mtef_visitor_source,0,0,1,[]),
    (17,mtef_visitor_source,0,0,1,[]),
    (18, mtef_visitor_source, 0, 0, 1, []),
    (19, mtef_visitor_source, 0, 0, 1, []),
    (20, mtef_visitor_source, 0, 0, 1, []),
    (21, mtef_visitor_source, 0, 0, 1, []),
    (22, mtef_visitor_source, 0, 0, 1, []),
    (23, mtef_visitor_source, 0, 0, 1, []),
    (24, mtef_visitor_source, 0, 0, 1, []),
    (25, mtef_visitor_source, 0, 0, 1, []),
    (26, mtef_visitor_source, 0, 0, 1, []),
    (27, mtef_visitor_source, 0, 0, 1, []),
    (28, mtef_visitor_source, 0, 0, 1, []),
    (29, mtef_visitor_source, 0, 0, 1, []),
    (30, mtef_visitor_source, 0, 0, 1, []),
    (31, mtef_visitor_source, 0, 0, 1, []),
    (32, mtef_visitor_source, 0, 0, 1, []),
    (33, mtef_visitor_source, 0, 0, 1, []),
    (34, mtef_visitor_source, 0, 0, 1, []),
    (35, mtef_visitor_source, 0, 0, 1, []),
    (36, mtef_visitor_source, 0, 0, 1, []),
    (37, mtef_visitor_source, 0, 0, 1, []),
    (38, mtef_visitor_source, 0, 0, 1, []),
    (39, mtef_visitor_source, 0, 0, 1, []),
    (40, mtef_visitor_source, 0, 0, 1, []),
    (41, mtef_visitor_source, 0, 0, 1, []),
    (42, mtef_visitor_source, 0, 0, 1, []),
    (43, mtef_visitor_source, 0, 0, 1, []),
    (44, mtef_visitor_source, 0, 0, 1, []),
    (45, mtef_visitor_source, 0, 0, 1, []),
    (46, mtef_visitor_source, 0, 0, 1, []),
    (47, mtef_visitor_source, 0, 0, 1, []),
    (48, mtef_visitor_source, 0, 0, 1, []),
    (49, mtef_visitor_source, 0, 0, 1, []),
    (50, mtef_visitor_source, 0, 0, 1, []),
    (51, mtef_visitor_source, 0, 0, 1, []),
    (52, mtef_visitor_source, 0, 0, 1, []),
    (53, mtef_visitor_source, 0, 0, 1, []),
    (54, mtef_visitor_source, 0, 0, 1, []),
    (55, mtef_visitor_source, 0, 0, 1, []),
    (56, mtef_visitor_source, 0, 0, 1, []),
    (57, mtef_visitor_source, 0, 0, 1, []),
    (58, mtef_visitor_source, 0, 0, 1, []),
    (59, mtef_visitor_source, 0, 0, 1, []),
    (60, mtef_visitor_source, 0, 0, 1, []),
    (61, mtef_visitor_source, 0, 0, 1, []),
    (62, mtef_visitor_source, 0, 0, 1, []),
    (63, mtef_visitor_source, 0, 0, 1, []),
    (64, mtef_visitor_source, 0, 0, 1, []),
    (65, mtef_visitor_source, 0, 0, 1, []),
    (66, mtef_visitor_source, 0, 0, 1, []),
    (67, mtef_visitor_source, 0, 0, 1, []),
    (68, mtef_visitor_source, 0, 0, 1, []),
    (69, mtef_visitor_source, 0, 0, 1, []),
    (70, mtef_visitor_source, 0, 0, 1, []),
    (71, mtef_visitor_source, af_castle_lord, 0, 1, []),
    (72, mtef_visitor_source, af_castle_lord, 0, 1, []),
    (73, mtef_visitor_source, af_override_everything, 0, 1, [itm_female_caligea_gold, itm_roman_female_augusta_2]),
    (74, mtef_visitor_source, af_override_everything|af_override_gloves|af_override_horse, 0, 1, [itm_lyre_rich,itm_roman_poor3,itm_female_caligea_gold]),
    (75, mtef_visitor_source, af_castle_lord, 0, 1, []),
    (76, mtef_visitor_source, af_override_everything, 0, 1, [itm_caligea,itm_roman_toga]),
    (77, mtef_visitor_source, 0, 0, 1, []),
    (78, mtef_visitor_source, 0, 0, 1, []),
    (79, mtef_visitor_source, 0, 0, 1, []),
  ], p_wetter + global_common_triggers +
  [
    can_spawn_commoners,
    (0,0,0,[
      (check_quest_active, "qst_nero_special_quest"),
      (quest_slot_eq, "qst_nero_special_quest", slot_quest_target_dna, 0),
      (quest_slot_eq, "qst_nero_special_quest", slot_quest_current_state, 2),
    ],[
      (store_mission_timer_a, ":cur_time"),
      (set_fixed_point_multiplier, 100),
      (try_begin),
          (ge, ":cur_time", 54),
          (eq, "$tutorial_state", 11),
          (stop_all_sounds, 1),
          (show_object_details_overlay,1),
          (finish_mission,2),
          (jump_to_menu, "mnu_gardens_of_maecenas_concludes"),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 53),
          (eq, "$tutorial_state", 10),
          (tutorial_message, -1),
          (tutorial_message_set_background, 0),
          (mission_cam_set_screen_color, 0x00FFFFFF),
          (mission_cam_animate_to_screen_color, 0xFFFFFFFF, 3000),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 43),
          (eq, "$tutorial_state", 9),
          (init_position, pos9),
          (entry_point_get_position, pos9, 85),
          (mission_cam_animate_to_position, pos9, 7000, 0),
          (tutorial_message_set_background, 1),
          (tutorial_message,
          "@The guests applause, as the poem ends^^"
          +"A fitting tribute, to new friends^^"
          +"The feast may be over, but the memories^^"
          +"Will live on forever, in our histories."),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 33),
          (eq, "$tutorial_state", 8),
          (init_position, pos9),
          (entry_point_get_position, pos9, 84),
          (mission_cam_animate_to_position, pos9, 7000, 0),
          (tutorial_message_set_background, 1),
          (tutorial_message,
          "@So let us drink, and be merry^^"
          +"For life is short, and time is hairy^^"
          +"Cherish this night, and hold it tight^^"
          +"For memories, will last a lifetime's light."),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 24),
          (eq, "$tutorial_state", 7),
          (init_position, pos9),
          (entry_point_get_position, pos9, 83),
          (mission_cam_animate_to_position, pos9, 7000, 0),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 23),
          (eq, "$tutorial_state", 6),
          (tutorial_message_set_background, 1),
          (tutorial_message,
          "@That life is sweet, and meant to be^^"
          +"Enjoyed with friends, and wild and free^^"
          +"Let us dance, and sing, and play^^"
          +"For tomorrow's troubles, are not today."),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 18),
          (eq, "$tutorial_state", 5),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 13),
          (eq, "$tutorial_state", 4),
          (tutorial_message_set_background, 1),
          (tutorial_message,
          "@The gardens of Maecenas bloom^^"
          +"With fragrant flowers, in nature's room^^"
          +"The stars above, a twinkling show^^"
          +"As we raise our glasses, let us know."),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 10),
          (eq, "$tutorial_state", 3),
          (init_position, pos9),
          (entry_point_get_position, pos9, 82),
          (mission_cam_animate_to_position, pos9, 8500, 0),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 3),
          (eq, "$tutorial_state", 2),
          (tutorial_message_set_background, 1),
          (tutorial_message,
            "@The feast is done, the guests have dined^^"
            +"But one more treat, I have in mind^^"
            +"A poem I composed, for all to hear ^^"
            +"A tribute to the evening dear."),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 2),
          (eq, "$tutorial_state", 1),
          (init_position, pos9),
          (entry_point_get_position, pos9, 81),
          (mission_cam_animate_to_position, pos9, 7000, 0),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (eq, "$tutorial_state", 0),
          (call_script, "script_save_cam_first_person_mode"),
          (mission_cam_set_mode, 1, 0, 0),
          (set_camera_in_first_person, 0),
          (init_position, pos10),
          (entry_point_get_position, pos10, 80),
          (mission_cam_set_position, pos10),
          (assign, "$tutorial_state", 1),
          (show_object_details_overlay, 0),
          (mission_disable_talk),
      (try_end),
    ]),

    (0, 0, ti_once, [],[
      (mission_cam_set_screen_color, 0xFF000000),
      (mission_cam_animate_to_screen_color, 0x00000000, 2000),
      (try_begin),
          (check_quest_active, "qst_nero_special_quest"),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_target_dna, 0),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_current_state, 2),
      (else_try),
          (mission_enable_talk),
      (try_end),
    ]),

    common_inventory_not_available,

    (ti_tab_pressed, 0, 0,[],[
      (try_begin),
          (check_quest_active, "qst_nero_special_quest"),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_target_dna, 0),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_current_state, 1),
          (assign, reg2, 0),
          (try_for_agents, ":agent"),
              (agent_is_active, ":agent"),
              (agent_get_troop_id, ":troop", ":agent"),
              (this_or_next|eq, ":troop", "trp_kingdom_7_lord"),
              (eq, ":troop", "trp_kingdom_7_lady_1"),
              (agent_slot_ge, ":agent", slot_agent_fatiga, 1),
              (val_add, reg2, 1),
          (try_end),
          (ge, reg2, 2),
          (jump_to_menu, "mnu_gardens_of_maecenas_final"),
          (mission_disable_talk),
          (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
          (finish_mission, 3),
      (else_try),
          (check_quest_active, "qst_nero_special_quest"),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_target_dna, 0),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_current_state, 1),
          (tutorial_box, "@Find and talk with Nero and Poppaea to finish the mission."),
      (else_try),
          (check_quest_active, "qst_nero_special_quest"),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_target_dna, 0),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_current_state, 2),
          (display_message, "str_cannot_leave_now"),
      (else_try),
          (mission_disable_talk),
          (mission_cam_animate_to_screen_color, 0xFF000000, 2500),
          (finish_mission, 3),
      (try_end),
    ]),

    (0, 0, ti_once, [],[
      (try_begin),
          (check_quest_active, "qst_nero_special_quest"),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_target_dna, 0),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_current_state, 2),
          (get_player_agent_no, ":player"),
          (call_script, "script_advanced_agent_set_speed_modifier", ":player", 0),
          (agent_set_no_death_knock_down_only, ":player", 1),
      (try_end),

      (try_begin),
          (check_quest_active, "qst_nero_special_quest"),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_current_state, 1),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_target_dna, 0),
          (play_track, "track_town_roman6", 2),
      (else_try),
          (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
      (try_end),

      (try_for_agents, ":agent"),
          (agent_is_alive, ":agent"),
          (agent_is_human, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (neq, ":troop", "trp_player"),
          (try_begin),
              (eq, ":troop", "trp_circus_1"),
              (agent_set_no_dynamics, ":agent"),
              (agent_set_stand_animation, ":agent", "anim_circus_1"),
              (agent_set_animation, ":agent", "anim_circus_1"),
              (agent_set_no_dynamics, ":agent", 1),
              (agent_ai_set_interact_with_player, ":agent", 0),
          (else_try),
              (eq, ":troop", "trp_circus_2"),
              (agent_set_no_dynamics, ":agent"),
              (agent_set_stand_animation, ":agent", "anim_circus_2"),
              (agent_set_animation, ":agent", "anim_circus_2"),
              (agent_set_no_dynamics, ":agent", 1),
              (agent_ai_set_interact_with_player, ":agent", 0),
          (else_try),
              (eq, ":troop", "trp_circus_3"),
              (agent_set_no_dynamics, ":agent"),
              (agent_set_stand_animation, ":agent", "anim_circus_3"),
              (agent_set_animation, ":agent", "anim_circus_3"),
              (agent_set_no_dynamics, ":agent", 1),
              (agent_ai_set_interact_with_player, ":agent", 0),
          (else_try),
              (this_or_next|eq, ":troop", "trp_guest"),
              (eq, ":troop", "trp_guest_female"),

              (assign, ":block", 0),
              (try_begin),
                  (check_quest_active, "qst_nero_special_quest"),
                  (quest_slot_eq, "qst_nero_special_quest", slot_quest_target_dna, 0),
                  (quest_slot_eq, "qst_nero_special_quest", slot_quest_current_state, 2),
                  (assign, ":block", 1),
              (try_end),
              (eq, ":block", 0),
              (try_begin),
                  (agent_get_entry_no, ":entry", ":agent"),
                  (is_between, ":entry", 21, 46),
                  (agent_set_stand_animation, ":agent", "anim_lie_normal"),
                  (agent_set_animation, ":agent", "anim_lie_normal"),
                  (set_fixed_point_multiplier, 1),
                  (agent_get_position, pos1, ":agent"),
                  (agent_set_no_dynamics, ":agent", 1),
                  (position_move_z, pos1, -110),
                  (agent_set_position, ":agent", pos1),
              (else_try),
                  (agent_set_stand_animation, ":agent", "anim_sitting_low"),
                  (agent_set_animation, ":agent", "anim_sitting_low"),
              (try_end),
              (agent_set_no_dynamics, ":agent", 1),
              (agent_ai_set_interact_with_player, ":agent", 0),
          (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn,1,0,[
      (store_trigger_param_1,":agent"),
      (agent_get_troop_id,":troop",":agent"),
      (assign, ":c", 0),

      (try_begin),
          (is_between,":troop",tavern_minstrels_begin,tavern_minstrels_end),
          (assign, ":c", 1),
      (else_try),
          (eq, ":troop", "trp_kingdom_7_lord"),
          (check_quest_active, "qst_nero_special_quest"),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_target_dna, 0),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_current_state, 2),
          (assign, ":c", 1),
          # (display_message, "@NERO ACTIVATED"),
      (try_end),
      (try_begin),
          (eq, ":c", 1),
          (play_track,0,2),
          (try_begin),
              (agent_has_item_equipped,":agent","itm_lute"),
              (agent_set_stand_animation, ":agent", "anim_lute_standing"),
              (agent_set_animation, ":agent", "anim_lute_standing"),
              (agent_play_sound,":agent","snd_dedal_tavern_lute"),
          (else_try),
              (agent_has_item_equipped,":agent","itm_lyre"),
              (agent_set_stand_animation, ":agent", "anim_lyre_standing"),
              (agent_set_animation, ":agent", "anim_lyre_standing"),
              (agent_play_sound,":agent","snd_dedal_tavern_lyre"),
          (else_try),
              (agent_has_item_equipped,":agent","itm_lyre_rich"),
              (agent_set_stand_animation, ":agent", "anim_lyre_standing"),
              (agent_set_animation, ":agent", "anim_lyre_standing"),
              (agent_play_sound,":agent","snd_dedal_tavern_lyre"),
          (else_try),
              (agent_has_item_equipped,":agent","itm_flute"),
              (agent_set_stand_animation, ":agent", "anim_flute_player"),
              (agent_set_animation, ":agent", "anim_flute_player"),
              (agent_play_sound,":agent","snd_dedal_tavern_flute"),
          (try_end),
          (store_random_in_range,":r",0,300),
          (agent_set_animation_progress,":agent",":r"),
      (try_end),
    ],[]),

    (0,0,ti_once, [],[
      (try_begin),
          (check_quest_active, "qst_nero_special_quest"),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_target_dna, 0),
          (quest_slot_eq, "qst_nero_special_quest", slot_quest_current_state, 2),
      (else_try),
          (try_for_agents, ":agent_no"),
              (agent_is_active, ":agent_no"),
              (agent_is_human, ":agent_no"),
              (agent_is_alive, ":agent_no"),

              (agent_get_troop_id, ":troop", ":agent_no"),
              (neg|is_between, ":troop", tavern_minstrels_begin, tavern_minstrels_end),
              (call_script, "script_init_town_agent", ":agent_no"),
          (try_end),
      (try_end),
    ]),

    (0,8,0,[],[
      (try_for_agents,":agent_no"),
          (agent_is_alive,":agent_no"),
          (agent_is_human,":agent_no"),
          (agent_get_troop_id, ":troop_no", ":agent_no"),
          (this_or_next|eq, ":troop_no", "trp_roman_town_walker"),
          (eq, ":troop_no", "trp_roman_town_walker_female"),

          (assign, ":continue_walk", 0),
          (store_random_in_range, ":continue_walk", 1, 100),
          (try_begin),
              (le, ":continue_walk", 40),
              (agent_set_stand_animation, ":agent_no", "anim_stand_man"),
              (agent_set_walk_forward_animation, ":agent_no", "anim_walk_forward"),
              (agent_set_animation, ":agent_no", "anim_stand_man"),
              (agent_set_animation_progress, ":agent_no", 10),

              (agent_get_position, pos1, ":agent_no"),
              (store_random_in_range, ":points", 0, 21),
              (entry_point_get_position, pos2, ":points"),
              (agent_set_speed_limit, ":agent_no", 1),
              (agent_set_scripted_destination, ":agent_no", pos2),
          (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, [],[
      (call_script, "script_change_banners_and_chest"),
    ]),

    ambient_set_agents_for_sounds,
    ambient_agent_play_sound,
    ambient_scene_play_loop,
    ambient_scene_play_random_sound,

    (ti_before_mission_start, 0, 0, [
      (check_quest_active, "qst_nero_special_quest"),
      (quest_slot_eq, "qst_nero_special_quest", slot_quest_target_dna, 0),
      (quest_slot_ge, "qst_nero_special_quest", slot_quest_current_state, 1),
    ],
    [
      (scene_set_day_time, 0),
    ]),
]),

("fleet_cutscene",mtf_battle_mode,-1,
  "plundering a settlement",[
    (0,mtef_scene_source,af_override_horse,0,1,[]),#player
    (1,mtef_visitor_source,af_override_everything,0,1,[itm_caligea,itm_roman_lupa_dress_4,itm_cloak_5]),#guard
    (2,mtef_visitor_source,af_override_horse,0,1,[]),#guard
    (3,mtef_visitor_source,af_override_horse,0,1,[]),#legatus
    (4,mtef_visitor_source,af_override_horse,0,1,[]),#legatus
    (5,mtef_visitor_source,af_override_horse,0,1,[]),#unused
    (6,mtef_visitor_source,af_override_horse,0,1,[]),#unused
    (7,mtef_visitor_source,af_override_horse,0,1,[]),#unused
    (8,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (9,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (10,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (11,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (12,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (13,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (14,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (15,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (16,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (17,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (18,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (19,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (20,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (21,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (22,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (23,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (24,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (25,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (26,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (27,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (28,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (29,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (30,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (31,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (32,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (33,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (34,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (35,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (36,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (37,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (38,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (39,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (40,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (41,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (42,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (43,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (44,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (45,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (46,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (47,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (48,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (49,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (50,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (51,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (52,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (53,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (54,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (55,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (56,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (57,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (58,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (59,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (60,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (61,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (62,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (63,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (64,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (65,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (66,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (67,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (68,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (69,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (70,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (71,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (72,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (73,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (74,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (75,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (76,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (77,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (78,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (79,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (80,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (81,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (82,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (83,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (84,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (85,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (86,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (87,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (88,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (89,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (90,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (91,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (92,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (93,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (94,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (95,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (96,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (97,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (98,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (99,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (100,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (101,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (102,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (103,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (104,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (105,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (106,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (107,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (108,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (109,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (110,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (111,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (112,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (113,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (114,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (115,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (116,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (117,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (118,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (119,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (120,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (121,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (122,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (123,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (124,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (125,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (126,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
    (127,mtef_visitor_source,af_override_horse,0,1,[]),#spectators
  ], vc_water + [
    cannot_spawn_commoners,
    (ti_before_mission_start, 0, 0, [],[
      (scene_set_day_time, 24),
      (set_global_cloud_amount, 100),
      (set_global_haze_amount, 100),
      (set_fog_distance, 350, 0xFF6c6c6c),
      (set_rain, 1, 250),
    ]),

    (ti_tab_pressed,0,0,[],[
      (show_object_details_overlay, 1),
      (jump_to_menu, "$g_next_menu"),
      (finish_mission),
    ]),

    (ti_after_mission_start,0,0,[],[
      (show_object_details_overlay, 0),
    ]),

    deactivate_player_agent,

    (0,0,0,[],[
      (store_mission_timer_a, ":cur_time"),
      (set_fixed_point_multiplier, 100),
      (try_begin),
          (eq, "$tutorial_state", 5),
          (ge, ":cur_time", 73),
          (jump_to_menu, "$g_next_menu"),
          (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
          (show_object_details_overlay,1),
          (finish_mission, 3),
          (val_add, "$tutorial_state", 1),
          (play_sound,"snd_thunder_close"),
      (else_try),
          (ge, ":cur_time", 70),
          (eq, "$tutorial_state", 4),
          (set_fixed_point_multiplier, 1000),
          (entry_point_get_position, pos9, 104),
          (mission_cam_animate_to_position, pos9, 4000, 1),
          (val_add, "$tutorial_state", 1),
          (tutorial_message_set_background, 1),
          (tutorial_message, -1),
      (else_try),
          (ge, ":cur_time", 45),
          (eq, "$tutorial_state", 3),
          (set_fixed_point_multiplier, 1000),
          (entry_point_get_position, pos9, 103),
          (mission_cam_animate_to_position, pos9, 25000, 0),
          (val_add, "$tutorial_state", 1),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@Another thunder is roaming. The soldiers take it as a good omen. They cheer and shout! The troops have high moral."),
      (else_try),
          (ge, ":cur_time", 23),
          (eq, "$tutorial_state", 2),
          (entry_point_get_position, pos9, 102),
          (mission_cam_animate_to_position, pos9, 25000, 0),
          (val_add, "$tutorial_state", 1),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@Antonia:^^'With reverence, I offer this prayer to thee,'^'Grant us strength and courage. Grant us victory!'"),
      (else_try),
          (ge, ":cur_time", 1),
          (eq, "$tutorial_state", 1),
          (entry_point_get_position, pos9, 101),
          (mission_cam_animate_to_position, pos9, 25000, 0),
          (val_add, "$tutorial_state", 1),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@Antonia:^^'Mighty Mars, god of war and valor,'^'I humbly come before your divine presence.'"),
      (else_try),
          (eq, "$tutorial_state", 0),
          (set_fixed_point_multiplier, 1000),
          (mission_cam_set_mode, 1, 0, 0),
          (set_camera_in_first_person, 0),
          (init_position, pos10),
          (entry_point_get_position, pos10, 100),
          (mission_cam_set_position, pos10),
          (val_add, "$tutorial_state", 1),
          (set_fixed_point_multiplier, 1),
          (try_for_prop_instances, ":ship"),
              (prop_instance_get_scene_prop_kind, ":is_ship", ":ship"),
              (is_between, ":is_ship", "spr_ship", "spr_snowy_barrel_a"),
              (prop_instance_get_position, pos11, ":ship"),
              (position_move_x, pos11, 75000),
              (prop_instance_animate_to_position, ":ship", pos11, 14000),
          (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, [],	# equipment troops
    [
      (store_trigger_param, ":agent", 1),
      (try_for_range, ":item_slot", ek_item_0, ek_head),
          (agent_get_item_slot, ":item", ":agent", ":item_slot"),
          (gt, ":item", -1),
          (try_begin),
              (is_between, ":item", weapons_begin, weapons_end),
              (agent_set_wielded_item,":agent",":item"),
          (else_try),
              (is_between, ":item", shields_begin, shields_end),
              (agent_set_wielded_item,":agent",":item"),
          (try_end),
      (try_end),
    ]),

    (4, 0, 0,
      [
        (store_mission_timer_a, ":cur_time"),
        (gt, ":cur_time", 2),
      ],[
        (try_for_agents, ":agent"),
            (agent_is_human, ":agent"),
            (agent_is_alive, ":agent"),
            (agent_is_active,":agent"),

            (agent_get_troop_id, ":troop_id", ":agent"),
            (neq,":troop_id","trp_player"),

            (agent_get_animation, ":agent_anl", ":agent", 0),
            (agent_get_animation, ":agent_anu", ":agent", 1),

            (store_random_in_range, ":rand", 0, 350),

            (try_begin),
                (le, ":rand", 40),
                (agent_play_sound, ":agent", "snd_man_warcry"),
                (call_script,"script_agent_perform_shield_taunt", ":agent"),
            (else_try),
                (le, ":rand", 75),
                (eq, ":agent_anl", 8),#
                (this_or_next|eq, ":agent_anu", 320),#
                (eq, ":agent_anu", -1),#
                (call_script,"script_agent_perform_warcry", ":agent"),
            (else_try),
                (le, ":rand", 115),
                (eq, ":agent_anl", 8),#v
                (this_or_next|eq, ":agent_anu", 320),#
                (eq, ":agent_anu", -1),#
                (call_script,"script_agent_perform_shield_taunt", ":agent"),
            (try_end),
        (try_end),
    ]),

    (0, 0, ti_once, #preparations 2
    [],[
      (assign, "$lightning_cycle", 0),
      (play_sound,"snd_thunder_close"),
      (set_fixed_point_multiplier, 100),
      (get_startup_sun_light, pos20),
      (position_get_x, "$sun_r", pos20),	# r
      (position_get_y, "$sun_g", pos20), # g
      (position_get_z, "$sun_b", pos20),	# b
      (get_startup_ambient_light, pos21),
      (position_get_x, "$amb_r", pos21),	# r
      (position_get_y, "$amb_g", pos21), # g
      (position_get_z, "$amb_b", pos21),	# b
    ]),

    (3, 0.2, 6, 			#lightning 1
    [
      (eq,"$lightning_cycle",0),
      # (store_random_in_range,":chance",0,2),
      # (eq,":chance",1),
      (play_sound,"snd_thunder_close"),
      (set_startup_sun_light, 10000, 10000, 10000),
      (set_startup_ambient_light, 10000, 10000, 10000),
      # (display_message, "@set light 1"),
    ],[
      (set_startup_sun_light, 0, 0, 0),
      (set_startup_ambient_light, 0, 0, 0),
      (assign, "$lightning_cycle",1),
      # (display_message, "@set light 2"),
    ]),

    (0.4,0.1, 6,			#lightning 2
    [
      (eq,"$lightning_cycle",1),

      (set_startup_sun_light, 220, 220, 220),
      (set_startup_ambient_light, 220, 220, 220),
      # (display_message, "@set light 3"),
    ],[
      (set_startup_sun_light, 1, 1, 1),
      (set_startup_ambient_light, 1, 1, 1),
      (assign,"$lightning_cycle",2),
      # (display_message, "@set light 4"),
    ]),

    (0.5,0.1, 6,			#lightning 3
    [
      (eq,"$lightning_cycle",2),
      (set_startup_sun_light, 150, 150, 150),
      (set_startup_ambient_light, 150, 150, 150),
      # (display_message, "@set light 5"),
    ],[
      (set_startup_sun_light, "$sun_r", "$sun_g", "$sun_b"),
      (set_startup_ambient_light, "$amb_r", "$amb_g", "$amb_b"),
      (assign,"$lightning_cycle", 0),
      # (display_message, "@set light 6"),
    ]),
    common_inventory_not_available,
]),

("cutscene_rome_speech",mtf_battle_mode,-1, "triumph",[
    (0,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (1,mtef_visitor_source,af_override_head|af_override_horse|af_override_weapons,0,1,[itm_laurel_gold, itm_roman_gladius_rich_3]),
    (2,mtef_visitor_source,af_override_head|af_override_horse,0,1,[itm_laurel_gold]),
    (3,mtef_visitor_source,af_override_fullhelm|af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_fullhelm|af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_fullhelm|af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_fullhelm|af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_fullhelm|af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_fullhelm|af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_fullhelm|af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_fullhelm|af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (12,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (13,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (14,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (15,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (16,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (17,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (18,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (19,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (20,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (21,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (22,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (23,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (24,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (25,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (26,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (27,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (28,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (29,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (30,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (31,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (32,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (33,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (34,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (35,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (36,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (37,mtef_visitor_source,af_override_fullhelm,0,1,[]),
  ],[
    cannot_spawn_commoners,
    (ti_before_mission_start, 0, 0, [
    ],[
      (scene_set_day_time, 12),
      (set_global_cloud_amount, 0),
      (assign, "$tutorial_state", 0),
    ]),

    (ti_tab_pressed,0,0,[],[
      (show_object_details_overlay, 1),
      (jump_to_menu, "$g_next_menu"),
      (finish_mission, 3),
      (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
      # (stop_all_sounds, 1),
    ]),

    (ti_after_mission_start,0,0,[],[
      (show_object_details_overlay, 0),
    ]),

    deactivate_player_agent,

    (0,0,0,[],[
      (store_mission_timer_a, ":cur_time"),
      (set_fixed_point_multiplier, 100),
      (try_begin),
          (eq, "$tutorial_state", 3),
          (ge, ":cur_time", 35),
          (jump_to_menu, "$g_next_menu"),
          (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
          (show_object_details_overlay,1),
          (finish_mission, 3),
          (val_add, "$tutorial_state", 1),
          # (stop_all_sounds, 1),
      (else_try),
          (ge, ":cur_time", 33),
          (eq, "$tutorial_state", 2),
          (val_add, "$tutorial_state", 1),
          (tutorial_message_set_background, 1),
          (tutorial_message, -1),
      (else_try),
          (ge, ":cur_time", 4),
          (eq, "$tutorial_state", 1),
          (val_add, "$tutorial_state", 1),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@You:^^People of Rome! Noble citizens! I stand before you as your newly declared Princeps, first among equals. With humility, I accept this sacred responsibility. We shall forge a path of prosperity, unity, and glory for Rome. Let the spirit of Rome guide our endeavors, and let justice prevail. I pledge to lead with unwavering dedication, ensuring the welfare of every citizen. May the legacy of our ancestors inspire our actions. We shall build a Rome that stands strong for generations. Roma Invicta!"),
          (get_player_agent_no, ":player"),
          (agent_play_sound, ":player", "snd_player_speech_rome_other_goy"),
      (else_try),
          (eq, "$tutorial_state", 0),
          (val_add, "$tutorial_state", 1),
          (set_fixed_point_multiplier, 1000),
          (call_script, "script_save_cam_first_person_mode"),
          (mission_cam_set_mode, 1, 0, 0),
          (set_camera_in_first_person, 0),
          (init_position, pos10),
          (entry_point_get_position, pos10, 37),
          (mission_cam_set_position, pos10),
      (try_end),
    ]),
    common_inventory_not_available,
]),

("cutscene_rome_triumph",mtf_battle_mode,-1, "triumph",[
    (0,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (1,mtef_visitor_source,af_override_head|af_override_horse,0,1,[itm_laurel_gold, itm_leopard_horse_1]),
    (2,mtef_visitor_source,af_override_head|af_override_horse,0,1,[itm_laurel_gold, itm_leopard_horse_1]),
    (3,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (4,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (5,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (6,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (7,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (8,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (9,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (10,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (11,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (12,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (13,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (14,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (15,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (16,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (17,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (18,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (19,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (20,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (21,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (22,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (23,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (24,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (25,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (26,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (27,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (28,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (29,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (30,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    (31,mtef_visitor_source,af_override_fullhelm,0,1,[]),
  ],[
    cannot_spawn_commoners,
    (ti_before_mission_start, 0, 0, [
    ],[
      (scene_set_day_time, 19),
      (set_global_cloud_amount, 0),
    ]),

    (ti_tab_pressed,0,0,[],[
      (show_object_details_overlay, 1),
      (jump_to_menu, "$g_next_menu"),
      (finish_mission),
    ]),

    (ti_after_mission_start,0,0,[],[
      (show_object_details_overlay, 0),
    ]),

    deactivate_player_agent,

    (0,0,0,[],[
      (store_mission_timer_a, ":cur_time"),
      (set_fixed_point_multiplier, 100),
      (try_begin),
          (eq, "$tutorial_state", 4),
          (ge, ":cur_time", 30),
          (jump_to_menu, "$g_next_menu"),
          (mission_cam_animate_to_screen_color, 0xFF000000, 2000),
          (show_object_details_overlay,1),
          (finish_mission, 3),
          (val_add, "$tutorial_state", 1),
      (else_try),
          (ge, ":cur_time", 27),
          (eq, "$tutorial_state", 3),
          (val_add, "$tutorial_state", 1),
          (tutorial_message_set_background, 1),
          (tutorial_message, -1),
      (else_try),
          (ge, ":cur_time", 14),
          (eq, "$tutorial_state", 2),
          (val_add, "$tutorial_state", 1),
          (str_store_troop_name, s10, "trp_player"),
          (store_current_hours, ":hours"),
          (call_script, "script_game_get_date_text",0,":hours"),
          (tutorial_message_set_background, 1),
          (tutorial_message, "@On {s1}, {s10} entered Rome as sole victor of the most troublesome year since the defeat of Antonius."),
      (else_try),
          (ge, ":cur_time", 1),
          (eq, "$tutorial_state", 1),
          (val_add, "$tutorial_state", 1),
          (entry_point_get_position, pos9, 27),
          (mission_cam_animate_to_position, pos9, 80000, 0),
      (else_try),
          (eq, "$tutorial_state", 0),
          (val_add, "$tutorial_state", 1),
          (set_fixed_point_multiplier, 1000),
          # march the troops down the bridge
          (entry_point_get_position, pos1, 25),
          (try_for_agents, ":agent_no"), # find everyone and march them off
              (agent_is_active, ":agent_no"),
              (try_begin),
                  (agent_get_troop_id, ":agent_troop", ":agent_no"),
                  (this_or_next|main_party_has_troop, ":agent_troop"),
                  (this_or_next|eq, ":agent_troop", "trp_aux_cav_praetoriani_2"),
                  (this_or_next|eq, ":agent_troop", "trp_multiplayer_profile_troop_male"),
                  (eq, ":agent_troop", "trp_antonia"),
                  (store_random_in_range, ":r", 0, 1000),
                  (val_mul, ":r", -1),
                  (position_move_x, pos1, ":r"), # correction for angle numerical loss
                  (val_mul, ":r", -1),
                  (position_move_y, pos1, ":r"),
                  (agent_set_scripted_destination, ":agent_no", pos1, 1),
                  (entry_point_get_position, pos1, 25),
                  (call_script, "script_advanced_agent_set_speed_modifier", ":agent_no", 13),
              (else_try),
                  (eq, ":agent_troop", "trp_roman_town_walker"),
                  (agent_set_stand_animation, ":agent_no", "anim_wedding_guest"),
                  (agent_set_animation, ":agent_no", "anim_wedding_guest"),
                  (store_random_in_range,":r",0,300),
                  (agent_set_animation_progress, ":agent_no", ":r"),
              (else_try),
                  (eq, ":agent_troop", "trp_roman_town_walker_female"),
                  (agent_set_stand_animation, ":agent_no", "anim_wedding_guest_woman"),
                  (agent_set_animation, ":agent_no", "anim_wedding_guest_woman"),
                  (store_random_in_range,":r",0,300),
                  (agent_set_animation_progress, ":agent_no", ":r"),
              (try_end),
          (try_end),
          (call_script, "script_save_cam_first_person_mode"),
          (mission_cam_set_mode, 1, 0, 0),
          (set_camera_in_first_person, 0),
          (init_position, pos10),
          (entry_point_get_position, pos10, 26),
          (mission_cam_set_position, pos10),
      (try_end),
    ]),
    common_inventory_not_available,
]),

("vespasian_final_dialogue",mtf_battle_mode,-1, "triumph",[
    (0,mtef_visitor_source,af_override_horse,0,1,[]),
    (1,mtef_visitor_source,af_override_horse,0,1,[]),
    (2,mtef_visitor_source,af_override_horse,0,1,[]),
    (3,mtef_visitor_source,af_override_horse,0,1,[]),
    (4,mtef_visitor_source,af_override_horse,0,1,[]),
    (5,mtef_visitor_source,af_override_horse,0,1,[]),
    (6,mtef_visitor_source,af_override_horse,0,1,[]),
    (7,mtef_visitor_source,af_override_horse,0,1,[]),
    (8,mtef_visitor_source,af_override_horse,0,1,[]),
    (9,mtef_visitor_source,af_override_horse,0,1,[]),
    (10,mtef_visitor_source,af_override_horse,0,1,[]),
    (11,mtef_visitor_source,af_override_horse,0,1,[]),
    (12,mtef_visitor_source,af_override_horse,0,1,[]),
    (13,mtef_visitor_source,af_override_horse,0,1,[]),
    (14,mtef_visitor_source,af_override_horse,0,1,[]),
    (15,mtef_visitor_source,af_override_horse,0,1,[]),
    (16,mtef_visitor_source,af_override_horse,0,1,[]),
    (17,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (18,mtef_visitor_source|mtef_team_1,af_override_head|af_override_horse|af_override_weapons,0,1,[itm_laurel_gold, itm_roman_gladius_rich_3]),
    (19,mtef_visitor_source,af_override_head|af_override_horse|af_override_weapons,0,1,[itm_laurel_gold]),
    (20,mtef_visitor_source,af_override_horse,0,1,[]),
    (21,mtef_visitor_source,af_override_horse,0,1,[]),
    (22,mtef_visitor_source,af_override_horse,0,1,[]),
    (23,mtef_visitor_source,af_override_horse,0,1,[]),
    (24,mtef_visitor_source,af_override_horse,0,1,[]),
    (25,mtef_visitor_source,af_override_horse,0,1,[]),
    (26,mtef_visitor_source,af_override_horse,0,1,[]),
    (27,mtef_visitor_source,af_override_horse,0,1,[]),
    (28,mtef_visitor_source,af_override_horse,0,1,[]),
    (29,mtef_visitor_source,af_override_horse,0,1,[]),
    (30,mtef_visitor_source,af_override_horse,0,1,[]),
    (31,mtef_visitor_source,af_override_horse,0,1,[]),
    (32,mtef_visitor_source,af_override_horse,0,1,[]),
    (33,mtef_visitor_source,af_override_horse,0,1,[]),
    (34,mtef_visitor_source,af_override_horse,0,1,[]),
    (35,mtef_visitor_source,af_override_horse,0,1,[]),
    (36,mtef_visitor_source,af_override_horse,0,1,[]),
    (37,mtef_visitor_source,af_override_horse,0,1,[]),
    (38,mtef_visitor_source,af_override_horse,0,1,[]),
    (39,mtef_visitor_source,af_override_head|af_override_horse,0,1,[itm_laurel_gold]),
    (40,mtef_visitor_source,af_override_horse,0,1,[]),
    (41,mtef_visitor_source,af_override_horse,0,1,[]),
    (42,mtef_visitor_source|mtef_team_2,af_override_horse|af_override_weapons,0,1,[itm_roman_gladius]),
    (43,mtef_visitor_source|mtef_team_1,af_override_head|af_override_horse|af_override_weapons,0,1,[itm_roman_gladius_rich_3, itm_laurel_gold]),
    (44,mtef_visitor_source,af_override_horse,0,1,[]),
    (45,mtef_visitor_source,af_override_horse,0,1,[]),
    (46,mtef_visitor_source,af_override_horse,0,1,[]),
    (47,mtef_visitor_source,af_override_horse,0,1,[]),
    (48,mtef_visitor_source,af_override_horse,0,1,[]),
    (49,mtef_visitor_source,af_override_horse,0,1,[]),
  ],[
    cannot_spawn_commoners,
    (ti_before_mission_start, 0, 0, [
    ],[
      (scene_set_day_time, 19),
      (set_global_cloud_amount, 0),
    ]),
    (ti_after_mission_start, 0, 0, [
    ],[
      (team_set_relation, 0, 1, 1),
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 0, 1),
      (team_set_relation, 2, 0, 1),
      (team_set_relation, 1, 2, 1),
      (team_set_relation, 2, 1, 1),
    ]),
    (0, 0, ti_once, [],[
      (try_for_agents, ":agent"),
          (agent_is_active, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (neg|troop_is_hero, ":troop"),
          (call_script, "script_init_town_agent", ":agent"),
      (try_end),
      (mission_enable_talk),
    ]),
    (0, 0, ti_once, [
      (neg|conversation_screen_is_active),
      (eq, "$temp4", 0),
    ],[
      (quest_get_slot, ":pop_or_antonia", "qst_four_emperors", slot_quest_main_antonia_or_poppaea),
      (start_mission_conversation, ":pop_or_antonia"),
    ]),
    (0, 0, ti_once, [
      (neg|conversation_screen_is_active),
      (eq, "$temp4", 3),
      (all_enemies_defeated, 2),
    ],[
      # (show_object_details_overlay, 1),
      (quest_get_slot, ":pop_or_antonia", "qst_four_emperors", slot_quest_main_antonia_or_poppaea),
      (start_mission_conversation, ":pop_or_antonia"),
    ]),
    (4,0,ti_once,[
      (main_hero_fallen),
    ],[
      (assign, "$temp", 2),
      (jump_to_menu, "mnu_death_waits"),
      (stop_all_sounds),
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      # (show_object_details_overlay, 1),
      (finish_mission,4),
		]),
    (ti_on_agent_spawn, 0, 0, [
    ],[
      (store_trigger_param_1, ":agent_no"),
      (agent_is_active, ":agent_no"),
      (agent_get_troop_id, ":troop_id", ":agent_no"),
      (try_begin),
          (quest_slot_eq, "qst_four_emperors", slot_quest_target_troop, "trp_legatus_11"),
          (eq, ":troop_id", "trp_kingdom_7_lady_1"),
          (agent_set_visibility, ":agent_no", 0),
          (assign, "$temp3", ":agent_no"),
          (agent_set_no_death_knock_down_only, ":agent_no", 1),
      (else_try),
          (eq, ":troop_id", "trp_tigellinus"),
          (call_script, "script_advanced_agent_set_speed_modifier", ":agent_no", 0),
          (agent_ai_set_always_attack_in_melee, ":agent_no", 1),
      (else_try),
          (eq, ":troop_id", "trp_quest_primus_pilus"),
          (call_script, "script_advanced_agent_set_speed_modifier", ":agent_no", 0),
          (agent_ai_set_always_attack_in_melee, ":agent_no", 1),
      (try_end),
    ]),
    (ti_tab_pressed,0,0,[],[
      (display_message, "str_cannot_leave_now"),
    ]),
    common_inventory_not_available,
]),

("werdheri_battle_lair",mtf_battle_mode,-1, "triumph",[
    (0,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (1,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (2,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (3,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (4,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (5,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (6,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (7,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (8,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (9,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (10,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (11,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (12,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (13,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (14,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (15,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (16,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (17,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (18,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (19,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (20,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (21,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (22,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (23,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (24,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (25,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (26,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (27,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (28,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (29,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (30,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (31,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (32,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (33,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (34,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (35,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (36,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (37,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (38,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (39,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (40,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (41,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (42,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (43,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (44,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
    (45,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (46,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (47,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (48,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
    (49,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
  ], global_common_triggers + p_wetter +
  [
    common_inventory_not_available,
    cannot_spawn_commoners,
    wounds_vc,

    (ti_after_mission_start, 0, 0, [
    ],[
      (team_set_relation, 2, 1, 0),
      (team_set_relation, 1, 2, 0),
      (assign, "$temp", 0),
      (team_give_order, 2, grc_everyone, mordr_stand_ground),
      (team_give_order, 1, grc_everyone, mordr_follow),
      (set_cheer_at_no_enemy, 0),
      (call_script, "script_music_set_situation_with_culture", mtf_sit_siege),
    ]),
    (ti_before_mission_start, 0, 0, [],[ # set it night with fog and no rain
      (scene_set_day_time, 24),
      (set_global_cloud_amount, 0),
      (set_global_cloud_amount, 100),
      (set_global_haze_amount, 100),
      (set_fog_distance, 100, 0xFF6c6c6c),
      (set_rain, 0, 250),
    ]),

    (ti_on_agent_spawn, 0, 0, [],[ # set it night with fog and no rain
      (store_trigger_param_1, ":agent"),
      (agent_is_active, ":agent"),
      (agent_is_non_player, ":agent"),
      (agent_get_troop_id, ":troop", ":agent"),
      (try_begin),
        (troop_is_hero, ":troop"),
        (agent_ai_set_aggressiveness, ":agent", 1000),
        (agent_ai_set_always_attack_in_melee, ":agent", 1),
      (else_try),
        (agent_set_accuracy_modifier, ":agent", 50),
      (try_end),
    ]),

    (ti_tab_pressed,0,0,[],[
      (display_message, "str_cannot_leave_now"),
    ]),
    (1, 0, 0, [
      (eq, "$temp", 0),
      (set_fixed_point_multiplier, 1000),
      (store_skill_level,":player_sneaking_skill","skl_athletics","trp_player"),
      (assign,":sneak_distance", 20000),
      (val_mul, ":player_sneaking_skill", 1000),
      (val_sub, ":sneak_distance", ":player_sneaking_skill"),

      (try_for_agents, ":hero_agent"),
        (agent_get_troop_id, ":troop", ":hero_agent"),
        (troop_is_hero, ":troop"),
        (assign,":continue",0),
        (agent_get_position, pos1, ":hero_agent"),
        (try_for_agents, ":cur_agent", pos1, ":sneak_distance"),
          (agent_is_active, ":cur_agent"),
          (agent_is_alive, ":cur_agent"),
          (agent_get_troop_id, ":troop", ":cur_agent"),
          (neg|troop_is_hero, ":troop"),
          (assign,":continue",1),
          # (str_store_agent_name, s10, ":cur_agent"),
          # (display_message, "@Spotted by {s10}!", message_alert),
        (try_end),
        (eq,":continue",1),
        (team_set_relation, 2, 1, -1),
        (team_set_relation, 1, 2, -1),
        (set_party_battle_mode),
        (assign, "$temp", 1),
      (try_end),
    ],[
    ]),
    (4,0,ti_once,[
      (main_hero_fallen),
    ],[
      (jump_to_menu, "mnu_werdheri_lost"),
      (stop_all_sounds),
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      # (show_object_details_overlay, 1),
      (finish_mission,4),
		]),
    (4,0,ti_once,[
      (num_active_teams_le, 1),
      (neg|main_hero_fallen),
    ],[
      (jump_to_menu, "mnu_werdheri_won"),
      (stop_all_sounds),
      (mission_cam_animate_to_screen_color, 0xFF000000, 3000),
      (finish_mission,4),
		]),
]),
]###end of file
